<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>Dreamhack CTF Season 1 Round #12 Damnida WriteUp | 棱晶の小窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="link: https:&#x2F;&#x2F;dreamhack.io&#x2F;wargame&#x2F;challenges&#x2F;275A challenge released at 2021.08.07. 09:00:00.Took about 20 hours.  Initial AnalysisWe can notice that from sub_D000 to sub_1A5F88 these 372 functions">
<meta property="og:type" content="article">
<meta property="og:title" content="Dreamhack CTF Season 1 Round #12 Damnida WriteUp">
<meta property="og:url" content="https://astralprisma.github.io/2026/01/04/dreamhack_275_damnida/index.html">
<meta property="og:site_name" content="棱晶の小窝">
<meta property="og:description" content="link: https:&#x2F;&#x2F;dreamhack.io&#x2F;wargame&#x2F;challenges&#x2F;275A challenge released at 2021.08.07. 09:00:00.Took about 20 hours.  Initial AnalysisWe can notice that from sub_D000 to sub_1A5F88 these 372 functions">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="d:/BY/blogs/source/pictures/dreamhack_275_1.png">
<meta property="og:image" content="d:/BY/blogs/source/pictures/dreamhack_275_2.png">
<meta property="og:image" content="d:/BY/blogs/source/pictures/dreamhack_275_3.png">
<meta property="article:published_time" content="2026-01-04T10:00:00.000Z">
<meta property="article:modified_time" content="2026-01-04T14:14:30.270Z">
<meta property="article:author" content="Astral Prisma">
<meta property="article:tag" content="Obfuscate">
<meta property="article:tag" content="Indirect Jump">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="d:/BY/blogs/source/pictures/dreamhack_275_1.png">
  
  
    <link rel="shortcut icon" href="/AP.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/OTSA.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>棱晶の小窝 </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/XH_2.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Astral Prisma </div>
      <div class="dot"></div>
      <div class="subtitle">星界棱晶 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/454936579" title="Bilibili"><image src=https://www.bilibili.com/favicon.ico></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://www.primegrid.com/show_user.php?userid=1243718" title="PrimeGrid"><image src=https://www.primegrid.com/images/favicon_32.png></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/AstralPrisma" title="GitHub"><image src=https://github.githubassets.com/favicons/favicon.png></image></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/WriteUp/">
                WriteUp
                <div class="category-count">36</div>
            </a>
        
            <a class="category-link" href="/categories/Ideas/">
                Ideas
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/">
                出题记录
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">标签</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/got/" rel="tag">.got</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ARM/" rel="tag">ARM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AutoRe/" rel="tag">AutoRe</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Brainfuck/" rel="tag">Brainfuck</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CUDA/" rel="tag">CUDA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Cheat-Engine/" rel="tag">Cheat Engine</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DOS/" rel="tag">DOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Driver/" rel="tag">Driver</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Frida-Hook/" rel="tag">Frida Hook</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Harmony-OS/" rel="tag">Harmony OS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/IPC/" rel="tag">IPC</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Indirect-Jump/" rel="tag">Indirect Jump</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Kotlin/" rel="tag">Kotlin</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Lua/" rel="tag">Lua</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Mac/" rel="tag">Mac</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Obfuscate/" rel="tag">Obfuscate</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pascal/" rel="tag">Pascal</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Powershell/" rel="tag">Powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pyarmor/" rel="tag">Pyarmor</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/QEMU/" rel="tag">QEMU</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/R2R/" rel="tag">R2R</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Remote/" rel="tag">Remote</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Rust/" rel="tag">Rust</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Subprocess/" rel="tag">Subprocess</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Traffic/" rel="tag">Traffic</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Unicorn/" rel="tag">Unicorn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/VM/" rel="tag">VM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WASM/" rel="tag">WASM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Wechat-Mini-Program/" rel="tag">Wechat Mini Program</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Windows-DLL/" rel="tag">Windows DLL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Yara/" rel="tag">Yara</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iOS/" rel="tag">iOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/il2cpp/" rel="tag">il2cpp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pickle/" rel="tag">pickle</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/x96/" rel="tag">x96</a></li></ul>
    </div>
  </div>


    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-dreamhack_275_damnida" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        Dreamhack CTF Season 1 Round #12 Damnida WriteUp
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2026-01-04T10:00:00.000Z" itemprop="datePublished">2026-01-04</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/WriteUp/">WriteUp</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            6.3k 词 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Indirect-Jump/" rel="tag">Indirect Jump</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Obfuscate/" rel="tag">Obfuscate</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <blockquote>
<p><small>link: <a target="_blank" rel="noopener" href="https://dreamhack.io/wargame/challenges/275">https://dreamhack.io/wargame/challenges/275</a></small><br><small>A challenge released at 2021.08.07. 09:00:00.</small><br><small>Took about 20 hours.</small></p>
</blockquote>
<h2 id="Initial-Analysis"><a href="#Initial-Analysis" class="headerlink" title="Initial Analysis"></a>Initial Analysis</h2><p>We can notice that from <code>sub_D000</code> to <code>sub_1A5F88</code> these 372 functions are severely obfuscated, and they all have <code>leave</code> and  <code>jmp rbx</code> for <code>indirect jump</code>. Some of these functions has a <code>retn</code> or <code>jmp rbx</code> in the middle of the whole func, therefore the code after those place <strong>can’t be correctly recognized</strong> as a part of the function. In fact, we should pay more attention to <code>jmp rbx</code> and <code>retn</code> than <code>endbr64</code>, which is used to distinguish the beginning of functions, because in this case, the boundaries between functions have been <strong>blurred</strong>, and the entire assembly paragraph is a <strong>colossal overall execution flow</strong>.</p>
<p>At addr <code>0x1A651D</code>, there is a off_table which has <strong>744 indices</strong>, but only <strong>372 unique indices</strong> — just the same as the amount of functions. First we can dump those 372 addrs and write an <strong>intel pin hook</strong>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pin.H&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line">std::ofstream traceFile;</span><br><span class="line">std::unordered_set&lt;ADDRINT&gt; targetAddresses;</span><br><span class="line">ADDRINT imageBase = <span class="number">0</span>;</span><br><span class="line"><span class="function">VOID <span class="title">RecordAddress</span><span class="params">(ADDRINT addr)</span> </span>&#123;</span><br><span class="line">    traceFile &lt;&lt; <span class="string">&quot;Hit address: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; addr &lt;&lt; std::endl;</span><br><span class="line">    traceFile.<span class="built_in">flush</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span> </span>&#123;</span><br><span class="line">    ADDRINT insAddr = <span class="built_in">INS_Address</span>(ins);</span><br><span class="line">    <span class="keyword">if</span> (targetAddresses.<span class="built_in">find</span>(insAddr) != targetAddresses.<span class="built_in">end</span>()) &#123;</span><br><span class="line">        <span class="built_in">INS_InsertCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)RecordAddress, IARG_ADDRINT, insAddr, IARG_END);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">ImageLoad</span><span class="params">(IMG img, VOID *v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IMG_IsMainExecutable</span>(img)) &#123;</span><br><span class="line">        imageBase = <span class="built_in">IMG_LowAddress</span>(img);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Main executable loaded at base: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; imageBase &lt;&lt; std::endl;</span><br><span class="line">        std::vector&lt;UINT64&gt; rvaList = &#123;<span class="number">53248</span>, <span class="number">58949</span>, <span class="number">64459</span>, <span class="number">69502</span>, <span class="number">70931</span>, <span class="number">75935</span>, <span class="number">81356</span>, <span class="number">86424</span>, <span class="number">91895</span>, <span class="number">96863</span>, <span class="number">97667</span>, <span class="number">102735</span>, <span class="number">108245</span>, <span class="number">113752</span>, <span class="number">118781</span>, <span class="number">123863</span>, <span class="number">129009</span>, <span class="number">133858</span>, <span class="number">138976</span>, <span class="number">144447</span>, <span class="number">149876</span>, <span class="number">151909</span>, <span class="number">157642</span>, <span class="number">163089</span>, <span class="number">168040</span>, <span class="number">173511</span>, <span class="number">179169</span>, <span class="number">184562</span>, <span class="number">189630</span>, <span class="number">195062</span>, <span class="number">200091</span>, <span class="number">205237</span>, <span class="number">210344</span>, <span class="number">215412</span>, <span class="number">220519</span>, <span class="number">225446</span>, <span class="number">225992</span>, <span class="number">228025</span>, <span class="number">233132</span>, <span class="number">234561</span>, <span class="number">240032</span>, <span class="number">245503</span>, <span class="number">250619</span>, <span class="number">255726</span>, <span class="number">257155</span>, <span class="number">262223</span>, <span class="number">267291</span>, <span class="number">272281</span>, <span class="number">277674</span>, <span class="number">282781</span>, <span class="number">284210</span>, <span class="number">289603</span>, <span class="number">294996</span>, <span class="number">300064</span>, <span class="number">305490</span>, <span class="number">310636</span>, <span class="number">311838</span>, <span class="number">312588</span>, <span class="number">317656</span>, <span class="number">322724</span>, <span class="number">327792</span>, <span class="number">332644</span>, <span class="number">338037</span>, <span class="number">343105</span>, <span class="number">348212</span>, <span class="number">353641</span>, <span class="number">358709</span>, <span class="number">364180</span>, <span class="number">369651</span>, <span class="number">371078</span>, <span class="number">372507</span>, <span class="number">377939</span>, <span class="number">383057</span>, <span class="number">388139</span>, <span class="number">392928</span>, <span class="number">396998</span>, <span class="number">402144</span>, <span class="number">402948</span>, <span class="number">407977</span>, <span class="number">413398</span>, <span class="number">418544</span>, <span class="number">420331</span>, <span class="number">425778</span>, <span class="number">430846</span>, <span class="number">435797</span>, <span class="number">440787</span>, <span class="number">445911</span>, <span class="number">451018</span>, <span class="number">456139</span>, <span class="number">461185</span>, <span class="number">462390</span>, <span class="number">463637</span>, <span class="number">468543</span>, <span class="number">473628</span>, <span class="number">479099</span>, <span class="number">484531</span>, <span class="number">485960</span>, <span class="number">490950</span>, <span class="number">496343</span>, <span class="number">501450</span>, <span class="number">506479</span>, <span class="number">511989</span>, <span class="number">513418</span>, <span class="number">519034</span>, <span class="number">524024</span>, <span class="number">529480</span>, <span class="number">534487</span>, <span class="number">539958</span>, <span class="number">545026</span>, <span class="number">550150</span>, <span class="number">555196</span>, <span class="number">560118</span>, <span class="number">565186</span>, <span class="number">570293</span>, <span class="number">575725</span>, <span class="number">580608</span>, <span class="number">585962</span>, <span class="number">591029</span>, <span class="number">595912</span>, <span class="number">601305</span>, <span class="number">606373</span>, <span class="number">611458</span>, <span class="number">616929</span>, <span class="number">618117</span>, <span class="number">619904</span>, <span class="number">625011</span>, <span class="number">630443</span>, <span class="number">631648</span>, <span class="number">637119</span>, <span class="number">642204</span>, <span class="number">643392</span>, <span class="number">648280</span>, <span class="number">649030</span>, <span class="number">654059</span>, <span class="number">659530</span>, <span class="number">665040</span>, <span class="number">667073</span>, <span class="number">668335</span>, <span class="number">673417</span>, <span class="number">674610</span>, <span class="number">679717</span>, <span class="number">685227</span>, <span class="number">686474</span>, <span class="number">691581</span>, <span class="number">692385</span>, <span class="number">697778</span>,<span class="number">702924</span>, <span class="number">708031</span>, <span class="number">713463</span>, <span class="number">718856</span>, <span class="number">723822</span>, <span class="number">728890</span>, <span class="number">733997</span>, <span class="number">739468</span>, <span class="number">744592</span>, <span class="number">749475</span>, <span class="number">754907</span>, <span class="number">760526</span>, <span class="number">765594</span>, <span class="number">766782</span>, <span class="number">772175</span>, <span class="number">777568</span>, <span class="number">781638</span>, <span class="number">786667</span>, <span class="number">788151</span>, <span class="number">793544</span>, <span class="number">799015</span>, <span class="number">799819</span>, <span class="number">801248</span>, <span class="number">806680</span>, <span class="number">811765</span>, <span class="number">816833</span>, <span class="number">821951</span>, <span class="number">826021</span>, <span class="number">827450</span>, <span class="number">832278</span>, <span class="number">836348</span>, <span class="number">841494</span>, <span class="number">846640</span>, <span class="number">852376</span>, <span class="number">857805</span>, <span class="number">862834</span>, <span class="number">867701</span>, <span class="number">872808</span>, <span class="number">878240</span>, <span class="number">883624</span>, <span class="number">889095</span>, <span class="number">894202</span>, <span class="number">899309</span>, <span class="number">904433</span>, <span class="number">909501</span>, <span class="number">914972</span>, <span class="number">920001</span>, <span class="number">925164</span>, <span class="number">926593</span>, <span class="number">928380</span>, <span class="number">933996</span>, <span class="number">939142</span>, <span class="number">944009</span>, <span class="number">949430</span>, <span class="number">954515</span>, <span class="number">959544</span>, <span class="number">960294</span>, <span class="number">965284</span>, <span class="number">970391</span>, <span class="number">975459</span>, <span class="number">980565</span>, <span class="number">984635</span>, <span class="number">985439</span>, <span class="number">990871</span>, <span class="number">991417</span>, <span class="number">996888</span>, <span class="number">1002546</span>, <span class="number">1007670</span>, <span class="number">1012738</span>, <span class="number">1017605</span>, <span class="number">1023115</span>, <span class="number">1028547</span>, <span class="number">1033671</span>, <span class="number">1038499</span>, <span class="number">1043892</span>, <span class="number">1049038</span>, <span class="number">1054464</span>, <span class="number">1055742</span>, <span class="number">1059812</span>, <span class="number">1064880</span>, <span class="number">1069987</span>, <span class="number">1075458</span>, <span class="number">1080526</span>, <span class="number">1085375</span>, <span class="number">1086580</span>, <span class="number">1087785</span>, <span class="number">1088589</span>, <span class="number">1093657</span>, <span class="number">1098686</span>, <span class="number">1104157</span>, <span class="number">1109225</span>, <span class="number">1114696</span>, <span class="number">1118766</span>, <span class="number">1123795</span>, <span class="number">1129305</span>, <span class="number">1134697</span>, <span class="number">1136126</span>, <span class="number">1141597</span>, <span class="number">1143026</span>, <span class="number">1148461</span>, <span class="number">1153529</span>, <span class="number">1158614</span>, <span class="number">1164046</span>, <span class="number">1169556</span>, <span class="number">1175024</span>, <span class="number">1180456</span>, <span class="number">1185580</span>, <span class="number">1190609</span>, <span class="number">1195638</span>, <span class="number">1196826</span>, <span class="number">1201947</span>, <span class="number">1206697</span>, <span class="number">1211804</span>, <span class="number">1217338</span>, <span class="number">1218531</span>, <span class="number">1223599</span>, <span class="number">1227669</span>, <span class="number">1233249</span>, <span class="number">1238672</span>, <span class="number">1243718</span>, <span class="number">1248800</span>, <span class="number">1254458</span>, <span class="number">1259968</span>, <span class="number">1265400</span>, <span class="number">1271019</span>, <span class="number">1276529</span>, <span class="number">1281692</span>, <span class="number">1286799</span>, <span class="number">1288228</span>, <span class="number">1293072</span>, <span class="number">1294319</span>, <span class="number">1295748</span>, <span class="number">1301102</span>, <span class="number">1302531</span>, <span class="number">1307963</span>, <span class="number">1313048</span>,<span class="number">1318543</span>, <span class="number">1323667</span>, <span class="number">1324929</span>, <span class="number">1330623</span>, <span class="number">1335730</span>, <span class="number">1341240</span>, <span class="number">1346386</span>, <span class="number">1351818</span>, <span class="number">1356903</span>, <span class="number">1361971</span>, <span class="number">1367078</span>, <span class="number">1367828</span>, <span class="number">1369016</span>, <span class="number">1371049</span>, <span class="number">1376156</span>, <span class="number">1381549</span>, <span class="number">1386393</span>, <span class="number">1396081</span>, <span class="number">1397274</span>, <span class="number">1402398</span>, <span class="number">1407830</span>, <span class="number">1412937</span>, <span class="number">1414724</span>, <span class="number">1419753</span>, <span class="number">1421540</span>, <span class="number">1426625</span>, <span class="number">1431693</span>, <span class="number">1436800</span>, <span class="number">1442447</span>, <span class="number">1447903</span>, <span class="number">1452971</span>, <span class="number">1458702</span>, <span class="number">1463809</span>, <span class="number">1468876</span>, <span class="number">1473997</span>, <span class="number">1474801</span>, <span class="number">1480571</span>, <span class="number">1485438</span>, <span class="number">1490545</span>, <span class="number">1495535</span>, <span class="number">1501193</span>, <span class="number">1506929</span>, <span class="number">1512006</span>, <span class="number">1517477</span>, <span class="number">1522545</span>, <span class="number">1527977</span>, <span class="number">1533596</span>, <span class="number">1538681</span>, <span class="number">1543763</span>, <span class="number">1549195</span>, <span class="number">1554588</span>, <span class="number">1559656</span>, <span class="number">1564685</span>, <span class="number">1565489</span>, <span class="number">1570921</span>, <span class="number">1571671</span>, <span class="number">1577103</span>, <span class="number">1582535</span>, <span class="number">1588042</span>, <span class="number">1593149</span>, <span class="number">1598605</span>, <span class="number">1599355</span>, <span class="number">1604501</span>, <span class="number">1609608</span>, <span class="number">1611093</span>, <span class="number">1616161</span>, <span class="number">1621858</span>, <span class="number">1627251</span>, <span class="number">1632683</span>, <span class="number">1637790</span>, <span class="number">1642908</span>, <span class="number">1648015</span>, <span class="number">1653139</span>, <span class="number">1658224</span>, <span class="number">1663292</span>, <span class="number">1668748</span>, <span class="number">1673816</span>, <span class="number">1679248</span>, <span class="number">1684291</span>, <span class="number">1689320</span>, <span class="number">1694725</span>, <span class="number">1700196</span>, <span class="number">1705628</span>, <span class="number">1710594</span>, <span class="number">1716056</span>, <span class="number">1716806</span>, <span class="number">1717610</span>, <span class="number">1722639</span>, <span class="number">1722999</span>, <span class="number">1728392</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (UINT64 rva : rvaList) &#123;</span><br><span class="line">            ADDRINT va = imageBase + rva;</span><br><span class="line">            targetAddresses.<span class="built_in">insert</span>(va);</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Added hook at VA: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; va &lt;&lt; <span class="string">&quot; (RVA=0x&quot;</span> &lt;&lt; rva &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span> </span>&#123;</span><br><span class="line">    traceFile.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PIN_Init</span>(argc, argv)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Usage: ./pin -t hook_rva.so -- &lt;target_program&gt;&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    traceFile.<span class="built_in">open</span>(<span class="string">&quot;hit_addresses.log&quot;</span>);</span><br><span class="line">    <span class="built_in">IMG_AddInstrumentFunction</span>(ImageLoad, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">INS_AddInstrumentFunction</span>(Instruction, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">PIN_AddFiniFunction</span>(Fini, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">PIN_StartProgram</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>then we launch the program:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./pin -t hook.so -- ./damnida</span><br></pre></td></tr></table></figure>

<p>output is the <code>hit_addresses.log</code>, we use a python script to visualize it:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">funcs = [...]</span><br><span class="line">offset_to_index = &#123;offset: idx <span class="keyword">for</span> idx, offset <span class="keyword">in</span> <span class="built_in">enumerate</span>(funcs)&#125;</span><br><span class="line">BASE = 0x...</span><br><span class="line"></span><br><span class="line">indices = []</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;hit_addresses.log&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        line = line.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            addr = <span class="built_in">int</span>(line, <span class="number">16</span>)</span><br><span class="line">            offset = addr - BASE</span><br><span class="line">            <span class="keyword">if</span> offset <span class="keyword">in</span> offset_to_index:</span><br><span class="line">                indices.append(offset_to_index[offset])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Warning: offset <span class="subst">&#123;<span class="built_in">hex</span>(offset)&#125;</span> not found in funcs&quot;</span>)</span><br><span class="line">                indices.append(-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Invalid hex value: <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line">            indices.append(-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">x_vals = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(indices)))</span><br><span class="line">plt.figure(figsize=(<span class="number">12</span>, <span class="number">6</span>))</span><br><span class="line">plt.scatter(x_vals, indices, s=<span class="number">10</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Function Index&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Line Number&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Function Index&#x27;</span>)</span><br><span class="line">plt.grid(<span class="literal">True</span>)</span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>and the visual image is:</p>
<p><img src="/pictures/dreamhack_275_1.png" title="fig"></p>
<p>then, <code>blindly test</code> where the check starts and how to verify it (such as <code>single byte</code> or <code>multi byte</code>, with or without <code>length verification</code>). First, try if there are some length limit. Change the script to count times only <strong>but add a rule</strong>: If there are <strong>no new hooks</strong> within <strong>5 seconds</strong>, <strong>insert a prompt</strong> so that we can distinguish which ones are executed after we input strings:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pin.H&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line">std::unordered_set&lt;ADDRINT&gt; targetAddresses;</span><br><span class="line">ADDRINT imageBase = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;UINT64&gt; tickMs&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;UINT64&gt; lastHitMs&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; toolActive&#123;<span class="literal">true</span>&#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;UINT64&gt; hitCount&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; splitDone&#123;<span class="literal">false</span>&#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;UINT64&gt; beforeSplitCount&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">static</span> PIN_THREAD_UID monitorUid = INVALID_PIN_THREAD_UID;</span><br><span class="line"><span class="type">static</span> THREADID monitorTid = INVALID_THREADID;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">RecordHit</span><span class="params">(THREADID <span class="comment">/*tid*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    hitCount.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">    lastHitMs.<span class="built_in">store</span>(tickMs.<span class="built_in">load</span>(std::memory_order_relaxed), std::memory_order_relaxed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID* <span class="comment">/*v*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ADDRINT insAddr = <span class="built_in">INS_Address</span>(ins);</span><br><span class="line">    <span class="keyword">if</span> (targetAddresses.<span class="built_in">find</span>(insAddr) != targetAddresses.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">INS_InsertCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)RecordHit, IARG_THREAD_ID, IARG_END);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ImageLoad</span><span class="params">(IMG img, VOID* <span class="comment">/*v*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IMG_IsMainExecutable</span>(img)) <span class="keyword">return</span>;</span><br><span class="line">    imageBase = <span class="built_in">IMG_LowAddress</span>(img);</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;[*] Main image base: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; imageBase &lt;&lt; std::dec &lt;&lt; <span class="string">&quot;\\n&quot;</span>;</span><br><span class="line">    std::vector&lt;UINT64&gt; rvaList = &#123;...&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (UINT64 rva : rvaList)</span><br><span class="line">        targetAddresses.<span class="built_in">insert</span>(imageBase + rva);</span><br><span class="line">    lastHitMs.<span class="built_in">store</span>(tickMs.<span class="built_in">load</span>(std::memory_order_relaxed), std::memory_order_relaxed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">TimeoutMonitor</span><span class="params">(VOID* <span class="comment">/*arg*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (toolActive.<span class="built_in">load</span>(std::memory_order_relaxed))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">PIN_Sleep</span>(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        UINT64 now = tickMs.<span class="built_in">fetch_add</span>(<span class="number">1000</span>, std::memory_order_relaxed) + <span class="number">1000</span>;</span><br><span class="line">        UINT64 last = lastHitMs.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!splitDone.<span class="built_in">load</span>(std::memory_order_relaxed) &amp;&amp; (now - last &gt;= <span class="number">5000</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            UINT64 before = hitCount.<span class="built_in">exchange</span>(<span class="number">0</span>, std::memory_order_relaxed);</span><br><span class="line">            beforeSplitCount.<span class="built_in">store</span>(before, std::memory_order_relaxed);</span><br><span class="line">            splitDone.<span class="built_in">store</span>(<span class="literal">true</span>, std::memory_order_relaxed);</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[*] 5sec split triggered. before=&quot;</span> &lt;&lt; before &lt;&lt; <span class="string">&quot;\\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">PIN_ExitThread</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">PrepareForFini</span><span class="params">(VOID* <span class="comment">/*v*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    toolActive.<span class="built_in">store</span>(<span class="literal">false</span>, std::memory_order_relaxed);</span><br><span class="line">    <span class="keyword">if</span> (monitorUid != INVALID_PIN_THREAD_UID)</span><br><span class="line">    &#123;</span><br><span class="line">        INT32 exitCode = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">PIN_WaitForThreadTermination</span>(monitorUid, <span class="number">10</span> * <span class="number">1000</span>, &amp;exitCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Fini</span><span class="params">(INT32 <span class="comment">/*code*/</span>, VOID* <span class="comment">/*v*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UINT64 after = hitCount.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (splitDone.<span class="built_in">load</span>(std::memory_order_relaxed))</span><br><span class="line">    &#123;</span><br><span class="line">        UINT64 before = beforeSplitCount.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;before=&quot;</span> &lt;&lt; before &lt;&lt; <span class="string">&quot;\\n&quot;</span>;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;after=&quot;</span> &lt;&lt; after &lt;&lt; <span class="string">&quot;\\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;after=&quot;</span> &lt;&lt; after &lt;&lt; <span class="string">&quot;\\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PIN_Init</span>(argc, argv))</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Usage: pin -t MyPinTool.so -- &lt;target_program&gt;\\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">IMG_AddInstrumentFunction</span>(ImageLoad, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">INS_AddInstrumentFunction</span>(Instruction, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">PIN_AddPrepareForFiniFunction</span>(PrepareForFini, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">PIN_AddFiniFunction</span>(Fini, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    monitorTid = <span class="built_in">PIN_SpawnInternalThread</span>(TimeoutMonitor, <span class="literal">nullptr</span>, <span class="number">0</span>, &amp;monitorUid);</span><br><span class="line">    <span class="keyword">if</span> (monitorTid == INVALID_THREADID)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to spawn internal monitor thread.\\n&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">PIN_StartProgram</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>and use a python script to test len 1 ~ 128:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> selectors</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">PIN_CMD = [<span class="string">&quot;./pin&quot;</span>, <span class="string">&quot;-t&quot;</span>, <span class="string">&quot;hook_count.so&quot;</span>, <span class="string">&quot;--&quot;</span>, <span class="string">&quot;./damnida&quot;</span>]</span><br><span class="line"></span><br><span class="line">SPLIT_RE = re.<span class="built_in">compile</span>(<span class="string">r&quot;split triggered\\. before=(\\d+)&quot;</span>)</span><br><span class="line">AFTER_RE = re.<span class="built_in">compile</span>(<span class="string">r&quot;after=(\\d+)&quot;</span>)</span><br><span class="line">BEFORE_RE = re.<span class="built_in">compile</span>(<span class="string">r&quot;\\bbefore=(\\d+)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_one</span>(<span class="params">test_input: <span class="built_in">str</span>, timeout_sec: <span class="built_in">float</span> = <span class="number">60.0</span></span>):</span><br><span class="line">    p = subprocess.Popen(PIN_CMD, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, bufsize=<span class="number">0</span>)</span><br><span class="line">    sel = selectors.DefaultSelector()</span><br><span class="line">    sel.register(p.stdout, selectors.EVENT_READ)</span><br><span class="line">    buf = <span class="string">&quot;&quot;</span></span><br><span class="line">    before = <span class="literal">None</span></span><br><span class="line">    sent = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    start = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">feed_input</span>():</span><br><span class="line">        <span class="keyword">nonlocal</span> sent</span><br><span class="line">        <span class="keyword">if</span> sent: <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p.stdin.write((test_input + <span class="string">&quot;\\n&quot;</span>).encode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>))</span><br><span class="line">            p.stdin.flush()</span><br><span class="line">            sent = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span> BrokenPipeError: sent = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> time.time() - start &gt; timeout_sec:</span><br><span class="line">            <span class="keyword">try</span>: p.kill()</span><br><span class="line">            <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">raise</span> TimeoutError(<span class="string">&quot;Timeout waiting for program output / split trigger.&quot;</span>)</span><br><span class="line">        events = sel.select(timeout=<span class="number">0.2</span>)</span><br><span class="line">        <span class="keyword">for</span> key, _ <span class="keyword">in</span> events:</span><br><span class="line">            chunk = os.read(key.fileobj.fileno(), <span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chunk: <span class="keyword">continue</span></span><br><span class="line">            s = chunk.decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;replace&quot;</span>)</span><br><span class="line">            buf += s</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">not</span> sent):</span><br><span class="line">                m = SPLIT_RE.search(buf)</span><br><span class="line">                <span class="keyword">if</span> m:</span><br><span class="line">                    before = <span class="built_in">int</span>(m.group(<span class="number">1</span>))</span><br><span class="line">                    feed_input()</span><br><span class="line">        <span class="keyword">if</span> p.poll() <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># drain</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>: chunk = os.read(p.stdout.fileno(), <span class="number">4096</span>)</span><br><span class="line">                <span class="keyword">except</span> Exception: <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> chunk: <span class="keyword">break</span></span><br><span class="line">                buf += chunk.decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;replace&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    sel.unregister(p.stdout)</span><br><span class="line">    <span class="keyword">try</span>: p.stdout.close()</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> before <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        m2 = BEFORE_RE.search(buf)</span><br><span class="line">        <span class="keyword">if</span> m2: before = <span class="built_in">int</span>(m2.group(<span class="number">1</span>))</span><br><span class="line">    m3 = AFTER_RE.search(buf)</span><br><span class="line">    after = <span class="built_in">int</span>(m3.group(<span class="number">1</span>)) <span class="keyword">if</span> m3 <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> before, after, buf</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">gen_input</span>(<span class="params">n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>: <span class="keyword">return</span> <span class="string">&quot;A&quot;</span> * n</span><br><span class="line">    results = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">129</span>):</span><br><span class="line">        s = gen_input(n)</span><br><span class="line">        <span class="keyword">try</span>: before, after, out = run_one(s)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;n&#125;</span>\\tERROR\\t<span class="subst">&#123;e&#125;</span>&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        results.setdefault(after, <span class="number">0</span>)</span><br><span class="line">        results[after] += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;n&#125;</span>\\tbefore=<span class="subst">&#123;before&#125;</span>\\tafter=<span class="subst">&#123;after&#125;</span>&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\\n=== after ===&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">sorted</span>(results.keys(), key=<span class="keyword">lambda</span> x: (x <span class="keyword">is</span> <span class="literal">None</span>, x)): <span class="built_in">print</span>(<span class="string">f&quot;after=<span class="subst">&#123;k&#125;</span>\\tcount=<span class="subst">&#123;results[k]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>: main()</span><br></pre></td></tr></table></figure>

<p>Note that for all length of input from 0 to 100, all are <strong>4139 before and 5703 after</strong>. Seems no length limit.</p>
<p>Then, add detailed log to visualize:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pin.H&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"></span><br><span class="line">std::ofstream traceFile;</span><br><span class="line">std::unordered_set&lt;ADDRINT&gt; targetAddresses;</span><br><span class="line">ADDRINT imageBase = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> PIN_LOCK logLock;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;UINT64&gt; tickMs&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;UINT64&gt; lastHitMs&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">static</span> std::atomic&lt;<span class="type">bool</span>&gt; toolActive&#123;<span class="literal">true</span>&#125;;</span><br><span class="line"><span class="type">static</span> PIN_THREAD_UID monitorUid = INVALID_PIN_THREAD_UID;</span><br><span class="line"><span class="type">static</span> THREADID monitorTid = INVALID_THREADID;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">RecordAddress</span><span class="params">(THREADID tid, ADDRINT addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ADDRINT rva = addr - imageBase;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PIN_GetLock</span>(&amp;logLock, (INT32)tid + <span class="number">1</span>);</span><br><span class="line">    traceFile &lt;&lt; <span class="string">&quot;0x&quot;</span> &lt;&lt; std::hex &lt;&lt; rva &lt;&lt; std::endl;</span><br><span class="line">    traceFile.<span class="built_in">flush</span>();</span><br><span class="line">    <span class="built_in">PIN_ReleaseLock</span>(&amp;logLock);</span><br><span class="line">    lastHitMs.<span class="built_in">store</span>(tickMs.<span class="built_in">load</span>(std::memory_order_relaxed), std::memory_order_relaxed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ADDRINT insAddr = <span class="built_in">INS_Address</span>(ins);</span><br><span class="line">    <span class="keyword">if</span> (targetAddresses.<span class="built_in">find</span>(insAddr) != targetAddresses.<span class="built_in">end</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">INS_InsertCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)RecordAddress,IARG_THREAD_ID, IARG_ADDRINT, insAddr, IARG_END);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ImageLoad</span><span class="params">(IMG img, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IMG_IsMainExecutable</span>(img))</span><br><span class="line">    &#123;</span><br><span class="line">        imageBase = <span class="built_in">IMG_LowAddress</span>(img);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;[*] Loaded at base: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; imageBase &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        std::vector&lt;UINT64&gt; rvaList = &#123;...&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (UINT64 rva : rvaList)</span><br><span class="line">        &#123;</span><br><span class="line">            ADDRINT va = imageBase + rva;</span><br><span class="line">            targetAddresses.<span class="built_in">insert</span>(va);</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Added hook at VA: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; va</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; (RVA=0x&quot;</span> &lt;&lt; rva &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastHitMs.<span class="built_in">store</span>(tickMs.<span class="built_in">load</span>(std::memory_order_relaxed), std::memory_order_relaxed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">TimeoutMonitor</span><span class="params">(VOID *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (toolActive.<span class="built_in">load</span>(std::memory_order_relaxed))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">PIN_Sleep</span>(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        UINT64 now = tickMs.<span class="built_in">fetch_add</span>(<span class="number">1000</span>, std::memory_order_relaxed) + <span class="number">1000</span>;</span><br><span class="line">        UINT64 last = lastHitMs.<span class="built_in">load</span>(std::memory_order_relaxed);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (now - last &gt;= <span class="number">5000</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">PIN_GetLock</span>(&amp;logLock, <span class="number">0</span>);</span><br><span class="line">            traceFile &lt;&lt; <span class="string">&quot;--- 5sec ---&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            traceFile.<span class="built_in">flush</span>();</span><br><span class="line">            <span class="built_in">PIN_ReleaseLock</span>(&amp;logLock);</span><br><span class="line"></span><br><span class="line">            lastHitMs.<span class="built_in">store</span>(now, std::memory_order_relaxed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PIN_ExitThread</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">PrepareForFini</span><span class="params">(VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    toolActive.<span class="built_in">store</span>(<span class="literal">false</span>, std::memory_order_relaxed);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (monitorUid != INVALID_PIN_THREAD_UID)</span><br><span class="line">    &#123;</span><br><span class="line">        INT32 exitCode = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">PIN_WaitForThreadTermination</span>(monitorUid, <span class="number">10</span> * <span class="number">1000</span>, &amp;exitCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    traceFile.<span class="built_in">close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PIN_Init</span>(argc, argv))</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Usage: ./pin -t MyPinTool.so -- &lt;target_program&gt;&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PIN_InitLock</span>(&amp;logLock);</span><br><span class="line"></span><br><span class="line">    traceFile.<span class="built_in">open</span>(<span class="string">&quot;hit_addresses.log&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!traceFile.<span class="built_in">is_open</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Cannot open hit_addresses.log for writing!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">IMG_AddInstrumentFunction</span>(ImageLoad, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">INS_AddInstrumentFunction</span>(Instruction, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">PIN_AddPrepareForFiniFunction</span>(PrepareForFini, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">PIN_AddFiniFunction</span>(Fini, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    monitorTid = <span class="built_in">PIN_SpawnInternalThread</span>(TimeoutMonitor, <span class="literal">nullptr</span>, <span class="number">0</span>, &amp;monitorUid);</span><br><span class="line">    <span class="keyword">if</span> (monitorTid == INVALID_THREADID)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;Failed to spawn internal monitor thread.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">PIN_StartProgram</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>python script to visualize the output:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">funcs = [...]</span><br><span class="line">offset_to_index = &#123;offset: idx <span class="keyword">for</span> idx, offset <span class="keyword">in</span> <span class="built_in">enumerate</span>(funcs)&#125;</span><br><span class="line"></span><br><span class="line">indices = []</span><br><span class="line">colors = []</span><br><span class="line">current_color = <span class="string">&#x27;blue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;hit_addresses.log&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        line = line.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;---&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">            current_color = <span class="string">&#x27;red&#x27;</span> <span class="keyword">if</span> current_color == <span class="string">&#x27;blue&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;blue&#x27;</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            addr = <span class="built_in">int</span>(line, <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">if</span> addr <span class="keyword">in</span> offset_to_index:</span><br><span class="line">                indices.append(offset_to_index[addr])</span><br><span class="line">                colors.append(current_color)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Warning: address <span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span> not found in funcs&quot;</span>)</span><br><span class="line">                indices.append(-<span class="number">1</span>)</span><br><span class="line">                colors.append(current_color)</span><br><span class="line">        <span class="keyword">except</span> ValueError:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Invalid hex value: <span class="subst">&#123;line&#125;</span>&quot;</span>)</span><br><span class="line">            indices.append(-<span class="number">1</span>)</span><br><span class="line">            colors.append(current_color)</span><br><span class="line"></span><br><span class="line">x_vals = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(indices)))</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">12</span>, <span class="number">6</span>))</span><br><span class="line">plt.scatter(x_vals, indices, s=<span class="number">10</span>, c=colors)</span><br><span class="line"></span><br><span class="line">plt.title(<span class="string">&#x27;Function Index&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Line Number&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Function Index&#x27;</span>)</span><br><span class="line">plt.grid(<span class="literal">True</span>)</span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>The red color were all happened after input:</p>
<p><img src="/pictures/dreamhack_275_2.png" title="fig"></p>
<p>Note that most functions have <strong>strong loop characteristics</strong>, use scripts to <strong>optimize</strong> loops:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">INPUT_FILE = <span class="string">&#x27;hit_addresses.log&#x27;</span></span><br><span class="line">OUTPUT_FILE = <span class="string">&#x27;optimized.log&#x27;</span></span><br><span class="line"></span><br><span class="line">funcs = [...]</span><br><span class="line">offset_to_index = &#123;addr: idx <span class="keyword">for</span> idx, addr <span class="keyword">in</span> <span class="built_in">enumerate</span>(funcs)&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_best_loop</span>(<span class="params">seq, start, max_period=<span class="number">100</span></span>):</span><br><span class="line">    L = <span class="built_in">len</span>(seq)</span><br><span class="line">    best_loop = <span class="literal">None</span></span><br><span class="line">    max_saved = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, max_period + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> start + p * <span class="number">2</span> &gt; L: <span class="keyword">break</span></span><br><span class="line">        pattern = seq[start : start + p]</span><br><span class="line">        reps = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> start + (reps + <span class="number">1</span>) * p &lt;= L:</span><br><span class="line">            <span class="keyword">if</span> seq[start + reps * p : start + (reps + <span class="number">1</span>) * p] == pattern: reps += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>: <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> reps &gt;= <span class="number">2</span>:</span><br><span class="line">            saved = (reps - <span class="number">1</span>) * p - <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> saved &gt; max_saved:</span><br><span class="line">                max_saved = saved</span><br><span class="line">                best_loop = (p, reps)</span><br><span class="line">    <span class="keyword">return</span> best_loop</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_func_segment</span>(<span class="params">func_block</span>):</span><br><span class="line">    output = []</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    L = <span class="built_in">len</span>(func_block)</span><br><span class="line">    <span class="keyword">while</span> i &lt; L:</span><br><span class="line">        loop = find_best_loop(func_block, i)</span><br><span class="line">        <span class="keyword">if</span> loop:</span><br><span class="line">            p, reps = loop</span><br><span class="line">            output.append(<span class="string">f&quot;--- begin loop <span class="subst">&#123;reps&#125;</span> rounds ---&quot;</span>)</span><br><span class="line">            output.extend(func_block[i : i + p])</span><br><span class="line">            output.append(<span class="string">f&quot;--- end loop ---&quot;</span>)</span><br><span class="line">            i += p * reps</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            output.append(func_block[i])</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(INPUT_FILE):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;INPUT_FILE&#125;</span> not found.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    processed_lines = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(INPUT_FILE, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            stripped = line.strip()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> stripped: <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                addr = <span class="built_in">int</span>(stripped, <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">if</span> addr <span class="keyword">in</span> offset_to_index: processed_lines.append(<span class="string">f&quot;func_<span class="subst">&#123;offset_to_index[addr]&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>: processed_lines.append(<span class="string">f&quot;unknown_<span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">except</span> ValueError: processed_lines.append(stripped)</span><br><span class="line">    final_output = []</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    n = <span class="built_in">len</span>(processed_lines)</span><br><span class="line">    <span class="keyword">while</span> i &lt; n:</span><br><span class="line">        <span class="keyword">if</span> processed_lines[i].startswith(<span class="string">&#x27;func_&#x27;</span>):</span><br><span class="line">            j = i</span><br><span class="line">            func_block = []</span><br><span class="line">            <span class="keyword">while</span> j &lt; n <span class="keyword">and</span> (processed_lines[j].startswith(<span class="string">&#x27;func_&#x27;</span>) <span class="keyword">or</span> processed_lines[j].startswith(<span class="string">&#x27;unknown_&#x27;</span>)):</span><br><span class="line">                func_block.append(processed_lines[j])</span><br><span class="line">                j += <span class="number">1</span></span><br><span class="line">            final_output.extend(process_func_segment(func_block))</span><br><span class="line">            i = j</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            final_output.append(processed_lines[i])</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(OUTPUT_FILE, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> final_output: f.write(line + <span class="string">&#x27;\\n&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Done! Optimized <span class="subst">&#123;<span class="built_in">len</span>(processed_lines)&#125;</span> lines down to <span class="subst">&#123;<span class="built_in">len</span>(final_output)&#125;</span> lines.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>this change total <strong>9,842 lines to only 380 lines</strong>, and notice that there are <strong>2 * 256 round loops, 1 * 4 round loop and 1 * 16 round loop</strong>, which are suspicious. Then visualize it:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">LOOP_COLOR = <span class="string">&#x27;blue&#x27;</span></span><br><span class="line">NON_LOOP_COLOR = <span class="string">&#x27;red&#x27;</span></span><br><span class="line"></span><br><span class="line">indices = []</span><br><span class="line">colors = []</span><br><span class="line">current_color = NON_LOOP_COLOR</span><br><span class="line">highlight_positions = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;optimized.log&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    lines = f.readlines()</span><br><span class="line">    <span class="keyword">for</span> i, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(lines):</span><br><span class="line">        stripped = line.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;--- 5sec&#x27;</span> <span class="keyword">in</span> stripped: highlight_positions.append(i)</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;--- begin loop&#x27;</span> <span class="keyword">in</span> stripped: current_color = LOOP_COLOR</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;--- end loop&#x27;</span> <span class="keyword">in</span> stripped: current_color = NON_LOOP_COLOR</span><br><span class="line">        <span class="keyword">elif</span> stripped.startswith(<span class="string">&#x27;func_&#x27;</span>):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                idx = <span class="built_in">int</span>(stripped[<span class="number">5</span>:])</span><br><span class="line">                indices.append(idx)</span><br><span class="line">                colors.append(current_color)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Warning: invalid func line: <span class="subst">&#123;stripped&#125;</span>&quot;</span>)</span><br><span class="line">                indices.append(-<span class="number">1</span>)</span><br><span class="line">                colors.append(current_color)</span><br><span class="line"></span><br><span class="line">x_vals = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(indices)))</span><br><span class="line">plt.figure(figsize=(<span class="number">12</span>, <span class="number">6</span>))</span><br><span class="line">plt.scatter(x_vals, indices, s=<span class="number">10</span>, c=colors)</span><br><span class="line"><span class="keyword">for</span> pos <span class="keyword">in</span> highlight_positions: plt.axvline(x=pos, color=<span class="string">&#x27;green&#x27;</span>, linestyle=<span class="string">&#x27;--&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;Function Index with Loop and Input Markers&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;Func Line Number&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Function Index&#x27;</span>)</span><br><span class="line">plt.grid(<span class="literal">True</span>)</span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>output (red are out of loop, blue are in the loop, green line is the input marker):</p>
<p><img src="/pictures/dreamhack_275_3.png" title="fig"></p>
<p>the optimized log:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func_55, func_238, func_240, func_60, func_176, func_221, func_371, func_309, func_364, func_249, func_153, func_91, func_318, func_218, func_204, func_206, func_350, func_121, func_129, func_366</span><br><span class="line">--- begin loop 256 rounds ---</span><br><span class="line">func_344, func_216, func_2, func_141, func_334, func_99, func_234, func_315, func_17, func_332, func_269, func_215, func_299, func_245, func_208, func_123</span><br><span class="line">--- end loop ---</span><br><span class="line">func_344, func_216, func_2, func_141, func_334, func_130, func_339, func_150, func_73, func_261, func_228, func_64, func_128, func_46, func_263, func_4, func_75, func_190, func_33, func_214, func_368, func_116, func_161</span><br><span class="line">--- 5sec ---</span><br><span class="line">func_345, func_9, func_29, func_93, func_360, func_174, func_189, func_223, func_259, func_79, func_148, func_177, func_170, func_183, func_38, func_132, func_286, func_254, func_342</span><br><span class="line">--- begin loop 256 rounds ---</span><br><span class="line">func_290, func_24, func_329, func_90, func_316, func_320, func_18, func_72, func_171, func_325, func_262, func_140, func_138, func_307, func_28, func_303</span><br><span class="line">--- end loop ---</span><br><span class="line">func_290, func_24, func_329, func_90, func_316, func_311, func_7, func_264, func_44, func_242, func_276, func_82, func_125, func_253, func_96, func_338, func_49, func_114, func_54, func_159, func_3, func_297, func_119, func_61, func_273, func_154, func_142, func_226, func_241, func_117, func_83, func_67, func_101, func_52, func_219, func_192, func_105, func_352, func_26, func_95, func_252, func_118, func_280, func_6, func_365, func_108, func_10, func_324, func_193, func_260, func_94, func_126, func_224, func_11, func_89, func_86, func_47, func_122, func_131</span><br><span class="line">--- begin loop 4 rounds ---</span><br><span class="line">func_37, func_39, func_283, func_207, func_181, func_145, func_165, func_0, func_361, func_63, func_185, func_68, func_27, func_133, func_265, func_48, func_78, func_335, func_25, func_199, func_285, func_301, func_137, func_205, func_317, func_180, func_152, func_359, func_314, func_312, func_103, func_32, func_358, func_135, func_333, func_267, func_80</span><br><span class="line">--- end loop ---</span><br><span class="line">func_37, func_39, func_283, func_207, func_232, func_247, func_109, func_258, func_319, func_337, func_167, func_235, func_331, func_158, func_336</span><br><span class="line">--- begin loop 16 rounds ---</span><br><span class="line">func_139, func_160, func_136, func_231, func_57, func_236, func_217, func_281, func_15, func_220, func_330, func_92, func_104, func_21, func_62, func_164, func_85, func_308, func_321, func_162, func_202, func_144, func_328, func_341, func_22, func_355, func_5, func_268, func_178, func_251, func_23, func_134, func_88, func_266, func_284, func_107, func_115, func_20, func_58, func_279, func_120, func_31, func_50, func_294, func_233, func_40, func_354, func_356, func_182, func_213, func_1, func_188, func_310, func_195, func_340, func_127, func_8, func_112, func_327, func_187, func_272, func_113, func_212, func_81, func_191, func_198, func_326, func_322, func_289, func_304, func_370, func_246, func_347, func_102, func_302, func_147, func_36, func_257, func_106, func_194</span><br><span class="line">--- end loop ---</span><br><span class="line">func_139, func_160, func_136, func_231, func_225, func_210, func_271, func_84, func_70, func_306, func_243, func_343, func_348, func_282, func_13, func_184, func_357, func_313, func_296, func_169, func_173, func_369, func_151, func_362, func_230, func_274, func_110, func_157, func_349, func_278, func_346, func_51, func_69, func_98, func_270, func_293, func_292, func_200, func_168, func_255, func_275, func_166, func_295, func_250, func_14, func_71, func_291, func_211, func_363, func_323, func_59, func_155, func_87, func_351, func_287, func_156, func_66, func_41, func_163, func_367, func_45, func_239, func_229, func_201, func_30, func_100, func_300, func_42, func_97, func_43, func_124, func_277, func_222, func_76, func_149, func_19, func_196, func_74, func_256, func_111, func_53, func_353, func_244, func_143, func_298, func_35</span><br></pre></td></tr></table></figure>

<h2 id="Segmented-Analysis"><a href="#Segmented-Analysis" class="headerlink" title="Segmented Analysis"></a>Segmented Analysis</h2><h3 id="I-The-First-256-Round-Loop"><a href="#I-The-First-256-Round-Loop" class="headerlink" title="I. The First 256 Round Loop"></a>I. The First 256 Round Loop</h3><p>Analyze any function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">func_36</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  a1[<span class="number">189</span>] = <span class="number">-1083127581</span>;</span><br><span class="line">  a1[<span class="number">189</span>] -= <span class="number">0xDCACBBFBC0CEBA3LL</span>;</span><br><span class="line">  v7 = a1[<span class="number">189</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !a1[<span class="number">190</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">189</span>] = (<span class="type">int</span>)v7;</span><br><span class="line">    a1[<span class="number">189</span>] ^= <span class="number">0x4C5617340363DD40uLL</span>;</span><br><span class="line">    v7 = a1[<span class="number">189</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  v1 = a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[(v7 &gt;&gt; <span class="number">3</span>) + <span class="number">160</span>]];</span><br><span class="line">  a1[<span class="number">189</span>] = <span class="number">279415311</span>;</span><br><span class="line">  a1[<span class="number">189</span>] ^= <span class="number">0x3E8E4DEA3F310A25uLL</span>;</span><br><span class="line">  v6 = a1[<span class="number">189</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !a1[<span class="number">190</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">189</span>] = (<span class="type">int</span>)v6;</span><br><span class="line">    a1[<span class="number">189</span>] += <span class="number">0x5826E559D0698066LL</span>;</span><br><span class="line">    v6 = a1[<span class="number">189</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = *(_QWORD *)a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[(v6 &gt;&gt; <span class="number">3</span>) + <span class="number">160</span>]] - v1;</span><br><span class="line">  v2 = __readeflags();</span><br><span class="line">  a1[<span class="number">181</span>] = v2;</span><br><span class="line">  a1[<span class="number">189</span>] = <span class="number">279415311</span>;</span><br><span class="line">  a1[<span class="number">189</span>] ^= <span class="number">0x3E8E4DEA3F310A25uLL</span>;</span><br><span class="line">  v4 = a1[<span class="number">189</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !a1[<span class="number">190</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">189</span>] = (<span class="type">int</span>)v4;</span><br><span class="line">    a1[<span class="number">189</span>] += <span class="number">0x5826E559D0698066LL</span>;</span><br><span class="line">    v4 = a1[<span class="number">189</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  *(_QWORD *)a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[(v4 &gt;&gt; <span class="number">3</span>) + <span class="number">160</span>]] = v5;</span><br><span class="line">  a1[<span class="number">189</span>] = <span class="number">0xD3A4F2C6013A249DLL</span>;</span><br><span class="line">  a1[<span class="number">189</span>] ^= <span class="number">0x78BFCC6B59A79E9AuLL</span>;</span><br><span class="line">  v8 = a1[<span class="number">189</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !a1[<span class="number">190</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">189</span>] = v8;</span><br><span class="line">    a1[<span class="number">189</span>] ^= <span class="number">0xAB1B3EAD589DB8B4LL</span>;</span><br><span class="line">    v8 = a1[<span class="number">189</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (*(__int64 (__fastcall **)(_QWORD *))(<span class="number">8</span> * v8 + a1[<span class="number">183</span>]))(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note that there are 2 main place to calc the “<strong>obf data</strong>“, [189] and [190], [190] uses for choosing case, and [189] uses for calculating. There are also [181] and [183], and the data is from a1[a1[xxx + 160]]. <strong><del>Not very obviously</del></strong>, this program <strong>breaks the whole calculation into singular operators</strong> (just like <a href="https://astralprisma.github.io/2025/11/02/about_flowers_2/">True Operator Master</a>), put them into 372 functions, and in each function uses one tag (a1[190]) to control another tag (a1[189]) ’s calculation (with a little bit obfuscated), use this tag to <strong>construct immediate numbers and calculate for the indirect jump index</strong>. The functions use <strong>indirect jumps</strong> to connect with each other (just like <a href="https://astralprisma.github.io/2025/10/08/flareon_12/">Flare On 12 #8</a>). The whole program’s data and status are <strong>in the stack</strong> and the <strong>anonymous mapping</strong> which was created by mmap().</p>
<p>Extract this whole part of data (from index 0 to about 200) before the first 256 round loop:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>]:D2F0 off_7FFFFFFFD2F0 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">1</span>]:D2F8 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">2</span>]:D300 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">3</span>]:D308 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">4</span>]:D310 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">5</span>]:D318 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">6</span>]:D320 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">7</span>]:D328 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">8</span>]:D330 <span class="built_in">dq</span> offset off_7FFFFFFFD400</span><br><span class="line">[<span class="number">9</span>]:D338 <span class="built_in">dq</span> offset unk_7FFFF7FD8878</span><br><span class="line">[<span class="number">10</span>]:D340 <span class="built_in">dq</span> offset off_7FFFF7FFE2E0</span><br><span class="line">[<span class="number">11</span>]:D348 <span class="built_in">dq</span> offset off_7FFFF7FBD160</span><br><span class="line">[<span class="number">12</span>]:D350 <span class="built_in">dq</span> offset off_7FFFF7FFDAB0</span><br><span class="line">[<span class="number">13</span>]:D358 <span class="built_in">dq</span> offset off_7FFFF7FBD160</span><br><span class="line">[<span class="number">14</span>]:D360 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">15</span>]:D368 <span class="built_in">dq</span> offset aLdLinuxX8664So               <span class="comment">; &quot;ld-linux-x86-64.so.2&quot;</span></span><br><span class="line">[<span class="number">16</span>]:D370 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">17</span>]:D378 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">18</span>]:D380 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">19</span>]:D388 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">20</span>]:D390 <span class="built_in">dq</span> <span class="number">78h</span></span><br><span class="line">...</span><br><span class="line">[<span class="number">100</span>]:D620 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">101</span>]:D628 <span class="built_in">dq</span> offset unk_7FFFF7FCF4C3</span><br><span class="line">[<span class="number">102</span>]:D630 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">103</span>]:D638 <span class="built_in">dq</span> offset off_7FFFF7FFDAB0</span><br><span class="line">[<span class="number">104</span>]:D640 <span class="built_in">dq</span> <span class="number">5702B738h</span></span><br><span class="line">[<span class="number">105</span>]:D648 <span class="built_in">dq</span> offset unk_7FFFF7FC5590</span><br><span class="line">[<span class="number">106</span>]:D650 <span class="built_in">dq</span> offset unk_7FFFF7FC5568</span><br><span class="line">[<span class="number">107</span>]:D658 <span class="built_in">dq</span> offset unk_7FFFF7FC5950</span><br><span class="line">[<span class="number">108</span>]:D660 <span class="built_in">dq</span> offset qword_7FFFFFFFD750</span><br><span class="line">[<span class="number">109</span>]:D668 <span class="built_in">dq</span> offset unk_7FFFF7FCF8C9</span><br><span class="line">[<span class="number">110</span>]:D670 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">111</span>]:D678 <span class="built_in">dq</span> offset unk_7FFFF7FC5950</span><br><span class="line">[<span class="number">112</span>]:D680 <span class="built_in">dq</span> offset off_7FFFF7FFDAB0</span><br><span class="line">[<span class="number">113</span>]:D688 <span class="built_in">dq</span> offset off_7FFFFFFFD718</span><br><span class="line">[<span class="number">114</span>]:D690 <span class="built_in">dq</span> offset dword_7FFFFFFFD714</span><br><span class="line">[<span class="number">115</span>]:D698 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">116</span>]:D6A0 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">117</span>]:D6A8 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">118</span>]:D6B0 <span class="built_in">dq</span> offset off_7FFFFFFFD2F0</span><br><span class="line">[<span class="number">119</span>]:D6B8 <span class="built_in">dq</span> <span class="number">3</span></span><br><span class="line">[<span class="number">120</span>]:D6C0 <span class="built_in">dq</span> offset off_7FFFF7FBD6C0</span><br><span class="line">[<span class="number">121</span>]:D6C8 <span class="built_in">dq</span> <span class="number">7FFF00000000h</span></span><br><span class="line">[<span class="number">122</span>]:D6D0 <span class="built_in">dq</span> offset qword_7FFFFFFFD7E8</span><br><span class="line">[<span class="number">123</span>]:D6D8 <span class="built_in">dq</span> offset qword_7FFFFFFFD7F0</span><br><span class="line">[<span class="number">124</span>]:D6E0 <span class="built_in">dq</span> offset dword_7FFFFFFFD714</span><br><span class="line">[<span class="number">125</span>]:D6E8 <span class="built_in">dq</span> <span class="number">7FFF00000038h</span></span><br><span class="line">[<span class="number">126</span>]:D6F0 <span class="built_in">dq</span> <span class="number">7FFF015C0ADCh</span></span><br><span class="line">[<span class="number">127</span>]:D6F8 <span class="built_in">dq</span> offset unk_7FFFF7FC5860</span><br><span class="line">[<span class="number">128</span>]:D700 <span class="built_in">dq</span> <span class="number">5702B738h</span></span><br><span class="line">[<span class="number">129</span>]:D708 <span class="built_in">dq</span> offset aRseqSize                     <span class="comment">; &quot;__rseq_size&quot;</span></span><br><span class="line">[<span class="number">130</span>]:D710 <span class="built_in">dd</span> <span class="number">0F7FBD160h</span></span><br><span class="line">[<span class="number">131</span>]:D714 dword_7FFFFFFFD714 <span class="built_in">dd</span> <span class="number">0</span>                 <span class="comment">; DATA XREF: [stack]:D690↑o</span></span><br><span class="line">[<span class="number">132</span>]:D714                                         <span class="comment">; [stack]:D6E0↑o</span></span><br><span class="line">[<span class="number">133</span>]:D718 off_7FFFFFFFD718 <span class="built_in">dq</span> <span class="number">0</span>                   <span class="comment">; DATA XREF: [stack]:D688↑o</span></span><br><span class="line">[<span class="number">134</span>]:D720 <span class="built_in">dq</span> offset off_7FFFFFFFD7A0+<span class="number">4</span></span><br><span class="line">[<span class="number">135</span>]:D728 <span class="built_in">dq</span> offset off_7FFFF7FBDC60              <span class="comment">; &quot;GLIBC_2.35&quot;</span></span><br><span class="line">[<span class="number">136</span>]:D730 <span class="built_in">dq</span> offset off_7FFFF7FFE680</span><br><span class="line">[<span class="number">137</span>]:D738 <span class="built_in">dq</span> offset aRseqSize                     <span class="comment">; &quot;__rseq_size&quot;</span></span><br><span class="line">[<span class="number">138</span>]:D740 <span class="built_in">dq</span> <span class="number">5702B738h</span></span><br><span class="line">[<span class="number">139</span>]:D748 <span class="built_in">dq</span> offset off_7FFFFFFFD918</span><br><span class="line">[<span class="number">140</span>]:D750 qword_7FFFFFFFD750 <span class="built_in">dq</span> <span class="number">7FFFFFFFD850h</span>     <span class="comment">; DATA XREF: [stack]:D660↑o</span></span><br><span class="line">[<span class="number">141</span>]:D758 <span class="built_in">dq</span> offset unk_7FFFF7FD01FC</span><br><span class="line">[<span class="number">142</span>]:D760 <span class="built_in">dq</span> <span class="number">2</span></span><br><span class="line">[<span class="number">143</span>]:D768 <span class="built_in">dq</span> offset off_7FFFF7FBDC60              <span class="comment">; &quot;GLIBC_2.35&quot;</span></span><br><span class="line">[<span class="number">144</span>]:D770 <span class="built_in">dq</span> offset off_7FFFF7F9FFB8</span><br><span class="line">[<span class="number">145</span>]:D778 <span class="built_in">dq</span> offset unk_7FFFF7F9FD1C</span><br><span class="line">[<span class="number">146</span>]:D780 <span class="built_in">dq</span> offset unk_7FFFF7F9FD1C</span><br><span class="line">[<span class="number">147</span>]:D788 <span class="built_in">dq</span> offset unk_7FFFF7F9FD1C</span><br><span class="line">[<span class="number">148</span>]:D790 <span class="built_in">dq</span> offset unk_7FFFF7F9FD1C</span><br><span class="line">[<span class="number">149</span>]:D798 <span class="built_in">dq</span> offset unk_7FFFF7F9FD1C</span><br><span class="line">[<span class="number">150</span>]:D7A0 off_7FFFFFFFD7A0 <span class="built_in">dq</span> offset unk_7FFFF7F9FD1C</span><br><span class="line">[<span class="number">151</span>]:D7A8 <span class="built_in">dq</span> offset unk_7FFFF7F9FD1C</span><br><span class="line">[<span class="number">152</span>]:D7B0 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">153</span>]:D7B8 <span class="built_in">dq</span> offset off_7FFFF7FFE680</span><br><span class="line">[<span class="number">154</span>]:D7C0 <span class="built_in">dq</span> offset qword_7FFFFFFFD7F0</span><br><span class="line">[<span class="number">155</span>]:D7C8 <span class="built_in">dq</span> <span class="number">7FFF00000000h</span></span><br><span class="line">[<span class="number">156</span>]:D7D0 <span class="built_in">dq</span> offset off_7FFFF7FFDAB0</span><br><span class="line">[<span class="number">157</span>]:D7D8 <span class="built_in">dq</span> offset qword_7FFFFFFFD7E8</span><br><span class="line">[<span class="number">158</span>]:D7E0 <span class="built_in">dq</span> offset qword_7FFFFFFFD8E0</span><br><span class="line">[<span class="number">159</span>]:D7E8 qword_7FFFFFFFD7E8 <span class="built_in">dq</span> <span class="number">0FFFFFFFFh</span>        <span class="comment">; DATA XREF: [stack]:D7D8↑o</span></span><br><span class="line">[<span class="number">160</span>]:D7F0 qword_7FFFFFFFD7F0 <span class="built_in">dq</span> <span class="number">7</span>                 <span class="comment">; DATA XREF: [stack]:D7C0↑o</span></span><br><span class="line">[<span class="number">161</span>]:D7F8 <span class="built_in">dq</span> <span class="number">8</span></span><br><span class="line">[<span class="number">162</span>]:D800 <span class="built_in">dq</span> <span class="number">14h</span></span><br><span class="line">[<span class="number">163</span>]:D808 <span class="built_in">dq</span> <span class="number">1Bh</span></span><br><span class="line">[<span class="number">164</span>]:D810 <span class="built_in">dq</span> <span class="number">24h</span></span><br><span class="line">[<span class="number">165</span>]:D818 <span class="built_in">dq</span> <span class="number">2Ch</span></span><br><span class="line">[<span class="number">166</span>]:D820 <span class="built_in">dq</span> <span class="number">35h</span></span><br><span class="line">[<span class="number">167</span>]:D828 <span class="built_in">dq</span> <span class="number">3Dh</span></span><br><span class="line">[<span class="number">168</span>]:D830 <span class="built_in">dq</span> <span class="number">40h</span></span><br><span class="line">[<span class="number">169</span>]:D838 <span class="built_in">dq</span> <span class="number">48h</span></span><br><span class="line">[<span class="number">170</span>]:D840 <span class="built_in">dq</span> <span class="number">50h</span></span><br><span class="line">[<span class="number">171</span>]:D848 <span class="built_in">dq</span> <span class="number">58h</span></span><br><span class="line">[<span class="number">172</span>]:D850 <span class="built_in">dq</span> <span class="number">60h</span></span><br><span class="line">[<span class="number">173</span>]:D858 <span class="built_in">dq</span> <span class="number">68h</span></span><br><span class="line">[<span class="number">174</span>]:D860 <span class="built_in">dq</span> <span class="number">70h</span></span><br><span class="line">[<span class="number">175</span>]:D868 <span class="built_in">dq</span> <span class="number">78h</span></span><br><span class="line">[<span class="number">176</span>]:D870 <span class="built_in">dq</span> <span class="number">80h</span></span><br><span class="line">[<span class="number">177</span>]:D878 <span class="built_in">dq</span> <span class="number">88h</span></span><br><span class="line">[<span class="number">178</span>]:D880 <span class="built_in">dq</span> <span class="number">95h</span></span><br><span class="line">[<span class="number">179</span>]:D888 <span class="built_in">dq</span> <span class="number">98h</span></span><br><span class="line">[<span class="number">180</span>]:D890 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">181</span>]:D898 <span class="built_in">dq</span> <span class="number">212h</span></span><br><span class="line">[<span class="number">182</span>]:D8A0 <span class="built_in">dq</span> offset unk_7FFFF7EA0000</span><br><span class="line">[<span class="number">183</span>]:D8A8 <span class="built_in">dq</span> offset dynamic_off_table</span><br><span class="line">[<span class="number">184</span>]:D8B0 <span class="built_in">dq</span> offset ELF_header</span><br><span class="line">[<span class="number">185</span>]:D8B8 <span class="built_in">dq</span> <span class="number">1A7EF4h</span></span><br><span class="line">[<span class="number">186</span>]:D8C0 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">187</span>]:D8C8 <span class="built_in">dq</span> offset off_7FFFFFFFD918</span><br><span class="line">[<span class="number">188</span>]:D8D0 <span class="built_in">dq</span> offset unk_7FFFF7FC5D90</span><br><span class="line">[<span class="number">189</span>]:D8D8 <span class="built_in">dq</span> <span class="number">276</span></span><br><span class="line">[<span class="number">190</span>]:D8E0 qword_7FFFFFFFD8E0 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">191</span>]:D8E8 <span class="built_in">dq</span> offset unk_7FFFF7FC5000</span><br><span class="line">[<span class="number">192</span>]:D8F0 <span class="built_in">dq</span> <span class="number">744</span></span><br><span class="line">[<span class="number">193</span>]:D8F8 <span class="built_in">dq</span> <span class="number">744</span></span><br><span class="line">[<span class="number">194</span>]:D900 <span class="built_in">dq</span> offset _off_table</span><br><span class="line">[<span class="number">195</span>]:D908 <span class="built_in">dq</span> <span class="number">1B7F7FD0DC5h</span></span><br><span class="line">[<span class="number">196</span>]:D910 <span class="built_in">dq</span> <span class="number">900000048h</span></span><br><span class="line">[<span class="number">197</span>]:D918 off_7FFFFFFFD918 <span class="built_in">dq</span> offset off_7FFFFFFFD2F0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>The [183] is <strong>dynamic rebased off_table</strong>, [181],[182] are two empty fields. [160] to [179] is a series of incremental data. After the whole loop, [160] to [179] were slightly changed, and[0] to [7] were changed to <strong>0x100</strong>.</p>
<p>For further analysis, there are two write funcitons in the first 256 rounds loop <em>(func_344, func_216, func_2, func_141, func_334, func_99, func_234, func_315, func_17, func_332, func_269, func_215, <strong>func_299</strong>, func_245, func_208, <strong>func_123</strong>)</em>, <code>func_299</code> and <code>func_123</code>. The characteristic of these two functions with write traces is that they all contain <strong>writes to a1[…] bytes or dword pointers</strong>. <code>func_299</code> has a byte write <strong>from [rdx(the first time)] to [rdx(the first time)+0x100]</strong> (0x100 bytes), but <strong>in the whole loop</strong> it only wrote <strong>0x00</strong> for 0x100 times. <code>func_123</code> has a dword write to <strong>[rdx(fixed)]</strong>, and it wrote the loop index here, from 1 to 0x100. After that, the value of this index was synced with a1[0] to a1[7].</p>
<h3 id="II-The-Input-Function"><a href="#II-The-Input-Function" class="headerlink" title="II. The Input Function"></a>II. The Input Function</h3><p>After the loop, func_161 constructed the addr of function <code>read</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">func_161</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v1 = a1[<span class="number">184</span>];</span><br><span class="line">  a1[<span class="number">189</span>] = <span class="number">17446</span>;</span><br><span class="line">  a1[<span class="number">189</span>] += <span class="number">0x52E339D82320383LL</span>;</span><br><span class="line">  v25 = a1[<span class="number">189</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !a1[<span class="number">190</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">189</span>] = v25;</span><br><span class="line">    a1[<span class="number">189</span>] += <span class="number">0x124AC798AFCBD8C7LL</span>;</span><br><span class="line">    v25 = a1[<span class="number">189</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  v24 = (__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD, __int64))(v1 + v25); <span class="comment">// read</span></span><br><span class="line">  __writeeflags(a1[<span class="number">181</span>]);</span><br><span class="line">  v2 = a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">161</span>]];</span><br><span class="line">  v3 = a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">172</span>]];</span><br><span class="line">  v4 = a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">173</span>]];</span><br><span class="line">  v22 = <span class="built_in">v24</span>(a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">165</span>]], a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">164</span>]], a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">163</span>]], a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">162</span>]], a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">168</span>]], v2);</span><br><span class="line">  v5 = __readeflags();</span><br><span class="line">  a1[<span class="number">181</span>] = v5;</span><br><span class="line">  v20 = a1[<span class="number">161</span>];</span><br><span class="line">  v19 = a1[<span class="number">162</span>];</span><br><span class="line">  v18 = a1[<span class="number">163</span>];</span><br><span class="line">  v17 = a1[<span class="number">164</span>];</span><br><span class="line">  v16 = a1[<span class="number">165</span>];</span><br><span class="line">  v15 = a1[<span class="number">168</span>];</span><br><span class="line">  v14 = a1[<span class="number">169</span>];</span><br><span class="line">  v13 = a1[<span class="number">170</span>];</span><br><span class="line">  v12 = a1[<span class="number">171</span>];</span><br><span class="line">  v11 = a1[<span class="number">172</span>];</span><br><span class="line">  v10 = a1[<span class="number">173</span>];</span><br><span class="line">  v9 = a1[<span class="number">174</span>];</span><br><span class="line">  v8 = a1[<span class="number">175</span>];</span><br><span class="line">  v6 = a1[<span class="number">175</span>];</span><br><span class="line">  a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">160</span>]] = v6;</span><br><span class="line">  a1[v20] = v2;</span><br><span class="line">  a1[v19] = v6;</span><br><span class="line">  a1[v18] = a1;</span><br><span class="line">  a1[v17] = v2;</span><br><span class="line">  a1[v16] = v6;</span><br><span class="line">  a1[v15] = a1;</span><br><span class="line">  a1[v14] = v2;</span><br><span class="line">  a1[v13] = v6;</span><br><span class="line">  a1[v12] = a1;</span><br><span class="line">  a1[v11] = v3;</span><br><span class="line">  a1[v10] = v4;</span><br><span class="line">  a1[v9] = v3;</span><br><span class="line">  a1[v8] = a1;</span><br><span class="line">  a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">160</span>]] = v22;</span><br><span class="line">  a1[<span class="number">189</span>] = <span class="number">0xF4B95DADE84EC149LL</span>;</span><br><span class="line">  a1[<span class="number">189</span>] ^= <span class="number">0xEAB7B9641410BE6DLL</span>;</span><br><span class="line">  v26 = a1[<span class="number">189</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !a1[<span class="number">190</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">189</span>] = v26;</span><br><span class="line">    a1[<span class="number">189</span>] -= <span class="number">0x1E0EE4C9FC5E7CC0LL</span>;</span><br><span class="line">    v26 = a1[<span class="number">189</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (*(__int64 (__fastcall **)(_QWORD *))(<span class="number">8</span> * v26 + a1[<span class="number">183</span>]))(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>After the call, the input was saved to the address where <strong>a1[150] ~ a1[157]</strong> pointed to — <strong>exactly the 256 byte buffer</strong> which was filled with zero just now. At the same time, the <code>__debugbreak();</code> (0xCC) in check function started to take effect from this time, and the debug speed of ida became very slow. Choose silent <code>SIGTRAP</code> can restore to original speed.</p>
<h3 id="III-The-Second-256-Round-Loop"><a href="#III-The-Second-256-Round-Loop" class="headerlink" title="III. The Second 256 Round Loop"></a>III. The Second 256 Round Loop</h3><p>Then the second 256 round loop is almost the same as loop1, with the byte write function <code>func_138</code> and the dword write function <code>func_303</code>, and this time the bytes are <strong>still 0x00</strong>. Therefore, we can suspect the existence of <strong>anti debugging</strong> mechanisms in the program. Using the intel pin script:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pin.H&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cinttypes&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Meta</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* loop;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* width;</span><br><span class="line">    BOOL isDword;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">HookId</span> : UINT32 &#123;</span><br><span class="line">    H_LOOP1_BYTE  = <span class="number">1</span>,</span><br><span class="line">    H_LOOP1_DWORD = <span class="number">2</span>,</span><br><span class="line">    H_LOOP2_BYTE  = <span class="number">3</span>,</span><br><span class="line">    H_LOOP2_DWORD = <span class="number">4</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> Meta kMeta[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, FALSE&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;loop1&quot;</span>, <span class="string">&quot;byte&quot;</span>,  FALSE&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;loop1&quot;</span>, <span class="string">&quot;dword&quot;</span>, TRUE&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;loop2&quot;</span>, <span class="string">&quot;byte&quot;</span>,  FALSE&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;loop2&quot;</span>, <span class="string">&quot;dword&quot;</span>, TRUE&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> ADDRINT OFF_LOOP1_BYTE  = <span class="number">0x1550DC</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> ADDRINT OFF_LOOP1_DWORD = <span class="number">0x097442</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> ADDRINT OFF_LOOP2_BYTE  = <span class="number">0x0A49F4</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> ADDRINT OFF_LOOP2_DWORD = <span class="number">0x159506</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">KNOB&lt;std::string&gt; <span class="title">KnobOut</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;writes.log&quot;</span>, <span class="string">&quot;output log file&quot;</span>)</span></span>;</span><br><span class="line"><span class="function">KNOB&lt;ADDRINT&gt; <span class="title">KnobBase</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;base&quot;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;override image base (0 = auto main image low address)&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> FILE* gLog = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">static</span> PIN_LOCK gLock;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> std::unordered_map&lt;ADDRINT, HookId&gt; gTargets; <span class="comment">// runtime addr -&gt; id</span></span><br><span class="line"><span class="type">static</span> ADDRINT gBase = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> VOID <span class="title">LogLine</span><span class="params">(HookId id, ADDRINT rdx, ADDRINT rax)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> Meta&amp; m = kMeta[id];</span><br><span class="line">    <span class="keyword">if</span> (!gLog) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    UINT64 addr = (UINT64)rdx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!m.isDword) &#123;</span><br><span class="line">        UINT8 al = (UINT8)(rax &amp; <span class="number">0xFF</span>);</span><br><span class="line">        <span class="built_in">PIN_GetLock</span>(&amp;gLock, <span class="number">0</span>);</span><br><span class="line">        std::<span class="built_in">fprintf</span>(gLog, <span class="string">&quot;%s\\t%s\\t0x%016&quot;</span> PRIx64 <span class="string">&quot;\\t0x%02x\\n&quot;</span>, m.loop, m.width, addr, (<span class="type">unsigned</span>)al);</span><br><span class="line">        <span class="built_in">PIN_ReleaseLock</span>(&amp;gLock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        UINT32 eax = (UINT32)(rax &amp; <span class="number">0xFFFFFFFFu</span>);</span><br><span class="line">        <span class="built_in">PIN_GetLock</span>(&amp;gLock, <span class="number">0</span>);</span><br><span class="line">        std::<span class="built_in">fprintf</span>(gLog, <span class="string">&quot;%s\\t%s\\t0x%016&quot;</span> PRIx64 <span class="string">&quot;\\t0x%08x\\n&quot;</span>, m.loop, m.width, addr, eax);</span><br><span class="line">        <span class="built_in">PIN_ReleaseLock</span>(&amp;gLock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">OnIns</span><span class="params">(INS ins, VOID* <span class="comment">/*v*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> ADDRINT ip = <span class="built_in">INS_Address</span>(ins);</span><br><span class="line">    <span class="keyword">auto</span> it = gTargets.<span class="built_in">find</span>(ip);</span><br><span class="line">    <span class="keyword">if</span> (it == gTargets.<span class="built_in">end</span>()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">const</span> HookId id = it-&gt;second;</span><br><span class="line">    <span class="built_in">INS_InsertCall</span>(</span><br><span class="line">        ins, IPOINT_BEFORE, (AFUNPTR)LogLine,</span><br><span class="line">        IARG_UINT32, (UINT32)id,</span><br><span class="line">        IARG_REG_VALUE, REG_RDX,</span><br><span class="line">        IARG_REG_VALUE, REG_RAX,</span><br><span class="line">        IARG_END</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">OnImg</span><span class="params">(IMG img, VOID* <span class="comment">/*v*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">IMG_IsMainExecutable</span>(img)) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (KnobBase.<span class="built_in">Value</span>() != <span class="number">0</span>) gBase = KnobBase.<span class="built_in">Value</span>();</span><br><span class="line">    <span class="keyword">else</span> gBase = <span class="built_in">IMG_LowAddress</span>(img);</span><br><span class="line">    </span><br><span class="line">    gTargets[gBase + OFF_LOOP1_BYTE]  = H_LOOP1_BYTE;</span><br><span class="line">    gTargets[gBase + OFF_LOOP1_DWORD] = H_LOOP1_DWORD;</span><br><span class="line">    gTargets[gBase + OFF_LOOP2_BYTE]  = H_LOOP2_BYTE;</span><br><span class="line">    gTargets[gBase + OFF_LOOP2_DWORD] = H_LOOP2_DWORD;</span><br><span class="line">    </span><br><span class="line">    std::<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;[hook] main base = 0x%lx\\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)gBase);</span><br><span class="line">    std::<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;[hook] loop1 byte  @ 0x%lx\\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)(gBase + OFF_LOOP1_BYTE));</span><br><span class="line">    std::<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;[hook] loop1 dword @ 0x%lx\\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)(gBase + OFF_LOOP1_DWORD));</span><br><span class="line">    std::<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;[hook] loop2 byte  @ 0x%lx\\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)(gBase + OFF_LOOP2_BYTE));</span><br><span class="line">    std::<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;[hook] loop2 dword @ 0x%lx\\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)(gBase + OFF_LOOP2_DWORD));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">OnFini</span><span class="params">(INT32 <span class="comment">/*code*/</span>, VOID* <span class="comment">/*v*/</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (gLog) std::<span class="built_in">fclose</span>(gLog);</span><br><span class="line">    gLog = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PIN_Init</span>(argc, argv)) &#123;</span><br><span class="line">        std::<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Usage: pin -t &lt;tool&gt; [-o writes.log] [-base 0x...] -- &lt;app&gt;\\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">PIN_InitLock</span>(&amp;gLock);</span><br><span class="line">    gLog = std::<span class="built_in">fopen</span>(KnobOut.<span class="built_in">Value</span>().<span class="built_in">c_str</span>(), <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!gLog) &#123;</span><br><span class="line">        std::<span class="built_in">perror</span>(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::<span class="built_in">setvbuf</span>(gLog, <span class="literal">nullptr</span>, _IOFBF, <span class="number">1</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line">    <span class="built_in">IMG_AddInstrumentFunction</span>(OnImg, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">INS_AddInstrumentFunction</span>(OnIns, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddFiniFunction</span>(OnFini, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_StartProgram</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, the output is the same as what we watched from ida: <strong>all 256 * 2 bytes are 0x00</strong>. And the second loop’s 256 bytes are after the first loop, not covering it. Seems no obvious anti debug.</p>
<p>The input string has its first xref at a lib function <code>_strchrnul_avx2</code>, called by <code>func_223</code>, a function before the 2nd loop:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">func_223</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v1 = a1[<span class="number">184</span>];</span><br><span class="line">  a1[<span class="number">189</span>] = <span class="number">48694</span>;</span><br><span class="line">  a1[<span class="number">189</span>] ^= <span class="number">0xDCB41D5F773EDA0ALL</span>;</span><br><span class="line">  v25 = a1[<span class="number">189</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !a1[<span class="number">190</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">189</span>] = v25;</span><br><span class="line">    a1[<span class="number">189</span>] -= <span class="number">0x285C3D01FCD943FCLL</span>;</span><br><span class="line">    v25 = a1[<span class="number">189</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  v24 = (__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD, __int64))(v1 + v25);</span><br><span class="line">  __writeeflags(a1[<span class="number">181</span>]);</span><br><span class="line">  v2 = a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">161</span>]];</span><br><span class="line">  v3 = a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">172</span>]];</span><br><span class="line">  v4 = a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">173</span>]];</span><br><span class="line">  v22 = <span class="built_in">v24</span>(a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">165</span>]], a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">164</span>]], a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">163</span>]], a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">162</span>]], a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">168</span>]], v2);</span><br><span class="line">  v5 = __readeflags();</span><br><span class="line">  a1[<span class="number">181</span>] = v5;</span><br><span class="line">  v20 = a1[<span class="number">161</span>];</span><br><span class="line">  v19 = a1[<span class="number">162</span>];</span><br><span class="line">  v18 = a1[<span class="number">163</span>];</span><br><span class="line">  v17 = a1[<span class="number">164</span>];</span><br><span class="line">  v16 = a1[<span class="number">165</span>];</span><br><span class="line">  v15 = a1[<span class="number">168</span>];</span><br><span class="line">  v14 = a1[<span class="number">169</span>];</span><br><span class="line">  v13 = a1[<span class="number">170</span>];</span><br><span class="line">  v12 = a1[<span class="number">171</span>];</span><br><span class="line">  v11 = a1[<span class="number">172</span>];</span><br><span class="line">  v10 = a1[<span class="number">173</span>];</span><br><span class="line">  v9 = a1[<span class="number">174</span>];</span><br><span class="line">  v8 = a1[<span class="number">175</span>];</span><br><span class="line">  v6 = a1[<span class="number">175</span>];</span><br><span class="line">  a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">160</span>]] = v6;</span><br><span class="line">  a1[v20] = v2;</span><br><span class="line">  a1[v19] = v6;</span><br><span class="line">  a1[v18] = a1;</span><br><span class="line">  a1[v17] = v2;</span><br><span class="line">  a1[v16] = v6;</span><br><span class="line">  a1[v15] = a1;</span><br><span class="line">  a1[v14] = v2;</span><br><span class="line">  a1[v13] = v6;</span><br><span class="line">  a1[v12] = a1;</span><br><span class="line">  a1[v11] = v3;</span><br><span class="line">  a1[v10] = v4;</span><br><span class="line">  a1[v9] = v3;</span><br><span class="line">  a1[v8] = a1;</span><br><span class="line">  a1[(<span class="type">unsigned</span> <span class="type">int</span>)a1[<span class="number">160</span>]] = v22;</span><br><span class="line">  a1[<span class="number">189</span>] = <span class="number">0x6C452573CB136AA1LL</span>;</span><br><span class="line">  a1[<span class="number">189</span>] -= <span class="number">0x1F15378B922FA66LL</span>;</span><br><span class="line">  v26 = a1[<span class="number">189</span>];</span><br><span class="line">  <span class="keyword">if</span> ( !a1[<span class="number">190</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">189</span>] = v26;</span><br><span class="line">    a1[<span class="number">189</span>] ^= <span class="number">0x6A53D1FB11F071C8uLL</span>;</span><br><span class="line">    v26 = a1[<span class="number">189</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (*(__int64 (__fastcall **)(_QWORD *))(<span class="number">8</span> * v26 + a1[<span class="number">183</span>]))(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And the <code>\\x0A</code> in input was removed before the loop2.</p>
<h3 id="IV-Functions-Between-Loop2-and-4-Round-Loop"><a href="#IV-Functions-Between-Loop2-and-4-Round-Loop" class="headerlink" title="IV. Functions Between Loop2 and 4 Round Loop"></a>IV. Functions Between Loop2 and 4 Round Loop</h3><p>The two loops has the same term:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">--- begin loop ---</span><br><span class="line">A B C D E F G .... N-4 N-3 N-2 N-1 N</span><br><span class="line">--- end loop ---</span><br><span class="line">A B C D E K (NOT F) ...</span><br></pre></td></tr></table></figure>

<p>The first funcs of the loop are used to <strong>check whether to jump out of the loop</strong> (especially func E, you can see <strong>if-else pattern</strong> in it), while the last funcs are used to <strong>calc and write the loop index</strong> (the ‘i’ in for i in range).</p>
<p>The function <code>func_276</code> is the first write func after the second loop and before the third 4 round loop. It writes a <strong>qword</strong> to [rdx], from debug we can see it wrote the ptr of input to the check struct, and the second function is <code>func_49</code>, it’s also a qword write func, which writes the addr of the second 256 bytes buffer under the previous <code>func_276</code>. The third function is <code>func_3</code>. Unlike the previous two, it writes a magic number <strong>0xDEADBEEFDEADBEEF</strong> to a further location below, while the fourth function <code>func_273</code> is almost the same as <code>func_3</code>, it writes magic number <strong>0xADDEDBADADDEDBAD</strong> under <code>func_3</code>. The fifth and sixth, <code>func_241</code> and <code>func_101</code>, are just like 3rd and 4th, writes <strong>0xFEEDFACEFEEDFACE</strong> and <strong>0xC0DEBABEC0DEBABE.</strong></p>
<p>The first part of input string is xrefed in <code>func_105</code>, with a qword put in. Then it is written to the struct under the buffer in <code>func_95</code>, and the second part of input string is written to the struct in <code>func_193</code>. <code>func_126</code> and <code>func_89</code> write two <strong>0x0000000000000000</strong> under the input.</p>
<p>The last write function is <code>func_122</code>, which wrote 0 to struct+4, maybe the loop index of the afterwards loop.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0</span>]:00007FFFF7F9FD20 check_struct <span class="built_in">dd</span> <span class="number">100h</span></span><br><span class="line">[<span class="number">0.5</span>]:00007FFFF7F9FD24 <span class="built_in">dd</span> <span class="number">0</span>                                  <span class="comment">; loop index?</span></span><br><span class="line">[<span class="number">1</span>]:00007FFFF7F9FD28 <span class="built_in">dd</span> <span class="number">0</span></span><br><span class="line">[<span class="number">1.5</span>]:00007FFFF7F9FD2C <span class="built_in">dd</span> <span class="number">0</span>                                  <span class="comment">; modified in loop3</span></span><br><span class="line">[<span class="number">2</span>]:00007FFFF7F9FD30 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">3</span>]:00007FFFF7F9FD38 <span class="built_in">dq</span> offset input</span><br><span class="line">[<span class="number">4</span>]:00007FFFF7F9FD40 off_7FFFF7F9FD40 <span class="built_in">dq</span> offset input        <span class="comment">; input</span></span><br><span class="line">[<span class="number">5</span>]:00007FFFF7F9FD48 <span class="built_in">dq</span> offset byte_7FFFF7F9FEA8             <span class="comment">; buffer</span></span><br><span class="line">[<span class="number">6</span>]:00007FFFF7F9FD50 <span class="built_in">dq</span> XXXXXXXXXXXXXXXXh                    <span class="comment">; input1</span></span><br><span class="line">[<span class="number">7</span>]:00007FFFF7F9FD58 <span class="built_in">dq</span> XXXXXXXXXXXXXXXXh                    <span class="comment">; input2</span></span><br><span class="line">[<span class="number">8</span>]:00007FFFF7F9FD60 <span class="built_in">dq</span> <span class="number">0</span>                                    <span class="comment">; temp1</span></span><br><span class="line">[<span class="number">9</span>]:00007FFFF7F9FD68 <span class="built_in">dq</span> <span class="number">0</span>                                    <span class="comment">; temp2</span></span><br><span class="line">[<span class="number">10</span>]:00007FFFF7F9FD70 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">11</span>]:00007FFFF7F9FD78 <span class="built_in">dq</span> <span class="number">0DEADBEEFDEADBEEFh</span>                   <span class="comment">; the magic number 1</span></span><br><span class="line">[<span class="number">12</span>]:00007FFFF7F9FD80 <span class="built_in">dq</span> <span class="number">0ADDEDBADADDEDBADh</span>                   <span class="comment">; the magic number 2</span></span><br><span class="line">[<span class="number">13</span>]:00007FFFF7F9FD88 <span class="built_in">dq</span> <span class="number">0FEEDFACEFEEDFACEh</span>                   <span class="comment">; the magic number 3</span></span><br><span class="line">[<span class="number">14</span>]:00007FFFF7F9FD90 <span class="built_in">dq</span> <span class="number">0C0DEBABEC0DEBABEh</span>                   <span class="comment">; the magic number 4</span></span><br><span class="line">[<span class="number">15</span>]:00007FFFF7F9FD98 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">16</span>]:00007FFFF7F9FDA0 <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line">[<span class="number">17</span>]:00007FFFF7F9FDA8 inp                                     <span class="comment">; the input, the loop1 256 bytes</span></span><br><span class="line">[<span class="number">18</span>]:00007FFFF7F9FEA8 buf                                     <span class="comment">; the buffer, the loop2 256 bytes</span></span><br></pre></td></tr></table></figure>

<p>Therefore, for these functions:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--- end loop2 ---</span><br><span class="line">func_290 func_24 func_329 func_90 func_316</span><br><span class="line">func_311 func_7 func_264 func_44 func_242 func_276 <span class="comment">// the preparation and the first write: input string</span></span><br><span class="line">func_82 func_125 func_253 func_96 func_338 func_49 <span class="comment">// the second write: the buffer</span></span><br><span class="line">func_114 func_54 func_159 func_3    <span class="comment">// magic number 1</span></span><br><span class="line">func_297 func_119 func_61 func_273  <span class="comment">// magic number 2</span></span><br><span class="line">func_154 func_142 func_226 func_241 <span class="comment">// magic number 3</span></span><br><span class="line">func_117 func_83 func_67 func_101   <span class="comment">// magic number 4</span></span><br><span class="line">func_52 func_219 func_192 func_105  <span class="comment">// xref1</span></span><br><span class="line">func_352 func_26 func_95            <span class="comment">// input1</span></span><br><span class="line">func_252 func_118 func_280 func_6 func_365 func_108 func_10 func_324 func_193 <span class="comment">// input2</span></span><br><span class="line">func_260 func_94 func_126           <span class="comment">// temp1</span></span><br><span class="line">func_224 func_11 func_89            <span class="comment">// temp2</span></span><br><span class="line">func_86 func_47 func_122            <span class="comment">// loop index?</span></span><br><span class="line">func_131                            <span class="comment">// end, prepare to get into the loop</span></span><br><span class="line">--- begin loop <span class="number">4</span> rounds ---</span><br></pre></td></tr></table></figure>

<p>Next, set hardware breakpoint at input1,2, temp1,2 and four magic numbers, so that we can start analyzing encryption algorithms.</p>
<h3 id="V-The-Encrypt"><a href="#V-The-Encrypt" class="headerlink" title="V. The Encrypt"></a>V. The Encrypt</h3><p>For loop3 we can see that <code>func_207</code> is the if-else break function, and this loop do someting:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">--- begin loop <span class="number">4</span> rounds ---</span><br><span class="line">func_37 func_39 func_283 func_207 <span class="comment">// cmp and decide whether break out of the loop</span></span><br><span class="line">func_181 func_145 func_165 func_0 func_361 func_63 func_185 func_68 <span class="comment">// dword write 0x30,0x20,0x10,0x0 at check struct[1.5]</span></span><br><span class="line">func_27 func_133 func_265 func_48 func_78 func_335 func_25 func_199 <span class="comment">// xrefed magic number1,2,3,4</span></span><br><span class="line">func_285 func_301 func_137 <span class="comment">// xrefed 0x30,0x20,0x10,0x0</span></span><br><span class="line">func_205 func_317 <span class="comment">// 0xDEADBEEFDEADBEEF &gt;&gt; 0x30 = 0xDEAD, 0xADDEDBADADDEDBAD &gt;&gt; 0x20 = 0xADDEDBAD, ...</span></span><br><span class="line">func_180 func_152 func_359 <span class="comment">// xrefed 0x30,0x20,0x10,0x0</span></span><br><span class="line">func_314 func_312 <span class="comment">// 0xDEAD &lt;&lt; 0x30 = 0xDEAD000000000000, 0xADDEDBAD &lt;&lt; 0x20 = 0xADDEDBAD00000000, ...</span></span><br><span class="line">func_103 func_32 func_358 func_135 <span class="comment">// qword xor temp1 and write to temp1: 0xDEAD000000000000, 0xDEAD000000000000, ...</span></span><br><span class="line">func_333 func_267 func_80 <span class="comment">// dword inc check struct[1]</span></span><br><span class="line">--- end loop ---</span><br><span class="line">func_37 func_39 func_283 func_207</span><br><span class="line">func_232 func_247</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>This loop constructs a const number <strong>0x4d409bdd3e33babe</strong> at temp1, the co-construct in python:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">0x4D409BDD3E33BABE</span></span><br><span class="line"></span><br><span class="line">k = [<span class="number">0xDEADBEEFDEADBEEF</span>, <span class="number">0xADDEDBADADDEDBAD</span>, <span class="number">0xFEEDFACEFEEDFACE</span>, <span class="number">0xC0DEBABEC0DEBABE</span>]</span><br><span class="line">t = [((k[i] &gt;&gt; (<span class="number">0x30</span> - <span class="number">0x10</span> * i)) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span>) &lt;&lt; (<span class="number">0x30</span> - <span class="number">0x10</span> * i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">4</span>): t[i] ^= t[i-<span class="number">1</span>]</span><br><span class="line">o = t[-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">assert</span> o == a</span><br></pre></td></tr></table></figure>

<p>After the loop3:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func_37 func_39 func_283 func_207 <span class="comment">// end loop</span></span><br><span class="line">func_232 func_247 func_109 <span class="comment">// xrefed the const</span></span><br><span class="line">func_258 <span class="comment">// const &lt;&lt; 4 = 0xD409BDD3E33BABE0</span></span><br><span class="line">func_319 func_337 func_167 <span class="comment">// qword write 0xD409BDD3E33BABE0 at temp2</span></span><br><span class="line">func_235 func_331 func_158 <span class="comment">// dword write 0x0 at check struct[0.5]</span></span><br><span class="line">func_336 <span class="comment">// prepare for the loop4</span></span><br><span class="line">--- begin loop <span class="number">16</span> rounds ---</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>For loop4, it is a very obvious <strong>64-bit XTEA</strong>, using <strong>temp2 as delta</strong> and <strong>magic numbers as key</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">--- begin loop <span class="number">16</span> rounds ---</span><br><span class="line">func_139, func_160, func_136, func_231 <span class="comment">// decide break</span></span><br><span class="line">func_57, func_236, func_217 <span class="comment">// xrefed input1</span></span><br><span class="line">func_281 <span class="comment">// input1 &lt;&lt; 8</span></span><br><span class="line">func_15, func_220, func_330, func_92 <span class="comment">// xrefed input1</span></span><br><span class="line">func_104 <span class="comment">// input1 &gt;&gt; 10</span></span><br><span class="line">func_21 <span class="comment">// (input1 &lt;&lt; 8) ^ (input1 &gt;&gt; 10)</span></span><br><span class="line">func_62, func_164, func_85 <span class="comment">// xrefed input1</span></span><br><span class="line">func_308, func_321 <span class="comment">// input1 + ((input1 &lt;&lt; 8) ^ (input1 &gt;&gt; 10))</span></span><br><span class="line">func_162, func_202, func_144, func_328 <span class="comment">// xrefed temp2</span></span><br><span class="line">func_341 <span class="comment">// temp2 &gt;&gt; 11</span></span><br><span class="line">func_22 <span class="comment">// (temp2 &gt;&gt; 11) &amp; 3</span></span><br><span class="line">func_355, func_5 <span class="comment">// ((temp2 &gt;&gt; 11) &amp; 3) * 8</span></span><br><span class="line">func_268, func_178, func_251 <span class="comment">// key[(temp2 &gt;&gt; 11) &amp; 3]</span></span><br><span class="line">func_23, func_134, func_88 <span class="comment">// xrefed temp2</span></span><br><span class="line">func_266 <span class="comment">// temp2 + key[(temp2 &gt;&gt; 11) &amp; 3]</span></span><br><span class="line">func_284 <span class="comment">// (input1 + ((input1 &lt;&lt; 8) ^ (input1 &gt;&gt; 10))) ^ (temp2 + key[(temp2 &gt;&gt; 11) &amp; 3])</span></span><br><span class="line">func_107, func_115, func_20 <span class="comment">// input2 - ((input1 + ((input1 &lt;&lt; 8) ^ (input1 &gt;&gt; 10))) ^ (temp2 + key[(temp2 &gt;&gt; 11) &amp; 3])) then write to input2</span></span><br><span class="line">func_58, func_279, func_120 <span class="comment">// xrefed temp1</span></span><br><span class="line">func_31, func_50, func_294 <span class="comment">// temp2 - temp1 then write to temp2</span></span><br><span class="line">func_233, func_40, func_354 <span class="comment">// xrefed input2</span></span><br><span class="line">func_356 <span class="comment">// input2 &lt;&lt; 8</span></span><br><span class="line">func_182, func_213, func_1, func_188 <span class="comment">// xrefed input2</span></span><br><span class="line">func_310 <span class="comment">// input2 &gt;&gt; 10</span></span><br><span class="line">func_195 <span class="comment">// (input2 &lt;&lt; 8) ^ (input2 &gt;&gt; 10)</span></span><br><span class="line">func_340, func_127, func_8 <span class="comment">// xrefed input2</span></span><br><span class="line">func_112, func_327 <span class="comment">// input2 + ((input2 &lt;&lt; 8) ^ (input2 &gt;&gt; 10))</span></span><br><span class="line">func_187, func_272, func_113, func_212 <span class="comment">// xrefed temp2</span></span><br><span class="line">func_81 <span class="comment">// temp2 &amp; 3</span></span><br><span class="line">func_191, func_198 <span class="comment">// (temp2 &amp; 3) * 8</span></span><br><span class="line">func_326, func_322, func_289 <span class="comment">// key[temp2 &amp; 3]</span></span><br><span class="line">func_304, func_370, func_246 <span class="comment">// xrefed temp2</span></span><br><span class="line">func_347 <span class="comment">// temp2 + key[temp2 &amp; 3]</span></span><br><span class="line">func_102 <span class="comment">// (input2 + ((input2 &lt;&lt; 8) ^ (input2 &gt;&gt; 10))) ^ (temp2 + key[temp2 &amp; 3])</span></span><br><span class="line">func_302, func_147, func_36 <span class="comment">// input1 - ((input2 + ((input2 &lt;&lt; 8) ^ (input2 &gt;&gt; 10))) ^ (temp2 + key[temp2 &amp; 3])) then write to input1</span></span><br><span class="line">func_257, func_106, func_194 <span class="comment">// calc for the loop index</span></span><br><span class="line">--- end loop ---</span><br><span class="line">func_139, func_160, func_136, func_231</span><br><span class="line">func_225</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>The whole co-construction in python:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">n2ble</span>(<span class="params">na, n</span>):</span><br><span class="line">    b = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> na: b.extend(a.to_bytes(n, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b2nle</span>(<span class="params">b, n</span>): <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(b[i:i+n], byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">False</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(b), n)]</span><br><span class="line"></span><br><span class="line">binp = <span class="built_in">bytearray</span>(<span class="string">b&quot;1234567890123456&quot;</span>)</span><br><span class="line">inp = b2nle(binp, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">key = [<span class="number">0xDEADBEEFDEADBEEF</span>, <span class="number">0xADDEDBADADDEDBAD</span>, <span class="number">0xFEEDFACEFEEDFACE</span>, <span class="number">0xC0DEBABEC0DEBABE</span>]</span><br><span class="line">temp = [((key[i] &gt;&gt; (<span class="number">0x30</span> - <span class="number">0x10</span> * i)) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span>) &lt;&lt; (<span class="number">0x30</span> - <span class="number">0x10</span> * i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">4</span>): temp[i] ^= temp[i-<span class="number">1</span>]</span><br><span class="line">delta = temp[-<span class="number">1</span>]</span><br><span class="line">ttl = (delta &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    inp[<span class="number">1</span>] = (inp[<span class="number">1</span>] - ((inp[<span class="number">0</span>] + ((inp[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) ^ (inp[<span class="number">0</span>] &gt;&gt; <span class="number">10</span>))) ^ (ttl + key[(ttl &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>]))) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">    ttl = (ttl - delta) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">    inp[<span class="number">0</span>] = (inp[<span class="number">0</span>] - ((inp[<span class="number">1</span>] + ((inp[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) ^ (inp[<span class="number">1</span>] &gt;&gt; <span class="number">10</span>))) ^ (ttl + key[ttl &amp; <span class="number">3</span>]))) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(inp[<span class="number">0</span>]), <span class="built_in">hex</span>(inp[<span class="number">1</span>]), <span class="built_in">hex</span>(ttl))</span><br></pre></td></tr></table></figure>

<h3 id="VI-The-Verification"><a href="#VI-The-Verification" class="headerlink" title="VI. The Verification"></a>VI. The Verification</h3><p>And last, all we need is the cipher. Set hardware breakpoint at output buffer.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func_139, func_160, func_136, func_231 <span class="comment">// break</span></span><br><span class="line">func_225, func_210, func_271 <span class="comment">// xrefed buf</span></span><br><span class="line">func_84, func_70, func_306 <span class="comment">// xrefed input1</span></span><br><span class="line">func_243 <span class="comment">// write input1 to buf[0]</span></span><br><span class="line">func_343, func_348, func_282 <span class="comment">// xrefed buf</span></span><br><span class="line">func_13, func_184 <span class="comment">// buf + 8</span></span><br><span class="line">func_357, func_313, func_296, func_169 <span class="comment">// xrefed input2</span></span><br><span class="line">func_173 <span class="comment">// write input2 to buf[1]</span></span><br><span class="line">func_369, func_151, func_362, func_230 <span class="comment">// write 0x1 to check struct[10]</span></span><br><span class="line">func_274, func_110, func_157, func_349, func_278 <span class="comment">// write 0xB902E3961384ADFC to check struct[15]</span></span><br><span class="line">func_346, func_51, func_69 <span class="comment">// write 0x8ED17998A64FE48C to check struct[16]</span></span><br><span class="line">func_98, func_270, func_293, func_292, func_200, func_168, func_255, func_275, func_166, func_295, func_250, func_14, func_71, func_291, func_211, func_363, func_323, func_59, func_155, func_87, func_351, func_287, func_156, func_66, func_41, func_163, func_367, func_45, func_239, func_229, func_201, func_30, func_100, func_300, func_42, func_97, func_43, func_124, func_277, func_222, func_76, func_149, func_19, func_196, func_74, func_256, func_111, func_53, func_353, func_244, func_143, func_298, func_35</span><br></pre></td></tr></table></figure>

<p>In fact, after <code>func_69</code>, the cipher is totally loaded. The afterwards functions are no need to analyze.</p>
<p>Write decrypt script:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">n2ble</span>(<span class="params">na, n</span>):</span><br><span class="line">    b = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> na: b.extend(a.to_bytes(n, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b2nle</span>(<span class="params">b, n</span>): <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(b[i:i+n], byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">False</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(b), n)]</span><br><span class="line"></span><br><span class="line">binp = <span class="built_in">bytearray</span>(<span class="string">b&quot;1234567890123456&quot;</span>)</span><br><span class="line">inp = b2nle(binp, <span class="number">8</span>)</span><br><span class="line">out = []</span><br><span class="line"></span><br><span class="line">key = [<span class="number">0xDEADBEEFDEADBEEF</span>, <span class="number">0xADDEDBADADDEDBAD</span>, <span class="number">0xFEEDFACEFEEDFACE</span>, <span class="number">0xC0DEBABEC0DEBABE</span>]</span><br><span class="line">temp = [((key[i] &gt;&gt; (<span class="number">0x30</span> - <span class="number">0x10</span> * i)) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span>) &lt;&lt; (<span class="number">0x30</span> - <span class="number">0x10</span> * i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">4</span>): temp[i] ^= temp[i-<span class="number">1</span>]</span><br><span class="line">delta = temp[-<span class="number">1</span>]</span><br><span class="line">ttl = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">cip = [<span class="number">0xB902E3961384ADFC</span>, <span class="number">0x8ED17998A64FE48C</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    cip[<span class="number">0</span>] = (cip[<span class="number">0</span>] + ((cip[<span class="number">1</span>] + ((cip[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) ^ (cip[<span class="number">1</span>] &gt;&gt; <span class="number">10</span>))) ^ (ttl + key[ttl &amp; <span class="number">3</span>]))) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">    ttl = (ttl + delta) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">    cip[<span class="number">1</span>] = (cip[<span class="number">1</span>] + ((cip[<span class="number">0</span>] + ((cip[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) ^ (cip[<span class="number">0</span>] &gt;&gt; <span class="number">10</span>))) ^ (ttl + key[(ttl &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>]))) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(n2ble(cip, <span class="number">8</span>))</span><br></pre></td></tr></table></figure>

<p>Output: b’NoM0reBytec0des\x00’.</p>
<p>Flag: <font color=deepskyblue><strong>DH{NoM0reBytec0des}</strong></font></p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2026/01/08/visualize_indirect_jump/"
      title="关于间接跳转的一种分析方法"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        关于间接跳转的一种分析方法
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2026/01/01/2026_xnhc/"
      title="2026年新年贺词"
     >

    <p class="title-text">
      
        2026年新年贺词
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2026 Astral Prisma<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
