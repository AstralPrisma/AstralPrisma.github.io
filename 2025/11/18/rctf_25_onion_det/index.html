<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>RCTF 2025 Reverse-Onion &amp; Determinism WriteUp | 棱晶の小窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="Onion读取50个64位整数作为密钥，存储到0x5555555C3D00 vm字节码加载到0x5555555B5D00 参数结构： 12345678910unsigned __int8 *opcodes;_QWORD reg[8];_WORD MEM[256];unsigned __int16 PC;unsigned __int16 HIPC;unsigned __int16 LOTAG;uns">
<meta property="og:type" content="article">
<meta property="og:title" content="RCTF 2025 Reverse-Onion &amp; Determinism WriteUp">
<meta property="og:url" content="https://astralprisma.github.io/2025/11/18/rctf_25_onion_det/index.html">
<meta property="og:site_name" content="棱晶の小窝">
<meta property="og:description" content="Onion读取50个64位整数作为密钥，存储到0x5555555C3D00 vm字节码加载到0x5555555B5D00 参数结构： 12345678910unsigned __int8 *opcodes;_QWORD reg[8];_WORD MEM[256];unsigned __int16 PC;unsigned __int16 HIPC;unsigned __int16 LOTAG;uns">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-11-18T02:00:00.000Z">
<meta property="article:modified_time" content="2025-11-18T03:32:12.927Z">
<meta property="article:author" content="Astral Prisma">
<meta property="article:tag" content="VM">
<meta property="article:tag" content="AutoRe">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/XH.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/OTSA.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>棱晶の小窝 </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/AP.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Astral Prisma </div>
      <div class="dot"></div>
      <div class="subtitle">星界棱晶 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/454936579" title="Bilibili"><image src=https://www.bilibili.com/favicon.ico></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://www.primegrid.com/show_user.php?userid=1243718" title="PrimeGrid"><image src=https://www.primegrid.com/images/favicon_32.png></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/AstralPrisma" title="GitHub"><image src=https://github.githubassets.com/favicons/favicon.png></image></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/Ideas/">
                Ideas
                <div class="category-count">2</div>
            </a>
        
            <a class="category-link" href="/categories/WriteUp/">
                WriteUp
                <div class="category-count">36</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/">
                出题记录
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">标签</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/got/" rel="tag">.got</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ARM/" rel="tag">ARM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AutoRe/" rel="tag">AutoRe</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Brainfuck/" rel="tag">Brainfuck</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CUDA/" rel="tag">CUDA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Cheat-Engine/" rel="tag">Cheat Engine</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DOS/" rel="tag">DOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Driver/" rel="tag">Driver</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Frida-Hook/" rel="tag">Frida Hook</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Harmony-OS/" rel="tag">Harmony OS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/IPC/" rel="tag">IPC</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Indirect-Jump/" rel="tag">Indirect Jump</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Kotlin/" rel="tag">Kotlin</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Lua/" rel="tag">Lua</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Mac/" rel="tag">Mac</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Obfuscate/" rel="tag">Obfuscate</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pascal/" rel="tag">Pascal</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Powershell/" rel="tag">Powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pyarmor/" rel="tag">Pyarmor</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/QEMU/" rel="tag">QEMU</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/R2R/" rel="tag">R2R</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Remote/" rel="tag">Remote</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Rust/" rel="tag">Rust</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Subprocess/" rel="tag">Subprocess</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Traffic/" rel="tag">Traffic</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Unicorn/" rel="tag">Unicorn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/VM/" rel="tag">VM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WASM/" rel="tag">WASM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Wechat-Mini-Program/" rel="tag">Wechat Mini Program</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Windows-DLL/" rel="tag">Windows DLL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Yara/" rel="tag">Yara</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iOS/" rel="tag">iOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/il2cpp/" rel="tag">il2cpp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pickle/" rel="tag">pickle</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/x96/" rel="tag">x96</a></li></ul>
    </div>
  </div>


    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-rctf_25_onion_det" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        RCTF 2025 Reverse-Onion &amp; Determinism WriteUp
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2025-11-18T02:00:00.000Z" itemprop="datePublished">2025-11-18</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/WriteUp/">WriteUp</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            13k 词 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AutoRe/" rel="tag">AutoRe</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/VM/" rel="tag">VM</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="Onion"><a href="#Onion" class="headerlink" title="Onion"></a>Onion</h1><p>读取50个64位整数作为密钥，存储到0x5555555C3D00</p>
<p>vm字节码加载到0x5555555B5D00</p>
<p>参数结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int8 *opcodes;</span><br><span class="line">_QWORD reg[<span class="number">8</span>];</span><br><span class="line">_WORD MEM[<span class="number">256</span>];</span><br><span class="line"><span class="type">unsigned</span> __int16 PC;</span><br><span class="line"><span class="type">unsigned</span> __int16 HIPC;</span><br><span class="line"><span class="type">unsigned</span> __int16 LOTAG;</span><br><span class="line"><span class="type">unsigned</span> __int16 HITAG;</span><br><span class="line"><span class="type">unsigned</span> __int16 STAKPC;</span><br><span class="line"><span class="type">bool</span> ZFLAG;</span><br><span class="line"><span class="type">char</span> ENDFLAG;</span><br></pre></td></tr></table></figure>

<p>字节码种类：</p>
<table>
<thead>
<tr>
<th>字节码</th>
<th>参数</th>
<th>作用</th>
<th>等价于</th>
<th>长度</th>
</tr>
</thead>
<tbody><tr>
<td>0x01</td>
<td>1个int16</td>
<td>无条件跳转</td>
<td>jmp</td>
<td>3</td>
</tr>
<tr>
<td>0x02</td>
<td>1个int16</td>
<td>!ZFLAG 时跳转</td>
<td>jz</td>
<td>3</td>
</tr>
<tr>
<td>0x03</td>
<td>1个int16</td>
<td>ZFLAG 时跳转</td>
<td>jnz</td>
<td>3</td>
</tr>
<tr>
<td>0xFF</td>
<td>-</td>
<td>结束</td>
<td>exit</td>
<td>1</td>
</tr>
<tr>
<td>0x11</td>
<td>1个int16</td>
<td>给LOTAG赋值</td>
<td>mov</td>
<td>3</td>
</tr>
<tr>
<td>0x12</td>
<td>1个int16</td>
<td>给HITAG赋值</td>
<td>mov</td>
<td>3</td>
</tr>
<tr>
<td>0x15</td>
<td>1个int8</td>
<td>从LOTAG指向的文件地址处加载int64到寄存器A</td>
<td>load_data</td>
<td>2</td>
</tr>
<tr>
<td>0x16</td>
<td>1个int8, 1个int64</td>
<td>将64位立即数加载到寄存器A</td>
<td>load_imm</td>
<td>10</td>
</tr>
<tr>
<td>0x17</td>
<td>2个int8</td>
<td>mov regA, regB</td>
<td>mov</td>
<td>3</td>
</tr>
<tr>
<td>0x18</td>
<td>1个int8, 1个int16</td>
<td>从LOTAG + imm16 指向的文件地址处加载int64到寄存器A</td>
<td>load_data</td>
<td>4</td>
</tr>
<tr>
<td>0x19</td>
<td>1个int8</td>
<td>把寄存器A的值写入LOTAG指向的文件地址</td>
<td>write</td>
<td>2</td>
</tr>
<tr>
<td>0x1A</td>
<td>2个int8</td>
<td>从寄存器B + LOTAG指向的文件地址读取1字节到寄存器A</td>
<td>load_data</td>
<td>3</td>
</tr>
<tr>
<td>0x1B</td>
<td>2个int8</td>
<td>将寄存器A的低字节写入寄存器B + LOTAG指向的文件地址</td>
<td>write</td>
<td>3</td>
</tr>
<tr>
<td>0x1C</td>
<td>1个int8</td>
<td>寄存器自增，如果结果为0则设置ZFLAG为true</td>
<td>inc</td>
<td>2</td>
</tr>
<tr>
<td>0x1D</td>
<td>1个int8</td>
<td>寄存器自减，如果结果为0则设置ZFLAG为true</td>
<td>dec</td>
<td>2</td>
</tr>
<tr>
<td>0x1E</td>
<td>2个int8</td>
<td>shr regA, imm8，如果结果为0则设置ZFLAG为true</td>
<td>shr</td>
<td>3</td>
</tr>
<tr>
<td>0x1F</td>
<td>1个int8</td>
<td>将寄存器低 16 位加到LOTAG</td>
<td>add_tag</td>
<td>2</td>
</tr>
<tr>
<td>0x25</td>
<td>2个int8</td>
<td>and regA, regB，如果结果为0则设置ZFLAG为true</td>
<td>and</td>
<td>3</td>
</tr>
<tr>
<td>0x26</td>
<td>2个int8</td>
<td>xor regA, regB，如果结果为0则设置ZFLAG为true</td>
<td>xor</td>
<td>3</td>
</tr>
<tr>
<td>0x27</td>
<td>2个int8</td>
<td>shl regA, imm8，如果结果为0则设置ZFLAG为true</td>
<td>shl</td>
<td>3</td>
</tr>
<tr>
<td>0x29</td>
<td>1个int8, 1个int64</td>
<td>xor regA, imm64，如果结果为0则设置ZFLAG为true</td>
<td>xor_imm</td>
<td>10</td>
</tr>
<tr>
<td>0x2A</td>
<td>1个int8, 1个int64</td>
<td>and regA, imm64，如果结果为0则设置ZFLAG为true</td>
<td>and_imm</td>
<td>10</td>
</tr>
<tr>
<td>0x2B</td>
<td>2个int8</td>
<td>从寄存器B + HITAG指向的文件地址读取1字节到寄存器A</td>
<td>load_data</td>
<td>3</td>
</tr>
<tr>
<td>0x2C</td>
<td>2个int8</td>
<td>将寄存器A的低字节写入寄存器B + HITAG指向的文件地址</td>
<td>write</td>
<td>3</td>
</tr>
<tr>
<td>0x32</td>
<td>1个int8, 1个int64</td>
<td>cmp regA, imm64，如果相等则设置ZFLAG为true</td>
<td>cmp</td>
<td>10</td>
</tr>
<tr>
<td>0x80</td>
<td>-</td>
<td>将下一条指令地址保存到STAKPC</td>
<td>save_ret_addr</td>
<td>1</td>
</tr>
<tr>
<td>0x81</td>
<td>1个int8</td>
<td>将STAKPC的值+3后存入参数索引指向的缓存</td>
<td>push_ret_addr</td>
<td>2</td>
</tr>
<tr>
<td>0x82</td>
<td>1个int8</td>
<td>将下一指令地址写入HIPC-2指向的文件地址并跳转</td>
<td>call</td>
<td>2</td>
</tr>
<tr>
<td>0x83</td>
<td>-</td>
<td>跳回返回地址，恢复HIPC</td>
<td>ret</td>
<td>1</td>
</tr>
<tr>
<td>0x84</td>
<td>1个int8</td>
<td>将寄存器A的值HIPC-8指向的文件地址</td>
<td>pushq</td>
<td>2</td>
</tr>
<tr>
<td>0x85</td>
<td>1个int8</td>
<td>从HIPC指向的文件地址取出int64赋值给寄存器A，恢复HIPC</td>
<td>popq</td>
<td>2</td>
</tr>
<tr>
<td>0x90</td>
<td>1个int8</td>
<td>输出1字节</td>
<td>printf</td>
<td>2</td>
</tr>
</tbody></table>
<p>基本结构：</p>
<p>外层结构体：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">VMOPCODE ptr</span><br><span class="line">REGS 8 * qword</span><br><span class="line">MEM 256 * word</span><br><span class="line">LOPC word</span><br><span class="line">HIPC word</span><br><span class="line">LOTAG word</span><br><span class="line">HITAG word</span><br><span class="line">STAKPC word</span><br><span class="line">ZFLAG bool</span><br><span class="line">ENDFLAG bool</span><br></pre></td></tr></table></figure>

<p>opcode内部前26497是文件，0xE000开始是50个8字节输入，0xFFF7处有一个倒着生长的栈（向上生长）</p>
<p>在代码中存在3个函数，0x104、0x116和0x2BE，0x104是校验未通过的退出函数，0x116和0x2BE是两个不同的加密函数</p>
<p>第一个check仅校验输入的第三个int64（0xE010）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><span class="line">0x0	jmp	0x100</span><br><span class="line">0x3	jmp	0x5a9</span><br><span class="line">0x100	svstk	0x101</span><br><span class="line">0x101	jmp	0x110</span><br><span class="line">0x104	stdout</span><br><span class="line">0x106	stdout</span><br><span class="line">0x108	stdout</span><br><span class="line">0x10a	stdout</span><br><span class="line">0x10c	stdout</span><br><span class="line">0x10e	exit</span><br><span class="line">0x110	push	mem[0x1]	0x104</span><br><span class="line">0x112	svstk	0x113</span><br><span class="line">0x113	jmp	0x2b8</span><br><span class="line">0x2b8	push	mem[0x10]	0x116</span><br><span class="line">0x2ba	svstk	0x2bb</span><br><span class="line">0x2bb	jmp	0x5a4</span><br><span class="line">0x2be	pushq	code[0xfff5]	reg[0]</span><br><span class="line">0x2c0	pushq	code[0xffed]	reg[1]</span><br><span class="line">0x2c2	pushq	code[0xffe5]	reg[2]</span><br><span class="line">0x2c4	pushq	code[0xffdd]	reg[3]</span><br><span class="line">0x2c6	pushq	code[0xffd5]	reg[4]</span><br><span class="line">0x2c8	pushq	code[0xffcd]	reg[5]</span><br><span class="line">0x2ca	pushq	code[0xffc5]	reg[6]</span><br><span class="line">0x2cc	pushq	code[0xffbd]	reg[7]</span><br><span class="line">0x2ce	mov	reg[1]	reg[0]</span><br><span class="line">0x2d1	shr	reg[1]	0x20</span><br><span class="line">0x2d4	and_imm	reg[0]	0xffffffff</span><br><span class="line">0x2de	load	code[0x7200]	reg[2]</span><br><span class="line">0x2e0	pushq	code[0xffb5]	reg[0]</span><br><span class="line">0x2e2	mov_imm	reg[0]	0x8</span><br><span class="line">0x2ec	add	LOTAG	regs[0]</span><br><span class="line">0x2ee	popq	reg[0]	code[0xffb5]</span><br><span class="line">0x2f0	load	code[0x7208]	reg[3]</span><br><span class="line">0x2f2	pushq	code[0xffb5]	reg[0]</span><br><span class="line">0x2f4	mov_imm	reg[0]	0x8</span><br><span class="line">0x2fe	pushq	code[0xffad]	reg[5]</span><br><span class="line">0x300	mov_imm	reg[5]	0x10</span><br><span class="line">0x30a	xor_imm	reg[5]	0xffffffffffffffff</span><br><span class="line">0x314	pushq	code[0xffa5]	reg[6]</span><br><span class="line">0x316	pushq	code[0xff9d]	reg[7]</span><br><span class="line">0x318	mov_imm	reg[6]	0x1</span><br><span class="line">0x322	mov	reg[7]	reg[5]</span><br><span class="line">0x325	and	reg[7]	reg[6]</span><br><span class="line">0x328	xor	reg[5]	reg[6]</span><br><span class="line">0x32b	cmp_imm	reg[7]	0x0</span><br><span class="line">0x335	jnz	0x341</span><br><span class="line">0x338	shl	reg[7]	0x1</span><br><span class="line">0x33b	mov	reg[6]	reg[7]</span><br><span class="line">0x33e	jmp	0x322</span><br><span class="line">0x341	popq	reg[7]	code[0xff9d]</span><br><span class="line">0x343	popq	reg[6]	code[0xffa5]</span><br><span class="line">0x345	pushq	code[0xffa5]	reg[6]</span><br><span class="line">0x347	pushq	code[0xff9d]	reg[7]</span><br><span class="line">0x349	mov	reg[6]	reg[5]</span><br><span class="line">0x34c	mov	reg[7]	reg[0]</span><br><span class="line">0x34f	and	reg[7]	reg[6]</span><br><span class="line">0x352	xor	reg[0]	reg[6]</span><br><span class="line">0x355	cmp_imm	reg[7]	0x0</span><br><span class="line">0x35f	jnz	0x36b</span><br><span class="line">0x36b	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x375	popq	reg[7]	code[0xff9d]</span><br><span class="line">0x377	popq	reg[6]	code[0xffa5]</span><br><span class="line">0x379	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x383	popq	reg[5]	code[0xffad]</span><br><span class="line">0x385	add	LOTAG	regs[0]</span><br><span class="line">0x387	popq	reg[0]	code[0xffb5]</span><br><span class="line">0x389	mov	reg[4]	reg[2]</span><br><span class="line">0x38c	mov	reg[5]	reg[3]</span><br><span class="line">0x38f	and_imm	reg[2]	0xffffffff</span><br><span class="line">0x399	shr	reg[4]	0x20</span><br><span class="line">0x39c	and_imm	reg[3]	0xffffffff</span><br><span class="line">0x3a6	shr	reg[5]	0x20</span><br><span class="line">0x3a9	pushq	code[0xffb5]	reg[7]</span><br><span class="line">0x3ab	mov	reg[7]	reg[3]</span><br><span class="line">0x3ae	mov	reg[3]	reg[4]</span><br><span class="line">0x3b1	mov	reg[4]	reg[7]</span><br><span class="line">0x3b4	popq	reg[7]	code[0xffb5]</span><br><span class="line">0x3b6	mov_imm	reg[6]	0x0</span><br><span class="line">0x3c0	pushq	code[0xffb5]	reg[7]</span><br><span class="line">0x3c2	mov	reg[7]	reg[0]</span><br><span class="line">0x3c5	pushq	code[0xffad]	reg[6]</span><br><span class="line">0x3c7	pushq	code[0xffa5]	reg[7]</span><br><span class="line">0x3c9	mov	reg[6]	reg[7]</span><br><span class="line">0x3cc	mov	reg[7]	reg[7]</span><br><span class="line">0x3cf	shr	reg[6]	0x8</span><br><span class="line">0x3d2	shl	reg[7]	0x18</span><br><span class="line">0x3d5	xor	reg[6]	reg[7]</span><br><span class="line">0x3d8	and_imm	reg[6]	0xffffffff</span><br><span class="line">0x3e2	popq	reg[7]	code[0xffa5]</span><br><span class="line">0x3e4	mov	reg[7]	reg[6]</span><br><span class="line">0x3e7	popq	reg[6]	code[0xffad]</span><br><span class="line">0x3e9	mov	reg[0]	reg[7]</span><br><span class="line">0x3ec	pushq	code[0xffad]	reg[6]</span><br><span class="line">0x3ee	pushq	code[0xffa5]	reg[7]</span><br><span class="line">0x3f0	mov	reg[6]	reg[1]</span><br><span class="line">0x3f3	mov	reg[7]	reg[0]</span><br><span class="line">0x3f6	and	reg[7]	reg[6]</span><br><span class="line">0x3f9	xor	reg[0]	reg[6]</span><br><span class="line">0x3fc	cmp_imm	reg[7]	0x0</span><br><span class="line">0x406	jnz	0x412</span><br><span class="line">0x409	shl	reg[7]	0x1</span><br><span class="line">0x40c	mov	reg[6]	reg[7]</span><br><span class="line">0x40f	jmp	0x3f3</span><br><span class="line">0x412	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x41c	popq	reg[7]	code[0xffa5]</span><br><span class="line">0x41e	popq	reg[6]	code[0xffad]</span><br><span class="line">0x420	and_imm	reg[0]	0xffffffff</span><br><span class="line">0x42a	xor	reg[0]	reg[2]</span><br><span class="line">0x42d	and_imm	reg[0]	0xffffffff</span><br><span class="line">0x437	mov	reg[7]	reg[1]</span><br><span class="line">0x43a	pushq	code[0xffad]	reg[6]</span><br><span class="line">0x43c	pushq	code[0xffa5]	reg[7]</span><br><span class="line">0x43e	mov	reg[6]	reg[7]</span><br><span class="line">0x441	mov	reg[7]	reg[7]</span><br><span class="line">0x444	shl	reg[6]	0x3</span><br><span class="line">0x447	shr	reg[7]	0x1d</span><br><span class="line">0x44a	xor	reg[6]	reg[7]</span><br><span class="line">0x44d	and_imm	reg[6]	0xffffffff</span><br><span class="line">0x457	popq	reg[7]	code[0xffa5]</span><br><span class="line">0x459	mov	reg[7]	reg[6]</span><br><span class="line">0x45c	popq	reg[6]	code[0xffad]</span><br><span class="line">0x45e	mov	reg[1]	reg[7]</span><br><span class="line">0x461	xor	reg[1]	reg[0]</span><br><span class="line">0x464	and_imm	reg[1]	0xffffffff</span><br><span class="line">0x46e	popq	reg[7]	code[0xffb5]</span><br><span class="line">0x470	cmp_imm	reg[6]	0x1a</span><br><span class="line">0x47a	jnz	0x54a</span><br><span class="line">0x47d	pushq	code[0xffb5]	reg[0]</span><br><span class="line">0x47f	pushq	code[0xffad]	reg[1]</span><br><span class="line">0x481	mov	reg[0]	reg[3]</span><br><span class="line">0x484	mov	reg[1]	reg[2]</span><br><span class="line">0x487	mov	reg[2]	reg[6]</span><br><span class="line">0x48a	pushq	code[0xffa5]	reg[7]</span><br><span class="line">0x48c	mov	reg[7]	reg[0]</span><br><span class="line">0x48f	pushq	code[0xff9d]	reg[6]</span><br><span class="line">0x491	pushq	code[0xff95]	reg[7]</span><br><span class="line">0x493	mov	reg[6]	reg[7]</span><br><span class="line">0x496	mov	reg[7]	reg[7]</span><br><span class="line">0x499	shr	reg[6]	0x8</span><br><span class="line">0x49c	shl	reg[7]	0x18</span><br><span class="line">0x49f	xor	reg[6]	reg[7]</span><br><span class="line">0x4a2	and_imm	reg[6]	0xffffffff</span><br><span class="line">0x4ac	popq	reg[7]	code[0xff95]</span><br><span class="line">0x4ae	mov	reg[7]	reg[6]</span><br><span class="line">0x4b1	popq	reg[6]	code[0xff9d]</span><br><span class="line">0x4b3	mov	reg[0]	reg[7]</span><br><span class="line">0x4b6	pushq	code[0xff9d]	reg[6]</span><br><span class="line">0x4b8	pushq	code[0xff95]	reg[7]</span><br><span class="line">0x4ba	mov	reg[6]	reg[1]</span><br><span class="line">0x4bd	mov	reg[7]	reg[0]</span><br><span class="line">0x4c0	and	reg[7]	reg[6]</span><br><span class="line">0x4c3	xor	reg[0]	reg[6]</span><br><span class="line">0x4c6	cmp_imm	reg[7]	0x0</span><br><span class="line">0x4d0	jnz	0x4dc</span><br><span class="line">0x4d3	shl	reg[7]	0x1</span><br><span class="line">0x4d6	mov	reg[6]	reg[7]</span><br><span class="line">0x4d9	jmp	0x4bd</span><br><span class="line">0x4dc	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x4e6	popq	reg[7]	code[0xff95]</span><br><span class="line">0x4e8	popq	reg[6]	code[0xff9d]</span><br><span class="line">0x4ea	and_imm	reg[0]	0xffffffff</span><br><span class="line">0x4f4	xor	reg[0]	reg[2]</span><br><span class="line">0x4f7	and_imm	reg[0]	0xffffffff</span><br><span class="line">0x501	mov	reg[7]	reg[1]</span><br><span class="line">0x504	pushq	code[0xff9d]	reg[6]</span><br><span class="line">0x506	pushq	code[0xff95]	reg[7]</span><br><span class="line">0x508	mov	reg[6]	reg[7]</span><br><span class="line">0x50b	mov	reg[7]	reg[7]</span><br><span class="line">0x50e	shl	reg[6]	0x3</span><br><span class="line">0x511	shr	reg[7]	0x1d</span><br><span class="line">0x514	xor	reg[6]	reg[7]</span><br><span class="line">0x517	and_imm	reg[6]	0xffffffff</span><br><span class="line">0x521	popq	reg[7]	code[0xff95]</span><br><span class="line">0x523	mov	reg[7]	reg[6]</span><br><span class="line">0x526	popq	reg[6]	code[0xff9d]</span><br><span class="line">0x528	mov	reg[1]	reg[7]</span><br><span class="line">0x52b	xor	reg[1]	reg[0]</span><br><span class="line">0x52e	and_imm	reg[1]	0xffffffff</span><br><span class="line">0x538	popq	reg[7]	code[0xffa5]</span><br><span class="line">0x53a	mov	reg[2]	reg[1]</span><br><span class="line">0x53d	mov	reg[3]	reg[4]</span><br><span class="line">0x540	mov	reg[4]	reg[5]</span><br><span class="line">0x543	mov	reg[5]	reg[0]</span><br><span class="line">0x546	popq	reg[1]	code[0xffad]</span><br><span class="line">0x548	popq	reg[0]	code[0xffb5]</span><br><span class="line">0x54a	inc	reg[6]</span><br><span class="line">0x54c	cmp_imm	reg[6]	0x1b</span><br><span class="line">0x556	jnz	0x55c</span><br><span class="line">0x559	jmp	0x3c0</span><br><span class="line">0x55c	shl	reg[1]	0x20</span><br><span class="line">0x55f	pushq	code[0xffb5]	reg[6]</span><br><span class="line">0x561	pushq	code[0xffad]	reg[7]</span><br><span class="line">0x563	mov	reg[6]	reg[1]</span><br><span class="line">0x566	mov	reg[7]	reg[0]</span><br><span class="line">0x569	and	reg[7]	reg[6]</span><br><span class="line">0x56c	xor	reg[0]	reg[6]</span><br><span class="line">0x56f	cmp_imm	reg[7]	0x0</span><br><span class="line">0x579	jnz	0x585</span><br><span class="line">0x585	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x58f	popq	reg[7]	code[0xffad]</span><br><span class="line">0x591	popq	reg[6]	code[0xffb5]</span><br><span class="line">0x593	popq	reg[7]	code[0xffbd]</span><br><span class="line">0x595	popq	reg[6]	code[0xffc5]</span><br><span class="line">0x597	popq	reg[5]	code[0xffcd]</span><br><span class="line">0x599	popq	reg[4]	code[0xffd5]</span><br><span class="line">0x59b	popq	reg[3]	code[0xffdd]</span><br><span class="line">0x59d	popq	reg[2]	code[0xffe5]</span><br><span class="line">0x59f	popq	reg[1]	code[0xffed]</span><br><span class="line">0x5a1	popq	reg[6]	code[0xfff5]</span><br><span class="line">0x5a3	retn	0x705</span><br><span class="line">0x5a4	push	mem[0x20]	0x2be</span><br><span class="line">0x5a6	jmp	0x3</span><br><span class="line">0x5a9	mov_imm	LOTAG	0xe000</span><br><span class="line">0x5ac	load	reg[0]	code[0xe010]</span><br><span class="line">0x5b0	mov	reg[5]	reg[0]</span><br><span class="line">0x5b3	pushq	code[0xfff7]	reg[5]</span><br><span class="line">0x5b5	mov_imm	reg[5]	0x48f0e6421ac66dea</span><br><span class="line">0x5bf	xor_imm	reg[5]	0xffffffffffffffff</span><br><span class="line">0x5c9	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x5cb	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x5cd	mov_imm	reg[6]	0x1</span><br><span class="line">0x5d7	mov	reg[7]	reg[5]</span><br><span class="line">0x5da	and	reg[7]	reg[6]</span><br><span class="line">0x5dd	xor	reg[5]	reg[6]</span><br><span class="line">0x5e0	cmp_imm	reg[7]	0x0</span><br><span class="line">0x5ea	jnz	0x5f6</span><br><span class="line">0x5ed	shl	reg[7]	0x1</span><br><span class="line">0x5f0	mov	reg[6]	reg[7]</span><br><span class="line">0x5f3	jmp	0x5d7</span><br><span class="line">0x5f6	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x5f8	popq	reg[6]	code[0xffef]</span><br><span class="line">0x5fa	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x5fc	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x5fe	mov	reg[6]	reg[5]</span><br><span class="line">0x601	mov	reg[7]	reg[0]</span><br><span class="line">0x604	and	reg[7]	reg[6]</span><br><span class="line">0x607	xor	reg[0]	reg[6]</span><br><span class="line">0x60a	cmp_imm	reg[7]	0x0</span><br><span class="line">0x614	jnz	0x620</span><br><span class="line">0x617	shl	reg[7]	0x1</span><br><span class="line">0x61a	mov	reg[6]	reg[7]</span><br><span class="line">0x61d	jmp	0x601</span><br><span class="line">0x620	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x62a	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x62c	popq	reg[6]	code[0xffef]</span><br><span class="line">0x62e	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x638	popq	reg[5]	code[0xfff7]</span><br><span class="line">0x63a	xor_imm	reg[0]	0x5074d85b9194e696</span><br><span class="line">0x644	pushq	code[0xfff7]	reg[5]</span><br><span class="line">0x646	mov_imm	reg[5]	0x5566488c9c5cf234</span><br><span class="line">0x650	xor_imm	reg[5]	0xffffffffffffffff</span><br><span class="line">0x65a	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x65c	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x65e	mov_imm	reg[6]	0x1</span><br><span class="line">0x668	mov	reg[7]	reg[5]</span><br><span class="line">0x66b	and	reg[7]	reg[6]</span><br><span class="line">0x66e	xor	reg[5]	reg[6]</span><br><span class="line">0x671	cmp_imm	reg[7]	0x0</span><br><span class="line">0x67b	jnz	0x687</span><br><span class="line">0x67e	shl	reg[7]	0x1</span><br><span class="line">0x681	mov	reg[6]	reg[7]</span><br><span class="line">0x684	jmp	0x668</span><br><span class="line">0x687	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x689	popq	reg[6]	code[0xffef]</span><br><span class="line">0x68b	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x68d	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x68f	mov	reg[6]	reg[5]</span><br><span class="line">0x692	mov	reg[7]	reg[0]</span><br><span class="line">0x695	and	reg[7]	reg[6]</span><br><span class="line">0x698	xor	reg[0]	reg[6]</span><br><span class="line">0x69b	cmp_imm	reg[7]	0x0</span><br><span class="line">0x6a5	jnz	0x6b1</span><br><span class="line">0x6a8	shl	reg[7]	0x1</span><br><span class="line">0x6ab	mov	reg[6]	reg[7]</span><br><span class="line">0x6ae	jmp	0x692</span><br><span class="line">0x6b1	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x6bb	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x6bd	popq	reg[6]	code[0xffef]</span><br><span class="line">0x6bf	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x6c9	popq	reg[5]	code[0xfff7]</span><br><span class="line">0x6cb	xor_imm	reg[0]	0x8cb331163a92fc19</span><br><span class="line">0x6d5	mov_imm	LOTAG	0x7200</span><br><span class="line">0x6d8	mov_imm	reg[1]	0x36b1cc9fe433713d</span><br><span class="line">0x6e2	write	code[0x7200]	reg[1]</span><br><span class="line">0x6e4	pushq	code[0xfff7]	reg[0]</span><br><span class="line">0x6e6	mov_imm	reg[0]	0x8</span><br><span class="line">0x6f0	add	LOTAG	regs[0]</span><br><span class="line">0x6f2	popq	reg[0]	code[0xfff7]</span><br><span class="line">0x6f4	mov_imm	reg[1]	0xf97646d69c84ebd8</span><br><span class="line">0x6fe	write	code[0x7208]	reg[1]</span><br><span class="line">0x700	mov_imm	LOTAG	0x7200</span><br><span class="line">0x703	call	0x2be</span><br><span class="line">0x705	cmp_imm	reg[0]	0xda19ba6b81c83f61</span><br><span class="line">0x70f	jnz	0x715</span><br><span class="line">0x712	call	0x104</span><br></pre></td></tr></table></figure>

<p>call函数之前的代码等价于：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">R0 = inp[<span class="number">2</span>]</span><br><span class="line">R5 = <span class="number">0x48f0e6421ac66dea</span></span><br><span class="line">R5 = ~R5 &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">R6 = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    R7 = R5 &amp; R6</span><br><span class="line">    R5 ^= R6</span><br><span class="line">    <span class="keyword">if</span> R7 == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">    R6 = R7 &lt;&lt; <span class="number">1</span> &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">R6, R7 = R5, <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    R7 = R0 &amp; R6</span><br><span class="line">    R0 ^= R6</span><br><span class="line">    <span class="keyword">if</span> R7 == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">    R6 = R7 &lt;&lt; <span class="number">1</span> &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">R5, R6, R7 = inp, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">R0 ^= <span class="number">0x5074d85b9194e696</span>    </span><br><span class="line">R5 = <span class="number">0x5566488c9c5cf234</span></span><br><span class="line">R5 = ~R5 &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">R6 = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    R7 = R5 &amp; R6</span><br><span class="line">    R5 ^= R6</span><br><span class="line">    <span class="keyword">if</span> R7 == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">    R6 = R7 &lt;&lt; <span class="number">1</span> &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">R6, R7 = R5, <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    R7 = R0 &amp; R6</span><br><span class="line">    R0 ^= R6</span><br><span class="line">    <span class="keyword">if</span> R7 == <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">    R6 = R7 &lt;&lt; <span class="number">1</span> &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">R5, R6, R7 = inp, <span class="number">0</span>, <span class="number">0</span></span><br><span class="line">R0 ^= <span class="number">0x8cb331163a92fc19</span></span><br></pre></td></tr></table></figure>

<p>进一步等价于（用循环和位运算实现了加减法）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">R0 = inp[<span class="number">2</span>]</span><br><span class="line">R0 -= <span class="number">0x48f0e6421ac66dea</span></span><br><span class="line">R0 ^= <span class="number">0x5074d85b9194e696</span>    </span><br><span class="line">R0 -= <span class="number">0x5566488c9c5cf234</span></span><br><span class="line">R0 ^= <span class="number">0x8cb331163a92fc19</span></span><br></pre></td></tr></table></figure>

<p>函数0x2BE是一个SPECK加密，R0为明文，code[0x7200]和code[0x7208]为顺序打乱的密钥，同构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">enc</span>(<span class="params">inp, key</span>):</span><br><span class="line">    k = [key[<span class="number">0</span>] &amp; <span class="number">0xFFFFFFFF</span>, (key[<span class="number">1</span>] &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>, key[<span class="number">1</span>] &amp; <span class="number">0xFFFFFFFF</span>, (key[<span class="number">0</span>] &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>]</span><br><span class="line">    rk = [k[<span class="number">0</span>]]</span><br><span class="line">    kl = [k[<span class="number">3</span>], k[<span class="number">2</span>], k[<span class="number">1</span>]]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">26</span>):</span><br><span class="line">        l1 = (((((kl[<span class="number">0</span>] &gt;&gt; <span class="number">0x08</span>) | (kl[<span class="number">0</span>] &lt;&lt; <span class="number">0x18</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + rk[i]) ^ i) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        k1 = ((((rk[i] &lt;&lt; <span class="number">0x03</span>) | (rk[i] &gt;&gt; <span class="number">0x1D</span>)) &amp; <span class="number">0xFFFFFFFF</span>) ^ l1) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        kl.pop(<span class="number">0</span>)</span><br><span class="line">        kl.append(l1)</span><br><span class="line">        rk.append(k1)</span><br><span class="line">    x = inp &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    y = inp &gt;&gt; <span class="number">32</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">27</span>):</span><br><span class="line">        x = (((((x &gt;&gt; <span class="number">0x08</span>) | (x &lt;&lt; <span class="number">0x18</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + y) &amp; <span class="number">0xFFFFFFFF</span>) ^ rk[i]</span><br><span class="line">        y = (((y &lt;&lt; <span class="number">0x03</span>) | (y &gt;&gt; <span class="number">0x1D</span>)) &amp; <span class="number">0xFFFFFFFF</span>) ^ x</span><br><span class="line">    <span class="keyword">return</span> y &lt;&lt; <span class="number">32</span> | x</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec</span>(<span class="params">inp, key</span>):</span><br><span class="line">    k = [key[<span class="number">0</span>] &amp; <span class="number">0xFFFFFFFF</span>, (key[<span class="number">1</span>] &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>, key[<span class="number">1</span>] &amp; <span class="number">0xFFFFFFFF</span>, (key[<span class="number">0</span>] &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>]</span><br><span class="line">    rk = [k[<span class="number">0</span>]]</span><br><span class="line">    kl = [k[<span class="number">3</span>], k[<span class="number">2</span>], k[<span class="number">1</span>]]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">26</span>):</span><br><span class="line">        l1 = (((((kl[<span class="number">0</span>] &gt;&gt; <span class="number">0x08</span>) | (kl[<span class="number">0</span>] &lt;&lt; <span class="number">0x18</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + rk[i]) ^ i) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        k1 = ((((rk[i] &lt;&lt; <span class="number">0x03</span>) | (rk[i] &gt;&gt; <span class="number">0x1D</span>)) &amp; <span class="number">0xFFFFFFFF</span>) ^ l1) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        kl.pop(<span class="number">0</span>)</span><br><span class="line">        kl.append(l1)</span><br><span class="line">        rk.append(k1)</span><br><span class="line">    x = inp &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    y = inp &gt;&gt; <span class="number">32</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">26</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        y = (((y^x) &gt;&gt; <span class="number">0x03</span>) | ((y^x) &lt;&lt; <span class="number">0x1D</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        x = (((((x^rk[i]) - y) &amp; <span class="number">0xFFFFFFFF</span>) &lt;&lt; <span class="number">0x08</span>) | ((((x^rk[i]) - y) &amp; <span class="number">0xFFFFFFFF</span>) &gt;&gt; <span class="number">0x18</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> y &lt;&lt; <span class="number">32</span> | x</span><br><span class="line"></span><br><span class="line">key = [<span class="number">0x36b1cc9fe433713d</span>, <span class="number">0xf97646d69c84ebd8</span>]</span><br><span class="line">inp = <span class="number">0xcf626ef7f00ee7fd</span></span><br><span class="line">enc = enc(inp, key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(enc)&#125;</span>&quot;</span>)</span><br><span class="line">enc = <span class="number">0xda19ba6b81c83f61</span></span><br><span class="line">dec = dec(enc, key)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(dec)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>得到中间密文<code>0x38377082e139ecb9</code>，解密得到inp[2] &#x3D; <code>0xa28f38bd0463522c</code>，继续执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x715	mov	reg[0]	reg[5]</span><br><span class="line">0x718	mov_imm	HITAG	0x72a</span><br><span class="line">0x71b	mov_imm	reg[1]	0x6057</span><br><span class="line">0x725	call	0x116</span><br></pre></td></tr></table></figure>

<p>0x116是一个标准RC4，以inp[2]为密钥，存储在code[0x7100]，S盒存储在code[0x7000]，自解密0x72A开始长度0x6057的代码块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">0x116	mov_imm	LOTAG	0x7100</span><br><span class="line">0x119	write	code[0x7100]	reg[0]</span><br><span class="line">0x11b	mov_imm	LOTAG	0x7000</span><br><span class="line">0x11e	mov_imm	reg[2]	0x0</span><br><span class="line">0x128	write	code[LOTAG + reg[2]]	reg[2]</span><br><span class="line">0x12b	inc	reg[2]</span><br><span class="line">0x12d	cmp_imm	reg[2]	0x100</span><br><span class="line">0x137	jz	0x128</span><br><span class="line">0x13a	mov_imm	reg[2]	0x0</span><br><span class="line">0x144	mov_imm	reg[3]	0x0</span><br><span class="line">0x14e	mov_imm	reg[7]	0xff</span><br><span class="line">0x158	mov_imm	LOTAG	0x7000</span><br><span class="line">0x15b	load	reg[5]	code[LOTAG + reg[2]]</span><br><span class="line">0x15e	mov	reg[4]	reg[2]</span><br><span class="line">0x161	and_imm	reg[4]	0x7</span><br><span class="line">0x16b	mov_imm	LOTAG	0x7100</span><br><span class="line">0x16e	load	reg[4]	code[LOTAG + reg[4]]</span><br><span class="line">0x171	pushq	code[0xfff5]	reg[6]</span><br><span class="line">0x173	pushq	code[0xffed]	reg[7]</span><br><span class="line">0x175	mov	reg[6]	reg[5]</span><br><span class="line">0x178	mov	reg[7]	reg[3]</span><br><span class="line">0x17b	and	reg[7]	reg[6]</span><br><span class="line">0x17e	xor	reg[3]	reg[6]</span><br><span class="line">0x181	cmp_imm	reg[7]	0x0</span><br><span class="line">0x18b	jnz	0x197</span><br><span class="line">0x18e	shl	reg[7]	0x1</span><br><span class="line">0x191	mov	reg[6]	reg[7]</span><br><span class="line">0x194	jmp	0x178</span><br><span class="line">0x197	and_imm	reg[3]	0xffffffffffffffff</span><br><span class="line">0x1a1	popq	reg[7]	code[0xffed]</span><br><span class="line">0x1a3	popq	reg[6]	code[0xfff5]</span><br><span class="line">0x1a5	pushq	code[0xfff5]	reg[6]</span><br><span class="line">0x1a7	pushq	code[0xffed]	reg[7]</span><br><span class="line">0x1a9	mov	reg[6]	reg[4]</span><br><span class="line">0x1ac	mov	reg[7]	reg[3]</span><br><span class="line">0x1af	and	reg[7]	reg[6]</span><br><span class="line">0x1b2	xor	reg[3]	reg[6]</span><br><span class="line">0x1b5	cmp_imm	reg[7]	0x0</span><br><span class="line">0x1bf	jnz	0x1cb</span><br><span class="line">0x1c2	shl	reg[7]	0x1</span><br><span class="line">0x1c5	mov	reg[6]	reg[7]</span><br><span class="line">0x1c8	jmp	0x1ac</span><br><span class="line">0x1cb	and_imm	reg[3]	0xffffffffffffffff</span><br><span class="line">0x1d5	popq	reg[7]	code[0xffed]</span><br><span class="line">0x1d7	popq	reg[6]	code[0xfff5]</span><br><span class="line">0x1d9	and	reg[3]	reg[7]</span><br><span class="line">0x1dc	mov_imm	LOTAG	0x7000</span><br><span class="line">0x1df	load	reg[6]	code[LOTAG + reg[3]]</span><br><span class="line">0x1e2	write	code[LOTAG + reg[2]]	reg[6]</span><br><span class="line">0x1e5	write	code[LOTAG + reg[3]]	reg[5]</span><br><span class="line">0x1e8	inc	reg[2]</span><br><span class="line">0x1ea	cmp_imm	reg[2]	0x100</span><br><span class="line">0x1f4	jz	0x158</span><br><span class="line">0x1f7	mov_imm	reg[2]	0x0</span><br><span class="line">0x201	mov_imm	reg[3]	0x0</span><br><span class="line">0x20b	mov_imm	reg[6]	0x0</span><br><span class="line">0x215	cmp_imm	reg[1]	0x0</span><br><span class="line">0x21f	jnz	0x2b7</span><br><span class="line">0x222	inc	reg[2]</span><br><span class="line">0x224	and	reg[2]	reg[7]</span><br><span class="line">0x227	mov_imm	LOTAG	0x7000</span><br><span class="line">0x22a	load	reg[5]	code[LOTAG + reg[2]]</span><br><span class="line">0x22d	pushq	code[0xfff5]	reg[6]</span><br><span class="line">0x22f	pushq	code[0xffed]	reg[7]</span><br><span class="line">0x231	mov	reg[6]	reg[5]</span><br><span class="line">0x234	mov	reg[7]	reg[3]</span><br><span class="line">0x237	and	reg[7]	reg[6]</span><br><span class="line">0x23a	xor	reg[3]	reg[6]</span><br><span class="line">0x23d	cmp_imm	reg[7]	0x0</span><br><span class="line">0x247	jnz	0x253</span><br><span class="line">0x24a	shl	reg[7]	0x1</span><br><span class="line">0x24d	mov	reg[6]	reg[7]</span><br><span class="line">0x250	jmp	0x234</span><br><span class="line">0x253	and_imm	reg[3]	0xffffffffffffffff</span><br><span class="line">0x25d	popq	reg[7]	code[0xffed]</span><br><span class="line">0x25f	popq	reg[6]	code[0xfff5]</span><br><span class="line">0x261	and	reg[3]	reg[7]</span><br><span class="line">0x264	load	reg[0]	code[LOTAG + reg[3]]</span><br><span class="line">0x267	write	code[LOTAG + reg[2]]	reg[0]</span><br><span class="line">0x26a	write	code[LOTAG + reg[3]]	reg[5]</span><br><span class="line">0x26d	pushq	code[0xfff5]	reg[6]</span><br><span class="line">0x26f	pushq	code[0xffed]	reg[7]</span><br><span class="line">0x271	mov	reg[6]	reg[0]</span><br><span class="line">0x274	mov	reg[7]	reg[5]</span><br><span class="line">0x277	and	reg[7]	reg[6]</span><br><span class="line">0x27a	xor	reg[5]	reg[6]</span><br><span class="line">0x27d	cmp_imm	reg[7]	0x0</span><br><span class="line">0x287	jnz	0x293</span><br><span class="line">0x28a	shl	reg[7]	0x1</span><br><span class="line">0x28d	mov	reg[6]	reg[7]</span><br><span class="line">0x290	jmp	0x274</span><br><span class="line">0x293	and_imm	reg[5]	0xffffffffffffffff</span><br><span class="line">0x29d	popq	reg[7]	code[0xffed]</span><br><span class="line">0x29f	popq	reg[6]	code[0xfff5]</span><br><span class="line">0x2a1	and	reg[5]	reg[7]</span><br><span class="line">0x2a4	load	reg[4]	code[LOTAG + reg[5]]</span><br><span class="line">0x2a7	load	reg[5]	code[HITAG + reg[6]]</span><br><span class="line">0x2aa	xor	reg[5]	reg[4]</span><br><span class="line">0x2ad	write	code[HITAG + reg[6]]	reg[5]</span><br><span class="line">0x2b0	inc	reg[6]</span><br><span class="line">0x2b2	dec	reg[1]</span><br><span class="line">0x2b4	jmp	0x215</span><br><span class="line">0x2b7	retn	0x727</span><br></pre></td></tr></table></figure>

<p>后续逻辑：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">0x727	jmp	0x72a</span><br><span class="line">0x72a	mov_imm	LOTAG	0xe000</span><br><span class="line">0x72d	load	reg[0]	code[0xe008]</span><br><span class="line">0x731	mov	reg[5]	reg[0]</span><br><span class="line">0x734	xor_imm	reg[0]	0x95714c91bc8b306f</span><br><span class="line">0x73e	xor_imm	reg[0]	0x4303f92241dd9a9f</span><br><span class="line">0x748	xor_imm	reg[0]	0x311e18c91413b58c</span><br><span class="line">0x752	pushq	code[0xfff7]	reg[5]</span><br><span class="line">0x754	mov_imm	reg[5]	0x8df6073d0dbbff09</span><br><span class="line">0x75e	xor_imm	reg[5]	0xffffffffffffffff</span><br><span class="line">0x768	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x76a	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x76c	mov_imm	reg[6]	0x1</span><br><span class="line">0x776	mov	reg[7]	reg[5]</span><br><span class="line">0x779	and	reg[7]	reg[6]</span><br><span class="line">0x77c	xor	reg[5]	reg[6]</span><br><span class="line">0x77f	cmp_imm	reg[7]	0x0</span><br><span class="line">0x789	jnz	0x795</span><br><span class="line">0x795	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x797	popq	reg[6]	code[0xffef]</span><br><span class="line">0x799	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x79b	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x79d	mov	reg[6]	reg[5]</span><br><span class="line">0x7a0	mov	reg[7]	reg[0]</span><br><span class="line">0x7a3	and	reg[7]	reg[6]</span><br><span class="line">0x7a6	xor	reg[0]	reg[6]</span><br><span class="line">0x7a9	cmp_imm	reg[7]	0x0</span><br><span class="line">0x7b3	jnz	0x7bf</span><br><span class="line">0x7b6	shl	reg[7]	0x1</span><br><span class="line">0x7b9	mov	reg[6]	reg[7]</span><br><span class="line">0x7bc	jmp	0x7a0</span><br><span class="line">0x7bf	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x7c9	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x7cb	popq	reg[6]	code[0xffef]</span><br><span class="line">0x7cd	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x7d7	popq	reg[5]	code[0xfff7]</span><br><span class="line">0x7d9	pushq	code[0xfff7]	reg[5]</span><br><span class="line">0x7db	mov_imm	reg[5]	0xee5744efe81e97b7</span><br><span class="line">0x7e5	xor_imm	reg[5]	0xffffffffffffffff</span><br><span class="line">0x7ef	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x7f1	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x7f3	mov_imm	reg[6]	0x1</span><br><span class="line">0x7fd	mov	reg[7]	reg[5]</span><br><span class="line">0x800	and	reg[7]	reg[6]</span><br><span class="line">0x803	xor	reg[5]	reg[6]</span><br><span class="line">0x806	cmp_imm	reg[7]	0x0</span><br><span class="line">0x810	jnz	0x81c</span><br><span class="line">0x81c	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x81e	popq	reg[6]	code[0xffef]</span><br><span class="line">0x820	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x822	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x824	mov	reg[6]	reg[5]</span><br><span class="line">0x827	mov	reg[7]	reg[0]</span><br><span class="line">0x82a	and	reg[7]	reg[6]</span><br><span class="line">0x82d	xor	reg[0]	reg[6]</span><br><span class="line">0x830	cmp_imm	reg[7]	0x0</span><br><span class="line">0x83a	jnz	0x846</span><br><span class="line">0x83d	shl	reg[7]	0x1</span><br><span class="line">0x840	mov	reg[6]	reg[7]</span><br><span class="line">0x843	jmp	0x827</span><br><span class="line">0x846	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x850	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x852	popq	reg[6]	code[0xffef]</span><br><span class="line">0x854	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x85e	popq	reg[5]	code[0xfff7]</span><br><span class="line">0x860	pushq	code[0xfff7]	reg[6]</span><br><span class="line">0x862	pushq	code[0xffef]	reg[7]</span><br><span class="line">0x864	mov_imm	reg[6]	0xf8a82a8dbdb78c3f</span><br><span class="line">0x86e	mov	reg[7]	reg[0]</span><br><span class="line">0x871	and	reg[7]	reg[6]</span><br><span class="line">0x874	xor	reg[0]	reg[6]</span><br><span class="line">0x877	cmp_imm	reg[7]	0x0</span><br><span class="line">0x881	jnz	0x88d</span><br><span class="line">0x884	shl	reg[7]	0x1</span><br><span class="line">0x887	mov	reg[6]	reg[7]</span><br><span class="line">0x88a	jmp	0x86e</span><br><span class="line">0x88d	popq	reg[7]	code[0xffef]</span><br><span class="line">0x88f	popq	reg[6]	code[0xfff7]</span><br><span class="line">0x891	pushq	code[0xfff7]	reg[6]</span><br><span class="line">0x893	pushq	code[0xffef]	reg[7]</span><br><span class="line">0x895	mov_imm	reg[6]	0x58e8abfc7618f5fd</span><br><span class="line">0x89f	mov	reg[7]	reg[0]</span><br><span class="line">0x8a2	and	reg[7]	reg[6]</span><br><span class="line">0x8a5	xor	reg[0]	reg[6]</span><br><span class="line">0x8a8	cmp_imm	reg[7]	0x0</span><br><span class="line">0x8b2	jnz	0x8be</span><br><span class="line">0x8b5	shl	reg[7]	0x1</span><br><span class="line">0x8b8	mov	reg[6]	reg[7]</span><br><span class="line">0x8bb	jmp	0x89f</span><br><span class="line">0x8be	popq	reg[7]	code[0xffef]</span><br><span class="line">0x8c0	popq	reg[6]	code[0xfff7]</span><br><span class="line">0x8c2	xor_imm	reg[0]	0x99d88c4fa4cc68aa</span><br><span class="line">0x8cc	mov_imm	LOTAG	0x7200</span><br><span class="line">0x8cf	mov_imm	reg[1]	0x8d85b3156df9f721</span><br><span class="line">0x8d9	write	code[0x7200]	reg[1]</span><br><span class="line">0x8db	pushq	code[0xfff7]	reg[0]</span><br><span class="line">0x8dd	mov_imm	reg[0]	0x8</span><br><span class="line">0x8e7	add	LOTAG	regs[0]</span><br><span class="line">0x8e9	popq	reg[0]	code[0xfff7]</span><br><span class="line">0x8eb	mov_imm	reg[1]	0x28e3d33340bc0884</span><br><span class="line">0x8f5	write	code[0x7208]	reg[1]</span><br><span class="line">0x8f7	mov_imm	LOTAG	0x7200</span><br><span class="line">0x8fa	call	0x2be</span><br><span class="line">0x8fc	cmp_imm	reg[0]	0x659391a5dc3522b3</span><br><span class="line">0x906	jnz	0x90c</span><br><span class="line">0x909	call	0x104</span><br></pre></td></tr></table></figure>

<p>开始对inp[1]进行检查，同构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">R0 = inp[<span class="number">1</span>]</span><br><span class="line">R0 ^= <span class="number">0x95714c91bc8b306f</span></span><br><span class="line">R0 ^= <span class="number">0x4303f92241dd9a9f</span></span><br><span class="line">R0 ^= <span class="number">0x311e18c91413b58c</span></span><br><span class="line">R0 -= <span class="number">0x8df6073d0dbbff09</span></span><br><span class="line">R0 -= <span class="number">0xee5744efe81e97b7</span></span><br><span class="line">R0 += <span class="number">0xf8a82a8dbdb78c3f</span></span><br><span class="line">R0 += <span class="number">0x58e8abfc7618f5fd</span></span><br><span class="line">R0 ^= <span class="number">0x99d88c4fa4cc68aa</span></span><br><span class="line">R0 &amp;= <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">key = [<span class="number">0x8d85b3156df9f721</span>, <span class="number">0x28e3d33340bc0884</span>]</span><br><span class="line">enc = speck_dec(R0, key)</span><br></pre></td></tr></table></figure>

<p>解密得到inp[1] &#x3D; <code>0xbf11b34d0ce941cc</code>，作为下一组加密代码的RC4解密密钥，之后所有的组都符合此模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">0x90c	mov	reg[0]	reg[5]</span><br><span class="line">0x90f	mov_imm	HITAG	0x921</span><br><span class="line">0x912	mov_imm	reg[1]	0x5e60</span><br><span class="line">0x91c	call	0x116</span><br><span class="line">0x91e	jmp	0x921</span><br><span class="line">0x921	mov_imm	LOTAG	0xe000</span><br><span class="line">0x924	load	reg[0]	code[0xe0a0]</span><br><span class="line">0x928	mov	reg[5]	reg[0]</span><br><span class="line">0x92b	pushq	code[0xfff7]	reg[6]</span><br><span class="line">0x92d	pushq	code[0xffef]	reg[7]</span><br><span class="line">0x92f	mov_imm	reg[6]	0x52591d5fa111b92e</span><br><span class="line">0x939	mov	reg[7]	reg[0]</span><br><span class="line">0x93c	and	reg[7]	reg[6]</span><br><span class="line">0x93f	xor	reg[0]	reg[6]</span><br><span class="line">0x942	cmp_imm	reg[7]	0x0</span><br><span class="line">0x94c	jnz	0x958</span><br><span class="line">0x94f	shl	reg[7]	0x1</span><br><span class="line">0x952	mov	reg[6]	reg[7]</span><br><span class="line">0x955	jmp	0x939</span><br><span class="line">0x958	popq	reg[7]	code[0xffef]</span><br><span class="line">0x95a	popq	reg[6]	code[0xfff7]</span><br><span class="line">0x95c	xor_imm	reg[0]	0xc7e29a0a50ac78e3</span><br><span class="line">0x966	xor_imm	reg[0]	0xead13c41399fcfd6</span><br><span class="line">0x970	pushq	code[0xfff7]	reg[5]</span><br><span class="line">0x972	mov_imm	reg[5]	0x61553c85a2f4e8b9</span><br><span class="line">0x97c	xor_imm	reg[5]	0xffffffffffffffff</span><br><span class="line">0x986	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x988	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x98a	mov_imm	reg[6]	0x1</span><br><span class="line">0x994	mov	reg[7]	reg[5]</span><br><span class="line">0x997	and	reg[7]	reg[6]</span><br><span class="line">0x99a	xor	reg[5]	reg[6]</span><br><span class="line">0x99d	cmp_imm	reg[7]	0x0</span><br><span class="line">0x9a7	jnz	0x9b3</span><br><span class="line">0x9b3	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x9b5	popq	reg[6]	code[0xffef]</span><br><span class="line">0x9b7	pushq	code[0xffef]	reg[6]</span><br><span class="line">0x9b9	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0x9bb	mov	reg[6]	reg[5]</span><br><span class="line">0x9be	mov	reg[7]	reg[0]</span><br><span class="line">0x9c1	and	reg[7]	reg[6]</span><br><span class="line">0x9c4	xor	reg[0]	reg[6]</span><br><span class="line">0x9c7	cmp_imm	reg[7]	0x0</span><br><span class="line">0x9d1	jnz	0x9dd</span><br><span class="line">0x9d4	shl	reg[7]	0x1</span><br><span class="line">0x9d7	mov	reg[6]	reg[7]</span><br><span class="line">0x9da	jmp	0x9be</span><br><span class="line">0x9dd	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x9e7	popq	reg[7]	code[0xffe7]</span><br><span class="line">0x9e9	popq	reg[6]	code[0xffef]</span><br><span class="line">0x9eb	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0x9f5	popq	reg[5]	code[0xfff7]</span><br><span class="line">0x9f7	xor_imm	reg[0]	0x15f909ccb556ec05</span><br><span class="line">0xa01	pushq	code[0xfff7]	reg[5]</span><br><span class="line">0xa03	mov_imm	reg[5]	0x4674252dee87e8a2</span><br><span class="line">0xa0d	xor_imm	reg[5]	0xffffffffffffffff</span><br><span class="line">0xa17	pushq	code[0xffef]	reg[6]</span><br><span class="line">0xa19	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0xa1b	mov_imm	reg[6]	0x1</span><br><span class="line">0xa25	mov	reg[7]	reg[5]</span><br><span class="line">0xa28	and	reg[7]	reg[6]</span><br><span class="line">0xa2b	xor	reg[5]	reg[6]</span><br><span class="line">0xa2e	cmp_imm	reg[7]	0x0</span><br><span class="line">0xa38	jnz	0xa44</span><br><span class="line">0xa3b	shl	reg[7]	0x1</span><br><span class="line">0xa3e	mov	reg[6]	reg[7]</span><br><span class="line">0xa41	jmp	0xa25</span><br><span class="line">0xa44	popq	reg[7]	code[0xffe7]</span><br><span class="line">0xa46	popq	reg[6]	code[0xffef]</span><br><span class="line">0xa48	pushq	code[0xffef]	reg[6]</span><br><span class="line">0xa4a	pushq	code[0xffe7]	reg[7]</span><br><span class="line">0xa4c	mov	reg[6]	reg[5]</span><br><span class="line">0xa4f	mov	reg[7]	reg[0]</span><br><span class="line">0xa52	and	reg[7]	reg[6]</span><br><span class="line">0xa55	xor	reg[0]	reg[6]</span><br><span class="line">0xa58	cmp_imm	reg[7]	0x0</span><br><span class="line">0xa62	jnz	0xa6e</span><br><span class="line">0xa65	shl	reg[7]	0x1</span><br><span class="line">0xa68	mov	reg[6]	reg[7]</span><br><span class="line">0xa6b	jmp	0xa4f</span><br><span class="line">0xa6e	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0xa78	popq	reg[7]	code[0xffe7]</span><br><span class="line">0xa7a	popq	reg[6]	code[0xffef]</span><br><span class="line">0xa7c	and_imm	reg[0]	0xffffffffffffffff</span><br><span class="line">0xa86	popq	reg[5]	code[0xfff7]</span><br><span class="line">0xa88	xor_imm	reg[0]	0xe885b64f981d1baa</span><br><span class="line">0xa92	pushq	code[0xfff7]	reg[6]</span><br><span class="line">0xa94	pushq	code[0xffef]	reg[7]</span><br><span class="line">0xa96	mov_imm	reg[6]	0x94c6e3f48118560b</span><br><span class="line">0xaa0	mov	reg[7]	reg[0]</span><br><span class="line">0xaa3	and	reg[7]	reg[6]</span><br><span class="line">0xaa6	xor	reg[0]	reg[6]</span><br><span class="line">0xaa9	cmp_imm	reg[7]	0x0</span><br><span class="line">0xab3	jnz	0xabf</span><br><span class="line">0xab6	shl	reg[7]	0x1</span><br><span class="line">0xab9	mov	reg[6]	reg[7]</span><br><span class="line">0xabc	jmp	0xaa0</span><br><span class="line">0xabf	popq	reg[7]	code[0xffef]</span><br><span class="line">0xac1	popq	reg[6]	code[0xfff7]</span><br><span class="line">0xac3	mov_imm	LOTAG	0x7200</span><br><span class="line">0xac6	mov_imm	reg[1]	0x1d1a63b571be74bc</span><br><span class="line">0xad0	write	code[0x7200]	reg[1]</span><br><span class="line">0xad2	pushq	code[0xfff7]	reg[0]</span><br><span class="line">0xad4	mov_imm	reg[0]	0x8</span><br><span class="line">0xade	add	LOTAG	regs[0]</span><br><span class="line">0xae0	popq	reg[0]	code[0xfff7]</span><br><span class="line">0xae2	mov_imm	reg[1]	0x3e36eee3aac04cfd</span><br><span class="line">0xaec	write	code[0x7208]	reg[1]</span><br><span class="line">0xaee	mov_imm	LOTAG	0x7200</span><br><span class="line">0xaf1	call	0x2be</span><br><span class="line">0xaf3	cmp_imm	reg[0]	0x5538224d4c7a252a</span><br><span class="line">0xafd	jnz	0xb03</span><br><span class="line">0xb00	call	0x104</span><br></pre></td></tr></table></figure>

<p>同构下一组inp[20]：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">R0 = inp[<span class="number">20</span>]</span><br><span class="line">R0 = <span class="number">0x3a2e507999f2831f</span></span><br><span class="line">R0 += <span class="number">0x52591d5fa111b92e</span></span><br><span class="line">R0 ^= <span class="number">0xc7e29a0a50ac78e3</span></span><br><span class="line">R0 ^= <span class="number">0xead13c41399fcfd6</span></span><br><span class="line">R0 -= <span class="number">0x61553c85a2f4e8b9</span></span><br><span class="line">R0 ^= <span class="number">0x15f909ccb556ec05</span></span><br><span class="line">R0 -= <span class="number">0x4674252dee87e8a2</span></span><br><span class="line">R0 ^= <span class="number">0xe885b64f981d1baa</span></span><br><span class="line">R0 += <span class="number">0x94c6e3f48118560b</span></span><br><span class="line">R0 &amp;= <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">key = [<span class="number">0x1d1a63b571be74bc</span>, <span class="number">0x3e36eee3aac04cfd</span>]</span><br><span class="line">enc = speck_enc(R0, key)</span><br></pre></td></tr></table></figure>

<p>解得inp[20] &#x3D; <code>0xef320f9e6ae31520</code>，以此类推，注意到其加密方式除了speck之外只有3种：+、-和^，所有关键汇编分别具有特征：</p>
<table>
<thead>
<tr>
<th>运算</th>
<th>表达式举例</th>
<th>特征</th>
</tr>
</thead>
<tbody><tr>
<td>明文</td>
<td>load	reg[0]	code[0xe0e8]</td>
<td>code[0xe</td>
</tr>
<tr>
<td>+</td>
<td>mov_imm	reg[6]	0x52591d5fa111b92e</td>
<td>mov_imm reg[6] uint64</td>
</tr>
<tr>
<td>-</td>
<td>mov_imm	reg[5]	0x308442bd2f0ab265</td>
<td>mov_imm reg[5] uint64</td>
</tr>
<tr>
<td>^</td>
<td>xor_imm	reg[0]	0xd701b4a09a5bde6f</td>
<td>xor_imm reg[0] uint64</td>
</tr>
<tr>
<td>speck</td>
<td>mov_imm	reg[1]	0x54a0680a97645358</td>
<td>mov_imm reg[1] uint64</td>
</tr>
<tr>
<td>密文</td>
<td>cmp_imm	reg[0]	0x66e064f4dac280d0</td>
<td>cmp_imm reg[0] uint64</td>
</tr>
</tbody></table>
<p>因此可以提取汇编中的特征，编写脚本同构整个VM：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">import</span> re</span></span><br><span class="line"><span class="function"><span class="keyword">import</span> time</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">printhex</span><span class="params">(array)</span>:</span></span><br><span class="line"><span class="function">    for i in range(len(array)):</span></span><br><span class="line"><span class="function">        print(f<span class="string">&quot;0x&#123;array[i]:016x&#125;&quot;</span>, end=</span><span class="string">&quot;  &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">5</span> == <span class="number">4</span>: <span class="built_in">print</span>()</span><br><span class="line"></span><br><span class="line">def <span class="built_in">b2nle</span>(b, n): <span class="keyword">return</span> [<span class="type">int</span>.<span class="built_in">from_bytes</span>(b[i:i+n], byteorder=<span class="string">&#x27;little&#x27;</span>, <span class="type">signed</span>=False) <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(b), n)]</span><br><span class="line"></span><br><span class="line">def <span class="built_in">n2ble</span>(na, n):</span><br><span class="line">    b = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> a in na: b.<span class="built_in">extend</span>(a.<span class="built_in">to_bytes</span>(n, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line">def <span class="built_in">speck_enc</span>(inp, key):</span><br><span class="line">    k = [key[<span class="number">0</span>] &amp; <span class="number">0xFFFFFFFF</span>, (key[<span class="number">1</span>] &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>, key[<span class="number">1</span>] &amp; <span class="number">0xFFFFFFFF</span>, (key[<span class="number">0</span>] &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>]</span><br><span class="line">    rk = [k[<span class="number">0</span>]]</span><br><span class="line">    kl = [k[<span class="number">3</span>], k[<span class="number">2</span>], k[<span class="number">1</span>]]</span><br><span class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">26</span>):</span><br><span class="line">        l1 = (((((kl[<span class="number">0</span>] &gt;&gt; <span class="number">0x08</span>) | (kl[<span class="number">0</span>] &lt;&lt; <span class="number">0x18</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + rk[i]) ^ i) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        k1 = ((((rk[i] &lt;&lt; <span class="number">0x03</span>) | (rk[i] &gt;&gt; <span class="number">0x1D</span>)) &amp; <span class="number">0xFFFFFFFF</span>) ^ l1) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        kl.<span class="built_in">pop</span>(<span class="number">0</span>)</span><br><span class="line">        kl.<span class="built_in">append</span>(l1)</span><br><span class="line">        rk.<span class="built_in">append</span>(k1)</span><br><span class="line">    x = inp &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    y = inp &gt;&gt; <span class="number">32</span></span><br><span class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">27</span>):</span><br><span class="line">        x = (((((x &gt;&gt; <span class="number">0x08</span>) | (x &lt;&lt; <span class="number">0x18</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + y) &amp; <span class="number">0xFFFFFFFF</span>) ^ rk[i]</span><br><span class="line">        y = (((y &lt;&lt; <span class="number">0x03</span>) | (y &gt;&gt; <span class="number">0x1D</span>)) &amp; <span class="number">0xFFFFFFFF</span>) ^ x</span><br><span class="line">    <span class="keyword">return</span> y &lt;&lt; <span class="number">32</span> | x</span><br><span class="line"></span><br><span class="line">def <span class="built_in">speck_dec</span>(inp, key):</span><br><span class="line">    k = [key[<span class="number">0</span>] &amp; <span class="number">0xFFFFFFFF</span>, (key[<span class="number">1</span>] &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>, key[<span class="number">1</span>] &amp; <span class="number">0xFFFFFFFF</span>, (key[<span class="number">0</span>] &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span>]</span><br><span class="line">    rk = [k[<span class="number">0</span>]]</span><br><span class="line">    kl = [k[<span class="number">3</span>], k[<span class="number">2</span>], k[<span class="number">1</span>]]</span><br><span class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">26</span>):</span><br><span class="line">        l1 = (((((kl[<span class="number">0</span>] &gt;&gt; <span class="number">0x08</span>) | (kl[<span class="number">0</span>] &lt;&lt; <span class="number">0x18</span>)) &amp; <span class="number">0xFFFFFFFF</span>) + rk[i]) ^ i) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        k1 = ((((rk[i] &lt;&lt; <span class="number">0x03</span>) | (rk[i] &gt;&gt; <span class="number">0x1D</span>)) &amp; <span class="number">0xFFFFFFFF</span>) ^ l1) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        kl.<span class="built_in">pop</span>(<span class="number">0</span>)</span><br><span class="line">        kl.<span class="built_in">append</span>(l1)</span><br><span class="line">        rk.<span class="built_in">append</span>(k1)</span><br><span class="line">    x = inp &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    y = inp &gt;&gt; <span class="number">32</span></span><br><span class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="number">26</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">        y = (((y^x) &gt;&gt; <span class="number">0x03</span>) | ((y^x) &lt;&lt; <span class="number">0x1D</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        x = (((((x^rk[i]) - y) &amp; <span class="number">0xFFFFFFFF</span>) &lt;&lt; <span class="number">0x08</span>) | ((((x^rk[i]) - y) &amp; <span class="number">0xFFFFFFFF</span>) &gt;&gt; <span class="number">0x18</span>)) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> y &lt;&lt; <span class="number">32</span> | x</span><br><span class="line"></span><br><span class="line">def <span class="built_in">solve</span>(inst):</span><br><span class="line">    enc = inst[<span class="number">-1</span>][<span class="number">1</span>] # 密文</span><br><span class="line">    key = [inst[<span class="number">-3</span>][<span class="number">1</span>], inst[<span class="number">-2</span>][<span class="number">1</span>]] # C7200和C7208</span><br><span class="line">    dec = <span class="built_in">speck_dec</span>(enc, key) # 解密speck</span><br><span class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="built_in">len</span>(inst)<span class="number">-4</span>,<span class="number">0</span>,<span class="number">-1</span>): # 解密线性运算</span><br><span class="line">        <span class="keyword">if</span> inst[i][<span class="number">0</span>] == <span class="string">&quot;+&quot;</span>: dec = (dec - inst[i][<span class="number">1</span>]) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">        <span class="keyword">if</span> inst[i][<span class="number">0</span>] == <span class="string">&quot;-&quot;</span>: dec = (dec + inst[i][<span class="number">1</span>]) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">        <span class="keyword">if</span> inst[i][<span class="number">0</span>] == <span class="string">&quot;^&quot;</span>: dec = dec ^ inst[i][<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> dec</span><br><span class="line"></span><br><span class="line">def <span class="built_in">parse</span>(insts):</span><br><span class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="built_in">len</span>(insts)): # <span class="number">50</span>个单句</span><br><span class="line">        inst = insts[i]</span><br><span class="line">        enc = inst[<span class="number">-1</span>][<span class="number">1</span>] # 密文</span><br><span class="line">        key = [inst[<span class="number">-3</span>][<span class="number">1</span>], inst[<span class="number">-2</span>][<span class="number">1</span>]] # C7200和C7208</span><br><span class="line">        idx = inst[<span class="number">0</span>] # 索引</span><br><span class="line">        <span class="keyword">for</span> j in <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(inst)<span class="number">-3</span>):</span><br><span class="line">            <span class="keyword">if</span> inst[j][<span class="number">0</span>] == <span class="string">&quot;+&quot;</span>: <span class="built_in">print</span>(f<span class="string">&quot;inps[&#123;idx&#125;] += &#123;hex(inst[j][1])&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> inst[j][<span class="number">0</span>] == <span class="string">&quot;-&quot;</span>: <span class="built_in">print</span>(f<span class="string">&quot;inps[&#123;idx&#125;] -= &#123;hex(inst[j][1])&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> inst[j][<span class="number">0</span>] == <span class="string">&quot;^&quot;</span>: <span class="built_in">print</span>(f<span class="string">&quot;inps[&#123;idx&#125;] ^= &#123;hex(inst[j][1])&#125;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(f<span class="string">&quot;speck_enc(inps[&#123;idx&#125;], key = [&#123;hex(inst[-3][1])&#125;, &#123;hex(inst[-2][1])&#125;])&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(f<span class="string">&quot;assert inps[&#123;idx&#125;] == &#123;hex(enc)&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">extr</span>(l):</span><br><span class="line">    fl = [it <span class="keyword">for</span> it in l <span class="keyword">if</span> it is <span class="keyword">not</span> None]</span><br><span class="line">    idx = <span class="number">-1</span></span><br><span class="line">    c = None</span><br><span class="line">    <span class="keyword">for</span> i, ln in <span class="built_in">enumerate</span>(fl):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;code[0xe&quot;</span> in ln:</span><br><span class="line">            mt = re.<span class="built_in">search</span>(r<span class="string">&#x27;code\\[(0x[0-9a-fA-F]+)\\]&#x27;</span>, ln)</span><br><span class="line">            <span class="keyword">if</span> mt:</span><br><span class="line">                hs = mt.<span class="built_in">group</span>(<span class="number">1</span>)</span><br><span class="line">                c = (<span class="built_in">int</span>(hs, <span class="number">16</span>) - <span class="number">0xE000</span>) <span class="comment">// 8</span></span><br><span class="line">                idx = i</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">-1</span>: raise <span class="built_in">ValueError</span>(<span class="string">&quot;Base addr not found.&quot;</span>)</span><br><span class="line">    res = [c]</span><br><span class="line">    <span class="keyword">for</span> i in <span class="built_in">range</span>(idx + <span class="number">1</span>, <span class="built_in">len</span>(fl)):</span><br><span class="line">        ln = fl[i]</span><br><span class="line">        arg = re.<span class="built_in">search</span>(r<span class="string">&#x27;0x[0-9a-fA-F]&#123;9,&#125;&#x27;</span>, ln)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> arg: <span class="keyword">continue</span></span><br><span class="line">        hv = <span class="built_in">int</span>(arg.<span class="built_in">group</span>(), <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;mov_imm\\treg[6]&quot;</span> in ln: res.<span class="built_in">append</span>([<span class="string">&quot;+&quot;</span>, hv])</span><br><span class="line">        elif <span class="string">&quot;mov_imm\\treg[5]&quot;</span> in ln: res.<span class="built_in">append</span>([<span class="string">&quot;-&quot;</span>, hv])</span><br><span class="line">        elif <span class="string">&quot;xor_imm\\treg[0]&quot;</span> in ln: res.<span class="built_in">append</span>([<span class="string">&quot;^&quot;</span>, hv])</span><br><span class="line">        elif <span class="string">&quot;mov_imm\\treg[1]&quot;</span> in ln: res.<span class="built_in">append</span>([<span class="string">&quot;k&quot;</span>, hv])</span><br><span class="line">        elif <span class="string">&quot;cmp_imm\\treg[0]&quot;</span> in ln: res.<span class="built_in">append</span>([<span class="string">&quot;c&quot;</span>, hv])</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">def <span class="built_in">extr_all</span>(l):</span><br><span class="line">    fl = [it <span class="keyword">for</span> it in l <span class="keyword">if</span> it is <span class="keyword">not</span> None]</span><br><span class="line">    idx = []</span><br><span class="line">    <span class="keyword">for</span> i, ln in <span class="built_in">enumerate</span>(fl):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;code[0xe&quot;</span> in ln: idx.<span class="built_in">append</span>(i)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> idx: raise <span class="built_in">ValueError</span>(<span class="string">&quot;No base addr found.&quot;</span>)</span><br><span class="line">    res = []</span><br><span class="line">    <span class="keyword">for</span> ci in idx:</span><br><span class="line">        ln = fl[ci]</span><br><span class="line">        mt = re.<span class="built_in">search</span>(r<span class="string">&#x27;code\\[(0x[0-9a-fA-F]+)\\]&#x27;</span>, ln)</span><br><span class="line">        <span class="keyword">if</span> mt:</span><br><span class="line">            hs = mt.<span class="built_in">group</span>(<span class="number">1</span>)</span><br><span class="line">            c = (<span class="built_in">int</span>(hs, <span class="number">16</span>) - <span class="number">0xE000</span>) <span class="comment">// 8</span></span><br><span class="line">            sg = [c]</span><br><span class="line">            ei = <span class="built_in">len</span>(fl)</span><br><span class="line">            <span class="keyword">if</span> idx.<span class="built_in">index</span>(ci) + <span class="number">1</span> &lt; <span class="built_in">len</span>(idx):</span><br><span class="line">                ei = idx[idx.<span class="built_in">index</span>(ci) + <span class="number">1</span>]</span><br><span class="line">            <span class="keyword">for</span> i in <span class="built_in">range</span>(ci + <span class="number">1</span>, ei):</span><br><span class="line">                ln = fl[i]</span><br><span class="line">                arg = re.<span class="built_in">search</span>(r<span class="string">&#x27;0x[0-9a-fA-F]&#123;9,&#125;&#x27;</span>, ln)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> arg: <span class="keyword">continue</span></span><br><span class="line">                hv = <span class="built_in">int</span>(arg.<span class="built_in">group</span>(), <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;mov_imm\\treg[6]&quot;</span> in ln: sg.<span class="built_in">append</span>([<span class="string">&quot;+&quot;</span>, hv])</span><br><span class="line">                elif <span class="string">&quot;mov_imm\\treg[5]&quot;</span> in ln: sg.<span class="built_in">append</span>([<span class="string">&quot;-&quot;</span>, hv])</span><br><span class="line">                elif <span class="string">&quot;xor_imm\\treg[0]&quot;</span> in ln: sg.<span class="built_in">append</span>([<span class="string">&quot;^&quot;</span>, hv])</span><br><span class="line">                elif <span class="string">&quot;mov_imm\\treg[1]&quot;</span> in ln: sg.<span class="built_in">append</span>([<span class="string">&quot;k&quot;</span>, hv])</span><br><span class="line">                elif <span class="string">&quot;cmp_imm\\treg[0]&quot;</span> in ln: sg.<span class="built_in">append</span>([<span class="string">&quot;c&quot;</span>, hv])</span><br><span class="line">            res.<span class="built_in">append</span>(sg)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">def <span class="built_in">trace_vm</span>(inp, limit):</span><br><span class="line">    with <span class="built_in">open</span>(<span class="string">&quot;full_vmcode&quot;</span>, <span class="string">&#x27;rb&#x27;</span>) as file: code = file.<span class="built_in">read</span>(<span class="number">26497</span>)</span><br><span class="line">    code = <span class="built_in">bytearray</span>(code) + <span class="built_in">bytearray</span>(<span class="number">0xE000</span> - <span class="built_in">len</span>(code))</span><br><span class="line">    binp = <span class="built_in">n2ble</span>(inp, <span class="number">8</span>)</span><br><span class="line">    code += binp</span><br><span class="line">    code = <span class="built_in">bytearray</span>(code) + <span class="built_in">bytearray</span>(<span class="number">0x10000</span> - <span class="built_in">len</span>(code))</span><br><span class="line">    PC = <span class="number">0</span></span><br><span class="line">    HIPC = <span class="number">0xFFFF</span></span><br><span class="line">    LOTAG = <span class="number">0</span></span><br><span class="line">    HITAG = <span class="number">0</span></span><br><span class="line">    STAKPC = <span class="number">0</span></span><br><span class="line">    ZFLAG = False</span><br><span class="line">    ENDFLAG = <span class="number">1</span></span><br><span class="line">    regs = [<span class="number">0</span>] * <span class="number">8</span></span><br><span class="line">    mem = [<span class="number">0</span>] * <span class="number">256</span></span><br><span class="line">    stdout = <span class="string">&quot;&quot;</span></span><br><span class="line">    tracelen = <span class="number">0</span></span><br><span class="line">    DEBUG, NOISY, ASM = True, False, False # 输出trace流</span><br><span class="line">    FORCEJMP = False</span><br><span class="line">    PASSED = [<span class="number">0</span>] * <span class="built_in">len</span>(code)</span><br><span class="line">    ASMS = [None] * <span class="built_in">len</span>(code)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;traceid\\taddr\\topcode\\tname\\targs and ress&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        <span class="keyword">if</span> PC &gt; limit: DEBUG, ASM = True, False # 限制trace输出范围</span><br><span class="line">        <span class="keyword">else</span>: DEBUG, ASM = False, False</span><br><span class="line">        PC_1 = PC</span><br><span class="line">        op = code[PC]</span><br><span class="line">        <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> ASM: <span class="built_in">print</span>(f<span class="string">&quot;&#123;tracelen&#125;\\t&#123;hex(PC)&#125;\\t&#123;hex(op)&#125;&quot;</span>,end=<span class="string">&quot;\\t&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> op == <span class="number">0x01</span>:</span><br><span class="line">            PC = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;jmp\\t&#123;hex(PC)&#125;&quot;</span>)</span><br><span class="line">        elif op == <span class="number">0x02</span>:</span><br><span class="line">            <span class="keyword">if</span> ZFLAG == False <span class="keyword">or</span> FORCEJMP == True: </span><br><span class="line">                PC = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;jz\\t&#123;hex(PC)&#125; =&gt; JUMPED&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;jz\\t&#123;hex(b2nle(code[PC+1:PC+3], 2)[0])&#125; =&gt; NOT JUMP&quot;</span>)</span><br><span class="line">                PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x03</span>:</span><br><span class="line">            <span class="keyword">if</span> ZFLAG == True <span class="keyword">or</span> FORCEJMP == True: </span><br><span class="line">                PC = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;jnz\\t&#123;hex(PC)&#125; =&gt; JUMPED&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;jnz\\t&#123;hex(b2nle(code[PC+1:PC+3], 2)[0])&#125; =&gt; NOT JUMP&quot;</span>)</span><br><span class="line">                PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x11</span>:</span><br><span class="line">            LOTAG = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;mov_imm\\tLOTAG\\t&#123;hex(LOTAG)&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x12</span>:</span><br><span class="line">            HITAG = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;mov_imm\\tHITAG\\t&#123;hex(HITAG)&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x15</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            regs[regid] = <span class="built_in">b2nle</span>(code[LOTAG:LOTAG<span class="number">+8</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;load\\tcode[&#123;hex(LOTAG)&#125;]\\treg[&#123;regid&#125;] = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x16</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM = <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+10</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            regs[regid] = IMM</span><br><span class="line">            ZFLAG = regs[REG_B] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;mov_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;mov_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">10</span></span><br><span class="line">        elif op == <span class="number">0x17</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[REG_A] = regs[REG_B]</span><br><span class="line">            ZFLAG = regs[REG_A] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;mov\\treg[&#123;REG_A&#125;]\\treg[&#123;REG_B&#125;] = &#123;hex(regs[REG_A])&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;mov\\treg[&#123;REG_A&#125;]\\treg[&#123;REG_B&#125;] = &#123;hex(regs[REG_A])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x18</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            addr = LOTAG + <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+4</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            regs[regid] = <span class="built_in">b2nle</span>(code[addr:addr<span class="number">+8</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;load\\treg[&#123;regid&#125;]\\tcode[&#123;hex(addr)&#125;] = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">4</span></span><br><span class="line">        elif op == <span class="number">0x19</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            code[LOTAG:LOTAG<span class="number">+8</span>] = <span class="built_in">n2ble</span>([regs[regid]], <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;write\\tcode[&#123;hex(LOTAG)&#125;]\\treg[&#123;regid&#125;] = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x1A</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            addr = LOTAG + regs[REG_B]</span><br><span class="line">            regs[REG_A] = code[addr]</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;load\\treg[&#123;REG_A&#125;]\\tcode[&#123;hex(addr)&#125;] = &#123;hex(regs[REG_A])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x1B</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            addr = LOTAG + regs[REG_B]</span><br><span class="line">            code[addr] = regs[REG_A] &amp; <span class="number">0xFF</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;write\\tcode[&#123;hex(addr)&#125;]\\treg[&#123;REG_A&#125;] = &#123;hex(regs[REG_A])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x1C</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            regs[regid] += <span class="number">1</span></span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;inc\\treg[&#123;regid&#125;]\\tres = &#123;hex(regs[regid])&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;inc\\treg[&#123;regid&#125;]\\tres = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x1D</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            regs[regid] -= <span class="number">1</span></span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;dec\\treg[&#123;regid&#125;]\\tres = &#123;hex(regs[regid])&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;dec\\treg[&#123;regid&#125;]\\tres = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x1E</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM8 = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[regid] = regs[regid] &gt;&gt; IMM8</span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;shr\\treg[&#123;regid&#125;]\\t&#123;hex(IMM8)&#125;\\tres = &#123;hex(regs[regid])&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;shr\\treg[&#123;regid&#125;]\\t&#123;hex(IMM8)&#125;\\tres = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x1f</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            LOTAG += regs[regid] &amp; <span class="number">0xFFFF</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;add\\tLOTAG\\tregs[&#123;regid&#125;]\\tres = &#123;hex(LOTAG)&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x25</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[REG_A] &amp;= regs[REG_B]</span><br><span class="line">            ZFLAG = regs[REG_A] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;and\\treg[&#123;REG_A&#125;]\\treg[&#123;REG_B&#125;]\\tres = &#123;hex(regs[REG_A])&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;and\\treg[&#123;REG_A&#125;]\\treg[&#123;REG_B&#125;]\\tres = &#123;hex(regs[REG_A])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x26</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[REG_A] ^= regs[REG_B]</span><br><span class="line">            ZFLAG = regs[REG_A] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;xor\\treg[&#123;REG_A&#125;]\\treg[&#123;REG_B&#125;]\\tres = &#123;hex(regs[REG_A])&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;xor\\treg[&#123;REG_A&#125;]\\treg[&#123;REG_B&#125;]\\tres = &#123;hex(regs[REG_A])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x27</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM8 = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[regid] = (regs[regid] &lt;&lt; IMM8) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;shl\\treg[&#123;regid&#125;]\\t&#123;hex(IMM8)&#125;\\tres = &#123;hex(regs[regid])&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;shl\\treg[&#123;regid&#125;]\\t&#123;hex(IMM8)&#125;\\tres = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x29</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM = <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+10</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            regs[regid] ^= IMM</span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;xor_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;\\tres = &#123;hex(regs[regid])&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;xor_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;\\tres = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">10</span></span><br><span class="line">        elif op == <span class="number">0x2A</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM = <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+10</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            regs[regid] &amp;= IMM</span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;and_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;\\tres = &#123;hex(regs[regid])&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;and_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;\\tres = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">10</span></span><br><span class="line">        elif op == <span class="number">0x2B</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            addr = HITAG + regs[REG_B]</span><br><span class="line">            regs[REG_A] = code[addr]</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;load\\treg[&#123;REG_A&#125;]\\tcode[&#123;hex(addr)&#125;] = &#123;hex(regs[REG_A])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x2C</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            addr = HITAG + regs[REG_B]</span><br><span class="line">            code[addr] = regs[REG_A] &amp; <span class="number">0xFF</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;write\\tcode[&#123;hex(addr)&#125;]\\treg[&#123;REG_A&#125;] = &#123;hex(regs[REG_A])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x32</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM = <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+10</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            ZFLAG = regs[regid] == IMM</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;cmp_imm\\treg[&#123;regid&#125;] = &#123;hex(regs[regid])&#125;\\t&#123;hex(IMM)&#125;\\tZFLAG = &#123;ZFLAG&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG <span class="keyword">and</span> <span class="keyword">not</span> NOISY: <span class="built_in">print</span>(f<span class="string">&quot;cmp_imm\\treg[&#123;regid&#125;] = &#123;hex(regs[regid])&#125;\\t&#123;hex(IMM)&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">10</span></span><br><span class="line">        elif op == <span class="number">0x80</span>:</span><br><span class="line">            STAKPC = PC + <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;svstk\\t&#123;hex(STAKPC)&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">1</span></span><br><span class="line">        elif op == <span class="number">0x81</span>:</span><br><span class="line">            mem[code[PC<span class="number">+1</span>]] = STAKPC + <span class="number">3</span></span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;push\\tmem[&#123;hex(code[PC+1])&#125;]\\t&#123;hex(STAKPC+3)&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x82</span>:</span><br><span class="line">            addr = mem[code[PC<span class="number">+1</span>]]</span><br><span class="line">            RETADDR = PC + <span class="number">2</span></span><br><span class="line">            HIPC -= <span class="number">2</span></span><br><span class="line">            code[HIPC:HIPC<span class="number">+2</span>] = <span class="built_in">n2ble</span>([RETADDR], <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;call\\tmem[&#123;hex(code[PC+1])&#125;] = &#123;hex(addr)&#125;\\tretaddr = &#123;hex(RETADDR)&#125;&quot;</span>)</span><br><span class="line">            PC = addr</span><br><span class="line">        elif op == <span class="number">0x83</span>:</span><br><span class="line">            addr = <span class="built_in">b2nle</span>(code[HIPC:HIPC<span class="number">+2</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;retn\\t&#123;hex(addr)&#125;&quot;</span>)</span><br><span class="line">            HIPC += <span class="number">2</span></span><br><span class="line">            PC = addr</span><br><span class="line">        elif op == <span class="number">0x84</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            HIPC -= <span class="number">8</span></span><br><span class="line">            code[HIPC:HIPC<span class="number">+8</span>] = <span class="built_in">n2ble</span>([regs[regid]], <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;pushq\\tcode[&#123;hex(HIPC &amp; 0xFFFF)&#125;]\\treg[&#123;regid&#125;] = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x85</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            regs[regid] = <span class="built_in">b2nle</span>(code[HIPC:HIPC<span class="number">+8</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;popq\\treg[&#123;regid&#125;]\\tcode[&#123;hex(HIPC &amp; 0xFFFF)&#125;] = &#123;hex(regs[regid])&#125;&quot;</span>)</span><br><span class="line">            HIPC += <span class="number">8</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x90</span>:</span><br><span class="line">            addr = code[PC<span class="number">+1</span>]</span><br><span class="line">            stdout += <span class="built_in">chr</span>(addr)</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(<span class="string">&quot;stdout&quot;</span>)</span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0xFF</span>:</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(<span class="string">&quot;exit&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;Unknown OP &#123;hex(op)&#125; at &#123;hex(PC)&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        tracelen += <span class="number">1</span></span><br><span class="line">        PASSED.<span class="built_in">append</span>(PC_1)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> NOISY: <span class="built_in">print</span>(HITAG, LOTAG, HIPC, PC)</span><br><span class="line">    <span class="keyword">if</span> NOISY: <span class="built_in">print</span>(regs)</span><br><span class="line">    <span class="keyword">if</span> NOISY: <span class="built_in">print</span>(<span class="built_in">b2nle</span>(code[<span class="number">0x7200</span>:<span class="number">0x7200</span><span class="number">+8</span>*<span class="number">5</span>], <span class="number">8</span>))</span><br><span class="line">    <span class="keyword">if</span> NOISY: <span class="built_in">print</span>(<span class="built_in">b2nle</span>(code[<span class="number">0xFFF7</span><span class="number">-8</span>*<span class="number">0x20</span>:<span class="number">0xFFFF</span>], <span class="number">8</span>))</span><br><span class="line">    <span class="keyword">if</span> NOISY: <span class="built_in">print</span>(code[<span class="number">0x7000</span>:<span class="number">0x7100</span>].<span class="built_in">hex</span>())</span><br><span class="line">    <span class="built_in">print</span>(tracelen)</span><br><span class="line">    <span class="built_in">print</span>(stdout)</span><br><span class="line"></span><br><span class="line">def <span class="built_in">run_vm</span>(inp, limit, <span class="keyword">auto</span> = False):</span><br><span class="line">    with <span class="built_in">open</span>(<span class="string">&quot;full_vmcode&quot;</span>, <span class="string">&#x27;rb&#x27;</span>) as file: code = file.<span class="built_in">read</span>(<span class="number">26497</span>)</span><br><span class="line">    code = <span class="built_in">bytearray</span>(code) + <span class="built_in">bytearray</span>(<span class="number">0xE000</span> - <span class="built_in">len</span>(code))</span><br><span class="line">    binp = <span class="built_in">n2ble</span>(inp, <span class="number">8</span>)</span><br><span class="line">    code += binp</span><br><span class="line">    code = <span class="built_in">bytearray</span>(code) + <span class="built_in">bytearray</span>(<span class="number">0x10000</span> - <span class="built_in">len</span>(code))</span><br><span class="line">    PC = <span class="number">0</span></span><br><span class="line">    HIPC = <span class="number">0xFFFF</span></span><br><span class="line">    LOTAG = <span class="number">0</span></span><br><span class="line">    HITAG = <span class="number">0</span></span><br><span class="line">    STAKPC = <span class="number">0</span></span><br><span class="line">    ZFLAG = False</span><br><span class="line">    ENDFLAG = <span class="number">1</span></span><br><span class="line">    regs = [<span class="number">0</span>] * <span class="number">8</span></span><br><span class="line">    mem = [<span class="number">0</span>] * <span class="number">256</span></span><br><span class="line">    stdout = <span class="string">&quot;&quot;</span></span><br><span class="line">    tracelen = <span class="number">0</span></span><br><span class="line">    DEBUG, NOISY, ASM = False, False, True  # 输出反汇编</span><br><span class="line">    FORCEJMP = False</span><br><span class="line">    PASSED = [<span class="number">0</span>] * <span class="built_in">len</span>(code)</span><br><span class="line">    ASMS = [None] * <span class="built_in">len</span>(code)</span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        <span class="keyword">if</span> PC &gt; limit: DEBUG, ASM = False, True # 限制汇编输出范围</span><br><span class="line">        <span class="keyword">else</span>: DEBUG, ASM = False, False</span><br><span class="line">        PC_1 = PC</span><br><span class="line">        op = code[PC]</span><br><span class="line">        <span class="keyword">if</span> op == <span class="number">0x01</span>:</span><br><span class="line">            PC = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;jmp\\t&#123;hex(PC)&#125;&quot;</span></span><br><span class="line">        elif op == <span class="number">0x02</span>:</span><br><span class="line">            <span class="keyword">if</span> ZFLAG == False <span class="keyword">or</span> FORCEJMP == True: </span><br><span class="line">                PC = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;jz\\t&#123;hex(PC)&#125;&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;jz\\t&#123;hex(b2nle(code[PC+1:PC+3], 2)[0])&#125;&quot;</span></span><br><span class="line">                PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x03</span>:</span><br><span class="line">            <span class="keyword">if</span> ZFLAG == True <span class="keyword">or</span> FORCEJMP == True: </span><br><span class="line">                PC = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;jnz\\t&#123;hex(PC)&#125;&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;jnz\\t&#123;hex(b2nle(code[PC+1:PC+3], 2)[0])&#125;&quot;</span></span><br><span class="line">                PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x11</span>:</span><br><span class="line">            LOTAG = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;mov_imm\\tLOTAG\\t&#123;hex(LOTAG)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x12</span>:</span><br><span class="line">            HITAG = <span class="built_in">b2nle</span>(code[PC<span class="number">+1</span>:PC<span class="number">+3</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;mov_imm\\tHITAG\\t&#123;hex(HITAG)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x15</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            regs[regid] = <span class="built_in">b2nle</span>(code[LOTAG:LOTAG<span class="number">+8</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;load\\tcode[&#123;hex(LOTAG)&#125;]\\treg[&#123;regid&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x16</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM = <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+10</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            regs[regid] = IMM</span><br><span class="line">            ZFLAG = regs[REG_B] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;mov_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">10</span></span><br><span class="line">        elif op == <span class="number">0x17</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[REG_A] = regs[REG_B]</span><br><span class="line">            ZFLAG = regs[REG_A] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;mov\\treg[&#123;REG_A&#125;]\\treg[&#123;REG_B&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x18</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            addr = LOTAG + <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+4</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            regs[regid] = <span class="built_in">b2nle</span>(code[addr:addr<span class="number">+8</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;load\\treg[&#123;regid&#125;]\\tcode[&#123;hex(addr)&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">4</span></span><br><span class="line">        elif op == <span class="number">0x19</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            code[LOTAG:LOTAG<span class="number">+8</span>] = <span class="built_in">n2ble</span>([regs[regid]], <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;write\\tcode[&#123;hex(LOTAG)&#125;]\\treg[&#123;regid&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x1A</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            addr = LOTAG + regs[REG_B]</span><br><span class="line">            regs[REG_A] = code[addr]</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;load\\treg[&#123;REG_A&#125;]\\tcode[LOTAG + reg[&#123;REG_B&#125;]]&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x1B</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            addr = LOTAG + regs[REG_B]</span><br><span class="line">            code[addr] = regs[REG_A] &amp; <span class="number">0xFF</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;write\\tcode[LOTAG + reg[&#123;REG_B&#125;]]\\treg[&#123;REG_A&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x1C</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            regs[regid] += <span class="number">1</span></span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;inc\\treg[&#123;regid&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x1D</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            regs[regid] -= <span class="number">1</span></span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;dec\\treg[&#123;regid&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x1E</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM8 = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[regid] = regs[regid] &gt;&gt; IMM8</span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;shr\\treg[&#123;regid&#125;]\\t&#123;hex(IMM8)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x1f</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            LOTAG += regs[regid] &amp; <span class="number">0xFFFF</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;add\\tLOTAG\\tregs[&#123;regid&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x25</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[REG_A] &amp;= regs[REG_B]</span><br><span class="line">            ZFLAG = regs[REG_A] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;and\\treg[&#123;REG_A&#125;]\\treg[&#123;REG_B&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x26</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[REG_A] ^= regs[REG_B]</span><br><span class="line">            ZFLAG = regs[REG_A] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;xor\\treg[&#123;REG_A&#125;]\\treg[&#123;REG_B&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x27</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM8 = code[PC<span class="number">+2</span>]</span><br><span class="line">            regs[regid] = (regs[regid] &lt;&lt; IMM8) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;shl\\treg[&#123;regid&#125;]\\t&#123;hex(IMM8)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x29</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM = <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+10</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            regs[regid] ^= IMM</span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;xor_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">10</span></span><br><span class="line">        elif op == <span class="number">0x2A</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM = <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+10</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            regs[regid] &amp;= IMM</span><br><span class="line">            ZFLAG = regs[regid] == <span class="number">0</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;and_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">10</span></span><br><span class="line">        elif op == <span class="number">0x2B</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            addr = HITAG + regs[REG_B]</span><br><span class="line">            regs[REG_A] = code[addr]</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;load\\treg[&#123;REG_A&#125;]\\tcode[HITAG + reg[&#123;REG_B&#125;]]&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x2C</span>:</span><br><span class="line">            REG_A = code[PC<span class="number">+1</span>]</span><br><span class="line">            REG_B = code[PC<span class="number">+2</span>]</span><br><span class="line">            addr = HITAG + regs[REG_B]</span><br><span class="line">            code[addr] = regs[REG_A] &amp; <span class="number">0xFF</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;write\\tcode[HITAG + reg[&#123;REG_B&#125;]]\\treg[&#123;REG_A&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">3</span></span><br><span class="line">        elif op == <span class="number">0x32</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            IMM = <span class="built_in">b2nle</span>(code[PC<span class="number">+2</span>:PC<span class="number">+10</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            ZFLAG = regs[regid] == IMM</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;cmp_imm\\treg[&#123;regid&#125;]\\t&#123;hex(IMM)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">10</span></span><br><span class="line">        elif op == <span class="number">0x80</span>:</span><br><span class="line">            STAKPC = PC + <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;svstk\\t&#123;hex(STAKPC)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">1</span></span><br><span class="line">        elif op == <span class="number">0x81</span>:</span><br><span class="line">            mem[code[PC<span class="number">+1</span>]] = STAKPC + <span class="number">3</span></span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;push\\tmem[&#123;hex(code[PC+1])&#125;]\\t&#123;hex(STAKPC+3)&#125;&quot;</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x82</span>:</span><br><span class="line">            addr = mem[code[PC<span class="number">+1</span>]]</span><br><span class="line">            RETADDR = PC + <span class="number">2</span></span><br><span class="line">            HIPC -= <span class="number">2</span></span><br><span class="line">            code[HIPC:HIPC<span class="number">+2</span>] = <span class="built_in">n2ble</span>([RETADDR], <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;call\\t&#123;hex(addr)&#125;&quot;</span></span><br><span class="line">            PC = addr</span><br><span class="line">        elif op == <span class="number">0x83</span>:</span><br><span class="line">            addr = <span class="built_in">b2nle</span>(code[HIPC:HIPC<span class="number">+2</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;retn\\t&#123;hex(addr)&#125;&quot;</span></span><br><span class="line">            HIPC += <span class="number">2</span></span><br><span class="line">            PC = addr</span><br><span class="line">        elif op == <span class="number">0x84</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            HIPC -= <span class="number">8</span></span><br><span class="line">            code[HIPC:HIPC<span class="number">+8</span>] = <span class="built_in">n2ble</span>([regs[regid]], <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;pushq\\tcode[&#123;hex(HIPC &amp; 0xFFFF)&#125;]\\treg[&#123;regid&#125;]&quot;</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x85</span>:</span><br><span class="line">            regid = code[PC<span class="number">+1</span>]</span><br><span class="line">            regs[regid] = <span class="built_in">b2nle</span>(code[HIPC:HIPC<span class="number">+8</span>], <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;popq\\treg[&#123;regid&#125;]\\tcode[&#123;hex(HIPC &amp; 0xFFFF)&#125;]&quot;</span></span><br><span class="line">            HIPC += <span class="number">8</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0x90</span>:</span><br><span class="line">            addr = code[PC<span class="number">+1</span>]</span><br><span class="line">            stdout += <span class="built_in">chr</span>(addr)</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;stdout&quot;</span></span><br><span class="line">            PC += <span class="number">2</span></span><br><span class="line">        elif op == <span class="number">0xFF</span>:</span><br><span class="line">            <span class="keyword">if</span> ASM <span class="keyword">and</span> PASSED[PC_1] == <span class="number">0</span>: PASSED[PC_1] = <span class="number">1</span>; ASMS[PC_1] = f<span class="string">&quot;exit&quot;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> DEBUG: <span class="built_in">print</span>(f<span class="string">&quot;Unknown OP &#123;hex(op)&#125; at &#123;hex(PC)&#125;&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        tracelen += <span class="number">1</span></span><br><span class="line">        PASSED.<span class="built_in">append</span>(PC_1)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">auto</span>:</span><br><span class="line">        <span class="keyword">for</span> i in <span class="built_in">range</span>(<span class="built_in">len</span>(ASMS)):</span><br><span class="line">            <span class="keyword">if</span> ASMS[i] is <span class="keyword">not</span> None: <span class="built_in">print</span>(f<span class="string">&quot;&#123;hex(i)&#125;\\t&#123;ASMS[i]&#125;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> ASMS, code, HIPC, stdout</span><br><span class="line"></span><br><span class="line">limit = <span class="number">0x5A4</span></span><br><span class="line">inps = [<span class="number">0xba610b6c5d80c91a</span>, <span class="number">0xbf11b34d0ce941cc</span>, <span class="number">0xa28f38bd0463522c</span>, <span class="number">0x79ed5d84199dd9cb</span>, <span class="number">0x4d9c56b2a1d77a0d</span>, </span><br><span class="line">        <span class="number">0xfe13c54ceb12fea8</span>, <span class="number">0x494a63fc85b9953a</span>, <span class="number">0xad1f6be84bbb4680</span>, <span class="number">0xcd05f91609d653fa</span>, <span class="number">0x55493aa141fbe86f</span>, </span><br><span class="line">        <span class="number">0x25bc9aff736b80a8</span>, <span class="number">0xd8817dda43824d2c</span>, <span class="number">0x5fcca9a9cb65130d</span>, <span class="number">0x6f3ed35da24dacfa</span>, <span class="number">0xb5e1534e1dc36c87</span>, </span><br><span class="line">        <span class="number">0xac1b4e2750778a01</span>, <span class="number">0xc8f82d07316dcd3b</span>, <span class="number">0x36646367b78c2f91</span>, <span class="number">0x9eed7637cd5eaa26</span>, <span class="number">0xff546a0085041459</span>, </span><br><span class="line">        <span class="number">0xef320f9e6ae31520</span>, <span class="number">0x1e00a4b9e25488f6</span>, <span class="number">0x1a9a0626a035fb9d</span>, <span class="number">0xe2f1eb0e5248cd2c</span>, <span class="number">0x8a0bf5239eed75c4</span>, </span><br><span class="line">        <span class="number">0x749e8082db34037d</span>, <span class="number">0xf4d25540ed584887</span>, <span class="number">0xc12422512500c887</span>, <span class="number">0x7e1a125dcfa56359</span>, <span class="number">0x497cff13eaa5bf76</span>, </span><br><span class="line">        <span class="number">0xd51ceddab7795459</span>, <span class="number">0xa922933b0b315a10</span>, <span class="number">0xcabd557ffa1df043</span>, <span class="number">0xe0459b855188d045</span>, <span class="number">0x82700d6f6a986873</span>, </span><br><span class="line">        <span class="number">0xc01552dff3a12f67</span>, <span class="number">0x0615548ece7312fb</span>, <span class="number">0x0e189fa829657913</span>, <span class="number">0x8d4c8f2124957228</span>, <span class="number">0x451572c65bcb3425</span>, </span><br><span class="line">        <span class="number">0x554fca602792e879</span>, <span class="number">0x4f749f6bbca2014c</span>, <span class="number">0xb1e1adc831c8d567</span>, <span class="number">0x9c73a6d3f711e66e</span>, <span class="number">0x2ab305ec4e07b0b4</span>, </span><br><span class="line">        <span class="number">0x98a16d274bb044d2</span>, <span class="number">0xc409de0e72c1029e</span>, <span class="number">0x5e68e47d3a360a80</span>, <span class="number">0xa1570f48caceb3dd</span>, <span class="number">0xd6ab1c9a18ebb936</span>]</span><br><span class="line"></span><br><span class="line"># <span class="built_in">trace_vm</span>(inps, limit) # 输出非函数部分的trace</span><br><span class="line"># <span class="built_in">run_vm</span>(inps, <span class="number">0</span>) # 输出整个文件的反汇编</span><br><span class="line"></span><br><span class="line"># 输出所有校验的反编译</span><br><span class="line"># ASMS, code, HIPC, stdout = <span class="built_in">run_vm</span>(inps, limit, True)</span><br><span class="line"># all_inst = <span class="built_in">extr_all</span>(ASMS)</span><br><span class="line"><span class="meta"># parse(all_inst)</span></span><br><span class="line"></span><br><span class="line"># 自动化逆向</span><br><span class="line">start = time.<span class="built_in">time</span>()</span><br><span class="line">inps = [<span class="number">0</span>] * <span class="number">50</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">0</span> in inps:</span><br><span class="line">    ASMS, code, HIPC, stdout = <span class="built_in">run_vm</span>(inps, limit, True)</span><br><span class="line">    inst = <span class="built_in">extr</span>(ASMS)</span><br><span class="line">    limit = <span class="built_in">b2nle</span>(code[HIPC:HIPC<span class="number">+2</span>], <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">    dec = <span class="built_in">solve</span>(inst)</span><br><span class="line">    inps[inst[<span class="number">0</span>]] = dec</span><br><span class="line">    <span class="built_in">print</span>(f<span class="string">&quot;[&#123;(time.time()-start):9.4f&#125;s] inps[0x&#123;inst[0]:02X&#125;] = 0x&#123;dec:016X&#125;&quot;</span>)</span><br><span class="line">end = time.<span class="built_in">time</span>()</span><br><span class="line"><span class="built_in">print</span>(f<span class="string">&quot;Completed. Total time: &#123;(end-start):9.4f&#125;s.&quot;</span>)</span><br><span class="line"><span class="built_in">printhex</span>(inps)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Now getting the flag...&quot;</span>)</span><br><span class="line">ASMS, code, HIPC, stdout = <span class="built_in">run_vm</span>(inps, limit, True)</span><br><span class="line"><span class="built_in">print</span>(stdout)</span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong>RCTF{VM_ALU_SMC_RC4_SPECK!_593eb6079d2da6c187ed462b033fee34}</strong></font></p>
<h1 id="Determinism"><a href="#Determinism" class="headerlink" title="Determinism"></a>Determinism</h1><p>程序数据段中存在12M的被加密小函数，flag校验逻辑围绕这数万个函数展开，很像<a href="https://astralprisma.github.io/2025/10/08/flareon_12/">flare-on 12的#5 ntfsm那题</a>.</p>
<p>程序主函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    __printf_chk(<span class="number">1</span>, <span class="string">&quot;usage: %s path.txt\\n&quot;</span>, *a2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">readfile</span>(a2[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">readflag</span>();</span><br><span class="line">    <span class="built_in">parse</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先读文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">readfile</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  stream_1 = <span class="built_in">fopen</span>(filename, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !stream_1 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">  stream = stream_1;</span><br><span class="line">  v3 = file;</span><br><span class="line">LABEL_8:</span><br><span class="line">  v4 = (_DWORD)v3 - (<span class="type">unsigned</span> <span class="type">int</span>)file;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    n10 = <span class="built_in">fgetc</span>(stream);</span><br><span class="line">    <span class="keyword">if</span> ( n10 == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v3 == &amp;byte_F64B9F )</span><br><span class="line">    &#123;</span><br><span class="line">      byte_F64B9F = <span class="number">0</span>;</span><br><span class="line">      result = <span class="built_in">fclose</span>(stream);</span><br><span class="line">      n1023 = <span class="number">1023</span>;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( n10 != <span class="number">10</span> &amp;&amp; n10 != <span class="number">13</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( ((*__ctype_b_loc())[n10] &amp; <span class="number">0x800</span>) == <span class="number">0</span> ) <span class="comment">//只允许0-9</span></span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      *v3++ = n10;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  file[v4] = <span class="number">0</span>;</span><br><span class="line">  result = <span class="built_in">fclose</span>(stream);</span><br><span class="line">  n1023 = (_DWORD)v3 - (<span class="type">unsigned</span> <span class="type">int</span>)file;</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">LABEL_13:</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存储到长度1023的全局数组file中，又读了一次flag：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">readflag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  __printf_chk(<span class="number">1</span>, <span class="string">&quot; input flag: &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">fgets</span>(s_, <span class="number">256</span>, stdin) || (s_[<span class="built_in">strcspn</span>(s_, <span class="string">&quot;\\r\\n&quot;</span>)] = <span class="number">0</span>, <span class="built_in">strlen</span>(s_) != <span class="number">17</span>) )</span><br><span class="line">LABEL_7:</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">for</span> ( n17 = <span class="number">0</span>; n17 != <span class="number">17</span>; ++n17 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = s_[n17];</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)(v1 - <span class="number">32</span>) &gt; <span class="number">0x5Fu</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    flag[n17] = v1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>flag长度17，之后开始处理：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">parse</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  p_file = (<span class="type">unsigned</span> __int8 *)file;</span><br><span class="line">  v18 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  p_buf = buf;</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">  <span class="built_in">LODWORD</span>(buf[<span class="number">2</span>]) = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">1</span>; ; i = buf[<span class="number">2</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = i - <span class="number">1</span>;</span><br><span class="line">    src = func_A_off[v3];</span><br><span class="line">    <span class="keyword">if</span> ( !src )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Missed the Jump!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    n16 = <span class="number">0</span>;</span><br><span class="line">    *(_OWORD *)v17 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v17[n16] = ~key1[n16];</span><br><span class="line">      ++n16;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( n16 != <span class="number">16</span> );</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    src_1 = <span class="built_in">TEA_DEC</span>(src, func_A_size[v3], (__int64)v17, &amp;n);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)<span class="built_in">Run_Func_A</span>(src_1, n, (__int64)buf, (__int64)flag) &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">HIDWORD</span>(buf[<span class="number">0</span>]) == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      __printf_chk(<span class="number">1</span>, <span class="string">&quot;running code error \\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> v18 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    v7 = <span class="built_in">LODWORD</span>(buf[<span class="number">2</span>]) - <span class="number">1</span>;</span><br><span class="line">    src_2 = func_B_off[v7];</span><br><span class="line">    <span class="keyword">if</span> ( !src_2 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Empty Path&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( n16_1 = <span class="number">0</span>; n16_1 != <span class="number">16</span>; ++n16_1 )</span><br><span class="line">      v17[n16_1] = ~key2[n16_1];</span><br><span class="line">    n = <span class="number">0</span>;</span><br><span class="line">    src_3 = <span class="built_in">AES_DEC</span>(src_2, func_B_size[v7], v17, &amp;n);</span><br><span class="line">    <span class="built_in">Run_Func_B</span>(src_3, n, (__int64)buf, buf[<span class="number">2</span>], *p_file);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">LODWORD</span>(buf[<span class="number">0</span>]) == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( buf[<span class="number">1</span>] == TARGET_<span class="number">17E1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !<span class="built_in">LODWORD</span>(buf[<span class="number">131</span>]) )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">        v12 = <span class="number">0x14650FB0739D0383LL</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v13 = *((<span class="type">int</span> *)p_buf + <span class="number">6</span>);</span><br><span class="line">          p_buf = (__int64 *)((<span class="type">char</span> *)p_buf + <span class="number">4</span>);</span><br><span class="line">          v14 = v12 ^ v13;</span><br><span class="line">          v12 = <span class="number">0x100000001B3LL</span> * v14;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( (__int64 *)((<span class="type">char</span> *)buf + <span class="number">4</span> * <span class="built_in">SLODWORD</span>(buf[<span class="number">131</span>])) != p_buf );</span><br><span class="line">        <span class="keyword">if</span> ( v14 == <span class="number">0x18C3D466784B5624LL</span></span><br><span class="line">          &amp;&amp; (flag[<span class="number">14</span>] ^ (<span class="type">unsigned</span> __int8)(((<span class="type">unsigned</span> __int8)flag[<span class="number">4</span>] &gt;&gt; <span class="number">1</span>) + <span class="number">2</span> * flag[<span class="number">0</span>])) == <span class="number">-48</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          __printf_chk(<span class="number">1</span>, <span class="string">&quot;you get flag %s&quot;</span>, flag);</span><br><span class="line">          <span class="built_in">putc</span>(<span class="number">10</span>, stdout);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">LABEL_24:</span><br><span class="line">          __printf_chk(<span class="number">1</span>, <span class="string">&quot;final check failed!\\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> v18 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( ++p_file == (<span class="type">unsigned</span> __int8 *)&amp;dword_F64BA0 )</span><br><span class="line">      <span class="keyword">return</span> v18 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v18 - __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序的data段有两组函数，前半组（A，0x1F2D00<del>0x933C88）用TEA加密，后半组（B，0x9D87C0</del>0xF308E0）用AES加密，密钥分别为取反的key1（<code>Jump_h1gh_2_sky!</code>）和key2（<code>L1nk_2_th3_IN3T!</code>），直接用hrtng解密，patch回源程序，然后批量创建函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_ida, ida_idaapi, ida_bytes, ida_funcs</span><br><span class="line"><span class="keyword">import</span> ida_ua</span><br><span class="line"><span class="keyword">import</span> ida_name</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">b&quot;\\xF3\\x0F\\x1E\\xFA&quot;</span></span><br><span class="line">BADADDR = idaapi.BADADDR</span><br><span class="line">REGIONS = [(<span class="number">0x1F2D00</span>, <span class="number">0x933C88</span>),(<span class="number">0x9D87C0</span>, <span class="number">0xF308E0</span>)]</span><br><span class="line">count_A = <span class="number">1</span></span><br><span class="line">count_B = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clear_region_if_needed</span>(<span class="params">start_ea, end_ea</span>):</span><br><span class="line">    need_clear = <span class="literal">False</span></span><br><span class="line">    ea = start_ea</span><br><span class="line">    <span class="keyword">while</span> ea &lt; end_ea:</span><br><span class="line">        flags = ida_bytes.get_full_flags(ea)</span><br><span class="line">        <span class="keyword">if</span> ida_bytes.is_code(flags) <span class="keyword">or</span> ida_funcs.get_func(ea) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            need_clear = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        ea = ida_bytes.next_head(ea, end_ea)</span><br><span class="line">        <span class="keyword">if</span> ea == BADADDR: <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> need_clear:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] No Code in Region 0x<span class="subst">&#123;start_ea:X&#125;</span>-0x<span class="subst">&#123;end_ea:X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] Clearing 0x<span class="subst">&#123;start_ea:X&#125;</span>-0x<span class="subst">&#123;end_ea:X&#125;</span>...&quot;</span>)</span><br><span class="line">    f = ida_funcs.get_next_func(start_ea)</span><br><span class="line">    <span class="keyword">while</span> f <span class="keyword">and</span> f.start_ea &lt; end_ea:</span><br><span class="line">        next_f = ida_funcs.get_next_func(f.start_ea)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;    - delfunc 0x<span class="subst">&#123;f.start_ea:X&#125;</span>&quot;</span>)</span><br><span class="line">        ida_funcs.del_func(f.start_ea)</span><br><span class="line">        f = next_f</span><br><span class="line">    ida_bytes.del_items(start_ea, ida_bytes.DELIT_SIMPLE, end_ea - start_ea)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Cleared 0x<span class="subst">&#123;start_ea:X&#125;</span>-0x<span class="subst">&#123;end_ea:X&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_region</span>(<span class="params">start_ea, end_ea</span>):</span><br><span class="line">    <span class="keyword">global</span> count_A, count_B</span><br><span class="line">    ea = ida_bytes.find_bytes(pattern, start_ea, range_end=end_ea)</span><br><span class="line">    <span class="keyword">while</span> ea != BADADDR <span class="keyword">and</span> ea &lt; end_ea:</span><br><span class="line">        flags = ida_bytes.get_full_flags(ea)</span><br><span class="line">        <span class="keyword">if</span> ida_bytes.is_unknown(flags):</span><br><span class="line">            ida_ua.create_insn(ea)</span><br><span class="line">            ida_funcs.add_func(ea)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Created function at 0x<span class="subst">&#123;ea:X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> ea &lt; <span class="number">0x960000</span>:</span><br><span class="line">            name = <span class="string">f&quot;func_A_<span class="subst">&#123;count_A&#125;</span>&quot;</span></span><br><span class="line">            count_A += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            name = <span class="string">f&quot;func_B_<span class="subst">&#123;count_B&#125;</span>&quot;</span></span><br><span class="line">            count_B += <span class="number">1</span></span><br><span class="line">        ida_name.set_name(ea, name, ida_name.SN_NOWARN | ida_name.SN_NOCHECK)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Renamed 0x<span class="subst">&#123;ea:X&#125;</span> to <span class="subst">&#123;name&#125;</span>&quot;</span>)</span><br><span class="line">        ea = ida_bytes.find_bytes(pattern, ea + <span class="number">1</span>, range_end=end_ea)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> idx, (r_start, r_end) <span class="keyword">in</span> <span class="built_in">enumerate</span>(REGIONS):</span><br><span class="line">    clear_region_if_needed(r_start, r_end)</span><br><span class="line">    process_region(r_start, r_end)</span><br></pre></td></tr></table></figure>

<p>修复诡异跳转导致的func_A中代码混乱问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_ida, ida_idaapi, ida_bytes, ida_funcs</span><br><span class="line"><span class="keyword">import</span> ida_ua</span><br><span class="line"><span class="keyword">import</span> ida_name</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> ida_idp</span><br><span class="line"></span><br><span class="line">pattern = <span class="string">b&quot;\\xF3\\x0F\\x1E\\xFA&quot;</span></span><br><span class="line">BADADDR = idaapi.BADADDR</span><br><span class="line">REGION = (<span class="number">0x1F2D00</span>, <span class="number">0x933C88</span>)</span><br><span class="line">count_A = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fix_sub_funcs_in_A</span>():</span><br><span class="line">    A_START, A_END = REGION</span><br><span class="line">    sub_funcs = []</span><br><span class="line">    f = ida_funcs.get_next_func(A_START)</span><br><span class="line">    <span class="keyword">while</span> f <span class="keyword">and</span> f.start_ea &lt; A_END:</span><br><span class="line">        fname = ida_funcs.get_func_name(f.start_ea) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> fname.startswith(<span class="string">&quot;sub_&quot;</span>):</span><br><span class="line">            sub_funcs.append(f)</span><br><span class="line">        f = ida_funcs.get_next_func(f.start_ea)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] found <span class="subst">&#123;<span class="built_in">len</span>(sub_funcs)&#125;</span> funcs&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> sub_f <span class="keyword">in</span> sub_funcs:</span><br><span class="line">        sub_start = sub_f.start_ea</span><br><span class="line">        sub_end   = sub_f.end_ea</span><br><span class="line">        last_ret = BADADDR</span><br><span class="line">        last_ret_end = BADADDR</span><br><span class="line">        ea = sub_start</span><br><span class="line">        <span class="keyword">while</span> ea &lt; sub_end:</span><br><span class="line">            insn = ida_ua.insn_t()</span><br><span class="line">            size = ida_ua.decode_insn(insn, ea)</span><br><span class="line">            <span class="keyword">if</span> size &lt;= <span class="number">0</span>:</span><br><span class="line">                ea += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> ida_idp.is_ret_insn(insn):</span><br><span class="line">                last_ret = ea</span><br><span class="line">                last_ret_end = ea + size</span><br><span class="line">            ea += size</span><br><span class="line">        <span class="keyword">if</span> last_ret == BADADDR:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] func 0x<span class="subst">&#123;sub_start:X&#125;</span> has no retn&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        prev = ida_funcs.get_prev_func(sub_start)</span><br><span class="line">        target = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">while</span> prev <span class="keyword">and</span> prev.start_ea &gt;= A_START:</span><br><span class="line">            pname = ida_funcs.get_func_name(prev.start_ea) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">if</span> pname.startswith(<span class="string">&quot;func_A_&quot;</span>):</span><br><span class="line">                target = prev</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            prev = ida_funcs.get_prev_func(prev.start_ea)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> target:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] No func_A above sub func 0x<span class="subst">&#123;sub_start:X&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        target_start = target.start_ea</span><br><span class="line">        target_name  = ida_funcs.get_func_name(target_start) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] Merge sub_0x<span class="subst">&#123;sub_start:X&#125;</span> to <span class="subst">&#123;target_name&#125;</span> (0x<span class="subst">&#123;target_start:X&#125;</span>), new end=0x<span class="subst">&#123;last_ret_end:X&#125;</span>&quot;</span>)</span><br><span class="line">        ida_funcs.del_func(sub_start)</span><br><span class="line">        ida_funcs.del_func(target_start)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ida_funcs.add_func(target_start, last_ret_end):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] Make function <span class="subst">&#123;target_name&#125;</span> @0x<span class="subst">&#123;target_start:X&#125;</span> failed&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        ida_name.set_name(target_start, target_name, ida_name.SN_NOWARN | ida_name.SN_NOCHECK)</span><br><span class="line"></span><br><span class="line">fix_sub_funcs_in_A()</span><br></pre></td></tr></table></figure>

<p>统计A和B的指令长度：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> ida_funcs</span><br><span class="line"><span class="keyword">import</span> ida_ua</span><br><span class="line"><span class="keyword">import</span> ida_name</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line">output_file_path = <span class="string">r&quot;E:/CTF/temp/basic_data.txt&quot;</span></span><br><span class="line">funcA_instruction_count = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">funcB_instruction_count = defaultdict(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_instruction_mnem</span>(<span class="params">ea</span>): <span class="keyword">return</span> ida_ua.print_insn_mnem(ea)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(output_file_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    func = ida_funcs.get_next_func(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">while</span> func:</span><br><span class="line">        func_name = ida_funcs.get_func_name(func.start_ea)</span><br><span class="line">        func_start = func.start_ea</span><br><span class="line">        func_end = func.end_ea</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (func_name.startswith(<span class="string">&quot;func_A_&quot;</span>) <span class="keyword">or</span> func_name.startswith(<span class="string">&quot;func_B_&quot;</span>)):</span><br><span class="line">            func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        ea = func_start</span><br><span class="line">        endbr_addr = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">while</span> ea &lt; func_end <span class="keyword">and</span> ea != idaapi.BADADDR:</span><br><span class="line">            mnem = get_instruction_mnem(ea)</span><br><span class="line">            <span class="keyword">if</span> mnem == <span class="string">&quot;endbr64&quot;</span>:</span><br><span class="line">                endbr_addr = ea</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            size = ida_bytes.get_item_size(ea)</span><br><span class="line">            <span class="keyword">if</span> size &lt;= <span class="number">0</span>: ea += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>: ea += size</span><br><span class="line">        <span class="keyword">if</span> endbr_addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        instruction_count = <span class="number">0</span></span><br><span class="line">        current = endbr_addr</span><br><span class="line">        found_retn = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">while</span> current &lt; func_end <span class="keyword">and</span> current != idaapi.BADADDR:</span><br><span class="line">            mnem = get_instruction_mnem(current)</span><br><span class="line">            size = ida_bytes.get_item_size(current)</span><br><span class="line">            <span class="keyword">if</span> size &lt;= <span class="number">0</span>:</span><br><span class="line">                current += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            instruction_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> mnem <span class="keyword">in</span> (<span class="string">&quot;retn&quot;</span>, <span class="string">&quot;ret&quot;</span>):</span><br><span class="line">                found_retn = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            current += size</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> found_retn:</span><br><span class="line">            func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> func_name.startswith(<span class="string">&quot;func_A_&quot;</span>):</span><br><span class="line">            funcA_instruction_count[instruction_count] += <span class="number">1</span></span><br><span class="line">            f.write(<span class="string">f&quot;<span class="subst">&#123;func_name&#125;</span> <span class="subst">&#123;func_start:08X&#125;</span> <span class="subst">&#123;instruction_count:08d&#125;</span>\\n&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> func_name.startswith(<span class="string">&quot;func_B_&quot;</span>):</span><br><span class="line">            funcB_instruction_count[instruction_count] += <span class="number">1</span></span><br><span class="line">            f.write(<span class="string">f&quot;<span class="subst">&#123;func_name&#125;</span> <span class="subst">&#123;func_start:08X&#125;</span> <span class="subst">&#123;instruction_count:08d&#125;</span>\\n&quot;</span>)</span><br><span class="line">        func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line">    f.write(<span class="string">&quot;\\n[*] 汇总：\\n&quot;</span>)</span><br><span class="line">    f.write(<span class="string">&quot;[*] func_A 指令条数统计：\\n&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> count, qty <span class="keyword">in</span> <span class="built_in">sorted</span>(funcA_instruction_count.items()): f.write(<span class="string">f&quot;指令条数 <span class="subst">&#123;count&#125;</span>: <span class="subst">&#123;qty&#125;</span> 个函数\\n&quot;</span>)</span><br><span class="line">    f.write(<span class="string">&quot;[*] func_B 指令条数统计：\\n&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> count, qty <span class="keyword">in</span> <span class="built_in">sorted</span>(funcB_instruction_count.items()): f.write(<span class="string">f&quot;指令条数 <span class="subst">&#123;count&#125;</span>: <span class="subst">&#123;qty&#125;</span> 个函数\\n&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] 数据已输出到 <span class="subst">&#123;output_file_path&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[*] 汇总：</span><br><span class="line">[*] func_A 指令条数统计：</span><br><span class="line">指令条数 <span class="number">56</span>: <span class="number">18868</span> 个函数</span><br><span class="line">指令条数 <span class="number">68</span>: <span class="number">1</span> 个函数</span><br><span class="line">指令条数 <span class="number">70</span>: <span class="number">9</span> 个函数</span><br><span class="line">指令条数 <span class="number">71</span>: <span class="number">367</span> 个函数</span><br><span class="line">指令条数 <span class="number">72</span>: <span class="number">2469</span> 个函数</span><br><span class="line">指令条数 <span class="number">75</span>: <span class="number">1</span> 个函数</span><br><span class="line">指令条数 <span class="number">76</span>: <span class="number">10</span> 个函数</span><br><span class="line">指令条数 <span class="number">77</span>: <span class="number">21</span> 个函数</span><br><span class="line">指令条数 <span class="number">78</span>: <span class="number">28</span> 个函数</span><br><span class="line">指令条数 <span class="number">79</span>: <span class="number">1086</span> 个函数</span><br><span class="line">指令条数 <span class="number">80</span>: <span class="number">3303</span> 个函数</span><br><span class="line">指令条数 <span class="number">81</span>: <span class="number">2</span> 个函数</span><br><span class="line">指令条数 <span class="number">82</span>: <span class="number">8</span> 个函数</span><br><span class="line">指令条数 <span class="number">95</span>: <span class="number">395</span> 个函数</span><br><span class="line">指令条数 <span class="number">96</span>: <span class="number">2560</span> 个函数</span><br><span class="line">[*] func_B 指令条数统计：</span><br><span class="line">指令条数 <span class="number">81</span>: <span class="number">19457</span> 个函数</span><br></pre></td></tr></table></figure>

<p>注意到B的长度均相同，而A的长度略有差异，先观察函数B的特征：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">func_B_1</span><span class="params">(_DWORD *a1, __int64 a2, <span class="type">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (a3 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*a1 )</span><br><span class="line">      *a1 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( *a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *a1 = <span class="number">2</span>;</span><br><span class="line">    n38914_1 = <span class="number">0xFFFFFFFFLL</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (a3 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">    n38914 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    n38914 = <span class="number">38914</span>;</span><br><span class="line">  <span class="keyword">if</span> ( n38914 == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *a1 = <span class="number">2</span>;</span><br><span class="line">    n38914_1 = <span class="number">0xFFFFFFFFLL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">4</span>] = n38914;</span><br><span class="line">    ++a1[<span class="number">5</span>];</span><br><span class="line">    n38914_1 = n38914;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_12:</span><br><span class="line">  <span class="keyword">if</span> ( v5 != __readfsqword(<span class="number">0x28u</span>) )</span><br><span class="line">    <span class="keyword">return</span> MEMORY[<span class="number">0xFFFFFFFFFFDDC722</span>]();</span><br><span class="line">  <span class="keyword">return</span> n38914_1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">func_B_2</span><span class="params">(_DWORD *a1, __int64 a2, <span class="type">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (a3 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*a1 )</span><br><span class="line">      *a1 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( *a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *a1 = <span class="number">2</span>;</span><br><span class="line">    n38913_1 = <span class="number">0xFFFFFFFFLL</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (a3 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">    n38913 = <span class="number">38913</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    n38913 = <span class="number">38912</span>;</span><br><span class="line">  a1[<span class="number">4</span>] = n38913;</span><br><span class="line">  ++a1[<span class="number">5</span>];</span><br><span class="line">  n38913_1 = n38913;</span><br><span class="line">LABEL_10:</span><br><span class="line">  <span class="keyword">if</span> ( v5 != __readfsqword(<span class="number">0x28u</span>) )</span><br><span class="line">    <span class="keyword">return</span> MEMORY[<span class="number">0xFFFFFFFFFFDDC95D</span>]();</span><br><span class="line">  <span class="keyword">return</span> n38913_1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">func_B_8</span><span class="params">(_DWORD *a1, __int64 a2, <span class="type">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (a3 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !*a1 )</span><br><span class="line">      *a1 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( *a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *a1 = <span class="number">2</span>;</span><br><span class="line">    result = <span class="number">0xFFFFFFFFLL</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  *a1 = <span class="number">2</span>;</span><br><span class="line">  result = <span class="number">0xFFFFFFFFLL</span>;</span><br><span class="line">LABEL_7:</span><br><span class="line">  <span class="keyword">if</span> ( v4 != __readfsqword(<span class="number">0x28u</span>) )</span><br><span class="line">    <span class="keyword">return</span> MEMORY[<span class="number">0xFFFFFFFFFFDDD6BF</span>]();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，funcB会根据某种条件从两个候选值中选择一个return，有的时候return的两个值都是合法值，有的时候则只有1个甚至无合法值，注意到这两个值位于funcB的偏移量0x7B（<code>(a3 &amp; 2) != 0</code>）和0x74（<code>(a3 &amp; 2) == 0</code>）处，提取值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> ida_funcs</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">output_path = <span class="string">r&quot;E:/CTF/temp/func_B_branches.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_imm_from_mov</span>(<span class="params">ea</span>):</span><br><span class="line">    <span class="keyword">if</span> idc.print_insn_mnem(ea) != <span class="string">&quot;mov&quot;</span>: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    op1_type = idc.get_operand_type(ea, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> op1_type == idc.o_imm: <span class="keyword">return</span> idc.get_operand_value(ea, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    func = ida_funcs.get_next_func(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">while</span> func:</span><br><span class="line">        func_name = ida_funcs.get_func_name(func.start_ea)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> func_name <span class="keyword">or</span> <span class="keyword">not</span> func_name.startswith(<span class="string">&quot;func_B_&quot;</span>):</span><br><span class="line">            func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> idc.print_insn_mnem(func.start_ea) != <span class="string">&quot;endbr64&quot;</span>:</span><br><span class="line">            func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        addr1 = func.start_ea + <span class="number">0x74</span></span><br><span class="line">        addr2 = func.start_ea + <span class="number">0x7B</span></span><br><span class="line">        imm1 = get_imm_from_mov(addr1)</span><br><span class="line">        imm2 = get_imm_from_mov(addr2)</span><br><span class="line">        <span class="keyword">if</span> imm1 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> imm2 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            val1 = imm1 &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            val2 = imm2 &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            f.write(<span class="string">f&quot;<span class="subst">&#123;func_name&#125;</span> <span class="subst">&#123;val2&#125;</span> <span class="subst">&#123;val1&#125;</span>\\n&quot;</span>)</span><br><span class="line">        func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] func_B 分支数据已输出到: <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>提取后发现B中的合法值均在38914~2（倒序，无1和0），且其他值被替换成了-1.</p>
<p>结合整个程序的二进制结构：</p>
<table>
<thead>
<tr>
<th>地址</th>
<th>大小 &#x2F; 项数</th>
<th>作用 &#x2F; 描述</th>
</tr>
</thead>
<tbody><tr>
<td>0x11E2C0 - 0x12007D (text)</td>
<td>-</td>
<td>text段</td>
</tr>
<tr>
<td>0x121088 - 0x17FEE0 (sizes)</td>
<td>48587</td>
<td>记录了funcA和funcB加密块的大小</td>
</tr>
<tr>
<td>0x182040 - 0x1CE050 (func_A_size)</td>
<td>38914</td>
<td>稀疏存储了每个func_A加密块的大小</td>
</tr>
<tr>
<td>0x1F3D00 - 0x934C84 (func_A)</td>
<td>29130</td>
<td>func_A</td>
</tr>
<tr>
<td>0x934CA0 - 0x980CB0 (func_A_off)</td>
<td>38914</td>
<td>稀疏倒序存储了每个func_A的地址</td>
</tr>
<tr>
<td>0x9A6960 - 0x9D97C0 (func_B_size)</td>
<td>26057</td>
<td>稀疏存储了每个func_B加密块的大小</td>
</tr>
<tr>
<td>0x9D97C0 - 0xF318DA (func_B)</td>
<td>19457</td>
<td>func_B</td>
</tr>
<tr>
<td>0xF318E0 - 0xF64728 (func_B_off)</td>
<td>26057</td>
<td>稀疏倒序存储了每个func_B的地址</td>
</tr>
</tbody></table>
<p>分析func_B中的几个指针，和任意一个func_A的结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">func_A_1</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *((_QWORD *)a1 + <span class="number">1</span>) += <span class="number">1111LL</span>; <span class="comment">// func_A全局权重和</span></span><br><span class="line">    <span class="keyword">if</span> ( a1[<span class="number">262</span>] &lt;= <span class="number">0x3FFu</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = a1[<span class="number">262</span>];</span><br><span class="line">      a1[<span class="number">262</span>] = v1 + <span class="number">1</span>;</span><br><span class="line">      a1[v1 + <span class="number">6</span>] = <span class="number">1111</span>;</span><br><span class="line">    &#125;&#125;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )&#123;<span class="keyword">if</span> ( *a1 == <span class="number">1</span> ) &#123;a1[<span class="number">1</span>] = <span class="number">2</span>;&#125;&#125;</span><br><span class="line">  <span class="keyword">else</span> &#123; a1[<span class="number">1</span>] = <span class="number">0</span>;&#125;</span><br><span class="line">  a1[<span class="number">4</span>] = <span class="number">0x9802</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ↓ 简化为</span></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">func_A_1</span><span class="params">(_DWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *((_QWORD *)a1 + <span class="number">1</span>) += <span class="number">1111LL</span>; <span class="comment">// func_A全局权重和</span></span><br><span class="line">    <span class="keyword">if</span> ( a1[<span class="number">262</span>] &lt;= <span class="number">0x3FFu</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = a1[<span class="number">262</span>];</span><br><span class="line">      a1[<span class="number">262</span>] = v1 + <span class="number">1</span>;</span><br><span class="line">      a1[v1 + <span class="number">6</span>] = <span class="number">1111</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    a1[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123; a1[<span class="number">1</span>] = <span class="number">0</span>;&#125;</span><br><span class="line">  a1[<span class="number">4</span>] = <span class="number">0x9802</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">func_A_4</span><span class="params">(_DWORD *a1, <span class="type">unsigned</span> __int8 *a2)</span> <span class="comment">// a2是flag</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *((_QWORD *)a1 + <span class="number">1</span>) += <span class="number">7276LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a1[<span class="number">262</span>] &lt;= <span class="number">0x3FFu</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = a1[<span class="number">262</span>];</span><br><span class="line">      a1[<span class="number">262</span>] = v2 + <span class="number">1</span>;</span><br><span class="line">      a1[v2 + <span class="number">6</span>] = <span class="number">7276</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *a1 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (a2[<span class="number">11</span>] + a2[<span class="number">4</span>]) * a2[<span class="number">9</span>] * a2[<span class="number">2</span>] == <span class="number">119</span> )</span><br><span class="line">        a1[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        a1[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    a1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  a1[<span class="number">4</span>] = <span class="number">38911</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合parse的处理逻辑，整体推断，注意到parse中的buf和func_A、func_B的第一个参数是一个巨大的结构体，其组成为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x000</span> <span class="type">int</span> func_A_state; <span class="comment">// A的运行状态，为1时运行其内部逻辑，为0时不运行</span></span><br><span class="line"><span class="number">0x004</span> <span class="type">int</span> func_A_result; <span class="comment">// A的返回状态，不运行时为0，运行时，若其内部无比较flag的逻辑，则为2；若有，若正确则为1，不正确则为2</span></span><br><span class="line"><span class="number">0x008</span> <span class="type">long</span> <span class="type">long</span> func_A_weight; <span class="comment">// A的权重，最终加和要等于0x17E1</span></span><br><span class="line"><span class="number">0x010</span> <span class="type">int</span> func_index; <span class="comment">// A/B共用的func索引，是稀疏偏移量表中的索引</span></span><br><span class="line"><span class="number">0x014</span> <span class="type">int</span> Total_func_B_Called; <span class="comment">// B的调用次数</span></span><br><span class="line"><span class="number">0x018</span> <span class="type">int</span> func_A_weight_hash[<span class="number">256</span>]; <span class="comment">// 一个256项的int数组，统计了经过的所有A的权重</span></span><br><span class="line"><span class="number">0x418</span> <span class="type">int</span> Total_func_A_Called; <span class="comment">// A的调用次数</span></span><br></pre></td></tr></table></figure>

<p>A和B的实际逻辑是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func_A_</span>&lt;<span class="built_in">id</span>&gt; (Stucture, flag):                          <span class="comment"># flag约束逻辑</span></span><br><span class="line">	<span class="keyword">if</span> func_A_state == <span class="number">1</span>:                                    <span class="comment"># 如果执行内部代码</span></span><br><span class="line">		func_A_weight += &lt;weight&gt;                              <span class="comment"># 权重总和更新</span></span><br><span class="line">    <span class="keyword">if</span> Total_func_A_Called &lt;= <span class="number">0x3FF</span>:</span><br><span class="line">      func_A_weight_hash[Total_func_A_Called] = &lt;weight&gt;   <span class="comment"># 权重列表更新</span></span><br><span class="line">      Total_func_A_Called += <span class="number">1</span>                             <span class="comment"># 调用次数+1</span></span><br><span class="line">      <span class="keyword">if</span> &lt;<span class="keyword">assert</span> flag... == ...&gt;: func_A_result = <span class="number">1</span>        <span class="comment"># 校验flag / 不校验直接返回2（死节点）</span></span><br><span class="line">      <span class="keyword">else</span>: func_A_result = <span class="number">2</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    func_A_result = <span class="number">0</span>                                      <span class="comment"># 不执行，转到func_B</span></span><br><span class="line">  func_index = &lt;idx <span class="keyword">in</span> func_A_off&gt;                         <span class="comment"># func_A全过程都没修改过idx，此处为多余操作</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_B_</span>&lt;<span class="built_in">id</span>&gt; (Stucture, func_index, file[i]):           <span class="comment"># 控制流修改逻辑</span></span><br><span class="line">  <span class="keyword">if</span> (file[i] &amp; <span class="number">0b01</span>) != <span class="number">0</span>:                                <span class="comment"># 如果最低位为1（1、3、5、7、9）</span></span><br><span class="line">    <span class="keyword">if</span> func_A_state == <span class="number">0</span>: func_A_state = <span class="number">1</span>                 <span class="comment"># 如果func_A没有激活，则激活func_A（注意没有取消激活）</span></span><br><span class="line">  <span class="keyword">elif</span> func_A_state == <span class="number">1</span>:                                  <span class="comment"># 如果最低位不为1（0、2、4、6、8）且A已激活</span></span><br><span class="line">    func_A_state = <span class="number">2</span>                                       <span class="comment"># 将func_A_state改为2，进入最终校验逻辑（结束处理循环）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span></span><br><span class="line">  <span class="keyword">if</span> (file[i] &amp; <span class="number">0b10</span>) != <span class="number">0</span>: func_index = &lt;num at <span class="number">0x7B</span>&gt;     <span class="comment"># 如果第二位为1（2、3、6、7），更新func_index为0x7B处的值</span></span><br><span class="line">  <span class="keyword">else</span>: func_index = &lt;num at <span class="number">0x74</span>&gt;                         <span class="comment"># 如果第二位不为1（0、1、4、5、8、9），更新func_index为0x74处的值</span></span><br><span class="line">  Total_func_B_Called += <span class="number">1</span>                                 <span class="comment"># 调用次数+1</span></span><br><span class="line">  res = next_idx</span><br><span class="line">  <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure>

<p>处理逻辑为：初始化index为1（实际上指向稀疏偏移量表[0]）→ parse循环体 → func_A_29130(0) → 返回index 1 → func_B_19457 此时文件数据开始生效，我们可以控制先不激活A，让index增加一会，然后从某个时机开始激活A并逐步通过约束flag，最终在B改状态位为2进入最终校验.</p>
<p>提取A的权重：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> ida_funcs</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">output_path = <span class="string">r&quot;E:/CTF/temp/func_A_weights.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_imm_from_mov_to_rbp_offset</span>(<span class="params">ea</span>):</span><br><span class="line">    <span class="keyword">if</span> idc.print_insn_mnem(ea) != <span class="string">&quot;mov&quot;</span>: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    op0_type = idc.get_operand_type(ea, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> op0_type != idc.o_displ: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    op1_type = idc.get_operand_type(ea, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> op1_type == idc.o_imm: <span class="keyword">return</span> idc.get_operand_value(ea, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    func = ida_funcs.get_next_func(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">while</span> func:</span><br><span class="line">        func_name = ida_funcs.get_func_name(func.start_ea)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> func_name <span class="keyword">or</span> <span class="keyword">not</span> func_name.startswith(<span class="string">&quot;func_A_&quot;</span>):</span><br><span class="line">            func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> idc.print_insn_mnem(func.start_ea) != <span class="string">&quot;endbr64&quot;</span>:</span><br><span class="line">            func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        weight_insn_ea = func.start_ea + <span class="number">0x10</span></span><br><span class="line">        weight = get_imm_from_mov_to_rbp_offset(weight_insn_ea)</span><br><span class="line">        <span class="keyword">if</span> weight <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            weight &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">            f.write(<span class="string">f&quot;<span class="subst">&#123;func_name&#125;</span> <span class="subst">&#123;weight&#125;</span>\\n&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>: <span class="built_in">print</span>(<span class="string">f&quot;[!] Failed to extract weight from <span class="subst">&#123;func_name&#125;</span> at <span class="subst">&#123;<span class="built_in">hex</span>(weight_insn_ea)&#125;</span>&quot;</span>)</span><br><span class="line">        func = ida_funcs.get_next_func(func.start_ea)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[+] func_A 权重数据已输出到: <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>接下来进行权重和约束，先提取func_A_off和func_B_off：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_uint64s_to_hex</span>(<span class="params">input_file, offset, count, output_file</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.seek(offset)</span><br><span class="line">        data = f.read(<span class="number">8</span> * count)</span><br><span class="line">    values = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count):</span><br><span class="line">        val = struct.unpack_from(<span class="string">&#x27;&lt;Q&#x27;</span>, data, i * <span class="number">8</span>)[<span class="number">0</span>]</span><br><span class="line">        hex_str = <span class="string">f&#x27;0x<span class="subst">&#123;val:08X&#125;</span>&#x27;</span></span><br><span class="line">        values.append(hex_str)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> out_f:</span><br><span class="line">        out_f.write(<span class="string">&#x27;\\n&#x27;</span>.join(values))</span><br><span class="line">        out_f.write(<span class="string">&#x27;\\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">input_bin = <span class="string">&#x27;Determinism&#x27;</span></span><br><span class="line">extract_uint64s_to_hex(</span><br><span class="line">    input_file=input_bin,</span><br><span class="line">    offset=<span class="number">0x933CA0</span>,</span><br><span class="line">    count=<span class="number">38914</span>,</span><br><span class="line">    output_file=<span class="string">&#x27;func_A_off.txt&#x27;</span></span><br><span class="line">)</span><br><span class="line">extract_uint64s_to_hex(</span><br><span class="line">    input_file=input_bin,</span><br><span class="line">    offset=<span class="number">0xF308E0</span>,</span><br><span class="line">    count=<span class="number">26057</span>,</span><br><span class="line">    output_file=<span class="string">&#x27;func_B_off.txt&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>接下来映射为func编号：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build_address_to_func_map</span>(<span class="params">basic_file, num_lines=<span class="number">48587</span></span>):</span><br><span class="line">    addr_to_func = &#123;&#125;</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(basic_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f):</span><br><span class="line">            <span class="keyword">if</span> i &gt;= num_lines: <span class="keyword">break</span></span><br><span class="line">            parts = line.strip().split()</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(parts) &lt; <span class="number">2</span>: <span class="keyword">continue</span></span><br><span class="line">            func_name = parts[<span class="number">0</span>]</span><br><span class="line">            addr_hex = parts[<span class="number">1</span>].upper().zfill(<span class="number">8</span>)[-<span class="number">8</span>:]</span><br><span class="line">            addr_to_func[addr_hex] = func_name</span><br><span class="line">    <span class="keyword">return</span> addr_to_func</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resolve_offsets</span>(<span class="params">off_file, addr_map, output_file</span>):</span><br><span class="line">    found = <span class="number">0</span></span><br><span class="line">    not_found = <span class="number">0</span></span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(off_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            line = line.strip()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> line: <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">try</span>: full_val = <span class="built_in">int</span>(line, <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                results.append(<span class="string">&quot;ERROR&quot;</span>)</span><br><span class="line">                not_found += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            low32 = full_val &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            addr_key = <span class="string">f&quot;<span class="subst">&#123;low32:08X&#125;</span>&quot;</span></span><br><span class="line">            func_name = addr_map.get(addr_key, <span class="string">&quot;ERROR&quot;</span>)</span><br><span class="line">            results.append(func_name)</span><br><span class="line">            <span class="keyword">if</span> func_name == <span class="string">&quot;ERROR&quot;</span>: not_found += <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>: found += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> out_f:</span><br><span class="line">        out_f.write(<span class="string">&#x27;\\n&#x27;</span>.join(results))</span><br><span class="line">        out_f.write(<span class="string">&#x27;\\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> found, not_found</span><br><span class="line"></span><br><span class="line">addr_map = build_address_to_func_map(<span class="string">&#x27;basic_data.txt&#x27;</span>, num_lines=<span class="number">48587</span>)</span><br><span class="line">found_a, not_found_a = resolve_offsets(<span class="string">&#x27;func_A_off.txt&#x27;</span>, addr_map, <span class="string">&#x27;off_A.txt&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;func_A: 找到 <span class="subst">&#123;found_a&#125;</span> 个，未找到 <span class="subst">&#123;not_found_a&#125;</span> 个&quot;</span>)</span><br><span class="line">found_b, not_found_b = resolve_offsets(<span class="string">&#x27;func_B_off.txt&#x27;</span>, addr_map, <span class="string">&#x27;off_B.txt&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;func_B: 找到 <span class="subst">&#123;found_b&#125;</span> 个，未找到 <span class="subst">&#123;not_found_b&#125;</span> 个&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>编写脚本求解约束：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line">TARGET = <span class="number">0x17E1</span></span><br><span class="line">HASH_TARGET = <span class="number">0x18C3D466784B5624</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fnv1_hash</span>(<span class="params">weights</span>):</span><br><span class="line">    v12 = <span class="number">0x14650FB0739D0383</span></span><br><span class="line">    <span class="keyword">for</span> weight <span class="keyword">in</span> weights:</span><br><span class="line">        v14 = v12 ^ weight &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span> <span class="comment"># 这里拓展到64位了</span></span><br><span class="line">        v12 = (<span class="number">0x100000001B3</span> * v14) &amp; <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> v14</span><br><span class="line"></span><br><span class="line">addr_to_A = &#123;&#125;</span><br><span class="line">addr_to_B = &#123;&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Loading basic_data.txt...&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;basic_data.txt&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f: lines = f.readlines()</span><br><span class="line"><span class="keyword">for</span> i, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(lines):</span><br><span class="line">    parts = line.strip().split()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(parts) &lt; <span class="number">3</span>: <span class="keyword">continue</span></span><br><span class="line">    name, addr_hex, size_hex = parts[<span class="number">0</span>], parts[<span class="number">1</span>], parts[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">try</span>: size = <span class="built_in">int</span>(size_hex, <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">except</span> ValueError: <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> name.startswith(<span class="string">&quot;func_A&quot;</span>): addr_to_A[name] = &#123;<span class="string">&quot;size&quot;</span>: size&#125;</span><br><span class="line">    <span class="keyword">elif</span> name.startswith(<span class="string">&quot;func_B&quot;</span>): addr_to_B[name] = &#123;<span class="string">&quot;size&quot;</span>: size&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Loading func_A_weights.txt...&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;func_A_weights.txt&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        parts = line.strip().split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(parts) &lt; <span class="number">2</span>: <span class="keyword">continue</span></span><br><span class="line">        name, w_str = parts[<span class="number">0</span>], parts[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">try</span>: w_uint = <span class="built_in">int</span>(w_str)</span><br><span class="line">        <span class="keyword">except</span> ValueError: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> w_uint &gt;= <span class="number">2</span>**<span class="number">31</span>: w_int = w_uint - <span class="number">2</span>**<span class="number">32</span></span><br><span class="line">        <span class="keyword">else</span>: w_int = w_uint</span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> addr_to_A: addr_to_A[name][<span class="string">&quot;weight&quot;</span>] = w_int</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Loading func_B_branches.txt...&quot;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;func_B_branches.txt&quot;</span>, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        parts = line.strip().split()</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(parts) &lt; <span class="number">3</span>: <span class="keyword">continue</span></span><br><span class="line">        name, b1_str, b2_str = parts[<span class="number">0</span>], parts[<span class="number">1</span>], parts[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            b1 = <span class="built_in">int</span>(b1_str)</span><br><span class="line">            b2 = <span class="built_in">int</span>(b2_str)</span><br><span class="line">        <span class="keyword">except</span> ValueError: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> name <span class="keyword">in</span> addr_to_B:</span><br><span class="line">            addr_to_B[name][<span class="string">&quot;branch1&quot;</span>] = b1 <span class="keyword">if</span> b1 != <span class="number">0xFFFFFFFF</span> <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line">            addr_to_B[name][<span class="string">&quot;branch2&quot;</span>] = b2 <span class="keyword">if</span> b2 != <span class="number">0xFFFFFFFF</span> <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_off</span>(<span class="params">filename</span>):</span><br><span class="line">    lst = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            s = line.strip()</span><br><span class="line">            <span class="keyword">if</span> s == <span class="string">&quot;ERROR&quot;</span>: lst.append(<span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">else</span>: lst.append(s)</span><br><span class="line">    <span class="keyword">return</span> lst</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Loading off_A.txt and off_B.txt...&quot;</span>)</span><br><span class="line">off_A = load_off(<span class="string">&quot;off_A.txt&quot;</span>)</span><br><span class="line">off_B = load_off(<span class="string">&quot;off_B.txt&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_A_name</span>(<span class="params">func_index</span>):</span><br><span class="line">    idx = func_index - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> idx &lt; <span class="number">0</span> <span class="keyword">or</span> idx &gt;= <span class="built_in">len</span>(off_A): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> off_A[idx]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_B_name</span>(<span class="params">func_index</span>):</span><br><span class="line">    idx = func_index - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> idx &lt; <span class="number">0</span> <span class="keyword">or</span> idx &gt;= <span class="built_in">len</span>(off_B): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> off_B[idx]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_A_info</span>(<span class="params">func_index</span>):</span><br><span class="line">    idx = func_index - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> idx &lt; <span class="number">0</span> <span class="keyword">or</span> idx &gt;= <span class="built_in">len</span>(off_A): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    name = off_A[idx]</span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> addr_to_A: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> addr_to_A[name]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_B_info</span>(<span class="params">func_index</span>):</span><br><span class="line">    idx = func_index - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> idx &lt; <span class="number">0</span> <span class="keyword">or</span> idx &gt;= <span class="built_in">len</span>(off_B): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    name = off_B[idx]</span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> name <span class="keyword">not</span> <span class="keyword">in</span> addr_to_B: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> addr_to_B[name]</span><br><span class="line">sys.setrecursionlimit(<span class="number">10000</span>)</span><br><span class="line">valid_paths = []</span><br><span class="line">MAX_DEPTH = <span class="number">2000</span></span><br><span class="line">visited = <span class="built_in">set</span>()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dfs</span>(<span class="params">step_type, func_index, activation_from, weight, activated_weights, path, depth</span>):</span><br><span class="line">    <span class="keyword">if</span> depth &gt; <span class="number">200</span>: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> weight == TARGET:</span><br><span class="line">        <span class="keyword">if</span> activated_weights:</span><br><span class="line">            hash_result = fnv1_hash(activated_weights)</span><br><span class="line">            <span class="keyword">if</span> hash_result == HASH_TARGET:</span><br><span class="line">                activation_from_name = get_B_name(activation_from) <span class="keyword">if</span> activation_from <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">                path_info = &#123;</span><br><span class="line">                    <span class="string">&#x27;path&#x27;</span>: path.copy(),</span><br><span class="line">                    <span class="string">&#x27;activated_weights&#x27;</span>: activated_weights.copy(),</span><br><span class="line">                    <span class="string">&#x27;activation_from&#x27;</span>: activation_from_name,</span><br><span class="line">                    <span class="string">&#x27;final_weight&#x27;</span>: weight,</span><br><span class="line">                    <span class="string">&#x27;hash_result&#x27;</span>: <span class="built_in">hex</span>(hash_result)</span><br><span class="line">                &#125;</span><br><span class="line">                valid_paths.append(path_info)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Found valid path! Steps: <span class="subst">&#123;<span class="built_in">len</span>(path)&#125;</span>, weight=<span class="subst">&#123;weight&#125;</span>, hash=0x<span class="subst">&#123;hash_result:016X&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Activation started from: <span class="subst">&#123;activation_from_name&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Activated weights: <span class="subst">&#123;activated_weights&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">    weights_tuple = <span class="built_in">tuple</span>(activated_weights)</span><br><span class="line">    state = (step_type, func_index, activation_from, weight, weights_tuple)</span><br><span class="line">    <span class="keyword">if</span> state <span class="keyword">in</span> visited: <span class="keyword">return</span></span><br><span class="line">    visited.add(state)</span><br><span class="line">    <span class="keyword">if</span> step_type == <span class="string">&#x27;A&#x27;</span>:</span><br><span class="line">        a_info = get_A_info(func_index)</span><br><span class="line">        <span class="keyword">if</span> a_info <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> a_info[<span class="string">&quot;size&quot;</span>] == <span class="number">56</span>: <span class="keyword">return</span></span><br><span class="line">        a_name = get_A_name(func_index)</span><br><span class="line">        new_weight = weight</span><br><span class="line">        new_activated_weights = activated_weights.copy()</span><br><span class="line">        <span class="keyword">if</span> activation_from <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            w = a_info.get(<span class="string">&quot;weight&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            new_weight = weight + w</span><br><span class="line">            new_activated_weights.append(w)</span><br><span class="line">        path.append(<span class="string">f&quot;<span class="subst">&#123;a_name&#125;</span>&quot;</span> + (<span class="string">&quot;*&quot;</span> <span class="keyword">if</span> activation_from <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">&quot;&quot;</span>))</span><br><span class="line">        dfs(<span class="string">&#x27;B&#x27;</span>, func_index, activation_from, new_weight, new_activated_weights, path, depth + <span class="number">1</span>)</span><br><span class="line">        path.pop()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        b_info = get_B_info(func_index)</span><br><span class="line">        <span class="keyword">if</span> b_info <span class="keyword">is</span> <span class="literal">None</span>: <span class="keyword">return</span></span><br><span class="line">        b_name = get_B_name(func_index)</span><br><span class="line">        b1 = b_info.get(<span class="string">&quot;branch1&quot;</span>, -<span class="number">1</span>)</span><br><span class="line">        b2 = b_info.get(<span class="string">&quot;branch2&quot;</span>, -<span class="number">1</span>)</span><br><span class="line">        next_indices = []</span><br><span class="line">        <span class="keyword">if</span> b1 != -<span class="number">1</span>: next_indices.append(b1)</span><br><span class="line">        <span class="keyword">if</span> b2 != -<span class="number">1</span>: next_indices.append(b2)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> next_indices: <span class="keyword">return</span></span><br><span class="line">        path.append(<span class="string">f&quot;<span class="subst">&#123;b_name&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> next_idx <span class="keyword">in</span> next_indices:</span><br><span class="line">            <span class="keyword">if</span> next_idx &lt;= <span class="number">0</span>: <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> activation_from <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>: dfs(<span class="string">&#x27;A&#x27;</span>, next_idx, activation_from, weight, activated_weights, path, depth + <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dfs(<span class="string">&#x27;A&#x27;</span>, next_idx, <span class="literal">None</span>, weight, activated_weights, path, depth + <span class="number">1</span>)</span><br><span class="line">                dfs(<span class="string">&#x27;A&#x27;</span>, next_idx, func_index, weight, activated_weights, path, depth + <span class="number">1</span>)</span><br><span class="line">        path.pop()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Starting DFS with hash constraint...&quot;</span>)</span><br><span class="line">dfs(<span class="string">&#x27;A&#x27;</span>, <span class="number">1</span>, <span class="literal">None</span>, <span class="number">0</span>, [], [], <span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\\nTotal valid paths found: <span class="subst">&#123;<span class="built_in">len</span>(valid_paths)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i, path_info <span class="keyword">in</span> <span class="built_in">enumerate</span>(valid_paths):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\\nPath <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>:&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Route: <span class="subst">&#123;<span class="string">&#x27; -&gt; &#x27;</span>.join(path_info[<span class="string">&#x27;path&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Activation started from: <span class="subst">&#123;path_info[<span class="string">&#x27;activation_from&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Activated weights: <span class="subst">&#123;path_info[<span class="string">&#x27;activated_weights&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Final weight: <span class="subst">&#123;path_info[<span class="string">&#x27;final_weight&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  Hash result: <span class="subst">&#123;path_info[<span class="string">&#x27;hash_result&#x27;</span>]&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>得到唯一解：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Found valid path! Steps: 41, weight=6113, hash=0x18C3D466784B5624</span><br><span class="line">Activation started from: func_B_19446</span><br><span class="line">Activated weights: [5783, -7171, -1733, -3415, 7703, -8204, 2875, 7495, 7641, -183, -7455, 3473, 2466, -17, 2740, -5885]</span><br><span class="line"></span><br><span class="line">Total valid paths found: 1</span><br><span class="line"></span><br><span class="line">Path 1:</span><br><span class="line">  Route: func_A_29130 -&gt; func_B_19457 -&gt; func_A_29129 -&gt; func_B_19456 -&gt; func_A_29127 -&gt; func_B_19454 -&gt; func_A_29124 -&gt; func_B_19451 -&gt; func_A_29119 -&gt; func_B_19446 -&gt; func_A_29110* -&gt; func_B_19437 -&gt; func_A_29098* -&gt; func_B_19425 -&gt; func_A_29078* -&gt; func_B_19405 -&gt; func_A_29046* -&gt; func_B_19373 -&gt; func_A_28997* -&gt; func_B_19324 -&gt; func_A_28922* -&gt; func_B_19249 -&gt; func_A_28814* -&gt; func_B_19141 -&gt; func_A_28650* -&gt; func_B_18977 -&gt; func_A_28403* -&gt; func_B_18730 -&gt; func_A_28037* -&gt; func_B_18364 -&gt; func_A_27475* -&gt; func_B_17802 -&gt; func_A_26636* -&gt; func_B_16963 -&gt; func_A_25362*-&gt; func_B_15689 -&gt; func_A_23492* -&gt; func_B_13819 -&gt; func_A_20708* -&gt; func_B_11035 -&gt; func_A_16548*</span><br><span class="line">  Activation started from: func_B_19446</span><br><span class="line">  Activated weights: [5783, -7171, -1733, -3415, 7703, -8204, 2875, 7495, 7641, -183, -7455, 3473, 2466, -17, 2740, -5885]</span><br><span class="line">  Final weight: 6113</span><br><span class="line">  Hash result: 0x18c3d466784b5624</span><br></pre></td></tr></table></figure>

<p>进行约束的A有16个（连同parse刚好17个）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func_A_29110* func_A_29098* func_A_29078* func_A_29046*</span><br><span class="line">func_A_28997* func_A_28922* func_A_28814* func_A_28650*</span><br><span class="line">func_A_28403* func_A_28037* func_A_27475* func_A_26636*</span><br><span class="line">func_A_25362* func_A_23492* func_A_20708* func_A_16548*</span><br></pre></td></tr></table></figure>

<p>提取这些func_A中的约束（连同parse）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hashfunc</span>(<span class="params">a, b</span>):</span><br><span class="line">    v4 = (((a &lt;&lt; <span class="number">8</span>) | b) - <span class="number">0x61C88647</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    tmp = (<span class="number">0x85EBCA6B</span> * (v4 ^ HIWORD(v4))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    v5 = (<span class="number">0xC2B2AE35</span> * (tmp ^ (tmp &gt;&gt; <span class="number">13</span>)))</span><br><span class="line">    <span class="keyword">return</span> v5 &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">HIWORD</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">LOWORD</span>(<span class="params">x</span>): <span class="keyword">return</span> x &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># func_A_29110</span></span><br><span class="line"><span class="keyword">assert</span> flag[<span class="number">6</span>] ^ ((flag[<span class="number">9</span>] &gt;&gt; <span class="number">1</span>) + <span class="number">2</span> * flag[<span class="number">12</span>]) == <span class="number">0xD9</span></span><br><span class="line"><span class="comment"># func_A_29098</span></span><br><span class="line">v5 = hashfunc(flag[<span class="number">6</span>], flag[<span class="number">15</span>])</span><br><span class="line"><span class="keyword">assert</span> HIWORD(v5) ^ LOWORD(v5) == <span class="number">0x885B</span></span><br><span class="line"><span class="comment"># func_A_29078</span></span><br><span class="line"><span class="keyword">assert</span> (flag[<span class="number">3</span>] * (flag[<span class="number">8</span>] + <span class="number">3</span>)) ^ (<span class="number">2</span> * flag[<span class="number">5</span>]) == <span class="number">0xB4</span></span><br><span class="line"><span class="comment"># func_A_29046</span></span><br><span class="line"><span class="keyword">assert</span> ((<span class="number">3</span> * flag[<span class="number">9</span>]) ^ (flag[<span class="number">6</span>] + flag[<span class="number">2</span>])) + <span class="number">17</span> == <span class="number">0x71</span></span><br><span class="line"><span class="comment"># func_A_28997</span></span><br><span class="line"><span class="keyword">assert</span> (flag[<span class="number">4</span>] ^ flag[<span class="number">10</span>]) + <span class="number">2</span> * flag[<span class="number">5</span>] == <span class="number">0xF7</span></span><br><span class="line"><span class="comment"># func_A_28922</span></span><br><span class="line">v5 = hashfunc(flag[<span class="number">10</span>], flag[<span class="number">13</span>])</span><br><span class="line"><span class="keyword">assert</span> HIWORD(v5) ^ LOWORD(v5) == <span class="number">0x13DE</span></span><br><span class="line"><span class="comment"># func_A_28814</span></span><br><span class="line"><span class="keyword">assert</span> (flag[<span class="number">4</span>] * (flag[<span class="number">7</span>] + <span class="number">3</span>)) ^ (<span class="number">2</span> * flag[<span class="number">16</span>]) == <span class="number">0x25</span></span><br><span class="line"><span class="comment"># func_A_28650 (无效项)</span></span><br><span class="line"><span class="keyword">assert</span> <span class="keyword">not</span> flag[<span class="number">8</span>] == (flag[<span class="number">1</span>] == <span class="number">3</span>)</span><br><span class="line"><span class="comment"># func_A_28403</span></span><br><span class="line">v5 = hashfunc(flag[<span class="number">11</span>], flag[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">assert</span> HIWORD(v5) ^ LOWORD(v5) == <span class="number">0xD9B4</span></span><br><span class="line"><span class="comment"># func_A_28037</span></span><br><span class="line"><span class="keyword">assert</span> (flag[<span class="number">10</span>] * (flag[<span class="number">15</span>] + <span class="number">3</span>)) ^ (<span class="number">2</span> * flag[<span class="number">11</span>]) == <span class="number">0x64</span></span><br><span class="line"><span class="comment"># func_A_27475</span></span><br><span class="line"><span class="keyword">assert</span> ((<span class="number">3</span> * flag[<span class="number">11</span>]) ^ (flag[<span class="number">1</span>] + flag[<span class="number">16</span>])) + <span class="number">17</span> == <span class="number">0xF1</span></span><br><span class="line"><span class="comment"># func_A_26636</span></span><br><span class="line"><span class="keyword">assert</span> (flag[<span class="number">1</span>] ^ flag[<span class="number">2</span>]) + <span class="number">2</span> * flag[<span class="number">16</span>] == <span class="number">0x0D</span></span><br><span class="line"><span class="comment"># func_A_25362</span></span><br><span class="line">v5 = hashfunc(flag[<span class="number">0</span>], flag[<span class="number">13</span>])</span><br><span class="line"><span class="keyword">assert</span> HIWORD(v5) ^ LOWORD(v5) == <span class="number">0xE64D</span></span><br><span class="line"><span class="comment"># func_A_23492</span></span><br><span class="line"><span class="keyword">assert</span> (flag[<span class="number">0</span>] * (flag[<span class="number">7</span>] + <span class="number">3</span>)) ^ (<span class="number">2</span> * flag[<span class="number">16</span>]) == <span class="number">0x91</span></span><br><span class="line"><span class="comment"># func_A_20708</span></span><br><span class="line"><span class="keyword">assert</span> flag[<span class="number">14</span>] ^ flag[<span class="number">2</span>] == <span class="number">0x54</span></span><br><span class="line"><span class="comment"># func_A_16548</span></span><br><span class="line">v5 = hashfunc(flag[<span class="number">0</span>], flag[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">assert</span> HIWORD(v5) ^ LOWORD(v5) == <span class="number">0xC3DD</span></span><br><span class="line"><span class="comment"># parse</span></span><br><span class="line"><span class="keyword">assert</span> flag[<span class="number">14</span>] ^ ((flag[<span class="number">4</span>] &gt;&gt; <span class="number">1</span>) + <span class="number">2</span> * flag[<span class="number">0</span>]) == <span class="number">0xD0</span></span><br></pre></td></tr></table></figure>

<p>注意到约束是欠定的（17项flag，16个有效约束），求所有解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">HIWORD</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">LOWORD</span>(<span class="params">x</span>): <span class="keyword">return</span> x &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hashfunc</span>(<span class="params">a, b</span>):</span><br><span class="line">    v4 = (((b &lt;&lt; <span class="number">8</span>) | a) - <span class="number">0x61C88647</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    tmp = (<span class="number">0x85EBCA6B</span> * (v4 ^ HIWORD(v4))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    v5 = (<span class="number">0xC2B2AE35</span> * (tmp ^ (tmp &gt;&gt; <span class="number">13</span>))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> v5</span><br><span class="line"></span><br><span class="line">chars = []</span><br><span class="line">chars.extend(<span class="built_in">range</span>(<span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;Z&#x27;</span>) + <span class="number">1</span>))</span><br><span class="line">chars.extend(<span class="built_in">range</span>(<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;z&#x27;</span>) + <span class="number">1</span>))</span><br><span class="line">chars.extend(<span class="built_in">range</span>(<span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;9&#x27;</span>) + <span class="number">1</span>))</span><br><span class="line">chars.append(<span class="built_in">ord</span>(<span class="string">&#x27;_&#x27;</span>))</span><br><span class="line"></span><br><span class="line">hash_constraints = [</span><br><span class="line">    (<span class="string">&quot;func_A_29098&quot;</span>, <span class="number">0x885B</span>, <span class="string">&quot;flag[6], flag[15]&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;func_A_28922&quot;</span>, <span class="number">0x13DE</span>, <span class="string">&quot;flag[10], flag[13]&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;func_A_28403&quot;</span>, <span class="number">0xD9B4</span>, <span class="string">&quot;flag[11], flag[2]&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;func_A_25362&quot;</span>, <span class="number">0xE64D</span>, <span class="string">&quot;flag[0], flag[13]&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;func_A_16548&quot;</span>, <span class="number">0xC3DD</span>, <span class="string">&quot;flag[0], flag[2]&quot;</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">hash_solutions = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> name, expected, param_desc <span class="keyword">in</span> hash_constraints:</span><br><span class="line">    solutions = []</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> chars:</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> chars:</span><br><span class="line">            <span class="keyword">for</span> order, (p1, p2) <span class="keyword">in</span> <span class="built_in">enumerate</span>([(a, b), (b, a)]):</span><br><span class="line">                v5 = hashfunc(p1, p2)</span><br><span class="line">                result = HIWORD(v5) ^ LOWORD(v5)</span><br><span class="line">                <span class="keyword">if</span> result == expected: solutions.append((p1, p2, order))</span><br><span class="line">    hash_solutions[name] = solutions</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_valid_char</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        (c &gt;= <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) <span class="keyword">and</span> c &lt;= <span class="built_in">ord</span>(<span class="string">&#x27;Z&#x27;</span>)) <span class="keyword">or</span></span><br><span class="line">        (c &gt;= <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>) <span class="keyword">and</span> c &lt;= <span class="built_in">ord</span>(<span class="string">&#x27;z&#x27;</span>)) <span class="keyword">or</span></span><br><span class="line">        (c &gt;= <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>) <span class="keyword">and</span> c &lt;= <span class="built_in">ord</span>(<span class="string">&#x27;9&#x27;</span>)) <span class="keyword">or</span></span><br><span class="line">        (c == <span class="built_in">ord</span>(<span class="string">&#x27;_&#x27;</span>))</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_all</span>():</span><br><span class="line">    flag = [BitVec(<span class="string">f&#x27;flag_<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">17</span>)]</span><br><span class="line">    s = Solver()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">17</span>):</span><br><span class="line">        char_constraints = Or([flag[i] == c <span class="keyword">for</span> c <span class="keyword">in</span> chars])</span><br><span class="line">        s.add(char_constraints)</span><br><span class="line">    s.add(flag[<span class="number">6</span>] ^ ((flag[<span class="number">9</span>] &gt;&gt; <span class="number">1</span>) + <span class="number">2</span> * flag[<span class="number">12</span>]) == <span class="number">0xD9</span>)  <span class="comment"># func_A_29110</span></span><br><span class="line">    s.add((flag[<span class="number">3</span>] * (flag[<span class="number">8</span>] + <span class="number">3</span>)) ^ (<span class="number">2</span> * flag[<span class="number">5</span>]) == <span class="number">0xB4</span>)  <span class="comment"># func_A_29078</span></span><br><span class="line">    s.add(((<span class="number">3</span> * flag[<span class="number">9</span>]) ^ (flag[<span class="number">6</span>] + flag[<span class="number">2</span>])) + <span class="number">17</span> == <span class="number">0x71</span>)  <span class="comment"># func_A_29046</span></span><br><span class="line">    s.add((flag[<span class="number">4</span>] ^ flag[<span class="number">10</span>]) + <span class="number">2</span> * flag[<span class="number">5</span>] == <span class="number">0xF7</span>)  <span class="comment"># func_A_28997</span></span><br><span class="line">    s.add((flag[<span class="number">4</span>] * (flag[<span class="number">7</span>] + <span class="number">3</span>)) ^ (<span class="number">2</span> * flag[<span class="number">16</span>]) == <span class="number">0x25</span>)  <span class="comment"># func_A_28814</span></span><br><span class="line">    s.add((flag[<span class="number">10</span>] * (flag[<span class="number">15</span>] + <span class="number">3</span>)) ^ (<span class="number">2</span> * flag[<span class="number">11</span>]) == <span class="number">0x64</span>)  <span class="comment"># func_A_28037</span></span><br><span class="line">    s.add(((<span class="number">3</span> * flag[<span class="number">11</span>]) ^ (flag[<span class="number">1</span>] + flag[<span class="number">16</span>])) + <span class="number">17</span> == <span class="number">0xF1</span>)  <span class="comment"># func_A_27475</span></span><br><span class="line">    s.add((flag[<span class="number">1</span>] ^ flag[<span class="number">2</span>]) + <span class="number">2</span> * flag[<span class="number">16</span>] == <span class="number">0x0D</span>)  <span class="comment"># func_A_26636</span></span><br><span class="line">    s.add((flag[<span class="number">0</span>] * (flag[<span class="number">7</span>] + <span class="number">3</span>)) ^ (<span class="number">2</span> * flag[<span class="number">16</span>]) == <span class="number">0x91</span>)  <span class="comment"># func_A_23492</span></span><br><span class="line">    s.add(flag[<span class="number">14</span>] ^ flag[<span class="number">2</span>] == <span class="number">0x54</span>)  <span class="comment"># func_A_20708</span></span><br><span class="line">    s.add(flag[<span class="number">14</span>] ^ ((flag[<span class="number">4</span>] &gt;&gt; <span class="number">1</span>) + <span class="number">2</span> * flag[<span class="number">0</span>]) == <span class="number">0xD0</span>)  <span class="comment"># parse</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_hash_constraint</span>(<span class="params">solver, solutions, flag_indices</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> solutions:  <span class="keyword">return</span></span><br><span class="line">        constraints = []</span><br><span class="line">        <span class="keyword">for</span> sol <span class="keyword">in</span> solutions:</span><br><span class="line">            a, b, order = sol</span><br><span class="line">            <span class="keyword">if</span> order == <span class="number">0</span>:  constraints.append(And(flag[flag_indices[<span class="number">0</span>]] == a, flag[flag_indices[<span class="number">1</span>]] == b))</span><br><span class="line">            <span class="keyword">else</span>:  constraints.append(And(flag[flag_indices[<span class="number">0</span>]] == b, flag[flag_indices[<span class="number">1</span>]] == a))</span><br><span class="line">        <span class="keyword">if</span> constraints:  solver.add(Or(constraints))</span><br><span class="line">    <span class="keyword">if</span> hash_solutions.get(<span class="string">&quot;func_A_29098&quot;</span>):  add_hash_constraint(s, hash_solutions[<span class="string">&quot;func_A_29098&quot;</span>], [<span class="number">6</span>, <span class="number">15</span>])</span><br><span class="line">    <span class="keyword">if</span> hash_solutions.get(<span class="string">&quot;func_A_28922&quot;</span>):  add_hash_constraint(s, hash_solutions[<span class="string">&quot;func_A_28922&quot;</span>], [<span class="number">10</span>, <span class="number">13</span>])</span><br><span class="line">    <span class="keyword">if</span> hash_solutions.get(<span class="string">&quot;func_A_28403&quot;</span>):  add_hash_constraint(s, hash_solutions[<span class="string">&quot;func_A_28403&quot;</span>], [<span class="number">11</span>, <span class="number">2</span>])</span><br><span class="line">    <span class="keyword">if</span> hash_solutions.get(<span class="string">&quot;func_A_25362&quot;</span>):  add_hash_constraint(s, hash_solutions[<span class="string">&quot;func_A_25362&quot;</span>], [<span class="number">0</span>, <span class="number">13</span>])</span><br><span class="line">    <span class="keyword">if</span> hash_solutions.get(<span class="string">&quot;func_A_16548&quot;</span>):  add_hash_constraint(s, hash_solutions[<span class="string">&quot;func_A_16548&quot;</span>], [<span class="number">0</span>, <span class="number">2</span>])</span><br><span class="line">    solutions = []</span><br><span class="line">    solution_count = <span class="number">0</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nSearching for solutions...&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        result = s.check()</span><br><span class="line">        <span class="keyword">if</span> result == sat:</span><br><span class="line">            solution_count += <span class="number">1</span></span><br><span class="line">            model = s.model()</span><br><span class="line">            flag_values = [model[flag[i]].as_long() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">17</span>)]</span><br><span class="line">            all_valid = <span class="built_in">all</span>(is_valid_char(v) <span class="keyword">for</span> v <span class="keyword">in</span> flag_values)</span><br><span class="line">            flag_string = <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">chr</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> flag_values])</span><br><span class="line">            solutions.append((flag_values, flag_string))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Solution <span class="subst">&#123;solution_count&#125;</span>: RCTF&#123;&#123;<span class="subst">&#123;flag_string&#125;</span>&#125;&#125;&quot;</span>)</span><br><span class="line">            exclude_constraint = Or([flag[i] != flag_values[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">17</span>)])</span><br><span class="line">            s.add(exclude_constraint)</span><br><span class="line">        <span class="keyword">else</span>: <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nTotal solutions found: <span class="subst">&#123;<span class="built_in">len</span>(solutions)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> solutions</span><br><span class="line"></span><br><span class="line">all_solutions = solve_all()</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\n=== All Solutions ===&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i, (values, string) <span class="keyword">in</span> <span class="built_in">enumerate</span>(all_solutions):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Solution <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;[<span class="built_in">chr</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> values]&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;ASCII values: <span class="subst">&#123;values&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Flag: RCTF&#123;&#123;<span class="subst">&#123;string&#125;</span>&#125;&#125;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong>RCTF{Ct1l_fL0w_th3_eNd}</strong></font></p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2025/12/30/2025_end/"
      title="2025年 年末回顾"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        2025年 年末回顾
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2025/11/10/info_25_disthis/"
      title="Infobahn CTF 2025 Reverse-disthis WriteUp"
     >

    <p class="title-text">
      
        Infobahn CTF 2025 Reverse-disthis WriteUp
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2026 Astral Prisma<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
