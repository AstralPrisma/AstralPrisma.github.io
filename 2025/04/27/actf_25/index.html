<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>ACTF 2025 WriteUp (Reverse方向) | 棱晶の小窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="re出题人怎么这么喜欢矩阵，FPGA和deeptx都属于恢复出来逻辑不好逆的 ezFPGA：查了查FPGA的相关知识，先用Digital-IDE查看vcd信号： 提取密文：AD00C09F1617EC25251F12E27F9F375312BA8D3860141B318E13E2560A1A25B980738A60 从encryptor恢复加密逻辑： 12345678910111213141516">
<meta property="og:type" content="article">
<meta property="og:title" content="ACTF 2025 WriteUp (Reverse方向)">
<meta property="og:url" content="https://astralprisma.github.io/2025/04/27/actf_25/index.html">
<meta property="og:site_name" content="棱晶の小窝">
<meta property="og:description" content="re出题人怎么这么喜欢矩阵，FPGA和deeptx都属于恢复出来逻辑不好逆的 ezFPGA：查了查FPGA的相关知识，先用Digital-IDE查看vcd信号： 提取密文：AD00C09F1617EC25251F12E27F9F375312BA8D3860141B318E13E2560A1A25B980738A60 从encryptor恢复加密逻辑： 12345678910111213141516">
<meta property="og:locale">
<meta property="og:image" content="https://astralprisma.github.io/source/pictures/actf25_signal.png">
<meta property="og:image" content="https://astralprisma.github.io/source/pictures/actf25_motionblur.bmp">
<meta property="og:image" content="https://astralprisma.github.io/source/pictures/actf25_motionrecover.jpg">
<meta property="article:published_time" content="2025-04-27T09:00:00.000Z">
<meta property="article:modified_time" content="2025-04-27T09:49:38.356Z">
<meta property="article:author" content="Astral Prisma">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://astralprisma.github.io/source/pictures/actf25_signal.png">
  
  
    <link rel="shortcut icon" href="/XH.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/OTSA.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>棱晶の小窝 </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/AP.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Astral Prisma </div>
      <div class="dot"></div>
      <div class="subtitle">星界棱晶 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/454936579" title="Bilibili"><image src=https://www.bilibili.com/favicon.ico></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://www.primegrid.com/show_user.php?userid=1243718" title="PrimeGrid"><image src=https://www.primegrid.com/images/favicon_32.png></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/AstralPrisma" title="GitHub"><image src=https://github.githubassets.com/favicons/favicon.png></image></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/Ideas/">
                Ideas
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/WriteUp/">
                WriteUp
                <div class="category-count">20</div>
            </a>
        </div>
    </div>
  </div>


    
      

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-actf_25" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        ACTF 2025 WriteUp (Reverse方向)
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2025-04-27T09:00:00.000Z" itemprop="datePublished">2025-04-27</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/WriteUp/">WriteUp</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            7.5k words 
          </div>
        </div>
        
      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <p><del><em>re出题人怎么这么喜欢矩阵，FPGA和deeptx都属于恢复出来逻辑不好逆的</em></del></p>
<h1 id="ezFPGA："><a href="#ezFPGA：" class="headerlink" title="ezFPGA："></a>ezFPGA：</h1><p>查了查FPGA的相关知识，先用Digital-IDE查看vcd信号：<br><img src="/pictures/actf25_signal.png" title="actf25sig"></p>
<p>提取密文：<font color=lime><strong>AD00C09F1617EC25251F12E27F9F375312BA8D3860141B318E13E2560A1A25B980738A60</strong></font></p>
<p>从encryptor恢复加密逻辑：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> Encryptor#(</span><br><span class="line">    <span class="keyword">parameter</span> <span class="keyword">logic</span> [<span class="number">7</span>:<span class="number">0</span>] FLAG [<span class="number">0</span>:<span class="number">13</span>] = &#123;</span><br><span class="line">        <span class="string">&quot;A&quot;</span>, <span class="string">&quot;C&quot;</span>, <span class="string">&quot;T&quot;</span>, <span class="string">&quot;F&quot;</span>, <span class="string">&quot;&#123;&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;s&quot;</span>, <span class="string">&quot;t&quot;</span>, <span class="string">&quot;f&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;g&quot;</span>, <span class="string">&quot;&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">)(</span><br><span class="line">    <span class="keyword">input</span> rst,</span><br><span class="line">    <span class="keyword">input</span> clk,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">7</span>:<span class="number">0</span>] cypher</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">logic</span> [<span class="number">7</span>:<span class="number">0</span>] uint8_t;</span><br><span class="line">    <span class="keyword">localparam</span> l = <span class="built_in">$size</span>(FLAG);</span><br><span class="line"></span><br><span class="line">    uint8_t aa [<span class="number">38</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">genvar</span> i;</span><br><span class="line">    <span class="keyword">generate</span></span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; l; i++) <span class="keyword">begin</span> : gen</span><br><span class="line">            <span class="keyword">assign</span> aa[i] = FLAG[i];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">for</span> (i = l; i &lt; <span class="number">39</span>; i++) <span class="keyword">begin</span> : gen</span><br><span class="line">            <span class="keyword">assign</span> aa[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endgenerate</span></span><br><span class="line"></span><br><span class="line">    uint8_t ab [<span class="number">0</span>:<span class="number">3</span>] = &#123;<span class="number">11</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">14</span>&#125;;</span><br><span class="line">    uint8_t ac [<span class="number">35</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">generate</span></span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">36</span>; i++) <span class="keyword">begin</span> : gen</span><br><span class="line">            <span class="keyword">assign</span> ac[i] = aa[i]*ab[<span class="number">0</span>] + aa[i+<span class="number">1</span>]*ab[<span class="number">1</span>] + aa[i+<span class="number">2</span>]*ab[<span class="number">2</span>] + aa[i+<span class="number">3</span>]*ab[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endgenerate</span></span><br><span class="line"></span><br><span class="line">    uint8_t ad [<span class="number">0</span>:<span class="number">35</span>] = &#123;<span class="number">116</span>,<span class="number">174</span>,<span class="number">193</span>,<span class="number">124</span>,<span class="number">102</span>,<span class="number">100</span>,<span class="number">11</span>,<span class="number">193</span>,<span class="number">115</span>,<span class="number">4</span>,<span class="number">127</span>,<span class="number">139</span>,<span class="number">98</span>,<span class="number">214</span>,<span class="number">197</span>,<span class="number">145</span>,<span class="number">97</span>,<span class="number">151</span>,<span class="number">31</span>,<span class="number">30</span>,<span class="number">117</span>,<span class="number">15</span>,<span class="number">230</span>,<span class="number">179</span>,<span class="number">235</span>,<span class="number">25</span>,<span class="number">244</span>,<span class="number">202</span>,<span class="number">73</span>,<span class="number">222</span>,<span class="number">15</span>,<span class="number">191</span>,<span class="number">119</span>,<span class="number">140</span>,<span class="number">94</span>,<span class="number">32</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    uint8_t ae [<span class="number">35</span>:<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">generate</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">36</span>; i = i + <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">assign</span> ae[i] = ac[i/<span class="number">6</span>*<span class="number">6</span>]*ad[i%<span class="number">6</span>]+ac[i/<span class="number">6</span>*<span class="number">6</span>+<span class="number">1</span>]*ad[i%<span class="number">6</span>+<span class="number">6</span>]+ac[i/<span class="number">6</span>*<span class="number">6</span>+<span class="number">2</span>]*ad[i%<span class="number">6</span>+<span class="number">12</span>]+ac[i/<span class="number">6</span>*<span class="number">6</span>+<span class="number">3</span>]*ad[i%<span class="number">6</span>+<span class="number">18</span>]+ac[i/<span class="number">6</span>*<span class="number">6</span>+<span class="number">4</span>]*ad[i%<span class="number">6</span>+<span class="number">24</span>]+ac[i/<span class="number">6</span>*<span class="number">6</span>+<span class="number">5</span>]*ad[i%<span class="number">6</span>+<span class="number">30</span>];</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">endgenerate</span></span><br><span class="line"></span><br><span class="line">    uint8_t af[<span class="number">35</span>:<span class="number">0</span>];</span><br><span class="line">    uint8_t ba[<span class="number">255</span>:<span class="number">0</span>];</span><br><span class="line">    uint8_t ca,cb,cd,ce,cf,cg,ch;</span><br><span class="line">    uint8_t da;</span><br><span class="line">    uint8_t db[<span class="number">0</span>:<span class="number">7</span>] = &#123;<span class="string">&quot;e&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;l&quot;</span>,<span class="string">&quot;i&quot;</span>,<span class="string">&quot;p&quot;</span>,<span class="string">&quot;s&quot;</span>,<span class="string">&quot;k&quot;</span>,<span class="string">&quot;y&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="keyword">logic</span>[<span class="number">1</span>:<span class="number">0</span>] &#123;S0,S1,S2,S3&#125; state_t;</span><br><span class="line">    state_t state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> cd = ca + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">assign</span> ce = cb + ba[cd];</span><br><span class="line">    <span class="keyword">assign</span> cf = ba[cd] + ba[ce];</span><br><span class="line">    <span class="keyword">assign</span> ch = cg + ba[da] + db[da%<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @( <span class="keyword">posedge</span> clk <span class="keyword">or</span> <span class="keyword">posedge</span> rst) <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> (rst) <span class="keyword">begin</span></span><br><span class="line">            ca &lt;= <span class="number">0</span>;</span><br><span class="line">            cb &lt;= <span class="number">0</span>;</span><br><span class="line">            cg &lt;= <span class="number">0</span>;</span><br><span class="line">            da &lt;= <span class="number">0</span>;</span><br><span class="line">            cypher &lt;= <span class="number">0</span>;</span><br><span class="line">            state &lt;= S1;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">case</span> (state)</span><br><span class="line">                S0: <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span> (da != <span class="number">8&#x27;d255</span>) <span class="keyword">begin</span></span><br><span class="line">                        ba[da] &lt;= da;</span><br><span class="line">                        da &lt;= da + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                        ba[da] &lt;= da;</span><br><span class="line">                        da &lt;= <span class="number">0</span>;</span><br><span class="line">                        state &lt;= S1;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                S1: <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span> (da != <span class="number">8&#x27;d255</span>) <span class="keyword">begin</span></span><br><span class="line">                        ba[da] &lt;= ba[ch];</span><br><span class="line">                        ba[ch] &lt;= ba[da];</span><br><span class="line">                        cg &lt;= ch;</span><br><span class="line">                        da &lt;= da + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                        ba[da] &lt;= ba[ch];</span><br><span class="line">                        ba[ch] &lt;= ba[da];</span><br><span class="line">                        da &lt;= <span class="number">0</span>;</span><br><span class="line">                        state &lt;= S2;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                S2: <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span> (da &lt; <span class="number">36</span>) <span class="keyword">begin</span></span><br><span class="line">                        ba[cd] &lt;= ba[ce];</span><br><span class="line">                        ba[ce] &lt;= ba[cd];</span><br><span class="line">                        af[da[<span class="number">5</span>:<span class="number">0</span>]] &lt;= ba[cf] + ae[da[<span class="number">5</span>:<span class="number">0</span>]];</span><br><span class="line">                        ca &lt;= cd;</span><br><span class="line">                        cb &lt;= ce;</span><br><span class="line">                        da &lt;= da + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                        da &lt;= <span class="number">0</span>;</span><br><span class="line">                        state &lt;= S3;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                S3: <span class="keyword">begin</span></span><br><span class="line">                    <span class="keyword">if</span> (da &lt; <span class="number">36</span>) <span class="keyword">begin</span></span><br><span class="line">                        cypher &lt;= af[da[<span class="number">5</span>:<span class="number">0</span>]];</span><br><span class="line">                        da &lt;= da + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                        cypher &lt;= <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>
<p>python实现：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">m = <span class="built_in">bytearray</span>(<span class="string">b&quot;ACTF&#123;?????????????????????????????????&#125;&quot;</span>)</span><br><span class="line">c1 = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">36</span>))</span><br><span class="line">c2 = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">36</span>))</span><br><span class="line">c3 = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">36</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    c1[i] = (m[i] * <span class="number">11</span> + m[i+<span class="number">1</span>] * <span class="number">4</span> + m[i+<span class="number">2</span>] * <span class="number">5</span> + m[i+<span class="number">3</span>] * <span class="number">14</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c1)</span><br><span class="line"></span><br><span class="line">k2 = [<span class="number">116</span>, <span class="number">174</span>, <span class="number">193</span>, <span class="number">124</span>, <span class="number">102</span>, <span class="number">100</span>, </span><br><span class="line">       <span class="number">11</span>, <span class="number">193</span>, <span class="number">115</span>,   <span class="number">4</span>, <span class="number">127</span>, <span class="number">139</span>, </span><br><span class="line">       <span class="number">98</span>, <span class="number">214</span>, <span class="number">197</span>, <span class="number">145</span>,  <span class="number">97</span>, <span class="number">151</span>, </span><br><span class="line">       <span class="number">31</span>,  <span class="number">30</span>, <span class="number">117</span>,  <span class="number">15</span>, <span class="number">230</span>, <span class="number">179</span>, </span><br><span class="line">      <span class="number">235</span>,  <span class="number">25</span>, <span class="number">244</span>, <span class="number">202</span>,  <span class="number">73</span>, <span class="number">222</span>, </span><br><span class="line">       <span class="number">15</span>, <span class="number">191</span>, <span class="number">119</span>, <span class="number">140</span>,  <span class="number">94</span>,  <span class="number">32</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    ttl = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        ttl += c1[i // <span class="number">6</span> * <span class="number">6</span> + j] * k2[i % <span class="number">6</span> + <span class="number">6</span> * j]</span><br><span class="line">    c2[i] = ttl &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c2)</span><br><span class="line"></span><br><span class="line">k3 = <span class="built_in">bytearray</span>(<span class="string">b&quot;eclipsky&quot;</span>)</span><br><span class="line">sbox = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + sbox[i] + k3[i % <span class="number">8</span>]) &amp; <span class="number">0xFF</span></span><br><span class="line">    sbox[i], sbox[j] = sbox[j], sbox[i]</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">    j = (j + sbox[i]) % <span class="number">256</span></span><br><span class="line">    sbox[i], sbox[j] = sbox[j], sbox[i]</span><br><span class="line">    c3[p] = sbox[(sbox[i] + sbox[j]) % <span class="number">256</span>] + c2[p]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(c3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># c3 = bytearray.fromhex(b&quot;AD00C09F1617EC25251F12E27F9F375312BA8D3860141B318E13E2560A1A25B980738A60&quot;)</span></span><br></pre></td></tr></table></figure>
<p>编写脚本解密：</p>
<p>RC4阶段：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">enc = <span class="built_in">bytearray</span>.fromhex(<span class="string">&quot;AD00C09F1617EC25251F12E27F9F375312BA8D3860141B318E13E2560A1A25B980738A60&quot;</span>)</span><br><span class="line">de3 = <span class="built_in">bytearray</span>(<span class="number">36</span>)</span><br><span class="line"></span><br><span class="line">k3 = <span class="built_in">bytearray</span>(<span class="string">b&quot;eclipsky&quot;</span>)</span><br><span class="line">sbox = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    j = (j + sbox[i] + k3[i % <span class="number">8</span>]) &amp; <span class="number">0xFF</span></span><br><span class="line">    sbox[i], sbox[j] = sbox[j], sbox[i]</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">j = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">    j = (j + sbox[i]) % <span class="number">256</span></span><br><span class="line">    sbox[i], sbox[j] = sbox[j], sbox[i]</span><br><span class="line">    de3[p] = (enc[p] - sbox[(sbox[i] + sbox[j]) % <span class="number">256</span>]) &amp; <span class="number">0xFF</span></span><br><span class="line"><span class="built_in">print</span>(de3.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>
<p>得到c2：<font color=LimeGreen><strong>6b01bf6dbc164991f3eb4c714ef0c0c546f87d51523d8b8e4ed8a2b233e3f4875287c322</strong></font></p>
<p>矩阵阶段：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">k2 = [<span class="number">116</span>, <span class="number">174</span>, <span class="number">193</span>, <span class="number">124</span>, <span class="number">102</span>, <span class="number">100</span>, </span><br><span class="line">       <span class="number">11</span>, <span class="number">193</span>, <span class="number">115</span>,   <span class="number">4</span>, <span class="number">127</span>, <span class="number">139</span>, </span><br><span class="line">       <span class="number">98</span>, <span class="number">214</span>, <span class="number">197</span>, <span class="number">145</span>,  <span class="number">97</span>, <span class="number">151</span>, </span><br><span class="line">       <span class="number">31</span>,  <span class="number">30</span>, <span class="number">117</span>,  <span class="number">15</span>, <span class="number">230</span>, <span class="number">179</span>, </span><br><span class="line">      <span class="number">235</span>,  <span class="number">25</span>, <span class="number">244</span>, <span class="number">202</span>,  <span class="number">73</span>, <span class="number">222</span>, </span><br><span class="line">       <span class="number">15</span>, <span class="number">191</span>, <span class="number">119</span>, <span class="number">140</span>,  <span class="number">94</span>,  <span class="number">32</span>]</span><br><span class="line"></span><br><span class="line">c2_hex = <span class="string">&quot;6b01bf6dbc164991f3eb4c714ef0c0c546f87d51523d8b8e4ed8a2b233e3f4875287c322&quot;</span></span><br><span class="line">c2 = [<span class="built_in">int</span>(c2_hex[i:i+<span class="number">2</span>], <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(c2_hex), <span class="number">2</span>)]</span><br><span class="line">solver = Solver()</span><br><span class="line">c1 = [BitVec(<span class="string">f&#x27;c1_<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    ttl = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        ttl += c1[i // <span class="number">6</span> * <span class="number">6</span> + j] * k2[i % <span class="number">6</span> + <span class="number">6</span> * j]</span><br><span class="line">    solver.add(ttl &amp; <span class="number">0xFF</span> == c2[i])</span><br><span class="line"><span class="keyword">if</span> solver.check() == sat:</span><br><span class="line">    model = solver.model()</span><br><span class="line">    c1_solution = [model[c1[i]].as_long() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;c1 =&quot;</span>, c1_solution)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;无解&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>得到c1：<font color=yellow><strong>[79, 73, 151, 50, 184, 200, 100, 192, 131, 26, 249, 134, 159, 51, 3, 110, 114, 221, 227, 53, 217, 14, 87, 183, 172, 111, 194, 28, 122, 221, 22, 117, 218, 95, 0, 0]</strong></font></p>
<p>加权求和阶段：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">c1 = [<span class="number">79</span>, <span class="number">73</span>, <span class="number">151</span>, <span class="number">50</span>, <span class="number">184</span>, <span class="number">200</span>, <span class="number">100</span>, <span class="number">192</span>, <span class="number">131</span>, <span class="number">26</span>, <span class="number">249</span>, <span class="number">134</span>, </span><br><span class="line">      <span class="number">159</span>, <span class="number">51</span>, <span class="number">3</span>, <span class="number">110</span>, <span class="number">114</span>, <span class="number">221</span>, <span class="number">227</span>, <span class="number">53</span>, <span class="number">217</span>, <span class="number">14</span>, <span class="number">87</span>, <span class="number">183</span>, </span><br><span class="line">      <span class="number">172</span>, <span class="number">111</span>, <span class="number">194</span>, <span class="number">28</span>, <span class="number">122</span>, <span class="number">221</span>, <span class="number">22</span>, <span class="number">117</span>, <span class="number">218</span>, <span class="number">95</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">solver = Solver()</span><br><span class="line">m = [BitVec(<span class="string">f&#x27;m_<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">39</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">36</span>):</span><br><span class="line">    solver.add((m[i] * <span class="number">11</span> + m[i+<span class="number">1</span>] * <span class="number">4</span> + m[i+<span class="number">2</span>] * <span class="number">5</span> + m[i+<span class="number">3</span>] * <span class="number">14</span>) &amp; <span class="number">0xFF</span> == c1[i])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> solver.check() == sat:</span><br><span class="line">    model = solver.model()</span><br><span class="line">    m_solution = [model[m[i]].as_long() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">39</span>)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;m =&quot;</span>, m_solution)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;无解&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>得到flag：<font color=deepskyblue><strong>[65, 67, 84, 70, 123, 82, 67, 52, 95, 52, 110, 100, 95, 70, 80, 71, 65, 95, 119, 52, 108, 107, 95, 49, 110, 116, 48, 95, 52, 95, 98, 52, 114, 125, 0, 0, 0, 0, 0]</strong></font></p>
<p>flag：<font color=deepskyblue><strong>ACTF{RC4_4nd_FPGA_w4lk_1nt0_4_b4r}</strong></font>.</p>
<h1 id="deeptx："><a href="#deeptx：" class="headerlink" title="deeptx："></a>deeptx：</h1><p>cuda逆向，查看main：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  _QWORD v5[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-8C0h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *output_ptr; <span class="comment">// [rsp+200h] [rbp-6C0h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *pixel_ptr; <span class="comment">// [rsp+208h] [rbp-6B8h] BYREF</span></span><br><span class="line">  <span class="type">char</span> ptr__1[<span class="number">1024</span>]; <span class="comment">// [rsp+210h] [rbp-6B0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> ptr_[<span class="number">4</span>]; <span class="comment">// [rsp+610h] [rbp-2B0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> n256_1; <span class="comment">// [rsp+614h] [rbp-2ACh]</span></span><br><span class="line">  <span class="type">int</span> n256; <span class="comment">// [rsp+618h] [rbp-2A8h]</span></span><br><span class="line">  __int16 n8; <span class="comment">// [rsp+61Eh] [rbp-2A2h]</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// [rsp+620h] [rbp-2A0h]</span></span><br><span class="line">  <span class="type">char</span> ptr[<span class="number">14</span>]; <span class="comment">// [rsp+642h] [rbp-27Eh] BYREF</span></span><br><span class="line">  _QWORD v15[<span class="number">32</span>]; <span class="comment">// [rsp+650h] [rbp-270h] BYREF</span></span><br><span class="line">  __int64 v16; <span class="comment">// [rsp+750h] [rbp-170h] BYREF</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+858h] [rbp-68h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v18; <span class="comment">// [rsp+860h] [rbp-60h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp+864h] [rbp-5Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v20; <span class="comment">// [rsp+86Ch] [rbp-54h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+870h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v22; <span class="comment">// [rsp+878h] [rbp-48h]</span></span><br><span class="line">  __int64 v23; <span class="comment">// [rsp+87Ch] [rbp-44h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v24; <span class="comment">// [rsp+884h] [rbp-3Ch]</span></span><br><span class="line">  __int64 v25; <span class="comment">// [rsp+888h] [rbp-38h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v26; <span class="comment">// [rsp+890h] [rbp-30h]</span></span><br><span class="line">  __int64 v27; <span class="comment">// [rsp+894h] [rbp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v28; <span class="comment">// [rsp+89Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> *ptr_3; <span class="comment">// [rsp+8A0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *pixel; <span class="comment">// [rsp+8A8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  std::ifstream::<span class="built_in">basic_ifstream</span>(file, <span class="string">&quot;flag.bmp&quot;</span>, <span class="number">4LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)std::ios::<span class="keyword">operator</span>!(&amp;v16) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    std::istream::<span class="built_in">read</span>((std::istream *)file, ptr, <span class="number">14LL</span>);</span><br><span class="line">    std::istream::<span class="built_in">read</span>((std::istream *)file, ptr_, <span class="number">40LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( n256_1 == <span class="number">256</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( n256 == <span class="number">256</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( n8 == <span class="number">8</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v13 )</span><br><span class="line">          &#123;</span><br><span class="line">            v3 = <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            std::istream::<span class="built_in">read</span>((std::istream *)file, ptr__1, <span class="number">1024LL</span>);</span><br><span class="line">            pixel = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x10000uLL</span>);</span><br><span class="line">            ptr_3 = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x10000uLL</span>);</span><br><span class="line">            <span class="built_in">cudaMemcpyToSymbol</span>&lt;<span class="type">unsigned</span> <span class="type">char</span> [<span class="number">256</span>]&gt;(&amp;cuda_sbox, sbox, <span class="number">256LL</span>, <span class="number">0LL</span>, <span class="number">1LL</span>);</span><br><span class="line">            <span class="built_in">cudaMemcpyToSymbol</span>&lt;<span class="type">unsigned</span> <span class="type">char</span> [<span class="number">256</span>]&gt;(&amp;cuda_tbox, tbox, <span class="number">256LL</span>, <span class="number">0LL</span>, <span class="number">1LL</span>);</span><br><span class="line">            <span class="built_in">cudaMemcpyToSymbol</span>&lt;<span class="type">float</span> [<span class="number">256</span>]&gt;((__int64)&amp;cuda_motion, (__int64)motion, <span class="number">1024LL</span>, <span class="number">0LL</span>, <span class="number">1u</span>);</span><br><span class="line">            <span class="built_in">cudaMalloc</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt;(&amp;pixel_ptr, <span class="number">0x10000LL</span>);</span><br><span class="line">            <span class="built_in">cudaMalloc</span>&lt;<span class="type">unsigned</span> <span class="type">char</span>&gt;(&amp;output_ptr, <span class="number">0x10000LL</span>);</span><br><span class="line">            std::istream::<span class="built_in">read</span>((std::istream *)file, pixel, <span class="number">0x10000LL</span>);</span><br><span class="line">            std::ifstream::<span class="built_in">close</span>(file);</span><br><span class="line">            <span class="built_in">cudaMemcpy</span>(pixel_ptr, pixel, <span class="number">0x10000LL</span>, <span class="number">1LL</span>);</span><br><span class="line">            dim3::<span class="built_in">dim3</span>((dim3 *)&amp;v17, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            dim3::<span class="built_in">dim3</span>((dim3 *)&amp;v19, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)_cudaPushCallConfiguration(v19, v20, v17, v18, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">              <span class="built_in">Layer1</span>(pixel_ptr, output_ptr);</span><br><span class="line">            <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line">            dim3::<span class="built_in">dim3</span>((dim3 *)&amp;v21, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            dim3::<span class="built_in">dim3</span>((dim3 *)&amp;v23, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)_cudaPushCallConfiguration(v23, v24, v21, v22, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">              <span class="built_in">Layer2</span>(output_ptr, pixel_ptr);</span><br><span class="line">            <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line">            dim3::<span class="built_in">dim3</span>((dim3 *)&amp;v25, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            dim3::<span class="built_in">dim3</span>((dim3 *)&amp;v27, <span class="number">256</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)_cudaPushCallConfiguration(v27, v28, v25, v26, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">              <span class="built_in">Layer3</span>(pixel_ptr, output_ptr);</span><br><span class="line">            <span class="built_in">cudaDeviceSynchronize</span>();</span><br><span class="line">            <span class="built_in">cudaMemcpy</span>(ptr_3, output_ptr, <span class="number">0x10000LL</span>, <span class="number">2LL</span>);</span><br><span class="line">            std::ofstream::<span class="built_in">basic_ofstream</span>(v5, <span class="string">&quot;deep_flag.bmp&quot;</span>, <span class="number">4LL</span>);</span><br><span class="line">            std::ostream::<span class="built_in">write</span>((std::ostream *)v5, ptr, <span class="number">14LL</span>);</span><br><span class="line">            std::ostream::<span class="built_in">write</span>((std::ostream *)v5, ptr_, <span class="number">40LL</span>);</span><br><span class="line">            std::ostream::<span class="built_in">write</span>((std::ostream *)v5, ptr__1, <span class="number">1024LL</span>);</span><br><span class="line">            std::ostream::<span class="built_in">write</span>((std::ostream *)v5, ptr_3, <span class="number">0x10000LL</span>);</span><br><span class="line">            std::ofstream::<span class="built_in">close</span>(v5);</span><br><span class="line">            <span class="built_in">free</span>(pixel);</span><br><span class="line">            <span class="built_in">free</span>(ptr_3);</span><br><span class="line">            <span class="built_in">cudaFree</span>(pixel_ptr);</span><br><span class="line">            <span class="built_in">cudaFree</span>(output_ptr);</span><br><span class="line">            v3 = <span class="number">0</span>;</span><br><span class="line">            std::ofstream::~<span class="built_in">ofstream</span>(v5);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v3 = <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v3 = <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v3 = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  std::ifstream::~ifstream(v15);</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读取了一个flag.bmp，bmp是纯黑白的，没有rgb颜色，一个像素对应一个0~FF的值，被加密的是bmp中的256*256&#x3D;65536个像素，用layer1、2、3加密了这65536个字节，cuobjdump得到ptx：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line">Fatbin elf code:</span><br><span class="line">================</span><br><span class="line">arch = sm_86</span><br><span class="line">code version = [<span class="number">1</span>,<span class="number">7</span>]</span><br><span class="line">host = linux</span><br><span class="line">compile_size = 64bit</span><br><span class="line"></span><br><span class="line">Fatbin elf code:</span><br><span class="line">================</span><br><span class="line">arch = sm_86</span><br><span class="line">code version = [<span class="number">1</span>,<span class="number">7</span>]</span><br><span class="line">host = linux</span><br><span class="line">compile_size = 64bit</span><br><span class="line"></span><br><span class="line">Fatbin ptx code:</span><br><span class="line">================</span><br><span class="line">arch = sm_86</span><br><span class="line">code version = [<span class="number">8</span>,<span class="number">7</span>]</span><br><span class="line">host = linux</span><br><span class="line">compile_size = 64bit</span><br><span class="line">compressed</span><br><span class="line">ptxasOptions = </span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">//</span><br><span class="line">//</span><br><span class="line">//</span><br><span class="line">//</span><br><span class="line">//</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">.version</span> <span class="number">8.7</span></span><br><span class="line"><span class="meta">.target</span> sm_86</span><br><span class="line"><span class="meta">.address_size</span> <span class="number">64</span></span><br><span class="line"></span><br><span class="line">//</span><br><span class="line"><span class="meta">.const</span> .align <span class="number">1</span> .b8 cuda_sbox[<span class="number">256</span>]<span class="comment">;</span></span><br><span class="line"><span class="meta">.const</span> .align <span class="number">1</span> .b8 cuda_tbox[<span class="number">256</span>]<span class="comment">;</span></span><br><span class="line"><span class="meta">.const</span> .align <span class="number">4</span> .b8 cuda_motion[<span class="number">1024</span>]<span class="comment">;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">.visible</span> .entry _Z6Layer1PhS_(</span><br><span class="line"><span class="meta">.param</span> .u64 _Z6Layer1PhS__param_0,</span><br><span class="line"><span class="meta">.param</span> .u64 _Z6Layer1PhS__param_1</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">.reg</span> .pred %p&lt;<span class="number">6</span>&gt;<span class="comment">;</span></span><br><span class="line"><span class="meta">.reg</span> .b16 %rs&lt;<span class="number">2</span>&gt;<span class="comment">;</span></span><br><span class="line"><span class="meta">.reg</span> .f32 %f&lt;<span class="number">12</span>&gt;<span class="comment">;</span></span><br><span class="line"><span class="meta">.reg</span> .b32 %r&lt;<span class="number">23</span>&gt;<span class="comment">;</span></span><br><span class="line"><span class="meta">.reg</span> .b64 %rd&lt;<span class="number">15</span>&gt;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ld<span class="number">.</span>param<span class="number">.</span>u64 %rd5, [_Z6Layer1PhS__param_0]<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>param<span class="number">.</span>u64 %rd6, [_Z6Layer1PhS__param_1]<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r1, %tid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>lt<span class="number">.</span>u32 %p1, %r1, <span class="number">241</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r2, %ctaid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>lt<span class="number">.</span>u32 %p2, %r2, <span class="number">241</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>pred %p3, %p1, %p2<span class="comment">;</span></span><br><span class="line">@%p3 bra $L__BB0_2<span class="comment">;</span></span><br><span class="line">bra<span class="number">.</span>uni $L__BB0_1<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB0_2:</span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r3, %ntid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line">cvta<span class="number">.</span>to<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u64 %rd1, %rd5<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>f32 %f10, 0f00000000<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r11, <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u64 %rd8, cuda_motion<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r20, %r11<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB0_3:</span><br><span class="line"><span class="meta">.pragma</span> <span class="string">&quot;nounroll&quot;</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r13, %r20, %r2<span class="comment">;</span></span><br><span class="line"><span class="keyword">shl</span><span class="number">.</span>b32 %r14, %r20, <span class="number">4</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r15, <span class="number">240</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">sub</span><span class="number">.</span>s32 %r16, %r15, %r14<span class="comment">;</span></span><br><span class="line">mad<span class="number">.</span>lo<span class="number">.</span>s32 %r21, %r13, %r3, %r1<span class="comment">;</span></span><br><span class="line"><span class="keyword">mul</span><span class="number">.</span>wide<span class="number">.</span>u32 %rd7, %r16, <span class="number">4</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd14, %rd8, %rd7<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r22, %r11<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB0_4:</span><br><span class="line"><span class="meta">.pragma</span> <span class="string">&quot;nounroll&quot;</span><span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd9, %r21<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd10, %rd1, %rd9<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 %rs1, [%rd10]<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>rn<span class="number">.</span>f32<span class="number">.</span>u16 %f7, %rs1<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>f32 %f8, [%rd14]<span class="comment">;</span></span><br><span class="line">fma<span class="number">.</span>rn<span class="number">.</span>f32 %f10, %f8, %f7, %f10<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r21, %r21, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd14, %rd14, <span class="number">4</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r22, %r22, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>ne<span class="number">.</span>s32 %p4, %r22, <span class="number">16</span><span class="comment">;</span></span><br><span class="line">@%p4 bra $L__BB0_4<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r20, %r20, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>lt<span class="number">.</span>u32 %p5, %r20, <span class="number">16</span><span class="comment">;</span></span><br><span class="line">@%p5 bra $L__BB0_3<span class="comment">;</span></span><br><span class="line">bra<span class="number">.</span>uni $L__BB0_6<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB0_1:</span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>f32 %f10, 0f00000000<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB0_6:</span><br><span class="line">cvt<span class="number">.</span>rzi<span class="number">.</span>u32<span class="number">.</span>f32 %r17, %f10<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r18, %ntid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line">mad<span class="number">.</span>lo<span class="number">.</span>s32 %r19, %r2, %r18, %r1<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd11, %r19<span class="comment">;</span></span><br><span class="line">cvta<span class="number">.</span>to<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u64 %rd12, %rd6<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd13, %rd12, %rd11<span class="comment">;</span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 [%rd13], %r17<span class="comment">;</span></span><br><span class="line"><span class="keyword">ret</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">//</span><br><span class="line"><span class="meta">.visible</span> .entry _Z6Layer2PhS_(</span><br><span class="line"><span class="meta">.param</span> .u64 _Z6Layer2PhS__param_0,</span><br><span class="line"><span class="meta">.param</span> .u64 _Z6Layer2PhS__param_1</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">.reg</span> .b16 %rs&lt;<span class="number">2</span>&gt;<span class="comment">;</span></span><br><span class="line"><span class="meta">.reg</span> .b32 %r&lt;<span class="number">8</span>&gt;<span class="comment">;</span></span><br><span class="line"><span class="meta">.reg</span> .b64 %rd&lt;<span class="number">14</span>&gt;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ld<span class="number">.</span>param<span class="number">.</span>u64 %rd1, [_Z6Layer2PhS__param_0]<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>param<span class="number">.</span>u64 %rd2, [_Z6Layer2PhS__param_1]<span class="comment">;</span></span><br><span class="line">cvta<span class="number">.</span>to<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u64 %rd3, %rd2<span class="comment">;</span></span><br><span class="line">cvta<span class="number">.</span>to<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u64 %rd4, %rd1<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r1, %ctaid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r2, %ntid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r3, %tid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line">mad<span class="number">.</span>lo<span class="number">.</span>s32 %r4, %r1, %r2, %r3<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd5, %r4<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd6, %rd4, %rd5<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 %rs1, [%rd6]<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd7, %r3<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u64 %rd8, cuda_sbox<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd9, %rd8, %rd7<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %r5, [%rd9]<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd10, %r1<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd11, %rd8, %rd10<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %r6, [%rd11]<span class="comment">;</span></span><br><span class="line">mad<span class="number">.</span>lo<span class="number">.</span>s32 %r7, %r2, %r5, %r6<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd12, %r7<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd13, %rd3, %rd12<span class="comment">;</span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 [%rd13], %rs1<span class="comment">;</span></span><br><span class="line"><span class="keyword">ret</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">//</span><br><span class="line"><span class="meta">.visible</span> .entry _Z6Layer3PhS_(</span><br><span class="line"><span class="meta">.param</span> .u64 _Z6Layer3PhS__param_0,</span><br><span class="line"><span class="meta">.param</span> .u64 _Z6Layer3PhS__param_1</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">.reg</span> .pred %p&lt;<span class="number">5</span>&gt;<span class="comment">;</span></span><br><span class="line"><span class="meta">.reg</span> .b16 %rs&lt;<span class="number">33</span>&gt;<span class="comment">;</span></span><br><span class="line"><span class="meta">.reg</span> .b32 %r&lt;<span class="number">52</span>&gt;<span class="comment">;</span></span><br><span class="line"><span class="meta">.reg</span> .b64 %rd&lt;<span class="number">24</span>&gt;<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ld<span class="number">.</span>param<span class="number">.</span>u64 %rd6, [_Z6Layer3PhS__param_0]<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>param<span class="number">.</span>u64 %rd5, [_Z6Layer3PhS__param_1]<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r21, %ntid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r1, %ctaid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line"><span class="keyword">mul</span><span class="number">.</span>lo<span class="number">.</span>s32 %r49, %r1, %r21<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r3, %tid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r22, %r49, %r3<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd1, %r22<span class="comment">;</span></span><br><span class="line">cvta<span class="number">.</span>to<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u64 %rd2, %rd6<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd3, %rd2, %rd1<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u16<span class="number">.</span>u32 %rs8, %r3<span class="comment">; </span></span><br><span class="line">cvt<span class="number">.</span>u16<span class="number">.</span>u32 %rs9, %r1<span class="comment">; </span></span><br><span class="line"><span class="keyword">or</span><span class="number">.</span>b16 %rs10, %rs9, %rs8<span class="comment">; </span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 %rs11, [%rd3]<span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b16 %rs12, %rs11, %rs10<span class="comment">; </span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 [%rd3], %rs12<span class="comment">; </span></span><br><span class="line">bar<span class="number">.</span>sync <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b32 %r23, %r3, <span class="number">7</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>ne<span class="number">.</span>s32 %p1, %r23, <span class="number">0</span><span class="comment">;</span></span><br><span class="line">@%p1 bra $L__BB2_4<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u32 %r47, [%rd3+<span class="number">4</span>]<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u32 %r48, [%rd3]<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r46, <span class="number">1786956040</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r45, <span class="number">0</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB2_2:</span><br><span class="line"><span class="meta">.pragma</span> <span class="string">&quot;nounroll&quot;</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">shl</span><span class="number">.</span>b32 %r26, %r48, <span class="number">4</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r27, %r26, <span class="number">1386807340</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">shr</span><span class="number">.</span>u32 %r28, %r48, <span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r29, %r28, <span class="number">2007053320</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r30, %r29, %r27<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r31, %r48, %r46<span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r32, %r30, %r31<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r47, %r32, %r47<span class="comment">;</span></span><br><span class="line"><span class="keyword">shl</span><span class="number">.</span>b32 %r33, %r47, <span class="number">4</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r34, %r33, <span class="number">621668851</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r35, %r46, %r47<span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r36, %r34, %r35<span class="comment">;</span></span><br><span class="line"><span class="keyword">shr</span><span class="number">.</span>u32 %r37, %r47, <span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r38, %r37, -<span class="number">862448841</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r39, %r36, %r38<span class="comment">;</span></span><br><span class="line"><span class="keyword">sub</span><span class="number">.</span>s32 %r48, %r48, %r39<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r46, %r46, -<span class="number">1708609273</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r45, %r45, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>ne<span class="number">.</span>s32 %p2, %r45, <span class="number">3238567</span><span class="comment">;</span></span><br><span class="line">@%p2 bra $L__BB2_2<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u32 [%rd3], %r48<span class="comment">;</span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u32 [%rd3+<span class="number">4</span>], %r47<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB2_4:</span><br><span class="line">bar<span class="number">.</span>sync <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b16 %rs16, %rs9, %rs8<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 %rs17, [%rd3]<span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b16 %rs18, %rs17, %rs16<span class="comment">; </span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 [%rd3], %rs18<span class="comment">;</span></span><br><span class="line">bar<span class="number">.</span>sync <span class="number">0</span><span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd7, %r3<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u64 %rd8, cuda_sbox<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd9, %rd8, %rd7<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %rs31, [%rd9]<span class="comment">;</span></span><br><span class="line">cvta<span class="number">.</span>to<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u64 %rd4, %rd5<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u16 %rs32, <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r50, <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u64 %rd14, cuda_tbox<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB2_5:</span><br><span class="line"><span class="meta">.pragma</span> <span class="string">&quot;nounroll&quot;</span><span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd10, %r49<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd11, %rd2, %rd10<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u16 %rd12, %rs31<span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b64 %rd13, %rd12, <span class="number">255</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd15, %rd14, %rd13<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %rs19, [%rd15]<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 %rs20, [%rd11]<span class="comment">;</span></span><br><span class="line"><span class="keyword">mul</span><span class="number">.</span>lo<span class="number">.</span>s16 %rs21, %rs19, %rs20<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s16 %rs32, %rs21, %rs32<span class="comment">;</span></span><br><span class="line"><span class="keyword">mul</span><span class="number">.</span>lo<span class="number">.</span>s16 %rs22, %rs31, <span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s16 %rs31, %rs22, <span class="number">17</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r49, %r49, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r50, %r50, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>ne<span class="number">.</span>s32 %p3, %r50, <span class="number">256</span><span class="comment">; </span></span><br><span class="line">@%p3 bra $L__BB2_5<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r18, %r1, %r3<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r51, <span class="number">8</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB2_7:</span><br><span class="line"><span class="meta">.pragma</span> <span class="string">&quot;nounroll&quot;</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">shl</span><span class="number">.</span>b16 %rs23, %rs32, <span class="number">3</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b16 %rs24, %rs32, <span class="number">224</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">shr</span><span class="number">.</span>u16 %rs25, %rs24, <span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">or</span><span class="number">.</span>b16 %rs26, %rs25, %rs23<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u32<span class="number">.</span>u16 %r42, %rs26<span class="comment">;</span></span><br><span class="line">mad<span class="number">.</span>lo<span class="number">.</span>s32 %r43, %r42, <span class="number">13</span>, %r18<span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b32 %r44, %r51, <span class="number">255</span><span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd16, %r44<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd18, %rd14, %rd16<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u16<span class="number">.</span>u32 %rs27, %r43<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %rs28, [%rd18]<span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b16 %rs29, %rs28, %rs27<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u16 %rd19, %rs29<span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b64 %rd20, %rd19, <span class="number">255</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd22, %rd8, %rd20<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %rs32, [%rd22]<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r51, %r51, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>ne<span class="number">.</span>s32 %p4, %r51, <span class="number">4137823</span><span class="comment">;</span></span><br><span class="line">@%p4 bra $L__BB2_7<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd23, %rd4, %rd1<span class="comment">;</span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 [%rd23], %rs32<span class="comment">;</span></span><br><span class="line"><span class="keyword">ret</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>motion是一个浮点数组构成的模糊核：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01248378586024046, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0055596730671823025, 0.04262230917811394, 0.01248378586024046, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0055596730671823025, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0</span><br></pre></td></tr></table></figure>
<p>sbox：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D690E9FECCE13DB716B614C228FB2C052B679A762ABE04C3AA441326498606999C4250F491EF987A33540B43EDCFAC62E4B31CA9C908E89580DF94FA758F3FA64707A7FCF37317BA83593C19E6854FA8686B81B27164DA8BF8EB0F4B70569D351E240E5E6358D1A225227C3B01217887D40046579FD327524C3602E7A0C4C89EEABF8AD240C738B5A3F7F2CEF96115A1E0AE5DA49B341A55AD933230F58CB1E31DF6E22E8266CA60C02923AB0D534E6FD5DB3745DEFD8E2F03FF6A726D6C5B518D1BAF92BBDDBC7F11D95C411F105AD80AC13188A5CD7BBD2D74D012B8E5B4B08969974A0C96777E65B9F109C56EC68418F07DEC3ADC4D2079EE5F3ED7CB3948</span><br></pre></td></tr></table></figure>
<p>tbox：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">627C767AF26A6EC43000662AFED6AA76CA82C87CFA5846F0ACD4A2AE9CA472C0B6FC9226363EF6CC34A4E4F070D8301404C622C21896049A061280E2EA26B27408822C1A1A6E5AA0523AD6B228E22E8452D000EC20FCB05A6ACABE384A4C58CED0EEAAFA424C328444F8027E503C9EA850A2408E929C38F4BCB6DA2010FEF2D2CC0C12EC5E964416C4A67E3C645C187260804EDC222A908846EFB814DE5E0ADAE0323A0A4806245CC2D2AC629094E478E6C8366C8CD44EA86C56F4EA647AAE08BA78242E1CA6B4C6E8DC741E4ABC8A8A703EB4664802F60E603456B886C01C9EE0F8981068D88E949A1E86E8CE5428DE8CA0880CBEE6426840982C0EB054BA16</span><br></pre></td></tr></table></figure>
<h2 id="Layer1"><a href="#Layer1" class="headerlink" title="Layer1"></a>Layer1</h2><p>逻辑恢复（by <a target="_blank" rel="noopener" href="https://blog.huanghunr.top/">huanghunr</a>）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">Layer1</span><span class="params">(<span class="type">uint8_t</span>* input, <span class="type">uint8_t</span>* output)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> tid = threadIdx.x; <span class="comment">//当前线程index</span></span><br><span class="line">    <span class="type">int</span> blockid = blockIdx.x; <span class="comment">//当前block index</span></span><br><span class="line">    <span class="type">int</span> ntid = blockDim.x; <span class="comment">//block中线程数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tid &gt;= <span class="number">241</span> || blockid &gt;= <span class="number">241</span>) &#123;</span><br><span class="line">        output[blockid * ntid + tid] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">float</span> acc = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) &#123;</span><br><span class="line">        <span class="type">int</span> offset = (<span class="number">240</span> - (i &lt;&lt; <span class="number">4</span>)) * <span class="number">4</span>;  </span><br><span class="line">        <span class="type">float</span>* motion = (<span class="type">float</span>*)((<span class="type">char</span>*)cuda_motion + offset); <span class="comment">//cuda_motion[240- i * 16] 把motion看成16*16的矩阵，这里就是在倒着获取每一行的索引</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> idx = (blockid + i) * ntid + tid; <span class="comment">//线程所处理的块索引</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            acc += motion[j] * input[idx + j]; <span class="comment">//与motion相乘并相加</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> out_index = blockid * ntid + tid; <span class="comment">//计算块索引用于线程的写入</span></span><br><span class="line">    output[out_index] = (<span class="type">uint8_t</span>)(acc);  <span class="comment">//输出结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Layer1中把输入的数据按照256*256的矩阵以motion为卷积核的卷积，但是motion的列要倒序一下，即input[0][0] … input[0][15] * motion[15][0]…motion[15][15].</p>
<h2 id="Layer2"><a href="#Layer2" class="headerlink" title="Layer2"></a>Layer2</h2><p>是一个简单的sbox置换：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">ld<span class="number">.</span>param<span class="number">.</span>u64 %rd1, [_Z6Layer2PhS__param_0]<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>param<span class="number">.</span>u64 %rd2, [_Z6Layer2PhS__param_1]<span class="comment">;</span></span><br><span class="line">cvta<span class="number">.</span>to<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u64 %rd3, %rd2<span class="comment">; // output</span></span><br><span class="line">cvta<span class="number">.</span>to<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u64 %rd4, %rd1<span class="comment">; // data</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r1, %ctaid<span class="number">.</span>x<span class="comment">; // block</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r2, %ntid<span class="number">.</span>x<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r3, %tid<span class="number">.</span>x<span class="comment">; // thread</span></span><br><span class="line">mad<span class="number">.</span>lo<span class="number">.</span>s32 %r4, %r1, %r2, %r3<span class="comment">; // pos = block * 256 + thread</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd5, %r4<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd6, %rd4, %rd5<span class="comment">; //data[pos]的地址</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 %rs1, [%rd6]<span class="comment">; // 读取data[pos]</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd7, %r3<span class="comment">; // thread</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u64 %rd8, cuda_sbox<span class="comment">; // 加载 sbox</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd9, %rd8, %rd7<span class="comment">; // sbox[thread]的地址</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %r5, [%rd9]<span class="comment">; // sbox[thread]</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd10, %r1<span class="comment">; // block</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd11, %rd8, %rd10<span class="comment">; // sbox[block]的地址</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %r6, [%rd11]<span class="comment">; //sbox[block]</span></span><br><span class="line">mad<span class="number">.</span>lo<span class="number">.</span>s32 %r7, %r2, %r5, %r6<span class="comment">; // val = sbox[thread] * 256 + sbox[block]</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd12, %r7<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd13, %rd3, %rd12<span class="comment">; // output[val]</span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 [%rd13], %rs1<span class="comment">; // output[val] = data[pos]</span></span><br><span class="line"><span class="keyword">ret</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>python实现：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        output[sbox[thread] * <span class="number">256</span> + sbox[block]] = data[block * <span class="number">256</span> + thread]</span><br></pre></td></tr></table></figure>

<h2 id="Layer3"><a href="#Layer3" class="headerlink" title="Layer3"></a>Layer3</h2><p>起始部分有一个异或：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cvt<span class="number">.</span>u16<span class="number">.</span>u32 %rs8, %r3<span class="comment">; // 将线程索引转换为16位</span></span><br><span class="line">cvt<span class="number">.</span>u16<span class="number">.</span>u32 %rs9, %r1<span class="comment">; // 将块索引转换为16位</span></span><br><span class="line"><span class="keyword">or</span><span class="number">.</span>b16 %rs10, %rs9, %rs8<span class="comment">; // %rs10 = %rs9 | %rs8</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 %rs11, [%rd3]<span class="comment">; // 加载原数据</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b16 %rs12, %rs11, %rs10<span class="comment">; // %rs12 = %rs11 ^ %rs10</span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 [%rd3], %rs12<span class="comment">; // 写回原数据</span></span><br></pre></td></tr></table></figure>
<p>其python实现：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        val = block | thread</span><br><span class="line">        data[<span class="number">256</span> * block + thread] ^= val</span><br></pre></td></tr></table></figure>
<p>中间按线程索引&amp;7&#x3D;0（为8的倍数）进行TEA加密的部分：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">bar<span class="number">.</span>sync <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b32 %r23, %r3, <span class="number">7</span><span class="comment">; // %r23 = 线程索引 &amp; 7</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>ne<span class="number">.</span>s32 %p1, %r23, <span class="number">0</span><span class="comment">; // 如果不为0则跳转到$L_BB2_4</span></span><br><span class="line">@%p1 bra $L__BB2_4<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u32 %r47, [%rd3+<span class="number">4</span>]<span class="comment">; // m2</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u32 %r48, [%rd3]<span class="comment">; // m1</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r46, <span class="number">1786956040</span><span class="comment">; // delta</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r45, <span class="number">0</span><span class="comment">; //循环轮数</span></span><br><span class="line"></span><br><span class="line">$L__BB2_2:<span class="comment">; //TEA</span></span><br><span class="line"><span class="meta">.pragma</span> <span class="string">&quot;nounroll&quot;</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">shl</span><span class="number">.</span>b32 %r26, %r48, <span class="number">4</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r27, %r26, <span class="number">1386807340</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">shr</span><span class="number">.</span>u32 %r28, %r48, <span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r29, %r28, <span class="number">2007053320</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r30, %r29, %r27<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r31, %r48, %r46<span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r32, %r30, %r31<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r47, %r32, %r47<span class="comment">;</span></span><br><span class="line"><span class="keyword">shl</span><span class="number">.</span>b32 %r33, %r47, <span class="number">4</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r34, %r33, <span class="number">621668851</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r35, %r46, %r47<span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r36, %r34, %r35<span class="comment">;</span></span><br><span class="line"><span class="keyword">shr</span><span class="number">.</span>u32 %r37, %r47, <span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r38, %r37, -<span class="number">862448841</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r39, %r36, %r38<span class="comment">;</span></span><br><span class="line"><span class="keyword">sub</span><span class="number">.</span>s32 %r48, %r48, %r39<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r46, %r46, -<span class="number">1708609273</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r45, %r45, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>ne<span class="number">.</span>s32 %p2, %r45, <span class="number">3238567</span><span class="comment">;</span></span><br><span class="line">@%p2 bra $L__BB2_2<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u32 [%rd3], %r48<span class="comment">; //写回原数据</span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u32 [%rd3+<span class="number">4</span>], %r47<span class="comment">; //写回原数据</span></span><br></pre></td></tr></table></figure>
<p>其python模拟如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">delta = <span class="number">0x6a82c908</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x316aa7</span>):</span><br><span class="line">    m2 = (m2 + (((m1 &gt;&gt; <span class="number">5</span>) + <span class="number">0x77a13408</span>) ^ ((m1 &lt;&lt; <span class="number">4</span>) + <span class="number">0x52a9002c</span>) ^ (m1 + delta))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    m1 = (m1 - (((m2 &gt;&gt; <span class="number">5</span>) + <span class="number">0xcc981337</span>) ^ ((m2 &lt;&lt; <span class="number">4</span>) + <span class="number">0x250de9f3</span>) ^ (m2 + delta))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    delta = (delta + <span class="number">0x9a28b107</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br></pre></td></tr></table></figure>
<p>之后在$L_BB2_4有一个异或：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bar<span class="number">.</span>sync <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b16 %rs16, %rs9, %rs8<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 %rs17, [%rd3]<span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b16 %rs18, %rs17, %rs16<span class="comment">;</span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 [%rd3], %rs18<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>对应：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        val = block &amp; thread</span><br><span class="line">        data[<span class="number">256</span> * block + thread] ^= val</span><br></pre></td></tr></table></figure>
<p>在$L_BB2_4的下半部分、$L_BB2_5和$L_BB2_7有Sbox、Tbox置换：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">bar<span class="number">.</span>sync <span class="number">0</span><span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd7, %r3<span class="comment">; //thread</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u64 %rd8, cuda_sbox<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd9, %rd8, %rd7<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %rs31, [%rd9]<span class="comment">; //加载sbox[thread]</span></span><br><span class="line">cvta<span class="number">.</span>to<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u64 %rd4, %rd5<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u16 %rs32, <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r50, <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u64 %rd14, cuda_tbox<span class="comment">; //加载tbox</span></span><br><span class="line"></span><br><span class="line">$L__BB2_5:</span><br><span class="line"><span class="meta">.pragma</span> <span class="string">&quot;nounroll&quot;</span><span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd10, %r49<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd11, %rd2, %rd10<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u16 %rd12, %rs31<span class="comment">; //sbox[thread]</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b64 %rd13, %rd12, <span class="number">255</span><span class="comment">; //&amp;0xFF</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd15, %rd14, %rd13<span class="comment">; //tbox[sbox[thread]]的地址</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %rs19, [%rd15]<span class="comment">; // rs19为tbox[sbox[thread]]的值</span></span><br><span class="line">ld<span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 %rs20, [%rd11]<span class="comment">; //data</span></span><br><span class="line"><span class="keyword">mul</span><span class="number">.</span>lo<span class="number">.</span>s16 %rs21, %rs19, %rs20<span class="comment">; // tbox[sbox[thread]] * data</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s16 %rs32, %rs21, %rs32<span class="comment">; // 累加和</span></span><br><span class="line"><span class="keyword">mul</span><span class="number">.</span>lo<span class="number">.</span>s16 %rs22, %rs31, <span class="number">5</span><span class="comment">; // sbox[thread] * 5</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s16 %rs31, %rs22, <span class="number">17</span><span class="comment">; // sbox[thread] = sbox[thread] * 5 + 17</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r49, %r49, <span class="number">1</span><span class="comment">; //计数+1</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r50, %r50, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>ne<span class="number">.</span>s32 %p3, %r50, <span class="number">256</span><span class="comment">; //循环256次</span></span><br><span class="line">@%p3 bra $L__BB2_5<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b32 %r18, %r1, %r3<span class="comment">;</span></span><br><span class="line"><span class="keyword">mov</span><span class="number">.</span>u32 %r51, <span class="number">8</span><span class="comment">;</span></span><br><span class="line"></span><br><span class="line">$L__BB2_7:</span><br><span class="line"><span class="meta">.pragma</span> <span class="string">&quot;nounroll&quot;</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">shl</span><span class="number">.</span>b16 %rs23, %rs32, <span class="number">3</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b16 %rs24, %rs32, <span class="number">224</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">shr</span><span class="number">.</span>u16 %rs25, %rs24, <span class="number">5</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">or</span><span class="number">.</span>b16 %rs26, %rs25, %rs23<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u32<span class="number">.</span>u16 %r42, %rs26<span class="comment">;</span></span><br><span class="line">mad<span class="number">.</span>lo<span class="number">.</span>s32 %r43, %r42, <span class="number">13</span>, %r18<span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b32 %r44, %r51, <span class="number">255</span><span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u32 %rd16, %r44<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd18, %rd14, %rd16<span class="comment">; // tbox地址</span></span><br><span class="line">cvt<span class="number">.</span>u16<span class="number">.</span>u32 %rs27, %r43<span class="comment">;</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %rs28, [%rd18]<span class="comment">;</span></span><br><span class="line"><span class="keyword">xor</span><span class="number">.</span>b16 %rs29, %rs28, %rs27<span class="comment">;</span></span><br><span class="line">cvt<span class="number">.</span>u64<span class="number">.</span>u16 %rd19, %rs29<span class="comment">;</span></span><br><span class="line"><span class="keyword">and</span><span class="number">.</span>b64 %rd20, %rd19, <span class="number">255</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd22, %rd8, %rd20<span class="comment">; // sbox地址</span></span><br><span class="line">ld<span class="number">.</span>const<span class="number">.</span>u8 %rs32, [%rd22]<span class="comment">;</span></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s32 %r51, %r51, <span class="number">1</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">setp</span><span class="number">.</span>ne<span class="number">.</span>s32 %p4, %r51, <span class="number">4137823</span><span class="comment">;</span></span><br><span class="line">@%p4 bra $L__BB2_7<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">add</span><span class="number">.</span>s64 %rd23, %rd4, %rd1<span class="comment">;</span></span><br><span class="line"><span class="built_in">st</span><span class="number">.</span><span class="meta">global</span><span class="number">.</span>u8 [%rd23], %rs32<span class="comment">;</span></span><br><span class="line"><span class="keyword">ret</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>对应：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        ttl = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> rounds <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            ttl += tbox[sbox[thread]] * b_dat[<span class="number">256</span> * block + rounds]</span><br><span class="line">            sbox[thread] = (sbox[thread] * <span class="number">5</span> + <span class="number">17</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        <span class="keyword">for</span> cycle <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>, <span class="number">4137823</span>):</span><br><span class="line">            res = sbox[tbox[cycle &amp; <span class="number">0xFF</span>] ^ ((((ttl &amp; <span class="number">224</span>) &gt;&gt; <span class="number">5</span>) | (ttl &lt;&lt; <span class="number">3</span>)) * <span class="number">13</span> + (block ^ thread)) &amp; <span class="number">0xFF</span>]</span><br><span class="line">        final[block * <span class="number">256</span> + thread] = res</span><br></pre></td></tr></table></figure>
<p>Layer3总体逻辑：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">bytes_to_dwords_little_endian</span>(<span class="params">byte_array</span>):</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(byte_array[i:i+<span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">False</span>)<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(byte_array), <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dwords_to_bytes_little_endian</span>(<span class="params">dword_array</span>):</span><br><span class="line">    byte_list = []</span><br><span class="line">    <span class="keyword">for</span> dword <span class="keyword">in</span> dword_array:</span><br><span class="line">        byte_list.extend(dword.to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> byte_list</span><br><span class="line"></span><br><span class="line">sbox_ori = [<span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xE9</span>, <span class="number">0xFE</span>, <span class="number">0xCC</span>, <span class="number">0xE1</span>, <span class="number">0x3D</span>, <span class="number">0xB7</span>, <span class="number">0x16</span>, <span class="number">0xB6</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x28</span>, <span class="number">0xFB</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>, </span><br><span class="line">            <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x9A</span>, <span class="number">0x76</span>, <span class="number">0x2A</span>, <span class="number">0xBE</span>, <span class="number">0x04</span>, <span class="number">0xC3</span>, <span class="number">0xAA</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>, </span><br><span class="line">            <span class="number">0x9C</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xF4</span>, <span class="number">0x91</span>, <span class="number">0xEF</span>, <span class="number">0x98</span>, <span class="number">0x7A</span>, <span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0B</span>, <span class="number">0x43</span>, <span class="number">0xED</span>, <span class="number">0xCF</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, </span><br><span class="line">            <span class="number">0xE4</span>, <span class="number">0xB3</span>, <span class="number">0x1C</span>, <span class="number">0xA9</span>, <span class="number">0xC9</span>, <span class="number">0x08</span>, <span class="number">0xE8</span>, <span class="number">0x95</span>, <span class="number">0x80</span>, <span class="number">0xDF</span>, <span class="number">0x94</span>, <span class="number">0xFA</span>, <span class="number">0x75</span>, <span class="number">0x8F</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>, </span><br><span class="line">            <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xA7</span>, <span class="number">0xFC</span>, <span class="number">0xF3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xBA</span>, <span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3C</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x4F</span>, <span class="number">0xA8</span>, </span><br><span class="line">            <span class="number">0x68</span>, <span class="number">0x6B</span>, <span class="number">0x81</span>, <span class="number">0xB2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xDA</span>, <span class="number">0x8B</span>, <span class="number">0xF8</span>, <span class="number">0xEB</span>, <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x35</span>, </span><br><span class="line">            <span class="number">0x1E</span>, <span class="number">0x24</span>, <span class="number">0x0E</span>, <span class="number">0x5E</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xD1</span>, <span class="number">0xA2</span>, <span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7C</span>, <span class="number">0x3B</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>, </span><br><span class="line">            <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9F</span>, <span class="number">0xD3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>, <span class="number">0x4C</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xE7</span>, <span class="number">0xA0</span>, <span class="number">0xC4</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>, </span><br><span class="line">            <span class="number">0xEA</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0xD2</span>, <span class="number">0x40</span>, <span class="number">0xC7</span>, <span class="number">0x38</span>, <span class="number">0xB5</span>, <span class="number">0xA3</span>, <span class="number">0xF7</span>, <span class="number">0xF2</span>, <span class="number">0xCE</span>, <span class="number">0xF9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xA1</span>, </span><br><span class="line">            <span class="number">0xE0</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xA4</span>, <span class="number">0x9B</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x55</span>, <span class="number">0xAD</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xF5</span>, <span class="number">0x8C</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>, </span><br><span class="line">            <span class="number">0x1D</span>, <span class="number">0xF6</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xCA</span>, <span class="number">0x60</span>, <span class="number">0xC0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xAB</span>, <span class="number">0x0D</span>, <span class="number">0x53</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>, </span><br><span class="line">            <span class="number">0xD5</span>, <span class="number">0xDB</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xDE</span>, <span class="number">0xFD</span>, <span class="number">0x8E</span>, <span class="number">0x2F</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x6A</span>, <span class="number">0x72</span>, <span class="number">0x6D</span>, <span class="number">0x6C</span>, <span class="number">0x5B</span>, <span class="number">0x51</span>, </span><br><span class="line">            <span class="number">0x8D</span>, <span class="number">0x1B</span>, <span class="number">0xAF</span>, <span class="number">0x92</span>, <span class="number">0xBB</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x7F</span>, <span class="number">0x11</span>, <span class="number">0xD9</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x5A</span>, <span class="number">0xD8</span>, </span><br><span class="line">            <span class="number">0x0A</span>, <span class="number">0xC1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xA5</span>, <span class="number">0xCD</span>, <span class="number">0x7B</span>, <span class="number">0xBD</span>, <span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0xD0</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0xE5</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>, </span><br><span class="line">            <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4A</span>, <span class="number">0x0C</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>, <span class="number">0x65</span>, <span class="number">0xB9</span>, <span class="number">0xF1</span>, <span class="number">0x09</span>, <span class="number">0xC5</span>, <span class="number">0x6E</span>, <span class="number">0xC6</span>, <span class="number">0x84</span>, </span><br><span class="line">            <span class="number">0x18</span>, <span class="number">0xF0</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x3A</span>, <span class="number">0xDC</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>, <span class="number">0x79</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0x3E</span>, <span class="number">0xD7</span>, <span class="number">0xCB</span>, <span class="number">0x39</span>, <span class="number">0x48</span>]</span><br><span class="line"></span><br><span class="line">tbox = [<span class="number">0x62</span>, <span class="number">0x7C</span>, <span class="number">0x76</span>, <span class="number">0x7A</span>, <span class="number">0xF2</span>, <span class="number">0x6A</span>, <span class="number">0x6E</span>, <span class="number">0xC4</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x2A</span>, <span class="number">0xFE</span>, <span class="number">0xD6</span>, <span class="number">0xAA</span>, <span class="number">0x76</span>, </span><br><span class="line">        <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC8</span>, <span class="number">0x7C</span>, <span class="number">0xFA</span>, <span class="number">0x58</span>, <span class="number">0x46</span>, <span class="number">0xF0</span>, <span class="number">0xAC</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAE</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>, </span><br><span class="line">        <span class="number">0xB6</span>, <span class="number">0xFC</span>, <span class="number">0x92</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3E</span>, <span class="number">0xF6</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA4</span>, <span class="number">0xE4</span>, <span class="number">0xF0</span>, <span class="number">0x70</span>, <span class="number">0xD8</span>, <span class="number">0x30</span>, <span class="number">0x14</span>, </span><br><span class="line">        <span class="number">0x04</span>, <span class="number">0xC6</span>, <span class="number">0x22</span>, <span class="number">0xC2</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x04</span>, <span class="number">0x9A</span>, <span class="number">0x06</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEA</span>, <span class="number">0x26</span>, <span class="number">0xB2</span>, <span class="number">0x74</span>, </span><br><span class="line">        <span class="number">0x08</span>, <span class="number">0x82</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1A</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3A</span>, <span class="number">0xD6</span>, <span class="number">0xB2</span>, <span class="number">0x28</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x84</span>, </span><br><span class="line">        <span class="number">0x52</span>, <span class="number">0xD0</span>, <span class="number">0x00</span>, <span class="number">0xEC</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB0</span>, <span class="number">0x5A</span>, <span class="number">0x6A</span>, <span class="number">0xCA</span>, <span class="number">0xBE</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCE</span>, </span><br><span class="line">        <span class="number">0xD0</span>, <span class="number">0xEE</span>, <span class="number">0xAA</span>, <span class="number">0xFA</span>, <span class="number">0x42</span>, <span class="number">0x4C</span>, <span class="number">0x32</span>, <span class="number">0x84</span>, <span class="number">0x44</span>, <span class="number">0xF8</span>, <span class="number">0x02</span>, <span class="number">0x7E</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9E</span>, <span class="number">0xA8</span>, </span><br><span class="line">        <span class="number">0x50</span>, <span class="number">0xA2</span>, <span class="number">0x40</span>, <span class="number">0x8E</span>, <span class="number">0x92</span>, <span class="number">0x9C</span>, <span class="number">0x38</span>, <span class="number">0xF4</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x20</span>, <span class="number">0x10</span>, <span class="number">0xFE</span>, <span class="number">0xF2</span>, <span class="number">0xD2</span>, </span><br><span class="line">        <span class="number">0xCC</span>, <span class="number">0x0C</span>, <span class="number">0x12</span>, <span class="number">0xEC</span>, <span class="number">0x5E</span>, <span class="number">0x96</span>, <span class="number">0x44</span>, <span class="number">0x16</span>, <span class="number">0xC4</span>, <span class="number">0xA6</span>, <span class="number">0x7E</span>, <span class="number">0x3C</span>, <span class="number">0x64</span>, <span class="number">0x5C</span>, <span class="number">0x18</span>, <span class="number">0x72</span>, </span><br><span class="line">        <span class="number">0x60</span>, <span class="number">0x80</span>, <span class="number">0x4E</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEF</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0A</span>, <span class="number">0xDA</span>, </span><br><span class="line">        <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x48</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD2</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x90</span>, <span class="number">0x94</span>, <span class="number">0xE4</span>, <span class="number">0x78</span>, </span><br><span class="line">        <span class="number">0xE6</span>, <span class="number">0xC8</span>, <span class="number">0x36</span>, <span class="number">0x6C</span>, <span class="number">0x8C</span>, <span class="number">0xD4</span>, <span class="number">0x4E</span>, <span class="number">0xA8</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x64</span>, <span class="number">0x7A</span>, <span class="number">0xAE</span>, <span class="number">0x08</span>, </span><br><span class="line">        <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x24</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDC</span>, <span class="number">0x74</span>, <span class="number">0x1E</span>, <span class="number">0x4A</span>, <span class="number">0xBC</span>, <span class="number">0x8A</span>, <span class="number">0x8A</span>, </span><br><span class="line">        <span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB4</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x02</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x60</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0xB8</span>, <span class="number">0x86</span>, <span class="number">0xC0</span>, <span class="number">0x1C</span>, <span class="number">0x9E</span>, </span><br><span class="line">        <span class="number">0xE0</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x10</span>, <span class="number">0x68</span>, <span class="number">0xD8</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9A</span>, <span class="number">0x1E</span>, <span class="number">0x86</span>, <span class="number">0xE8</span>, <span class="number">0xCE</span>, <span class="number">0x54</span>, <span class="number">0x28</span>, <span class="number">0xDE</span>, </span><br><span class="line">        <span class="number">0x8C</span>, <span class="number">0xA0</span>, <span class="number">0x88</span>, <span class="number">0x0C</span>, <span class="number">0xBE</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x40</span>, <span class="number">0x98</span>, <span class="number">0x2C</span>, <span class="number">0x0E</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBA</span>, <span class="number">0x16</span>]</span><br><span class="line"></span><br><span class="line">data = [<span class="number">0</span>] * <span class="number">65536</span></span><br><span class="line">final = [<span class="number">0</span>] * <span class="number">65536</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        val = block | thread</span><br><span class="line">        data[<span class="number">256</span> * block + thread] ^= val</span><br><span class="line"></span><br><span class="line">d_dat = bytes_to_dwords_little_endian(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(d_dat) // <span class="number">2</span>):</span><br><span class="line">    m1 = d_dat[<span class="number">2</span> * i]</span><br><span class="line">    m2 = d_dat[<span class="number">2</span> * i + <span class="number">1</span>]</span><br><span class="line">    ttl = <span class="number">0x6a82c908</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3238567</span>):</span><br><span class="line">        m2 = (m2 + (((m1 &gt;&gt; <span class="number">5</span>) + <span class="number">0x77a13408</span>) ^ ((m1 &lt;&lt; <span class="number">4</span>) + <span class="number">0x52a9002c</span>) ^ (m1 + ttl))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        m1 = (m1 - (((m2 &gt;&gt; <span class="number">5</span>) + <span class="number">0xcc981337</span>) ^ ((m2 &lt;&lt; <span class="number">4</span>) + <span class="number">0x250de9f3</span>) ^ (m2 + ttl))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        ttl = (ttl + <span class="number">0x9a28b107</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    d_dat[<span class="number">2</span> * i] = m1</span><br><span class="line">    d_dat[<span class="number">2</span> * i + <span class="number">1</span>] = m2</span><br><span class="line"></span><br><span class="line">b_dat = dwords_to_bytes_little_endian(d_dat)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        val = block &amp; thread</span><br><span class="line">        b_dat[<span class="number">256</span> * block + thread] ^= val</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        sbox = sbox_ori.copy()</span><br><span class="line">        ttl = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> rounds <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            ttl += tbox[sbox[thread]] * b_dat[<span class="number">256</span> * block + rounds]</span><br><span class="line">            sbox[thread] = (sbox[thread] * <span class="number">5</span> + <span class="number">17</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">        <span class="keyword">for</span> cycle <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>, <span class="number">4137823</span>):</span><br><span class="line">            ttl = sbox[tbox[cycle &amp; <span class="number">0xFF</span>] ^ ((((ttl &amp; <span class="number">224</span>) &gt;&gt; <span class="number">5</span>) | (ttl &lt;&lt; <span class="number">3</span>)) * <span class="number">13</span> + (block ^ thread)) &amp; <span class="number">0xFF</span>]</span><br><span class="line">        final[block * <span class="number">256</span> + thread] = ttl</span><br></pre></td></tr></table></figure>
<h2 id="Layer3求解："><a href="#Layer3求解：" class="headerlink" title="Layer3求解："></a>Layer3求解：</h2><p>经过测试发现ttl生成过程中的sbox修改对于thread0~255，在256轮后的结果都一样，并且等于原始sbox（SM4的sbox）：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">sbox_ori = [<span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xE9</span>, <span class="number">0xFE</span>, <span class="number">0xCC</span>, <span class="number">0xE1</span>, <span class="number">0x3D</span>, <span class="number">0xB7</span>, <span class="number">0x16</span>, <span class="number">0xB6</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x28</span>, <span class="number">0xFB</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>,</span><br><span class="line">            <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x9A</span>, <span class="number">0x76</span>, <span class="number">0x2A</span>, <span class="number">0xBE</span>, <span class="number">0x04</span>, <span class="number">0xC3</span>, <span class="number">0xAA</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>,</span><br><span class="line">            <span class="number">0x9C</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xF4</span>, <span class="number">0x91</span>, <span class="number">0xEF</span>, <span class="number">0x98</span>, <span class="number">0x7A</span>, <span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0B</span>, <span class="number">0x43</span>, <span class="number">0xED</span>, <span class="number">0xCF</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>,</span><br><span class="line">            <span class="number">0xE4</span>, <span class="number">0xB3</span>, <span class="number">0x1C</span>, <span class="number">0xA9</span>, <span class="number">0xC9</span>, <span class="number">0x08</span>, <span class="number">0xE8</span>, <span class="number">0x95</span>, <span class="number">0x80</span>, <span class="number">0xDF</span>, <span class="number">0x94</span>, <span class="number">0xFA</span>, <span class="number">0x75</span>, <span class="number">0x8F</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>,</span><br><span class="line">            <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xA7</span>, <span class="number">0xFC</span>, <span class="number">0xF3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xBA</span>, <span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3C</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x4F</span>, <span class="number">0xA8</span>,</span><br><span class="line">            <span class="number">0x68</span>, <span class="number">0x6B</span>, <span class="number">0x81</span>, <span class="number">0xB2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xDA</span>, <span class="number">0x8B</span>, <span class="number">0xF8</span>, <span class="number">0xEB</span>, <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x35</span>,</span><br><span class="line">            <span class="number">0x1E</span>, <span class="number">0x24</span>, <span class="number">0x0E</span>, <span class="number">0x5E</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xD1</span>, <span class="number">0xA2</span>, <span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7C</span>, <span class="number">0x3B</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>,</span><br><span class="line">            <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9F</span>, <span class="number">0xD3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>, <span class="number">0x4C</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xE7</span>, <span class="number">0xA0</span>, <span class="number">0xC4</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>,</span><br><span class="line">            <span class="number">0xEA</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0xD2</span>, <span class="number">0x40</span>, <span class="number">0xC7</span>, <span class="number">0x38</span>, <span class="number">0xB5</span>, <span class="number">0xA3</span>, <span class="number">0xF7</span>, <span class="number">0xF2</span>, <span class="number">0xCE</span>, <span class="number">0xF9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xA1</span>,</span><br><span class="line">            <span class="number">0xE0</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xA4</span>, <span class="number">0x9B</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x55</span>, <span class="number">0xAD</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xF5</span>, <span class="number">0x8C</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>,</span><br><span class="line">            <span class="number">0x1D</span>, <span class="number">0xF6</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xCA</span>, <span class="number">0x60</span>, <span class="number">0xC0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xAB</span>, <span class="number">0x0D</span>, <span class="number">0x53</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>,</span><br><span class="line">            <span class="number">0xD5</span>, <span class="number">0xDB</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xDE</span>, <span class="number">0xFD</span>, <span class="number">0x8E</span>, <span class="number">0x2F</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x6A</span>, <span class="number">0x72</span>, <span class="number">0x6D</span>, <span class="number">0x6C</span>, <span class="number">0x5B</span>, <span class="number">0x51</span>,</span><br><span class="line">            <span class="number">0x8D</span>, <span class="number">0x1B</span>, <span class="number">0xAF</span>, <span class="number">0x92</span>, <span class="number">0xBB</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x7F</span>, <span class="number">0x11</span>, <span class="number">0xD9</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x5A</span>, <span class="number">0xD8</span>,</span><br><span class="line">            <span class="number">0x0A</span>, <span class="number">0xC1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xA5</span>, <span class="number">0xCD</span>, <span class="number">0x7B</span>, <span class="number">0xBD</span>, <span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0xD0</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0xE5</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>,</span><br><span class="line">            <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4A</span>, <span class="number">0x0C</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>, <span class="number">0x65</span>, <span class="number">0xB9</span>, <span class="number">0xF1</span>, <span class="number">0x09</span>, <span class="number">0xC5</span>, <span class="number">0x6E</span>, <span class="number">0xC6</span>, <span class="number">0x84</span>,</span><br><span class="line">            <span class="number">0x18</span>, <span class="number">0xF0</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x3A</span>, <span class="number">0xDC</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>, <span class="number">0x79</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0x3E</span>, <span class="number">0xD7</span>, <span class="number">0xCB</span>, <span class="number">0x39</span>, <span class="number">0x48</span>]</span><br><span class="line"></span><br><span class="line">sboxs = []</span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    sbox = sbox_ori.copy()</span><br><span class="line">    ttl = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> rounds <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        sbox[thread] = (sbox[thread] * <span class="number">5</span> + <span class="number">17</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">    sboxs.append(sbox.copy())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">assert</span> sbox_ori == sboxs[i]  <span class="comment"># assert通过验证</span></span><br></pre></td></tr></table></figure>
<p>cycle过程中的&amp;224无效，因为取的是高3位，逆向最后的cycle循环得到解密函数：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> numba <span class="keyword">import</span> njit</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">sbox = np.array([<span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xE9</span>, <span class="number">0xFE</span>, <span class="number">0xCC</span>, <span class="number">0xE1</span>, <span class="number">0x3D</span>, <span class="number">0xB7</span>, <span class="number">0x16</span>, <span class="number">0xB6</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x28</span>, <span class="number">0xFB</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>,</span><br><span class="line">        <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x9A</span>, <span class="number">0x76</span>, <span class="number">0x2A</span>, <span class="number">0xBE</span>, <span class="number">0x04</span>, <span class="number">0xC3</span>, <span class="number">0xAA</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>,</span><br><span class="line">        <span class="number">0x9C</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xF4</span>, <span class="number">0x91</span>, <span class="number">0xEF</span>, <span class="number">0x98</span>, <span class="number">0x7A</span>, <span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0B</span>, <span class="number">0x43</span>, <span class="number">0xED</span>, <span class="number">0xCF</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>,</span><br><span class="line">        <span class="number">0xE4</span>, <span class="number">0xB3</span>, <span class="number">0x1C</span>, <span class="number">0xA9</span>, <span class="number">0xC9</span>, <span class="number">0x08</span>, <span class="number">0xE8</span>, <span class="number">0x95</span>, <span class="number">0x80</span>, <span class="number">0xDF</span>, <span class="number">0x94</span>, <span class="number">0xFA</span>, <span class="number">0x75</span>, <span class="number">0x8F</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>,</span><br><span class="line">        <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xA7</span>, <span class="number">0xFC</span>, <span class="number">0xF3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xBA</span>, <span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3C</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x4F</span>, <span class="number">0xA8</span>,</span><br><span class="line">        <span class="number">0x68</span>, <span class="number">0x6B</span>, <span class="number">0x81</span>, <span class="number">0xB2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xDA</span>, <span class="number">0x8B</span>, <span class="number">0xF8</span>, <span class="number">0xEB</span>, <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x35</span>,</span><br><span class="line">        <span class="number">0x1E</span>, <span class="number">0x24</span>, <span class="number">0x0E</span>, <span class="number">0x5E</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xD1</span>, <span class="number">0xA2</span>, <span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7C</span>, <span class="number">0x3B</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>,</span><br><span class="line">        <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9F</span>, <span class="number">0xD3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>, <span class="number">0x4C</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xE7</span>, <span class="number">0xA0</span>, <span class="number">0xC4</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>,</span><br><span class="line">        <span class="number">0xEA</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0xD2</span>, <span class="number">0x40</span>, <span class="number">0xC7</span>, <span class="number">0x38</span>, <span class="number">0xB5</span>, <span class="number">0xA3</span>, <span class="number">0xF7</span>, <span class="number">0xF2</span>, <span class="number">0xCE</span>, <span class="number">0xF9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xA1</span>,</span><br><span class="line">        <span class="number">0xE0</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xA4</span>, <span class="number">0x9B</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x55</span>, <span class="number">0xAD</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xF5</span>, <span class="number">0x8C</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>,</span><br><span class="line">        <span class="number">0x1D</span>, <span class="number">0xF6</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xCA</span>, <span class="number">0x60</span>, <span class="number">0xC0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xAB</span>, <span class="number">0x0D</span>, <span class="number">0x53</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>,</span><br><span class="line">        <span class="number">0xD5</span>, <span class="number">0xDB</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xDE</span>, <span class="number">0xFD</span>, <span class="number">0x8E</span>, <span class="number">0x2F</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x6A</span>, <span class="number">0x72</span>, <span class="number">0x6D</span>, <span class="number">0x6C</span>, <span class="number">0x5B</span>, <span class="number">0x51</span>,</span><br><span class="line">        <span class="number">0x8D</span>, <span class="number">0x1B</span>, <span class="number">0xAF</span>, <span class="number">0x92</span>, <span class="number">0xBB</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x7F</span>, <span class="number">0x11</span>, <span class="number">0xD9</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x5A</span>, <span class="number">0xD8</span>,</span><br><span class="line">        <span class="number">0x0A</span>, <span class="number">0xC1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xA5</span>, <span class="number">0xCD</span>, <span class="number">0x7B</span>, <span class="number">0xBD</span>, <span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0xD0</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0xE5</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>,</span><br><span class="line">        <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4A</span>, <span class="number">0x0C</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>, <span class="number">0x65</span>, <span class="number">0xB9</span>, <span class="number">0xF1</span>, <span class="number">0x09</span>, <span class="number">0xC5</span>, <span class="number">0x6E</span>, <span class="number">0xC6</span>, <span class="number">0x84</span>,</span><br><span class="line">        <span class="number">0x18</span>, <span class="number">0xF0</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x3A</span>, <span class="number">0xDC</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>, <span class="number">0x79</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0x3E</span>, <span class="number">0xD7</span>, <span class="number">0xCB</span>, <span class="number">0x39</span>, <span class="number">0x48</span>], dtype=np.uint8)</span><br><span class="line"></span><br><span class="line">tbox = np.array([<span class="number">0x62</span>, <span class="number">0x7C</span>, <span class="number">0x76</span>, <span class="number">0x7A</span>, <span class="number">0xF2</span>, <span class="number">0x6A</span>, <span class="number">0x6E</span>, <span class="number">0xC4</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x2A</span>, <span class="number">0xFE</span>, <span class="number">0xD6</span>, <span class="number">0xAA</span>, <span class="number">0x76</span>,</span><br><span class="line">        <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC8</span>, <span class="number">0x7C</span>, <span class="number">0xFA</span>, <span class="number">0x58</span>, <span class="number">0x46</span>, <span class="number">0xF0</span>, <span class="number">0xAC</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAE</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>,</span><br><span class="line">        <span class="number">0xB6</span>, <span class="number">0xFC</span>, <span class="number">0x92</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3E</span>, <span class="number">0xF6</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA4</span>, <span class="number">0xE4</span>, <span class="number">0xF0</span>, <span class="number">0x70</span>, <span class="number">0xD8</span>, <span class="number">0x30</span>, <span class="number">0x14</span>,</span><br><span class="line">        <span class="number">0x04</span>, <span class="number">0xC6</span>, <span class="number">0x22</span>, <span class="number">0xC2</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x04</span>, <span class="number">0x9A</span>, <span class="number">0x06</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEA</span>, <span class="number">0x26</span>, <span class="number">0xB2</span>, <span class="number">0x74</span>,</span><br><span class="line">        <span class="number">0x08</span>, <span class="number">0x82</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1A</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3A</span>, <span class="number">0xD6</span>, <span class="number">0xB2</span>, <span class="number">0x28</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x84</span>,</span><br><span class="line">        <span class="number">0x52</span>, <span class="number">0xD0</span>, <span class="number">0x00</span>, <span class="number">0xEC</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB0</span>, <span class="number">0x5A</span>, <span class="number">0x6A</span>, <span class="number">0xCA</span>, <span class="number">0xBE</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCE</span>,</span><br><span class="line">        <span class="number">0xD0</span>, <span class="number">0xEE</span>, <span class="number">0xAA</span>, <span class="number">0xFA</span>, <span class="number">0x42</span>, <span class="number">0x4C</span>, <span class="number">0x32</span>, <span class="number">0x84</span>, <span class="number">0x44</span>, <span class="number">0xF8</span>, <span class="number">0x02</span>, <span class="number">0x7E</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9E</span>, <span class="number">0xA8</span>,</span><br><span class="line">        <span class="number">0x50</span>, <span class="number">0xA2</span>, <span class="number">0x40</span>, <span class="number">0x8E</span>, <span class="number">0x92</span>, <span class="number">0x9C</span>, <span class="number">0x38</span>, <span class="number">0xF4</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x20</span>, <span class="number">0x10</span>, <span class="number">0xFE</span>, <span class="number">0xF2</span>, <span class="number">0xD2</span>,</span><br><span class="line">        <span class="number">0xCC</span>, <span class="number">0x0C</span>, <span class="number">0x12</span>, <span class="number">0xEC</span>, <span class="number">0x5E</span>, <span class="number">0x96</span>, <span class="number">0x44</span>, <span class="number">0x16</span>, <span class="number">0xC4</span>, <span class="number">0xA6</span>, <span class="number">0x7E</span>, <span class="number">0x3C</span>, <span class="number">0x64</span>, <span class="number">0x5C</span>, <span class="number">0x18</span>, <span class="number">0x72</span>,</span><br><span class="line">        <span class="number">0x60</span>, <span class="number">0x80</span>, <span class="number">0x4E</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEF</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0A</span>, <span class="number">0xDA</span>,</span><br><span class="line">        <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x48</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD2</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x90</span>, <span class="number">0x94</span>, <span class="number">0xE4</span>, <span class="number">0x78</span>,</span><br><span class="line">        <span class="number">0xE6</span>, <span class="number">0xC8</span>, <span class="number">0x36</span>, <span class="number">0x6C</span>, <span class="number">0x8C</span>, <span class="number">0xD4</span>, <span class="number">0x4E</span>, <span class="number">0xA8</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x64</span>, <span class="number">0x7A</span>, <span class="number">0xAE</span>, <span class="number">0x08</span>,</span><br><span class="line">        <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x24</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDC</span>, <span class="number">0x74</span>, <span class="number">0x1E</span>, <span class="number">0x4A</span>, <span class="number">0xBC</span>, <span class="number">0x8A</span>, <span class="number">0x8A</span>,</span><br><span class="line">        <span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB4</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x02</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x60</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0xB8</span>, <span class="number">0x86</span>, <span class="number">0xC0</span>, <span class="number">0x1C</span>, <span class="number">0x9E</span>,</span><br><span class="line">        <span class="number">0xE0</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x10</span>, <span class="number">0x68</span>, <span class="number">0xD8</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9A</span>, <span class="number">0x1E</span>, <span class="number">0x86</span>, <span class="number">0xE8</span>, <span class="number">0xCE</span>, <span class="number">0x54</span>, <span class="number">0x28</span>, <span class="number">0xDE</span>,</span><br><span class="line">        <span class="number">0x8C</span>, <span class="number">0xA0</span>, <span class="number">0x88</span>, <span class="number">0x0C</span>, <span class="number">0xBE</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x40</span>, <span class="number">0x98</span>, <span class="number">0x2C</span>, <span class="number">0x0E</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBA</span>, <span class="number">0x16</span>], dtype=np.uint8)</span><br><span class="line"></span><br><span class="line">invs = np.array([<span class="number">0x71</span>, <span class="number">0x6c</span>, <span class="number">0x7a</span>, <span class="number">0xb8</span>, <span class="number">0x16</span>, <span class="number">0x0f</span>, <span class="number">0x1e</span>, <span class="number">0x41</span>, <span class="number">0x35</span>, <span class="number">0xeb</span>, <span class="number">0xd0</span>, <span class="number">0x2a</span>, <span class="number">0xe4</span>, <span class="number">0xac</span>, <span class="number">0x62</span>, <span class="number">0x5a</span>,</span><br><span class="line">        <span class="number">0xcd</span>, <span class="number">0xc8</span>, <span class="number">0xdb</span>, <span class="number">0x1a</span>, <span class="number">0x0a</span>, <span class="number">0x8e</span>, <span class="number">0x08</span>, <span class="number">0x46</span>, <span class="number">0xf0</span>, <span class="number">0x4b</span>, <span class="number">0x96</span>, <span class="number">0xc1</span>, <span class="number">0x32</span>, <span class="number">0xa0</span>, <span class="number">0x60</span>, <span class="number">0xcc</span>,</span><br><span class="line">        <span class="number">0xf7</span>, <span class="number">0x6d</span>, <span class="number">0x69</span>, <span class="number">0xaa</span>, <span class="number">0x61</span>, <span class="number">0x68</span>, <span class="number">0x1b</span>, <span class="number">0x76</span>, <span class="number">0x0c</span>, <span class="number">0xa9</span>, <span class="number">0x14</span>, <span class="number">0x10</span>, <span class="number">0x0e</span>, <span class="number">0xd8</span>, <span class="number">0xa3</span>, <span class="number">0xb7</span>,</span><br><span class="line">        <span class="number">0x9b</span>, <span class="number">0xd2</span>, <span class="number">0x9a</span>, <span class="number">0x28</span>, <span class="number">0x95</span>, <span class="number">0x5f</span>, <span class="number">0x79</span>, <span class="number">0xb2</span>, <span class="number">0x86</span>, <span class="number">0xfe</span>, <span class="number">0xf4</span>, <span class="number">0x6b</span>, <span class="number">0x4a</span>, <span class="number">0x06</span>, <span class="number">0xfb</span>, <span class="number">0x3e</span>,</span><br><span class="line">        <span class="number">0x84</span>, <span class="number">0xcb</span>, <span class="number">0x21</span>, <span class="number">0x2b</span>, <span class="number">0x19</span>, <span class="number">0xb3</span>, <span class="number">0x72</span>, <span class="number">0x40</span>, <span class="number">0xff</span>, <span class="number">0x1c</span>, <span class="number">0xe3</span>, <span class="number">0x5b</span>, <span class="number">0x78</span>, <span class="number">0xf6</span>, <span class="number">0xae</span>, <span class="number">0x4e</span>,</span><br><span class="line">        <span class="number">0x22</span>, <span class="number">0xbf</span>, <span class="number">0x77</span>, <span class="number">0xad</span>, <span class="number">0x29</span>, <span class="number">0x97</span>, <span class="number">0x5d</span>, <span class="number">0x73</span>, <span class="number">0x65</span>, <span class="number">0x49</span>, <span class="number">0xce</span>, <span class="number">0xbe</span>, <span class="number">0xca</span>, <span class="number">0x92</span>, <span class="number">0x63</span>, <span class="number">0xfa</span>,</span><br><span class="line">        <span class="number">0xa7</span>, <span class="number">0x8d</span>, <span class="number">0x2f</span>, <span class="number">0x64</span>, <span class="number">0x55</span>, <span class="number">0xe8</span>, <span class="number">0xa5</span>, <span class="number">0x11</span>, <span class="number">0x50</span>, <span class="number">0xe1</span>, <span class="number">0xba</span>, <span class="number">0x51</span>, <span class="number">0xbd</span>, <span class="number">0xbc</span>, <span class="number">0xed</span>, <span class="number">0xaf</span>,</span><br><span class="line">        <span class="number">0x5c</span>, <span class="number">0x54</span>, <span class="number">0xbb</span>, <span class="number">0x45</span>, <span class="number">0xd9</span>, <span class="number">0x3c</span>, <span class="number">0x13</span>, <span class="number">0xe6</span>, <span class="number">0x6e</span>, <span class="number">0xf8</span>, <span class="number">0x27</span>, <span class="number">0xd6</span>, <span class="number">0x6a</span>, <span class="number">0xf2</span>, <span class="number">0xe7</span>, <span class="number">0xc7</span>,</span><br><span class="line">        <span class="number">0x38</span>, <span class="number">0x52</span>, <span class="number">0xa4</span>, <span class="number">0x48</span>, <span class="number">0xef</span>, <span class="number">0x4d</span>, <span class="number">0x1d</span>, <span class="number">0x6f</span>, <span class="number">0xd3</span>, <span class="number">0xe0</span>, <span class="number">0x82</span>, <span class="number">0x57</span>, <span class="number">0x9d</span>, <span class="number">0xc0</span>, <span class="number">0xb6</span>, <span class="number">0x3d</span>,</span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x24</span>, <span class="number">0xc3</span>, <span class="number">0x99</span>, <span class="number">0x3a</span>, <span class="number">0x37</span>, <span class="number">0xe5</span>, <span class="number">0xe2</span>, <span class="number">0x26</span>, <span class="number">0x1f</span>, <span class="number">0x12</span>, <span class="number">0x94</span>, <span class="number">0x20</span>, <span class="number">0x5e</span>, <span class="number">0x7f</span>, <span class="number">0x74</span>,</span><br><span class="line">        <span class="number">0x7c</span>, <span class="number">0x8f</span>, <span class="number">0x67</span>, <span class="number">0x88</span>, <span class="number">0x93</span>, <span class="number">0xd4</span>, <span class="number">0x3f</span>, <span class="number">0x42</span>, <span class="number">0x4f</span>, <span class="number">0x33</span>, <span class="number">0x18</span>, <span class="number">0xab</span>, <span class="number">0x2e</span>, <span class="number">0x98</span>, <span class="number">0x91</span>, <span class="number">0xc2</span>,</span><br><span class="line">        <span class="number">0xdf</span>, <span class="number">0x9e</span>, <span class="number">0x53</span>, <span class="number">0x31</span>, <span class="number">0xde</span>, <span class="number">0x87</span>, <span class="number">0x09</span>, <span class="number">0x07</span>, <span class="number">0xdc</span>, <span class="number">0xe9</span>, <span class="number">0x47</span>, <span class="number">0xc4</span>, <span class="number">0xc6</span>, <span class="number">0xd7</span>, <span class="number">0x15</span>, <span class="number">0x81</span>,</span><br><span class="line">        <span class="number">0xa8</span>, <span class="number">0xd1</span>, <span class="number">0x0b</span>, <span class="number">0x17</span>, <span class="number">0x7d</span>, <span class="number">0xec</span>, <span class="number">0xee</span>, <span class="number">0x85</span>, <span class="number">0x7e</span>, <span class="number">0x34</span>, <span class="number">0xa6</span>, <span class="number">0xfd</span>, <span class="number">0x04</span>, <span class="number">0xd5</span>, <span class="number">0x8b</span>, <span class="number">0x2d</span>,</span><br><span class="line">        <span class="number">0xda</span>, <span class="number">0x66</span>, <span class="number">0x83</span>, <span class="number">0x75</span>, <span class="number">0x70</span>, <span class="number">0xb0</span>, <span class="number">0x00</span>, <span class="number">0xfc</span>, <span class="number">0xcf</span>, <span class="number">0xc9</span>, <span class="number">0x56</span>, <span class="number">0xb1</span>, <span class="number">0xf5</span>, <span class="number">0xc5</span>, <span class="number">0xb4</span>, <span class="number">0x39</span>,</span><br><span class="line">        <span class="number">0x90</span>, <span class="number">0x05</span>, <span class="number">0xa2</span>, <span class="number">0x9f</span>, <span class="number">0x30</span>, <span class="number">0xdd</span>, <span class="number">0x4c</span>, <span class="number">0x7b</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0x80</span>, <span class="number">0x59</span>, <span class="number">0xf3</span>, <span class="number">0x2c</span>, <span class="number">0xf9</span>, <span class="number">0x25</span>,</span><br><span class="line">        <span class="number">0xf1</span>, <span class="number">0xea</span>, <span class="number">0x8a</span>, <span class="number">0x44</span>, <span class="number">0x23</span>, <span class="number">0x9c</span>, <span class="number">0xa1</span>, <span class="number">0x89</span>, <span class="number">0x58</span>, <span class="number">0x8c</span>, <span class="number">0x3b</span>, <span class="number">0x0d</span>, <span class="number">0x43</span>, <span class="number">0xb5</span>, <span class="number">0x03</span>, <span class="number">0xb9</span>], dtype=np.uint8)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/(2025.04.26-2025.04.27) ACTF 2025/deeptx/3逆向cycle/encflag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    encflag = file.read().strip()</span><br><span class="line">final = np.frombuffer(<span class="built_in">bytearray</span>.fromhex(encflag), dtype=np.uint8)</span><br><span class="line"></span><br><span class="line"><span class="meta">@njit</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dec_cycle</span>(<span class="params">final, invs, tbox</span>):</span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> cycle <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4137822</span>, <span class="number">7</span>, -<span class="number">1</span>):</span><br><span class="line">                final[<span class="number">256</span> * block + thread] = ((((((invs[final[<span class="number">256</span> * block + thread]] ^ tbox[cycle &amp; <span class="number">0xFF</span>]) - (block ^ thread)) * <span class="number">197</span>) &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">5</span>) | (((((invs[final[<span class="number">256</span> * block + thread]] ^ tbox[cycle &amp; <span class="number">0xFF</span>]) - (block ^ thread)) * <span class="number">197</span>) &amp; <span class="number">0xFF</span>) &gt;&gt; <span class="number">3</span>)) &amp; <span class="number">0xFF</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="number">256</span> * block + thread)</span><br><span class="line">    <span class="keyword">return</span> final</span><br><span class="line"></span><br><span class="line">final = dec_cycle(final, invs, tbox)</span><br><span class="line"><span class="built_in">print</span>(final.tobytes().<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>
<p>恢复出ttl，接下来的部分要解矩阵，注意到在一个block内，ttl是256字节的data和系数的乘积的加和，data可以看做一个256维向量，256线程的256轮的系数可以看做一个256阶的系数矩阵，矩阵乘以向量得到输出ttl，使用z3求解data：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/(2025.04.26-2025.04.27) ACTF 2025/deeptx/3逆向cycle/encflag_decycle.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    encfs = file.read().strip()</span><br><span class="line">encf = np.array(<span class="built_in">bytearray</span>.fromhex(encfs), dtype=np.uint8)</span><br><span class="line">data = encf.reshape((<span class="number">256</span>, <span class="number">256</span>))</span><br><span class="line"></span><br><span class="line">sbox_ori = [<span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xE9</span>, <span class="number">0xFE</span>, <span class="number">0xCC</span>, <span class="number">0xE1</span>, <span class="number">0x3D</span>, <span class="number">0xB7</span>, <span class="number">0x16</span>, <span class="number">0xB6</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x28</span>, <span class="number">0xFB</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>,</span><br><span class="line">            <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x9A</span>, <span class="number">0x76</span>, <span class="number">0x2A</span>, <span class="number">0xBE</span>, <span class="number">0x04</span>, <span class="number">0xC3</span>, <span class="number">0xAA</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>,</span><br><span class="line">            <span class="number">0x9C</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xF4</span>, <span class="number">0x91</span>, <span class="number">0xEF</span>, <span class="number">0x98</span>, <span class="number">0x7A</span>, <span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0B</span>, <span class="number">0x43</span>, <span class="number">0xED</span>, <span class="number">0xCF</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>,</span><br><span class="line">            <span class="number">0xE4</span>, <span class="number">0xB3</span>, <span class="number">0x1C</span>, <span class="number">0xA9</span>, <span class="number">0xC9</span>, <span class="number">0x08</span>, <span class="number">0xE8</span>, <span class="number">0x95</span>, <span class="number">0x80</span>, <span class="number">0xDF</span>, <span class="number">0x94</span>, <span class="number">0xFA</span>, <span class="number">0x75</span>, <span class="number">0x8F</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>,</span><br><span class="line">            <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xA7</span>, <span class="number">0xFC</span>, <span class="number">0xF3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xBA</span>, <span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3C</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x4F</span>, <span class="number">0xA8</span>,</span><br><span class="line">            <span class="number">0x68</span>, <span class="number">0x6B</span>, <span class="number">0x81</span>, <span class="number">0xB2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xDA</span>, <span class="number">0x8B</span>, <span class="number">0xF8</span>, <span class="number">0xEB</span>, <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x35</span>,</span><br><span class="line">            <span class="number">0x1E</span>, <span class="number">0x24</span>, <span class="number">0x0E</span>, <span class="number">0x5E</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xD1</span>, <span class="number">0xA2</span>, <span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7C</span>, <span class="number">0x3B</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>,</span><br><span class="line">            <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9F</span>, <span class="number">0xD3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>, <span class="number">0x4C</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xE7</span>, <span class="number">0xA0</span>, <span class="number">0xC4</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>,</span><br><span class="line">            <span class="number">0xEA</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0xD2</span>, <span class="number">0x40</span>, <span class="number">0xC7</span>, <span class="number">0x38</span>, <span class="number">0xB5</span>, <span class="number">0xA3</span>, <span class="number">0xF7</span>, <span class="number">0xF2</span>, <span class="number">0xCE</span>, <span class="number">0xF9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xA1</span>,</span><br><span class="line">            <span class="number">0xE0</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xA4</span>, <span class="number">0x9B</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x55</span>, <span class="number">0xAD</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xF5</span>, <span class="number">0x8C</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>,</span><br><span class="line">            <span class="number">0x1D</span>, <span class="number">0xF6</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xCA</span>, <span class="number">0x60</span>, <span class="number">0xC0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xAB</span>, <span class="number">0x0D</span>, <span class="number">0x53</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>,</span><br><span class="line">            <span class="number">0xD5</span>, <span class="number">0xDB</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xDE</span>, <span class="number">0xFD</span>, <span class="number">0x8E</span>, <span class="number">0x2F</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x6A</span>, <span class="number">0x72</span>, <span class="number">0x6D</span>, <span class="number">0x6C</span>, <span class="number">0x5B</span>, <span class="number">0x51</span>,</span><br><span class="line">            <span class="number">0x8D</span>, <span class="number">0x1B</span>, <span class="number">0xAF</span>, <span class="number">0x92</span>, <span class="number">0xBB</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x7F</span>, <span class="number">0x11</span>, <span class="number">0xD9</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x5A</span>, <span class="number">0xD8</span>,</span><br><span class="line">            <span class="number">0x0A</span>, <span class="number">0xC1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xA5</span>, <span class="number">0xCD</span>, <span class="number">0x7B</span>, <span class="number">0xBD</span>, <span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0xD0</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0xE5</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>,</span><br><span class="line">            <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4A</span>, <span class="number">0x0C</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>, <span class="number">0x65</span>, <span class="number">0xB9</span>, <span class="number">0xF1</span>, <span class="number">0x09</span>, <span class="number">0xC5</span>, <span class="number">0x6E</span>, <span class="number">0xC6</span>, <span class="number">0x84</span>,</span><br><span class="line">            <span class="number">0x18</span>, <span class="number">0xF0</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x3A</span>, <span class="number">0xDC</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>, <span class="number">0x79</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0x3E</span>, <span class="number">0xD7</span>, <span class="number">0xCB</span>, <span class="number">0x39</span>, <span class="number">0x48</span>]</span><br><span class="line"></span><br><span class="line">tbox = [<span class="number">0x62</span>, <span class="number">0x7C</span>, <span class="number">0x76</span>, <span class="number">0x7A</span>, <span class="number">0xF2</span>, <span class="number">0x6A</span>, <span class="number">0x6E</span>, <span class="number">0xC4</span>, <span class="number">0x30</span>, <span class="number">0x00</span>, <span class="number">0x66</span>, <span class="number">0x2A</span>, <span class="number">0xFE</span>, <span class="number">0xD6</span>, <span class="number">0xAA</span>, <span class="number">0x76</span>,</span><br><span class="line">        <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC8</span>, <span class="number">0x7C</span>, <span class="number">0xFA</span>, <span class="number">0x58</span>, <span class="number">0x46</span>, <span class="number">0xF0</span>, <span class="number">0xAC</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAE</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>,</span><br><span class="line">        <span class="number">0xB6</span>, <span class="number">0xFC</span>, <span class="number">0x92</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3E</span>, <span class="number">0xF6</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA4</span>, <span class="number">0xE4</span>, <span class="number">0xF0</span>, <span class="number">0x70</span>, <span class="number">0xD8</span>, <span class="number">0x30</span>, <span class="number">0x14</span>,</span><br><span class="line">        <span class="number">0x04</span>, <span class="number">0xC6</span>, <span class="number">0x22</span>, <span class="number">0xC2</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x04</span>, <span class="number">0x9A</span>, <span class="number">0x06</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEA</span>, <span class="number">0x26</span>, <span class="number">0xB2</span>, <span class="number">0x74</span>,</span><br><span class="line">        <span class="number">0x08</span>, <span class="number">0x82</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1A</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3A</span>, <span class="number">0xD6</span>, <span class="number">0xB2</span>, <span class="number">0x28</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x84</span>,</span><br><span class="line">        <span class="number">0x52</span>, <span class="number">0xD0</span>, <span class="number">0x00</span>, <span class="number">0xEC</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB0</span>, <span class="number">0x5A</span>, <span class="number">0x6A</span>, <span class="number">0xCA</span>, <span class="number">0xBE</span>, <span class="number">0x38</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCE</span>,</span><br><span class="line">        <span class="number">0xD0</span>, <span class="number">0xEE</span>, <span class="number">0xAA</span>, <span class="number">0xFA</span>, <span class="number">0x42</span>, <span class="number">0x4C</span>, <span class="number">0x32</span>, <span class="number">0x84</span>, <span class="number">0x44</span>, <span class="number">0xF8</span>, <span class="number">0x02</span>, <span class="number">0x7E</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9E</span>, <span class="number">0xA8</span>,</span><br><span class="line">        <span class="number">0x50</span>, <span class="number">0xA2</span>, <span class="number">0x40</span>, <span class="number">0x8E</span>, <span class="number">0x92</span>, <span class="number">0x9C</span>, <span class="number">0x38</span>, <span class="number">0xF4</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x20</span>, <span class="number">0x10</span>, <span class="number">0xFE</span>, <span class="number">0xF2</span>, <span class="number">0xD2</span>,</span><br><span class="line">        <span class="number">0xCC</span>, <span class="number">0x0C</span>, <span class="number">0x12</span>, <span class="number">0xEC</span>, <span class="number">0x5E</span>, <span class="number">0x96</span>, <span class="number">0x44</span>, <span class="number">0x16</span>, <span class="number">0xC4</span>, <span class="number">0xA6</span>, <span class="number">0x7E</span>, <span class="number">0x3C</span>, <span class="number">0x64</span>, <span class="number">0x5C</span>, <span class="number">0x18</span>, <span class="number">0x72</span>,</span><br><span class="line">        <span class="number">0x60</span>, <span class="number">0x80</span>, <span class="number">0x4E</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEF</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0A</span>, <span class="number">0xDA</span>,</span><br><span class="line">        <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x48</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD2</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x90</span>, <span class="number">0x94</span>, <span class="number">0xE4</span>, <span class="number">0x78</span>,</span><br><span class="line">        <span class="number">0xE6</span>, <span class="number">0xC8</span>, <span class="number">0x36</span>, <span class="number">0x6C</span>, <span class="number">0x8C</span>, <span class="number">0xD4</span>, <span class="number">0x4E</span>, <span class="number">0xA8</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x64</span>, <span class="number">0x7A</span>, <span class="number">0xAE</span>, <span class="number">0x08</span>,</span><br><span class="line">        <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x24</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDC</span>, <span class="number">0x74</span>, <span class="number">0x1E</span>, <span class="number">0x4A</span>, <span class="number">0xBC</span>, <span class="number">0x8A</span>, <span class="number">0x8A</span>,</span><br><span class="line">        <span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB4</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x02</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x60</span>, <span class="number">0x34</span>, <span class="number">0x56</span>, <span class="number">0xB8</span>, <span class="number">0x86</span>, <span class="number">0xC0</span>, <span class="number">0x1C</span>, <span class="number">0x9E</span>,</span><br><span class="line">        <span class="number">0xE0</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x10</span>, <span class="number">0x68</span>, <span class="number">0xD8</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9A</span>, <span class="number">0x1E</span>, <span class="number">0x86</span>, <span class="number">0xE8</span>, <span class="number">0xCE</span>, <span class="number">0x54</span>, <span class="number">0x28</span>, <span class="number">0xDE</span>,</span><br><span class="line">        <span class="number">0x8C</span>, <span class="number">0xA0</span>, <span class="number">0x88</span>, <span class="number">0x0C</span>, <span class="number">0xBE</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x40</span>, <span class="number">0x98</span>, <span class="number">0x2C</span>, <span class="number">0x0E</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBA</span>, <span class="number">0x16</span>]</span><br><span class="line"></span><br><span class="line">C = [[<span class="number">0</span>] * <span class="number">256</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    sbox = sbox_ori.copy()</span><br><span class="line">    <span class="keyword">for</span> rounds <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        C[thread][rounds] = tbox[sbox[thread]]</span><br><span class="line">        sbox[thread] = (sbox[thread] * <span class="number">5</span> + <span class="number">17</span>) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line">all_b_dat = []</span><br><span class="line"><span class="keyword">for</span> block_idx <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">256</span>), desc=<span class="string">&quot;Processing Blocks&quot;</span>):</span><br><span class="line">    ttl = data[block_idx]</span><br><span class="line">    solver = Solver()</span><br><span class="line">    b_dat = [BitVec(<span class="string">f&#x27;b_dat_<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        linear_combination = <span class="built_in">sum</span>(C[thread][rounds] * b_dat[rounds] <span class="keyword">for</span> rounds <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">        solver.add(linear_combination % <span class="number">256</span> == ttl[thread])</span><br><span class="line">    <span class="keyword">if</span> solver.check() == sat:</span><br><span class="line">        model = solver.model()</span><br><span class="line">        b_dat_solution = [model[b_dat[i]].as_long() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">        all_b_dat.extend(b_dat_solution)</span><br><span class="line">        is_correct = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            sbox = sbox_ori.copy()</span><br><span class="line">            calculated_ttl = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> rounds <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                calculated_ttl += tbox[sbox[thread]] * b_dat_solution[rounds]</span><br><span class="line">                sbox[thread] = (sbox[thread] * <span class="number">5</span> + <span class="number">17</span>) &amp; <span class="number">0xFF</span></span><br><span class="line">            <span class="keyword">if</span> (calculated_ttl &amp; <span class="number">0xFF</span>) != ttl[thread]:</span><br><span class="line">                is_correct = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">bytearray</span>(b_dat_solution).<span class="built_in">hex</span>())</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Block <span class="subst">&#123;block_idx&#125;</span>: <span class="subst">&#123;<span class="string">&#x27;Correct&#x27;</span> <span class="keyword">if</span> is_correct <span class="keyword">else</span> <span class="string">&#x27;Incorrect&#x27;</span>&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Block <span class="subst">&#123;block_idx&#125;</span>: No solution found&quot;</span>)</span><br><span class="line"></span><br><span class="line">all_b_dat = np.array(all_b_dat, dtype=np.uint8)</span><br><span class="line">np.save(<span class="string">&quot;recovered_b_dat.npy&quot;</span>, all_b_dat)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;All b_dat recovered and saved to &#x27;recovered_b_dat.npy&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>接下来对layer3剩余的两个异或和TEA加密进行逆向：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> numba <span class="keyword">import</span> njit</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytes_to_dwords_little_endian</span>(<span class="params">byte_array</span>):</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(byte_array[i:i+<span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">False</span>)<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(byte_array), <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dwords_to_bytes_little_endian</span>(<span class="params">dword_array</span>):</span><br><span class="line">    byte_list = []</span><br><span class="line">    <span class="keyword">for</span> dword <span class="keyword">in</span> dword_array:</span><br><span class="line">        byte_list.extend(dword.to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> byte_list</span><br><span class="line"></span><br><span class="line">bdat = np.load(<span class="string">&quot;/(2025.04.26-2025.04.27) ACTF 2025/deeptx/4逆向boxexchange/recovered_b_dat.npy&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        val = block &amp; thread</span><br><span class="line">        bdat[<span class="number">256</span> * block + thread] ^= val</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(bdat)</span><br><span class="line">d_dat = bytes_to_dwords_little_endian(bdat)</span><br><span class="line"></span><br><span class="line"><span class="meta">@njit</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tea_dec</span>(<span class="params">d_dat</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(d_dat) // <span class="number">2</span>):</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        m1 = d_dat[<span class="number">2</span> * i]</span><br><span class="line">        m2 = d_dat[<span class="number">2</span> * i + <span class="number">1</span>]</span><br><span class="line">        ttl = (<span class="number">0x6a82c908</span> + <span class="number">0x9a28b107</span> * <span class="number">3238567</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3238567</span>):</span><br><span class="line">            ttl = (ttl - <span class="number">0x9a28b107</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            m1 = (m1 + (((m2 &gt;&gt; <span class="number">5</span>) + <span class="number">0xcc981337</span>) ^ ((m2 &lt;&lt; <span class="number">4</span>) + <span class="number">0x250de9f3</span>) ^ (m2 + ttl))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            m2 = (m2 - (((m1 &gt;&gt; <span class="number">5</span>) + <span class="number">0x77a13408</span>) ^ ((m1 &lt;&lt; <span class="number">4</span>) + <span class="number">0x52a9002c</span>) ^ (m1 + ttl))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        d_dat[<span class="number">2</span> * i] = m1</span><br><span class="line">        d_dat[<span class="number">2</span> * i + <span class="number">1</span>] = m2</span><br><span class="line">    <span class="keyword">return</span> d_dat</span><br><span class="line"></span><br><span class="line">d_dat = tea_dec(d_dat)</span><br><span class="line">b_dat = dwords_to_bytes_little_endian(d_dat)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        val = block | thread</span><br><span class="line">        b_dat[<span class="number">256</span> * block + thread] ^= val</span><br><span class="line"></span><br><span class="line">np.save(<span class="string">&quot;enc_layer2.npy&quot;</span>, b_dat)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;All b_dat recovered and saved to &#x27;enc_layer2.npy&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>得到layer2加密后的结果，还原layer2并验证：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">sbox = np.array([<span class="number">0xD6</span>, <span class="number">0x90</span>, <span class="number">0xE9</span>, <span class="number">0xFE</span>, <span class="number">0xCC</span>, <span class="number">0xE1</span>, <span class="number">0x3D</span>, <span class="number">0xB7</span>, <span class="number">0x16</span>, <span class="number">0xB6</span>, <span class="number">0x14</span>, <span class="number">0xC2</span>, <span class="number">0x28</span>, <span class="number">0xFB</span>, <span class="number">0x2C</span>, <span class="number">0x05</span>,</span><br><span class="line">        <span class="number">0x2B</span>, <span class="number">0x67</span>, <span class="number">0x9A</span>, <span class="number">0x76</span>, <span class="number">0x2A</span>, <span class="number">0xBE</span>, <span class="number">0x04</span>, <span class="number">0xC3</span>, <span class="number">0xAA</span>, <span class="number">0x44</span>, <span class="number">0x13</span>, <span class="number">0x26</span>, <span class="number">0x49</span>, <span class="number">0x86</span>, <span class="number">0x06</span>, <span class="number">0x99</span>,</span><br><span class="line">        <span class="number">0x9C</span>, <span class="number">0x42</span>, <span class="number">0x50</span>, <span class="number">0xF4</span>, <span class="number">0x91</span>, <span class="number">0xEF</span>, <span class="number">0x98</span>, <span class="number">0x7A</span>, <span class="number">0x33</span>, <span class="number">0x54</span>, <span class="number">0x0B</span>, <span class="number">0x43</span>, <span class="number">0xED</span>, <span class="number">0xCF</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>,</span><br><span class="line">        <span class="number">0xE4</span>, <span class="number">0xB3</span>, <span class="number">0x1C</span>, <span class="number">0xA9</span>, <span class="number">0xC9</span>, <span class="number">0x08</span>, <span class="number">0xE8</span>, <span class="number">0x95</span>, <span class="number">0x80</span>, <span class="number">0xDF</span>, <span class="number">0x94</span>, <span class="number">0xFA</span>, <span class="number">0x75</span>, <span class="number">0x8F</span>, <span class="number">0x3F</span>, <span class="number">0xA6</span>,</span><br><span class="line">        <span class="number">0x47</span>, <span class="number">0x07</span>, <span class="number">0xA7</span>, <span class="number">0xFC</span>, <span class="number">0xF3</span>, <span class="number">0x73</span>, <span class="number">0x17</span>, <span class="number">0xBA</span>, <span class="number">0x83</span>, <span class="number">0x59</span>, <span class="number">0x3C</span>, <span class="number">0x19</span>, <span class="number">0xE6</span>, <span class="number">0x85</span>, <span class="number">0x4F</span>, <span class="number">0xA8</span>,</span><br><span class="line">        <span class="number">0x68</span>, <span class="number">0x6B</span>, <span class="number">0x81</span>, <span class="number">0xB2</span>, <span class="number">0x71</span>, <span class="number">0x64</span>, <span class="number">0xDA</span>, <span class="number">0x8B</span>, <span class="number">0xF8</span>, <span class="number">0xEB</span>, <span class="number">0x0F</span>, <span class="number">0x4B</span>, <span class="number">0x70</span>, <span class="number">0x56</span>, <span class="number">0x9D</span>, <span class="number">0x35</span>,</span><br><span class="line">        <span class="number">0x1E</span>, <span class="number">0x24</span>, <span class="number">0x0E</span>, <span class="number">0x5E</span>, <span class="number">0x63</span>, <span class="number">0x58</span>, <span class="number">0xD1</span>, <span class="number">0xA2</span>, <span class="number">0x25</span>, <span class="number">0x22</span>, <span class="number">0x7C</span>, <span class="number">0x3B</span>, <span class="number">0x01</span>, <span class="number">0x21</span>, <span class="number">0x78</span>, <span class="number">0x87</span>,</span><br><span class="line">        <span class="number">0xD4</span>, <span class="number">0x00</span>, <span class="number">0x46</span>, <span class="number">0x57</span>, <span class="number">0x9F</span>, <span class="number">0xD3</span>, <span class="number">0x27</span>, <span class="number">0x52</span>, <span class="number">0x4C</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0xE7</span>, <span class="number">0xA0</span>, <span class="number">0xC4</span>, <span class="number">0xC8</span>, <span class="number">0x9E</span>,</span><br><span class="line">        <span class="number">0xEA</span>, <span class="number">0xBF</span>, <span class="number">0x8A</span>, <span class="number">0xD2</span>, <span class="number">0x40</span>, <span class="number">0xC7</span>, <span class="number">0x38</span>, <span class="number">0xB5</span>, <span class="number">0xA3</span>, <span class="number">0xF7</span>, <span class="number">0xF2</span>, <span class="number">0xCE</span>, <span class="number">0xF9</span>, <span class="number">0x61</span>, <span class="number">0x15</span>, <span class="number">0xA1</span>,</span><br><span class="line">        <span class="number">0xE0</span>, <span class="number">0xAE</span>, <span class="number">0x5D</span>, <span class="number">0xA4</span>, <span class="number">0x9B</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x55</span>, <span class="number">0xAD</span>, <span class="number">0x93</span>, <span class="number">0x32</span>, <span class="number">0x30</span>, <span class="number">0xF5</span>, <span class="number">0x8C</span>, <span class="number">0xB1</span>, <span class="number">0xE3</span>,</span><br><span class="line">        <span class="number">0x1D</span>, <span class="number">0xF6</span>, <span class="number">0xE2</span>, <span class="number">0x2E</span>, <span class="number">0x82</span>, <span class="number">0x66</span>, <span class="number">0xCA</span>, <span class="number">0x60</span>, <span class="number">0xC0</span>, <span class="number">0x29</span>, <span class="number">0x23</span>, <span class="number">0xAB</span>, <span class="number">0x0D</span>, <span class="number">0x53</span>, <span class="number">0x4E</span>, <span class="number">0x6F</span>,</span><br><span class="line">        <span class="number">0xD5</span>, <span class="number">0xDB</span>, <span class="number">0x37</span>, <span class="number">0x45</span>, <span class="number">0xDE</span>, <span class="number">0xFD</span>, <span class="number">0x8E</span>, <span class="number">0x2F</span>, <span class="number">0x03</span>, <span class="number">0xFF</span>, <span class="number">0x6A</span>, <span class="number">0x72</span>, <span class="number">0x6D</span>, <span class="number">0x6C</span>, <span class="number">0x5B</span>, <span class="number">0x51</span>,</span><br><span class="line">        <span class="number">0x8D</span>, <span class="number">0x1B</span>, <span class="number">0xAF</span>, <span class="number">0x92</span>, <span class="number">0xBB</span>, <span class="number">0xDD</span>, <span class="number">0xBC</span>, <span class="number">0x7F</span>, <span class="number">0x11</span>, <span class="number">0xD9</span>, <span class="number">0x5C</span>, <span class="number">0x41</span>, <span class="number">0x1F</span>, <span class="number">0x10</span>, <span class="number">0x5A</span>, <span class="number">0xD8</span>,</span><br><span class="line">        <span class="number">0x0A</span>, <span class="number">0xC1</span>, <span class="number">0x31</span>, <span class="number">0x88</span>, <span class="number">0xA5</span>, <span class="number">0xCD</span>, <span class="number">0x7B</span>, <span class="number">0xBD</span>, <span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0xD0</span>, <span class="number">0x12</span>, <span class="number">0xB8</span>, <span class="number">0xE5</span>, <span class="number">0xB4</span>, <span class="number">0xB0</span>,</span><br><span class="line">        <span class="number">0x89</span>, <span class="number">0x69</span>, <span class="number">0x97</span>, <span class="number">0x4A</span>, <span class="number">0x0C</span>, <span class="number">0x96</span>, <span class="number">0x77</span>, <span class="number">0x7E</span>, <span class="number">0x65</span>, <span class="number">0xB9</span>, <span class="number">0xF1</span>, <span class="number">0x09</span>, <span class="number">0xC5</span>, <span class="number">0x6E</span>, <span class="number">0xC6</span>, <span class="number">0x84</span>,</span><br><span class="line">        <span class="number">0x18</span>, <span class="number">0xF0</span>, <span class="number">0x7D</span>, <span class="number">0xEC</span>, <span class="number">0x3A</span>, <span class="number">0xDC</span>, <span class="number">0x4D</span>, <span class="number">0x20</span>, <span class="number">0x79</span>, <span class="number">0xEE</span>, <span class="number">0x5F</span>, <span class="number">0x3E</span>, <span class="number">0xD7</span>, <span class="number">0xCB</span>, <span class="number">0x39</span>, <span class="number">0x48</span>], dtype=np.uint8)</span><br><span class="line"></span><br><span class="line">invs = np.array([<span class="number">0x71</span>, <span class="number">0x6c</span>, <span class="number">0x7a</span>, <span class="number">0xb8</span>, <span class="number">0x16</span>, <span class="number">0x0f</span>, <span class="number">0x1e</span>, <span class="number">0x41</span>, <span class="number">0x35</span>, <span class="number">0xeb</span>, <span class="number">0xd0</span>, <span class="number">0x2a</span>, <span class="number">0xe4</span>, <span class="number">0xac</span>, <span class="number">0x62</span>, <span class="number">0x5a</span>,</span><br><span class="line">        <span class="number">0xcd</span>, <span class="number">0xc8</span>, <span class="number">0xdb</span>, <span class="number">0x1a</span>, <span class="number">0x0a</span>, <span class="number">0x8e</span>, <span class="number">0x08</span>, <span class="number">0x46</span>, <span class="number">0xf0</span>, <span class="number">0x4b</span>, <span class="number">0x96</span>, <span class="number">0xc1</span>, <span class="number">0x32</span>, <span class="number">0xa0</span>, <span class="number">0x60</span>, <span class="number">0xcc</span>,</span><br><span class="line">        <span class="number">0xf7</span>, <span class="number">0x6d</span>, <span class="number">0x69</span>, <span class="number">0xaa</span>, <span class="number">0x61</span>, <span class="number">0x68</span>, <span class="number">0x1b</span>, <span class="number">0x76</span>, <span class="number">0x0c</span>, <span class="number">0xa9</span>, <span class="number">0x14</span>, <span class="number">0x10</span>, <span class="number">0x0e</span>, <span class="number">0xd8</span>, <span class="number">0xa3</span>, <span class="number">0xb7</span>,</span><br><span class="line">        <span class="number">0x9b</span>, <span class="number">0xd2</span>, <span class="number">0x9a</span>, <span class="number">0x28</span>, <span class="number">0x95</span>, <span class="number">0x5f</span>, <span class="number">0x79</span>, <span class="number">0xb2</span>, <span class="number">0x86</span>, <span class="number">0xfe</span>, <span class="number">0xf4</span>, <span class="number">0x6b</span>, <span class="number">0x4a</span>, <span class="number">0x06</span>, <span class="number">0xfb</span>, <span class="number">0x3e</span>,</span><br><span class="line">        <span class="number">0x84</span>, <span class="number">0xcb</span>, <span class="number">0x21</span>, <span class="number">0x2b</span>, <span class="number">0x19</span>, <span class="number">0xb3</span>, <span class="number">0x72</span>, <span class="number">0x40</span>, <span class="number">0xff</span>, <span class="number">0x1c</span>, <span class="number">0xe3</span>, <span class="number">0x5b</span>, <span class="number">0x78</span>, <span class="number">0xf6</span>, <span class="number">0xae</span>, <span class="number">0x4e</span>,</span><br><span class="line">        <span class="number">0x22</span>, <span class="number">0xbf</span>, <span class="number">0x77</span>, <span class="number">0xad</span>, <span class="number">0x29</span>, <span class="number">0x97</span>, <span class="number">0x5d</span>, <span class="number">0x73</span>, <span class="number">0x65</span>, <span class="number">0x49</span>, <span class="number">0xce</span>, <span class="number">0xbe</span>, <span class="number">0xca</span>, <span class="number">0x92</span>, <span class="number">0x63</span>, <span class="number">0xfa</span>,</span><br><span class="line">        <span class="number">0xa7</span>, <span class="number">0x8d</span>, <span class="number">0x2f</span>, <span class="number">0x64</span>, <span class="number">0x55</span>, <span class="number">0xe8</span>, <span class="number">0xa5</span>, <span class="number">0x11</span>, <span class="number">0x50</span>, <span class="number">0xe1</span>, <span class="number">0xba</span>, <span class="number">0x51</span>, <span class="number">0xbd</span>, <span class="number">0xbc</span>, <span class="number">0xed</span>, <span class="number">0xaf</span>,</span><br><span class="line">        <span class="number">0x5c</span>, <span class="number">0x54</span>, <span class="number">0xbb</span>, <span class="number">0x45</span>, <span class="number">0xd9</span>, <span class="number">0x3c</span>, <span class="number">0x13</span>, <span class="number">0xe6</span>, <span class="number">0x6e</span>, <span class="number">0xf8</span>, <span class="number">0x27</span>, <span class="number">0xd6</span>, <span class="number">0x6a</span>, <span class="number">0xf2</span>, <span class="number">0xe7</span>, <span class="number">0xc7</span>,</span><br><span class="line">        <span class="number">0x38</span>, <span class="number">0x52</span>, <span class="number">0xa4</span>, <span class="number">0x48</span>, <span class="number">0xef</span>, <span class="number">0x4d</span>, <span class="number">0x1d</span>, <span class="number">0x6f</span>, <span class="number">0xd3</span>, <span class="number">0xe0</span>, <span class="number">0x82</span>, <span class="number">0x57</span>, <span class="number">0x9d</span>, <span class="number">0xc0</span>, <span class="number">0xb6</span>, <span class="number">0x3d</span>,</span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x24</span>, <span class="number">0xc3</span>, <span class="number">0x99</span>, <span class="number">0x3a</span>, <span class="number">0x37</span>, <span class="number">0xe5</span>, <span class="number">0xe2</span>, <span class="number">0x26</span>, <span class="number">0x1f</span>, <span class="number">0x12</span>, <span class="number">0x94</span>, <span class="number">0x20</span>, <span class="number">0x5e</span>, <span class="number">0x7f</span>, <span class="number">0x74</span>,</span><br><span class="line">        <span class="number">0x7c</span>, <span class="number">0x8f</span>, <span class="number">0x67</span>, <span class="number">0x88</span>, <span class="number">0x93</span>, <span class="number">0xd4</span>, <span class="number">0x3f</span>, <span class="number">0x42</span>, <span class="number">0x4f</span>, <span class="number">0x33</span>, <span class="number">0x18</span>, <span class="number">0xab</span>, <span class="number">0x2e</span>, <span class="number">0x98</span>, <span class="number">0x91</span>, <span class="number">0xc2</span>,</span><br><span class="line">        <span class="number">0xdf</span>, <span class="number">0x9e</span>, <span class="number">0x53</span>, <span class="number">0x31</span>, <span class="number">0xde</span>, <span class="number">0x87</span>, <span class="number">0x09</span>, <span class="number">0x07</span>, <span class="number">0xdc</span>, <span class="number">0xe9</span>, <span class="number">0x47</span>, <span class="number">0xc4</span>, <span class="number">0xc6</span>, <span class="number">0xd7</span>, <span class="number">0x15</span>, <span class="number">0x81</span>,</span><br><span class="line">        <span class="number">0xa8</span>, <span class="number">0xd1</span>, <span class="number">0x0b</span>, <span class="number">0x17</span>, <span class="number">0x7d</span>, <span class="number">0xec</span>, <span class="number">0xee</span>, <span class="number">0x85</span>, <span class="number">0x7e</span>, <span class="number">0x34</span>, <span class="number">0xa6</span>, <span class="number">0xfd</span>, <span class="number">0x04</span>, <span class="number">0xd5</span>, <span class="number">0x8b</span>, <span class="number">0x2d</span>,</span><br><span class="line">        <span class="number">0xda</span>, <span class="number">0x66</span>, <span class="number">0x83</span>, <span class="number">0x75</span>, <span class="number">0x70</span>, <span class="number">0xb0</span>, <span class="number">0x00</span>, <span class="number">0xfc</span>, <span class="number">0xcf</span>, <span class="number">0xc9</span>, <span class="number">0x56</span>, <span class="number">0xb1</span>, <span class="number">0xf5</span>, <span class="number">0xc5</span>, <span class="number">0xb4</span>, <span class="number">0x39</span>,</span><br><span class="line">        <span class="number">0x90</span>, <span class="number">0x05</span>, <span class="number">0xa2</span>, <span class="number">0x9f</span>, <span class="number">0x30</span>, <span class="number">0xdd</span>, <span class="number">0x4c</span>, <span class="number">0x7b</span>, <span class="number">0x36</span>, <span class="number">0x02</span>, <span class="number">0x80</span>, <span class="number">0x59</span>, <span class="number">0xf3</span>, <span class="number">0x2c</span>, <span class="number">0xf9</span>, <span class="number">0x25</span>,</span><br><span class="line">        <span class="number">0xf1</span>, <span class="number">0xea</span>, <span class="number">0x8a</span>, <span class="number">0x44</span>, <span class="number">0x23</span>, <span class="number">0x9c</span>, <span class="number">0xa1</span>, <span class="number">0x89</span>, <span class="number">0x58</span>, <span class="number">0x8c</span>, <span class="number">0x3b</span>, <span class="number">0x0d</span>, <span class="number">0x43</span>, <span class="number">0xb5</span>, <span class="number">0x03</span>, <span class="number">0xb9</span>], dtype=np.uint8)</span><br><span class="line"></span><br><span class="line">data = np.load(<span class="string">&quot;/(2025.04.26-2025.04.27) ACTF 2025/deeptx/5逆向layer3剩余部分/enc_layer2.npy&quot;</span>)</span><br><span class="line">dec = np.array([<span class="number">0</span>]*<span class="number">65536</span>).reshape(<span class="number">256</span>*<span class="number">256</span>)</span><br><span class="line">enc = np.array([<span class="number">0</span>]*<span class="number">65536</span>).reshape(<span class="number">256</span>*<span class="number">256</span>)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        dec[invs[thread] * <span class="number">256</span> + invs[block]] = data[block * <span class="number">256</span> + thread]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(dec)</span><br><span class="line">dec = np.array(dec, dtype=np.uint8)</span><br><span class="line">np.save(<span class="string">&quot;enc1.npy&quot;</span>, dec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> block <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        enc[sbox[thread] * <span class="number">256</span> + sbox[block]] = dec[block * <span class="number">256</span> + thread]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(enc)</span><br></pre></td></tr></table></figure>
<p>得到仅layer1加密的flag，查看图像：</p>
<p><img src="/pictures/actf25_motionblur.bmp" title="actf25encflag"></p>
<p>发现只剩下因卷积产生的动态模糊效果了，说明layer2~3的逆向还原完全正确，layer1是一个动态模糊，由于模糊核大部分都是0，考虑用AI恢复字符，尝试多次得到一个比较清晰的图片：</p>
<p><img src="/pictures/actf25_motionrecover.jpg" title="actf25decflag"></p>
<p>编写脚本爆破flag：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"></span><br><span class="line">target_hash = <span class="string">&quot;fe6c63ce926ab3ed8aba9f52a3a3b8b5ef34d00c89708fba719c4cd13d0a9d73&quot;</span></span><br><span class="line"></span><br><span class="line">possible_chars = [</span><br><span class="line">    <span class="built_in">list</span>(<span class="string">&quot;D&quot;</span>),</span><br><span class="line">    <span class="built_in">list</span>(<span class="string">&quot;e&quot;</span>),</span><br><span class="line">    <span class="built_in">list</span>(<span class="string">&quot;E&quot;</span>),</span><br><span class="line">    <span class="built_in">list</span>(<span class="string">&quot;p&quot;</span>),</span><br><span class="line">    <span class="built_in">list</span>(<span class="string">&quot;acemnorstuvwxz&quot;</span>),</span><br><span class="line">    [<span class="string">&quot;C&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;U&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;d&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;A&quot;</span>],</span><br><span class="line">    <span class="built_in">list</span>(<span class="string">&quot;RDUru0Oo&quot;</span>),</span><br><span class="line">    <span class="built_in">list</span>(<span class="string">&quot;Ii71lL&quot;</span>),</span><br><span class="line">    [<span class="string">&quot;Y&quot;</span>, <span class="string">&quot;V&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="string">&quot;y&quot;</span>],</span><br><span class="line">    <span class="built_in">list</span>(<span class="string">&quot;0OoCGQa&quot;</span>),</span><br><span class="line">    [<span class="string">&quot;u&quot;</span>, <span class="string">&quot;U&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;7&quot;</span>, <span class="string">&quot;T&quot;</span>,<span class="string">&quot;Z&quot;</span>],</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">prefix = <span class="string">&quot;ACTF&#123;&quot;</span></span><br><span class="line">suffix = <span class="string">&quot;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_flags</span>(<span class="params">possible_chars, prefix, suffix, target_hash</span>):</span><br><span class="line">    <span class="keyword">for</span> combination <span class="keyword">in</span> product(*possible_chars):</span><br><span class="line">        flag = prefix + <span class="string">&quot;&quot;</span>.join(combination) + suffix</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line">        hash_value = hashlib.sha256(flag.encode()).hexdigest()</span><br><span class="line">        <span class="keyword">if</span> hash_value == target_hash:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Found valid flag: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> flag</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No valid flag found.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">valid_flag = check_flags(possible_chars, prefix, suffix, target_hash)</span><br></pre></td></tr></table></figure>
<p>爆破得到flag：<font color=deepskyblue><strong>ACTF{DeEptCUdAR1VQUZ}</strong></font>.</p>
<h1 id="闲话"><a href="#闲话" class="headerlink" title="闲话"></a>闲话</h1><p>deeptx真难逆😭</p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2025/05/07/jq_25_wu/"
      title="第三届京麒CTF挑战赛·热身赛 WriteUp (Reverse方向)"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        第三届京麒CTF挑战赛·热身赛 WriteUp (Reverse方向)
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2025/04/15/tg_25/"
      title="TGCTF 2025 WriteUp"
     >

    <p class="title-text">
      
        TGCTF 2025 WriteUp
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2025 Astral Prisma<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
