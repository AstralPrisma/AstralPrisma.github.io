<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>第三届京麒CTF挑战赛·初赛 WriteUp (Reverse方向) | 棱晶の小窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="在这里仅给出我个人解出的题目的WriteUp. Customize Virtual Machine：查看main： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757">
<meta property="og:type" content="article">
<meta property="og:title" content="第三届京麒CTF挑战赛·初赛 WriteUp (Reverse方向)">
<meta property="og:url" content="https://astralprisma.github.io/2025/05/24/jq_25_qual/index.html">
<meta property="og:site_name" content="棱晶の小窝">
<meta property="og:description" content="在这里仅给出我个人解出的题目的WriteUp. Customize Virtual Machine：查看main： 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-05-24T15:00:00.000Z">
<meta property="article:modified_time" content="2025-07-27T15:52:25.800Z">
<meta property="article:author" content="Astral Prisma">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/XH.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/OTSA.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>棱晶の小窝 </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/AP.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Astral Prisma </div>
      <div class="dot"></div>
      <div class="subtitle">星界棱晶 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/454936579" title="Bilibili"><image src=https://www.bilibili.com/favicon.ico></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://www.primegrid.com/show_user.php?userid=1243718" title="PrimeGrid"><image src=https://www.primegrid.com/images/favicon_32.png></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/AstralPrisma" title="GitHub"><image src=https://github.githubassets.com/favicons/favicon.png></image></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/Ideas/">
                Ideas
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/WriteUp/">
                WriteUp
                <div class="category-count">27</div>
            </a>
        </div>
    </div>
  </div>


    
      

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-jq_25_qual" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        第三届京麒CTF挑战赛·初赛 WriteUp (Reverse方向)
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2025-05-24T15:00:00.000Z" itemprop="datePublished">2025-05-24</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/WriteUp/">WriteUp</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            2.8k 词 
          </div>
        </div>
        
      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <p><em>在这里仅给出我个人解出的题目的WriteUp.</em></p>
<h1 id="Customize-Virtual-Machine："><a href="#Customize-Virtual-Machine：" class="headerlink" title="Customize Virtual Machine："></a>Customize Virtual Machine：</h1><p>查看main：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">void</span> *addr; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">char</span> *len; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> j; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">char</span> v13; <span class="comment">// bl</span></span><br><span class="line">  <span class="type">int</span> n2; <span class="comment">// ecx</span></span><br><span class="line">  __int64 i_1; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v16; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *p_s1; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">bool</span> v19; <span class="comment">// [rsp+3h] [rbp-B5h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v20; <span class="comment">// [rsp+4h] [rbp-B4h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+8h] [rbp-B0h]</span></span><br><span class="line">  _OWORD s1[<span class="number">3</span>]; <span class="comment">// [rsp+10h] [rbp-A8h] BYREF</span></span><br><span class="line">  __int16 v23; <span class="comment">// [rsp+40h] [rbp-78h]</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">104</span>]; <span class="comment">// [rsp+50h] [rbp-68h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;input:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%50s&quot;</span>, input);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(input) != <span class="number">50</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Wrong. Try Again.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  &#125;</span><br><span class="line">  v21 = -<span class="built_in">sysconf</span>(<span class="number">30</span>);</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  v19 = <span class="number">1</span>;</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    addr = (<span class="type">void</span> *)(v21 &amp; (<span class="type">unsigned</span> __int64)*(&amp;funcs + i));</span><br><span class="line">    len = (<span class="type">char</span> *)(lens[i] + *(&amp;funcs + i) - (_UNKNOWN *)addr);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">mprotect</span>(addr, (<span class="type">size_t</span>)len, <span class="number">7</span>) == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v7 = (__int64)*(&amp;funcs + i);</span><br><span class="line">    v8 = lens[i];</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= <span class="number">0xF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v8 != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v10 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">          *(_BYTE *)(v7 + v10++) ^= input[i];</span><br><span class="line">        <span class="keyword">while</span> ( v10 &lt; lens[i] - <span class="number">1LL</span> );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v8 )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">        *(_BYTE *)(v7 + v9++) ^= input[i];</span><br><span class="line">      <span class="keyword">while</span> ( v9 &lt; lens[i] );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">mprotect</span>(addr, (<span class="type">size_t</span>)len, <span class="number">5</span>);</span><br><span class="line">    v19 = i++ &lt; <span class="number">0x31</span>;</span><br><span class="line">    <span class="keyword">if</span> ( i == <span class="number">50</span> )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">perror</span>(<span class="string">&quot;mprotect failed&quot;</span>);</span><br><span class="line">  v20 = <span class="number">1</span>;</span><br><span class="line">LABEL_15:</span><br><span class="line">  <span class="keyword">if</span> ( v19 )</span><br><span class="line">    <span class="keyword">return</span> v20;</span><br><span class="line">  <span class="built_in">memset</span>(s1, <span class="number">0</span>, <span class="built_in">sizeof</span>(s1));</span><br><span class="line">  v23 = <span class="number">0</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  j = <span class="number">0</span>;</span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    i_1 = idx[j];</span><br><span class="line">    <span class="keyword">if</span> ( i_1 == <span class="number">51</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v16 = v13++;</span><br><span class="line">      *((_BYTE *)s1 + v16) = v11;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)i_1 != <span class="number">50</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v11 = ((__int64 (__fastcall *)(_QWORD))*(&amp;funcs + i_1))(v11);</span><br><span class="line">LABEL_18:</span><br><span class="line">      n2 = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_19;</span><br><span class="line">    &#125;</span><br><span class="line">    v11 = idx[j + <span class="number">1</span>];</span><br><span class="line">    n2 = <span class="number">2</span>;</span><br><span class="line">LABEL_19:</span><br><span class="line">    j += n2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( j &lt; <span class="number">426</span> );</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">bcmp</span>(s1, <span class="string">&quot;Congratulations! Your flag is flag&#123;your_input&#125;!^_^&quot;</span>, <span class="number">0x32u</span>) )</span><br><span class="line">    p_s1 = <span class="string">&quot;Wrong. Try Again.&quot;</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    p_s1 = (<span class="type">const</span> <span class="type">char</span> *)s1;</span><br><span class="line">  <span class="built_in">puts</span>(p_s1);</span><br><span class="line">  <span class="keyword">return</span> v20;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到是输入的字节SMC解密代码，之后有一个426字节的vm加载密文并进行解密，由于flag是我们的输入所以我们其实不需要关注后面的vm部分，仅仅需要注意50个funcs的解密，而funcs的每一块都由输入的一个字节进行异或，观察这些funcs：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00005555555551F0 unk_5555555551F0 <span class="built_in">db</span> <span class="number">0EEh</span>                <span class="comment">; DATA XREF: .data:funcs↓o</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551F1                 <span class="built_in">db</span>  <span class="number">24h</span> <span class="comment">; $</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551F2                 <span class="built_in">db</span> <span class="number">0B5h</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551F3                 <span class="built_in">db</span> <span class="number">0E0h</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551F4                 <span class="built_in">db</span>  <span class="number">93h</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551F5                 <span class="built_in">db</span>  <span class="number">48h</span> <span class="comment">; H</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551F6                 <span class="built_in">db</span> <span class="number">0A4h</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551F7                 <span class="built_in">db</span>  <span class="number">27h</span> <span class="comment">; &#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551F8                 <span class="built_in">db</span>  <span class="number">47h</span> <span class="comment">; G</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551F9                 <span class="built_in">db</span>  <span class="number">9Fh</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551FA                 <span class="built_in">db</span> <span class="number">0EDh</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551FB                 <span class="built_in">db</span>  <span class="number">63h</span> <span class="comment">; c</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551FC                 <span class="built_in">db</span>  <span class="number">63h</span> <span class="comment">; c</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551FD                 <span class="built_in">db</span>  <span class="number">63h</span> <span class="comment">; c</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551FE                 <span class="built_in">db</span> <span class="number">0E2h</span></span><br><span class="line"><span class="symbol">.text:</span>00005555555551FF                 <span class="built_in">db</span>  <span class="number">27h</span> <span class="comment">; &#x27;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000555555555200</span>                 <span class="built_in">db</span>  <span class="number">47h</span> <span class="comment">; G</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000555555555259</span>                 <span class="built_in">db</span>  <span class="number">47h</span> <span class="comment">; G</span></span><br><span class="line">…</span><br><span class="line"><span class="symbol">.text:</span>000055555555525A                 <span class="built_in">db</span>  <span class="number">9Bh</span></span><br><span class="line"><span class="symbol">.text:</span>000055555555525B                 <span class="built_in">db</span>    <span class="number">5</span></span><br><span class="line"><span class="symbol">.text:</span>000055555555525C                 <span class="built_in">db</span> <span class="number">0A0h</span></span><br><span class="line"><span class="symbol">.text:</span>000055555555525C <span class="comment">; &#125; // starts at 5555555551F0</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">000055555555525D</span>                 <span class="built_in">db</span>  <span class="number">0Fh</span></span><br><span class="line"><span class="symbol">.text:</span>000055555555525E                 <span class="built_in">db</span>  <span class="number">1Fh</span></span><br><span class="line"><span class="symbol">.text:</span>000055555555525F                 <span class="built_in">db</span>    <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>发现其中绝大多数都有多个连续的三个相同字节，且值恰好在给定的flag字符集范围内，猜测是同一个dword的三个连续高位0字节，带入输入测试发现确实如此，50个块中有45块均可被这样解密，剩余的5块发现其中两个的值大于0x7F，说明其在被异或之前应该是负数（0xFFFFFF??），还有两个为b+1，b，b，推测是大于1个字节，第二位的b被覆盖，而倒数第四个函数块没有找到类似的结构，经过推测猜测首字节应该为异或（0x83），经过测试发现确实如此，提取得到输入<font color=LimeGreen><strong>c9z2cn9jmvkh30aqjwrb3urxtkp10q8b0vr_9dbfrocalkn1v5</strong></font><br><font color=deepskyblue><strong>flag{c9z2cn9jmvkh30aqjwrb3urxtkp10q8b0vr_9dbfrocalkn1v5}</strong></font>.</p>
<h1 id="drillbeam："><a href="#drillbeam：" class="headerlink" title="drillbeam："></a>drillbeam：</h1><p>查看java层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.primite.drillbeam;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.text.method.DigitsKeyListener;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.EdgeToEdge;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> androidx.constraintlayout.widget.ConstraintLayout;</span><br><span class="line"><span class="keyword">import</span> androidx.core.graphics.Insets;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.OnApplyWindowInsetsListener;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.ViewCompat;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.WindowInsetsCompat;</span><br><span class="line"><span class="keyword">import</span> kotlin.Metadata;</span><br><span class="line"><span class="keyword">import</span> kotlin.jvm.internal.Intrinsics;</span><br><span class="line"><span class="comment">/* compiled from: MainActivity.kt */</span></span><br><span class="line"><span class="meta">@Metadata(m146d1 = &#123;&quot;\u0000\u0018\n\u0002\u0018\u0002\n\u0002\u0018\u0002\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0000\n\u0002\u0018\u0002\n\u0000\u0018\u00002\u00020\u0001B\u0005¢\u0006\u0002\u0010\u0002J\u0012\u0010\u0003\u001a\u00020\u00042\b\u0010\u0005\u001a\u0004\u0018\u00010\u0006H\u0014¨\u0006\u0007&quot;&#125;, m147d2 = &#123;&quot;Lcom/primite/drillbeam/MainActivity;&quot;, &quot;Landroidx/appcompat/app/AppCompatActivity;&quot;, &quot;()V&quot;, &quot;onCreate&quot;, &quot;&quot;, &quot;savedInstanceState&quot;, &quot;Landroid/os/Bundle;&quot;, &quot;app_release&quot;&#125;, m148k = 1, m149mv = &#123;1, 9, 0&#125;, m151xi = ConstraintLayout.LayoutParams.Table.LAYOUT_CONSTRAINT_VERTICAL_CHAINSTYLE)</span></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: protected */</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        EdgeToEdge.enable$<span class="keyword">default</span>(<span class="built_in">this</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">3</span>, <span class="literal">null</span>);</span><br><span class="line">        setContentView(C0792R.layout.activity_main);</span><br><span class="line">        ViewCompat.setOnApplyWindowInsetsListener(findViewById(C0792R.id.main), <span class="keyword">new</span> <span class="title class_">OnApplyWindowInsetsListener</span>() &#123; <span class="comment">// from class: com.primite.drillbeam.MainActivity$$ExternalSyntheticLambda0</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// androidx.core.view.OnApplyWindowInsetsListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">final</span> WindowInsetsCompat <span class="title function_">onApplyWindowInsets</span><span class="params">(View view, WindowInsetsCompat windowInsetsCompat)</span> &#123;</span><br><span class="line">                WindowInsetsCompat onCreate$lambda$<span class="number">0</span>;</span><br><span class="line">                onCreate$lambda$<span class="number">0</span> = MainActivity.onCreate$lambda$<span class="number">0</span>(view, windowInsetsCompat);</span><br><span class="line">                <span class="keyword">return</span> onCreate$lambda$<span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">EditText</span> <span class="variable">editText</span> <span class="operator">=</span> (EditText) findViewById(C0792R.id.editText);</span><br><span class="line">        editText.setKeyListener(DigitsKeyListener.getInstance(<span class="string">&quot;0123456789abcdef&quot;</span>));</span><br><span class="line">        ((Button) findViewById(C0792R.id.button)).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: com.primite.drillbeam.MainActivity$$ExternalSyntheticLambda1</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                MainActivity.onCreate$lambda$<span class="number">1</span>(editText, <span class="built_in">this</span>, view);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: private */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> WindowInsetsCompat onCreate$lambda$<span class="number">0</span>(View v, WindowInsetsCompat insets) &#123;</span><br><span class="line">        Intrinsics.checkNotNullParameter(v, <span class="string">&quot;v&quot;</span>);</span><br><span class="line">        Intrinsics.checkNotNullParameter(insets, <span class="string">&quot;insets&quot;</span>);</span><br><span class="line">        <span class="type">Insets</span> <span class="variable">insets2</span> <span class="operator">=</span> insets.getInsets(WindowInsetsCompat.Type.systemBars());</span><br><span class="line">        Intrinsics.checkNotNullExpressionValue(insets2, <span class="string">&quot;getInsets(...)&quot;</span>);</span><br><span class="line">        v.setPadding(insets2.left, insets2.top, insets2.right, insets2.bottom);</span><br><span class="line">        <span class="keyword">return</span> insets;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: private */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> onCreate$lambda$<span class="number">1</span>(EditText editText, MainActivity <span class="built_in">this</span>$<span class="number">0</span>, View view) &#123;</span><br><span class="line">        Intrinsics.checkNotNullParameter(<span class="built_in">this</span>$<span class="number">0</span>, <span class="string">&quot;this$0&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">new</span> <span class="title class_">Check</span>().calc(editText.getText().toString()).equals(<span class="string">&quot;8c1ee8d42e211d6b649e0b9c33bdc836fc912709&quot;</span>)) &#123;</span><br><span class="line">            ((TextView) <span class="built_in">this</span>$<span class="number">0.</span>findViewById(C0792R.id.textView)).setText(<span class="string">&quot;Congrats, flag为flag&#123;你的输入&#125;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输入值只能是0~f，在java层拿到密文<code>8c1ee8d42e211d6b649e0b9c33bdc836fc912709</code>，进入so层分析，查看所有函数，找到一个最关键的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *__fastcall <span class="title">XXTEA</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *src_1, <span class="type">size_t</span> n, __int128 *a3, _QWORD *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">enum</span> &#123; = <span class="number">0x0</span>, = <span class="number">0x1</span>,&#125; *res; <span class="comment">// x8</span></span><br><span class="line">  <span class="type">void</span> *dest_1; <span class="comment">// x23</span></span><br><span class="line">  <span class="type">size_t</span> v7; <span class="comment">// x8</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> after; <span class="comment">// w12</span></span><br><span class="line">  __int64 v12; <span class="comment">// [xsp+20h] [xbp-F0h]</span></span><br><span class="line">  <span class="type">void</span> *dest_2; <span class="comment">// [xsp+28h] [xbp-E8h]</span></span><br><span class="line">  _DWORD *dest_3; <span class="comment">// [xsp+30h] [xbp-E0h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int32 before; <span class="comment">// [xsp+3Ch] [xbp-D4h]</span></span><br><span class="line">  __int64 i; <span class="comment">// [xsp+40h] [xbp-D0h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> m_1; <span class="comment">// [xsp+48h] [xbp-C8h]</span></span><br><span class="line">  __int32 sum; <span class="comment">// [xsp+4Ch] [xbp-C4h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> round; <span class="comment">// [xsp+5Ch] [xbp-B4h]</span></span><br><span class="line">  __int64 t; <span class="comment">// [xsp+60h] [xbp-B0h]</span></span><br><span class="line">  <span class="type">size_t</span> v21; <span class="comment">// [xsp+80h] [xbp-90h]</span></span><br><span class="line">  <span class="type">size_t</span> length; <span class="comment">// [xsp+88h] [xbp-88h]</span></span><br><span class="line">  <span class="type">int</span> *m; <span class="comment">// [xsp+90h] [xbp-80h]</span></span><br><span class="line">  _DWORD *key; <span class="comment">// [xsp+A0h] [xbp-70h]</span></span><br><span class="line">  <span class="type">int</span> *<span class="keyword">final</span>; <span class="comment">// [xsp+C0h] [xbp-50h]</span></span><br><span class="line">  <span class="type">int</span> delta; <span class="comment">// [xsp+C8h] [xbp-48h]</span></span><br><span class="line">  <span class="type">int</span> ttl; <span class="comment">// [xsp+E0h] [xbp-30h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> e; <span class="comment">// [xsp+E4h] [xbp-2Ch]</span></span><br><span class="line">  <span class="keyword">enum</span> &#123; = <span class="number">0x0</span>, = <span class="number">0x1</span>,&#125; *res_1; <span class="comment">// [xsp+E8h] [xbp-28h]</span></span><br><span class="line">  __int128 a3_1; <span class="comment">// [xsp+F0h] [xbp-20h] BYREF</span></span><br><span class="line">  __int64 v31; <span class="comment">// [xsp+100h] [xbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v31 = *(_QWORD *)(_ReadStatusReg(TPIDR_EL0) + <span class="number">40</span>);</span><br><span class="line">  a3_1 = *a3;</span><br><span class="line">  t = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !(_BYTE)a3_1 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">BYTE1</span>(a3_1) )</span><br><span class="line">  &#123;</span><br><span class="line">    t = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">  &#125;</span><br><span class="line">…</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">BYTE14</span>(a3_1) )</span><br><span class="line">  &#123;</span><br><span class="line">    t = <span class="number">14</span>;</span><br><span class="line">LABEL_3:</span><br><span class="line">    <span class="built_in">memset</span>((<span class="type">char</span> *)&amp;a3_1 + t + <span class="number">1</span>, <span class="number">0</span>, t ^ <span class="number">0xF</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( n )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = n &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (n &amp; <span class="number">3</span>) != <span class="number">0</span> )</span><br><span class="line">      ++v7;</span><br><span class="line">    v21 = v7;</span><br><span class="line">    length = v7 + <span class="number">1</span>;</span><br><span class="line">    m = (<span class="type">int</span> *)<span class="built_in">calloc</span>(v7 + <span class="number">1</span>, <span class="number">4u</span>);</span><br><span class="line">    v12 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( m )</span><br><span class="line">    &#123;</span><br><span class="line">      m[v21] = n;</span><br><span class="line">      <span class="built_in">memcpy</span>(m, src_1, n);</span><br><span class="line">      key = <span class="built_in">calloc</span>(<span class="number">4u</span>, <span class="number">4u</span>);</span><br><span class="line">      <span class="keyword">if</span> ( key )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_OWORD *)key = a3_1;</span><br><span class="line">        <span class="keyword">final</span> = &amp;m[(<span class="type">unsigned</span> <span class="type">int</span>)(length - <span class="number">1</span>)];</span><br><span class="line">        <span class="keyword">if</span> ( (_DWORD)length != <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          delta = ::delta;</span><br><span class="line">          *(_QWORD *)&amp;sum = (<span class="type">unsigned</span> <span class="type">int</span>)*<span class="keyword">final</span>;</span><br><span class="line">          <span class="keyword">for</span> ( round = <span class="number">52</span> / (<span class="type">unsigned</span> <span class="type">int</span>)length + <span class="number">5</span>; ; --round )</span><br><span class="line">          &#123;</span><br><span class="line">            ttl = *(&amp;sum + <span class="number">1</span>) + delta;</span><br><span class="line">            e = ((<span class="type">unsigned</span> <span class="type">int</span>)(*(&amp;sum + <span class="number">1</span>) + delta) &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">            i = <span class="number">0</span>;</span><br><span class="line">            before = sum;</span><br><span class="line">            m_1 = *m;</span><br><span class="line">            <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              after = m[i + <span class="number">1</span>];</span><br><span class="line">              <span class="built_in">LODWORD</span>(res_1) = ((((<span class="number">4</span> * after) ^ (before &gt;&gt; <span class="number">5</span>)) + ((after &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * before)))</span><br><span class="line">                              ^ ((key[i &amp; <span class="number">3</span> ^ e] ^ before) + (after ^ ttl)))</span><br><span class="line">                             + m_1;</span><br><span class="line">              m[i] = (<span class="type">int</span>)res_1;</span><br><span class="line">              <span class="keyword">if</span> ( i + <span class="number">1</span> == (_DWORD)length - <span class="number">1</span> )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">              m_1 = after;</span><br><span class="line">              ++i;</span><br><span class="line">              before = (<span class="type">unsigned</span> <span class="type">int</span>)res_1;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">LODWORD</span>(res) = ((((<span class="number">4</span> * *m) ^ ((<span class="type">unsigned</span> <span class="type">int</span>)res_1 &gt;&gt; <span class="number">5</span>)) + (((<span class="type">unsigned</span> <span class="type">int</span>)*m &gt;&gt; <span class="number">3</span>) ^ (<span class="number">16</span> * (_DWORD)res_1)))</span><br><span class="line">                          ^ ((key[e ^ ((_BYTE)length - <span class="number">1</span>) &amp; <span class="number">3</span>] ^ (<span class="type">unsigned</span> <span class="type">int</span>)res_1) + (*m ^ ttl)))</span><br><span class="line">                         + *<span class="keyword">final</span>;</span><br><span class="line">            *<span class="keyword">final</span> = (<span class="type">int</span>)res;</span><br><span class="line">            <span class="keyword">if</span> ( !round )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            sum = (<span class="type">int</span>)res;</span><br><span class="line">            *(&amp;sum + <span class="number">1</span>) += delta;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dest_1 = <span class="built_in">malloc</span>((<span class="number">4</span> * length) | <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(dest_1, m, <span class="number">4</span> * length);</span><br><span class="line">        *((_BYTE *)dest_1 + <span class="number">4</span> * length) = <span class="number">0</span>;</span><br><span class="line">        *a4 = <span class="number">4</span> * length;</span><br><span class="line">        <span class="built_in">free</span>(m);</span><br><span class="line">        dest_2 = dest_1;</span><br><span class="line">        dest_3 = key;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        dest_2 = <span class="number">0</span>;</span><br><span class="line">        dest_3 = m;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">free</span>(dest_3);</span><br><span class="line">      <span class="keyword">return</span> dest_2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *)v12;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个典型的有长度填充的XXTEA加密，查看密钥和delta值，发现delta值在这个函数中被初始化：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">sub_217C</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  delta = <span class="number">0x7C1CA67A</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Key从外界传入：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">brf3</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> n_1; <span class="comment">// w0</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// x21</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *src; <span class="comment">// [xsp+40h] [xbp-30h]</span></span><br><span class="line">  _QWORD v9[<span class="number">2</span>]; <span class="comment">// [xsp+60h] [xbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v9[<span class="number">1</span>] = *(_QWORD *)(_ReadStatusReg(TPIDR_EL0) + <span class="number">40</span>);</span><br><span class="line">  n_1 = (*(__int64 (__fastcall **)(__int64, __int64))(*(_QWORD *)a1 + <span class="number">1344LL</span>))(a1, a3);</span><br><span class="line">  n = n_1;</span><br><span class="line">  v9[<span class="number">0</span>] = n_1;</span><br><span class="line">  src = (<span class="type">const</span> <span class="type">void</span> *)(*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(*(_QWORD *)a1 + <span class="number">1352LL</span>))(a1, a3, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">xorf1</span>(&amp;unk_6510, gen_114514);                 <span class="comment">// 114514</span></span><br><span class="line">  <span class="built_in">XXTEA</span>(src, n, (__int128 *)&amp;unk_6510, v9);</span><br><span class="line">  <span class="built_in">malloc</span>((<span class="number">2LL</span> * v9[<span class="number">0</span>]) | <span class="number">1</span>);</span><br><span class="line">  __asm &#123; BR              X9 &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中xorf1将其第二个参数解密得到密钥114514，在后续的XXTEA中填充为16位，为了确认题目采取的加密形式，编写frida脚本hook Java层：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">CheckClass</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;com.primite.drillbeam.Check&#x27;</span>);</span><br><span class="line">    <span class="title class_">CheckClass</span>.<span class="property">calc</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.String&#x27;</span>).<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params">input</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] 输入: &#x27;</span> + input + <span class="string">&quot; &quot;</span> + input.<span class="property">length</span>);</span><br><span class="line">        <span class="keyword">var</span> result = <span class="variable language_">this</span>.<span class="title function_">calc</span>(input);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[*] 加密结果: &#x27;</span> + result + <span class="string">&quot; &quot;</span> + result.<span class="property">length</span>);</span><br><span class="line">        <span class="keyword">return</span> result; </span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>经过观察比对发现，虽然要求输入的是0~f的值，猜测按两个字符为一个字节进行解析，但是实际测试发现密文的长度与字节数量并不成4的比例，反而与字符数量成4的比例，结合so层的scanf %02x没有任何xref猜测实际上传入的还是字符串，在加密时还会按ASCII值进行解析，编写同构加解密测试脚本发现结果并不相同，又因为密钥是从函数外界传入的参数，而delta值是全局dword，猜测可能暗改了delta值，编写脚本进行爆破：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">b2dle</span>(<span class="params">byte_array</span>):</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(byte_array[i:i+<span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">False</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(byte_array), <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">d2ble</span>(<span class="params">dword_array</span>):</span><br><span class="line">    byte_list = []</span><br><span class="line">    <span class="keyword">for</span> dword <span class="keyword">in</span> dword_array:</span><br><span class="line">        byte_list.extend(dword.to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> byte_list</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">XXTEA</span>(<span class="params">m, leng, k, delta</span>):</span><br><span class="line">    rounds = <span class="number">6</span> + <span class="number">52</span> // leng</span><br><span class="line">    ttl = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(rounds - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        ttl = (ttl + delta) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(leng):</span><br><span class="line">            after = m[(i + <span class="number">1</span>) % <span class="built_in">len</span>(m)]</span><br><span class="line">            before = m[(i - <span class="number">1</span>) % <span class="built_in">len</span>(m)]</span><br><span class="line">            m[i] = (m[i] + ((((before &gt;&gt; <span class="number">5</span>) ^ (after &lt;&lt; <span class="number">2</span>)) + ((after &gt;&gt; <span class="number">3</span>) ^ (before &lt;&lt; <span class="number">4</span>))) ^ ((ttl ^ after) + (k[(i &amp; <span class="number">3</span>) ^ ((ttl &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>)] ^ before)))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de_XXTEA</span>(<span class="params">m, leng, k, delta</span>):</span><br><span class="line">    rounds = <span class="number">6</span> + <span class="number">52</span> // leng</span><br><span class="line">    ttl = ((rounds + <span class="number">1</span>) * delta) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(rounds):</span><br><span class="line">        ttl = (ttl - delta) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(leng - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            after = m[(i + <span class="number">1</span>) % <span class="built_in">len</span>(m)]</span><br><span class="line">            before = m[(i - <span class="number">1</span>) % <span class="built_in">len</span>(m)]</span><br><span class="line">            m[i] = (m[i] - ((((before &gt;&gt; <span class="number">5</span>) ^ (after &lt;&lt; <span class="number">2</span>)) + ((after &gt;&gt; <span class="number">3</span>) ^ (before &lt;&lt; <span class="number">4</span>))) ^ ((ttl ^ after) + (k[(i &amp; <span class="number">3</span>) ^ ((ttl &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>)] ^ before)))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line">key = <span class="built_in">bytearray</span>(<span class="string">b&quot;114514\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;</span>)</span><br><span class="line">test = <span class="built_in">bytearray</span>(<span class="string">b&quot;1111111111111111\x10&quot;</span>)</span><br><span class="line">dwordkey = b2dle(key)</span><br><span class="line">dwordtest = b2dle(test)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> delta <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100000000</span>):</span><br><span class="line">    dwordresult = XXTEA(dwordtest.copy(), <span class="built_in">len</span>(dwordtest), dwordkey, delta)</span><br><span class="line">    result = <span class="built_in">bytes</span>(d2ble(dwordresult)).<span class="built_in">hex</span>()</span><br><span class="line">    <span class="built_in">print</span>(result, <span class="built_in">len</span>(result))</span><br><span class="line">    target = <span class="string">&quot;949e2a0a286af84e1d42cb9fffc31deb4af77f1d&quot;</span></span><br><span class="line">    <span class="keyword">if</span> result == target:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(delta))</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>发现delta值被改为了<code>0x7c1ca759</code>，测试加密结果与程序相同，但是在解密时发现解出来的东西一团乱麻，不符合之前输入的格式，仔细观察整个程序的所有函数，发现还有sysconf获取系统状态，popen管道创建与pclose管道关闭，mmap内存映射等，猜测还含有检测系统状态的反hook与反调试等，由于实在是不易分析，尝试从密文直接爆破flag，由于有填充，最后一个dword一定小于256，所以解密结果的最后6字符一定为000000，编写脚本爆破全部4字节：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Result</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> delta;</span><br><span class="line">    std::string hex_result;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::mutex result_mutex;</span><br><span class="line">std::vector&lt;Result&gt; all_results;</span><br><span class="line"><span class="function">std::atomic&lt;<span class="type">uint64_t</span>&gt; <span class="title">total_processed</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="type">uint64_t</span> total_range = <span class="number">0xFFFFFFFF</span> - <span class="number">0x00000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint32_t</span>&gt; <span class="title">b2dle</span><span class="params">(<span class="type">const</span> std::vector&lt;<span class="type">uint8_t</span>&gt;&amp; bytes)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">uint32_t</span>&gt; result;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; bytes.<span class="built_in">size</span>(); i += <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> val = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span> &amp;&amp; i + j &lt; bytes.<span class="built_in">size</span>(); ++j) &#123;</span><br><span class="line">            val |= <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(bytes[i + j]) &lt;&lt; (j * <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        result.<span class="built_in">push_back</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">d2ble</span><span class="params">(<span class="type">const</span> std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; dwords)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">uint8_t</span>&gt; result;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> d : dwords) &#123;</span><br><span class="line">        result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(d));</span><br><span class="line">        result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(d &gt;&gt; <span class="number">8</span>));</span><br><span class="line">        result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(d &gt;&gt; <span class="number">16</span>));</span><br><span class="line">        result.<span class="built_in">push_back</span>(<span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(d &gt;&gt; <span class="number">24</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">de_XXTEA</span><span class="params">(std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; v, <span class="type">int</span> leng, <span class="type">const</span> std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; k, <span class="type">uint32_t</span> delta)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> rounds = <span class="number">6</span> + <span class="number">52</span> / leng;</span><br><span class="line">    <span class="type">uint32_t</span> ttl = ((rounds + <span class="number">1ULL</span>) * delta) &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; rounds; ++j) &#123;</span><br><span class="line">        ttl = (ttl - delta) &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = leng - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="type">uint32_t</span> after = v[(i + <span class="number">1</span>) % leng];</span><br><span class="line">            <span class="type">uint32_t</span> before = v[(i - <span class="number">1</span> + leng) % leng];</span><br><span class="line">            v[i] = (v[i] - (</span><br><span class="line">                (((before &gt;&gt; <span class="number">5</span>) ^ (after &lt;&lt; <span class="number">2</span>)) + ((after &gt;&gt; <span class="number">3</span>) ^ (before &lt;&lt; <span class="number">4</span>)))</span><br><span class="line">                ^</span><br><span class="line">                ((ttl ^ after) + (k[(i &amp; <span class="number">3</span>) ^ ((ttl &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>)] ^ before))</span><br><span class="line">            )) &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">std::vector&lt;<span class="type">uint8_t</span>&gt; <span class="title">hex_to_bytes</span><span class="params">(<span class="type">const</span> std::string&amp; hex)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">uint8_t</span>&gt; bytes;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; hex.<span class="built_in">length</span>(); i += <span class="number">2</span>) &#123;</span><br><span class="line">        std::string byte_str = hex.<span class="built_in">substr</span>(i, <span class="number">2</span>);</span><br><span class="line">        <span class="type">uint8_t</span> byte = <span class="built_in">static_cast</span>&lt;<span class="type">uint8_t</span>&gt;(<span class="built_in">strtol</span>(byte_str.<span class="built_in">c_str</span>(), <span class="literal">nullptr</span>, <span class="number">16</span>));</span><br><span class="line">        bytes.<span class="built_in">push_back</span>(byte);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">brute_thread</span><span class="params">(<span class="type">uint32_t</span> start_delta, <span class="type">uint32_t</span> end_delta,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">const</span> std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; enc_data,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">const</span> std::vector&lt;<span class="type">uint32_t</span>&gt;&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">uint32_t</span>&gt; <span class="title">m</span><span class="params">(length)</span></span>;</span><br><span class="line">    <span class="type">uint64_t</span> chunk_size = end_delta - start_delta + <span class="number">1</span>;</span><br><span class="line">    <span class="type">uint64_t</span> report_interval = chunk_size / <span class="number">100</span> + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> delta = start_delta; delta &lt;= end_delta; ++delta) &#123;</span><br><span class="line">        m = enc_data;</span><br><span class="line">        <span class="built_in">de_XXTEA</span>(m, length, key, delta);</span><br><span class="line">        <span class="keyword">auto</span> decrypted_bytes = <span class="built_in">d2ble</span>(m);</span><br><span class="line">        std::ostringstream oss;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> b : decrypted_bytes) &#123;</span><br><span class="line">            oss &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; std::<span class="built_in">setfill</span>(<span class="string">&#x27;0&#x27;</span>) &lt;&lt; std::hex &lt;&lt; <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(b);</span><br><span class="line">        &#125;</span><br><span class="line">        std::string hex_result = oss.<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">if</span> (hex_result.<span class="built_in">size</span>() &gt;= <span class="number">6</span> &amp;&amp; hex_result.<span class="built_in">substr</span>(hex_result.<span class="built_in">size</span>() - <span class="number">6</span>) == <span class="string">&quot;000000&quot;</span>) &#123;</span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(result_mutex)</span></span>;</span><br><span class="line">            all_results.<span class="built_in">emplace_back</span>(Result&#123;delta, hex_result&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">uint64_t</span> count = total_processed.<span class="built_in">fetch_add</span>(<span class="number">1</span>, std::memory_order_relaxed);</span><br><span class="line">        <span class="keyword">if</span> (count % report_interval == <span class="number">0</span> || count == total_range - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">double</span> progress = <span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(count) / total_range * <span class="number">100.0</span>;</span><br><span class="line">            <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(result_mutex)</span></span>;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;\rProgress: [&quot;</span> &lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">2</span>) &lt;&lt; progress &lt;&lt; <span class="string">&quot;%]&quot;</span>;</span><br><span class="line">            std::cout.<span class="built_in">flush</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::vector&lt;<span class="type">uint32_t</span>&gt; key = &#123;<span class="number">0x35343131</span>, <span class="number">0x3431</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    std::string enc_hex = <span class="string">&quot;8c1ee8d42e211d6b649e0b9c33bdc836fc912709&quot;</span>;</span><br><span class="line">    <span class="keyword">auto</span> enc_bytes = <span class="built_in">hex_to_bytes</span>(enc_hex);</span><br><span class="line">    <span class="keyword">auto</span> enc_dwords = <span class="built_in">b2dle</span>(enc_bytes);</span><br><span class="line">    <span class="type">int</span> length = <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(enc_dwords.<span class="built_in">size</span>());</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> thread_count = <span class="number">32</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">uint32_t</span> per_thread = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(total_range / thread_count);</span><br><span class="line">    std::vector&lt;std::thread&gt; threads;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> t = <span class="number">0</span>; t &lt; thread_count; ++t) &#123;</span><br><span class="line">        <span class="type">uint32_t</span> start = <span class="number">0x00000000</span> + t * per_thread;</span><br><span class="line">        <span class="type">uint32_t</span> end = (t == thread_count - <span class="number">1</span>) ? <span class="number">0xFFFFFFFF</span> : start + per_thread - <span class="number">1</span>;</span><br><span class="line">        threads.<span class="built_in">emplace_back</span>(brute_thread, start, end, enc_dwords, key, length);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; th : threads) &#123;</span><br><span class="line">        <span class="keyword">if</span> (th.<span class="built_in">joinable</span>()) th.<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\nSearch completed.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">if</span> (!all_results.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Found &quot;</span> &lt;&lt; all_results.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; matching results:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; res : all_results) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Delta: 0x&quot;</span> &lt;&lt; std::hex &lt;&lt; res.delta</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; | Hex: &quot;</span> &lt;&lt; res.hex_result &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;No matching result found.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>筛选输出，发现其中有一个解：<font color=red><strong>Delta: 0x7c1ca806 | Hex: 6165313466623332396265353138626310000000</strong></font>符合结果，<font color=deepskyblue><strong>flag{ae14fb329be518bc}</strong></font>.</p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2025/05/26/huanghe_25/"
      title="第三届黄河流域公安院校网络安全技能挑战赛 WriteUp (Reverse方向)"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        第三届黄河流域公安院校网络安全技能挑战赛 WriteUp (Reverse方向)
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2025/05/21/xuanyuan_25/"
      title="“轩辕杯”云盾砺剑CTF挑战赛 2025 WriteUp"
     >

    <p class="title-text">
      
        “轩辕杯”云盾砺剑CTF挑战赛 2025 WriteUp
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2025 Astral Prisma<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
