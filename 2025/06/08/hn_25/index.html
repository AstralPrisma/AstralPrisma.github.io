<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>H&amp;NCTF 2025 WriteUp | 棱晶の小窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="仅给出我个人解出的题目的WriteUp. Crypto方向：lcgp：n-1光滑，先恢复c： 1234567891011121314151617181920212223242526from math import gcdfrom Crypto.Util.number import *random_outputs &#x3D; [    112503273551129562847207199879439418">
<meta property="og:type" content="article">
<meta property="og:title" content="H&amp;NCTF 2025 WriteUp">
<meta property="og:url" content="https://astralprisma.github.io/2025/06/08/hn_25/index.html">
<meta property="og:site_name" content="棱晶の小窝">
<meta property="og:description" content="仅给出我个人解出的题目的WriteUp. Crypto方向：lcgp：n-1光滑，先恢复c： 1234567891011121314151617181920212223242526from math import gcdfrom Crypto.Util.number import *random_outputs &#x3D; [    112503273551129562847207199879439418">
<meta property="og:locale">
<meta property="article:published_time" content="2025-06-08T10:00:00.000Z">
<meta property="article:modified_time" content="2025-06-08T10:02:33.488Z">
<meta property="article:author" content="Astral Prisma">
<meta name="twitter:card" content="summary">
  
  
    <link rel="shortcut icon" href="/XH.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/OTSA.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>棱晶の小窝 </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/AP.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Astral Prisma </div>
      <div class="dot"></div>
      <div class="subtitle">星界棱晶 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/454936579" title="Bilibili"><image src=https://www.bilibili.com/favicon.ico></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://www.primegrid.com/show_user.php?userid=1243718" title="PrimeGrid"><image src=https://www.primegrid.com/images/favicon_32.png></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/AstralPrisma" title="GitHub"><image src=https://github.githubassets.com/favicons/favicon.png></image></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/Ideas/">
                Ideas
                <div class="category-count">1</div>
            </a>
        
            <a class="category-link" href="/categories/WriteUp/">
                WriteUp
                <div class="category-count">24</div>
            </a>
        </div>
    </div>
  </div>


    
      

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-hn_25" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        H&amp;NCTF 2025 WriteUp
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2025-06-08T10:00:00.000Z" itemprop="datePublished">2025-06-08</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/WriteUp/">WriteUp</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            5.6k words 
          </div>
        </div>
        
      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <p><em>仅给出我个人解出的题目的WriteUp.</em></p>
<h1 id="Crypto方向："><a href="#Crypto方向：" class="headerlink" title="Crypto方向："></a>Crypto方向：</h1><h2 id="lcgp："><a href="#lcgp：" class="headerlink" title="lcgp："></a>lcgp：</h2><p>n-1光滑，先恢复c：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> gcd</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">random_outputs = [</span><br><span class="line">    <span class="number">11250327355112956284720719987943941825496074893551827972877616718074592862130806975889275745497426515405562887727117008818863728803549848574821067056997423443681347885027000632462241968640893471352200125748453396098854283137158609264944692129301617338233670002547470932851350750870478630955328653729176440142198779254117385657086615711880537380965161180532127926250520546846863536247569437</span>,</span><br><span class="line">    <span class="number">1289730679860726245234376434590068355673648326448223956572444944595048952808106413165882424967688302988257332835229651422892728384363094065438370663362237241013242843898967355558977974152917458085812489310623200114007728021151551927660975648884448177346441902806386690751359848832912607313329587047853601875294089502467524598036474193845319703759478494109845743765770254308199331552085163360820459311523382612948322756700518669154345145757700392164795583041949318636</span>,</span><br><span class="line">    <span class="number">147853940073845086740348793965278392144198492906678575722238097853659884813579087132349845941828785238545905768867483183634111847434793587821166882679621234634787376562998606494582491550592596838027522285263597247798608351871499848571767008878373891341861704004755752362146031951465205665840079918938797056361771851047994530311215961536936283541887169156535180878864233663699607369701462321037824218572445283037132205269900255514050653933970174340553425147148993214797622395988788709572605943994223528210919230924346860415844639247799805670459</span>,</span><br><span class="line">    <span class="number">7426988179463569301750073197586782838200202717435911385357661153208197570200804485303362695962843396307030986052311117232622043073376409347836815567322367321085387874196758434280075897513536063432730099103786733447352512984165432175254784494400699821500026196293994318206774720213317148132311223050562359314735977091536842516316149049281012797103790472349557847649282356393682360276814293256129426440381745354969522053841093229320186679875177247919985804406150542514337515002645320320069788390314900121917747534146857716743377658436154645197488134340819076585888700553005062311578963869641978771532330577371974731136</span>,</span><br><span class="line">    <span class="number">10389979373355413148376869524987139791217158307590828693700943753512488757973725227850725013905113587408391654379552713436220790487026223039058296951420273907725324214990441639760825661323514381671141482079783647253661594138658677104054180912818864005556386671430082941396497098166887200556959866845325602873713813206312644590812141400536476615405444030140762980665885244721798105034497461675317071497925846844396796854201566038890503298824928152263774446268093725702310124363765630370263370678902342200494544961012407826314577564991676315451785987248633724138137813024481818431889574317602521878974976264742037227074</span></span><br><span class="line">]</span><br><span class="line">n = <span class="number">604805773885048132038788501528078428693141138274580426531445179173412328238102786863592612653315029009606622583856638282837864213048342883583286440071990592001905867027978355755042060684149344414810835371740304319571184567860694439564098306766474576403800046937218588251809179787769286393579687694925268985445059</span></span><br><span class="line"></span><br><span class="line">s1, s2, s3, s4, s5 = random_outputs</span><br><span class="line">d1 = s2 - s1</span><br><span class="line">d2 = s3 - s2</span><br><span class="line">d3 = s4 - s3</span><br><span class="line">d4 = s5 - s4</span><br><span class="line">x = d2**<span class="number">2</span> - d1 * d3</span><br><span class="line">y = d3**<span class="number">2</span> - d2 * d4</span><br><span class="line">m = gcd(x, y)</span><br><span class="line">inv_d1 = inverse(d1, m)</span><br><span class="line">a = (d2 * inv_d1) % m</span><br><span class="line">b = (s2 - a * s1) % m</span><br><span class="line">inv_a = inverse(a, m)</span><br><span class="line">c = (s1 - b) * inv_a % m</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Recovered c:&quot;</span>, c)</span><br></pre></td></tr></table></figure>
<p>得到</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="number">98136663393066487319477131255488756533037186459124433869847045986870213783395243380337142782779765255670853582334927187474123853371504168896312528278296763527266828907487342102002206806408616944398694810398049626860321901229014612541564249969665358849039818103044159048535403863928440335143886672949700153798350</span></span><br></pre></td></tr></table></figure>
<p>接下来求解：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> long_to_bytes</span><br><span class="line"></span><br><span class="line">n = <span class="number">604805773885048132038788501528078428693141138274580426531445179173412328238102786863592612653315029009606622583856638282837864213048342883583286440071990592001905867027978355755042060684149344414810835371740304319571184567860694439564098306766474576403800046937218588251809179787769286393579687694925268985445059</span></span><br><span class="line">e = <span class="number">2024</span></span><br><span class="line">c = <span class="number">98136663393066487319477131255488756533037186459124433869847045986870213783395243380337142782779765255670853582334927187474123853371504168896312528278296763527266828907487342102002206806408616944398694810398049626860321901229014612541564249969665358849039818103044159048535403863928440335143886672949700153798350</span></span><br><span class="line"></span><br><span class="line">R = Zmod(n)</span><br><span class="line">c_val = R(c)</span><br><span class="line">e_val = R(e)</span><br><span class="line"></span><br><span class="line">n_minus_1 = n - <span class="number">1</span></span><br><span class="line">factors = factor(n_minus_1)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Factorization of n-1:&quot;</span>, factors)</span><br><span class="line">d = discrete_log(c_val, e_val)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Discrete logarithm d:&quot;</span>, d)</span><br><span class="line">flag = long_to_bytes(d)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Flag:&quot;</span>, flag)</span><br></pre></td></tr></table></figure>
<p><font color=deepskyblue><strong>H&amp;NCTF{7ecf4c8c-e6a5-45c7-b7de-2fecc31d8511}</strong></font></p>
<h2 id="哈基coke："><a href="#哈基coke：" class="headerlink" title="哈基coke："></a>哈基coke：</h2><p>逆向猫脸变换：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arnold_decode</span>(<span class="params">encrypted_image_path, shuffle_times, a, b</span>):</span><br><span class="line">    encrypted_image = cv2.imread(encrypted_image_path)</span><br><span class="line">    h, w = encrypted_image.shape[:<span class="number">2</span>]</span><br><span class="line">    N = h</span><br><span class="line">    decoded_image = np.zeros_like(encrypted_image)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(shuffle_times):</span><br><span class="line">        temp_image = np.copy(decoded_image)</span><br><span class="line">        <span class="keyword">for</span> x_prime <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">            <span class="keyword">for</span> y_prime <span class="keyword">in</span> <span class="built_in">range</span>(N):</span><br><span class="line">                x = (( (a*b + <span class="number">1</span>) * x_prime - b * y_prime ) % N + N) % N</span><br><span class="line">                y = (( -a * x_prime + y_prime ) % N + N) % N</span><br><span class="line">                temp_image[x, y, :] = encrypted_image[x_prime, y_prime, :]</span><br><span class="line">        decoded_image = temp_image</span><br><span class="line">        encrypted_image = np.copy(decoded_image)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decoded_image</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    decrypted_image = arnold_decode(<span class="string">&#x27;en_flag.png&#x27;</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">1</span>)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;decrypted_coke.png&#x27;</span>, decrypted_image, [<span class="built_in">int</span>(cv2.IMWRITE_PNG_COMPRESSION), <span class="number">0</span>])</span><br></pre></td></tr></table></figure>
<p><font color=deepskyblue><strong>H&amp;NCTF{haji_coke_you_win}</strong></font></p>
<h2 id="数据处理："><a href="#数据处理：" class="headerlink" title="数据处理："></a>数据处理：</h2><p>先求解intflag：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">0x100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line">m = <span class="number">0x61125b33959f20cbab41c14ff5b1825eb553e7d076098a003acd729163343437d6cbaa0271a61e69c1f3d054dfc85d4e47e568598ffe6a80642fff9d4ad8ff67</span></span><br><span class="line">c = <span class="number">0x39141869cbba69234a5619bb0766439c2e9f5b15a9009715ed3ce38a190466c6c0fbb274274ec3ae7d25a447938db11dd340038ad553bfd470496463974dcec7</span></span><br><span class="line"></span><br><span class="line">R = Integers(n)</span><br><span class="line">m = R(m)</span><br><span class="line">c = R(c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sage.groups.generic <span class="keyword">import</span> discrete_log</span><br><span class="line">flag = discrete_log(c, m)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;flag:&quot;</span>, flag)</span><br></pre></td></tr></table></figure>
<p>得到flag值为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3282248010524512146638712359816289396373430161050484501341123570760619381019795910712610762203934445754701</span><br></pre></td></tr></table></figure>
<p>接下来爆破映射表：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">lowercase = <span class="string">&#x27;0123456789&#x27;</span></span><br><span class="line">intflag = <span class="string">&#x27;3282248010524512146638712359816289396373430161050484501341123570760619381019795910712610762203934445754701&#x27;</span></span><br><span class="line">pattern = <span class="string">&quot;7***4****5&quot;</span></span><br><span class="line">used_digits = &#123;<span class="number">4</span>, <span class="number">5</span>, <span class="number">7</span>&#125;</span><br><span class="line">available_digits = [d <span class="keyword">for</span> d <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>) <span class="keyword">if</span> d <span class="keyword">not</span> <span class="keyword">in</span> used_digits]</span><br><span class="line"><span class="keyword">for</span> perm <span class="keyword">in</span> itertools.permutations(available_digits):</span><br><span class="line">    result = []</span><br><span class="line">    idx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> pattern:</span><br><span class="line">        <span class="keyword">if</span> ch == <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">            result.append(<span class="built_in">str</span>(perm[idx]))</span><br><span class="line">            idx += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result.append(ch)</span><br><span class="line">    uppercase = <span class="string">&quot;&quot;</span>.join(result)</span><br><span class="line">    table = <span class="string">&#x27;&#x27;</span>.maketrans(uppercase, lowercase)</span><br><span class="line">    flag = intflag.translate(table)</span><br><span class="line">    bflag = long_to_bytes(<span class="built_in">int</span>(flag))</span><br><span class="line">    <span class="keyword">if</span> bflag.startswith(<span class="string">b&quot;H&amp;NCTF&#123;&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span>(bflag)</span><br></pre></td></tr></table></figure>
<p><font color=deepskyblue><strong>H&amp;NCTF{cut_cut_rrioajtfijrwegeriogjiireigji}</strong></font></p>
<h1 id="Reverse："><a href="#Reverse：" class="headerlink" title="Reverse："></a>Reverse：</h1><h2 id="F-K："><a href="#F-K：" class="headerlink" title="F**K："></a>F**K：</h2><p>查看主函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> __dst[<span class="number">65</span>]; <span class="comment">// [xsp+2Eh] [xbp-162h] BYREF</span></span><br><span class="line">  <span class="type">char</span> __s_[<span class="number">65</span>]; <span class="comment">// [xsp+6Fh] [xbp-121h] BYREF</span></span><br><span class="line">  <span class="type">char</span> __b_[<span class="number">100</span>]; <span class="comment">// [xsp+B0h] [xbp-E0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> __b[<span class="number">100</span>]; <span class="comment">// [xsp+114h] [xbp-7Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(__b, <span class="number">0</span>, <span class="built_in">sizeof</span>(__b));</span><br><span class="line">  <span class="built_in">memset</span>(__b_, <span class="number">0</span>, <span class="built_in">sizeof</span>(__b_));</span><br><span class="line">  <span class="built_in">strcpy</span>(__dst, <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>);</span><br><span class="line">  <span class="built_in">func1</span>((__int64)__dst, __s_);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">fgets</span>(__b, <span class="number">0x64</span>, __stdinp) )</span><br><span class="line">  &#123;</span><br><span class="line">    __b[<span class="built_in">strcspn</span>(__b, <span class="string">&quot;\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">func2</span>(__b, (__int64)__b_, (__int64)__s_);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !byte_100008292 )</span><br><span class="line">    <span class="built_in">func3</span>((__int64)__b_);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(num1, num2, <span class="number">16</span> * num3) )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nCongratulations!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nSomething Wrong.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中func1是按时间生成随机数种子打乱base64表，func2是标准base64编码，func3是对明文的每4字节进行md5哈希后再进行一步简单的加密：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( n16 = <span class="number">0</span>; n16 &lt; <span class="number">16</span>; ++n16 )</span><br><span class="line">num2[<span class="number">16</span> * num3 + n16] = (<span class="number">7</span> * (num2[<span class="number">16</span> * num3 + n16] ^ (n16 + <span class="number">6</span>)) + <span class="number">0x1234</span> * (n16 % <span class="number">0xF</span>)) % <span class="number">256</span>;</span><br></pre></td></tr></table></figure>
<p>提取密文，先进行哈希爆破：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> product</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool, cpu_count</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"></span><br><span class="line">custom_table = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_all_b64_blocks</span>(<span class="params">table</span>):</span><br><span class="line">    <span class="keyword">return</span> (<span class="string">&#x27;&#x27;</span>.join(p) <span class="keyword">for</span> p <span class="keyword">in</span> product(table, repeat=<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">transform</span>(<span class="params">md5_hash</span>):</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> n16 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        val = (<span class="number">7</span> * ((md5_hash[n16] ^ (n16 + <span class="number">6</span>)) &amp; <span class="number">0xFF</span>) + <span class="number">0x1234</span> * (n16 % <span class="number">0xF</span>)) % <span class="number">256</span></span><br><span class="line">        result.append(val)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_block</span>(<span class="params">block</span>):</span><br><span class="line">    encoded_block = block.encode()</span><br><span class="line">    md5_hash = hashlib.md5(encoded_block).digest()</span><br><span class="line">    transformed = transform(md5_hash)</span><br><span class="line">    <span class="keyword">return</span> (transformed, block)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_rainbow_table</span>(<span class="params">custom_table</span>):</span><br><span class="line">    blocks = <span class="built_in">list</span>(generate_all_b64_blocks(custom_table))</span><br><span class="line">    total = <span class="built_in">len</span>(blocks)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] Generating rainbow table with <span class="subst">&#123;total&#125;</span> entries...&quot;</span>)</span><br><span class="line"></span><br><span class="line">    pool = Pool(cpu_count())</span><br><span class="line">    rainbow_dict = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tqdm(total=total, desc=<span class="string">&quot;Building Rainbow Table&quot;</span>, unit=<span class="string">&quot;block&quot;</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> pool.imap_unordered(process_block, blocks, chunksize=<span class="number">10000</span>):</span><br><span class="line">            key, value = result</span><br><span class="line">            rainbow_dict[key] = value</span><br><span class="line">            pbar.update()</span><br><span class="line"></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Rainbow table built.&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> rainbow_dict</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_num1</span>(<span class="params">num1_data, rainbow_table</span>):</span><br><span class="line">    b64_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    block_count = <span class="built_in">len</span>(num1_data) // <span class="number">16</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(block_count):</span><br><span class="line">        start = i * <span class="number">16</span></span><br><span class="line">        end = start + <span class="number">16</span></span><br><span class="line">        block = num1_data[start:end]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> block <span class="keyword">in</span> rainbow_table:</span><br><span class="line">            b64_string += rainbow_table[block]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[!] Block <span class="subst">&#123;i&#125;</span> not found in rainbow table.&quot;</span>)</span><br><span class="line">            b64_string += <span class="string">&quot;????&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> b64_string</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    rainbow_table = build_rainbow_table(custom_table)</span><br><span class="line">    num1 = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;8E681BB44AFA6C03C884467B469BE7BFE7F132B5DF3916FE3B8D902088D6BC040D5001699DE9EBEEEA63FE189D75014C59B1FF9363D8CE60FD211E4A5025F5F8968C3ABFD11318BD93C11088EAD50A7FD54A12DE52F0B1158938B76CB3374F8B795DA8FAD7ED6F1FF5F1C01B54BCF774DB4556CDC4E2A693FB097EF2235C915F9300E5F9278AADC17E18C6224BD7A6CA2F100A32105E59BEAE243E082A4DD1F56AFC5D84EAEB1B278352A0BB9DF40AA95530F1701653771B2C99179A70E24090C3B1EA924B3515145A30BF56306CF0304D5B097C74989E8872666C5C38A5760BA8EE7BF1B3AD582DBFA7331183467F1D1C9D861AC6D6B299CCC782ABED3A6B12A6F8BF1C3BEBDAE0610815018B2443CA154B1D9188BC5F9261370AA2D3309651AAA5D9505B823AAA1F77FF9CA64F2328E780088BE5CE1DFC0B6866BC5FFA44C25F0F0C861462D2F4A2E8CC9B274828AE5B76E8BCE03D8B844C29C8927FDC1EA680FF783FE1394BD0CCE013F7367CDD5C9602DCF9E9DD1887E9AC4326B3DF68C2FE3010B066DD046AFFD2FAE186EFA104BCADD1CE58A85D9D37517FCFF102BB4BB4161BBFE37105D41B5832E8592CCEE3D40B9E02F4A1343EF28FA39F7F24346E29246BFE8AB3E26C37E4EA7944F9A5285DCEAE7923862F9A00456E9F8711D10FE674BD7BE5812681EDD22A23E76F7D40D608EA781278B84F85E96C8B6DE78C14218A923FBA2D7968BEA20992D5B3FE7C4E5217E2AAEAECBD021D1C80AAF333BB65CBE51D96448F4E11696DA570984DBCD57CBF2C56131FF436B464FF520544023E15A0096912D151FF8A5A5BD0694B07678AE78F16A6401560E3DC628411085141B47ABA5A473429E776B1DAE3A829B679DAA5E2244113224667CB8DF684EC0EA8DE0E01AABFBC3AD00F8E658452BF43&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">len</span>(num1))</span><br><span class="line">    b64_string = decrypt_num1(num1, rainbow_table)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Recovered Base64 String:&quot;</span>, b64_string)</span><br></pre></td></tr></table></figure>
<p>得到base64：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">YIfUIfUWfUW7UW7XW7XM7XMkXMk7Mk7rk7rr7rrTrrTcrTcmTcmncmnOmnOYnOYLOYLPYLPdLPd6Pd63d63v63vg3vg5vg5Sg5S55S5SS5S75S7BS7Bo7BojBojdojdOjdO/dO/lO/lr/lr/lr/1r/1d/1dt1dt6????</span><br></pre></td></tr></table></figure>
<p>但是这个base64很明显是一位一位增加的（也就是源程序在进行哈希时一次只右移了一个字节），提取得到真正的base64密文：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">message = <span class="built_in">bytearray</span>(<span class="string">b&quot;YIfUIfUWfUW7UW7XW7XM7XMkXMk7Mk7rk7rr7rrTrrTcrTcmTcmncmnOmnOYnOYLOYLPYLPdLPd6Pd63d63v63vg3vg5vg5Sg5S55S5SS5S75S7BS7Bo7BojBojdojdOjdO/dO/lO/lr/lr/lr/1r/1d/1dt1dt6????&quot;</span>)</span><br><span class="line">output = <span class="built_in">bytearray</span>(<span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(message), <span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">        output += message[i:i+<span class="number">4</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        output.append(message[i+<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">output[-<span class="number">1</span>] = <span class="string">b&quot;=&quot;</span>[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(output)</span><br><span class="line"></span><br><span class="line">gen = <span class="built_in">bytearray</span>()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(output)-<span class="number">3</span>):</span><br><span class="line">    gen += output[i:i+<span class="number">4</span>]</span><br><span class="line"><span class="built_in">print</span>(message)</span><br><span class="line"><span class="built_in">print</span>(gen)</span><br></pre></td></tr></table></figure>
<p>得到密文为<font color=lime><strong>YIfUW7XMk7rrTcmnOYLPd63vg5S5S7BojdO&#x2F;lr&#x2F;1dt6&#x3D;</strong></font>，接下来编写脚本爆破解密：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;atomic&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 配置区域 ===</span></span><br><span class="line"><span class="type">const</span> string target_b64 = <span class="string">&quot;YIfUW7XMk7rrTcmnOYLPd63vg5S5S7BojdO/lr/1dt6=&quot;</span>;</span><br><span class="line"><span class="type">const</span> string known_prefix = <span class="string">&quot;H&amp;NCTF&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> num_threads = thread::<span class="built_in">hardware_concurrency</span>();</span><br><span class="line"><span class="type">const</span> <span class="type">uint64_t</span> start_seed = <span class="number">1700000000</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">uint64_t</span> end_seed = <span class="number">1800000000</span>;</span><br><span class="line"></span><br><span class="line">mutex result_mutex;</span><br><span class="line"><span class="function">atomic&lt;<span class="type">bool</span>&gt; <span class="title">found</span><span class="params">(<span class="literal">false</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// === macOS 版本的 rand/srand 实现 ===</span></span><br><span class="line"><span class="type">uint64_t</span> seed;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mac_srand</span><span class="params">(<span class="type">uint64_t</span> s)</span> </span>&#123;</span><br><span class="line">    seed = s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">mac_rand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (seed == <span class="number">0</span>)</span><br><span class="line">        seed = <span class="number">123459876</span>;</span><br><span class="line">    <span class="type">uint64_t</span> hi = seed / <span class="number">127773</span>;</span><br><span class="line">    <span class="type">uint64_t</span> lo = seed % <span class="number">127773</span>;</span><br><span class="line">    <span class="type">int64_t</span> x = <span class="number">16807</span> * lo - <span class="number">2836</span> * hi;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>)</span><br><span class="line">        x += <span class="number">0x7fffffff</span>;</span><br><span class="line">    <span class="keyword">return</span> ((seed = x) % ((<span class="type">long</span>)RAND_MAX + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// === Base64 编码函数（使用自定义表）===</span></span><br><span class="line"><span class="function">string <span class="title">custom_base64_encode</span><span class="params">(<span class="type">const</span> string&amp; data, <span class="type">const</span> string&amp; table)</span> </span>&#123;</span><br><span class="line">    string encoded;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> char_array_3[<span class="number">3</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> char_array_4[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> c : data) &#123;</span><br><span class="line">        char_array_3[i++] = c;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">3</span>) &#123;</span><br><span class="line">            char_array_4[<span class="number">0</span>] = (char_array_3[<span class="number">0</span>] &amp; <span class="number">0xfc</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">            char_array_4[<span class="number">1</span>] = ((char_array_3[<span class="number">0</span>] &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">4</span>) + ((char_array_3[<span class="number">1</span>] &amp; <span class="number">0xf0</span>) &gt;&gt; <span class="number">4</span>);</span><br><span class="line">            char_array_4[<span class="number">2</span>] = ((char_array_3[<span class="number">1</span>] &amp; <span class="number">0x0f</span>) &lt;&lt; <span class="number">2</span>) + ((char_array_3[<span class="number">2</span>] &amp; <span class="number">0xc0</span>) &gt;&gt; <span class="number">6</span>);</span><br><span class="line">            char_array_4[<span class="number">3</span>] = char_array_3[<span class="number">2</span>] &amp; <span class="number">0x3f</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; (i &lt;<span class="number">4</span>) ; i++)</span><br><span class="line">                encoded += table[char_array_4[i]];</span><br><span class="line">            i = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(j = i; j &lt; <span class="number">3</span>; j++)</span><br><span class="line">            char_array_3[j] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        char_array_4[<span class="number">0</span>] = (char_array_3[<span class="number">0</span>] &amp; <span class="number">0xfc</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">        char_array_4[<span class="number">1</span>] = ((char_array_3[<span class="number">0</span>] &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">4</span>) + ((char_array_3[<span class="number">1</span>] &amp; <span class="number">0xf0</span>) &gt;&gt; <span class="number">4</span>);</span><br><span class="line">        char_array_4[<span class="number">2</span>] = ((char_array_3[<span class="number">1</span>] &amp; <span class="number">0x0f</span>) &lt;&lt; <span class="number">2</span>) + ((char_array_3[<span class="number">2</span>] &amp; <span class="number">0xc0</span>) &gt;&gt; <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; (j &lt; i + <span class="number">1</span>); j++)</span><br><span class="line">            encoded += table[char_array_4[j]];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((i++ &lt; <span class="number">3</span>))</span><br><span class="line">            encoded += <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> encoded;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 根据 seed 生成打乱后的 Base64 表 ===</span></span><br><span class="line"><span class="function">string <span class="title">generate_custom_table</span><span class="params">(<span class="type">uint64_t</span> seed_candidate)</span> </span>&#123;</span><br><span class="line">    string base64_chars = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span></span><br><span class="line">                          <span class="string">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span></span><br><span class="line">                          <span class="string">&quot;0123456789+/&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">mac_srand</span>(seed_candidate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一次 rand()</span></span><br><span class="line">    <span class="type">int</span> v7 = <span class="built_in">mac_rand</span>() % <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Shuffle 操作</span></span><br><span class="line">    <span class="type">int</span> len = base64_chars.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">59</span>; ++i) &#123;</span><br><span class="line">        <span class="type">int</span> v5 = i + v7;</span><br><span class="line">        <span class="keyword">if</span> (v5 &gt;= len) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="built_in">swap</span>(base64_chars[i], base64_chars[v5]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> base64_chars;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 检查当前 seed 是否匹配目标 Base64 ===</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">check_seed</span><span class="params">(<span class="type">uint64_t</span> seed_candidate)</span> </span>&#123;</span><br><span class="line">    string custom_table = <span class="built_in">generate_custom_table</span>(seed_candidate);</span><br><span class="line">    string encoded = <span class="built_in">custom_base64_encode</span>(known_prefix, custom_table);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (target_b<span class="number">64.f</span>ind(encoded) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">lock</span><span class="params">(result_mutex)</span></span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[+] Found matching seed: &quot;</span> &lt;&lt; seed_candidate &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[+] Custom Base64 Table:&quot;</span> &lt;&lt; endl &lt;&lt; custom_table &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[+] Encoded prefix: &quot;</span> &lt;&lt; encoded &lt;&lt; endl;</span><br><span class="line">        found = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 线程任务函数 ===</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">worker</span><span class="params">(<span class="type">uint64_t</span> start, <span class="type">uint64_t</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint64_t</span> i = start; i &lt;= end &amp;&amp; !found; ++i) &#123;</span><br><span class="line">        <span class="built_in">check_seed</span>(i);</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">100000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;\r[*] Scanning: &quot;</span> &lt;&lt; fixed &lt;&lt; (<span class="type">double</span>)(i - start_seed) / (end_seed - start_seed) * <span class="number">100</span> &lt;&lt; <span class="string">&quot;%&quot;</span>;</span><br><span class="line">            cout.<span class="built_in">flush</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// === 主函数 ===</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[*] Starting brute-force from &quot;</span> &lt;&lt; start_seed &lt;&lt; <span class="string">&quot; to &quot;</span> &lt;&lt; end_seed &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[*] Target Base64: &quot;</span> &lt;&lt; target_b64 &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[*] Known prefix:  &quot;</span> &lt;&lt; known_prefix &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[*] Using &quot;</span> &lt;&lt; num_threads &lt;&lt; <span class="string">&quot; threads&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    vector&lt;thread&gt; workers;</span><br><span class="line">    <span class="type">uint64_t</span> range = (end_seed - start_seed) / num_threads;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> t = <span class="number">0</span>; t &lt; num_threads; ++t) &#123;</span><br><span class="line">        <span class="type">uint64_t</span> start = start_seed + t * range;</span><br><span class="line">        <span class="type">uint64_t</span> end = (t == num_threads - <span class="number">1</span>) ? end_seed : start + range - <span class="number">1</span>;</span><br><span class="line">        workers.<span class="built_in">emplace_back</span>(worker, start, end);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; w : workers) &#123;</span><br><span class="line">        w.<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[-] No matching seed found.&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到表：<font color=red><strong>GHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+&#x2F;EFABCD</strong></font><br><font color=deepskyblue><strong>H&amp;NCTF{Ye5h!!!I_Lik333_bur9~^o^}</strong></font></p>
<h2 id="HNDRIVER："><a href="#HNDRIVER：" class="headerlink" title="HNDRIVER："></a>HNDRIVER：</h2><p>查看用户态程序：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">void</span> *v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *v6; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-348h]</span></span><br><span class="line">  _BYTE v8[<span class="number">32</span>]; <span class="comment">// [rsp+38h] [rbp-340h] BYREF</span></span><br><span class="line">  _BYTE v9[<span class="number">40</span>]; <span class="comment">// [rsp+58h] [rbp-320h] BYREF</span></span><br><span class="line">  _BYTE dst_[<span class="number">760</span>]; <span class="comment">// [rsp+80h] [rbp-2F8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( argc == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">qmemcpy</span>(</span><br><span class="line">      dst_,</span><br><span class="line">      <span class="string">L&quot; _    _  _   _  _  __ ______  _____   _   _  ______  _      \n&quot;</span></span><br><span class="line">       <span class="string">&quot;| |  | || \\ | || |/ /|  ____||  __ \\ | \\ | ||  ____|| |     \n&quot;</span></span><br><span class="line">       <span class="string">&quot;| |__| ||  \\| || &#x27; / | |__   | |__) ||  \\| || |__   | |     \n&quot;</span></span><br><span class="line">       <span class="string">&quot;|  __  || . ` ||  &lt;  |  __|  |  _  / | . ` ||  __|  | |     \n&quot;</span></span><br><span class="line">       <span class="string">&quot;| |  | || |\\  || . \\ | |____ | | \\ \\ | |\\  || |____ | |____ \n&quot;</span></span><br><span class="line">       <span class="string">&quot;|_|  |_||_| \\_||_|\\_\\|______||_|  \\_\\|_| \\_||______||______|\n&quot;</span>,</span><br><span class="line">      <span class="number">0x2DEu</span>);</span><br><span class="line">    v6 = (<span class="type">void</span> *)<span class="built_in">sub_140004110</span>((__int64)&amp;qword_14003F320, (__int64)dst_);</span><br><span class="line">    _CallMemberFunction0(v6, (<span class="built_in">void</span> (__fastcall *)(<span class="type">void</span> *))sub_1400044C0);</span><br><span class="line">    <span class="built_in">sub_140003550</span>(v8, argv[<span class="number">1</span>]);</span><br><span class="line">    v7 = std::shared_ptr&lt;__ExceptionPtr&gt;::<span class="keyword">operator</span>=(v9, v8);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)<span class="built_in">sub_140003210</span>(v7) )</span><br><span class="line">      <span class="built_in">sub_140004110</span>((__int64)&amp;qword_14003F320, (__int64)<span class="string">L&quot;[R3] Backup path sent to driver successfully.\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">sub_140004110</span>((__int64)&amp;qword_14003F320, (__int64)<span class="string">L&quot;[R3] Failed to send backup info to driver.\n&quot;</span>);</span><br><span class="line">    std::wstring::~<span class="built_in">wstring</span>(v8);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 = (<span class="type">void</span> *)<span class="built_in">sub_140004110</span>(</span><br><span class="line">                   (__int64)&amp;qword_14003F320,</span><br><span class="line">                   (__int64)<span class="string">L&quot;here&#x27;s gift for you: A+cRZ+ofCz4yqqnHClujCqD5DF3RCW8Ltlxju5NzCqdHY/Pcu5nXul+c0l+buBCLGRXjoMp&quot;</span></span><br><span class="line">                             <span class="string">&quot;cG5ZM0lmFGRmFG5oFCW+cIYpi&quot;</span>);</span><br><span class="line">    _CallMemberFunction0(v3, (<span class="built_in">void</span> (__fastcall *)(<span class="type">void</span> *))sub_1400044C0);</span><br><span class="line">    v4 = (<span class="type">void</span> *)<span class="built_in">sub_140004110</span>((__int64)&amp;qword_14003F450, (__int64)<span class="string">L&quot;Usage: coom.exe &lt;BackUpFileName&gt;&quot;</span>);</span><br><span class="line">    _CallMemberFunction0(v4, (<span class="built_in">void</span> (__fastcall *)(<span class="type">void</span> *))sub_1400044C0);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现了一个base64密文，后续分析出整个程序只是把用户输入传给了驱动，分析驱动文件，发现了一个无xref的构造函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140002010</span><span class="params">(__int64 a1, __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NTSTATUS v3; <span class="comment">// [rsp+80h] [rbp-188h]</span></span><br><span class="line">  NTSTATUS v4; <span class="comment">// [rsp+80h] [rbp-188h]</span></span><br><span class="line">  NTSTATUS v5; <span class="comment">// [rsp+80h] [rbp-188h]</span></span><br><span class="line">  PFLT_CONTEXT Context; <span class="comment">// [rsp+88h] [rbp-180h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+90h] [rbp-178h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> n0x100000; <span class="comment">// [rsp+94h] [rbp-174h]</span></span><br><span class="line">  SIZE_T NumberOfBytes; <span class="comment">// [rsp+98h] [rbp-170h]</span></span><br><span class="line">  ULONG BytesRead; <span class="comment">// [rsp+A0h] [rbp-168h] BYREF</span></span><br><span class="line">  PVOID Buffer_1; <span class="comment">// [rsp+A8h] [rbp-160h]</span></span><br><span class="line">  PFILE_OBJECT FileObject; <span class="comment">// [rsp+B0h] [rbp-158h] BYREF</span></span><br><span class="line">  PFILE_OBJECT FileObject_; <span class="comment">// [rsp+B8h] [rbp-150h] BYREF</span></span><br><span class="line">  <span class="keyword">union</span> <span class="title class_">_LARGE_INTEGER</span> FileSize; <span class="comment">// [rsp+C0h] [rbp-148h] BYREF</span></span><br><span class="line">  PVOID P; <span class="comment">// [rsp+C8h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *FileHandle; <span class="comment">// [rsp+D0h] [rbp-138h] BYREF</span></span><br><span class="line">  HANDLE FileHandle_; <span class="comment">// [rsp+D8h] [rbp-130h] BYREF</span></span><br><span class="line">  ULONG Length[<span class="number">2</span>]; <span class="comment">// [rsp+E0h] [rbp-128h]</span></span><br><span class="line">  SIZE_T NumberOfBytes_1; <span class="comment">// [rsp+E8h] [rbp-120h]</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// [rsp+F0h] [rbp-118h]</span></span><br><span class="line">  HANDLE n4; <span class="comment">// [rsp+F8h] [rbp-110h]</span></span><br><span class="line">  PVOID Buffer; <span class="comment">// [rsp+100h] [rbp-108h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v23; <span class="comment">// [rsp+108h] [rbp-100h] BYREF</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_OBJECT_ATTRIBUTES</span> ObjectAttributes; <span class="comment">// [rsp+110h] [rbp-F8h] BYREF</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_OBJECT_ATTRIBUTES</span> buf_; <span class="comment">// [rsp+140h] [rbp-C8h] BYREF</span></span><br><span class="line">  __int64 v26; <span class="comment">// [rsp+170h] [rbp-98h]</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_STATUS_BLOCK</span> IoStatusBlock; <span class="comment">// [rsp+178h] [rbp-90h] BYREF</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">_IO_STATUS_BLOCK</span> buf__1; <span class="comment">// [rsp+188h] [rbp-80h] BYREF</span></span><br><span class="line">  __m128 v29[<span class="number">5</span>]; <span class="comment">// [rsp+1A0h] [rbp-68h] BYREF</span></span><br><span class="line"></span><br><span class="line">  Context = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">KeGetCurrentIrql</span>() &lt; <span class="number">2u</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    n4 = <span class="built_in">PsGetCurrentProcessId</span>();</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)n4 &gt; <span class="number">4</span></span><br><span class="line">      &amp;&amp; <span class="built_in">FltGetStreamHandleContext</span>(*(PFLT_INSTANCE *)(a2 + <span class="number">24</span>), *(PFILE_OBJECT *)(a2 + <span class="number">32</span>), &amp;Context) &gt;= <span class="number">0</span></span><br><span class="line">      &amp;&amp; Context )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_QWORD *)Context &amp;&amp; <span class="built_in">RtlPrefixUnicodeString</span>(&amp;String1, *(PCUNICODE_STRING *)Context, <span class="number">1u</span>) )</span><br><span class="line">        *((_DWORD *)Context + <span class="number">13</span>) = <span class="number">2</span>;</span><br><span class="line">      *((_BYTE *)Context + <span class="number">50</span>) = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( p_Length )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_QWORD *)Context &amp;&amp; <span class="built_in">RtlSuffixUnicodeString</span>(p_Length, *(PCUNICODE_STRING *)Context, <span class="number">1u</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">DbgPrintEx</span>(<span class="number">0x4Du</span>, <span class="number">0</span>, <span class="string">&quot;try backup %wZ \n&quot;</span>, *(_QWORD *)Context);</span><br><span class="line">          <span class="built_in">FsRtlGetFileSize</span>(*(PFILE_OBJECT *)(a2 + <span class="number">32</span>), &amp;FileSize);</span><br><span class="line">          <span class="built_in">DbgPrintEx</span>(<span class="number">0x4Du</span>, <span class="number">0</span>, <span class="string">&quot;file size: %llu\n&quot;</span>, FileSize.QuadPart);</span><br><span class="line">          <span class="keyword">if</span> ( !FileSize.QuadPart )</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">          FileHandle = <span class="number">0</span>;</span><br><span class="line">          FileObject = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;ObjectAttributes, <span class="number">0</span>, <span class="built_in">sizeof</span>(ObjectAttributes));</span><br><span class="line">          ObjectAttributes.Length = <span class="number">48</span>;</span><br><span class="line">          ObjectAttributes.RootDirectory = <span class="number">0</span>;</span><br><span class="line">          ObjectAttributes.Attributes = <span class="number">576</span>;</span><br><span class="line">          ObjectAttributes.ObjectName = *(PUNICODE_STRING *)Context;</span><br><span class="line">          ObjectAttributes.SecurityDescriptor = <span class="number">0</span>;</span><br><span class="line">          ObjectAttributes.SecurityQualityOfService = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;IoStatusBlock, <span class="number">0</span>, <span class="built_in">sizeof</span>(IoStatusBlock));</span><br><span class="line">          FileHandle_ = <span class="number">0</span>;</span><br><span class="line">          FileObject_ = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;buf_, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf_));</span><br><span class="line">          buf_.Length = <span class="number">48</span>;</span><br><span class="line">          buf_.RootDirectory = <span class="number">0</span>;</span><br><span class="line">          buf_.Attributes = <span class="number">576</span>;</span><br><span class="line">          buf_.ObjectName = (PUNICODE_STRING)::P;</span><br><span class="line">          buf_.SecurityDescriptor = <span class="number">0</span>;</span><br><span class="line">          buf_.SecurityQualityOfService = <span class="number">0</span>;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;buf__1, <span class="number">0</span>, <span class="built_in">sizeof</span>(buf__1));</span><br><span class="line">          v26 = <span class="number">0</span>;</span><br><span class="line">          n0x100000 = <span class="number">0x100000</span>;</span><br><span class="line">          BytesRead = <span class="number">0</span>;</span><br><span class="line">          v20 = <span class="number">0</span>;</span><br><span class="line">          Buffer_1 = <span class="number">0</span>;</span><br><span class="line">          NumberOfBytes = FileSize.QuadPart;</span><br><span class="line">          Buffer_1 = <span class="built_in">ExAllocatePool</span>(PagedPool, FileSize.QuadPart);</span><br><span class="line">          <span class="keyword">if</span> ( Buffer_1 )</span><br><span class="line">          &#123;</span><br><span class="line">            v3 = <span class="built_in">FltCreateFileEx</span>(</span><br><span class="line">                   *(PFLT_FILTER *)(a2 + <span class="number">8</span>),</span><br><span class="line">                   *(PFLT_INSTANCE *)(a2 + <span class="number">24</span>),</span><br><span class="line">                   &amp;FileHandle,</span><br><span class="line">                   &amp;FileObject,</span><br><span class="line">                   <span class="number">0x80000000</span>,</span><br><span class="line">                   &amp;ObjectAttributes,</span><br><span class="line">                   &amp;IoStatusBlock,</span><br><span class="line">                   <span class="number">0</span>,</span><br><span class="line">                   <span class="number">0x80u</span>,</span><br><span class="line">                   <span class="number">3u</span>,</span><br><span class="line">                   <span class="number">1u</span>,</span><br><span class="line">                   <span class="number">0x24u</span>,</span><br><span class="line">                   <span class="number">0</span>,</span><br><span class="line">                   <span class="number">0</span>,</span><br><span class="line">                   <span class="number">0x800u</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v3 &gt;= <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v4 = <span class="built_in">FltCreateFileEx</span>(</span><br><span class="line">                     *(PFLT_FILTER *)(a2 + <span class="number">8</span>),</span><br><span class="line">                     *(PFLT_INSTANCE *)(a2 + <span class="number">24</span>),</span><br><span class="line">                     &amp;FileHandle_,</span><br><span class="line">                     &amp;FileObject_,</span><br><span class="line">                     <span class="number">0x40000000u</span>,</span><br><span class="line">                     &amp;buf_,</span><br><span class="line">                     &amp;buf__1,</span><br><span class="line">                     <span class="number">0</span>,</span><br><span class="line">                     <span class="number">0x80u</span>,</span><br><span class="line">                     <span class="number">0</span>,</span><br><span class="line">                     <span class="number">5u</span>,</span><br><span class="line">                     <span class="number">0x24u</span>,</span><br><span class="line">                     <span class="number">0</span>,</span><br><span class="line">                     <span class="number">0</span>,</span><br><span class="line">                     <span class="number">0</span>);</span><br><span class="line">              <span class="keyword">if</span> ( v4 &gt;= <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">while</span> ( NumberOfBytes )</span><br><span class="line">                &#123;</span><br><span class="line">                  Buffer = Buffer_1;</span><br><span class="line">                  <span class="keyword">if</span> ( n0x100000 &gt;= NumberOfBytes )</span><br><span class="line">                    *(_QWORD *)Length = NumberOfBytes;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    *(_QWORD *)Length = n0x100000;</span><br><span class="line">                  v5 = <span class="built_in">FltReadFile</span>(*(PFLT_INSTANCE *)(a2 + <span class="number">24</span>), FileObject, <span class="number">0</span>, Length[<span class="number">0</span>], Buffer, <span class="number">0</span>, &amp;BytesRead, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                  <span class="keyword">if</span> ( v5 &lt; <span class="number">0</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    _mm_lfence();</span><br><span class="line">                    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4Du</span>, <span class="number">0</span>, <span class="string">&quot;[%s:%d] status: 0x%x\n&quot;</span>, <span class="string">&quot;MINIFILTER::PostWriteOperation&quot;</span>, <span class="number">334</span>, v5);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="built_in">sub_140001894</span>(v29);</span><br><span class="line">                  P = <span class="number">0</span>;</span><br><span class="line">                  v23 = <span class="number">0</span>;</span><br><span class="line">                  <span class="keyword">if</span> ( n0x100000 &gt;= NumberOfBytes )</span><br><span class="line">                    NumberOfBytes_1 = NumberOfBytes;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    NumberOfBytes_1 = n0x100000;</span><br><span class="line">                  v7 = <span class="built_in">sub_1400010C0</span>((__int64)Buffer_1, NumberOfBytes_1, &amp;P, &amp;v23, (__int64)v29);</span><br><span class="line">                  <span class="keyword">if</span> ( v7 &lt; <span class="number">0</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    _mm_lfence();</span><br><span class="line">                    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4Du</span>, <span class="number">0</span>, <span class="string">&quot;[%s:%d] status: 0x%x\n&quot;</span>, <span class="string">&quot;MINIFILTER::PostWriteOperation&quot;</span>, <span class="number">342</span>, v7);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  v7 = <span class="built_in">FltWriteFile</span>(*(PFLT_INSTANCE *)(a2 + <span class="number">24</span>), FileObject_, <span class="number">0</span>, BytesRead, P, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                  <span class="built_in">ExFreePoolWithTag</span>(P, <span class="number">0</span>);</span><br><span class="line">                  <span class="keyword">if</span> ( v7 &lt; <span class="number">0</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    <span class="built_in">DbgPrintEx</span>(<span class="number">0x4Du</span>, <span class="number">0</span>, <span class="string">&quot;[%s:%d] status: 0x%x\n&quot;</span>, <span class="string">&quot;MINIFILTER::PostWriteOperation&quot;</span>, <span class="number">347</span>, v7);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  NumberOfBytes -= BytesRead;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                _mm_lfence();</span><br><span class="line">                <span class="built_in">DbgPrintEx</span>(<span class="number">0x4Du</span>, <span class="number">0</span>, <span class="string">&quot;[%s:%d] status: 0x%x\n&quot;</span>, <span class="string">&quot;MINIFILTER::PostWriteOperation&quot;</span>, <span class="number">329</span>, v4);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              _mm_lfence();</span><br><span class="line">              <span class="built_in">DbgPrintEx</span>(<span class="number">0x4Du</span>, <span class="number">0</span>, <span class="string">&quot;[%s:%d] status: 0x%x\n&quot;</span>, <span class="string">&quot;MINIFILTER::PostWriteOperation&quot;</span>, <span class="number">324</span>, v3);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( Buffer_1 )</span><br><span class="line">            <span class="built_in">ExFreePoolWithTag</span>(Buffer_1, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( FileHandle )</span><br><span class="line">            <span class="built_in">FltClose</span>(FileHandle);</span><br><span class="line">          <span class="keyword">if</span> ( FileHandle_ )</span><br><span class="line">            <span class="built_in">FltClose</span>(FileHandle_);</span><br><span class="line">          <span class="keyword">if</span> ( FileObject )</span><br><span class="line">            <span class="built_in">ObfDereferenceObject</span>(FileObject);</span><br><span class="line">          <span class="keyword">if</span> ( FileObject_ )</span><br><span class="line">            <span class="built_in">ObfDereferenceObject</span>(FileObject_);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( Context )</span><br><span class="line">    <span class="built_in">FltReleaseContext</span>(Context);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>v7 = sub_1400010C0((__int64)Buffer_1, NumberOfBytes_1, &amp;P, &amp;v23, (__int64)v29);</code>是一个接受自定义base64表的base64编码函数，base64表v29由上文的<code>sub_140001894(v29);</code>生成，查看这个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140001894</span><span class="params">(__m128 *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 n64; <span class="comment">// rax</span></span><br><span class="line">  __int8 v2; <span class="comment">// [rsp+20h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> n63; <span class="comment">// [rsp+24h] [rbp-24h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+28h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i_4; <span class="comment">// [rsp+2Ch] [rbp-1Ch]</span></span><br><span class="line">  __m128 *v6; <span class="comment">// [rsp+38h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = (__m128 *)<span class="built_in">sub_1400010A4</span>();</span><br><span class="line">  <span class="built_in">sub_140003640</span>(a1, v6, <span class="number">0x40u</span>);</span><br><span class="line">  i = <span class="number">20250603</span>;</span><br><span class="line">  <span class="keyword">for</span> ( n63 = <span class="number">63</span>; n63 &gt; <span class="number">0</span>; --n63 )</span><br><span class="line">  &#123;</span><br><span class="line">    i = <span class="built_in">sub_140001964</span>(i);</span><br><span class="line">    i_4 = i % (n63 + <span class="number">1</span>);</span><br><span class="line">    v2 = a1-&gt;m128_i8[n63];</span><br><span class="line">    a1-&gt;m128_i8[n63] = a1-&gt;m128_i8[i_4];</span><br><span class="line">    a1-&gt;m128_i8[i_4] = v2;</span><br><span class="line">  &#125;</span><br><span class="line">  n64 = <span class="number">64</span>;</span><br><span class="line">  a1[<span class="number">4</span>].m128_i8[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> n64;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">_BYTE *<span class="title">sub_1400010A4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sub_1400019E4</span>((__int64)byte_1400042D0);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">_BYTE *__fastcall <span class="title">sub_1400019E4</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 n0x41; <span class="comment">// [rsp+20h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( n0x41 = <span class="number">0</span>; n0x41 &lt; <span class="number">0x41</span>; ++n0x41 )</span><br><span class="line">  &#123;</span><br><span class="line">    _mm_lfence();</span><br><span class="line">    byte_140005060[n0x41] = <span class="built_in">sub_140001A4C</span>(*(_BYTE *)(n0x41 + a1), n0x41);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> byte_140005060;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140001A4C</span><span class="params">(<span class="type">char</span> a1, <span class="type">unsigned</span> __int64 n0x41)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">char</span>)n0x41 ^ byte_1400042C0[n0x41 % <span class="number">8</span>] ^ (<span class="type">unsigned</span> <span class="type">int</span>)a1;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_140001964</span><span class="params">(__int64 n20250603)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="number">0x41C64E6D</span> * n20250603 + <span class="number">114514</span>) &amp; <span class="number">0x7FFFFFFF</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>提取密文和密钥进行同构：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">byte_1400042C0 = <span class="built_in">bytes</span>([<span class="number">0x51</span>, <span class="number">0x23</span>, <span class="number">0x97</span>, <span class="number">0xE8</span>, <span class="number">0xDC</span>, <span class="number">0xBA</span>, <span class="number">0x45</span>, <span class="number">0x67</span>,])</span><br><span class="line"></span><br><span class="line">byte_1400042D0 = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0x7A</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0xD3</span>, <span class="number">0xB0</span>, <span class="number">0xC9</span>, <span class="number">0x0D</span>, <span class="number">0x17</span>,</span><br><span class="line">    <span class="number">0x1C</span>, <span class="number">0x45</span>, <span class="number">0xD0</span>, <span class="number">0x86</span>, <span class="number">0x94</span>, <span class="number">0xDD</span>, <span class="number">0x13</span>, <span class="number">0x39</span>,</span><br><span class="line">    <span class="number">0x14</span>, <span class="number">0x61</span>, <span class="number">0xD7</span>, <span class="number">0xC8</span>, <span class="number">0xB9</span>, <span class="number">0x9F</span>, <span class="number">0x37</span>, <span class="number">0x2A</span>,</span><br><span class="line">    <span class="number">0x10</span>, <span class="number">0x4F</span>, <span class="number">0xFD</span>, <span class="number">0x94</span>, <span class="number">0x81</span>, <span class="number">0x96</span>, <span class="number">0x6C</span>, <span class="number">0x3E</span>,</span><br><span class="line">    <span class="number">0x03</span>, <span class="number">0x56</span>, <span class="number">0x8C</span>, <span class="number">0xFF</span>, <span class="number">0xB7</span>, <span class="number">0xEC</span>, <span class="number">0x21</span>, <span class="number">0x39</span>,</span><br><span class="line">    <span class="number">0x2E</span>, <span class="number">0x70</span>, <span class="number">0xD6</span>, <span class="number">0xF1</span>, <span class="number">0xB3</span>, <span class="number">0xF1</span>, <span class="number">0x27</span>, <span class="number">0x2B</span>,</span><br><span class="line">    <span class="number">0x4E</span>, <span class="number">0x55</span>, <span class="number">0xD1</span>, <span class="number">0x91</span>, <span class="number">0xBE</span>, <span class="number">0xC6</span>, <span class="number">0x23</span>, <span class="number">0x32</span>,</span><br><span class="line">    <span class="number">0x08</span>, <span class="number">0x62</span>, <span class="number">0xC3</span>, <span class="number">0xBF</span>, <span class="number">0x8D</span>, <span class="number">0xCF</span>, <span class="number">0x12</span>, <span class="number">0x6D</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor_encrypt</span>(<span class="params">a1: <span class="built_in">int</span>, n0x41: <span class="built_in">int</span></span>) -&gt; <span class="built_in">int</span>:</span><br><span class="line">    key = byte_1400042C0[n0x41 % <span class="number">8</span>]</span><br><span class="line">    <span class="keyword">return</span> (n0x41 ^ key ^ a1) &amp; <span class="number">0xFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_encoded_table</span>(<span class="params">initial_data</span>):</span><br><span class="line">    encoded_table = <span class="built_in">bytearray</span>(<span class="number">0x40</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">        a1 = initial_data[i]</span><br><span class="line">        encoded_table[i] = xor_encrypt(a1, i)</span><br><span class="line">    <span class="keyword">return</span> encoded_table</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lcg</span>(<span class="params">seed</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        seed = (<span class="number">0x41C64E6D</span> * seed + <span class="number">114514</span>) &amp; <span class="number">0x7FFFFFFF</span></span><br><span class="line">        <span class="keyword">yield</span> seed</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shuffle_table</span>(<span class="params">seed</span>):</span><br><span class="line">    prng = lcg(seed)</span><br><span class="line">    table = <span class="built_in">list</span>(generate_encoded_table(byte_1400042D0))[:<span class="number">64</span>]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">63</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">        j = <span class="built_in">next</span>(prng) % (i + <span class="number">1</span>)</span><br><span class="line">        table[i], table[j] = table[j], table[i]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(table)</span><br><span class="line"></span><br><span class="line">custom_base64_table = shuffle_table(<span class="number">20250603</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Custom Base64 Table:&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(custom_base64_table)</span><br></pre></td></tr></table></figure>
<p>得到自定义base64表：<font color=red><strong>idhR+nWSPOU0CGIrNmAqVZlYuo2sDt7yg6MBXF1aw4Kv9LHJkjb5p8&#x2F;zxcefQ3ET</strong></font><br>解密得到flag：<font color=lime><strong>HNCTF{3z_M1n1f1173r_C0mmun1c4710n_b9c1daa9-a2b3-491f-975b-de44e76e0a99}</strong></font>，改为<font color=deepskyblue><strong>H&amp;NCTF{3z_M1n1f1173r_C0mmun1c4710n_b9c1daa9-a2b3-491f-975b-de44e76e0a99}</strong></font>即可</p>
<h2 id="justgame："><a href="#justgame：" class="headerlink" title="justgame："></a>justgame：</h2><p><a href="https://astralprisma.github.io/2025/05/12/dam_25/">damctf 2025原题Is it data or data?</a>，只改了密文：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> n7; <span class="comment">// r13d</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *target; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> *s1; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> n100; <span class="comment">// al</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *p_n15_1; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">char</span> *p_n15; <span class="comment">// rdx</span></span><br><span class="line">  __int64 n9; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> s1_[<span class="number">264</span>]; <span class="comment">// [rsp+0h] [rbp-138h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v12; <span class="comment">// [rsp+108h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  __printf_chk(<span class="number">1</span>, <span class="string">&quot;please input number/n&quot;</span>, a3);</span><br><span class="line">  n7 = ::n7;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( n7 == <span class="number">7</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      p_n15 = s2;</span><br><span class="line">      n9 = ::n9;</span><br><span class="line">      i = <span class="number">15</span>;</span><br><span class="line">      <span class="keyword">if</span> ( s2 != (<span class="type">char</span> *)&amp;n15 )</span><br><span class="line">        i = n15;</span><br><span class="line">      <span class="keyword">if</span> ( ::n9 + <span class="number">1LL</span> &gt; i )</span><br><span class="line">      &#123;</span><br><span class="line">        std::string::_M_mutate(&amp;s2, ::n9, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">        p_n15 = s2;</span><br><span class="line">      &#125;</span><br><span class="line">      p_n15[n9] = <span class="string">&#x27;g&#x27;</span>;</span><br><span class="line">      ::n9 = n9 + <span class="number">1</span>;</span><br><span class="line">      s2[n9 + <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( !<span class="built_in">sub_555555402020</span>() )</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line">    target = <span class="string">&quot;dfrghumrxuqh|&quot;</span>;</span><br><span class="line">    s1 = s1_;</span><br><span class="line">    n7 = ::n7 + <span class="number">1</span>;</span><br><span class="line">    n100 = <span class="string">&#x27;d&#x27;</span>;</span><br><span class="line">    ++::n7;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++s1;</span><br><span class="line">      ++target;</span><br><span class="line">      *(s1 - <span class="number">1</span>) = n100 - <span class="number">3</span>;</span><br><span class="line">      n100 = *target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( *target );</span><br><span class="line">    p_n15_1 = s2;</span><br><span class="line">    *s1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1_, p_n15_1) )</span><br><span class="line">      <span class="built_in">sub_555555403720</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>main函数仍为等待输入检验和目标值是否相同，以及在第15步会自动插入一个字符g，查看输入接收函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">输入值/控制函数	作用</span><br><span class="line">1	将用户输入的另一个数字作为 ASCII 值插入到字符串尾部</span><br><span class="line">4	写入字符“f”</span><br><span class="line">5	对最后一个字符-1</span><br><span class="line">6	对最后一个字符+3</span><br><span class="line">7	写入字符“a”</span><br><span class="line">11	将最后一个字符改为“t”</span><br><span class="line">13	删除最后一个字符</span><br><span class="line">第8步	写入字符“g”</span><br></pre></td></tr></table></figure>
<p>密文<font color=red><strong>dfrghumrxuqh|</strong></font>有一个自解密，调试得到<font color=lime><strong>acoderjourney</strong></font>，构造payload就完了：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">target = <span class="string">b&quot;acoderjourney&quot;</span></span><br><span class="line">payload = <span class="string">&quot;[&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(target)):</span><br><span class="line">    cand = <span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">    payload += <span class="string">&quot;&#x27;7&#x27;, &quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> cand == target[i]:</span><br><span class="line">        <span class="keyword">if</span> cand &lt; target[i]:</span><br><span class="line">            cand += <span class="number">3</span></span><br><span class="line">            payload += <span class="string">&quot;&#x27;6&#x27;, &quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cand -= <span class="number">1</span></span><br><span class="line">            payload += <span class="string">&quot;&#x27;5&#x27;, &quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bytes</span>([cand]))</span><br><span class="line">payload += <span class="string">&quot;]&quot;</span></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br></pre></td></tr></table></figure>
<p>得到payload<code>[&#39;7&#39;, &#39;7&#39;, &#39;6&#39;, &#39;5&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;5&#39;, &#39;7&#39;, &#39;6&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;5&#39;, &#39;5&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;5&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;5&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;5&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;5&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;5&#39;, &#39;5&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;5&#39;, &#39;5&#39;, &#39;7&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;, &#39;6&#39;]</code>，注意还要插入一个13来删掉字母g，编写脚本提交payload：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">host = <span class="string">&quot;27.25.151.198&quot;</span></span><br><span class="line">port = <span class="number">38214</span></span><br><span class="line"></span><br><span class="line">payloads = [<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;13&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;6&#x27;</span>]</span><br><span class="line"></span><br><span class="line">conn = remote(host, port)</span><br><span class="line"></span><br><span class="line">initial = conn.recvuntil(<span class="string">b&quot;&gt;&quot;</span>, timeout=<span class="number">5</span>)</span><br><span class="line"><span class="comment"># print(initial.decode())</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, payload <span class="keyword">in</span> <span class="built_in">enumerate</span>(payloads):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Sending: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line">    conn.sendline(payload.encode())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="built_in">len</span>(payloads) - <span class="number">1</span>:</span><br><span class="line">        <span class="comment">#print(&quot;[+] Waiting for &#x27;&gt;&#x27; prompt...&quot;)</span></span><br><span class="line">        response = conn.recvuntil(<span class="string">b&quot;&gt;&quot;</span>, timeout=<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        final_output = conn.recvall(timeout=<span class="number">5</span>).decode()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n[+] Final output: &quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(final_output)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>
<p><font color=deepskyblue><strong>flag{586cee19-8bf4-4027-8bf3-1fd6fa74be92}</strong></font></p>
<h2 id="xxxR01d："><a href="#xxxR01d：" class="headerlink" title="xxxR01d："></a>xxxR01d：</h2><p>查看mainctivity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.aaron.xxxr01d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View.OnClickListener;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"><span class="keyword">import</span> com.aaron.nativelib.NativeLib;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] FIXED_IV = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] FIXED_KEY = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> Button buttonCheck;</span><br><span class="line">    <span class="keyword">private</span> EditText editTextUserInput;</span><br><span class="line">    <span class="keyword">private</span> NativeLib nativeInterface;</span><br><span class="line"></span><br><span class="line">    System.loadLibrary(<span class="string">&quot;Z1Y4&quot;</span>);</span><br><span class="line">    MainActivity.FIXED_KEY = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">84</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">0x73</span>, <span class="number">73</span>, <span class="number">0x73</span>, <span class="number">65</span>, <span class="number">49</span>, <span class="number">54</span>, <span class="number">66</span>, <span class="number">0x79</span>, <span class="number">0x74</span>, <span class="number">101</span>, <span class="number">75</span>, <span class="number">101</span>, <span class="number">0x79</span>&#125;;</span><br><span class="line">    MainActivity.FIXED_IV = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">49</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">52</span>, <span class="number">53</span>, <span class="number">54</span>, <span class="number">55</span>, <span class="number">56</span>, <span class="number">57</span>, <span class="number">0x30</span>, <span class="number">65</span>, <span class="number">66</span>, <span class="number">67</span>, <span class="number">68</span>, <span class="number">69</span>, <span class="number">70</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">C73ck19unt</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="built_in">this</span>.editTextUserInput.getText().toString();</span><br><span class="line">        <span class="keyword">if</span>(s.trim().isEmpty()) &#123;</span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;不能为空哦！&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">            <span class="built_in">this</span>.editTextUserInput.setError(<span class="string">&quot;此字段不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(s.trim().length() &lt; <span class="number">16</span>) &#123;</span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;输入内容长度不能小于16位！&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">            <span class="built_in">this</span>.editTextUserInput.setError(<span class="string">&quot;长度至少为16位&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] arr_b = s.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">byte</span>[] arr_b1 = <span class="built_in">this</span>.nativeInterface.Tungtungtungsahur(MainActivity.FIXED_KEY, MainActivity.FIXED_IV, arr_b);</span><br><span class="line">        <span class="keyword">if</span>(arr_b1 == <span class="literal">null</span>) &#123;</span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;加密失败!&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">            <span class="built_in">this</span>.editTextUserInput.setError(<span class="string">&quot;加密失败&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;加密后数据 (bytes hex): &quot;</span> + MainActivity.bytesToHex(arr_b1));</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.nativeInterface.validateEncryptedData(arr_b, arr_b1)) &#123;</span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;校验成功! flag-&gt; &quot;</span> + s, <span class="number">1</span>).show();</span><br><span class="line">            <span class="built_in">this</span>.editTextUserInput.setError(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;校验失败! 输入与解密结果不匹配。&quot;</span>, <span class="number">1</span>).show();</span><br><span class="line">        <span class="built_in">this</span>.editTextUserInput.setError(<span class="string">&quot;校验失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">bytesToHex</span><span class="params">(<span class="type">byte</span>[] arr_b)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(arr_b == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;null&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">stringBuilder0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> <span class="number">0</span>; v &lt; arr_b.length; ++v) &#123;</span><br><span class="line">            stringBuilder0.append(String.format(<span class="string">&quot;%02X&quot;</span>, ((<span class="type">byte</span>)arr_b[v])));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stringBuilder0.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>  <span class="comment">// android.app.Activity</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle0)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(bundle0); </span><br><span class="line">    <span class="built_in">this</span>.setContentView(layout.activity_main);</span><br><span class="line">    <span class="built_in">this</span>.buttonCheck = (Button) <span class="built_in">this</span>.findViewById(id.buttonCheck);</span><br><span class="line">    <span class="built_in">this</span>.editTextUserInput = (EditText) <span class="built_in">this</span>.findViewById(id.editTextUserInput);</span><br><span class="line">    MainActivity.FIXED_KEY = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">87</span>, <span class="number">101</span>, <span class="number">49</span>, <span class="number">99</span>, <span class="number">0x30</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">0x5F</span>, <span class="number">52</span>, <span class="number">0x5F</span>, <span class="number">72</span>, <span class="number">38</span>, <span class="number">78</span>, <span class="number">67</span>, <span class="number">84</span>, <span class="number">70</span>&#125;;</span><br><span class="line">    <span class="built_in">this</span>.nativeInterface = <span class="keyword">new</span> <span class="title class_">NativeLib</span>();</span><br><span class="line">    <span class="built_in">this</span>.buttonCheck.setOnClickListener(v -&gt; &#123;</span><br><span class="line">        MainActivity.<span class="built_in">this</span>.C73ck19unt();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">com</span>.aaron.xxxr01d.MainActivity<span class="number">.1</span> <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener &#123;</span><br><span class="line">            <span class="keyword">final</span> MainActivity <span class="built_in">this</span>$<span class="number">0</span>;</span><br><span class="line">            <span class="meta">@Override</span>  <span class="comment">// android.view.View$OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view0)</span> &#123;</span><br><span class="line">                MainActivity.access$<span class="number">000</span>(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现初始化了一个密钥：<font color=lime><strong>ThisIsA16ByteKey</strong></font>和一个iv：<font color=red><strong>1234567890ABCDEF</strong></font>，但是oncreate中又用了<font color=orange><strong>We1c0me_4_H&amp;NCTF</strong></font>作为key，加密函数为<code>Tungtungtungsahur</code>，验证函数为<code>validateEncryptedData</code>，均为native方法，查看so层，发现有很多花指令，编写脚本去除：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ida_bytes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">start_addr = <span class="number">0x13480</span></span><br><span class="line">end_addr = <span class="number">0x16310</span></span><br><span class="line"></span><br><span class="line">pattern = [<span class="number">0x74</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x0F</span>, <span class="number">0xBE</span>]</span><br><span class="line">length = <span class="built_in">len</span>(pattern)</span><br><span class="line"></span><br><span class="line">found_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> addr <span class="keyword">in</span> <span class="built_in">range</span>(start_addr, end_addr - length + <span class="number">1</span>):</span><br><span class="line">    bytes_here = [get_wide_byte(addr + i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length)]</span><br><span class="line">    <span class="keyword">if</span> bytes_here == pattern:</span><br><span class="line">        original_byte = get_wide_byte(addr + <span class="number">2</span>)</span><br><span class="line">        patch_byte(addr + <span class="number">2</span>, <span class="number">0x90</span>)</span><br><span class="line">        found_count += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>去除后反编译函数发现是一个复杂的加密算法，查看validateEncryptedData：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">Java_com_aaron_nativelib_NativeLib_validateEncryptedData</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 a1,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 a2,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 a3,</span></span></span><br><span class="line"><span class="params"><span class="function">        __int64 a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// ebp</span></span><br><span class="line">  __int64 v8; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">const</span> __m128i *v9; <span class="comment">// r13</span></span><br><span class="line">  __m128i v10; <span class="comment">// xmm1</span></span><br><span class="line"></span><br><span class="line">  v8 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(*(_QWORD *)a1 + <span class="number">1472LL</span>))(a1, a3, <span class="number">0LL</span>);</span><br><span class="line">  (*(<span class="built_in">void</span> (__fastcall **)(__int64, __int64))(*(_QWORD *)a1 + <span class="number">1368LL</span>))(a1, a3);</span><br><span class="line">  v9 = (<span class="type">const</span> __m128i *)(*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(*(_QWORD *)a1 + <span class="number">1472LL</span>))(a1, a4, <span class="number">0LL</span>);</span><br><span class="line">  (*(<span class="built_in">void</span> (__fastcall **)(__int64, __int64))(*(_QWORD *)a1 + <span class="number">1368LL</span>))(a1, a4);</span><br><span class="line">  v10 = _mm_or_si128(</span><br><span class="line">          _mm_xor_si128(_mm_loadu_si128(v9), *(__m128i *)byte_7910),</span><br><span class="line">          _mm_xor_si128(_mm_loadu_si128(v9 + <span class="number">1</span>), *(__m128i *)byte_79A0));</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v4) = _mm_testz_si128(v10, v10);</span><br><span class="line">  (*(<span class="built_in">void</span> (__fastcall **)(__int64, __int64, __int64, __int64))(*(_QWORD *)a1 + <span class="number">1536LL</span>))(a1, a3, v8, <span class="number">2LL</span>);</span><br><span class="line">  (*(<span class="built_in">void</span> (__fastcall **)(__int64, __int64, <span class="type">const</span> __m128i *, __int64))(*(_QWORD *)a1 + <span class="number">1536LL</span>))(a1, a4, v9, <span class="number">2LL</span>);</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现存储了两部分的密文：<code>7910</code>和<code>79A0</code>，提取得到<font color=lime><strong>3205ACCD2A7471916010989C15288D8E18EC2A88F1351C46D9E38DFFF293426F</strong></font>，接着寻找加密函数，发现是动态注册的，找到地址：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.data.rel.ro:</span>0000000000036CE0 off_36CE0       <span class="built_in">dq</span> offset aTungtungtungsa</span><br><span class="line"><span class="symbol">.data.rel.ro:</span>0000000000036CE0                                         <span class="comment">; DATA XREF: JNI_OnLoad+55↑o</span></span><br><span class="line"><span class="symbol">.data.rel.ro:</span>0000000000036CE0                                         <span class="comment">; &quot;Tungtungtungsahur&quot;</span></span><br><span class="line"><span class="symbol">.data.rel.ro:</span>0000000000036CE8                 <span class="built_in">dq</span> offset aBBBB         <span class="comment">; &quot;([B[B[B)[B&quot;</span></span><br><span class="line"><span class="symbol">.data.rel.ro:</span>0000000000036CF0                 <span class="built_in">dq</span> offset sub_12A10</span><br><span class="line"><span class="symbol">.data.rel.ro:</span>0000000000036CF8                 <span class="built_in">dq</span> offset aTralalerotrala <span class="comment">; &quot;Tralalerotralala&quot;</span></span><br><span class="line"><span class="symbol">.data.rel.ro:</span>0000000000036D00                 <span class="built_in">dq</span> offset aBBBB         <span class="comment">; &quot;([B[B[B)[B&quot;</span></span><br><span class="line"><span class="symbol">.data.rel.ro:</span>0000000000036D08                 <span class="built_in">dq</span> offset sub_12C70</span><br></pre></td></tr></table></figure>
<p>查看这两个函数，发现其分别是加密和解密函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_12A10</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, __int64 a4, __int64 n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r13d</span></span><br><span class="line">  __int64 v10; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *src; <span class="comment">// r12</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v13; <span class="comment">// r13d</span></span><br><span class="line">  __int64 v14; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">void</span> *ptr_1; <span class="comment">// rdi</span></span><br><span class="line">  __int64 n_1; <span class="comment">// [rsp+8h] [rbp-70h]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp+10h] [rbp-68h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp+18h] [rbp-60h]</span></span><br><span class="line">  __int64 v20; <span class="comment">// [rsp+20h] [rbp-58h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+28h] [rbp-50h]</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [rsp+30h] [rbp-48h] BYREF</span></span><br><span class="line">  __int64 v23[<span class="number">8</span>]; <span class="comment">// [rsp+38h] [rbp-40h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v23[<span class="number">1</span>] = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v21 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(*(_QWORD *)a1 + <span class="number">1472LL</span>))(a1, a3, <span class="number">0LL</span>);</span><br><span class="line">  v20 = a3;</span><br><span class="line">  v9 = (*(__int64 (__fastcall **)(__int64, __int64))(*(_QWORD *)a1 + <span class="number">1368LL</span>))(a1, a3);</span><br><span class="line">  v10 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(*(_QWORD *)a1 + <span class="number">1472LL</span>))(a1, a4, <span class="number">0LL</span>);</span><br><span class="line">  v19 = a4;</span><br><span class="line">  <span class="built_in">LODWORD</span>(a4) = (*(__int64 (__fastcall **)(__int64, __int64))(*(_QWORD *)a1 + <span class="number">1368LL</span>))(a1, a4);</span><br><span class="line">  src = (<span class="type">const</span> <span class="type">void</span> *)(*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(*(_QWORD *)a1 + <span class="number">1472LL</span>))(a1, n, <span class="number">0LL</span>);</span><br><span class="line">  n_1 = n;</span><br><span class="line">  <span class="built_in">LODWORD</span>(n) = (*(__int64 (__fastcall **)(__int64, __int64))(*(_QWORD *)a1 + <span class="number">1368LL</span>))(a1, n);</span><br><span class="line">  v18 = v10;</span><br><span class="line">  <span class="built_in">sub_16830</span>(v23, v21, v9, v10, (<span class="type">int</span>)a4);</span><br><span class="line">  ptr = <span class="number">0LL</span>;</span><br><span class="line">  __android_log_print(<span class="number">4LL</span>, <span class="string">&quot;NativeLib&quot;</span>, <span class="string">&quot;Input data length: %zu&quot;</span>, (<span class="type">int</span>)n);</span><br><span class="line">  v12 = <span class="built_in">sub_16C50</span>(v23, src, &amp;ptr, (<span class="type">int</span>)n);</span><br><span class="line">  v13 = v12;</span><br><span class="line">  <span class="keyword">if</span> ( !v12 || !ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    __android_log_print(<span class="number">6LL</span>, <span class="string">&quot;NativeLib&quot;</span>, <span class="string">&quot;Encryption failed. Encode returned %zu, cEncryptedData is %p&quot;</span>, v12, ptr);</span><br><span class="line">    ptr_1 = ptr;</span><br><span class="line">    v14 = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !ptr )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">LABEL_6:</span><br><span class="line">    <span class="built_in">j_j__free</span>(ptr_1);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  __android_log_print(<span class="number">4LL</span>, <span class="string">&quot;NativeLib&quot;</span>, <span class="string">&quot;Encryption successful. Encrypted data length: %zu&quot;</span>, v12);</span><br><span class="line">  v14 = (*(__int64 (__fastcall **)(__int64, _QWORD))(*(_QWORD *)a1 + <span class="number">1408LL</span>))(a1, v13);</span><br><span class="line">  <span class="keyword">if</span> ( v14 )</span><br><span class="line">    (*(<span class="built_in">void</span> (__fastcall **)(__int64, __int64, _QWORD, _QWORD, <span class="type">void</span> *))(*(_QWORD *)a1 + <span class="number">1664LL</span>))(a1, v14, <span class="number">0LL</span>, v13, ptr);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    __android_log_print(<span class="number">6LL</span>, <span class="string">&quot;NativeLib&quot;</span>, <span class="string">&quot;Encrypt: Failed to allocate NewByteArray for result.&quot;</span>);</span><br><span class="line">  ptr_1 = ptr;</span><br><span class="line">  <span class="keyword">if</span> ( ptr )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">LABEL_7:</span><br><span class="line">  (*(<span class="built_in">void</span> (__fastcall **)(__int64, __int64, __int64, __int64))(*(_QWORD *)a1 + <span class="number">1536LL</span>))(a1, v20, v21, <span class="number">2LL</span>);</span><br><span class="line">  (*(<span class="built_in">void</span> (__fastcall **)(__int64, __int64, __int64, __int64))(*(_QWORD *)a1 + <span class="number">1536LL</span>))(a1, v19, v18, <span class="number">2LL</span>);</span><br><span class="line">  (*(<span class="built_in">void</span> (__fastcall **)(__int64, __int64, <span class="type">const</span> <span class="type">void</span> *, __int64))(*(_QWORD *)a1 + <span class="number">1536LL</span>))(a1, n_1, src, <span class="number">2LL</span>);</span><br><span class="line">  <span class="built_in">sub_16BF0</span>(v23);</span><br><span class="line">  <span class="keyword">return</span> v14;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按说把加密函数hook成解密函数就行，但是这题的init_array有反hook：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.init_array:</span><span class="number">0000000000039010</span> _init_array     <span class="meta">segment</span> <span class="built_in">qword</span> <span class="meta">public</span> <span class="string">&#x27;DATA&#x27;</span> <span class="meta">use64</span></span><br><span class="line"><span class="symbol">.init_array:</span><span class="number">0000000000039010</span>                 <span class="meta">assume</span> <span class="built_in">cs</span>:_init_array</span><br><span class="line"><span class="symbol">.init_array:</span><span class="number">0000000000039010</span>                 <span class="comment">;org 39010h</span></span><br><span class="line"><span class="symbol">.init_array:</span><span class="number">0000000000039010</span>                 <span class="built_in">dq</span> offset sub_133E0</span><br><span class="line"><span class="symbol">.init_array:</span><span class="number">0000000000039018</span>                 <span class="built_in">dq</span> offset sub_13480</span><br><span class="line"><span class="symbol">.init_array:</span><span class="number">0000000000039018</span> _init_array     ends</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 <span class="title">sub_133E0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">pthread_t</span> newthread_[<span class="number">3</span>]; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  newthread_[<span class="number">1</span>] = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  __android_log_print(<span class="number">4LL</span>, <span class="string">&quot;CHECK&quot;</span>, <span class="string">&quot;START CHECK MAPS&quot;</span>);</span><br><span class="line">  <span class="built_in">sub_13030</span>();</span><br><span class="line">  __android_log_print(<span class="number">4LL</span>, <span class="string">&quot;CHECK&quot;</span>, <span class="string">&quot;START PTHREAD&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">pthread_create</span>(newthread_, <span class="number">0LL</span>, start_routine, <span class="number">0LL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">perror</span>(<span class="string">&quot;Failed to create thread&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">sub_13030</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *stream_1; <span class="comment">// rax</span></span><br><span class="line">  FILE *stream; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">char</span> *p_needle; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">char</span> haystack_[<span class="number">512</span>]; <span class="comment">// [rsp+0h] [rbp-238h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+200h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  stream_1 = <span class="built_in">fopen</span>(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( stream_1 )</span><br><span class="line">  &#123;</span><br><span class="line">    stream = stream_1;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">fgets</span>(haystack_, <span class="number">512</span>, stream_1) )</span><br><span class="line">    &#123;</span><br><span class="line">      p_needle = needle;</span><br><span class="line">      v3 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( needle[<span class="number">0</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( <span class="built_in">strstr</span>(haystack_, p_needle) )</span><br><span class="line">            &#123;</span><br><span class="line">              __android_log_print(<span class="number">4LL</span>, <span class="string">&quot;CHECK&quot;</span>, <span class="string">&quot;Find:%s&quot;</span>, p_needle);</span><br><span class="line">              <span class="built_in">LOBYTE</span>(v3) = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            v4 = p_needle[<span class="number">512</span>] == <span class="number">0</span>;</span><br><span class="line">            p_needle += <span class="number">512</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( !v4 );</span><br><span class="line">        &#125;</span><br><span class="line">        p_needle = needle;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="built_in">fgets</span>(haystack_, <span class="number">512</span>, stream) );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v3 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fclose</span>(stream);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> __fastcall __noreturn <span class="title">start_routine</span><span class="params">(<span class="type">void</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *inp_1; <span class="comment">// r15</span></span><br><span class="line">  <span class="type">int</span> fd_1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> fd_2; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> fd_3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">in_addr</span> *inp; <span class="comment">// rbx</span></span><br><span class="line">  FILE *stream_1; <span class="comment">// rax</span></span><br><span class="line">  FILE *stream; <span class="comment">// r15</span></span><br><span class="line">  <span class="type">int</span> fd_4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-24Ch]</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">sockaddr</span> addr; <span class="comment">// [rsp+10h] [rbp-248h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">568</span>]; <span class="comment">// [rsp+20h] [rbp-238h] BYREF</span></span><br><span class="line"></span><br><span class="line">  inp_1 = &amp;addr.sa_data[<span class="number">2</span>];</span><br><span class="line">  *(_DWORD *)&amp;addr.sa_data[<span class="number">10</span>] = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)&amp;addr.sa_data[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">  *(_DWORD *)&amp;addr.sa_family = <span class="number">-1570177022</span>;</span><br><span class="line">  <span class="built_in">inet_aton</span>(<span class="string">&quot;127.0.0.1&quot;</span>, (<span class="keyword">struct</span> in_addr *)&amp;addr.sa_data[<span class="number">2</span>]);</span><br><span class="line">  fd_1 = <span class="built_in">socket</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">connect</span>(fd_1, &amp;addr, <span class="number">0x10u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    fd = fd_1;</span><br><span class="line">    *(_WORD *)addr.sa_data = <span class="number">-30115</span>;</span><br><span class="line">    <span class="built_in">inet_aton</span>(<span class="string">&quot;127.0.0.1&quot;</span>, (<span class="keyword">struct</span> in_addr *)&amp;addr.sa_data[<span class="number">2</span>]);</span><br><span class="line">    fd_3 = <span class="built_in">socket</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">connect</span>(fd_3, &amp;addr, <span class="number">0x10u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_4:</span><br><span class="line">      fd_2 = fd;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      inp = (<span class="keyword">struct</span> in_addr *)inp_1;</span><br><span class="line">      stream_1 = <span class="built_in">fopen</span>(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( stream_1 )</span><br><span class="line">      &#123;</span><br><span class="line">        stream = stream_1;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="built_in">fgets</span>(s, <span class="number">512</span>, stream) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">strstr</span>(s, <span class="string">&quot;frida&quot;</span>)</span><br><span class="line">            || <span class="built_in">strstr</span>(s, <span class="string">&quot;gadget&quot;</span>)</span><br><span class="line">            || <span class="built_in">strstr</span>(s, <span class="string">&quot;agent&quot;</span>)</span><br><span class="line">            || <span class="built_in">strstr</span>(s, <span class="string">&quot;/data/local/tmp/&quot;</span>)</span><br><span class="line">            || <span class="built_in">strstr</span>(s, <span class="string">&quot;-64.so&quot;</span>)</span><br><span class="line">            || <span class="built_in">strstr</span>(s, <span class="string">&quot;-32.so&quot;</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fclose</span>(stream);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">      inp_1 = (<span class="type">char</span> *)inp;</span><br><span class="line">      inp[<span class="number">2</span>].s_addr = <span class="number">0</span>;</span><br><span class="line">      *(_QWORD *)&amp;inp-&gt;s_addr = <span class="number">0LL</span>;</span><br><span class="line">      *(_DWORD *)&amp;addr.sa_family = <span class="number">-1570177022</span>;</span><br><span class="line">      <span class="built_in">inet_aton</span>(<span class="string">&quot;127.0.0.1&quot;</span>, inp);</span><br><span class="line">      fd = <span class="built_in">socket</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">connect</span>(fd, &amp;addr, <span class="number">0x10u</span>) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      *(_WORD *)addr.sa_data = <span class="number">-30115</span>;</span><br><span class="line">      <span class="built_in">inet_aton</span>(<span class="string">&quot;127.0.0.1&quot;</span>, inp);</span><br><span class="line">      fd_4 = <span class="built_in">socket</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">connect</span>(fd_4, &amp;addr, <span class="number">0x10u</span>) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">    &#125;</span><br><span class="line">    fd_1 = fd;</span><br><span class="line">  &#125;</span><br><span class="line">  __android_log_print(<span class="number">4LL</span>, <span class="string">&quot;CHECK&quot;</span>, <span class="string">&quot;FIND PORT&quot;</span>);</span><br><span class="line">  fd_2 = fd_1;</span><br><span class="line">LABEL_5:</span><br><span class="line">  <span class="built_in">close</span>(fd_2);</span><br><span class="line">LABEL_6:</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试绕过并调用tralalero tralala解密：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hexToBytes</span>(<span class="params">hex</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> bytes = [], c = <span class="number">0</span>; c &lt; hex.<span class="property">length</span>; c += <span class="number">2</span>)</span><br><span class="line">        bytes.<span class="title function_">push</span>(<span class="built_in">parseInt</span>(hex.<span class="title function_">substr</span>(c, <span class="number">2</span>), <span class="number">16</span>));</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bytesToHex</span>(<span class="params">bytes</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">map</span>.<span class="title function_">call</span>(<span class="keyword">new</span> <span class="title class_">Uint8Array</span>(bytes), <span class="keyword">function</span> (<span class="params">b</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&#x27;0&#x27;</span> + b.<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">slice</span>(-<span class="number">2</span>);</span><br><span class="line">    &#125;).<span class="title function_">join</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">toUpperCase</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cipherHex = <span class="string">&quot;3205ACCD2A7471916010989C15288D8E18EC2A88F1351C46D9E38DFFF293426F&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> cipherBytes = <span class="title function_">hexToBytes</span>(cipherHex);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> libName = <span class="string">&quot;libZ1Y4.so&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(libName, <span class="string">&quot;sub_13030&quot;</span>) &amp;&amp; <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(libName, <span class="string">&quot;sub_13030&quot;</span>), &#123;</span><br><span class="line">    <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">        retval.<span class="title function_">replace</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(libName, <span class="string">&quot;start_routine&quot;</span>) &amp;&amp; <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(libName, <span class="string">&quot;start_routine&quot;</span>), <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(<span class="keyword">function</span>(<span class="params">arg0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;, <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fgetsPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;fgets&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (fgetsPtr) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(fgetsPtr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">buf</span> = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">size</span> = args[<span class="number">1</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">stream</span> = args[<span class="number">2</span>];</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (retval.<span class="title function_">toInt32</span>() !== <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> bufStr = <span class="title class_">Memory</span>.<span class="title function_">readUtf8String</span>(<span class="variable language_">this</span>.<span class="property">buf</span>);</span><br><span class="line">                <span class="keyword">if</span> (bufStr &amp;&amp; (</span><br><span class="line">                    bufStr.<span class="title function_">includes</span>(<span class="string">&quot;frida&quot;</span>) ||</span><br><span class="line">                    bufStr.<span class="title function_">includes</span>(<span class="string">&quot;gadget&quot;</span>) ||</span><br><span class="line">                    bufStr.<span class="title function_">includes</span>(<span class="string">&quot;agent&quot;</span>) ||</span><br><span class="line">                    bufStr.<span class="title function_">includes</span>(<span class="string">&quot;/data/local/tmp/&quot;</span>) ||</span><br><span class="line">                    bufStr.<span class="title function_">includes</span>(<span class="string">&quot;-64.so&quot;</span>) ||</span><br><span class="line">                    bufStr.<span class="title function_">includes</span>(<span class="string">&quot;-32.so&quot;</span>)</span><br><span class="line">                )) &#123;</span><br><span class="line">                    <span class="title class_">Memory</span>.<span class="title function_">writeUtf8String</span>(<span class="variable language_">this</span>.<span class="property">buf</span>, <span class="string">&quot;sth&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> connectPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&quot;libc.so&quot;</span>, <span class="string">&quot;connect&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (connectPtr) &#123;</span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(connectPtr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> addr = args[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">var</span> port = <span class="title class_">Memory</span>.<span class="title function_">readU16</span>(addr.<span class="title function_">add</span>(<span class="number">2</span>));</span><br><span class="line">            <span class="keyword">if</span> (port === <span class="number">0x69A6</span> || port === <span class="number">0x6A6A</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">block</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">block</span>) &#123;</span><br><span class="line">                retval.<span class="title function_">replace</span>(-<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">EditText</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.widget.EditText&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">SpannableStringBuilder</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.text.SpannableStringBuilder&quot;</span>);</span><br><span class="line">    <span class="title class_">EditText</span>.<span class="property">getText</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fakeInput = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;sth&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">SpannableStringBuilder</span>.<span class="property">$new</span>.<span class="title function_">overload</span>(<span class="string">&#x27;java.lang.CharSequence&#x27;</span>).<span class="title function_">call</span>(<span class="title class_">SpannableStringBuilder</span>, fakeInput);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title class_">EditText</span>.<span class="property">toString</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(<span class="string">&quot;sth&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">MainActivity</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.aaron.xxxr01d.MainActivity&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Toast</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;android.widget.Toast&quot;</span>);</span><br><span class="line">    <span class="title class_">MainActivity</span>.<span class="property">C73ck19unt</span>.<span class="property">implementation</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] Hooked C73ck19unt(), using fixed ciphertext as input&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> arr_b = cipherBytes;</span><br><span class="line">        <span class="keyword">var</span> nativeInterface = <span class="variable language_">this</span>.<span class="property">nativeInterface</span>.<span class="property">value</span>;</span><br><span class="line">        <span class="keyword">var</span> decryptedArr = nativeInterface.<span class="property">Tralalerotralala</span>.<span class="title function_">overload</span>(<span class="string">&#x27;[B&#x27;</span>, <span class="string">&#x27;[B&#x27;</span>, <span class="string">&#x27;[B&#x27;</span>).<span class="title function_">call</span>(nativeInterface, </span><br><span class="line">            <span class="title class_">MainActivity</span>.<span class="property">FIXED_KEY</span>.<span class="property">value</span>, </span><br><span class="line">            <span class="title class_">MainActivity</span>.<span class="property">FIXED_IV</span>.<span class="property">value</span>, </span><br><span class="line">            arr_b</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (decryptedArr == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="title class_">Toast</span>.<span class="title function_">makeText</span>(<span class="variable language_">this</span>, <span class="string">&quot;解密失败&quot;</span>, <span class="title class_">Toast</span>.<span class="property">LENGTH_SHORT</span>).<span class="title function_">show</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> decryptedFlag = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;java.lang.String&quot;</span>).$new(decryptedArr);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[+] 解密后的 flag 是:&quot;</span>, decryptedFlag);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;[DEBUG] 解密结果 (hex):&quot;</span>, <span class="title function_">bytesToHex</span>(decryptedArr));</span><br><span class="line">        <span class="title class_">Toast</span>.<span class="title function_">makeText</span>(<span class="variable language_">this</span>, <span class="string">&quot;flag: &quot;</span> + decryptedFlag, <span class="title class_">Toast</span>.<span class="property">LENGTH_LONG</span>).<span class="title function_">show</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">nativeInterface</span>.<span class="property">value</span>.<span class="title function_">validateEncryptedData</span>(arr_b, decryptedArr)) &#123;</span><br><span class="line">            <span class="title class_">Toast</span>.<span class="title function_">makeText</span>(<span class="variable language_">this</span>, <span class="string">&quot;校验成功！&quot;</span>, <span class="title class_">Toast</span>.<span class="property">LENGTH_SHORT</span>).<span class="title function_">show</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title class_">Toast</span>.<span class="title function_">makeText</span>(<span class="variable language_">this</span>, <span class="string">&quot;校验失败！&quot;</span>, <span class="title class_">Toast</span>.<span class="property">LENGTH_SHORT</span>).<span class="title function_">show</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><font color=deepskyblue><strong>H&amp;NCTF{Xxx_1s_And_F0r_Android^^}</strong></font></p>
<h2 id="签到re："><a href="#签到re：" class="headerlink" title="签到re："></a>签到re：</h2><p>查看程序主函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [rsp+Ch] [rbp-44h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">40</span>]; <span class="comment">// [rsp+10h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [rsp+3Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *MySecretKey123; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  MySecretKey123 = <span class="string">&quot;MySecretKey123!&quot;</span>; <span class="comment">// 密钥</span></span><br><span class="line">  <span class="built_in">fgets</span>(s, <span class="number">38</span>, stdin);</span><br><span class="line">  v8 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  v5 = <span class="built_in">sub_11B9</span>(MySecretKey123);</span><br><span class="line">  v7 = <span class="built_in">sub_1452</span>(s, v8, v5, &amp;ptr);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v7; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *((_BYTE *)ptr + i) != byte_4080[i] ) <span class="comment">// 密文</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;wrong&quot;</span>);</span><br><span class="line">      <span class="built_in">free</span>(ptr);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFFLL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;right&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(ptr);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看sub_11B9：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_11B9</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *MySecretKey123)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line">  __int16 v5; <span class="comment">// [rsp+21h] [rbp-1Fh]</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [rsp+23h] [rbp-1Dh]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="built_in">strlen</span>(MySecretKey123);</span><br><span class="line">  <span class="built_in">SHA256</span>(MySecretKey123, v1, &amp;v4);</span><br><span class="line">  <span class="built_in">LOBYTE</span>(v3) = v4 | <span class="number">1</span>;</span><br><span class="line">  *(_WORD *)((<span class="type">char</span> *)&amp;v3 + <span class="number">1</span>) = v5 &amp; <span class="number">0xFEFE</span>;</span><br><span class="line">  <span class="built_in">HIBYTE</span>(v3) = v6 | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是取了硬编码密钥字符串生成了一个新的密钥，动态调试得到密钥<font color=red><strong>51h, 16h, 34h, FBh</strong></font>，查看加密函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_1452</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *p_s, <span class="type">int</span> n, <span class="type">int</span> a3, __int64 p_ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _BYTE v7[<span class="number">2</span>]; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line">  _BYTE v8[<span class="number">2</span>]; <span class="comment">// [rsp+22h] [rbp-1Eh] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v9[<span class="number">2</span>]; <span class="comment">// [rsp+24h] [rbp-1Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v10[<span class="number">2</span>]; <span class="comment">// [rsp+26h] [rbp-1Ah] BYREF</span></span><br><span class="line">  <span class="type">void</span> *dest; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> size; <span class="comment">// [rsp+34h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> n4; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> size_1; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  n4 = <span class="number">4</span>;</span><br><span class="line">  size = <span class="number">4</span> * ((n + <span class="number">3</span>) / <span class="number">4</span>);</span><br><span class="line">  *(_QWORD *)p_ptr = <span class="built_in">malloc</span>(size + <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !*(_QWORD *)p_ptr )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFFLL</span>;</span><br><span class="line">  **(_BYTE **)p_ptr = <span class="built_in">HIBYTE</span>(n);</span><br><span class="line">  *(_BYTE *)(*(_QWORD *)p_ptr + <span class="number">1LL</span>) = <span class="built_in">BYTE2</span>(n);</span><br><span class="line">  *(_BYTE *)(*(_QWORD *)p_ptr + <span class="number">2LL</span>) = <span class="built_in">BYTE1</span>(n);</span><br><span class="line">  *(_BYTE *)(*(_QWORD *)p_ptr + <span class="number">3LL</span>) = n;</span><br><span class="line">  dest = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, p_s, n);</span><br><span class="line">  <span class="built_in">memset</span>((<span class="type">char</span> *)dest + n, <span class="number">0</span>, size - n);</span><br><span class="line">  <span class="keyword">for</span> ( size_1 = <span class="number">0</span>; size_1 &lt; size; size_1 += n4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v10[<span class="number">0</span>] = *((_BYTE *)dest + size_1);</span><br><span class="line">    v10[<span class="number">1</span>] = *((_BYTE *)dest + size_1 + <span class="number">1</span>);</span><br><span class="line">    v9[<span class="number">0</span>] = *((_BYTE *)dest + size_1 + <span class="number">2</span>);</span><br><span class="line">    v9[<span class="number">1</span>] = *((_BYTE *)dest + size_1 + <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">sub_13AC</span>(a3, v10, v8);</span><br><span class="line">    <span class="built_in">sub_13AC</span>(a3, v9, v7);</span><br><span class="line">    *(_BYTE *)(size_1 + <span class="number">4</span> + *(_QWORD *)p_ptr) = v8[<span class="number">0</span>];</span><br><span class="line">    *(_BYTE *)(*(_QWORD *)p_ptr + size_1 + <span class="number">4</span> + <span class="number">1LL</span>) = v8[<span class="number">1</span>];</span><br><span class="line">    *(_BYTE *)(*(_QWORD *)p_ptr + size_1 + <span class="number">4</span> + <span class="number">2LL</span>) = v7[<span class="number">0</span>];</span><br><span class="line">    *(_BYTE *)(*(_QWORD *)p_ptr + size_1 + <span class="number">4</span> + <span class="number">3LL</span>) = v7[<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(dest);</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)(size + <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现是对明文的每两个字节和密钥加密，查看sub_13AC：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BYTE *__fastcall <span class="title">sub_13AC</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> __int8 *a2, _BYTE *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _BYTE *result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  *a3 = *a2 * a1 + <span class="built_in">BYTE1</span>(a1) * a2[<span class="number">1</span>];</span><br><span class="line">  result = a3 + <span class="number">1</span>;</span><br><span class="line">  a3[<span class="number">1</span>] = (*a2 * <span class="built_in">BYTE2</span>(a1) + <span class="built_in">HIBYTE</span>(a1) * a2[<span class="number">1</span>]) % <span class="number">256</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是一个矩阵运算，提取密文编写脚本解密：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_block</span>(<span class="params">out0, out1, k0=<span class="number">81</span>, k1=<span class="number">22</span>, k2=<span class="number">52</span>, k3=<span class="number">251</span></span>):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            o0 = (x * k0 + y * k1) % <span class="number">256</span></span><br><span class="line">            o1 = (x * k2 + y * k3) % <span class="number">256</span></span><br><span class="line">            <span class="keyword">if</span> o0 == out0 <span class="keyword">and</span> o1 == out1:</span><br><span class="line">                <span class="keyword">return</span> (x, y)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">cipher = <span class="built_in">bytearray</span>.fromhex(<span class="string">&quot;000000250CE2708998B2BBE494A095AC389222F80E7B761A66C803052E7DA1043DC062FE6667028781F40000&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cipher), <span class="number">2</span>):</span><br><span class="line">    plain = decrypt_block(cipher[i], cipher[i+<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> plain:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">chr</span>(plain[<span class="number">0</span>])&#125;</span><span class="subst">&#123;<span class="built_in">chr</span>(plain[<span class="number">1</span>])&#125;</span>&quot;</span>,end=<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><font color=deepskyblue><strong>H&amp;NCTF{840584fb08a26f01c471054628e451}</strong></font></p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2025/06/28/gctf_25_mtac/"
      title="GoogleCTF 2025 Reverse-multiarch WriteUp"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        GoogleCTF 2025 Reverse-multiarch WriteUp
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2025/06/04/about_flowers_1/"
      title="【尝试】关于二次计算型花指令的分析与改进"
     >

    <p class="title-text">
      
        【尝试】关于二次计算型花指令的分析与改进
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2025 Astral Prisma<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
